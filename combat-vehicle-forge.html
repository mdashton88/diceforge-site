<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vehicle Forge — DiceForge Studios</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root{--bg-deep:#0E0C0A;--bg-dark:#141210;--bg-card:#1A1816;--bg-panel:#201E1A;--border:#3A3530;--border-light:#4A4540;--accent:#C4A44A;--accent-dim:#C4A44A40;--accent-glow:#C4A44A20;--text:#D4C8B0;--text-bright:#EDE4D4;--text-dim:#8A7A60;--green:#5A9A5A;--red:#8C3030;--red-bright:#B04040;--blue:#4A7A9A;--orange:#B07830}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;background:var(--bg-deep);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:15px;line-height:1.6}
.tool-nav{display:flex;gap:0;background:#141210;border-bottom:1px solid #3A3530;padding:0 12px;font-family:'Cinzel',serif;flex-wrap:wrap}
.tool-nav-item{background:transparent;border:none;color:#8A7A60;padding:8px 14px;font-size:10px;letter-spacing:1.5px;cursor:pointer;font-family:'Cinzel',serif;text-transform:uppercase;transition:all .15s}
.tool-nav-item:hover{color:#D4C8B0}.tool-nav-item.active{color:#C4A44A;border-bottom:2px solid #C4A44A}
.app{display:flex;height:calc(100vh - 38px);overflow:hidden}
.sidebar{width:380px;min-width:380px;background:var(--bg-dark);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.header{background:var(--bg-dark);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.header-brand{font-family:'Cinzel',serif;font-size:11px;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase}
.header-title{font-family:'Cinzel',serif;font-size:18px;color:var(--accent);letter-spacing:2px}
.header-spacer{flex:1}
.header-btn{background:transparent;border:1px solid var(--border);color:var(--text-dim);padding:6px 14px;font-family:'Crimson Pro',serif;font-size:13px;cursor:pointer;transition:all .15s;white-space:nowrap}
.header-btn:hover{border-color:var(--accent);color:var(--accent)}
.header-btn.primary{background:var(--accent);color:var(--bg-deep);border-color:var(--accent);font-weight:700}
.header-btn.primary:hover{background:#D4B45A}
.sidebar-section{padding:12px 16px;border-bottom:1px solid var(--border)}
.sidebar-section h3{font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px}
.field-row{margin-bottom:6px}
.field-row input[type="text"],.field-row textarea,.field-row select{background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:5px 10px;font-family:'Crimson Pro',serif;font-size:14px;width:100%}
.field-row input:focus,.field-row textarea:focus,.field-row select:focus{outline:none;border-color:var(--accent)}
.field-row textarea{resize:vertical;min-height:60px;line-height:1.5}
.field-row label{font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px;font-family:'Cinzel',serif;display:block;margin-bottom:3px}
.size-picker{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.size-picker input[type="range"]{flex:1;accent-color:var(--accent);cursor:pointer}
.size-picker .size-val{font-family:'Cinzel',serif;font-size:24px;color:var(--accent);font-weight:700;min-width:36px;text-align:center}
.size-picker .size-class{font-size:12px;color:var(--text-dim);font-style:italic}
.loco-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.loco-btn{background:var(--bg-deep);border:1px solid var(--border);color:var(--text);padding:6px 10px;cursor:pointer;font-family:'Crimson Pro',serif;font-size:12px;text-align:left;transition:all .15s;display:flex;justify-content:space-between;align-items:center}
.loco-btn:hover{border-color:var(--accent);color:var(--accent)}
.loco-btn.active{background:var(--accent-glow);border-color:var(--accent);color:var(--accent)}
.loco-btn .loco-speed{font-size:10px;color:var(--text-dim)}.loco-btn.active .loco-speed{color:var(--accent);opacity:.7}
.frame-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-top:8px}
.frame-stat{background:var(--bg-deep);border:1px solid var(--border);padding:6px 8px;text-align:center}
.frame-stat .fs-label{font-size:9px;letter-spacing:1.5px;color:var(--text-dim);text-transform:uppercase;font-family:'Cinzel',serif}
.frame-stat .fs-value{font-size:14px;font-weight:700;color:var(--text-bright);margin-top:1px}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.stat-box{background:var(--bg-deep);border:1px solid var(--border);padding:8px 10px;text-align:center}
.stat-box .stat-label{font-size:10px;letter-spacing:1.5px;color:var(--text-dim);text-transform:uppercase;font-family:'Cinzel',serif}
.stat-box .stat-value{font-size:16px;font-weight:700;color:var(--text-bright);margin-top:2px}
.mods-remaining{background:var(--bg-deep);border:1px solid var(--border);padding:10px;text-align:center;margin-top:8px}
.mods-remaining .big-num{font-size:28px;font-weight:700;font-family:'Cinzel',serif}
.big-num.ok{color:var(--green)}.big-num.low{color:var(--orange)}.big-num.over{color:var(--red-bright)}
.cost-display{background:var(--bg-deep);border:1px solid var(--border);padding:10px;text-align:center;margin-top:6px}
.cost-val{font-size:20px;font-weight:700;color:var(--accent);font-family:'Cinzel',serif}
.cost-label{font-size:10px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1px}
.tabs{display:flex;border-bottom:1px solid var(--border);background:var(--bg-dark);overflow-x:auto}
.tab{padding:8px 16px;font-size:11px;letter-spacing:1px;text-transform:uppercase;font-family:'Cinzel',serif;color:var(--text-dim);cursor:pointer;transition:all .15s;border-bottom:2px solid transparent;white-space:nowrap}
.tab:hover{color:var(--text)}.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.panel{display:none;flex:1;overflow-y:auto;padding:16px 20px}.panel.active{display:block}
.dnd-layout{display:grid;grid-template-columns:1fr 1fr;gap:16px;height:100%}
.dnd-column{overflow-y:auto}
.dnd-column h3{font-family:'Cinzel',serif;font-size:12px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px}
.cat-header{font-family:'Cinzel',serif;font-size:10px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;padding:8px 0 4px;border-bottom:1px solid var(--border);margin-top:8px}
.drag-item,.weapon-drag-item{display:flex;align-items:flex-start;gap:8px;padding:6px 8px;background:var(--bg-deep);border:1px solid var(--border);margin:3px 0;cursor:grab;transition:all .15s;-webkit-user-select:none;user-select:none}
.drag-item:hover,.weapon-drag-item:hover{border-color:var(--accent-dim);background:var(--bg-card)}
.drag-item.dragging,.weapon-drag-item.dragging{opacity:.3}
.drag-handle{color:var(--text-dim);font-size:14px;opacity:.4;cursor:grab;flex-shrink:0;padding-top:2px}
.di-info,.wdi-info{flex:1;min-width:0}
.di-name,.wdi-name{font-size:13px;font-weight:600;color:var(--text-bright)}
.di-desc{font-size:11px;color:var(--text-dim);line-height:1.3}
.wdi-stats{font-size:11px;color:var(--text-dim);line-height:1.3}
.di-meta,.wdi-meta{text-align:right;flex-shrink:0}
.di-mods,.wdi-mods{font-size:11px;color:var(--blue);font-weight:600}
.di-price,.wdi-price{font-size:11px;color:var(--text-dim)}
.drop-bay{min-height:120px;border:2px dashed var(--border);padding:8px;transition:all .3s}
.drop-bay.drag-over{border-color:var(--accent);background:var(--accent-glow)}
.drop-bay.impact{animation:bay-flash .3s ease}
@keyframes bay-flash{0%{border-color:var(--accent);box-shadow:0 0 20px var(--accent-glow)}100%{border-color:var(--border);box-shadow:none}}
.empty-bay{text-align:center;color:var(--text-dim);font-style:italic;padding:40px 20px;font-size:13px}
.bay-item,.weapon-bay-item{display:flex;align-items:center;gap:8px;padding:6px 8px;background:var(--bg-card);border:1px solid var(--border);margin:3px 0}
.bay-item.snap-in,.weapon-bay-item.snap-in{animation:snap .2s ease}
@keyframes snap{0%{transform:translateY(-6px);opacity:.5}100%{transform:translateY(0);opacity:1}}
.bi-info,.wbi-info{flex:1}.bi-name,.wbi-name{font-size:13px;font-weight:600;color:var(--text-bright)}
.bi-detail,.wbi-stats,.wbi-mount{font-size:11px;color:var(--text-dim)}
.bi-controls{display:flex;align-items:center;gap:6px}
.bi-controls button{background:var(--bg-deep);border:1px solid var(--border);color:var(--text);width:24px;height:24px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
.bi-controls button:hover{border-color:var(--accent);color:var(--accent)}
.bi-count{font-weight:700;color:var(--accent);min-width:16px;text-align:center}
.bi-remove,.wbi-remove{cursor:pointer;color:var(--text-dim);font-size:16px;opacity:.5}.bi-remove:hover,.wbi-remove:hover{color:var(--red-bright);opacity:1}
.mount-tabs{display:flex;gap:4px;margin-bottom:8px}
.mount-tab{padding:5px 12px;font-size:11px;background:var(--bg-deep);border:1px solid var(--border);color:var(--text-dim);cursor:pointer;font-family:'Crimson Pro',serif}
.mount-tab:hover{border-color:var(--accent-dim)}.mount-tab.active{background:var(--accent-glow);border-color:var(--accent);color:var(--accent)}
.drag-ghost{position:fixed;z-index:9999;pointer-events:none;background:var(--accent);color:var(--bg-deep);padding:4px 12px;font-size:12px;font-weight:700;font-family:'Crimson Pro',serif;transform:translate(-50%,-50%);opacity:.9;box-shadow:0 4px 16px rgba(0,0,0,.5)}
.drag-ghost.near-target{opacity:1;transform:translate(-50%,-50%) scale(1.05);box-shadow:0 0 20px var(--accent-glow)}
.saved-item{display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-deep);border:1px solid var(--border);margin:4px 0;cursor:pointer}
.saved-item:hover{border-color:var(--accent-dim)}.si-name{font-weight:600;color:var(--text-bright);flex:1}
.si-chassis{font-size:12px;color:var(--text-dim)}.si-delete{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:14px;padding:4px 8px}
.si-delete:hover{color:var(--red-bright)}
.empty-state{text-align:center;color:var(--text-dim);padding:20px;font-style:italic}
.stat-block{background:var(--bg-dark);border:2px solid var(--accent-dim);padding:16px;font-size:14px;line-height:1.5}
.sb-name{font-family:'Cinzel',serif;font-size:18px;font-weight:700;color:var(--accent);letter-spacing:1px}
.sb-type{font-size:12px;color:var(--text-dim);font-style:italic;margin-bottom:4px}
.sb-divider{border:none;border-top:1px solid var(--accent-dim);margin:6px 0}
.sb-line{font-size:13px;margin:2px 0}.sb-label{font-weight:700;color:var(--text-bright)}
.sb-notes{font-size:12px;font-style:italic;color:var(--text-dim)}
.sb-watermark{font-size:9px;color:var(--text-dim);text-align:right;margin-top:8px;font-style:italic;opacity:.5}
/* Search bars */
.search-bar{background:var(--bg-deep);border:1px solid var(--border);color:var(--text);padding:5px 10px;font-family:'Crimson Pro',serif;font-size:13px;width:100%;margin-bottom:6px}
.search-bar:focus{outline:none;border-color:var(--accent)}
.search-bar::placeholder{color:var(--text-dim);font-style:italic}
/* Help panel */
.help-section{margin-bottom:20px}
.help-section h3{font-family:'Cinzel',serif;font-size:13px;color:var(--accent);letter-spacing:1px;margin-bottom:6px;border-bottom:1px solid var(--accent-dim);padding-bottom:4px}
.help-section h4{font-size:13px;color:var(--text-bright);font-weight:700;margin:8px 0 4px}
.help-section p{font-size:13px;color:var(--text);margin:4px 0;line-height:1.5}
.help-section table{width:100%;border-collapse:collapse;font-size:12px;margin:6px 0}
.help-section th{text-align:left;color:var(--accent);border-bottom:1px solid var(--border);padding:4px 6px;font-family:'Cinzel',serif;font-size:10px;letter-spacing:1px;text-transform:uppercase}
.help-section td{padding:4px 6px;border-bottom:1px solid var(--bg-deep);color:var(--text)}
.help-search{margin-bottom:12px}
.rule-key{font-weight:700;color:var(--accent)}
.rule-note{font-size:11px;font-style:italic;color:var(--text-dim);margin-top:12px}
/* Image upload */
.img-upload-zone{border:2px dashed var(--border);padding:20px;text-align:center;cursor:pointer;transition:all .2s;margin:6px 0}
.img-upload-zone:hover{border-color:var(--accent-dim)}
.img-upload-zone.has-img{border-style:solid;padding:4px}
.img-upload-zone img{max-width:100%;max-height:200px;display:block;margin:0 auto}
/* Import/Export */
.io-buttons{display:flex;gap:6px;margin-top:8px}
.io-buttons .header-btn{flex:1;text-align:center;font-size:12px}
/* Responsive */
@media(max-width:900px){.app{flex-direction:column;height:auto}.sidebar{width:100%;min-width:0;max-height:50vh}.main{min-height:50vh}.dnd-layout{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="toolNavContainer"></div>
<div class="app">
  <div class="sidebar">
    <div class="sidebar-section">
      <h3>Vehicle Identity</h3>
      <div class="field-row"><label>Name</label><input type="text" id="vName" value="Untitled Vehicle" placeholder="Vehicle name"></div>
      <div class="field-row"><label>Description</label><textarea id="vDesc" placeholder="A brief description of your vehicle..." rows="3"></textarea></div>
      <div class="field-row"><label>Notes</label><textarea id="vNotes" placeholder="GM notes, special rules, campaign info..." rows="2"></textarea></div>
      <div class="field-row"><label>Image</label>
        <div class="img-upload-zone" id="imgZone" onclick="document.getElementById('imgInput').click()">
          <span id="imgPlaceholder" style="font-size:12px;color:var(--text-dim)">Click to upload vehicle image</span>
          <img id="imgPreview" style="display:none">
        </div>
        <input type="file" id="imgInput" accept="image/*" style="display:none" onchange="handleImage(event)">
        <button class="header-btn" id="imgClearBtn" style="display:none;width:100%;text-align:center;margin-top:4px;font-size:11px" onclick="clearImage()">Remove Image</button>
      </div>
    </div>
    <div class="sidebar-section">
      <h3>Size &amp; Frame</h3>
      <div class="size-picker"><span class="size-val" id="sizeVal">6</span><input type="range" id="sizeSlider" min="1" max="24" value="6" oninput="setSize(+this.value)"><span class="size-class" id="sizeClass">Large</span></div>
      <div id="frameInfo"></div>
    </div>
    <div class="sidebar-section">
      <h3>Main Locomotion</h3>
      <div class="loco-grid" id="locoGrid"></div>
    </div>
    <div class="sidebar-section">
      <h3>Armour Technology</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">
        <div class="loco-btn" id="at0" onclick="setAT(0)">Standard<span class="loco-speed">+0</span></div>
        <div class="loco-btn" id="at1" onclick="setAT(4)">Superior<span class="loco-speed">+4</span></div>
        <div class="loco-btn" id="at2" onclick="setAT(8)">Advanced<span class="loco-speed">+8</span></div>
        <div class="loco-btn" id="at3" onclick="setAT(12)">Exotic<span class="loco-speed">+12</span></div>
      </div>
      <div id="atDesc" style="font-size:11px;color:var(--text-dim);font-style:italic;margin-top:6px;line-height:1.3"></div>
    </div>
    <div class="sidebar-section">
      <h3>Statistics</h3>
      <div id="statsGrid" class="stats-grid"></div>
      <div id="modsRemaining" class="mods-remaining"></div>
      <div id="costDisplay" class="cost-display"></div>
    </div>
    <div class="sidebar-section">
      <h3>Save &amp; Load</h3>
      <div style="display:flex;gap:4px;margin-bottom:8px">
        <button class="header-btn primary" onclick="saveVehicle()" style="flex:1;text-align:center">Save</button>
        <button class="header-btn" onclick="duplicateVehicle()" style="flex:1;text-align:center">Duplicate</button>
        <button class="header-btn" onclick="newVehicle()" style="flex:1;text-align:center">New</button>
      </div>
      <div class="io-buttons">
        <button class="header-btn" onclick="exportJSON()">Export .json</button>
        <button class="header-btn" onclick="document.getElementById('importInput').click()">Import .json</button>
        <input type="file" id="importInput" accept=".json,.cvf.json" style="display:none" onchange="importJSON(event)">
        <button class="header-btn" onclick="batchExport()" title="Export all saved vehicles as one file">Batch Export</button>
        <button class="header-btn" onclick="printAll()" title="Print all saved vehicles as stat blocks">Print All</button>
      </div>
      <div id="savedList" style="margin-top:8px"></div>
    </div>
  </div>
  <div class="main">
    <div class="header">
      <div><div class="header-brand">DiceForge Studios</div><div class="header-title">Vehicle Forge</div></div>
      <div class="header-spacer"></div>
      <button class="header-btn" onclick="undo()" title="Undo (Ctrl+Z)">↩ Undo</button>
      <button class="header-btn" onclick="redo()" title="Redo (Ctrl+Y)">↪ Redo</button>
    </div>
    <div class="tabs">
      <div class="tab active" data-tab="mods" onclick="switchTab('mods')">Modifications</div>
      <div class="tab" data-tab="weapons" onclick="switchTab('weapons')">Weapons</div>
      <div class="tab" data-tab="output" onclick="switchTab('output')">Stat Block</div>
      <div class="tab" data-tab="help" onclick="switchTab('help')">Reference Guide</div>
    </div>
    <div class="panel active" id="panel-mods"><div class="dnd-layout"><div class="dnd-column"><h3>Modifications Catalogue</h3><input type="text" class="search-bar" id="modSearch" placeholder="Search modifications..." oninput="renderModCatalogue()"><div id="modCatalogue"></div></div><div class="dnd-column"><h3>Installed Modifications</h3><div class="drop-bay" id="modBay"><div class="empty-bay">Drag modifications here to install them</div></div></div></div></div>
    <div class="panel" id="panel-weapons"><div class="dnd-layout"><div class="dnd-column"><h3>Vehicular Weapons</h3><div id="eraFilter" style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:6px"></div><input type="text" class="search-bar" id="weaponSearch" placeholder="Search weapons..." oninput="renderWeaponCatalogue()"><div id="weaponCatalogue"></div><div style="margin-top:12px;padding-top:8px;border-top:1px solid var(--border)"><button class="header-btn" onclick="toggleCustomForm()" style="width:100%;text-align:center">+ Add Custom Weapon</button><div id="customForm" style="display:none;margin-top:8px"></div></div></div><div class="dnd-column"><h3>Weapon Hardpoints</h3><div class="mount-tabs"><div class="mount-tab active" data-mount="pintle" onclick="switchMount('pintle')">Pintle</div><div class="mount-tab" data-mount="fixed" onclick="switchMount('fixed')">Fixed (½)</div><div class="mount-tab" data-mount="turret" onclick="switchMount('turret')">Turret (×2)</div></div><div class="drop-bay" id="weaponBay"><div class="empty-bay">Drag weapons here to mount them</div></div></div></div></div>
    <div class="panel" id="panel-output"><div id="outputContent"></div></div>
    <div class="panel" id="panel-help"><input type="text" class="search-bar help-search" id="helpSearch" placeholder="Search reference guide..." oninput="filterHelp()"><div id="helpContent"></div></div>
  </div>
</div>
<script>
// ═══ AUDIO ENGINE ═══
var Audio={ctx:null,init:function(){if(!this.ctx)this.ctx=new(window.AudioContext||window.webkitAudioContext)();if(this.ctx.state==='suspended')this.ctx.resume()},
clunk:function(){this.init();var c=this.ctx,n=c.currentTime;var buf=c.createBuffer(1,c.sampleRate*.02,c.sampleRate);var d=buf.getChannelData(0);for(var i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,12);var ns=c.createBufferSource();ns.buffer=buf;var bp=c.createBiquadFilter();bp.type='bandpass';bp.frequency.value=4200;bp.Q.value=2;var o1=c.createOscillator();o1.type='sine';o1.frequency.value=820;var g1=c.createGain();g1.gain.setValueAtTime(.06,n);g1.gain.exponentialRampToValueAtTime(.001,n+.06);var o2=c.createOscillator();o2.type='sine';o2.frequency.value=2200;var g2=c.createGain();g2.gain.setValueAtTime(.02,n);g2.gain.exponentialRampToValueAtTime(.001,n+.03);var m=c.createGain();m.gain.value=.3;ns.connect(bp).connect(m);o1.connect(g1).connect(m);o2.connect(g2).connect(m);m.connect(c.destination);ns.start(n);ns.stop(n+.02);o1.start(n);o1.stop(n+.08);o2.start(n);o2.stop(n+.05)},
click:function(){this.init();var c=this.ctx,n=c.currentTime;var o=c.createOscillator();o.type='sine';o.frequency.value=600;var g=c.createGain();g.gain.setValueAtTime(.08,n);g.gain.exponentialRampToValueAtTime(.001,n+.04);o.connect(g).connect(c.destination);o.start(n);o.stop(n+.05)},
remove:function(){this.init();var c=this.ctx,n=c.currentTime;var o=c.createOscillator();o.type='triangle';o.frequency.setValueAtTime(500,n);o.frequency.exponentialRampToValueAtTime(200,n+.1);var g=c.createGain();g.gain.setValueAtTime(.1,n);g.gain.exponentialRampToValueAtTime(.001,n+.12);o.connect(g).connect(c.destination);o.start(n);o.stop(n+.15)}};

// ═══ SIZE REFERENCE ═══
var SIZE_REF={
  1:{len:"6'",ex:'Motorcycle, drone',wt:'250 lbs'},2:{len:"9'",ex:'Horse, large dog',wt:'1,000 lbs'},
  3:{len:"12'",ex:'Bull, early car, chariot',wt:'2,000 lbs'},4:{len:"15'",ex:'Hippo, compact car, jeep',wt:'2 tons'},
  5:{len:"18'",ex:'White rhino, SUV, truck',wt:'4 tons'},6:{len:"24'",ex:'Elephant, APC, orca',wt:'8 tons'},
  7:{len:"30'",ex:'T-Rex, heavy tank',wt:'16 tons'},8:{len:"36'",ex:'Dragon, patrol boat',wt:'32 tons'},
  9:{len:"50'",ex:'Sperm whale, MBT',wt:'64 tons'},10:{len:"63'",ex:'Bowhead whale, bomber',wt:'125 tons'},
  11:{len:"75'",ex:'Blue whale, corvette',wt:'250 tons'},12:{len:"100'",ex:'Kaiju, PT boat, frigate',wt:'500 tons'},
  13:{len:"125'",ex:'Space shuttle, destroyer',wt:'1,000 tons'},14:{len:"150'",ex:'Galleon, landing craft',wt:'2,000 tons'},
  15:{len:"200'",ex:'Large warship',wt:'4,000 tons'},16:{len:"250'",ex:'Heavy destroyer',wt:'8,000 tons'},
  17:{len:"300'",ex:'Battlecruiser',wt:'16,000 tons'},18:{len:"400'",ex:'Carrier',wt:'32,000 tons'},
  19:{len:"500'",ex:'Supercarrier',wt:'64,000 tons'},20:{len:"600'",ex:'Mega-platform',wt:'125,000 tons'},
  21:{len:"800'*",ex:'Mobile fortress',wt:'250K tons'},22:{len:"1000'*",ex:'Traction city, titan',wt:'500K tons'},
  23:{len:"1200'*",ex:'Capital ship',wt:'1M tons'},24:{len:"1500'+*",ex:'World-engine',wt:'2M+ tons'}};

function getFrame(sz){
  if(sz<=3)return{cat:'Normal',hand:1,baseTough:5,maxArmor:20,wounds:3,crew:1,energy:3,modMult:3,costMult:10000,compactBonus:(sz<=2?2:0)};
  if(sz<=7)return{cat:'Large',hand:0,baseTough:10,maxArmor:30,wounds:4,crew:3,energy:5,modMult:3,costMult:30000,compactBonus:0};
  if(sz<=11)return{cat:'Huge',hand:-1,baseTough:15,maxArmor:40,wounds:5,crew:5,energy:15,modMult:3,costMult:50000,compactBonus:0};
  return{cat:'Gargantuan',hand:-2,baseTough:20,maxArmor:50,wounds:6,crew:50,energy:30,modMult:4,costMult:1000000,compactBonus:0};}

var LOCOS=[
  {id:'wheeled',name:'Wheeled',speed:5,costMult:1000,notes:'Standard wheels.',group:'ground'},
  {id:'tracked',name:'Tracked',speed:4,costMult:5000,notes:'Ignores Difficult Ground.',group:'ground'},
  {id:'hover',name:'Hover',speed:6,costMult:10000,notes:'Ignores low obstacles and water.',group:'ground'},
  {id:'vtol',name:'Aircraft, VTOL',speed:8,costMult:100000,notes:'VTOL, hover, or fly.',group:'air'},
  {id:'turboprop',name:'Aircraft, Turboprop',speed:11,costMult:100000,notes:'Min speed 60 MPH or Out of Control.',group:'air'},
  {id:'jet',name:'Aircraft, Jet',speed:13,costMult:500000,notes:'Min speed 120 MPH or Out of Control.',group:'air'},
  {id:'water_turbo',name:'Water, Turboprop',speed:3,costMult:2000,notes:'Boat or ship, propeller/oar driven.',group:'water'},
  {id:'water_jet',name:'Water, Jet',speed:5,costMult:5000,notes:'Boat or ship, jet driven.',group:'water'},
  {id:'legs_biped',name:'Legs (Bipedal)',speed:8,costMult:50000,notes:'Walker rules. Fighting, Stomp, Death From Above.',group:'walker'},
  {id:'legs_quad',name:'Legs (Multileg)',speed:6,costMult:50000,notes:'Walker rules. 3+ legs: Reroll failed Piloting vs Out of Control.',group:'walker'}];

var SPD_TABLE={1:4,2:8,3:16,4:25,5:40,6:60,7:80,8:100,9:120,10:160,11:200,12:250,13:400,14:600,15:800,16:1000,17:1200,18:1600,19:2000,20:2500};
function speedMPH(r){return SPD_TABLE[r]||(r+'?')}
var MODS=[
  // NEGATIVE QUALITIES
  {id:'battered',name:'Battered',cat:'Negative Qualities',max:2,mods:-2,costFn:function(s){return -10000*s},desc:'Reduce base Toughness by 2.'},
  {id:'drone',name:'Drone',cat:'Negative Qualities',max:1,mods:-2,costFn:function(s){return -5000*s},desc:'No pilot. Requires Remote Control or AI. Crew drops to 0.'},
  {id:'exposed',name:'Exposed Crew',cat:'Negative Qualities',max:1,mods:-2,costFn:function(s){return -10000*s},desc:'Crew targetable, no Armor bonus. Can\'t take Sealed.'},
  {id:'finicky',name:'Finicky',cat:'Negative Qualities',max:2,mods:-2,costFn:function(s){return -10000*s},desc:'Repair at -2 (-4 if taken twice).'},
  {id:'fragile',name:'Fragile',cat:'Negative Qualities',max:2,mods:-2,costFn:function(s){return -10000*s},desc:'Reduce Wounds by 1.'},
  {id:'inefficient',name:'Inefficient',cat:'Negative Qualities',max:1,mods:-2,costFn:function(s){return -10000*s},desc:'Double fuel use per day.'},
  {id:'manual',name:'Manual',cat:'Negative Qualities',max:1,mods:-2,costFn:function(s){return -10000*s},desc:'No electronics. Cannot install electronic Mods.'},
  {id:'reduced_crew',name:'Reduced Crew',cat:'Negative Qualities',max:1,mods:'halfneg',costFn:function(s){return -10000*s},desc:'Crew drops to next lowest frame category.'},
  {id:'reduced_hand',name:'Reduced Handling',cat:'Negative Qualities',max:6,mods:-2,costFn:function(s){return -10000*s},desc:'-1 Handling per take (max -6 total).'},
  {id:'reduced_speed',name:'Reduced Speed',cat:'Negative Qualities',max:3,mods:-2,costFn:function(s){return -10000*s},desc:'-1 Speed Rating. Can\'t combine with Increased Speed.'},
  {id:'rough_ride',name:'Rough Ride',cat:'Negative Qualities',max:1,mods:-2,costFn:function(s){return -10000*s},desc:'Unstable Platform penalty is -4 instead of -2.'},
  {id:'unsafe',name:'Unsafe',cat:'Negative Qualities',max:1,mods:-2,costFn:function(s){return -10000*s},desc:'Full collision damage. No safety measures. Eject at -2.'},
  {id:'lightweight',name:'Lightweight Construction',cat:'Negative Qualities',max:3,mods:-1,costFn:function(s){return -8000*s},desc:'Reduce base Toughness by 2 per take. Plywood, canvas, aluminium, fibreglass. For large vehicles that are long but lightly built.'},
  // CORE SYSTEMS
  {id:'ai',name:'Artificial Intelligence',cat:'Core Systems',max:3,mods:1,costFn:function(s){return 5000*s},desc:'AI ally: d6 + Wild Die. 2nd: d10. 3rd: ignore 2 MAP.'},
  {id:'av_system',name:'AV System',cat:'Core Systems',max:1,mods:1,costFn:function(){return 10000},desc:'50× magnification, -4 Illumination, +2 Notice. +2 hearing 200 yds.'},
  {id:'command',name:'Command Suite',cat:'Core Systems',max:1,mods:1,costFn:function(){return 10000},desc:'See/hear through linked allies. Extend Command Range.'},
  {id:'comms',name:'Comms',cat:'Core Systems',max:2,mods:1,costFn:function(){return 5000},desc:'20 mile range. 2nd: 100 miles.'},
  {id:'entangled',name:'Entangled Comms',cat:'Core Systems',max:'U',mods:1,costFn:function(){return 50000},desc:'Quantum comms. Unlimited range, unjammable.'},
  {id:'remote',name:'Remote Control',cat:'Core Systems',max:1,mods:1,costFn:function(){return 10000},desc:'Operate from afar with Electronics -2.'},
  {id:'scanner',name:'Scanner',cat:'Core Systems',max:1,mods:1,costFn:function(){return 1000},desc:'Detect 50 yds. +2 Notice. Target need not be visible.'},
  {id:'sensor_array',name:'Sensor Array',cat:'Core Systems',max:1,mods:4,costFn:function(){return 25000},desc:'Scan 1 light-year / LOS. Full round, Vulnerable.'},
  // DEFENSIVE SYSTEMS
  {id:'amecm',name:'AM/ECM',cat:'Defensive Systems',max:1,mods:1,costFn:function(s){return 5000*s},desc:'+2 Evasion vs Guided Weapons.'},
  {id:'anti_tp',name:'Anti-Teleportation',cat:'Defensive Systems',max:1,mods:4,costFn:function(s){return 10000*s},desc:'Prevent teleportation into/onto vehicle.'},
  {id:'armor',name:'Armor',cat:'Defensive Systems',max:'frame',mods:1,costFn:function(s){return 5000*s},desc:'+2 Armor per take (up to frame max). Size 4+ = Heavy Armor.'},
  {id:'emp_shield',name:'EMP Shielding',cat:'Defensive Systems',max:1,mods:2,costFn:function(s){return 5000*s},desc:'Ignore 2 of -4 EMP penalty.'},
  {id:'escape',name:'Escape System',cat:'Defensive Systems',max:1,mods:'half',costFn:function(s){return 1000*s},desc:'Ejection seats (Size 7-) or escape pods (Size 8+).'},
  {id:'repair_drone',name:'Repair Drones',cat:'Defensive Systems',max:1,mods:'half',costFn:function(s){return 25000*s},desc:'Drones attempt Repair. Crit Fail = can\'t retry.'},
  {id:'repair_nano',name:'Repair Nanomachines',cat:'Defensive Systems',max:1,mods:3,costFn:function(s){return 50000*s},desc:'Repair as limited action. 3 Wounds max per 24hrs.'},
  {id:'shields',name:'Shields',cat:'Defensive Systems',max:1,mods:'half',costFn:function(s){return 50000*s},desc:'Charges = half base Wounds. Soak with Electronics.'},
  {id:'sloped',name:'Sloped Armor',cat:'Defensive Systems',max:1,mods:'half',costFn:function(s){return 5000*s},desc:'-2 enemy Shooting (direct-fire energy/kinetic only).'},
  {id:'stealth',name:'Stealth System',cat:'Defensive Systems',max:1,mods:'size',costFn:function(s){return 50000*s},desc:'-4 to lock on with Electronics.'},
  {id:'toughness',name:'Toughness',cat:'Defensive Systems',max:5,mods:1,costFn:function(s){return 5000*s},desc:'+1 Toughness.'},
  // LOCOMOTION & POWER
  {id:'amphibious',name:'Amphibious',cat:'Locomotion & Power',max:2,mods:2,costFn:function(s){return 1000*s},desc:'Enter water. Hand -1, Speed 2. 2nd: Speed 3.'},
  {id:'boosters',name:'Boosters',cat:'Locomotion & Power',max:4,mods:1,costFn:function(s){return 1000*s},desc:'Once/encounter: +1 Speed Rating for round. Don\'t stack.'},
  {id:'energy_pod',name:'Energy Pod',cat:'Locomotion & Power',max:'U',mods:'half',costFn:function(s){return 5000*s},desc:'Double Energy capacity.'},
  {id:'fwd',name:'Four-Wheel Drive',cat:'Locomotion & Power',max:1,mods:1,costFn:function(s){return 1000*s},desc:'Wheeled only. Difficult Ground = 1.5" per inch.'},
  {id:'handling',name:'Handling',cat:'Locomotion & Power',max:2,mods:'half',costFn:function(s){return 10000*s},desc:'+1 Handling (max +4 total).'},
  {id:'inc_speed',name:'Increased Speed',cat:'Locomotion & Power',max:5,mods:'half',costFn:function(s){return 10000*s},desc:'+1 Speed Rating. Can\'t combine with Reduced Speed.'},
  {id:'reactor',name:'Reactor',cat:'Locomotion & Power',max:1,mods:'half',costFn:function(s){return 10000*s},desc:'Energy ×10. Locomotion Crit: odd die = reactor explodes.'},
  // OFFENSIVE SYSTEMS
  {id:'stabilizer',name:'Stabilizer',cat:'Offensive Systems',max:1,mods:1,costFn:function(){return 5000},desc:'Negate Unstable Platform for all direct-fire weapons.'},
  {id:'targeting',name:'Targeting System',cat:'Offensive Systems',max:1,mods:1,costFn:function(){return 25000},desc:'-2 Shooting penalties (Called Shot, Cover, Range, Scale, Speed).'},
  // PERSONNEL
  {id:'crew_seat',name:'Crew Seating/Quarters',cat:'Personnel',max:'U',mods:'half',costFn:function(){return 10000},desc:'Add accommodations equal to Crew rating per take.'},
  {id:'luxury',name:'Luxury Features',cat:'Personnel',max:'U',mods:'half',costFn:function(s){return s>=8?10000*s:10000},desc:'Enhanced comfort. Required for voyages > few weeks.'},
  {id:'passenger_pod',name:'Passenger Pod',cat:'Personnel',max:'U',mods:2,costFn:function(){return 50000},desc:'Size 7 or less. 10 passengers, short trips.'},
  {id:'pro_bay',name:'Professional Bay',cat:'Personnel',max:'U',mods:4,costFn:function(){return 100000},desc:'Skill-specific facility. Free reroll on relevant Trait rolls.'},
  {id:'sealed',name:'Sealed',cat:'Personnel',max:1,mods:2,costFn:function(s){return 5000*s},desc:'Hermetically sealed. Life support, airlocks. Can\'t take Exposed.'},
  // STRUCTURAL
  {id:'hangar',name:'Hangar',cat:'Structural',max:'U',mods:5,costFn:function(){return 500000},desc:'Carry up to 10 Size points of vehicles (max half your Size).'},
  // WALKER-SPECIFIC (available when walker loco selected)
  {id:'jump_jets',name:'Jump Jets',cat:'Walker Systems',max:1,mods:1,costFn:function(s){return 10000*s},desc:'Move as VTOL once per encounter. Walker only.'},
  {id:'tandem_pilots',name:'Tandem Pilots',cat:'Negative Qualities',max:1,mods:-1,costFn:function(s){return -10000*s},desc:'Requires two pilots. Walker only.'},
  // MULTI-FORM
  {id:'variable_form',name:'Variable Form',cat:'Locomotion & Power',max:1,mods:'half',costFn:function(s){return 20000*s},desc:'Switch between two locomotion types as an action. Note secondary mode in Description (e.g. "Variable Form: VTOL"). Use secondary mode base Speed when transformed.'},
  {id:'submersible',name:'Submersible',cat:'Locomotion & Power',max:2,mods:2,costFn:function(s){return 10000*s},desc:'Can submerge as action. -4 to detect when submerged. 2nd: deep dive, crush-proof.'},
  // CANON ALIGNMENT MODS
  {id:'composite_armor',name:'Composite Armour',cat:'Defensive Systems',max:'frame',mods:1,costFn:function(s){return 50000*s},desc:'+4 Armour per take (not +2). Advanced composites, reactive armour, or layered plate. Stacks with standard Armor.'},
  {id:'road_vehicle',name:'Road Vehicle',cat:'Locomotion & Power',max:1,mods:0,costFn:function(s){return 5000*s},desc:'Wheeled only. +3 Speed Ratings on paved roads. Road tyres, suspension, transmission. Off-road speed unchanged.'},
  {id:'high_perf_engine',name:'High-Performance Engine',cat:'Locomotion & Power',max:3,mods:1,costFn:function(s){return 20000*s},desc:'+2 Speed Ratings per take. Superchargers, turbines, afterburners. Halve Energy per take.'}
];
// ═══ WEAPON CATALOGUE — DiceForge originals by era, SW compatible ═══
// Eras: ancient, medieval, blackpowder, industrial, modern, future, advanced
var WEAPONS=[
  // ANCIENT
  {id:'scorpion',name:'Scorpion',cat:'Siege Engines',era:'ancient',range:'15/30/60',damage:'2d6',ap:2,rof:1,shots:0,minSize:1,mods:1,cost:200,notes:'Reload 1, HW'},
  {id:'onager',name:'Onager',cat:'Siege Engines',era:'ancient',range:'24/48/96',damage:'3d6',ap:0,rof:1,shots:0,minSize:3,mods:2,cost:500,notes:'Reload 4, Indirect, MBT'},
  {id:'polybolos',name:'Polybolos',cat:'Siege Engines',era:'ancient',range:'15/30/60',damage:'2d6',ap:2,rof:2,shots:0,minSize:2,mods:1,cost:400,notes:'Reload 1, Repeating ballista, HW'},
  {id:'greek_fire_s',name:'Greek Fire Siphon',cat:'Incendiaries',era:'ancient',range:'Cone',damage:'2d8',ap:0,rof:1,shots:10,minSize:2,mods:1,cost:300,notes:'Cone 12", Incendiary, Cauterize'},
  {id:'bow_battery',name:'Bow Battery',cat:'Ranged',era:'ancient',range:'12/24/48',damage:'2d6',ap:1,rof:2,shots:0,minSize:2,mods:1,cost:100,notes:'Crew of archers, Reload 1'},
  {id:'javelin_rack',name:'Javelin Rack',cat:'Ranged',era:'ancient',range:'4/8/16',damage:'2d4',ap:0,rof:3,shots:20,minSize:1,mods:1,cost:50,notes:'Thrown, limited range'},
  {id:'scythed_wheels',name:'Scythed Wheels',cat:'Melee Systems',era:'ancient',range:'—',damage:'Str+2d6',ap:2,rof:0,shots:0,minSize:2,mods:1,cost:100,notes:'Melee, damages adjacent on pass, HW'},
  {id:'ram_ancient',name:'Bronze Ram',cat:'Melee Systems',era:'ancient',range:'—',damage:'Str+2d8',ap:4,rof:0,shots:0,minSize:4,mods:1,cost:300,notes:'Ship ram, melee only, HW'},
  // MEDIEVAL
  {id:'ballista',name:'Ballista',cat:'Siege Engines',era:'medieval',range:'15/30/60',damage:'3d6',ap:2,rof:1,shots:0,minSize:2,mods:1,cost:500,notes:'Reload 2, HW'},
  {id:'catapult',name:'Catapult',cat:'Siege Engines',era:'medieval',range:'24/48/96',damage:'3d8',ap:0,rof:1,shots:0,minSize:4,mods:2,cost:1000,notes:'Reload 4, Indirect, MBT'},
  {id:'trebuchet',name:'Trebuchet',cat:'Siege Engines',era:'medieval',range:'24/48/96',damage:'4d8',ap:4,rof:1,shots:0,minSize:6,mods:3,cost:2000,notes:'Reload 6, Indirect, LBT'},
  {id:'mangonel',name:'Mangonel',cat:'Siege Engines',era:'medieval',range:'18/36/72',damage:'3d6',ap:0,rof:1,shots:0,minSize:3,mods:2,cost:700,notes:'Reload 3, Indirect, MBT'},
  {id:'springald',name:'Springald',cat:'Siege Engines',era:'medieval',range:'20/40/80',damage:'2d8',ap:4,rof:1,shots:0,minSize:2,mods:1,cost:400,notes:'Reload 2, AP bolt, HW'},
  {id:'ram',name:'Battering Ram',cat:'Melee Systems',era:'medieval',range:'—',damage:'Str+2d8',ap:4,rof:0,shots:0,minSize:2,mods:1,cost:200,notes:'Melee only, HW'},
  {id:'boiling_oil',name:'Boiling Oil/Pitch',cat:'Defensive Weapons',era:'medieval',range:'Cone',damage:'2d10',ap:0,rof:1,shots:5,minSize:2,mods:1,cost:100,notes:'Cone, Incendiary'},
  {id:'fire_arrows',name:'Fire Arrows',cat:'Incendiaries',era:'medieval',range:'12/24/48',damage:'2d6',ap:0,rof:2,shots:0,minSize:1,mods:1,cost:80,notes:'Incendiary, Reload 1'},
  // BLACKPOWDER
  {id:'swivel_gun',name:'Swivel Gun',cat:'Blackpowder Guns',era:'blackpowder',range:'12/24/48',damage:'2d8',ap:2,rof:1,shots:0,minSize:1,mods:1,cost:300,notes:'Reload 2, Grapeshot (Cone)'},
  {id:'light_cannon_bp',name:'Light Cannon',cat:'Blackpowder Guns',era:'blackpowder',range:'20/40/80',damage:'3d6+1',ap:4,rof:1,shots:0,minSize:2,mods:1,cost:600,notes:'Reload 3, SBT, HW'},
  {id:'med_cannon_bp',name:'Medium Cannon',cat:'Blackpowder Guns',era:'blackpowder',range:'25/50/100',damage:'4d6+1',ap:4,rof:1,shots:0,minSize:4,mods:2,cost:1500,notes:'Reload 3, SBT, HW'},
  {id:'heavy_cannon_bp',name:'Heavy Cannon',cat:'Blackpowder Guns',era:'blackpowder',range:'30/60/120',damage:'5d6',ap:6,rof:1,shots:0,minSize:6,mods:3,cost:3000,notes:'Reload 4, SBT, HW'},
  {id:'carronade',name:'Carronade',cat:'Blackpowder Guns',era:'blackpowder',range:'10/20/40',damage:'4d6+2',ap:2,rof:1,shots:0,minSize:3,mods:1,cost:800,notes:'Reload 2, Grapeshot (Cone), HW'},
  {id:'mortar_bp',name:'Mortar',cat:'Blackpowder Guns',era:'blackpowder',range:'24/48/96',damage:'3d8',ap:0,rof:1,shots:0,minSize:2,mods:1,cost:500,notes:'Reload 3, Indirect, MBT, HW'},
  {id:'congreve',name:'Congreve Rocket',cat:'Rockets',era:'blackpowder',range:'18/36/72',damage:'3d6',ap:0,rof:1,shots:6,minSize:1,mods:1,cost:400,notes:'Inaccurate (-1 Shooting), Incendiary, MBT'},
  {id:'chain_shot',name:'Chain Shot',cat:'Blackpowder Guns',era:'blackpowder',range:'15/30/60',damage:'3d6',ap:0,rof:1,shots:0,minSize:3,mods:0,cost:200,notes:'Anti-rigging. Reload 3. Targets mast/locomotion only'},
  // INDUSTRIAL (WWI/WWII era)
  {id:'hmg',name:'Heavy Machine Gun',cat:'Machine Guns',era:'industrial',range:'30/60/120',damage:'2d8',ap:2,rof:3,shots:200,minSize:1,mods:1,cost:1000,notes:'Pt Def, Rxn Fire'},
  {id:'autocannon_ww',name:'Autocannon',cat:'Cannons',era:'industrial',range:'40/80/160',damage:'2d10',ap:4,rof:3,shots:100,minSize:2,mods:1,cost:5000,notes:'HW'},
  {id:'tank_gun_light',name:'Light Tank Gun',cat:'Cannons',era:'industrial',range:'50/100/200',damage:'3d10',ap:6,rof:1,shots:60,minSize:3,mods:2,cost:10000,notes:'SBT, HW'},
  {id:'tank_gun_med',name:'Medium Tank Gun',cat:'Cannons',era:'industrial',range:'75/150/300',damage:'4d10',ap:10,rof:1,shots:40,minSize:5,mods:3,cost:20000,notes:'SBT, HW'},
  {id:'tank_gun_heavy',name:'Heavy Tank Gun',cat:'Cannons',era:'industrial',range:'100/200/400',damage:'5d10',ap:16,rof:1,shots:30,minSize:7,mods:4,cost:40000,notes:'SBT, HW'},
  {id:'flamethrower_ww',name:'Flamethrower',cat:'Flamethrowers',era:'industrial',range:'Cone',damage:'3d6',ap:0,rof:1,shots:10,minSize:1,mods:1,cost:1000,notes:'Incendiary, Cone'},
  {id:'torpedo_ww',name:'Torpedo',cat:'Torpedoes',era:'industrial',range:'50/100/200',damage:'5d10',ap:10,rof:1,shots:2,minSize:4,mods:1,cost:5000,notes:'Guided (basic), LBT, Aquatic only'},
  {id:'bombs_ww',name:'Bomb Bay',cat:'Ordnance',era:'industrial',range:'—',damage:'4d8',ap:4,rof:1,shots:10,minSize:4,mods:2,cost:3000,notes:'Aircraft only. Drop, MBT. Bombing run rules.'},
  {id:'depth_charge_ww',name:'Depth Charges',cat:'Anti-Submarine',era:'industrial',range:'—',damage:'4d8',ap:4,rof:1,shots:8,minSize:4,mods:1,cost:2000,notes:'Drop, MBT. Anti-sub only.'},
  {id:'naval_gun_ww',name:'Naval Gun',cat:'Naval Guns',era:'industrial',range:'100/200/400',damage:'5d10',ap:12,rof:1,shots:60,minSize:8,mods:4,cost:35000,notes:'SBT, HW. Deck-mounted.'},
  {id:'mine_ww',name:'Naval Mine Layer',cat:'Mines',era:'industrial',range:'—',damage:'5d10',ap:8,rof:0,shots:20,minSize:4,mods:2,cost:4000,notes:'Deploy mine per round. 3d6 trigger radius.'},
  // MODERN
  {id:'hmg_modern',name:'Heavy Machine Gun',cat:'Machine Guns',era:'modern',range:'50/100/200',damage:'2d10',ap:4,rof:3,shots:200,minSize:1,mods:1,cost:2000,notes:'Pt Def, Rxn Fire, HW'},
  {id:'minigun_modern',name:'Minigun',cat:'Machine Guns',era:'modern',range:'50/100/200',damage:'2d8+1',ap:2,rof:5,shots:2000,minSize:3,mods:1,cost:10000,notes:'Min RoF 3, Pt Def, Rxn Fire, HW'},
  {id:'autocannon_mod',name:'Light Autocannon',cat:'Autocannons',era:'modern',range:'50/100/200',damage:'3d8',ap:4,rof:4,shots:100,minSize:2,mods:1,cost:10000,notes:'Min RoF 2, Pt Def, Rxn Fire, HW'},
  {id:'cannon_mod',name:'Tank Cannon',cat:'Cannons',era:'modern',range:'100/200/400',damage:'5d10',ap:20,rof:1,shots:40,minSize:4,mods:4,cost:50000,notes:'SBT, HW'},
  {id:'atgm',name:'ATGM Launcher',cat:'Missiles',era:'modern',range:'75/150/300',damage:'5d10',ap:20,rof:1,shots:4,minSize:1,mods:1,cost:8000,notes:'Guided, SBT, HW'},
  {id:'sam',name:'SAM Launcher',cat:'Missiles',era:'modern',range:'100/200/400',damage:'5d6',ap:10,rof:1,shots:4,minSize:2,mods:1,cost:12000,notes:'Guided, SBT, HW'},
  {id:'rocket_pod',name:'Rocket Pod',cat:'Missiles',era:'modern',range:'50/100/200',damage:'4d8',ap:6,rof:3,shots:19,minSize:2,mods:1,cost:6000,notes:'SBT, HW'},
  {id:'grenade_mod',name:'Grenade Launcher',cat:'Launchers',era:'modern',range:'24/48/96',damage:'3d6',ap:0,rof:1,shots:12,minSize:0,mods:1,cost:2600,notes:'MBT'},
  {id:'torpedo_mod',name:'Modern Torpedo',cat:'Torpedoes',era:'modern',range:'100/200/400',damage:'6d10',ap:16,rof:1,shots:4,minSize:4,mods:2,cost:15000,notes:'Guided, LBT, Aquatic only'},
  {id:'ciws',name:'CIWS / Phalanx',cat:'Point Defense',era:'modern',range:'30/60/120',damage:'2d10',ap:4,rof:6,shots:1000,minSize:4,mods:2,cost:20000,notes:'Pt Def only. Auto-fire vs missiles/aircraft.'},
  {id:'naval_gun_mod',name:'Naval Gun (5-inch)',cat:'Naval Guns',era:'modern',range:'150/300/600',damage:'5d10+2',ap:14,rof:1,shots:80,minSize:8,mods:4,cost:60000,notes:'SBT, HW. Deck-mounted.'},
  {id:'cruise_missile',name:'Cruise Missile',cat:'Missiles',era:'modern',range:'500/1K/2K',damage:'8d6',ap:24,rof:1,shots:2,minSize:6,mods:2,cost:50000,notes:'Guided, LBT, HW. Extreme range.'},
  {id:'bombs_mod',name:'Bomb Bay / Hardpoint',cat:'Ordnance',era:'modern',range:'—',damage:'5d8',ap:8,rof:1,shots:8,minSize:4,mods:2,cost:5000,notes:'Aircraft only. Drop, MBT. Precision guided.'},
  {id:'depth_charge_mod',name:'Depth Charges',cat:'Anti-Submarine',era:'modern',range:'—',damage:'5d8',ap:6,rof:1,shots:6,minSize:4,mods:1,cost:5000,notes:'Drop, MBT. Anti-sub only.'},
  // FUTURE (Sci-fi standard)
  {id:'slug_future',name:'Heavy Slugthrower',cat:'Slugthrowers',era:'future',range:'50/100/200',damage:'2d10 (I)',ap:4,rof:3,shots:50,minSize:3,mods:1,cost:2000,notes:'Pt Def, Rxn Fire'},
  {id:'ac_future',name:'Medium Autocannon',cat:'Autocannons',era:'future',range:'50/100/200',damage:'4d8 (II)',ap:6,rof:4,shots:80,minSize:8,mods:2,cost:20000,notes:'Min RoF 2'},
  {id:'laser_gat',name:'Gatling Laser',cat:'Lasers',era:'future',range:'50/100/200',damage:'3d6+4 (I)',ap:4,rof:4,shots:80,minSize:1,mods:1,cost:3000,notes:'Cauterize, Overcharge, Pt Def, Rxn Fire'},
  {id:'laser_light',name:'Light Laser',cat:'Lasers',era:'future',range:'150/300/600',damage:'2d10 (II)',ap:10,rof:3,shots:80,minSize:2,mods:1,cost:20000,notes:'Cauterize, Overcharge, Rxn Fire'},
  {id:'laser_med',name:'Medium Laser',cat:'Lasers',era:'future',range:'150/300/600',damage:'3d10 (III)',ap:20,rof:2,shots:60,minSize:4,mods:3,cost:50000,notes:'Cauterize, Overcharge'},
  {id:'laser_heavy',name:'Heavy Laser',cat:'Lasers',era:'future',range:'150/300/600',damage:'4d10 (V)',ap:30,rof:1,shots:40,minSize:8,mods:5,cost:200000,notes:'Cauterize, Overcharge'},
  {id:'cannon_future',name:'Heavy Cannon',cat:'Cannons',era:'future',range:'100/200/400',damage:'5d10 (IV)',ap:20,rof:1,shots:40,minSize:4,mods:5,cost:60000,notes:'SBT'},
  {id:'cannon_super',name:'Super Cannon',cat:'Cannons',era:'future',range:'150/300/600',damage:'6d10 (VI)',ap:30,rof:1,shots:20,minSize:10,mods:6,cost:100000,notes:'MBT'},
  {id:'flamer_future',name:'Heavy Flamethrower',cat:'Flamethrowers',era:'future',range:'Cone',damage:'3d12 (I)',ap:0,rof:1,shots:30,minSize:1,mods:1,cost:5000,notes:'Cauterize, Incendiary, Cone 18"'},
  {id:'missile_light',name:'Light Missiles (×8)',cat:'Missiles',era:'future',range:'100/200/400',damage:'6d6 (III)',ap:16,rof:4,shots:8,minSize:2,mods:0,cost:4000,notes:'Guided, SBT'},
  {id:'missile_med',name:'Medium Missiles (×4)',cat:'Missiles',era:'future',range:'150/300/600',damage:'7d6 (IV)',ap:24,rof:2,shots:4,minSize:2,mods:0,cost:10000,notes:'Guided, MBT'},
  {id:'missile_heavy',name:'Heavy Missiles (×2)',cat:'Missiles',era:'future',range:'200/400/800',damage:'8d6 (V)',ap:32,rof:1,shots:2,minSize:2,mods:0,cost:20000,notes:'Guided, LBT'},
  {id:'missile_rack',name:'Missile Launcher',cat:'Missiles',era:'future',range:'—',damage:'—',ap:0,rof:0,shots:0,minSize:2,mods:1,cost:1000,notes:'Rack only. Load missiles separately.'},
  {id:'torpedo_future',name:'Plasma Torpedo',cat:'Torpedoes',era:'future',range:'100/200/400',damage:'6d10 (IV)',ap:20,rof:1,shots:4,minSize:4,mods:2,cost:20000,notes:'Guided, LBT, Aquatic/Space'},
  // ADVANCED (far-future / energy weapons)
  {id:'md_light',name:'Light Mass Driver',cat:'Mass Drivers',era:'advanced',range:'100/200/400',damage:'2d12+2 (I)',ap:5,rof:3,shots:100,minSize:2,mods:2,cost:10000,notes:'Pt Def, Rxn Fire, SBT'},
  {id:'md_med',name:'Medium Mass Driver',cat:'Mass Drivers',era:'advanced',range:'100/200/400',damage:'3d12+3 (II)',ap:5,rof:2,shots:80,minSize:4,mods:3,cost:20000,notes:'MBT'},
  {id:'pc_light',name:'Light Particle Cannon',cat:'Particle Cannons',era:'advanced',range:'100/200/400',damage:'4d6+4 (II)',ap:5,rof:3,shots:90,minSize:2,mods:2,cost:25000,notes:'Pt Def, Rxn Fire'},
  {id:'pc_med',name:'Medium Particle Cannon',cat:'Particle Cannons',era:'advanced',range:'100/200/400',damage:'6d6+6 (III)',ap:10,rof:3,shots:60,minSize:8,mods:4,cost:50000,notes:''},
  {id:'laser_super',name:'Super Laser',cat:'Lasers',era:'advanced',range:'150/300/600',damage:'5d10 (V)',ap:30,rof:1,shots:20,minSize:12,mods:8,cost:300000,notes:'Cauterize, Overcharge'},
  {id:'plasma_cannon',name:'Plasma Cannon',cat:'Energy Weapons',era:'advanced',range:'75/150/300',damage:'5d10 (IV)',ap:20,rof:1,shots:30,minSize:6,mods:4,cost:150000,notes:'Cauterize, Incendiary, SBT'},
  {id:'rail_gun',name:'Railgun',cat:'Mass Drivers',era:'advanced',range:'200/400/800',damage:'5d12 (V)',ap:40,rof:1,shots:20,minSize:8,mods:6,cost:250000,notes:'SBT, Ignores Shields'}
];
// Era labels for UI
var ERA_LABELS={ancient:'Ancient',medieval:'Medieval',blackpowder:'Blackpowder',industrial:'Industrial (WWI/WWII)',modern:'Modern',future:'Future (Sci-Fi)',advanced:'Advanced (Far-Future)'};
var ERA_ORDER=['ancient','medieval','blackpowder','industrial','modern','future','advanced'];
var currentEra='modern';
// Custom weapons storage
var customWeapons=[];
try{var cw=localStorage.getItem('diceforge-cvf-custom-weapons');if(cw)customWeapons=JSON.parse(cw)}catch(e){}
function getAllWeapons(){return WEAPONS.concat(customWeapons)}

// ═══ STATE ═══
var customWeapons=[];
try{var cw=localStorage.getItem('diceforge-cvf-custom-weapons');if(cw)customWeapons=JSON.parse(cw)}catch(e){}
function getAllWeapons(){return WEAPONS.concat(customWeapons)}

// ═══ STATE ═══
var S={name:'Untitled Vehicle',desc:'',notes:'',image:'',size:6,loco:'wheeled',mods:{},weapons:[],currentMount:'pintle',saved:[],armourTech:0};
// ═══ UNDO/REDO ENGINE ═══
var undoStack=[],redoStack=[],maxUndo=50;
function snapState(){return{mods:JSON.parse(JSON.stringify(S.mods)),weapons:JSON.parse(JSON.stringify(S.weapons)),size:S.size,loco:S.loco}}
function pushUndo(){redoStack=[];undoStack.push(snapState());if(undoStack.length>maxUndo)undoStack.shift()}
function undo(){if(!undoStack.length)return;redoStack.push(snapState());var prev=undoStack.pop();S.mods=prev.mods;S.weapons=prev.weapons;S.size=prev.size;S.loco=prev.loco;document.getElementById('sizeSlider').value=S.size;Audio.remove();renderAll()}
function redo(){if(!redoStack.length)return;undoStack.push(snapState());var next=redoStack.pop();S.mods=next.mods;S.weapons=next.weapons;S.size=next.size;S.loco=next.loco;document.getElementById('sizeSlider').value=S.size;Audio.click();renderAll()}
document.addEventListener('keydown',function(e){if((e.ctrlKey||e.metaKey)&&e.key==='z'&&!e.shiftKey){e.preventDefault();undo()}if((e.ctrlKey||e.metaKey)&&(e.key==='y'||(e.key==='z'&&e.shiftKey))){e.preventDefault();redo()}});

// ═══ CALCULATIONS ═══
function modSlots(m,sz){if(m.mods==='half')return Math.ceil(sz/2);if(m.mods==='halfneg')return -Math.ceil(sz/2);if(m.mods==='size')return sz;return m.mods}
function weaponMountMods(w,mount){var mc=w.mods;if(mount==='fixed')mc=Math.ceil(mc/2);if(mount==='turret')mc=mc*2;return mc}
function maxArmorTakes(){var f=getFrame(S.size);return Math.floor((f.maxArmor-f.baseTough)/2)}
function calcTough(){var f=getFrame(S.size),t=f.baseTough;if(S.mods.battered)t-=2*S.mods.battered;if(S.mods.lightweight)t-=2*S.mods.lightweight;if(S.mods.toughness)t+=S.mods.toughness;return Math.max(0,t)}
function calcArmor(){var f=getFrame(S.size),a=f.baseTough;if(S.mods.armor)a+=2*S.mods.armor;if(S.mods.composite_armor)a+=4*S.mods.composite_armor;a+=S.armourTech;return Math.min(a,f.maxArmor+S.armourTech)}
function calcWounds(){var f=getFrame(S.size),w=f.wounds;if(S.mods.fragile)w-=S.mods.fragile;return Math.max(1,w)}
function calcHand(){var f=getFrame(S.size),h=f.hand;if(S.mods.handling)h+=S.mods.handling;if(S.mods.reduced_hand)h-=S.mods.reduced_hand;return h}
function calcSpeed(){var loco=LOCOS.find(function(l){return l.id===S.loco});var s=loco?loco.speed:5;if(S.mods.inc_speed)s+=S.mods.inc_speed;if(S.mods.reduced_speed)s-=S.mods.reduced_speed;if(S.mods.high_perf_engine)s+=2*S.mods.high_perf_engine;return Math.max(1,s)}
function calcRoadSpeed(){var s=calcSpeed();if(S.mods.road_vehicle&&S.loco==='wheeled')s+=3;return s}
function calcEnergy(){var f=getFrame(S.size),e=f.energy;if(S.mods.reactor)e*=10;if(S.mods.energy_pod)e*=Math.pow(2,S.mods.energy_pod);if(S.mods.high_perf_engine)e=Math.max(1,Math.floor(e/Math.pow(2,S.mods.high_perf_engine)));return e}
function calcModsUsed(){var t=0;for(var id in S.mods){var m=MODS.find(function(x){return x.id===id});if(m){var ms=modSlots(m,S.size);if(ms>0)t+=ms*S.mods[id]}}
  S.weapons.forEach(function(w){var wp=getAllWeapons().find(function(x){return x.id===w.weaponId});if(wp)t+=weaponMountMods(wp,w.mount)});return t}
function calcModsGained(){var t=0;for(var id in S.mods){var m=MODS.find(function(x){return x.id===id});if(m){var ms=modSlots(m,S.size);if(ms<0)t+=Math.abs(ms)*S.mods[id]}}return t}
function calcCost(){var f=getFrame(S.size),loco=LOCOS.find(function(l){return l.id===S.loco});
  var cost=f.costMult*S.size+(loco?loco.costMult*S.size:0);
  for(var id in S.mods){var m=MODS.find(function(x){return x.id===id});if(m)cost+=m.costFn(S.size)*S.mods[id]}
  S.weapons.forEach(function(w){var wp=getAllWeapons().find(function(x){return x.id===w.weaponId});if(wp)cost+=wp.cost});
  var atInfo=AT_INFO[S.armourTech]||AT_INFO[0];if(atInfo.cost>1)cost=cost*atInfo.cost;
  return Math.max(0,cost)}
function isWalker(){return S.loco==='legs_biped'||S.loco==='legs_quad'}
function walkerStr(){return 'd12+'+S.size}
function isHeavyArmor(){return S.size>=4||isWalker()}

// ═══ IMAGE HANDLING ═══
function handleImage(e){var file=e.target.files[0];if(!file)return;
  var reader=new FileReader();reader.onload=function(ev){
    var img=new Image();img.onload=function(){
      var max=800,w=img.width,h=img.height;
      if(w>max||h>max){if(w>h){h=Math.round(h*(max/w));w=max}else{w=Math.round(w*(max/h));h=max}}
      var c=document.createElement('canvas');c.width=w;c.height=h;
      var ctx=c.getContext('2d');ctx.drawImage(img,0,0,w,h);
      S.image=c.toDataURL('image/jpeg',0.7);showImage()};
    img.src=ev.target.result};reader.readAsDataURL(file)}
function showImage(){if(S.image){document.getElementById('imgPreview').src=S.image;document.getElementById('imgPreview').style.display='block';document.getElementById('imgPlaceholder').style.display='none';document.getElementById('imgClearBtn').style.display='block';document.getElementById('imgZone').classList.add('has-img')}
  else{document.getElementById('imgPreview').style.display='none';document.getElementById('imgPlaceholder').style.display='block';document.getElementById('imgClearBtn').style.display='none';document.getElementById('imgZone').classList.remove('has-img')}}
function clearImage(){S.image='';document.getElementById('imgInput').value='';showImage()}

// ═══ IMPORT/EXPORT ═══
function exportJSON(){var data={version:'1.0',tool:'DiceForge Vehicle Forge',exported:new Date().toISOString(),
  vehicle:{name:S.name,desc:S.desc,notes:S.notes,image:S.image,size:S.size,loco:S.loco,mods:JSON.parse(JSON.stringify(S.mods)),weapons:JSON.parse(JSON.stringify(S.weapons)),armourTech:S.armourTech}};
  var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;a.download=(S.name||'vehicle').replace(/[^a-zA-Z0-9_-]/g,'_')+'.cvf.json';a.click();URL.revokeObjectURL(url)}
function importJSON(e){var file=e.target.files[0];if(!file)return;var reader=new FileReader();reader.onload=function(ev){
  try{var data=JSON.parse(ev.target.result);
    if(data.vehicle){var v=data.vehicle;S.name=v.name||'Imported Vehicle';S.desc=v.desc||'';S.notes=v.notes||'';S.image=v.image||'';S.size=v.size||6;S.loco=v.loco||'wheeled';S.mods=v.mods||{};S.weapons=v.weapons||[];S.armourTech=v.armourTech||0;
      document.getElementById('vName').value=S.name;document.getElementById('vDesc').value=S.desc;document.getElementById('vNotes').value=S.notes;document.getElementById('sizeSlider').value=S.size;
      showImage();renderAll();Audio.clunk()}
    else if(data.vehicles&&Array.isArray(data.vehicles)){data.vehicles.forEach(function(v){
        S.saved.push({name:v.name||'Imported',desc:v.desc||'',notes:v.notes||'',image:v.image||'',size:v.size||6,loco:v.loco||'wheeled',mods:v.mods||{},weapons:v.weapons||[],armourTech:v.armourTech||0})});
      localStorage.setItem('diceforge-cvf',JSON.stringify(S.saved));renderSaved();Audio.clunk();
      alert('Imported '+data.vehicles.length+' vehicles.')}
    else alert('Invalid .cvf.json file.')}catch(err){alert('Error reading file: '+err.message)}};reader.readAsText(file);e.target.value=''}
function batchExport(){if(!S.saved.length){alert('No saved vehicles to export.');return}
  var data={version:'1.0',tool:'DiceForge Vehicle Forge',exported:new Date().toISOString(),count:S.saved.length,
    vehicles:S.saved.map(function(v){return{name:v.name,desc:v.desc,notes:v.notes,image:v.image,size:v.size,loco:v.loco,mods:JSON.parse(JSON.stringify(v.mods)),weapons:JSON.parse(JSON.stringify(v.weapons)),armourTech:v.armourTech||0}})};
  var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;a.download='vehicle-pack-'+S.saved.length+'.cvf.json';a.click();URL.revokeObjectURL(url)}

// ═══ DRAG-DROP ENGINE ═══
function getXY(e){if(e.touches&&e.touches.length)return{x:e.touches[0].clientX,y:e.touches[0].clientY};if(e.changedTouches&&e.changedTouches.length)return{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY};return{x:e.clientX,y:e.clientY}}
var drag={active:false,type:null,id:null,ghost:null};
function startDrag(e,type,id,label){e.preventDefault();Audio.init();var pt=getXY(e);drag={active:true,type:type,id:id,ghost:null};var ghost=document.createElement('div');ghost.className='drag-ghost';ghost.textContent=label;ghost.style.left=pt.x+'px';ghost.style.top=pt.y+'px';document.body.appendChild(ghost);drag.ghost=ghost;var src=e.target.closest('.drag-item')||e.target.closest('.weapon-drag-item');if(src)src.classList.add('dragging');document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onEnd);document.addEventListener('touchmove',onMove,{passive:false});document.addEventListener('touchend',onEnd);document.addEventListener('touchcancel',onEnd)}
function onMove(e){if(!drag.active||!drag.ghost)return;if(e.cancelable)e.preventDefault();var pt=getXY(e);var bay=document.getElementById(drag.type==='mod'?'modBay':'weaponBay');if(bay){var r=bay.getBoundingClientRect();var inside=pt.x>=r.left&&pt.x<=r.right&&pt.y>=r.top&&pt.y<=r.bottom;bay.classList.toggle('drag-over',inside);drag.ghost.classList.toggle('near-target',!inside&&pt.x>=r.left-80&&pt.x<=r.right+80&&pt.y>=r.top-80&&pt.y<=r.bottom+80)}drag.ghost.style.left=pt.x+'px';drag.ghost.style.top=pt.y+'px'}
function onEnd(e){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onEnd);document.removeEventListener('touchmove',onMove);document.removeEventListener('touchend',onEnd);document.removeEventListener('touchcancel',onEnd);if(drag.ghost)drag.ghost.remove();document.querySelectorAll('.dragging').forEach(function(el){el.classList.remove('dragging')});var pt=getXY(e);var bay=document.getElementById(drag.type==='mod'?'modBay':'weaponBay');if(bay){var r=bay.getBoundingClientRect();if(pt.x>=r.left&&pt.x<=r.right&&pt.y>=r.top&&pt.y<=r.bottom){if(drag.type==='mod')dropMod(drag.id);else dropWeapon(drag.id);bay.classList.remove('impact');void bay.offsetWidth;bay.classList.add('impact')}bay.classList.remove('drag-over')}drag={active:false,type:null,id:null,ghost:null}}
function dropMod(id){var m=MODS.find(function(x){return x.id===id});var max=m.max==='U'?99:m.max==='frame'?maxArmorTakes():m.max;var cur=S.mods[id]||0;
  if(id==='inc_speed'&&S.mods.reduced_speed)return;if(id==='reduced_speed'&&S.mods.inc_speed)return;
  if(id==='exposed'&&S.mods.sealed)return;if(id==='sealed'&&S.mods.exposed)return;
  if(id==='fwd'&&S.loco!=='wheeled')return;if(id==='road_vehicle'&&S.loco!=='wheeled')return;if(id==='jump_jets'&&!isWalker())return;if(id==='tandem_pilots'&&!isWalker())return;
  if(cur<max){pushUndo();S.mods[id]=cur+1;Audio.clunk();renderModBay(id);renderStats();renderOutput()}}
function dropWeapon(id){var w=getAllWeapons().find(function(x){return x.id===id});if(!w||w.minSize>S.size)return;
  pushUndo();S.weapons.push({weaponId:id,mount:S.currentMount});Audio.clunk();renderWeaponBay(id);renderStats();renderOutput()}
// ═══ RENDER FUNCTIONS ═══
function renderLocoGrid(){var el=document.getElementById('locoGrid');
  el.innerHTML=LOCOS.map(function(l){return '<div class="loco-btn'+(S.loco===l.id?' active':'')+'" onclick="setLoco(\''+l.id+'\')"><span>'+l.name+'</span><span class="loco-speed">Spd '+l.speed+'</span></div>'}).join('')}
function setLoco(id){S.loco=id;Audio.click();renderLocoGrid();renderStats();renderOutput();renderModCatalogue()}
var AT_INFO={0:{name:'Standard',desc:'Baseline armour for the era. Rolled steel, iron plate, wooden hull, hide over frame. No bonus.',cost:0},4:{name:'Superior',desc:'One generation ahead of baseline. Late-war sloped welded steel, hardened alloys, early composites. +4 Armour. Cost ×2.',cost:2},8:{name:'Advanced',desc:'Two generations ahead. Chobham composite, depleted uranium layers, reactive armour packages. Modern MBTs, advanced sci-fi. +8 Armour. Cost ×4.',cost:4},12:{name:'Exotic',desc:'Three generations ahead. Alien alloys, magical wards, phased materials, energy-bonded plating. +12 Armour. Cost ×8.',cost:8}};
function setAT(v){S.armourTech=v;Audio.click();renderAT();renderStats();renderOutput()}
function renderAT(){var info=AT_INFO[S.armourTech]||AT_INFO[0];
  document.getElementById('at0').classList.toggle('active',S.armourTech===0);
  document.getElementById('at1').classList.toggle('active',S.armourTech===4);
  document.getElementById('at2').classList.toggle('active',S.armourTech===8);
  document.getElementById('at3').classList.toggle('active',S.armourTech===12);
  document.getElementById('atDesc').innerHTML=info.desc}
function setSize(sz){S.size=sz;S.mods={};S.weapons=[];document.getElementById('sizeVal').textContent=sz;document.getElementById('sizeClass').textContent=getFrame(sz).cat;renderFrameInfo();renderLocoGrid();renderModCatalogue();renderModBay();renderWeaponCatalogue();renderWeaponBay();renderStats();renderOutput()}
function renderFrameInfo(){var f=getFrame(S.size);var ref=SIZE_REF[S.size]||{len:'?',ex:'—',wt:'?'};
  document.getElementById('sizeVal').textContent=S.size;document.getElementById('sizeClass').textContent=f.cat;
  document.getElementById('frameInfo').innerHTML='<div style="font-size:12px;color:var(--text-dim);font-style:italic;margin-bottom:6px;line-height:1.4">~'+ref.len+' long, ~'+ref.wt+' — <span style="color:var(--text)">'+ref.ex+'</span></div><div class="frame-stats">'
    +'<div class="frame-stat"><div class="fs-label">Base Tough</div><div class="fs-value">'+f.baseTough+' ('+f.maxArmor+')</div></div>'
    +'<div class="frame-stat"><div class="fs-label">Wounds</div><div class="fs-value">'+f.wounds+'</div></div>'
    +'<div class="frame-stat"><div class="fs-label">Crew</div><div class="fs-value">'+f.crew+'</div></div>'
    +'<div class="frame-stat"><div class="fs-label">Energy</div><div class="fs-value">'+f.energy+' days</div></div>'
    +'<div class="frame-stat"><div class="fs-label">Base Mods</div><div class="fs-value">'+(S.size*f.modMult+f.compactBonus)+'</div></div>'
    +'<div class="frame-stat"><div class="fs-label">Frame Cost</div><div class="fs-value">$'+fmtC(f.costMult*S.size)+'</div></div></div>'}

function renderModCatalogue(){var el=document.getElementById('modCatalogue'),cats={};
  var q=(document.getElementById('modSearch').value||'').toLowerCase();
  MODS.forEach(function(m){
    if(m.id==='fwd'&&S.loco!=='wheeled')return;if(m.id==='road_vehicle'&&S.loco!=='wheeled')return;if(m.id==='jump_jets'&&!isWalker())return;if(m.id==='tandem_pilots'&&!isWalker())return;
    if(q&&m.name.toLowerCase().indexOf(q)===-1&&m.desc.toLowerCase().indexOf(q)===-1&&m.cat.toLowerCase().indexOf(q)===-1)return;
    if(!cats[m.cat])cats[m.cat]=[];cats[m.cat].push(m)});
  var h='';for(var cat in cats){h+='<div class="cat-header">'+cat+'</div>';
    cats[cat].forEach(function(m){var ms=modSlots(m,S.size);var price=m.costFn(S.size);
      h+='<div class="drag-item" onmousedown="startDrag(event,\'mod\',\''+m.id+'\',\''+m.name+'\')" ontouchstart="startDrag(event,\'mod\',\''+m.id+'\',\''+m.name+'\')">'
        +'<span class="drag-handle">&#x2807;</span>'
        +'<div class="di-info"><div class="di-name">'+m.name+'</div><div class="di-desc">'+m.desc+'</div></div>'
        +'<div class="di-meta"><div class="di-mods">'+(ms>0?ms+' mod'+(ms>1?'s':''):ms<0?'+'+Math.abs(ms)+' mod'+(Math.abs(ms)>1?'s':''):'—')+'</div>'
        +'<div class="di-price">'+(price>=0?'$'+fmtN(price):'-$'+fmtN(Math.abs(price)))+'</div></div></div>'})}
  if(!h)h='<div class="empty-state"><p>No modifications match your search.</p></div>';
  el.innerHTML=h}

function renderModBay(animId){var bay=document.getElementById('modBay');
  var inst=[];for(var k in S.mods){if(S.mods[k]>0)inst.push([k,S.mods[k]])}
  if(!inst.length){bay.innerHTML='<div class="empty-bay">Drag modifications here to install them</div>';return}
  bay.innerHTML=inst.map(function(p){var id=p[0],ct=p[1];var m=MODS.find(function(x){return x.id===id});if(!m)return '';var ms=modSlots(m,S.size)*ct;var tp=m.costFn(S.size)*ct;
    return '<div class="bay-item '+(id===animId?'snap-in':'')+'">'
      +'<div class="bi-info"><div class="bi-name">'+m.name+'</div>'
      +'<div class="bi-detail">'+(ms>0?ms+' mods':ms<0?'Grants '+Math.abs(ms)+' mods':'0 mods')+' · '+(tp>=0?'$'+fmtN(tp):'-$'+fmtN(Math.abs(tp)))+'</div></div>'
      +'<div class="bi-controls"><button onclick="modDec(\''+id+'\')">&minus;</button><span class="bi-count">'+ct+'</span><button onclick="modInc(\''+id+'\')">+</button></div>'
      +'<span class="bi-remove" onclick="modRemoveAll(\''+id+'\')">&times;</span></div>'}).join('')}
function modInc(id){dropMod(id);Audio.click()}
function modDec(id){if(S.mods[id]>0){pushUndo();S.mods[id]--;if(!S.mods[id])delete S.mods[id];Audio.click();renderModBay();renderStats();renderOutput()}}
function modRemoveAll(id){pushUndo();delete S.mods[id];Audio.remove();renderModBay();renderStats();renderOutput()}

function renderEraFilter(){var el=document.getElementById('eraFilter');
  el.innerHTML='<div class="mount-tab'+(currentEra==='all'?' active':'')+'" onclick="setEra(\'all\')" style="font-size:10px;padding:4px 10px">All</div>'+
    ERA_ORDER.map(function(e){return '<div class="mount-tab'+(currentEra===e?' active':'')+'" onclick="setEra(\''+e+'\')" style="font-size:10px;padding:4px 10px">'+ERA_LABELS[e]+'</div>'}).join('')+
    (customWeapons.length?'<div class="mount-tab'+(currentEra==='custom'?' active':'')+'" onclick="setEra(\'custom\')" style="font-size:10px;padding:4px 10px">Custom</div>':'')}
function setEra(e){currentEra=e;renderEraFilter();renderWeaponCatalogue()}

function renderWeaponCatalogue(){var cats={};
  var q=(document.getElementById('weaponSearch').value||'').toLowerCase();
  var wpns=currentEra==='all'?getAllWeapons():currentEra==='custom'?customWeapons:getAllWeapons().filter(function(w){return w.era===currentEra});
  wpns.forEach(function(w){
    if(q&&w.name.toLowerCase().indexOf(q)===-1&&w.cat.toLowerCase().indexOf(q)===-1&&w.notes.toLowerCase().indexOf(q)===-1)return;
    if(!cats[w.cat])cats[w.cat]=[];cats[w.cat].push(w)});
  var h='';for(var cat in cats){h+='<div class="cat-header">'+cat+'</div>';
    cats[cat].forEach(function(w){var ok=w.minSize<=S.size;
      h+='<div class="weapon-drag-item" style="'+(ok?'':'opacity:.4;pointer-events:none')+'" onmousedown="startDrag(event,\'weapon\',\''+w.id+'\',\''+w.name+'\')" ontouchstart="startDrag(event,\'weapon\',\''+w.id+'\',\''+w.name+'\')">'
        +'<span class="drag-handle" style="color:var(--text-dim);font-size:14px;opacity:.4">&#x2807;</span>'
        +'<div class="wdi-info"><div class="wdi-name">'+w.name+(ok?'':' (Min Size '+w.minSize+')')+(w.era&&currentEra==='all'?'<span style="font-size:10px;color:var(--text-dim);font-weight:400"> — '+(ERA_LABELS[w.era]||'Custom')+'</span>':'')+'</div>'
        +'<div class="wdi-stats">'+w.range+' · '+w.damage+' · AP '+w.ap+' · RoF '+w.rof+'</div>'
        +'<div class="wdi-stats">'+w.notes+'</div></div>'
        +'<div class="wdi-meta"><div class="wdi-mods">'+w.mods+' mod'+(w.mods!==1?'s':'')+'</div>'
        +'<div class="wdi-price">$'+fmtN(w.cost)+'</div></div></div>'})}
  if(!h)h='<div class="empty-state"><p>No weapons match your search.</p></div>';
  document.getElementById('weaponCatalogue').innerHTML=h}

function renderWeaponBay(animId){var bay=document.getElementById('weaponBay');
  if(!S.weapons.length){bay.innerHTML='<div class="empty-bay">Drag weapons here to mount them</div>';return}
  bay.innerHTML=S.weapons.map(function(w,i){var wp=getAllWeapons().find(function(x){return x.id===w.weaponId});if(!wp)return '';
    var mc=weaponMountMods(wp,w.mount);var ml=w.mount==='fixed'?'Fixed Front':w.mount==='turret'?'Turret':'Pintle';
    return '<div class="weapon-bay-item '+(w.weaponId===animId&&i===S.weapons.length-1?'snap-in':'')+'">'
      +'<div class="wbi-info"><div class="wbi-name">'+wp.name+'</div>'
      +'<div class="wbi-stats">'+wp.range+' · '+wp.damage+' · AP '+wp.ap+' · '+wp.notes+'</div>'
      +'<div class="wbi-mount"><span onclick="cycleMount('+i+')" style="cursor:pointer;text-decoration:underline;text-decoration-style:dotted;text-underline-offset:2px" title="Click to change mount type">'+ml+'</span> · '+mc+' mod'+(mc!==1?'s':'')+' · $'+fmtN(wp.cost)+'</div></div>'
      +'<span class="wbi-remove" onclick="removeWeapon('+i+')">&times;</span></div>'}).join('')}
function switchMount(m){S.currentMount=m;document.querySelectorAll('.mount-tab').forEach(function(t){t.classList.toggle('active',t.dataset.mount===m)})}
function removeWeapon(i){pushUndo();S.weapons.splice(i,1);Audio.remove();renderWeaponBay();renderStats();renderOutput()}
function cycleMount(i){pushUndo();var order=['pintle','fixed','turret'];var cur=order.indexOf(S.weapons[i].mount);S.weapons[i].mount=order[(cur+1)%3];Audio.click();renderWeaponBay();renderStats();renderOutput()}
function toggleCustomForm(){var el=document.getElementById('customForm');
  if(el.style.display==='none'){el.style.display='block';
    el.innerHTML='<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">'
      +'<input type="text" id="cw_name" placeholder="Name" style="grid-column:1/3;background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="text" id="cw_cat" placeholder="Category" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="text" id="cw_range" placeholder="Range" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="text" id="cw_damage" placeholder="Damage" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="number" id="cw_ap" placeholder="AP" value="0" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="number" id="cw_rof" placeholder="RoF" value="1" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="number" id="cw_shots" placeholder="Shots" value="20" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="number" id="cw_minsize" placeholder="Min Size" value="1" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="number" id="cw_mods" placeholder="Mods" value="1" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="number" id="cw_cost" placeholder="Cost" value="5000" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="text" id="cw_notes" placeholder="Notes (e.g. HW, SBT)" style="grid-column:1/3;background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'</div><button class="header-btn" onclick="addCustomWeapon()" style="width:100%;margin-top:6px;text-align:center">Add Weapon</button>'}
  else{el.style.display='none'}}
function addCustomWeapon(){var n=document.getElementById('cw_name').value.trim();if(!n)return;
  var w={id:'custom_'+Date.now(),name:n,cat:document.getElementById('cw_cat').value.trim()||'Custom',era:'custom',
    range:document.getElementById('cw_range').value.trim()||'—',damage:document.getElementById('cw_damage').value.trim()||'—',
    ap:+(document.getElementById('cw_ap').value)||0,rof:+(document.getElementById('cw_rof').value)||1,
    shots:+(document.getElementById('cw_shots').value)||0,minSize:+(document.getElementById('cw_minsize').value)||1,
    mods:+(document.getElementById('cw_mods').value)||1,cost:+(document.getElementById('cw_cost').value)||0,
    notes:document.getElementById('cw_notes').value.trim()||''};
  customWeapons.push(w);localStorage.setItem('diceforge-cvf-custom-weapons',JSON.stringify(customWeapons));
  Audio.clunk();document.getElementById('customForm').style.display='none';renderEraFilter();renderWeaponCatalogue()}
// ═══ STATS & OUTPUT ═══
function renderStats(){var f=getFrame(S.size),used=calcModsUsed(),gained=calcModsGained(),total=(S.size*f.modMult+f.compactBonus)+gained,left=total-used;var spd=calcSpeed();var rspd=calcRoadSpeed();var spdLabel=rspd>spd?'Off-Road':'Top Speed';var spdExtra=rspd>spd?'<div class="stat-box"><div class="stat-label">Road Speed</div><div class="stat-value">'+rspd+' ('+speedMPH(rspd)+' MPH)</div></div>':'';
  document.getElementById('statsGrid').innerHTML=
    '<div class="stat-box"><div class="stat-label">Toughness</div><div class="stat-value">'+calcTough()+' ('+calcArmor()+')</div></div>'
    +'<div class="stat-box"><div class="stat-label">Wounds</div><div class="stat-value">'+calcWounds()+'</div></div>'
    +'<div class="stat-box"><div class="stat-label">Handling</div><div class="stat-value">'+(calcHand()>=0?'+':'')+calcHand()+'</div></div>'
    +'<div class="stat-box"><div class="stat-label">'+spdLabel+'</div><div class="stat-value">'+spd+' ('+speedMPH(spd)+' MPH)</div></div>'
    +spdExtra
    +'<div class="stat-box"><div class="stat-label">Crew</div><div class="stat-value">'+f.crew+'</div></div>'
    +(isWalker()?'<div class="stat-box"><div class="stat-label">Strength</div><div class="stat-value" style="color:var(--accent)">'+walkerStr()+'</div></div>':'')
    +'<div class="stat-box"><div class="stat-label">Energy</div><div class="stat-value">'+calcEnergy()+' days</div></div>';
  var cls=left<0?'over':left<=2?'low':'ok';
  document.getElementById('modsRemaining').innerHTML='<div class="big-num '+cls+'">'+left+'</div><div class="sub">Mods Remaining</div>';
  document.getElementById('costDisplay').innerHTML='<div class="cost-val">$'+fmtC(calcCost())+'</div><div class="cost-label">Total Cost</div>'}

function renderOutput(){var p=document.getElementById('outputContent'),f=getFrame(S.size);
  var loco=LOCOS.find(function(l){return l.id===S.loco});var spd=calcSpeed();
  var used=calcModsUsed(),gained=calcModsGained(),left=((S.size*f.modMult+f.compactBonus)+gained)-used;
  var notes=[];MODS.forEach(function(m){if(S.mods[m.id]>0)notes.push(S.mods[m.id]>1?S.mods[m.id]+'× '+m.name:m.name)});
  var wl=[];S.weapons.forEach(function(w){var wp=getAllWeapons().find(function(x){return x.id===w.weaponId});if(wp){var ml=w.mount==='fixed'?'Fixed Front':w.mount==='turret'?'Turret':'Pintle';
    wl.push(wp.name+' ('+ml+'): Range '+wp.range+', Damage '+wp.damage+', AP '+wp.ap+', RoF '+wp.rof+(wp.notes?', '+wp.notes:''))}});
  var special=[];
  if(isHeavyArmor())special.push('Heavy Armor');
  if(loco)special.push(loco.name+': '+loco.notes);
  if(isWalker())special.push('Piloting skill. Parry 2 + ½ Piloting + Handling. Fighting = lower of Piloting/Fighting. Always armed (Str '+walkerStr()+' damage, HW).');
  if(S.mods.shields)special.push('Shields: '+Math.floor(calcWounds()/2)+' charges, Soak with Electronics.');
  if(S.mods.reactor)special.push('Reactor: Energy ×10. Locomotion Crit on odd die = explosion.');
  if(S.mods.stabilizer)special.push('Stabilizer: No Unstable Platform penalty.');
  if(S.mods.targeting)special.push('Targeting: -2 Shooting penalties.');
  if(S.mods.submersible)special.push('Submersible'+(S.mods.submersible>1?' (Deep Dive)':'')+': Submerge as action. -4 to detect when submerged.');
  if(S.mods.composite_armor)special.push('Composite Armour: Advanced armour composition.');
  if(S.armourTech>0){var ati=AT_INFO[S.armourTech];special.push(ati.name+' Armour Technology: +'+S.armourTech+' Armour. Cost ×'+ati.cost+'.'); }
  if(S.mods.road_vehicle)special.push('Road Vehicle: Speed '+calcRoadSpeed()+' ('+speedMPH(calcRoadSpeed())+' MPH) on paved roads.');
  if(S.mods.high_perf_engine)special.push('High-Performance Engine'+(S.mods.high_perf_engine>1?' ×'+S.mods.high_perf_engine:'')+': Halve Energy per take.');

  var imgHtml=S.image?'<div style="text-align:center;margin-bottom:10px"><img src="'+S.image+'" style="max-width:100%;max-height:250px;border:1px solid var(--border)"></div>':'';
  var descHtml=S.desc?'<div style="font-size:13px;font-style:italic;color:var(--text);margin-bottom:8px;line-height:1.4">'+esc(S.desc)+'</div>':'';
  var notesHtml=S.notes?'<div style="font-size:12px;color:var(--text-dim);margin-top:8px;padding-top:6px;border-top:1px solid var(--border);line-height:1.4"><span class="sb-label">GM Notes:</span> '+esc(S.notes)+'</div>':'';

  p.innerHTML=imgHtml+'<div class="stat-block">'
    +'<div class="sb-name">'+(S.name||'Untitled Vehicle')+'</div>'
    +descHtml
    +'<div class="sb-type">Size '+S.size+' ('+f.cat+'), '+loco.name+', Handling '+(calcHand()>=0?'+':'')+calcHand()+', Top Speed '+spd+' ('+speedMPH(spd)+' MPH)</div>'
    +'<hr class="sb-divider">'
    +'<div class="sb-line"><span class="sb-label">Toughness:</span> '+calcTough()+' ('+calcArmor()+')</div>'
    +'<div class="sb-line"><span class="sb-label">Wounds:</span> '+calcWounds()+'</div>'
    +'<div class="sb-line"><span class="sb-label">Crew:</span> '+f.crew+'</div>'
    +(isWalker()?'<div class="sb-line"><span class="sb-label">Strength:</span> '+walkerStr()+'</div>':'')
    +'<div class="sb-line"><span class="sb-label">Energy:</span> '+calcEnergy()+' days</div>'
    +'<div class="sb-line"><span class="sb-label">Cost:</span> $'+fmtC(calcCost())+', Mods '+left+' remaining</div>'
    +'<hr class="sb-divider">'
    +(notes.length?'<div class="sb-line"><span class="sb-label">Mods:</span> '+notes.join(', ')+'.</div>':'')
    +(wl.length?'<div class="sb-line"><span class="sb-label">Weapons:</span></div>'+wl.map(function(w){return '<div class="sb-line">&nbsp;&nbsp;• '+w+'</div>'}).join(''):'')
    +(special.length?'<hr class="sb-divider"><div class="sb-notes"><span class="sb-label">Special:</span> '+special.join(' ')+'</div>':'')
    +notesHtml
    +'<div class="sb-watermark">Built with DiceForge Vehicle Forge · diceforgestudios.pages.dev</div>'
    +'</div>'
    +'<div style="margin-top:16px;display:flex;gap:8px"><button class="header-btn" onclick="copyBlock()">Copy to Clipboard</button><button class="header-btn" onclick="exportJSON()">Export .json</button><button class="header-btn" onclick="printStatBlock()">Print</button></div>'}
function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>')}

function copyBlock(){var f=getFrame(S.size),loco=LOCOS.find(function(l){return l.id===S.loco});var spd=calcSpeed();
  var left=((S.size*f.modMult+f.compactBonus)+calcModsGained())-calcModsUsed();
  var notes=[],wl=[];
  MODS.forEach(function(m){if(S.mods[m.id]>0)notes.push(S.mods[m.id]>1?S.mods[m.id]+'x '+m.name:m.name)});
  S.weapons.forEach(function(w){var wp=getAllWeapons().find(function(x){return x.id===w.weaponId});if(wp){var ml=w.mount==='fixed'?'Fixed':w.mount==='turret'?'Turret':'Pintle';wl.push('  * '+wp.name+' ('+ml+'): '+wp.range+', '+wp.damage+', AP '+wp.ap+', RoF '+wp.rof)}});
  var t=S.name+'\n';if(S.desc)t+=S.desc+'\n';
  t+='Size '+S.size+' ('+f.cat+'), '+loco.name+', Hand '+(calcHand()>=0?'+':'')+calcHand()+', Top Speed '+spd+' ('+speedMPH(spd)+' MPH)\nTough '+calcTough()+' ('+calcArmor()+'), Wounds '+calcWounds()+', Crew '+f.crew+(isWalker()?', Str '+walkerStr():'')+'\nEnergy '+calcEnergy()+' days, Cost $'+fmtC(calcCost())+', Mods '+left+' remaining\n';
  if(notes.length)t+='Mods: '+notes.join(', ')+'.\n';if(wl.length)t+='Weapons:\n'+wl.join('\n')+'\n';
  if(isHeavyArmor())t+='Special: Heavy Armor.';if(isWalker())t+=' Walker rules apply.';
  t+='\n— Built with DiceForge Vehicle Forge';
  navigator.clipboard.writeText(t).then(function(){var btn=event.target;btn.textContent='Copied!';btn.style.borderColor='var(--green)';btn.style.color='var(--green)';setTimeout(function(){btn.textContent='Copy to Clipboard';btn.style.borderColor='';btn.style.color=''},1500)})}
// ═══ COMPREHENSIVE HELP/REFERENCE PANEL ═══
function buildHelp(){
  var h='';
  // SECTION: Quick Start
  h+='<div class="help-section" data-help="quick start overview how to use"><h3>Quick Start Guide</h3>';
  h+='<p><span class="rule-key">1. Name your vehicle</span> in the sidebar — add a description, notes, and optionally upload an image.</p>';
  h+='<p><span class="rule-key">2. Set Size</span> using the slider (1–20). This determines your frame category, base stats, and available Mods.</p>';
  h+='<p><span class="rule-key">3. Choose Main Locomotion</span> — wheeled, tracked, hover, VTOL, jet, turboprop, water, or walker (biped/multileg). Use Variable Form for secondary modes.</p>';
  h+='<p><span class="rule-key">4. Install Modifications</span> by dragging them from the catalogue into the Installed bay. Negative Qualities give Mods back.</p>';
  h+='<p><span class="rule-key">5. Mount Weapons</span> — select your mount type (Pintle, Fixed, Turret), then drag weapons into the Hardpoints bay.</p>';
  h+='<p><span class="rule-key">6. Review your Stat Block</span> on the output tab. Copy to clipboard or export as .json to share.</p>';
  h+='</div>';

  // SECTION: Vehicle Frames
  h+='<div class="help-section" data-help="frames size category normal large huge gargantuan toughness wounds crew energy mods cost"><h3>Vehicle Frames</h3>';
  h+='<p>Every vehicle begins with a frame determined by its Size. The frame sets base Toughness, maximum Armor, Wounds, Crew capacity, Energy, available Mod slots, and base cost.</p>';
  h+='<table><tr><th>Category</th><th>Size</th><th>Hand</th><th>Tough (Max)</th><th>Wounds</th><th>Crew</th><th>Energy</th><th>Mods</th><th>Cost</th></tr>';
  h+='<tr><td>Normal</td><td>1–3</td><td>+1</td><td>5 (20)</td><td>3</td><td>1</td><td>3</td><td>Size×3</td><td>$10K×Size</td></tr>';
  h+='<tr><td>Large</td><td>4–7</td><td>0</td><td>10 (30)</td><td>4</td><td>3</td><td>5</td><td>Size×3</td><td>$30K×Size</td></tr>';
  h+='<tr><td>Huge</td><td>8–11</td><td>-1</td><td>15 (40)</td><td>5</td><td>5</td><td>15</td><td>Size×3</td><td>$50K×Size</td></tr>';
  h+='<tr><td>Gargantuan</td><td>12–20</td><td>-2</td><td>20 (50)</td><td>6</td><td>50</td><td>30</td><td>Size×4</td><td>$1M×Size</td></tr>';
  h+='</table><p><span class="rule-key">Heavy Armor:</span> All vehicles Size 4+ and all walkers have Heavy Armor — only Heavy Weapons can damage them.</p>';
  h+='<p><span class="rule-key">Unused Mods</span> represent cargo space — approximately 125 cubic feet per unused slot.</p></div>';

  // SECTION: Size Reference
  h+='<div class="help-section" data-help="size reference length weight examples dimensions"><h3>Size Reference</h3>';
  h+='<table><tr><th>Size</th><th>Length</th><th>Weight</th><th>Examples</th></tr>';
  for(var i=1;i<=24;i++){var r=SIZE_REF[i];h+='<tr'+(i>=21?' style="color:#997700;font-style:italic"':'')+'>'+
    '<td>'+i+'</td><td>~'+r.len+'</td><td>~'+r.wt+'</td><td>'+r.ex+'</td></tr>'}
  h+='<tr><td colspan="4" style="font-size:10px;color:#888;padding:6px">* Size 21+ extrapolated beyond published Savage Worlds tables. Use as guidelines. Consider mass combat rules for fleet-scale engagements.</td></tr>'
  h+='</table></div>';

  // SECTION: Locomotion
  h+='<div class="help-section" data-help="locomotion wheeled tracked hover vtol turboprop jet water walker legs bipedal quadruped speed"><h3>Locomotion Types</h3>';
  h+='<table><tr><th>Type</th><th>Speed</th><th>Cost</th><th>Notes</th></tr>';
  LOCOS.forEach(function(l){h+='<tr><td>'+l.name+'</td><td>'+l.speed+'</td><td>$'+fmtN(l.costMult)+'×Size</td><td>'+l.notes+'</td></tr>'});
  h+='</table>';
  h+='<h4>Multiple Locomotion</h4><p>A vehicle may have more than one locomotion type. Buy the cheapest first. Additional forms require Mods equal to half Size and cost double the second form\'s locomotion price. A third form costs the same Mods but triple the price.</p>';
  h+='<h4>Minimum Speeds</h4><p><span class="rule-key">Turboprop:</span> Minimum 60 MPH or Out of Control. <span class="rule-key">Jet:</span> Minimum 120 MPH or Out of Control. <span class="rule-key">VTOL:</span> Can hover at 0 speed.</p></div>';

  // SECTION: Speed Rating Table
  h+='<div class="help-section" data-help="speed rating mph miles per hour chase"><h3>Speed Rating Table</h3>';
  h+='<table><tr><th>Rating</th><th>MPH</th><th>Rating</th><th>MPH</th></tr>';
  var sr=Object.keys(SPD_TABLE);for(var i=0;i<sr.length;i+=2){h+='<tr><td>'+sr[i]+'</td><td>'+SPD_TABLE[sr[i]]+'</td>'+(sr[i+1]?'<td>'+sr[i+1]+'</td><td>'+SPD_TABLE[sr[i+1]]+'</td>':'<td></td><td></td>')+'</tr>'}
  h+='</table></div>';

  // SECTION: Modifications Reference
  h+='<div class="help-section" data-help="modifications mods negative qualities core defensive systems locomotion power offensive personnel structural"><h3>All Modifications</h3>';
  var mcats={};MODS.forEach(function(m){if(!mcats[m.cat])mcats[m.cat]=[];mcats[m.cat].push(m)});
  for(var cat in mcats){h+='<h4>'+cat+'</h4><table><tr><th>Name</th><th>Mods</th><th>Max</th><th>Cost</th><th>Description</th></tr>';
    mcats[cat].forEach(function(m){var ms=modSlots(m,6);h+='<tr><td>'+m.name+'</td><td>'+(ms>0?ms:ms<0?ms:'0')+'</td><td>'+(m.max==='U'?'∞':m.max==='frame'?'Frame':m.max)+'</td><td>'+
      (m.costFn(6)>=0?'$'+fmtN(m.costFn(6)):'-$'+fmtN(Math.abs(m.costFn(6))))+'*</td><td>'+m.desc+'</td></tr>'});
    h+='</table>'}
  h+='<p class="rule-note">* Costs shown at Size 6. Most scale with Size (×Size). Some are flat costs.</p></div>';

  // SECTION: Weapons Reference
  h+='<div class="help-section" data-help="weapons catalogue ancient medieval blackpowder industrial modern future advanced damage range ap rof"><h3>All Weapons by Era</h3>';
  ERA_ORDER.forEach(function(era){
    var ewpns=WEAPONS.filter(function(w){return w.era===era});if(!ewpns.length)return;
    h+='<h4>'+ERA_LABELS[era]+'</h4><table><tr><th>Name</th><th>Range</th><th>Damage</th><th>AP</th><th>RoF</th><th>Mods</th><th>Cost</th><th>Notes</th></tr>';
    ewpns.forEach(function(w){h+='<tr><td>'+w.name+'</td><td>'+w.range+'</td><td>'+w.damage+'</td><td>'+w.ap+'</td><td>'+w.rof+'</td><td>'+w.mods+'</td><td>$'+fmtN(w.cost)+'</td><td>'+w.notes+'</td></tr>'});
    h+='</table>'});
  h+='</div>';

  // SECTION: Weapon Mounts
  h+='<div class="help-section" data-help="weapon mounts pintle fixed turret linked arc fire"><h3>Weapon Mounts</h3>';
  h+='<table><tr><th>Mount</th><th>Mod Cost</th><th>Arc</th><th>Notes</th></tr>';
  h+='<tr><td>Pintle</td><td>Standard</td><td>180°</td><td>Default mount. Requires a crew member to operate.</td></tr>';
  h+='<tr><td>Fixed</td><td>½ (round up)</td><td>45°</td><td>Forward-facing only. Pilot fires. Cheapest option.</td></tr>';
  h+='<tr><td>Turret</td><td>×2</td><td>360°</td><td>Full rotation. Most expensive but most versatile.</td></tr>';
  h+='</table>';
  h+='<h4>Linked Weapons</h4><p><span class="rule-key">Dual Linked:</span> Two identical weapons fire as one. +1 to hit, +2 damage, +1 Mod over single. <span class="rule-key">Quad Linked:</span> Four identical weapons. +2 to hit, +4 damage, +3 Mods over single.</p></div>';

  // SECTION: Walker Rules
  h+='<div class="help-section" data-help="walker mech bipedal quadruped fighting parry stomp death from above strength prone critical hit"><h3>Walker Combat Rules</h3>';
  h+='<p>Walkers (bipedal and quadruped) use Piloting skill for movement and follow special combat rules.</p>';
  h+='<p><span class="rule-key">Strength:</span> d12 + Size. Used for melee damage. Walkers are always considered armed (Heavy Weapon).</p>';
  h+='<p><span class="rule-key">Fighting:</span> Use the lower of operator\'s Piloting or Fighting. Parry = 2 + half Piloting die + Handling modifier.</p>';
  h+='<p><span class="rule-key">Running:</span> Piloting roll each round. Failure = Out of Control. Success = +1 Speed Rating. Raise = +2 Speed Ratings.</p>';
  h+='<p><span class="rule-key">Stomp:</span> Gargantuan walkers only. Use blast template matching Scale. Opposed Athletics vs target\'s Agility. Damage = Strength. Ignores Scale penalties.</p>';
  h+='<p><span class="rule-key">Death From Above:</span> Opposed Piloting vs target. Success = Ram damage + d6 per Scale category exceeding target. Failure = miss + Out of Control.</p>';
  h+='<p><span class="rule-key">Prone:</span> Free action requiring Piloting roll. Standing: success = half movement, raise = full movement retained.</p>';
  h+='<p><span class="rule-key">Multileg Advantage:</span> 3+ legs provide inherent stability. Reroll failed Piloting rolls to avoid Out of Control.</p>';
  h+='<p><span class="rule-key">Critical Hits:</span> Called Shot to leg = Locomotion Crit (Speed -1). Called Shot to arm = System Crit. When nothing is left to destroy, reactor breach: Size × d10 damage in a 10" blast radius.</p></div>';

  // SECTION: Vehicle Combat
  h+='<div class="help-section" data-help="vehicle combat unstable platform shooting chase clash collision ram"><h3>Vehicle Combat Quick Reference</h3>';
  h+='<p><span class="rule-key">Unstable Platform:</span> -2 to Shooting from a moving vehicle (-4 with Rough Ride). Negated by Stabilizer mod.</p>';
  h+='<p><span class="rule-key">Evasion:</span> Handling modifier applies to avoiding attacks and maneuvers.</p>';
  h+='<p><span class="rule-key">Scale:</span> Vehicles attacking smaller targets suffer Scale penalties (and vice versa). See Savage Worlds core rules.</p>';
  h+='<p><span class="rule-key">Collision/Ram:</span> Damage = vehicle\'s base Toughness (plus Strength for walkers) as a melee attack. Both vehicles take damage.</p>';
  h+='<p><span class="rule-key">Chase Rules:</span> Use Speed Ratings to determine chase positions. Piloting/Driving rolls each round to gain or lose ground.</p></div>';

  // SECTION: Weapon Notes
  h+='<div class="help-section" data-help="weapon notes abbreviations SBT MBT LBT guided cauterize overcharge incendiary point defense reaction fire reload heavy weapon"><h3>Weapon Notes Glossary</h3>';
  h+='<table><tr><th>Abbreviation</th><th>Meaning</th></tr>';
  h+='<tr><td>HW</td><td>Heavy Weapon — can damage Heavy Armor targets</td></tr>';
  h+='<tr><td>SBT</td><td>Small Blast Template (2" radius)</td></tr>';
  h+='<tr><td>MBT</td><td>Medium Blast Template (4" radius)</td></tr>';
  h+='<tr><td>LBT</td><td>Large Blast Template (6" radius)</td></tr>';
  h+='<tr><td>Cone</td><td>Cone Template (9" default or as noted)</td></tr>';
  h+='<tr><td>Guided</td><td>Weapon tracks target. +2 Shooting. Can be jammed by AM/ECM.</td></tr>';
  h+='<tr><td>Cauterize</td><td>Energy weapon. Seals wounds on contact.</td></tr>';
  h+='<tr><td>Overcharge</td><td>Spend extra shot for +1d damage. Risk of burnout on 1.</td></tr>';
  h+='<tr><td>Incendiary</td><td>Target catches fire on hit. See Fire rules.</td></tr>';
  h+='<tr><td>Pt Def</td><td>Point Defense — can fire at incoming missiles/torpedoes.</td></tr>';
  h+='<tr><td>Rxn Fire</td><td>Reaction Fire — can fire during enemy movement.</td></tr>';
  h+='<tr><td>Reload X</td><td>Requires X actions to reload between shots.</td></tr>';
  h+='<tr><td>Indirect</td><td>Can fire over obstacles without line of sight.</td></tr>';
  h+='<tr><td>AP X</td><td>Armor Piercing — ignores X points of Armor.</td></tr>';
  h+='<tr><td>(I)–(VI)</td><td>Sci-fi weapon class rating for compatibility.</td></tr>';
  h+='</table></div>';

  // SECTION: Import/Export
  h+='<div class="help-section" data-help="import export json save load file share"><h3>Saving, Loading &amp; Sharing</h3>';
  h+='<p><span class="rule-key">Save:</span> Stores the current vehicle in your browser\'s local storage. Saved vehicles appear in the sidebar list and persist between sessions.</p>';
  h+='<p><span class="rule-key">Export .json:</span> Downloads a .cvf.json file containing the complete vehicle build, including image, description, and notes. Share this file with other users.</p>';
  h+='<p><span class="rule-key">Import .json:</span> Load a previously exported .cvf.json file. Restores all settings, mods, weapons, image, and notes.</p>';
  h+='<p><span class="rule-key">Custom Weapons:</span> Weapons you create via the "Add Custom Weapon" button are stored separately in your browser and appear across all vehicles.</p></div>';

  // SECTION: About
  h+='<div class="help-section" data-help="about credits diceforge studios savage worlds compatible"><h3>About Vehicle Forge</h3>';
  h+='<p>Vehicle Forge is a universal vehicle construction toolkit fully compatible with Savage Worlds. It covers every vehicle type from ancient war chariots to far-future hover carriers — ground, air, water, and walker — in a single tool.</p>';
  h+='<p>71 weapons across 7 historical eras (Ancient through Advanced), 40+ modifications, 10 locomotion types, and sizes from 1 (motorcycle) to 20 (mega-platform). Plus custom weapon entry for anything your setting needs.</p>';
  h+='<p style="font-size:12px;color:var(--text-dim);margin-top:8px">This product is not affiliated with or endorsed by Pinnacle Entertainment Group. Savage Worlds and all related marks and logos are trademarks of Pinnacle Entertainment Group. Used with permission.</p></div>';

  return h}

function filterHelp(){var q=(document.getElementById('helpSearch').value||'').toLowerCase();
  document.querySelectorAll('.help-section').forEach(function(s){
    if(!q){s.style.display='';return}
    var tags=(s.dataset.help||'')+' '+s.textContent.toLowerCase();
    s.style.display=tags.indexOf(q)>=0?'':'none'})}

// ═══ TABS, SAVE/LOAD, UTILS ═══
function switchTab(tab){document.querySelectorAll('.tab').forEach(function(t){t.classList.toggle('active',t.dataset.tab===tab)});document.querySelectorAll('.panel').forEach(function(p){p.classList.toggle('active',p.id==='panel-'+tab)});if(tab==='output')renderOutput()}
function newVehicle(){S={name:'Untitled Vehicle',desc:'',notes:'',image:'',size:6,loco:'wheeled',mods:{},weapons:[],currentMount:'pintle',saved:S.saved,armourTech:0};document.getElementById('vName').value=S.name;document.getElementById('vDesc').value='';document.getElementById('vNotes').value='';document.getElementById('sizeSlider').value=6;clearImage();undoStack=[];redoStack=[];renderAll()}
function duplicateVehicle(){S.name=(S.name||'Vehicle')+' (copy)';document.getElementById('vName').value=S.name;saveVehicle();Audio.clunk()}
function printStatBlock(){var f=getFrame(S.size),loco=LOCOS.find(function(l){return l.id===S.loco}),spd=calcSpeed();
  var used=calcModsUsed(),gained=calcModsGained(),left=((S.size*f.modMult+f.compactBonus)+gained)-used;
  var notes=[];MODS.forEach(function(m){if(S.mods[m.id]>0)notes.push(S.mods[m.id]>1?S.mods[m.id]+'× '+m.name:m.name)});
  var wl=[];S.weapons.forEach(function(w){var wp=getAllWeapons().find(function(x){return x.id===w.weaponId});if(wp){var ml=w.mount==='fixed'?'Fixed Front':w.mount==='turret'?'Turret':'Pintle';wl.push(wp.name+' ('+ml+'): Range '+wp.range+', Damage '+wp.damage+', AP '+wp.ap+', RoF '+wp.rof+(wp.notes?', '+wp.notes:''))}});
  var special=[];
  if(isHeavyArmor())special.push('Heavy Armor');if(loco)special.push(loco.name+': '+loco.notes);
  if(isWalker())special.push('Str '+walkerStr()+' melee (HW).');
  if(S.mods.shields)special.push('Shields: '+Math.floor(calcWounds()/2)+' charges.');
  if(S.mods.reactor)special.push('Reactor.');if(S.mods.stabilizer)special.push('Stabilizer.');if(S.mods.targeting)special.push('Targeting System.');
  if(S.mods.submersible)special.push('Submersible'+(S.mods.submersible>1?' (Deep)':'')+'.');
  if(S.mods.composite_armor)special.push('Composite Armour.');
  if(S.armourTech>0){var ati=AT_INFO[S.armourTech];special.push(ati.name+' Armour (+'+S.armourTech+').'); }
  if(S.mods.road_vehicle)special.push('Road Speed '+calcRoadSpeed()+' ('+speedMPH(calcRoadSpeed())+' MPH).');
  if(S.mods.high_perf_engine)special.push('High-Perf Engine'+(S.mods.high_perf_engine>1?' ×'+S.mods.high_perf_engine:'')+'. Halve Energy.');
  var imgTag=S.image?'<img src="'+S.image+'" style="max-width:100%;max-height:200px;display:block;margin:0 auto 8px">':'';
  var descLine=S.desc?'<p style="font-style:italic;margin:4px 0">'+esc(S.desc)+'</p>':'';
  var notesLine=S.notes?'<p style="font-size:11px;color:#666;margin-top:8px;border-top:1px solid #ccc;padding-top:6px"><strong>GM Notes:</strong> '+esc(S.notes)+'</p>':'';
  var win=window.open('','_blank','width=700,height=900');
  win.document.write('<!DOCTYPE html><html><head><title>'+esc(S.name)+' — Stat Block</title>'
    +'<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Georgia,serif;font-size:13px;line-height:1.5;padding:24px;color:#111;max-width:600px;margin:0 auto}'
    +'h1{font-size:20px;border-bottom:2px solid #333;padding-bottom:4px;margin-bottom:4px}'
    +'.type{font-size:12px;color:#555;font-style:italic;margin-bottom:6px}'
    +'hr{border:none;border-top:1px solid #999;margin:6px 0}'
    +'.line{margin:2px 0}.label{font-weight:bold}'
    +'.special{font-size:12px;font-style:italic;color:#444}'
    +'.watermark{font-size:9px;color:#aaa;text-align:right;margin-top:12px}'
    +'@media print{body{padding:12px}.watermark{color:#ccc}}</style></head><body>'
    +imgTag
    +'<h1>'+esc(S.name)+'</h1>'
    +descLine
    +'<div class="type">Size '+S.size+' ('+f.cat+'), '+loco.name+', Handling '+(calcHand()>=0?'+':'')+calcHand()+', Top Speed '+spd+' ('+speedMPH(spd)+' MPH)</div>'
    +'<hr>'
    +'<div class="line"><span class="label">Toughness:</span> '+calcTough()+' ('+calcArmor()+')</div>'
    +'<div class="line"><span class="label">Wounds:</span> '+calcWounds()+'</div>'
    +'<div class="line"><span class="label">Crew:</span> '+f.crew+'</div>'
    +(isWalker()?'<div class="line"><span class="label">Strength:</span> '+walkerStr()+'</div>':'')
    +'<div class="line"><span class="label">Energy:</span> '+calcEnergy()+' days</div>'
    +'<div class="line"><span class="label">Cost:</span> $'+fmtC(calcCost())+'</div>'
    +'<hr>'
    +(notes.length?'<div class="line"><span class="label">Mods:</span> '+notes.join(', ')+'.</div>':'')
    +(wl.length?'<div class="line"><span class="label">Weapons:</span></div>'+wl.map(function(w){return '<div class="line">&nbsp;&nbsp;• '+w+'</div>'}).join(''):'')
    +(special.length?'<hr><div class="special"><span class="label">Special:</span> '+special.join(' ')+'</div>':'')
    +notesLine
    +'<div class="watermark">Built with DiceForge Vehicle Forge · diceforgestudios.pages.dev</div>'
    +'<script>window.onload=function(){window.print()}<\/script>'
    +'</body></html>');
  win.document.close()}
function buildStatHTML(v){
  var origState={name:S.name,desc:S.desc,notes:S.notes,image:S.image,size:S.size,loco:S.loco,mods:JSON.parse(JSON.stringify(S.mods)),weapons:JSON.parse(JSON.stringify(S.weapons)),armourTech:S.armourTech};
  S.name=v.name;S.desc=v.desc||'';S.notes=v.notes||'';S.image=v.image||'';S.size=v.size;S.loco=v.loco;S.mods=JSON.parse(JSON.stringify(v.mods));S.weapons=JSON.parse(JSON.stringify(v.weapons));S.armourTech=v.armourTech||0;
  var f=getFrame(S.size),loco=LOCOS.find(function(l){return l.id===S.loco}),spd=calcSpeed();
  var notes=[];MODS.forEach(function(m){if(S.mods[m.id]>0)notes.push(S.mods[m.id]>1?S.mods[m.id]+'× '+m.name:m.name)});
  var wl=[];S.weapons.forEach(function(w){var wp=getAllWeapons().find(function(x){return x.id===w.weaponId});if(wp){var ml=w.mount==='fixed'?'Fixed':w.mount==='turret'?'Turret':'Pintle';wl.push(wp.name+' ('+ml+'): '+wp.range+', '+wp.damage+', AP '+wp.ap+', RoF '+wp.rof+(wp.notes?', '+wp.notes:''))}});
  var special=[];
  if(isHeavyArmor())special.push('Heavy Armor');if(loco)special.push(loco.name);
  if(isWalker())special.push('Str '+walkerStr()+' melee (HW)');
  if(S.mods.shields)special.push('Shields '+Math.floor(calcWounds()/2));if(S.mods.reactor)special.push('Reactor');
  if(S.mods.stabilizer)special.push('Stabilizer');if(S.mods.targeting)special.push('Targeting');
  if(S.mods.submersible)special.push('Submersible'+(S.mods.submersible>1?' (Deep)':''));
  if(S.mods.composite_armor)special.push('Composite Armour');
  if(S.armourTech>0)special.push(AT_INFO[S.armourTech].name+' AT (+'+S.armourTech+')');
  if(S.mods.road_vehicle)special.push('Road Spd '+calcRoadSpeed()+' ('+speedMPH(calcRoadSpeed())+' MPH)');
  if(S.mods.high_perf_engine)special.push('Hi-Perf'+(S.mods.high_perf_engine>1?' ×'+S.mods.high_perf_engine:''));
  var h='<div class="card"><h2>'+esc(S.name)+'</h2>';
  if(S.desc)h+='<p class="desc">'+esc(S.desc)+'</p>';
  h+='<div class="type">Size '+S.size+' ('+f.cat+'), '+(loco?loco.name:'?')+', H'+(calcHand()>=0?'+':'')+calcHand()+', Spd '+spd+' ('+speedMPH(spd)+' MPH)</div>';
  h+='<div class="stats"><span><b>Tough:</b> '+calcTough()+'('+calcArmor()+')</span><span><b>Wounds:</b> '+calcWounds()+'</span><span><b>Crew:</b> '+f.crew+'</span>';
  if(isWalker())h+='<span><b>Str:</b> '+walkerStr()+'</span>';
  h+='<span><b>Cost:</b> $'+fmtC(calcCost())+'</span></div>';
  if(notes.length)h+='<div class="mods"><b>Mods:</b> '+notes.join(', ')+'</div>';
  if(wl.length)h+='<div class="wpns"><b>Weapons:</b> '+wl.join('; ')+'</div>';
  if(special.length)h+='<div class="spec"><b>Special:</b> '+special.join(', ')+'</div>';
  if(S.notes)h+='<div class="gm"><b>GM:</b> '+esc(S.notes)+'</div>';
  h+='</div>';
  S.name=origState.name;S.desc=origState.desc;S.notes=origState.notes;S.image=origState.image;S.size=origState.size;S.loco=origState.loco;S.mods=JSON.parse(JSON.stringify(origState.mods));S.weapons=JSON.parse(JSON.stringify(origState.weapons));S.armourTech=origState.armourTech;
  return h}
function printAll(){if(!S.saved.length){alert('No saved vehicles to print.');return}
  var cards=S.saved.map(function(v){return buildStatHTML(v)}).join('');
  var win=window.open('','_blank','width=800,height=900');
  win.document.write('<!DOCTYPE html><html><head><title>Vehicle Pack — '+S.saved.length+' Vehicles</title>'
    +'<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Georgia,serif;font-size:11px;line-height:1.4;padding:16px;color:#111}'
    +'.card{border:2px solid #333;padding:10px 12px;margin-bottom:12px;page-break-inside:avoid;max-width:600px}'
    +'h2{font-size:16px;border-bottom:1px solid #333;padding-bottom:2px;margin-bottom:4px}'
    +'.desc{font-style:italic;font-size:10px;color:#555;margin:2px 0 4px}'
    +'.type{font-size:10px;color:#555;margin-bottom:4px}'
    +'.stats{display:flex;flex-wrap:wrap;gap:6px 14px;margin:4px 0;font-size:11px}'
    +'.mods,.wpns,.spec,.gm{font-size:10px;margin:3px 0}'
    +'.spec{font-style:italic;color:#444}'
    +'.gm{color:#666;border-top:1px solid #ddd;padding-top:3px;margin-top:4px}'
    +'.watermark{font-size:8px;color:#aaa;text-align:right;margin-top:8px}'
    +'@media print{.card{border:1.5px solid #333}}</style></head><body>'
    +cards
    +'<div class="watermark">Built with DiceForge Vehicle Forge · diceforgestudios.pages.dev</div>'
    +'<script>window.onload=function(){window.print()}<\\/script>'
    +'</body></html>');
  win.document.close()}
function saveVehicle(){var d={name:S.name,desc:S.desc,notes:S.notes,image:S.image,size:S.size,loco:S.loco,mods:JSON.parse(JSON.stringify(S.mods)),weapons:JSON.parse(JSON.stringify(S.weapons)),armourTech:S.armourTech};var i=S.saved.findIndex(function(s){return s.name===S.name});if(i>=0)S.saved[i]=d;else S.saved.push(d);localStorage.setItem('diceforge-cvf',JSON.stringify(S.saved));renderSaved();Audio.click()}
function loadVehicle(i){var d=S.saved[i];S.name=d.name;S.desc=d.desc||'';S.notes=d.notes||'';S.image=d.image||'';S.size=d.size;S.loco=d.loco;S.mods=JSON.parse(JSON.stringify(d.mods));S.weapons=JSON.parse(JSON.stringify(d.weapons));S.armourTech=d.armourTech||0;document.getElementById('vName').value=S.name;document.getElementById('vDesc').value=S.desc;document.getElementById('vNotes').value=S.notes;document.getElementById('sizeSlider').value=S.size;showImage();renderAll()}
function deleteSaved(i){S.saved.splice(i,1);localStorage.setItem('diceforge-cvf',JSON.stringify(S.saved));renderSaved()}
function renderSaved(){var list=document.getElementById('savedList');
  if(!S.saved.length){list.innerHTML='<div class="empty-state"><p>No saved builds yet.</p></div>';return}
  list.innerHTML=S.saved.map(function(s,i){var loco=LOCOS.find(function(l){return l.id===s.loco});
    return '<div class="saved-item" onclick="loadVehicle('+i+')"><span class="si-name">'+esc(s.name)+'</span><span class="si-chassis">Size '+s.size+' '+(loco?loco.name:'')+'</span><button class="si-delete" onclick="event.stopPropagation();deleteSaved('+i+')">&times;</button></div>'}).join('')}
function fmtN(n){return n.toLocaleString()}
function fmtC(n){if(n>=1e9)return(n/1e9).toFixed(2)+'B';if(n>=1e6)return(n/1e6).toFixed(n%1e6===0?0:2)+'M';if(n>=1e3)return(n/1e3).toFixed(n%1e3===0?0:1)+'K';return n.toString()}
function renderAll(){renderFrameInfo();renderLocoGrid();renderAT();renderEraFilter();renderModCatalogue();renderModBay();renderWeaponCatalogue();renderWeaponBay();renderStats();renderOutput();renderSaved()}

// ═══ NAV BAR ═══
(function(){var tools=[{id:'foundry',label:'🏭 The Foundry',url:'foundry'},{id:'adventure-vault',label:'🎭 Adventure Vault',url:'adventure-vault'},{id:'character-vault',label:'👤 Character Vault',url:'character-vault'},{id:'cvf',label:'⚙ Vehicle Forge',url:'combat-vehicle-forge'},{id:'pa-forge',label:'🛡 Power Armour Forge',url:'pa-forge'}];
  var nav=document.createElement('div');nav.className='tool-nav';
  tools.forEach(function(t){var btn=document.createElement('button');btn.className='tool-nav-item'+(t.id==='cvf'?' active':'');btn.textContent=t.label;btn.onclick=function(){if(t.id!=='cvf')window.location.href=t.url};nav.appendChild(btn)});
  document.getElementById('toolNavContainer').appendChild(nav)})();

// ═══ BOOT ═══
(function(){function unlock(){Audio.init();if(Audio.ctx.state==='suspended')Audio.ctx.resume();var buf=Audio.ctx.createBuffer(1,1,Audio.ctx.sampleRate);var src=Audio.ctx.createBufferSource();src.buffer=buf;src.connect(Audio.ctx.destination);src.start(0);['touchstart','touchend','mousedown','click'].forEach(function(e){document.removeEventListener(e,unlock,true)})}
  ['touchstart','touchend','mousedown','click'].forEach(function(e){document.addEventListener(e,unlock,true)})})();
try{var sd=localStorage.getItem('diceforge-cvf');if(sd)S.saved=JSON.parse(sd)}catch(e){}
document.getElementById('vName').addEventListener('input',function(e){S.name=e.target.value||'Untitled Vehicle'});
document.getElementById('vDesc').addEventListener('input',function(e){S.desc=e.target.value||''});
document.getElementById('vNotes').addEventListener('input',function(e){S.notes=e.target.value||''});
document.getElementById('helpContent').innerHTML=buildHelp();
renderAll();
</script>
</body>
</html>
