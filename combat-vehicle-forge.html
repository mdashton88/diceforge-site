<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Combat Vehicle Forge — DiceForge Studios</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root{--bg-deep:#0E0C0A;--bg-dark:#141210;--bg-card:#1A1816;--bg-panel:#201E1A;--border:#3A3530;--border-light:#4A4540;--accent:#C4A44A;--accent-dim:#C4A44A40;--accent-glow:#C4A44A20;--text:#D4C8B0;--text-bright:#EDE4D4;--text-dim:#8A7A60;--green:#5A9A5A;--red:#8C3030;--red-bright:#B04040;--blue:#4A7A9A;--orange:#B07830}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;background:var(--bg-deep);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:15px;line-height:1.6}
.tool-nav{display:flex;gap:0;background:#141210;border-bottom:1px solid #3A3530;padding:0 12px;font-family:'Cinzel',serif;flex-wrap:wrap}
.tool-nav-item{background:transparent;border:none;color:#8A7A60;padding:8px 14px;font-size:10px;letter-spacing:1.5px;cursor:pointer;font-family:'Cinzel',serif;text-transform:uppercase;transition:all .15s}
.tool-nav-item:hover{color:#D4C8B0}.tool-nav-item.active{color:#C4A44A;border-bottom:2px solid #C4A44A}
.app{display:flex;height:calc(100vh - 38px);overflow:hidden}
.sidebar{width:360px;min-width:360px;background:var(--bg-dark);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.header{background:var(--bg-dark);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;gap:16px}
.header-brand{font-family:'Cinzel',serif;font-size:11px;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase}
.header-title{font-family:'Cinzel',serif;font-size:18px;color:var(--accent);letter-spacing:2px}
.header-spacer{flex:1}
.header-btn{background:transparent;border:1px solid var(--border);color:var(--text-dim);padding:6px 14px;font-family:'Crimson Pro',serif;font-size:13px;cursor:pointer;transition:all .15s}
.header-btn:hover{border-color:var(--accent);color:var(--accent)}
.header-btn.primary{background:var(--accent);color:var(--bg-deep);border-color:var(--accent);font-weight:700}
.header-btn.primary:hover{background:#D4B45A}
.sidebar-section{padding:12px 16px;border-bottom:1px solid var(--border)}
.sidebar-section h3{font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px}
.field-row input[type="text"]{background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:5px 10px;font-family:'Crimson Pro',serif;font-size:14px;width:100%}
.field-row input[type="text"]:focus{outline:none;border-color:var(--accent)}
.size-picker{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.size-picker input[type="range"]{flex:1;accent-color:var(--accent);cursor:pointer}
.size-picker .size-val{font-family:'Cinzel',serif;font-size:24px;color:var(--accent);font-weight:700;min-width:36px;text-align:center}
.size-picker .size-class{font-size:12px;color:var(--text-dim);font-style:italic}
.loco-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.loco-btn{background:var(--bg-deep);border:1px solid var(--border);color:var(--text);padding:6px 10px;cursor:pointer;font-family:'Crimson Pro',serif;font-size:12px;text-align:left;transition:all .15s;display:flex;justify-content:space-between;align-items:center}
.loco-btn:hover{border-color:var(--accent);color:var(--accent)}
.loco-btn.active{background:var(--accent-glow);border-color:var(--accent);color:var(--accent)}
.loco-btn .loco-speed{font-size:10px;color:var(--text-dim)}.loco-btn.active .loco-speed{color:var(--accent);opacity:.7}
.frame-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-top:8px}
.frame-stat{background:var(--bg-deep);border:1px solid var(--border);padding:6px 8px;text-align:center}
.frame-stat .fs-label{font-size:9px;letter-spacing:1.5px;color:var(--text-dim);text-transform:uppercase;font-family:'Cinzel',serif}
.frame-stat .fs-value{font-size:14px;font-weight:700;color:var(--text-bright);margin-top:1px}
.frame-stat .fs-value.danger{color:var(--red-bright)}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.stat-box{background:var(--bg-deep);border:1px solid var(--border);padding:8px 10px;text-align:center}
.stat-box .stat-label{font-size:10px;letter-spacing:1.5px;color:var(--text-dim);text-transform:uppercase;font-family:'Cinzel',serif}
.stat-box .stat-value{font-size:16px;font-weight:700;color:var(--text-bright);margin-top:2px}
.stat-box .stat-value.danger{color:var(--red-bright)}
.mods-remaining{background:var(--bg-deep);border:1px solid var(--border);padding:10px;text-align:center;margin-top:8px}
.mods-remaining .big-num{font-size:28px;font-weight:700;font-family:'Cinzel',serif}
.mods-remaining .big-num.ok{color:var(--green)}.mods-remaining .big-num.low{color:var(--orange)}.mods-remaining .big-num.over{color:var(--red-bright)}
.mods-remaining .sub{font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase}
.cost-display{background:var(--bg-deep);border:1px solid var(--accent-dim);padding:10px;text-align:center;margin-top:6px}
.cost-display .cost-val{font-size:18px;font-weight:700;color:var(--accent);font-family:'Cinzel',serif}
.cost-display .cost-label{font-size:10px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase}
.content{flex:1;overflow-y:auto;padding:20px}
.content::-webkit-scrollbar{width:6px}.content::-webkit-scrollbar-track{background:var(--bg-dark)}.content::-webkit-scrollbar-thumb{background:var(--border)}
.tab-bar{display:flex;gap:0;border-bottom:1px solid var(--border)}
.tab{padding:10px 20px;font-family:'Cinzel',serif;font-size:12px;letter-spacing:1.5px;color:var(--text-dim);cursor:pointer;border-bottom:2px solid transparent;text-transform:uppercase;transition:all .15s}
.tab:hover{color:var(--text)}.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.panel{display:none}.panel.active{display:block}
.dnd-layout{display:grid;grid-template-columns:1fr 1fr;gap:20px;min-height:400px}
.dnd-column h3{font-family:'Cinzel',serif;font-size:12px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;padding-bottom:8px;border-bottom:1px solid var(--border);margin-bottom:10px}
.drag-item{display:flex;align-items:center;gap:10px;padding:10px 12px;margin-bottom:5px;background:var(--bg-card);border:1px solid var(--border);cursor:grab;transition:transform .15s,box-shadow .15s,border-color .15s;user-select:none;touch-action:none;-webkit-user-select:none}
.drag-item:hover{border-color:var(--border-light)}.drag-item:active{cursor:grabbing}.drag-item.dragging{opacity:.5;transform:scale(.97)}
.drag-item .drag-handle{color:var(--text-dim);font-size:14px;opacity:.4}
.drag-item .di-info{flex:1;min-width:0}.drag-item .di-name{font-weight:600;color:var(--text-bright);font-size:13px}
.drag-item .di-desc{font-size:11px;color:var(--text-dim);font-style:italic;line-height:1.3;margin-top:1px}
.drag-item .di-meta{text-align:right;min-width:55px}.drag-item .di-mods{font-weight:700;color:var(--accent);font-size:12px}
.drag-item .di-price{font-size:10px;color:var(--text-dim)}
.drag-ghost{position:fixed;pointer-events:none;z-index:1000;padding:8px 14px;background:var(--bg-panel);border:1px solid var(--accent);box-shadow:0 8px 32px rgba(196,164,74,.3),0 0 12px rgba(196,164,74,.15);font-family:'Cinzel',serif;font-size:13px;color:var(--accent);letter-spacing:1px;white-space:nowrap}
.drag-ghost.near-target{box-shadow:0 12px 48px rgba(196,164,74,.5),0 0 20px rgba(196,164,74,.25);transform:scale(1.05)}
.drop-bay{min-height:120px;padding:8px;background:var(--bg-deep);border:2px dashed var(--border);transition:border-color .2s,background .2s,box-shadow .2s}
.drop-bay.drag-over{border-color:var(--accent);border-style:solid;background:var(--accent-glow);box-shadow:inset 0 0 30px rgba(196,164,74,.08)}
.drop-bay .empty-bay{text-align:center;padding:30px 16px;color:var(--text-dim);font-style:italic;font-size:13px}
.bay-item{display:flex;align-items:center;gap:8px;padding:8px 12px;margin-bottom:4px;background:var(--bg-card);border:1px solid var(--accent-dim)}
.bay-item .bi-info{flex:1}.bay-item .bi-name{font-weight:600;color:var(--accent);font-size:13px}
.bay-item .bi-detail{font-size:11px;color:var(--text-dim)}
.bay-item .bi-count{font-family:'Cinzel',serif;font-size:14px;color:var(--text-bright);font-weight:700;min-width:24px;text-align:center}
.bay-item .bi-controls{display:flex;gap:3px}
.bay-item .bi-controls button{width:24px;height:24px;background:var(--bg-deep);border:1px solid var(--border);color:var(--text-dim);font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:'Crimson Pro',serif;transition:all .1s}
.bay-item .bi-controls button:hover{border-color:var(--accent);color:var(--accent)}
.bay-item .bi-remove{background:transparent;border:none;color:var(--text-dim);cursor:pointer;font-size:13px;padding:2px 6px;margin-left:4px}
.bay-item .bi-remove:hover{color:var(--red-bright)}
@keyframes snapIn{0%{transform:translateY(-8px) scale(1.03);opacity:.6}40%{transform:translateY(2px) scale(.98);opacity:1}70%{transform:translateY(-1px) scale(1.005)}100%{transform:translateY(0) scale(1)}}
.bay-item.snap-in,.weapon-bay-item.snap-in{animation:snapIn .3s ease-out}
@keyframes impactFlash{0%{box-shadow:inset 0 0 20px rgba(196,164,74,.4)}100%{box-shadow:inset 0 0 0 rgba(196,164,74,0)}}
.drop-bay.impact{animation:impactFlash .35s ease-out}
.cat-header{font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;padding:8px 0 4px;margin-top:8px}.cat-header:first-child{margin-top:0}
.weapon-drag-item{display:flex;align-items:center;gap:10px;padding:10px 12px;margin-bottom:5px;background:var(--bg-card);border:1px solid var(--border);cursor:grab;transition:transform .15s,box-shadow .15s,border-color .15s;user-select:none;touch-action:none;-webkit-user-select:none}
.weapon-drag-item:hover{border-color:var(--border-light)}.weapon-drag-item:active{cursor:grabbing}.weapon-drag-item.dragging{opacity:.5;transform:scale(.97)}
.weapon-drag-item .wdi-info{flex:1}.weapon-drag-item .wdi-name{font-weight:600;color:var(--text-bright);font-size:13px}
.weapon-drag-item .wdi-stats{font-size:11px;color:var(--text-dim)}
.weapon-drag-item .wdi-meta{text-align:right;min-width:55px}.weapon-drag-item .wdi-mods{font-weight:700;color:var(--accent);font-size:12px}
.weapon-drag-item .wdi-price{font-size:10px;color:var(--text-dim)}
.weapon-bay-item{display:flex;align-items:center;gap:8px;padding:10px 12px;margin-bottom:4px;background:var(--bg-card);border:1px solid var(--accent-dim)}
.weapon-bay-item .wbi-info{flex:1}.weapon-bay-item .wbi-name{font-weight:600;color:var(--accent);font-size:13px}
.weapon-bay-item .wbi-stats{font-size:11px;color:var(--text-dim)}
.weapon-bay-item .wbi-mount{font-size:10px;color:var(--text-dim);font-style:italic}
.weapon-bay-item .wbi-remove{background:transparent;border:none;color:var(--text-dim);cursor:pointer;font-size:13px;padding:2px 6px}
.weapon-bay-item .wbi-remove:hover{color:var(--red-bright)}
.mount-tabs{display:flex;gap:0;margin-bottom:10px}
.mount-tab{padding:6px 14px;font-family:'Cinzel',serif;font-size:11px;letter-spacing:1px;color:var(--text-dim);cursor:pointer;border:1px solid var(--border);background:transparent;text-transform:uppercase;transition:all .15s}
.mount-tab:first-child{border-radius:3px 0 0 3px}.mount-tab:last-child{border-radius:0 3px 3px 0}
.mount-tab:not(:first-child){border-left:none}
.mount-tab:hover{color:var(--text)}.mount-tab.active{background:var(--accent-glow);color:var(--accent);border-color:var(--accent)}
.stat-block{background:var(--bg-deep);border:1px solid var(--accent-dim);padding:24px;font-size:14px;line-height:1.8;max-width:700px}
.stat-block .sb-name{font-family:'Cinzel',serif;font-size:22px;color:var(--accent);letter-spacing:3px;text-align:center;margin-bottom:2px}
.stat-block .sb-type{text-align:center;color:var(--text-dim);font-style:italic;font-size:13px;margin-bottom:14px}
.stat-block .sb-divider{border:none;border-top:1px solid var(--accent-dim);margin:10px 0}
.stat-block .sb-line{margin-bottom:2px}.stat-block .sb-label{color:var(--accent);font-weight:700}
.stat-block .sb-notes{color:var(--text-dim);font-style:italic;margin-top:8px;font-size:13px;line-height:1.5}
.saved-list{display:flex;flex-direction:column;gap:4px}
.saved-item{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);cursor:pointer;transition:all .15s}
.saved-item:hover{border-color:var(--accent)}
.saved-item .si-name{flex:1;font-weight:600;color:var(--text-bright);font-size:14px}
.saved-item .si-chassis{font-size:12px;color:var(--text-dim)}
.saved-item .si-delete{background:transparent;border:none;color:var(--text-dim);cursor:pointer;font-size:14px;padding:2px 6px}
.saved-item .si-delete:hover{color:var(--red-bright)}
.empty-state{text-align:center;padding:40px 20px;color:var(--text-dim)}.empty-state p{font-size:13px;font-style:italic}
.sidebar-footer{margin-top:auto;padding:10px 16px;border-top:1px solid var(--border);font-size:11px;color:var(--text-dim);text-align:center;font-style:italic}
.rules-ref{max-width:700px}.rules-ref h3{font-family:'Cinzel',serif;font-size:14px;color:var(--accent);letter-spacing:1.5px;margin:16px 0 8px}
.rules-ref h3:first-child{margin-top:0}.rules-ref p{margin-bottom:8px;font-size:14px;color:var(--text)}
.rules-ref .rule-key{color:var(--accent);font-weight:700}.rules-ref .rule-note{color:var(--text-dim);font-style:italic;font-size:13px}
</style>
</head>
<body>
<div id="toolNavContainer"></div>
<div class="app">
  <div class="sidebar">
    <div class="sidebar-section"><h3>Combat Vehicle Forge</h3><div class="field-row"><input type="text" id="vName" placeholder="Name your vehicle..." value="Untitled Vehicle"></div></div>
    <div class="sidebar-section"><h3>Size</h3>
      <div class="size-picker"><input type="range" id="sizeSlider" min="1" max="20" value="6" oninput="setSize(+this.value)"><div><div class="size-val" id="sizeVal">6</div><div class="size-class" id="sizeClass">Large</div></div></div>
      <div id="frameInfo"></div>
    </div>
    <div class="sidebar-section"><h3>Locomotion</h3><div class="loco-grid" id="locoGrid"></div></div>
    <div class="sidebar-section"><h3>Current Stats</h3><div class="stats-grid" id="statsGrid"></div><div class="mods-remaining" id="modsRemaining"></div><div class="cost-display" id="costDisplay"></div></div>
    <div class="sidebar-section"><h3>Saved Builds</h3><div class="saved-list" id="savedList"></div></div>
    <div class="sidebar-footer">Savage Worlds &copy; Pinnacle Entertainment Group. &copy; DiceForge Studios Ltd.</div>
  </div>
  <div class="main">
    <div class="header"><div><div class="header-brand">DiceForge Studios</div><div class="header-title">Combat Vehicle Forge</div></div><div class="header-spacer"></div><button class="header-btn" onclick="newVehicle()">New</button><button class="header-btn" onclick="saveVehicle()">Save</button><button class="header-btn primary" onclick="switchTab('output')">Export</button></div>
    <div class="tab-bar">
      <div class="tab active" data-tab="mods" onclick="switchTab('mods')">Modifications</div>
      <div class="tab" data-tab="weapons" onclick="switchTab('weapons')">Weapon Systems</div>
      <div class="tab" data-tab="output" onclick="switchTab('output')">Stat Block</div>
      <div class="tab" data-tab="rules" onclick="switchTab('rules')">Rules Reference</div>
    </div>
    <div class="content">
      <div class="panel active" id="panel-mods"><div class="dnd-layout"><div class="dnd-column"><h3>Available Modifications</h3><div id="modCatalogue"></div></div><div class="dnd-column"><h3>Installed Systems</h3><div class="drop-bay" id="modBay"><div class="empty-bay">Drag modifications here to install them</div></div></div></div></div>
      <div class="panel" id="panel-weapons"><div class="dnd-layout"><div class="dnd-column"><h3>Vehicular Weapons</h3><div id="eraFilter" style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:10px"></div><div id="weaponCatalogue"></div><div style="margin-top:12px;padding-top:8px;border-top:1px solid var(--border)"><button class="header-btn" onclick="toggleCustomForm()" style="width:100%;text-align:center">+ Add Custom Weapon</button><div id="customForm" style="display:none;margin-top:8px"></div></div></div><div class="dnd-column"><h3>Weapon Hardpoints</h3><div class="mount-tabs"><div class="mount-tab active" data-mount="pintle" onclick="switchMount('pintle')">Pintle</div><div class="mount-tab" data-mount="fixed" onclick="switchMount('fixed')">Fixed (&frac12;)</div><div class="mount-tab" data-mount="turret" onclick="switchMount('turret')">Turret (&times;2)</div></div><div class="drop-bay" id="weaponBay"><div class="empty-bay">Drag weapons here to mount them</div></div></div></div></div>
      <div class="panel" id="panel-output"></div>
      <div class="panel" id="panel-rules"><div class="rules-ref" id="rulesContent"></div></div>
    </div>
  </div>
</div>
<script>
// ═══ AUDIO ENGINE (shared across all Forges) ═══
var Audio={ctx:null,init:function(){if(!this.ctx)this.ctx=new(window.AudioContext||window.webkitAudioContext)();if(this.ctx.state==='suspended')this.ctx.resume()},
clunk:function(){this.init();var c=this.ctx,n=c.currentTime;var buf=c.createBuffer(1,c.sampleRate*.02,c.sampleRate);var d=buf.getChannelData(0);for(var i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,12);var ns=c.createBufferSource();ns.buffer=buf;var bp=c.createBiquadFilter();bp.type='bandpass';bp.frequency.value=4200;bp.Q.value=2;var o1=c.createOscillator();o1.type='sine';o1.frequency.value=820;var g1=c.createGain();g1.gain.setValueAtTime(.06,n);g1.gain.exponentialRampToValueAtTime(.001,n+.06);var o2=c.createOscillator();o2.type='sine';o2.frequency.value=2200;var g2=c.createGain();g2.gain.setValueAtTime(.02,n);g2.gain.exponentialRampToValueAtTime(.001,n+.03);var m=c.createGain();m.gain.value=.3;ns.connect(bp).connect(m);o1.connect(g1).connect(m);o2.connect(g2).connect(m);m.connect(c.destination);ns.start(n);ns.stop(n+.02);o1.start(n);o1.stop(n+.08);o2.start(n);o2.stop(n+.05)},
click:function(){this.init();var c=this.ctx,n=c.currentTime;var o=c.createOscillator();o.type='sine';o.frequency.value=600;var g=c.createGain();g.gain.setValueAtTime(.08,n);g.gain.exponentialRampToValueAtTime(.001,n+.04);o.connect(g).connect(c.destination);o.start(n);o.stop(n+.05)},
remove:function(){this.init();var c=this.ctx,n=c.currentTime;var o=c.createOscillator();o.type='triangle';o.frequency.setValueAtTime(500,n);o.frequency.exponentialRampToValueAtTime(200,n+.1);var g=c.createGain();g.gain.setValueAtTime(.1,n);g.gain.exponentialRampToValueAtTime(.001,n+.12);o.connect(g).connect(c.destination);o.start(n);o.stop(n+.15)}};

// ═══ CANONICAL SFC DATA — Vehicle Frames (SFC p165) ═══
// Normal (1-3): Hand +1, Tough 5 (max 20), Wounds 3, Crew 1, Energy 3, Mods Size×3, Cost $10K×Size
// Large (4-7): Hand 0, Tough 10 (max 30), Wounds 4, Crew 3, Energy 5, Mods Size×3, Cost $30K×Size
// Huge (8-11): Hand -1, Tough 15 (max 40), Wounds 5, Crew 5, Energy 15, Mods Size×3, Cost $50K×Size
// Gargantuan (12-20): Hand -2, Tough 20 (max 50), Wounds 6, Crew 50, Energy 30, Mods Size×4, Cost $1M×Size
// Note: Top Speed comes from locomotion type, not frame
// Approximate dimensions and weight by Size (SFC frame notes + vehicle examples)
var SIZE_REF={
  1:{len:"6'",ex:'Drone, motorcycle',wt:'200 lbs'},
  2:{len:"8'",ex:'Compact car, hover bike',wt:'1,500 lbs'},
  3:{len:"12'",ex:'Sports car, light APC',wt:'3,000 lbs'},
  4:{len:"15'",ex:'SUV, light truck, scout walker',wt:'2 tons'},
  5:{len:"18'",ex:'Truck, gunboat, light mech',wt:'5 tons'},
  6:{len:"22'",ex:'APC, attack helicopter',wt:'10 tons'},
  7:{len:"28'",ex:'Heavy tank, assault mech',wt:'15 tons'},
  8:{len:"36'",ex:'Patrol boat, heavy walker',wt:'40 tons'},
  9:{len:"42'",ex:'Airliner, corvette',wt:'65 tons'},
  10:{len:"50'",ex:'Train car, gunship',wt:'120 tons'},
  11:{len:"63'",ex:'Large ship, assault walker',wt:'250 tons'},
  12:{len:"75'",ex:'Frigate, walking fortress',wt:'500 tons'},
  13:{len:"100'",ex:'Small destroyer',wt:'1,000 tons'},
  14:{len:"125'",ex:'Landing craft',wt:'2,000 tons'},
  15:{len:"150'",ex:'Large warship',wt:'4,000 tons'},
  16:{len:"200'",ex:'Heavy destroyer',wt:'8,000 tons'},
  17:{len:"250'",ex:'Battlecruiser',wt:'16,000 tons'},
  18:{len:"300'",ex:'Carrier',wt:'32,000 tons'},
  19:{len:"400'",ex:'Supercarrier',wt:'64,000 tons'},
  20:{len:"500'",ex:'Mega-platform',wt:'125,000 tons'}
};
function getFrame(sz){
  if(sz<=3)return{cat:'Normal',hand:1,baseTough:5,maxArmor:20,wounds:3,crew:1,energy:3,modMult:3,costMult:10000};
  if(sz<=7)return{cat:'Large',hand:0,baseTough:10,maxArmor:30,wounds:4,crew:3,energy:5,modMult:3,costMult:30000};
  if(sz<=11)return{cat:'Huge',hand:-1,baseTough:15,maxArmor:40,wounds:5,crew:5,energy:15,modMult:3,costMult:50000};
  return{cat:'Gargantuan',hand:-2,baseTough:20,maxArmor:50,wounds:6,crew:50,energy:30,modMult:4,costMult:1000000};
}

// ═══ LOCOMOTION TYPES (SFC p165) ═══
var LOCOS=[
  {id:'wheeled',name:'Wheeled',speed:5,costMult:1000,notes:'Standard wheels.',group:'ground'},
  {id:'tracked',name:'Tracked',speed:4,costMult:5000,notes:'Ignores Difficult Ground.',group:'ground'},
  {id:'hover',name:'Hover',speed:6,costMult:10000,notes:'Ignores low obstacles and water.',group:'ground'},
  {id:'vtol',name:'Aircraft, VTOL',speed:8,costMult:100000,notes:'VTOL, hover, or fly.',group:'air'},
  {id:'turboprop',name:'Aircraft, Turboprop',speed:11,costMult:100000,notes:'Min speed 60 MPH or Out of Control.',group:'air'},
  {id:'jet',name:'Aircraft, Jet',speed:13,costMult:500000,notes:'Min speed 120 MPH or Out of Control.',group:'air'},
  {id:'water_turbo',name:'Water, Turboprop',speed:3,costMult:2000,notes:'Boat or ship, propeller driven.',group:'water'},
  {id:'water_jet',name:'Water, Jet',speed:5,costMult:5000,notes:'Boat or ship, jet driven.',group:'water'},
  {id:'legs_biped',name:'Legs (Bipedal)',speed:8,costMult:50000,notes:'Walker rules apply. Fighting, Stomp, Death From Above.',group:'walker'},
  {id:'legs_quad',name:'Legs (Quadruped)',speed:6,costMult:50000,notes:'Walker rules. Reroll failed Piloting vs Out of Control.',group:'walker'}
];

// Speed Rating table (SFC p164)
var SPD_TABLE={1:4,2:8,3:16,4:25,5:40,6:60,7:80,8:100,9:120,10:160,11:200,12:250,13:400,14:600,15:800,16:1000,17:1200,18:1600,19:2000,20:2500};
function speedMPH(r){return SPD_TABLE[r]||(r+'?')}

// ═══ VEHICLE MODIFICATIONS (SFC pp166-171) ═══
var MODS=[
  // NEGATIVE QUALITIES
  {id:'battered',name:'Battered',cat:'Negative Qualities',max:2,mods:-2,costFn:function(s){return -10000*s},desc:'Reduce base Toughness by 2.'},
  {id:'drone',name:'Drone',cat:'Negative Qualities',max:1,mods:-2,costFn:function(s){return -5000*s},desc:'No pilot. Requires Remote Control or AI. Crew drops to 0.'},
  {id:'exposed',name:'Exposed Crew',cat:'Negative Qualities',max:1,mods:-2,costFn:function(s){return -10000*s},desc:'Crew targetable, no Armor bonus. Can\'t take Sealed.'},
  {id:'finicky',name:'Finicky',cat:'Negative Qualities',max:2,mods:-2,costFn:function(s){return -10000*s},desc:'Repair at -2 (-4 if taken twice).'},
  {id:'fragile',name:'Fragile',cat:'Negative Qualities',max:2,mods:-2,costFn:function(s){return -10000*s},desc:'Reduce Wounds by 1.'},
  {id:'inefficient',name:'Inefficient',cat:'Negative Qualities',max:1,mods:-2,costFn:function(s){return -10000*s},desc:'Double fuel use per day.'},
  {id:'manual',name:'Manual',cat:'Negative Qualities',max:1,mods:-2,costFn:function(s){return -10000*s},desc:'No electronics. Cannot install electronic Mods.'},
  {id:'reduced_crew',name:'Reduced Crew',cat:'Negative Qualities',max:1,mods:'halfneg',costFn:function(s){return -10000*s},desc:'Crew drops to next lowest frame category.'},
  {id:'reduced_hand',name:'Reduced Handling',cat:'Negative Qualities',max:6,mods:-2,costFn:function(s){return -10000*s},desc:'-1 Handling per take (max -6 total).'},
  {id:'reduced_speed',name:'Reduced Speed',cat:'Negative Qualities',max:3,mods:-2,costFn:function(s){return -10000*s},desc:'-1 Speed Rating. Can\'t combine with Increased Speed.'},
  {id:'rough_ride',name:'Rough Ride',cat:'Negative Qualities',max:1,mods:-2,costFn:function(s){return -10000*s},desc:'Unstable Platform penalty is -4 instead of -2.'},
  {id:'unsafe',name:'Unsafe',cat:'Negative Qualities',max:1,mods:-2,costFn:function(s){return -10000*s},desc:'Full collision damage. No safety measures. Eject at -2.'},
  // CORE SYSTEMS
  {id:'ai',name:'Artificial Intelligence',cat:'Core Systems',max:3,mods:1,costFn:function(s){return 5000*s},desc:'AI ally: d6 + Wild Die. 2nd: d10. 3rd: ignore 2 MAP.'},
  {id:'av_system',name:'AV System',cat:'Core Systems',max:1,mods:1,costFn:function(){return 10000},desc:'50× magnification, -4 Illumination, +2 Notice. +2 hearing 200 yds.'},
  {id:'command',name:'Command Suite',cat:'Core Systems',max:1,mods:1,costFn:function(){return 10000},desc:'See/hear through linked allies. Extend Command Range.'},
  {id:'comms',name:'Comms',cat:'Core Systems',max:2,mods:1,costFn:function(){return 5000},desc:'20 mile range. 2nd: 100 miles.'},
  {id:'entangled',name:'Entangled Comms',cat:'Core Systems',max:'U',mods:1,costFn:function(){return 50000},desc:'Quantum comms. Unlimited range, unjammable.'},
  {id:'remote',name:'Remote Control',cat:'Core Systems',max:1,mods:1,costFn:function(){return 10000},desc:'Operate from afar with Electronics -2.'},
  {id:'scanner',name:'Scanner',cat:'Core Systems',max:1,mods:1,costFn:function(){return 1000},desc:'Detect 50 yds. +2 Notice. Target need not be visible.'},
  {id:'sensor_array',name:'Sensor Array',cat:'Core Systems',max:1,mods:4,costFn:function(){return 25000},desc:'Scan 1 light-year / LOS. Full round, Vulnerable.'},
  // DEFENSIVE SYSTEMS
  {id:'amecm',name:'AM/ECM',cat:'Defensive Systems',max:1,mods:1,costFn:function(s){return 5000*s},desc:'+2 Evasion vs Guided Weapons.'},
  {id:'anti_tp',name:'Anti-Teleportation',cat:'Defensive Systems',max:1,mods:4,costFn:function(s){return 10000*s},desc:'Prevent teleportation into/onto vehicle.'},
  {id:'armor',name:'Armor',cat:'Defensive Systems',max:'frame',mods:1,costFn:function(s){return 5000*s},desc:'+2 Armor per take (up to frame max). Size 4+ = Heavy Armor.'},
  {id:'emp_shield',name:'EMP Shielding',cat:'Defensive Systems',max:1,mods:2,costFn:function(s){return 5000*s},desc:'Ignore 2 of -4 EMP penalty.'},
  {id:'escape',name:'Escape System',cat:'Defensive Systems',max:1,mods:'half',costFn:function(s){return 1000*s},desc:'Ejection seats (Size 7-) or escape pods (Size 8+).'},
  {id:'repair_drone',name:'Repair Drones',cat:'Defensive Systems',max:1,mods:'half',costFn:function(s){return 25000*s},desc:'Drones attempt Repair. Crit Fail = can\'t retry.'},
  {id:'repair_nano',name:'Repair Nanomachines',cat:'Defensive Systems',max:1,mods:3,costFn:function(s){return 50000*s},desc:'Repair as limited action. 3 Wounds max per 24hrs.'},
  {id:'shields',name:'Shields',cat:'Defensive Systems',max:1,mods:'half',costFn:function(s){return 50000*s},desc:'Charges = half base Wounds. Soak with Electronics.'},
  {id:'sloped',name:'Sloped Armor',cat:'Defensive Systems',max:1,mods:'half',costFn:function(s){return 5000*s},desc:'-2 enemy Shooting (direct-fire energy/kinetic only).'},
  {id:'stealth',name:'Stealth System',cat:'Defensive Systems',max:1,mods:'size',costFn:function(s){return 50000*s},desc:'-4 to lock on with Electronics.'},
  {id:'toughness',name:'Toughness',cat:'Defensive Systems',max:5,mods:1,costFn:function(s){return 5000*s},desc:'+1 Toughness.'},
  // LOCOMOTION & POWER
  {id:'amphibious',name:'Amphibious',cat:'Locomotion & Power',max:2,mods:2,costFn:function(s){return 1000*s},desc:'Enter water. Hand -1, Speed 2. 2nd: Speed 3.'},
  {id:'boosters',name:'Boosters',cat:'Locomotion & Power',max:4,mods:1,costFn:function(s){return 1000*s},desc:'Once/encounter: +1 Speed Rating for round. Don\'t stack.'},
  {id:'energy_pod',name:'Energy Pod',cat:'Locomotion & Power',max:'U',mods:'half',costFn:function(s){return 5000*s},desc:'Double Energy capacity.'},
  {id:'fwd',name:'Four-Wheel Drive',cat:'Locomotion & Power',max:1,mods:1,costFn:function(s){return 1000*s},desc:'Wheeled only. Difficult Ground = 1.5" per inch.'},
  {id:'handling',name:'Handling',cat:'Locomotion & Power',max:2,mods:'half',costFn:function(s){return 10000*s},desc:'+1 Handling (max +4 total).'},
  {id:'inc_speed',name:'Increased Speed',cat:'Locomotion & Power',max:5,mods:'half',costFn:function(s){return 10000*s},desc:'+1 Speed Rating. Can\'t combine with Reduced Speed.'},
  {id:'reactor',name:'Reactor',cat:'Locomotion & Power',max:1,mods:'half',costFn:function(s){return 10000*s},desc:'Energy ×10. Locomotion Crit: odd die = reactor explodes.'},
  // OFFENSIVE SYSTEMS
  {id:'stabilizer',name:'Stabilizer',cat:'Offensive Systems',max:1,mods:1,costFn:function(){return 5000},desc:'Negate Unstable Platform for all direct-fire weapons.'},
  {id:'targeting',name:'Targeting System',cat:'Offensive Systems',max:1,mods:1,costFn:function(){return 25000},desc:'-2 Shooting penalties (Called Shot, Cover, Range, Scale, Speed).'},
  // PERSONNEL
  {id:'crew_seat',name:'Crew Seating/Quarters',cat:'Personnel',max:'U',mods:'half',costFn:function(){return 10000},desc:'Add accommodations equal to Crew rating per take.'},
  {id:'luxury',name:'Luxury Features',cat:'Personnel',max:'U',mods:'half',costFn:function(s){return s>=8?10000*s:10000},desc:'Enhanced comfort. Required for voyages > few weeks.'},
  {id:'passenger_pod',name:'Passenger Pod',cat:'Personnel',max:'U',mods:2,costFn:function(){return 50000},desc:'Size 7 or less. 10 passengers, short trips.'},
  {id:'pro_bay',name:'Professional Bay',cat:'Personnel',max:'U',mods:4,costFn:function(){return 100000},desc:'Skill-specific facility. Free reroll on relevant Trait rolls.'},
  {id:'sealed',name:'Sealed',cat:'Personnel',max:1,mods:2,costFn:function(s){return 5000*s},desc:'Hermetically sealed. Life support, airlocks. Can\'t take Exposed.'},
  // STRUCTURAL
  {id:'hangar',name:'Hangar',cat:'Structural',max:'U',mods:5,costFn:function(){return 500000},desc:'Carry up to 10 Size points of vehicles (max half your Size).'},
  // WALKER-SPECIFIC (available when walker loco selected)
  {id:'jump_jets',name:'Jump Jets',cat:'Walker Systems',max:1,mods:1,costFn:function(s){return 10000*s},desc:'Move as VTOL once per encounter. Walker only.'},
  {id:'tandem_pilots',name:'Tandem Pilots',cat:'Negative Qualities',max:1,mods:-1,costFn:function(s){return -10000*s},desc:'Requires two pilots. Walker only.'},
  // MULTI-FORM
  {id:'variable_form',name:'Variable Form',cat:'Locomotion & Power',max:1,mods:'half',costFn:function(s){return 20000*s},desc:'Switch between two locomotion types as an action. Choose second form at build.'}
];
// ═══ WEAPON CATALOGUE — DiceForge originals by era, SW compatible ═══
// Eras: ancient, medieval, blackpowder, industrial, modern, future, advanced
var WEAPONS=[
  // ANCIENT
  {id:'scorpion',name:'Scorpion',cat:'Siege Engines',era:'ancient',range:'15/30/60',damage:'2d6',ap:2,rof:1,shots:0,minSize:1,mods:1,cost:200,notes:'Reload 1, HW'},
  {id:'onager',name:'Onager',cat:'Siege Engines',era:'ancient',range:'24/48/96',damage:'3d6',ap:0,rof:1,shots:0,minSize:3,mods:2,cost:500,notes:'Reload 4, Indirect, MBT'},
  {id:'polybolos',name:'Polybolos',cat:'Siege Engines',era:'ancient',range:'15/30/60',damage:'2d6',ap:2,rof:2,shots:0,minSize:2,mods:1,cost:400,notes:'Reload 1, Repeating ballista, HW'},
  {id:'greek_fire_s',name:'Greek Fire Siphon',cat:'Incendiaries',era:'ancient',range:'Cone',damage:'2d8',ap:0,rof:1,shots:10,minSize:2,mods:1,cost:300,notes:'Cone 12", Incendiary, Cauterize'},
  {id:'bow_battery',name:'Bow Battery',cat:'Ranged',era:'ancient',range:'12/24/48',damage:'2d6',ap:1,rof:2,shots:0,minSize:2,mods:1,cost:100,notes:'Crew of archers, Reload 1'},
  {id:'javelin_rack',name:'Javelin Rack',cat:'Ranged',era:'ancient',range:'4/8/16',damage:'2d4',ap:0,rof:3,shots:20,minSize:1,mods:1,cost:50,notes:'Thrown, limited range'},
  {id:'scythed_wheels',name:'Scythed Wheels',cat:'Melee Systems',era:'ancient',range:'—',damage:'Str+2d6',ap:2,rof:0,shots:0,minSize:2,mods:1,cost:100,notes:'Melee, damages adjacent on pass, HW'},
  {id:'ram_ancient',name:'Bronze Ram',cat:'Melee Systems',era:'ancient',range:'—',damage:'Str+2d8',ap:4,rof:0,shots:0,minSize:4,mods:1,cost:300,notes:'Ship ram, melee only, HW'},
  // MEDIEVAL
  {id:'ballista',name:'Ballista',cat:'Siege Engines',era:'medieval',range:'15/30/60',damage:'3d6',ap:2,rof:1,shots:0,minSize:2,mods:1,cost:500,notes:'Reload 2, HW'},
  {id:'catapult',name:'Catapult',cat:'Siege Engines',era:'medieval',range:'24/48/96',damage:'3d8',ap:0,rof:1,shots:0,minSize:4,mods:2,cost:1000,notes:'Reload 4, Indirect, MBT'},
  {id:'trebuchet',name:'Trebuchet',cat:'Siege Engines',era:'medieval',range:'24/48/96',damage:'4d8',ap:4,rof:1,shots:0,minSize:6,mods:3,cost:2000,notes:'Reload 6, Indirect, LBT'},
  {id:'mangonel',name:'Mangonel',cat:'Siege Engines',era:'medieval',range:'18/36/72',damage:'3d6',ap:0,rof:1,shots:0,minSize:3,mods:2,cost:700,notes:'Reload 3, Indirect, MBT'},
  {id:'springald',name:'Springald',cat:'Siege Engines',era:'medieval',range:'20/40/80',damage:'2d8',ap:4,rof:1,shots:0,minSize:2,mods:1,cost:400,notes:'Reload 2, AP bolt, HW'},
  {id:'ram',name:'Battering Ram',cat:'Melee Systems',era:'medieval',range:'—',damage:'Str+2d8',ap:4,rof:0,shots:0,minSize:2,mods:1,cost:200,notes:'Melee only, HW'},
  {id:'boiling_oil',name:'Boiling Oil/Pitch',cat:'Defensive Weapons',era:'medieval',range:'Cone',damage:'2d10',ap:0,rof:1,shots:5,minSize:2,mods:1,cost:100,notes:'Cone, Incendiary'},
  {id:'fire_arrows',name:'Fire Arrows',cat:'Incendiaries',era:'medieval',range:'12/24/48',damage:'2d6',ap:0,rof:2,shots:0,minSize:1,mods:1,cost:80,notes:'Incendiary, Reload 1'},
  // BLACKPOWDER
  {id:'swivel_gun',name:'Swivel Gun',cat:'Blackpowder Guns',era:'blackpowder',range:'12/24/48',damage:'2d8',ap:2,rof:1,shots:0,minSize:1,mods:1,cost:300,notes:'Reload 2, Grapeshot (Cone)'},
  {id:'light_cannon_bp',name:'Light Cannon',cat:'Blackpowder Guns',era:'blackpowder',range:'20/40/80',damage:'3d6+1',ap:4,rof:1,shots:0,minSize:2,mods:1,cost:600,notes:'Reload 3, SBT, HW'},
  {id:'med_cannon_bp',name:'Medium Cannon',cat:'Blackpowder Guns',era:'blackpowder',range:'25/50/100',damage:'4d6+1',ap:4,rof:1,shots:0,minSize:4,mods:2,cost:1500,notes:'Reload 3, SBT, HW'},
  {id:'heavy_cannon_bp',name:'Heavy Cannon',cat:'Blackpowder Guns',era:'blackpowder',range:'30/60/120',damage:'5d6',ap:6,rof:1,shots:0,minSize:6,mods:3,cost:3000,notes:'Reload 4, SBT, HW'},
  {id:'carronade',name:'Carronade',cat:'Blackpowder Guns',era:'blackpowder',range:'10/20/40',damage:'4d6+2',ap:2,rof:1,shots:0,minSize:3,mods:1,cost:800,notes:'Reload 2, Grapeshot (Cone), HW'},
  {id:'mortar_bp',name:'Mortar',cat:'Blackpowder Guns',era:'blackpowder',range:'24/48/96',damage:'3d8',ap:0,rof:1,shots:0,minSize:2,mods:1,cost:500,notes:'Reload 3, Indirect, MBT, HW'},
  {id:'congreve',name:'Congreve Rocket',cat:'Rockets',era:'blackpowder',range:'18/36/72',damage:'3d6',ap:0,rof:1,shots:6,minSize:1,mods:1,cost:400,notes:'Inaccurate (-1 Shooting), Incendiary, MBT'},
  {id:'chain_shot',name:'Chain Shot',cat:'Blackpowder Guns',era:'blackpowder',range:'15/30/60',damage:'3d6',ap:0,rof:1,shots:0,minSize:3,mods:0,cost:200,notes:'Anti-rigging. Reload 3. Targets mast/locomotion only'},
  // INDUSTRIAL (WWI/WWII era)
  {id:'hmg',name:'Heavy Machine Gun',cat:'Machine Guns',era:'industrial',range:'30/60/120',damage:'2d8',ap:2,rof:3,shots:200,minSize:1,mods:1,cost:1000,notes:'Pt Def, Rxn Fire'},
  {id:'autocannon_ww',name:'Autocannon',cat:'Cannons',era:'industrial',range:'40/80/160',damage:'2d10',ap:4,rof:3,shots:100,minSize:2,mods:1,cost:5000,notes:'HW'},
  {id:'tank_gun_light',name:'Light Tank Gun',cat:'Cannons',era:'industrial',range:'50/100/200',damage:'3d10',ap:6,rof:1,shots:60,minSize:3,mods:2,cost:10000,notes:'SBT, HW'},
  {id:'tank_gun_med',name:'Medium Tank Gun',cat:'Cannons',era:'industrial',range:'75/150/300',damage:'4d10',ap:10,rof:1,shots:40,minSize:5,mods:3,cost:20000,notes:'SBT, HW'},
  {id:'tank_gun_heavy',name:'Heavy Tank Gun',cat:'Cannons',era:'industrial',range:'100/200/400',damage:'5d10',ap:16,rof:1,shots:30,minSize:7,mods:4,cost:40000,notes:'SBT, HW'},
  {id:'flamethrower_ww',name:'Flamethrower',cat:'Flamethrowers',era:'industrial',range:'Cone',damage:'3d6',ap:0,rof:1,shots:10,minSize:1,mods:1,cost:1000,notes:'Incendiary, Cone'},
  {id:'torpedo_ww',name:'Torpedo',cat:'Torpedoes',era:'industrial',range:'50/100/200',damage:'5d10',ap:10,rof:1,shots:2,minSize:4,mods:1,cost:5000,notes:'Guided (basic), LBT, Aquatic only'},
  {id:'bombs_ww',name:'Bomb Bay',cat:'Ordnance',era:'industrial',range:'—',damage:'4d8',ap:4,rof:1,shots:10,minSize:4,mods:2,cost:3000,notes:'Aircraft only. Drop, MBT. Bombing run rules.'},
  {id:'depth_charge_ww',name:'Depth Charges',cat:'Anti-Submarine',era:'industrial',range:'—',damage:'4d8',ap:4,rof:1,shots:8,minSize:4,mods:1,cost:2000,notes:'Drop, MBT. Anti-sub only.'},
  {id:'naval_gun_ww',name:'Naval Gun',cat:'Naval Guns',era:'industrial',range:'100/200/400',damage:'5d10',ap:12,rof:1,shots:60,minSize:8,mods:4,cost:35000,notes:'SBT, HW. Deck-mounted.'},
  {id:'mine_ww',name:'Naval Mine Layer',cat:'Mines',era:'industrial',range:'—',damage:'5d10',ap:8,rof:0,shots:20,minSize:4,mods:2,cost:4000,notes:'Deploy mine per round. 3d6 trigger radius.'},
  // MODERN
  {id:'hmg_modern',name:'Heavy Machine Gun',cat:'Machine Guns',era:'modern',range:'50/100/200',damage:'2d10',ap:4,rof:3,shots:200,minSize:1,mods:1,cost:2000,notes:'Pt Def, Rxn Fire, HW'},
  {id:'minigun_modern',name:'Minigun',cat:'Machine Guns',era:'modern',range:'50/100/200',damage:'2d8+1',ap:2,rof:5,shots:2000,minSize:3,mods:1,cost:10000,notes:'Min RoF 3, Pt Def, Rxn Fire, HW'},
  {id:'autocannon_mod',name:'Light Autocannon',cat:'Autocannons',era:'modern',range:'50/100/200',damage:'3d8',ap:4,rof:4,shots:100,minSize:2,mods:1,cost:10000,notes:'Min RoF 2, Pt Def, Rxn Fire, HW'},
  {id:'cannon_mod',name:'Tank Cannon',cat:'Cannons',era:'modern',range:'100/200/400',damage:'5d10',ap:20,rof:1,shots:40,minSize:4,mods:4,cost:50000,notes:'SBT, HW'},
  {id:'atgm',name:'ATGM Launcher',cat:'Missiles',era:'modern',range:'75/150/300',damage:'5d10',ap:20,rof:1,shots:4,minSize:1,mods:1,cost:8000,notes:'Guided, SBT, HW'},
  {id:'sam',name:'SAM Launcher',cat:'Missiles',era:'modern',range:'100/200/400',damage:'5d6',ap:10,rof:1,shots:4,minSize:2,mods:1,cost:12000,notes:'Guided, SBT, HW'},
  {id:'rocket_pod',name:'Rocket Pod',cat:'Missiles',era:'modern',range:'50/100/200',damage:'4d8',ap:6,rof:3,shots:19,minSize:2,mods:1,cost:6000,notes:'SBT, HW'},
  {id:'grenade_mod',name:'Grenade Launcher',cat:'Launchers',era:'modern',range:'24/48/96',damage:'3d6',ap:0,rof:1,shots:12,minSize:0,mods:1,cost:2600,notes:'MBT'},
  {id:'torpedo_mod',name:'Modern Torpedo',cat:'Torpedoes',era:'modern',range:'100/200/400',damage:'6d10',ap:16,rof:1,shots:4,minSize:4,mods:2,cost:15000,notes:'Guided, LBT, Aquatic only'},
  {id:'ciws',name:'CIWS / Phalanx',cat:'Point Defense',era:'modern',range:'30/60/120',damage:'2d10',ap:4,rof:6,shots:1000,minSize:4,mods:2,cost:20000,notes:'Pt Def only. Auto-fire vs missiles/aircraft.'},
  {id:'naval_gun_mod',name:'Naval Gun (5-inch)',cat:'Naval Guns',era:'modern',range:'150/300/600',damage:'5d10+2',ap:14,rof:1,shots:80,minSize:8,mods:4,cost:60000,notes:'SBT, HW. Deck-mounted.'},
  {id:'cruise_missile',name:'Cruise Missile',cat:'Missiles',era:'modern',range:'500/1K/2K',damage:'8d6',ap:24,rof:1,shots:2,minSize:6,mods:2,cost:50000,notes:'Guided, LBT, HW. Extreme range.'},
  {id:'bombs_mod',name:'Bomb Bay / Hardpoint',cat:'Ordnance',era:'modern',range:'—',damage:'5d8',ap:8,rof:1,shots:8,minSize:4,mods:2,cost:5000,notes:'Aircraft only. Drop, MBT. Precision guided.'},
  {id:'depth_charge_mod',name:'Depth Charges',cat:'Anti-Submarine',era:'modern',range:'—',damage:'5d8',ap:6,rof:1,shots:6,minSize:4,mods:1,cost:5000,notes:'Drop, MBT. Anti-sub only.'},
  // FUTURE (Sci-fi standard)
  {id:'slug_future',name:'Heavy Slugthrower',cat:'Slugthrowers',era:'future',range:'50/100/200',damage:'2d10 (I)',ap:4,rof:3,shots:50,minSize:3,mods:1,cost:2000,notes:'Pt Def, Rxn Fire'},
  {id:'ac_future',name:'Medium Autocannon',cat:'Autocannons',era:'future',range:'50/100/200',damage:'4d8 (II)',ap:6,rof:4,shots:80,minSize:8,mods:2,cost:20000,notes:'Min RoF 2'},
  {id:'laser_gat',name:'Gatling Laser',cat:'Lasers',era:'future',range:'50/100/200',damage:'3d6+4 (I)',ap:4,rof:4,shots:80,minSize:1,mods:1,cost:3000,notes:'Cauterize, Overcharge, Pt Def, Rxn Fire'},
  {id:'laser_light',name:'Light Laser',cat:'Lasers',era:'future',range:'150/300/600',damage:'2d10 (II)',ap:10,rof:3,shots:80,minSize:2,mods:1,cost:20000,notes:'Cauterize, Overcharge, Rxn Fire'},
  {id:'laser_med',name:'Medium Laser',cat:'Lasers',era:'future',range:'150/300/600',damage:'3d10 (III)',ap:20,rof:2,shots:60,minSize:4,mods:3,cost:50000,notes:'Cauterize, Overcharge'},
  {id:'laser_heavy',name:'Heavy Laser',cat:'Lasers',era:'future',range:'150/300/600',damage:'4d10 (V)',ap:30,rof:1,shots:40,minSize:8,mods:5,cost:200000,notes:'Cauterize, Overcharge'},
  {id:'cannon_future',name:'Heavy Cannon',cat:'Cannons',era:'future',range:'100/200/400',damage:'5d10 (IV)',ap:20,rof:1,shots:40,minSize:4,mods:5,cost:60000,notes:'SBT'},
  {id:'cannon_super',name:'Super Cannon',cat:'Cannons',era:'future',range:'150/300/600',damage:'6d10 (VI)',ap:30,rof:1,shots:20,minSize:10,mods:6,cost:100000,notes:'MBT'},
  {id:'flamer_future',name:'Heavy Flamethrower',cat:'Flamethrowers',era:'future',range:'Cone',damage:'3d12 (I)',ap:0,rof:1,shots:30,minSize:1,mods:1,cost:5000,notes:'Cauterize, Incendiary, Cone 18"'},
  {id:'missile_light',name:'Light Missiles (×8)',cat:'Missiles',era:'future',range:'100/200/400',damage:'6d6 (III)',ap:16,rof:4,shots:8,minSize:2,mods:0,cost:4000,notes:'Guided, SBT'},
  {id:'missile_med',name:'Medium Missiles (×4)',cat:'Missiles',era:'future',range:'150/300/600',damage:'7d6 (IV)',ap:24,rof:2,shots:4,minSize:2,mods:0,cost:10000,notes:'Guided, MBT'},
  {id:'missile_heavy',name:'Heavy Missiles (×2)',cat:'Missiles',era:'future',range:'200/400/800',damage:'8d6 (V)',ap:32,rof:1,shots:2,minSize:2,mods:0,cost:20000,notes:'Guided, LBT'},
  {id:'missile_rack',name:'Missile Launcher',cat:'Missiles',era:'future',range:'—',damage:'—',ap:0,rof:0,shots:0,minSize:2,mods:1,cost:1000,notes:'Rack only. Load missiles separately.'},
  {id:'torpedo_future',name:'Plasma Torpedo',cat:'Torpedoes',era:'future',range:'100/200/400',damage:'6d10 (IV)',ap:20,rof:1,shots:4,minSize:4,mods:2,cost:20000,notes:'Guided, LBT, Aquatic/Space'},
  // ADVANCED (far-future / energy weapons)
  {id:'md_light',name:'Light Mass Driver',cat:'Mass Drivers',era:'advanced',range:'100/200/400',damage:'2d12+2 (I)',ap:5,rof:3,shots:100,minSize:2,mods:2,cost:10000,notes:'Pt Def, Rxn Fire, SBT'},
  {id:'md_med',name:'Medium Mass Driver',cat:'Mass Drivers',era:'advanced',range:'100/200/400',damage:'3d12+3 (II)',ap:5,rof:2,shots:80,minSize:4,mods:3,cost:20000,notes:'MBT'},
  {id:'pc_light',name:'Light Particle Cannon',cat:'Particle Cannons',era:'advanced',range:'100/200/400',damage:'4d6+4 (II)',ap:5,rof:3,shots:90,minSize:2,mods:2,cost:25000,notes:'Pt Def, Rxn Fire'},
  {id:'pc_med',name:'Medium Particle Cannon',cat:'Particle Cannons',era:'advanced',range:'100/200/400',damage:'6d6+6 (III)',ap:10,rof:3,shots:60,minSize:8,mods:4,cost:50000,notes:''},
  {id:'laser_super',name:'Super Laser',cat:'Lasers',era:'advanced',range:'150/300/600',damage:'5d10 (V)',ap:30,rof:1,shots:20,minSize:12,mods:8,cost:300000,notes:'Cauterize, Overcharge'},
  {id:'plasma_cannon',name:'Plasma Cannon',cat:'Energy Weapons',era:'advanced',range:'75/150/300',damage:'5d10 (IV)',ap:20,rof:1,shots:30,minSize:6,mods:4,cost:150000,notes:'Cauterize, Incendiary, SBT'},
  {id:'rail_gun',name:'Railgun',cat:'Mass Drivers',era:'advanced',range:'200/400/800',damage:'5d12 (V)',ap:40,rof:1,shots:20,minSize:8,mods:6,cost:250000,notes:'SBT, Ignores Shields'}
];
// Era labels for UI
var ERA_LABELS={ancient:'Ancient',medieval:'Medieval',blackpowder:'Blackpowder',industrial:'Industrial (WWI/WWII)',modern:'Modern',future:'Future (Sci-Fi)',advanced:'Advanced (Far-Future)'};
var ERA_ORDER=['ancient','medieval','blackpowder','industrial','modern','future','advanced'];
var currentEra='modern';
// Custom weapons storage
var customWeapons=[];
try{var cw=localStorage.getItem('diceforge-cvf-custom-weapons');if(cw)customWeapons=JSON.parse(cw)}catch(e){}
function getAllWeapons(){return WEAPONS.concat(customWeapons)}

// ═══ STATE ═══
var S={name:'Untitled Vehicle',size:6,loco:'wheeled',mods:{},weapons:[],currentMount:'pintle',saved:[]};

// ═══ MOD COST CALCULATIONS ═══
function modSlots(m,sz){
  if(m.mods==='half')return Math.ceil(sz/2);
  if(m.mods==='halfneg')return -Math.ceil(sz/2);
  if(m.mods==='size')return sz;
  return m.mods;
}
function weaponMountMods(w,mount){var mc=w.mods;if(mount==='fixed')mc=Math.ceil(mc/2);if(mount==='turret')mc=mc*2;return mc}
function maxArmorTakes(){var f=getFrame(S.size);return Math.floor((f.maxArmor-f.baseTough)/2)}

// ═══ STAT CALCULATIONS ═══
function calcTough(){var f=getFrame(S.size),t=f.baseTough;if(S.mods.battered)t-=2*S.mods.battered;if(S.mods.toughness)t+=S.mods.toughness;return Math.max(0,t)}
function calcArmor(){var f=getFrame(S.size),a=f.baseTough;if(S.mods.armor)a+=2*S.mods.armor;return Math.min(a,f.maxArmor)}
function calcWounds(){var f=getFrame(S.size),w=f.wounds;if(S.mods.fragile)w-=S.mods.fragile;return Math.max(1,w)}
function calcHand(){var f=getFrame(S.size),h=f.hand;if(S.mods.handling)h+=S.mods.handling;if(S.mods.reduced_hand)h-=S.mods.reduced_hand;return h}
function calcSpeed(){var loco=LOCOS.find(function(l){return l.id===S.loco});var s=loco?loco.speed:5;if(S.mods.inc_speed)s+=S.mods.inc_speed;if(S.mods.reduced_speed)s-=S.mods.reduced_speed;return Math.max(1,s)}
function calcEnergy(){var f=getFrame(S.size),e=f.energy;if(S.mods.reactor)e*=10;if(S.mods.energy_pod)e*=Math.pow(2,S.mods.energy_pod);return e}
function calcModsUsed(){var t=0;for(var id in S.mods){var m=MODS.find(function(x){return x.id===id});var ms=modSlots(m,S.size);if(ms>0)t+=ms*S.mods[id]}
  S.weapons.forEach(function(w){var wp=getAllWeapons().find(function(x){return x.id===w.weaponId});if(wp)t+=weaponMountMods(wp,w.mount)});return t}
function calcModsGained(){var t=0;for(var id in S.mods){var m=MODS.find(function(x){return x.id===id});var ms=modSlots(m,S.size);if(ms<0)t+=Math.abs(ms)*S.mods[id]}return t}
function calcCost(){var f=getFrame(S.size),loco=LOCOS.find(function(l){return l.id===S.loco});
  var cost=f.costMult*S.size+(loco?loco.costMult*S.size:0);
  for(var id in S.mods){var m=MODS.find(function(x){return x.id===id});cost+=m.costFn(S.size)*S.mods[id]}
  S.weapons.forEach(function(w){var wp=getAllWeapons().find(function(x){return x.id===w.weaponId});if(wp)cost+=wp.cost});return cost}
function isWalker(){return S.loco==='legs_biped'||S.loco==='legs_quad'}
function walkerStr(){return 'd12+'+S.size}
function isHeavyArmor(){return S.size>=4||isWalker()}
// ═══ DRAG-DROP ENGINE ═══
function getXY(e){if(e.touches&&e.touches.length)return{x:e.touches[0].clientX,y:e.touches[0].clientY};if(e.changedTouches&&e.changedTouches.length)return{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY};return{x:e.clientX,y:e.clientY}}
var drag={active:false,type:null,id:null,ghost:null};
function startDrag(e,type,id,label){e.preventDefault();Audio.init();var pt=getXY(e);drag={active:true,type:type,id:id,ghost:null};var ghost=document.createElement('div');ghost.className='drag-ghost';ghost.textContent=label;ghost.style.left=pt.x+'px';ghost.style.top=pt.y+'px';document.body.appendChild(ghost);drag.ghost=ghost;var src=e.target.closest('.drag-item')||e.target.closest('.weapon-drag-item');if(src)src.classList.add('dragging');document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onEnd);document.addEventListener('touchmove',onMove,{passive:false});document.addEventListener('touchend',onEnd);document.addEventListener('touchcancel',onEnd)}
function onMove(e){if(!drag.active||!drag.ghost)return;if(e.cancelable)e.preventDefault();var pt=getXY(e);var bay=document.getElementById(drag.type==='mod'?'modBay':'weaponBay');if(bay){var r=bay.getBoundingClientRect();var inside=pt.x>=r.left&&pt.x<=r.right&&pt.y>=r.top&&pt.y<=r.bottom;bay.classList.toggle('drag-over',inside);drag.ghost.classList.toggle('near-target',!inside&&pt.x>=r.left-80&&pt.x<=r.right+80&&pt.y>=r.top-80&&pt.y<=r.bottom+80)}drag.ghost.style.left=pt.x+'px';drag.ghost.style.top=pt.y+'px'}
function onEnd(e){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onEnd);document.removeEventListener('touchmove',onMove);document.removeEventListener('touchend',onEnd);document.removeEventListener('touchcancel',onEnd);if(drag.ghost)drag.ghost.remove();document.querySelectorAll('.dragging').forEach(function(el){el.classList.remove('dragging')});var pt=getXY(e);var bay=document.getElementById(drag.type==='mod'?'modBay':'weaponBay');if(bay){var r=bay.getBoundingClientRect();if(pt.x>=r.left&&pt.x<=r.right&&pt.y>=r.top&&pt.y<=r.bottom){if(drag.type==='mod')dropMod(drag.id);else dropWeapon(drag.id);bay.classList.remove('impact');void bay.offsetWidth;bay.classList.add('impact')}bay.classList.remove('drag-over')}drag={active:false,type:null,id:null,ghost:null}}

function dropMod(id){var m=MODS.find(function(x){return x.id===id});
  var max=m.max==='U'?99:m.max==='frame'?maxArmorTakes():m.max;
  var cur=S.mods[id]||0;
  if(id==='inc_speed'&&S.mods.reduced_speed)return;
  if(id==='reduced_speed'&&S.mods.inc_speed)return;
  if(id==='handling'&&S.mods.reduced_hand)return;
  if(id==='reduced_hand'&&S.mods.handling)return;
  if(id==='exposed'&&S.mods.sealed)return;
  if(id==='sealed'&&S.mods.exposed)return;
  if(id==='fwd'&&S.loco!=='wheeled')return;
  if(cur<max){S.mods[id]=cur+1;Audio.clunk();renderModBay(id);renderStats();renderOutput()}}
function dropWeapon(id){var w=getAllWeapons().find(function(x){return x.id===id});if(!w||w.minSize>S.size)return;
  S.weapons.push({weaponId:id,mount:S.currentMount});Audio.clunk();renderWeaponBay(id);renderStats();renderOutput()}

// ═══ RENDER FUNCTIONS ═══
function renderLocoGrid(){var el=document.getElementById('locoGrid');
  el.innerHTML=LOCOS.map(function(l){return '<div class="loco-btn'+(S.loco===l.id?' active':'')+'" onclick="setLoco(\''+l.id+'\')"><span>'+l.name+'</span><span class="loco-speed">Spd '+l.speed+'</span></div>'}).join('')}
function setLoco(id){S.loco=id;Audio.click();renderLocoGrid();renderStats();renderOutput();renderModCatalogue()}
function setSize(sz){S.size=sz;S.mods={};S.weapons=[];document.getElementById('sizeVal').textContent=sz;document.getElementById('sizeClass').textContent=getFrame(sz).cat;renderFrameInfo();renderLocoGrid();renderModCatalogue();renderModBay();renderWeaponCatalogue();renderWeaponBay();renderStats();renderOutput()}
function renderFrameInfo(){var f=getFrame(S.size);document.getElementById('sizeVal').textContent=S.size;document.getElementById('sizeClass').textContent=f.cat;
  var ref=SIZE_REF[S.size]||{len:'?',ex:'—',wt:'?'};
  document.getElementById('frameInfo').innerHTML='<div style="font-size:12px;color:var(--text-dim);font-style:italic;margin-bottom:6px;line-height:1.4">~'+ref.len+' long, ~'+ref.wt+' — <span style="color:var(--text)">'+ref.ex+'</span></div><div class="frame-stats">'
    +'<div class="frame-stat"><div class="fs-label">Base Tough</div><div class="fs-value">'+f.baseTough+' ('+f.maxArmor+')</div></div>'
    +'<div class="frame-stat"><div class="fs-label">Wounds</div><div class="fs-value">'+f.wounds+'</div></div>'
    +'<div class="frame-stat"><div class="fs-label">Crew</div><div class="fs-value">'+f.crew+'</div></div>'
    +'<div class="frame-stat"><div class="fs-label">Energy</div><div class="fs-value">'+f.energy+' days</div></div>'
    +'<div class="frame-stat"><div class="fs-label">Base Mods</div><div class="fs-value">'+S.size*f.modMult+'</div></div>'
    +'<div class="frame-stat"><div class="fs-label">Frame Cost</div><div class="fs-value">$'+fmtC(f.costMult*S.size)+'</div></div></div>'}

function renderModCatalogue(){var el=document.getElementById('modCatalogue'),cats={};
  MODS.forEach(function(m){
    if(m.id==='fwd'&&S.loco!=='wheeled')return;
    if(m.id==='jump_jets'&&!isWalker())return;
    if(m.id==='tandem_pilots'&&!isWalker())return;
    if(!cats[m.cat])cats[m.cat]=[];cats[m.cat].push(m)});
  var h='';for(var cat in cats){h+='<div class="cat-header">'+cat+'</div>';
    cats[cat].forEach(function(m){var ms=modSlots(m,S.size);var price=m.costFn(S.size);
      h+='<div class="drag-item" onmousedown="startDrag(event,\'mod\',\''+m.id+'\',\''+m.name+'\')" ontouchstart="startDrag(event,\'mod\',\''+m.id+'\',\''+m.name+'\')">'
        +'<span class="drag-handle">&#x2807;</span>'
        +'<div class="di-info"><div class="di-name">'+m.name+'</div><div class="di-desc">'+m.desc+'</div></div>'
        +'<div class="di-meta"><div class="di-mods">'+(ms>0?ms+' mod'+(ms>1?'s':''):ms<0?'+'+Math.abs(ms)+' mod'+(Math.abs(ms)>1?'s':''):'—')+'</div>'
        +'<div class="di-price">'+(price>=0?'$'+fmtN(price):'-$'+fmtN(Math.abs(price)))+'</div></div></div>'})}
  el.innerHTML=h}

function renderModBay(animId){var bay=document.getElementById('modBay');
  var inst=[];for(var k in S.mods){if(S.mods[k]>0)inst.push([k,S.mods[k]])}
  if(!inst.length){bay.innerHTML='<div class="empty-bay">Drag modifications here to install them</div>';return}
  bay.innerHTML=inst.map(function(p){var id=p[0],ct=p[1];var m=MODS.find(function(x){return x.id===id});var ms=modSlots(m,S.size)*ct;var tp=m.costFn(S.size)*ct;
    return '<div class="bay-item '+(id===animId?'snap-in':'')+'">'
      +'<div class="bi-info"><div class="bi-name">'+m.name+'</div>'
      +'<div class="bi-detail">'+(ms>0?ms+' mods':ms<0?'Grants '+Math.abs(ms)+' mods':'0 mods')+' · '+(tp>=0?'$'+fmtN(tp):'-$'+fmtN(Math.abs(tp)))+'</div></div>'
      +'<div class="bi-controls"><button onclick="modDec(\''+id+'\')">&minus;</button><span class="bi-count">'+ct+'</span><button onclick="modInc(\''+id+'\')">+</button></div>'
      +'<span class="bi-remove" onclick="modRemoveAll(\''+id+'\')">&times;</span></div>'}).join('')}
function modInc(id){dropMod(id);Audio.click()}
function modDec(id){if(S.mods[id]>0){S.mods[id]--;if(!S.mods[id])delete S.mods[id];Audio.click();renderModBay();renderStats();renderOutput()}}
function modRemoveAll(id){delete S.mods[id];Audio.remove();renderModBay();renderStats();renderOutput()}

function renderEraFilter(){var el=document.getElementById('eraFilter');
  el.innerHTML='<div class="mount-tab'+(currentEra==='all'?' active':'')+'" onclick="setEra(\'all\')" style="font-size:10px;padding:4px 10px">All</div>'+
    ERA_ORDER.map(function(e){return '<div class="mount-tab'+(currentEra===e?' active':'')+'" onclick="setEra(\''+e+'\')" style="font-size:10px;padding:4px 10px">'+ERA_LABELS[e]+'</div>'}).join('')+
    (customWeapons.length?'<div class="mount-tab'+(currentEra==='custom'?' active':'')+'" onclick="setEra(\'custom\')" style="font-size:10px;padding:4px 10px">Custom</div>':'')}
function setEra(e){currentEra=e;renderEraFilter();renderWeaponCatalogue()}

function renderWeaponCatalogue(){var cats={};
  var wpns=currentEra==='all'?getAllWeapons():currentEra==='custom'?customWeapons:getAllWeapons().filter(function(w){return w.era===currentEra});
  wpns.forEach(function(w){if(!cats[w.cat])cats[w.cat]=[];cats[w.cat].push(w)});
  var h='';for(var cat in cats){h+='<div class="cat-header">'+cat+'</div>';
    cats[cat].forEach(function(w){var ok=w.minSize<=S.size;
      h+='<div class="weapon-drag-item" style="'+(ok?'':'opacity:.4;pointer-events:none')+'" onmousedown="startDrag(event,\'weapon\',\''+w.id+'\',\''+w.name+'\')" ontouchstart="startDrag(event,\'weapon\',\''+w.id+'\',\''+w.name+'\')">'
        +'<span class="drag-handle" style="color:var(--text-dim);font-size:14px;opacity:.4">&#x2807;</span>'
        +'<div class="wdi-info"><div class="wdi-name">'+w.name+(ok?'':' (Min Size '+w.minSize+')')+(w.era?'<span style="font-size:10px;color:var(--text-dim);font-weight:400"> — '+ERA_LABELS[w.era]+'</span>':'')+'</div>'
        +'<div class="wdi-stats">'+w.range+' · '+w.damage+' · AP '+w.ap+' · RoF '+w.rof+'</div>'
        +'<div class="wdi-stats">'+w.notes+'</div></div>'
        +'<div class="wdi-meta"><div class="wdi-mods">'+w.mods+' mod'+(w.mods!==1?'s':'')+'</div>'
        +'<div class="wdi-price">$'+fmtN(w.cost)+'</div></div></div>'})}
  if(!h)h='<div class="empty-state"><p>No weapons in this era for Size '+S.size+'.</p></div>';
  document.getElementById('weaponCatalogue').innerHTML=h}

function toggleCustomForm(){var el=document.getElementById('customForm');
  if(el.style.display==='none'){el.style.display='block';
    el.innerHTML='<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">'
      +'<input type="text" id="cw_name" placeholder="Name" style="grid-column:1/3;background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="text" id="cw_cat" placeholder="Category" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="text" id="cw_range" placeholder="Range (e.g. 50/100/200)" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="text" id="cw_damage" placeholder="Damage (e.g. 3d10)" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="number" id="cw_ap" placeholder="AP" value="0" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="number" id="cw_rof" placeholder="RoF" value="1" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="number" id="cw_shots" placeholder="Shots" value="20" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="number" id="cw_minsize" placeholder="Min Size" value="1" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="number" id="cw_mods" placeholder="Mods" value="1" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="number" id="cw_cost" placeholder="Cost" value="5000" style="background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'<input type="text" id="cw_notes" placeholder="Notes (e.g. HW, SBT)" style="grid-column:1/3;background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:4px 8px;font-family:\'Crimson Pro\',serif;font-size:13px">'
      +'</div><button class="header-btn" onclick="addCustomWeapon()" style="width:100%;margin-top:6px;text-align:center">Add Weapon</button>'}
  else{el.style.display='none'}}

function addCustomWeapon(){var n=document.getElementById('cw_name').value.trim();if(!n)return;
  var w={id:'custom_'+Date.now(),name:n,cat:document.getElementById('cw_cat').value.trim()||'Custom',era:'custom',
    range:document.getElementById('cw_range').value.trim()||'—',damage:document.getElementById('cw_damage').value.trim()||'—',
    ap:+(document.getElementById('cw_ap').value)||0,rof:+(document.getElementById('cw_rof').value)||1,
    shots:+(document.getElementById('cw_shots').value)||0,minSize:+(document.getElementById('cw_minsize').value)||1,
    mods:+(document.getElementById('cw_mods').value)||1,cost:+(document.getElementById('cw_cost').value)||0,
    notes:document.getElementById('cw_notes').value.trim()||''};
  customWeapons.push(w);localStorage.setItem('diceforge-cvf-custom-weapons',JSON.stringify(customWeapons));
  Audio.clunk();document.getElementById('customForm').style.display='none';renderEraFilter();renderWeaponCatalogue()}

function renderWeaponBay(animId){var bay=document.getElementById('weaponBay');
  if(!S.weapons.length){bay.innerHTML='<div class="empty-bay">Drag weapons here to mount them</div>';return}
  bay.innerHTML=S.weapons.map(function(w,i){var wp=getAllWeapons().find(function(x){return x.id===w.weaponId});if(!wp)return '';
    var mc=weaponMountMods(wp,w.mount);var ml=w.mount==='fixed'?'Fixed Front':w.mount==='turret'?'Turret':'Pintle';
    return '<div class="weapon-bay-item '+(w.weaponId===animId&&i===S.weapons.length-1?'snap-in':'')+'">'
      +'<div class="wbi-info"><div class="wbi-name">'+wp.name+'</div>'
      +'<div class="wbi-stats">'+wp.range+' · '+wp.damage+' · AP '+wp.ap+' · '+wp.notes+'</div>'
      +'<div class="wbi-mount">'+ml+' · '+mc+' mod'+(mc!==1?'s':'')+' · $'+fmtN(wp.cost)+'</div></div>'
      +'<span class="wbi-remove" onclick="removeWeapon('+i+')">&times;</span></div>'}).join('')}
function switchMount(m){S.currentMount=m;document.querySelectorAll('.mount-tab').forEach(function(t){t.classList.toggle('active',t.dataset.mount===m)})}
function removeWeapon(i){S.weapons.splice(i,1);Audio.remove();renderWeaponBay();renderStats();renderOutput()}
// ═══ STATS PANEL ═══
function renderStats(){var f=getFrame(S.size),used=calcModsUsed(),gained=calcModsGained(),total=S.size*f.modMult+gained,left=total-used;var spd=calcSpeed();
  document.getElementById('statsGrid').innerHTML=
    '<div class="stat-box"><div class="stat-label">Toughness</div><div class="stat-value">'+calcTough()+' ('+calcArmor()+')</div></div>'
    +'<div class="stat-box"><div class="stat-label">Wounds</div><div class="stat-value">'+calcWounds()+'</div></div>'
    +'<div class="stat-box"><div class="stat-label">Handling</div><div class="stat-value">'+(calcHand()>=0?'+':'')+calcHand()+'</div></div>'
    +'<div class="stat-box"><div class="stat-label">Top Speed</div><div class="stat-value">'+spd+' ('+speedMPH(spd)+' MPH)</div></div>'
    +'<div class="stat-box"><div class="stat-label">Crew</div><div class="stat-value">'+f.crew+'</div></div>'
    +(isWalker()?'<div class="stat-box"><div class="stat-label">Strength</div><div class="stat-value" style="color:var(--accent)">'+walkerStr()+'</div></div>':'')
    +'<div class="stat-box"><div class="stat-label">Energy</div><div class="stat-value">'+calcEnergy()+' days</div></div>';
  var cls=left<0?'over':left<=2?'low':'ok';
  document.getElementById('modsRemaining').innerHTML='<div class="big-num '+cls+'">'+left+'</div><div class="sub">Mods Remaining</div>';
  document.getElementById('costDisplay').innerHTML='<div class="cost-val">$'+fmtC(calcCost())+'</div><div class="cost-label">Total Cost</div>'}

// ═══ STAT BLOCK OUTPUT ═══
function renderOutput(){var p=document.getElementById('panel-output'),f=getFrame(S.size);
  var loco=LOCOS.find(function(l){return l.id===S.loco});var spd=calcSpeed();
  var used=calcModsUsed(),gained=calcModsGained(),left=(S.size*f.modMult+gained)-used;
  var notes=[];MODS.forEach(function(m){if(S.mods[m.id]>0)notes.push(S.mods[m.id]>1?S.mods[m.id]+'× '+m.name:m.name)});
  var wl=[];S.weapons.forEach(function(w){var wp=getAllWeapons().find(function(x){return x.id===w.weaponId});if(wp){var ml=w.mount==='fixed'?'Fixed Front':w.mount==='turret'?'Turret':'Pintle';
    wl.push(wp.name+' ('+ml+'): Range '+wp.range+', Damage '+wp.damage+', AP '+wp.ap+', RoF '+wp.rof+(wp.notes?', '+wp.notes:''))}});
  var special=[];
  if(isHeavyArmor())special.push('Heavy Armor');
  if(loco)special.push(loco.name+': '+loco.notes);
  if(isWalker())special.push('Piloting skill. Parry 2 + ½ Piloting + Handling. Fighting = lower of Piloting/Fighting. Always armed (Str '+walkerStr()+' damage, HW).');
  if(S.mods.shields)special.push('Shields: '+Math.floor(calcWounds()/2)+' charges, Soak with Electronics.');
  if(S.mods.reactor)special.push('Reactor: Energy ×10. Locomotion Crit on odd die = explosion.');
  if(S.mods.stabilizer)special.push('Stabilizer: No Unstable Platform penalty.');
  if(S.mods.targeting)special.push('Targeting: -2 Shooting penalties.');

  p.innerHTML='<div class="stat-block">'
    +'<div class="sb-name">'+(S.name||'Untitled Vehicle')+'</div>'
    +'<div class="sb-type">Size '+S.size+' ('+f.cat+'), '+loco.name+', Handling '+(calcHand()>=0?'+':'')+calcHand()+', Top Speed '+spd+' ('+speedMPH(spd)+' MPH)</div>'
    +'<hr class="sb-divider">'
    +'<div class="sb-line"><span class="sb-label">Toughness:</span> '+calcTough()+' ('+calcArmor()+')</div>'
    +'<div class="sb-line"><span class="sb-label">Wounds:</span> '+calcWounds()+'</div>'
    +'<div class="sb-line"><span class="sb-label">Crew:</span> '+f.crew+'</div>'
    +(isWalker()?'<div class="sb-line"><span class="sb-label">Strength:</span> '+walkerStr()+'</div>':'')
    +'<div class="sb-line"><span class="sb-label">Energy:</span> '+calcEnergy()+' days</div>'
    +'<div class="sb-line"><span class="sb-label">Cost:</span> $'+fmtC(calcCost())+', Mods '+left+' remaining</div>'
    +'<hr class="sb-divider">'
    +(notes.length?'<div class="sb-line"><span class="sb-label">Mods:</span> '+notes.join(', ')+'.</div>':'')
    +(wl.length?'<div class="sb-line"><span class="sb-label">Weapons:</span></div>'+wl.map(function(w){return '<div class="sb-line">&nbsp;&nbsp;• '+w+'</div>'}).join(''):'')
    +(special.length?'<hr class="sb-divider"><div class="sb-notes"><span class="sb-label">Special:</span> '+special.join(' ')+'</div>':'')
    +'</div>'
    +'<div style="margin-top:16px"><button class="header-btn" onclick="copyBlock()">Copy to Clipboard</button></div>'}

function copyBlock(){var f=getFrame(S.size),loco=LOCOS.find(function(l){return l.id===S.loco});var spd=calcSpeed();
  var left=(S.size*f.modMult+calcModsGained())-calcModsUsed();
  var notes=[],wl=[];
  MODS.forEach(function(m){if(S.mods[m.id]>0)notes.push(S.mods[m.id]>1?S.mods[m.id]+'x '+m.name:m.name)});
  S.weapons.forEach(function(w){var wp=getAllWeapons().find(function(x){return x.id===w.weaponId});if(wp){var ml=w.mount==='fixed'?'Fixed':w.mount==='turret'?'Turret':'Pintle';wl.push('  * '+wp.name+' ('+ml+'): '+wp.range+', '+wp.damage+', AP '+wp.ap+', RoF '+wp.rof)}});
  var t=S.name+'\nSize '+S.size+' ('+f.cat+'), '+loco.name+', Hand '+(calcHand()>=0?'+':'')+calcHand()+', Top Speed '+spd+' ('+speedMPH(spd)+' MPH)\nTough '+calcTough()+' ('+calcArmor()+'), Wounds '+calcWounds()+', Crew '+f.crew+(isWalker()?', Str '+walkerStr():'')+'\nEnergy '+calcEnergy()+' days, Cost $'+fmtC(calcCost())+', Mods '+left+' remaining\n';
  if(notes.length)t+='Mods: '+notes.join(', ')+'.\n';if(wl.length)t+='Weapons:\n'+wl.join('\n')+'\n';
  if(isHeavyArmor())t+='Special: Heavy Armor.';if(isWalker())t+=' Walker rules apply.';
  navigator.clipboard.writeText(t).then(function(){var btn=event.target;btn.textContent='Copied!';btn.style.borderColor='var(--green)';btn.style.color='var(--green)';setTimeout(function(){btn.textContent='Copy to Clipboard';btn.style.borderColor='';btn.style.color=''},1500)})}

// ═══ RULES REFERENCE (dynamic based on locomotion) ═══
function renderRules(){var el=document.getElementById('rulesContent');
  var h='<h3>Vehicle Overview</h3><p>Vehicles use the Piloting or Driving skill depending on type. All vehicles Size 4+ have Heavy Armor. Unused Mod slots equal cargo space (125 cubic feet each).</p>';
  h+='<p><span class="rule-key">Handling:</span> Modifier to Driving/Piloting rolls. Affects Parry for walkers.</p>';
  h+='<p><span class="rule-key">Top Speed:</span> Rated by Speed Rating (see SFC p164). Used in Chases and Clashes.</p>';
  h+='<p><span class="rule-key">Unstable Platform:</span> Shooting from a moving vehicle is at -2 (or -4 with Rough Ride).</p>';
  if(isWalker()){
    h+='<h3>Walker Combat Rules</h3>';
    h+='<p><span class="rule-key">Fighting:</span> Use the lower of operator\'s Piloting or Fighting. Parry = 2 + half Piloting + Handling. Walkers are always considered armed (Strength damage, HW).</p>';
    h+='<p><span class="rule-key">Running:</span> Piloting roll. Failure = Out of Control. Success = +1 Speed Rating. Raise = +2.</p>';
    h+='<p><span class="rule-key">Stomp:</span> Gargantuan walkers use blast template. Ignores Scale. Opposed Athletics vs Agility. Damage = Strength.</p>';
    h+='<p><span class="rule-key">Death From Above:</span> Opposed Piloting. Success = Ram + d6 per Scale category exceeding target. Failure = miss + Out of Control.</p>';
    h+='<p><span class="rule-key">Prone:</span> Free action (Piloting roll). Stand up: success halves movement, raise retains full.</p>';
    h+='<p><span class="rule-key">Critical Hits:</span> Called Shot to leg = Locomotion Crit (Speed -1). Called Shot to arm = System Crit. Nothing left = reactor breach: Xd10 in 10".</p>';
  }
  var loco=LOCOS.find(function(l){return l.id===S.loco});
  if(loco&&loco.group==='air'){
    h+='<h3>Aircraft Rules</h3>';
    if(S.loco==='jet')h+='<p><span class="rule-key">Minimum Speed:</span> 120 MPH. Drop below = Out of Control.</p>';
    if(S.loco==='turboprop')h+='<p><span class="rule-key">Minimum Speed:</span> 60 MPH. Drop below = Out of Control.</p>';
    if(S.loco==='vtol')h+='<p><span class="rule-key">VTOL:</span> Can hover, perform vertical takeoff/landing.</p>';
  }
  h+='<h3>Weapon Mounts</h3>';
  h+='<p><span class="rule-key">Pintle:</span> Standard mount, full Mod cost, 180° arc.</p>';
  h+='<p><span class="rule-key">Fixed:</span> 45° arc. Half Mod cost (round up).</p>';
  h+='<p><span class="rule-key">Turret:</span> 360° arc. Double Mod cost.</p>';
  h+='<p><span class="rule-key">Linked:</span> Dual: +1 hit, +2 dmg, +1 Mod. Quad: +2 hit, +4 dmg, +3 Mods total.</p>';
  h+='<h3>Multiple Locomotion</h3>';
  h+='<p>A vehicle may have more than one locomotion type. Buy the cheapest first. Additional forms require Mods equal to half Size and cost double. Third form: same Mods, triple cost.</p>';
  h+='<p class="rule-note">References the Savage Worlds Sci-Fi Companion. Always defer to your physical rulebook.</p>';
  el.innerHTML=h}

// ═══ TABS, SAVE/LOAD, UTILS ═══
function switchTab(tab){document.querySelectorAll('.tab').forEach(function(t){t.classList.toggle('active',t.dataset.tab===tab)});document.querySelectorAll('.panel').forEach(function(p){p.classList.toggle('active',p.id==='panel-'+tab)});if(tab==='output')renderOutput();if(tab==='rules')renderRules()}
function newVehicle(){S={name:'Untitled Vehicle',size:6,loco:'wheeled',mods:{},weapons:[],currentMount:'pintle',saved:S.saved};document.getElementById('vName').value=S.name;document.getElementById('sizeSlider').value=6;renderAll()}
function saveVehicle(){var d={name:S.name,size:S.size,loco:S.loco,mods:JSON.parse(JSON.stringify(S.mods)),weapons:JSON.parse(JSON.stringify(S.weapons))};var i=S.saved.findIndex(function(s){return s.name===S.name});if(i>=0)S.saved[i]=d;else S.saved.push(d);localStorage.setItem('diceforge-cvf',JSON.stringify(S.saved));renderSaved()}
function loadVehicle(i){var d=S.saved[i];S.name=d.name;S.size=d.size;S.loco=d.loco;S.mods=JSON.parse(JSON.stringify(d.mods));S.weapons=JSON.parse(JSON.stringify(d.weapons));document.getElementById('vName').value=S.name;document.getElementById('sizeSlider').value=S.size;renderAll()}
function deleteSaved(i){S.saved.splice(i,1);localStorage.setItem('diceforge-cvf',JSON.stringify(S.saved));renderSaved()}
function renderSaved(){var list=document.getElementById('savedList');
  if(!S.saved.length){list.innerHTML='<div class="empty-state"><p>No saved builds yet.</p></div>';return}
  list.innerHTML=S.saved.map(function(s,i){var loco=LOCOS.find(function(l){return l.id===s.loco});
    return '<div class="saved-item" onclick="loadVehicle('+i+')"><span class="si-name">'+s.name+'</span><span class="si-chassis">Size '+s.size+' '+loco.name+'</span><button class="si-delete" onclick="event.stopPropagation();deleteSaved('+i+')">&times;</button></div>'}).join('')}
function fmtN(n){return n.toLocaleString()}
function fmtC(n){if(n>=1e9)return(n/1e9).toFixed(2)+'B';if(n>=1e6)return(n/1e6).toFixed(n%1e6===0?0:2)+'M';if(n>=1e3)return(n/1e3).toFixed(n%1e3===0?0:1)+'K';return n.toString()}
function renderAll(){renderFrameInfo();renderLocoGrid();renderEraFilter();renderModCatalogue();renderModBay();renderWeaponCatalogue();renderWeaponBay();renderStats();renderOutput();renderSaved()}

// ═══ NAV BAR ═══
(function(){var tools=[{id:'foundry',label:'🏭 The Foundry',url:'foundry'},{id:'adventure-vault',label:'🎭 Adventure Vault',url:'adventure-vault'},{id:'character-vault',label:'👤 Character Vault',url:'character-vault'},{id:'cvf',label:'⚙ Combat Vehicle Forge',url:'combat-vehicle-forge'},{id:'pa-forge',label:'🛡 Power Armour Forge',url:'pa-forge'}];
  var nav=document.createElement('div');nav.className='tool-nav';
  tools.forEach(function(t){var btn=document.createElement('button');btn.className='tool-nav-item'+(t.id==='cvf'?' active':'');btn.textContent=t.label;btn.onclick=function(){if(t.id!=='cvf')window.location.href=t.url};nav.appendChild(btn)});
  document.getElementById('toolNavContainer').appendChild(nav)})();

// ═══ BOOT ═══
(function(){function unlock(){Audio.init();if(Audio.ctx.state==='suspended')Audio.ctx.resume();var buf=Audio.ctx.createBuffer(1,1,Audio.ctx.sampleRate);var src=Audio.ctx.createBufferSource();src.buffer=buf;src.connect(Audio.ctx.destination);src.start(0);['touchstart','touchend','mousedown','click'].forEach(function(e){document.removeEventListener(e,unlock,true)})}
  ['touchstart','touchend','mousedown','click'].forEach(function(e){document.addEventListener(e,unlock,true)})})();
try{var sd=localStorage.getItem('diceforge-cvf');if(sd)S.saved=JSON.parse(sd)}catch(e){}
document.getElementById('vName').addEventListener('input',function(e){S.name=e.target.value||'Untitled Vehicle'});
renderAll();
</script>
</body>
</html>
