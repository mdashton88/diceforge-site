<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Vault - DiceForge Studios</title>
  <link rel="stylesheet" href="tribute-lands.css">
  <script src="tool-navigation.js"></script>
  <style>
    /* Task Vault specific styles only */
    .task-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .task-card:hover {
      background: var(--card-hover-bg);
      border-color: var(--accent-secondary);
    }

    .task-card.completed {
      opacity: 0.6;
      border-left: 3px solid var(--success-color);
    }

    .task-card.priority-critical {
      border-left: 3px solid var(--danger-color);
    }

    .task-card.priority-high {
      border-left: 3px solid var(--warning-color);
    }

    .task-card.priority-normal {
      border-left: 3px solid var(--accent-secondary);
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 8px;
    }

    .task-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      flex: 1;
      cursor: pointer;
    }

    .task-title.completed {
      text-decoration: line-through;
      color: var(--text-dim);
    }

    .task-meta {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 12px;
      color: var(--text-dim);
      flex-wrap: wrap;
    }

    .task-badge {
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 500;
      white-space: nowrap;
    }

    .badge-priority {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      color: var(--text-dim);
    }

    .badge-priority.critical {
      background: var(--danger-color);
      color: white;
      border: none;
    }

    .badge-priority.high {
      background: var(--warning-color);
      color: var(--bg-primary);
      border: none;
    }

    .task-description {
      font-size: 14px;
      color: var(--text-secondary);
      margin-top: 8px;
      line-height: 1.6;
    }

    .task-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }

    .task-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--accent-primary);
    }

    /* Header stats styling to match Character Vault */
    .header-stats {
      display: flex;
      gap: 16px;
      font-size: 13px;
      color: var(--text-dim);
      padding: 8px 0;
    }

    .header-stats > span:hover {
      color: var(--accent-primary);
    }

    .header-stats .stat-num {
      color: var(--accent-primary);
      font-weight: 600;
    }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-dim);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Modal styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .modal-body {
      padding: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 10px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    /* Sync status indicators */
    .sync-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 4px;
    }

    .sync-idle { background: var(--success-color); }
    .sync-saving { background: var(--warning-color); animation: pulse 1s infinite; }
    .sync-error { background: var(--danger-color); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header>
      <div>
        <h1>TRIBUTE LANDS â€” TASK VAULT</h1>
        <div class="subtitle">DiceForge Studios Production System</div>
      </div>
      <div id="headerButtons" style="display:flex;align-items:center;gap:8px;">
        <button class="btn btn-primary" onclick="openTaskModal()">+ New Task</button>
        <button class="btn" onclick="exportTasks()">ğŸ“‹ Export</button>
        <button class="btn" onclick="showHelp()">â“ Help</button>
      </div>
      <div style="display:flex;gap:8px;margin-right:20px;">
        <button class="btn sm" onclick="window.location.href='foundry'" title="Production Dashboard">ğŸ­ Foundry</button>
        <button class="btn sm" onclick="window.location.href='character-vault'" title="Character Database">ğŸ‘¤ Characters</button>
        <button class="btn sm" onclick="window.location.href='adventure-vault'" title="Adventure Vault">ğŸ­ Adventures</button>
      </div>
      <div class="header-stats" id="headerStats"></div>
      <div id="syncIndicator" style="text-align:right;padding:2px 10px;display:flex;align-items:center;justify-content:flex-end;gap:8px">
        <span id="syncLabel" style="font-size:11px;font-family:monospace;color:var(--text-dim)">â—</span>
        <button onclick="forceRefresh()" style="font-size:10px;padding:1px 6px;background:none;border:1px solid var(--border);color:var(--text-dim);border-radius:3px;cursor:pointer" title="Reload from remote">â†» Refresh</button>
        <button onclick="promptForToken()" id="tokenBtn" style="font-size:10px;padding:1px 6px;background:none;border:1px solid var(--border);color:var(--text-dim);border-radius:3px;cursor:pointer" title="Set GitHub token">ğŸ”‘ Token</button>
      </div>
    </header>

    <div id="breadcrumb">
      <span class="bc-current">Task Vault</span>
    </div>

    <!-- Main Content -->
    <div class="container">
      <div class="sidebar" id="taskSidebar">
        <div class="sidebar-controls">
          <input type="text" id="searchInput" placeholder="Search tasks..." oninput="applyFilters()">
          <div class="filter-row">
            <select id="filterPriority" onchange="applyFilters()">
              <option value="all">All Priorities</option>
              <option value="critical">ğŸ”´ Critical</option>
              <option value="high">ğŸŸ¡ High</option>
              <option value="normal">âšª Normal</option>
            </select>
          </div>
        </div>
        
        <div class="sidebar-footer">
          <button class="btn primary" style="flex: 1;" onclick="openTaskModal()">+ New Task</button>
          <button class="btn sm" onclick="exportTasks()">ğŸ“‹ Export</button>
          <button class="btn sm" onclick="showHelp()">â“ Help</button>
        </div>
      </div>
      
      <div class="main" id="mainContent">
        <!-- Task List -->
        <div id="taskList"></div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
          <div class="empty-state-icon">ğŸ“‹</div>
          <h3>No tasks found</h3>
          <p>Create your first task to get started!</p>
        </div>
      </div>
    </div>

  <!-- Task Modal -->
  <div class="modal-overlay" id="taskModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">New Task</h2>
        <button class="btn btn-text" onclick="closeTaskModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <form id="taskForm" onsubmit="saveTask(event)">
          <input type="hidden" id="taskId">
          
          <div class="form-group">
            <label class="form-label">Title *</label>
            <input type="text" class="form-input" id="taskTitle" required>
          </div>

          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-textarea" id="taskDescription"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Priority *</label>
            <select class="form-select" id="taskPriority" required>
              <option value="normal">âšª Normal</option>
              <option value="high">ğŸŸ¡ High</option>
              <option value="critical">ğŸ”´ Critical</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea class="form-textarea" id="taskNotes" style="min-height: 60px;"></textarea>
          </div>

          <div class="task-actions" style="border: none; padding: 0; margin-top: 24px;">
            <button type="submit" class="btn btn-primary">Save Task</button>
            <button type="button" class="btn" onclick="closeTaskModal()">Cancel</button>
            <button type="button" class="btn btn-danger" id="deleteTaskBtn" 
                    onclick="deleteTask()" style="margin-left: auto; display: none;">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // Gist configuration (shared Gist with Character Vault)
    const GIST_ID = '7fa2d50c458ed95c21a3c6d283f863d6';
    const GIST_TOKEN = localStorage.getItem('diceforge_gist_token') || '';
    const GIST_FILENAME = 'diceforge-tasks.json';
    const CACHE_KEY = 'diceforge_tasks_cache';

    // Task data store
    let allTasks = [];
    let filteredTasks = [];
    let editingTaskId = null;
    let syncStatus = 'idle';
    let saveTimer = null;

    // Sync status management
    function setSyncStatus(status, label) {
      syncStatus = status;
      const indicator = document.getElementById('syncLabel');
      const classes = { idle: 'sync-idle', saving: 'sync-saving', error: 'sync-error' };
      indicator.className = `sync-indicator ${classes[status] || 'sync-idle'}`;
      indicator.textContent = label || 'â—';
      
      // Show/hide token button
      document.getElementById('tokenBtn').style.display = GIST_TOKEN ? 'none' : 'inline-block';
    }

    // Load tasks from Gist (with localStorage cache fallback)
    async function loadTasks() {
      // Try cache first for instant load
      const cached = localStorage.getItem(CACHE_KEY);
      if (cached) {
        try {
          const data = JSON.parse(cached);
          allTasks = data.tasks || [];
          applyFilters();
          updateStats();
        } catch (e) {
          console.error('Cache parse error:', e);
        }
      }

      // Then fetch from Gist if we have credentials
      if (GIST_ID && GIST_TOKEN) {
        try {
          setSyncStatus('saving', 'Loading...');
          const resp = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
            headers: {
              'Authorization': `token ${GIST_TOKEN}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });

          if (!resp.ok) throw new Error(`GitHub ${resp.status}`);

          const gist = await resp.json();
          const raw = gist.files[GIST_FILENAME]?.content;
          
          if (raw) {
            const data = JSON.parse(raw);
            allTasks = data.tasks || [];
            localStorage.setItem(CACHE_KEY, raw);
            console.log('âœ… Loaded from Gist:', allTasks.length, 'tasks');
          }
          
          setSyncStatus('idle', `${allTasks.length} tasks`);
        } catch (err) {
          console.error('âŒ Gist load failed:', err);
          setSyncStatus('error', 'Load failed');
          // Fall back to cache
          if (!cached) allTasks = loadFromLocalBackup();
        }
      } else {
        // No Gist credentials - use local backup
        if (!cached) allTasks = loadFromLocalBackup();
        setSyncStatus('idle', 'Offline mode');
      }

      applyFilters();
      updateStats();
    }

    // Load from local backup (fallback when no Gist)
    function loadFromLocalBackup() {
      const backup = localStorage.getItem('tasks_local_backup');
      if (backup) {
        try {
          const data = JSON.parse(backup);
          return data.tasks || [];
        } catch (e) {
          return [];
        }
      }
      return [];
    }

    // Save tasks to Gist
    async function pushToGist() {
      console.log('â˜ï¸ pushToGist firing...');
      
      // Always save local backup
      const data = {
        version: '1.0',
        lastModified: new Date().toISOString(),
        lastModifiedBy: 'task-vault',
        taskCount: allTasks.length,
        tasks: allTasks
      };
      localStorage.setItem('tasks_local_backup', JSON.stringify(data));

      if (!GIST_ID || !GIST_TOKEN) {
        console.log('No Gist credentials - saved locally only');
        return;
      }

      setSyncStatus('saving', 'Saving...');
      
      try {
        const raw = JSON.stringify(data, null, 2);
        const resp = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `token ${GIST_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            files: {
              [GIST_FILENAME]: { content: raw }
            }
          })
        });

        if (!resp.ok) throw new Error(`GitHub ${resp.status}: ${resp.statusText}`);

        // Update cache
        localStorage.setItem(CACHE_KEY, raw);
        console.log('âœ… Gist save success:', allTasks.length, 'tasks');
        setSyncStatus('idle', `Saved â€” ${allTasks.length} tasks`);
      } catch (err) {
        console.error('âŒ Gist save FAILED:', err);
        setSyncStatus('error', 'Save failed â€” will retry');
        // Retry once after 5 seconds
        setTimeout(() => {
          if (syncStatus === 'error') pushToGist();
        }, 5000);
      }
    }

    // Queue save (debounced)
    function queueSave() {
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        pushToGist();
        saveTimer = null;
      }, 2000);
    }

    // Force refresh from Gist
    async function forceRefresh() {
      localStorage.removeItem(CACHE_KEY);
      await loadTasks();
    }

    // Prompt for GitHub token
    function promptForToken() {
      const token = prompt('Enter your GitHub Personal Access Token (with Gist permissions):');
      if (token) {
        localStorage.setItem('diceforge_gist_token', token);
        location.reload();
      }
    }

    // Apply filters (always exclude completed tasks)
    function applyFilters() {
      const priorityFilter = document.getElementById('filterPriority').value;
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();

      filteredTasks = allTasks.filter(task => {
        // Always exclude completed tasks
        if (task.completed) return false;
        if (priorityFilter !== 'all' && task.priority !== priorityFilter) return false;
        if (searchTerm) {
          const title = (task.title || '').toLowerCase();
          const desc = (task.description || '').toLowerCase();
          if (!title.includes(searchTerm) && !desc.includes(searchTerm)) return false;
        }
        return true;
      });

      renderTasks();
    }

    // Render tasks
    function renderTasks() {
      const taskList = document.getElementById('taskList');
      const emptyState = document.getElementById('emptyState');

      if (filteredTasks.length === 0) {
        taskList.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      
      // Sort: incomplete first, then by priority
      const sortedTasks = [...filteredTasks].sort((a, b) => {
        if (a.completed !== b.completed) return a.completed ? 1 : -1;
        const priorityOrder = { critical: 0, high: 1, normal: 2 };
        return priorityOrder[a.priority] - priorityOrder[b.priority];
      });

      taskList.innerHTML = sortedTasks.map(task => `
        <div class="task-card ${task.completed ? 'completed' : ''} priority-${task.priority}">
          <div class="task-header">
            <div style="display: flex; align-items: start; gap: 12px; flex: 1;">
              <input type="checkbox" class="task-checkbox" 
                     ${task.completed ? 'checked' : ''}
                     onchange="toggleComplete('${task.id}')">
              <div style="flex: 1;">
                <div class="task-title ${task.completed ? 'completed' : ''}" 
                     onclick="editTask('${task.id}')">
                  ${task.title}
                </div>
                <div class="task-meta">
                  <span class="task-badge badge-priority ${task.priority}">
                    ${task.priority === 'critical' ? 'ğŸ”´' : task.priority === 'high' ? 'ğŸŸ¡' : 'âšª'} 
                    ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                  </span>
                  ${task.created ? `<span>Created: ${new Date(task.created).toLocaleDateString()}</span>` : ''}
                </div>
              </div>
            </div>
          </div>
          ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
          ${task.notes ? `<div class="task-description" style="font-style: italic; font-size: 13px;">ğŸ’¡ ${task.notes}</div>` : ''}
        </div>
      `).join('');
    }

    // Update statistics
    function updateStats() {
      const total = allTasks.length;
      const completed = allTasks.filter(t => t.completed).length;
      const active = total - completed;
      const critical = allTasks.filter(t => !t.completed && t.priority === 'critical').length;
      const high = allTasks.filter(t => !t.completed && t.priority === 'high').length;

      document.getElementById('headerStats').innerHTML = `
        <span><span class="stat-num">${total}</span> Total</span>
        <span><span class="stat-num">${active}</span> Active</span>
        <span><span class="stat-num">${completed}</span> Completed</span>
        <span><span class="stat-num">${critical}</span> ğŸ”´ Critical</span>
        <span><span class="stat-num">${high}</span> ğŸŸ¡ High</span>
      `;
    }

    // Toggle task completion
    // Toggle complete - delete completed tasks immediately
    function toggleComplete(id) {
      if (!confirm('Delete this task?')) return;
      
      allTasks = allTasks.filter(t => t.id !== id);
      queueSave();
      applyFilters();
      updateStats();
    }

    // Open task modal
    function openTaskModal(id = null) {
      editingTaskId = id;
      const modal = document.getElementById('taskModal');
      const deleteBtn = document.getElementById('deleteTaskBtn');
      
      if (id) {
        const task = allTasks.find(t => t.id === id);
        document.getElementById('modalTitle').textContent = 'Edit Task';
        document.getElementById('taskId').value = task.id;
        document.getElementById('taskTitle').value = task.title;
        document.getElementById('taskDescription').value = task.description || '';
        document.getElementById('taskPriority').value = task.priority;
        document.getElementById('taskNotes').value = task.notes || '';
        deleteBtn.style.display = 'block';
      } else {
        document.getElementById('modalTitle').textContent = 'New Task';
        document.getElementById('taskForm').reset();
        document.getElementById('taskId').value = '';
        deleteBtn.style.display = 'none';
      }
      
      modal.classList.add('active');
    }

    // Close task modal
    function closeTaskModal() {
      document.getElementById('taskModal').classList.remove('active');
      editingTaskId = null;
    }

    // Edit task
    function editTask(id) {
      openTaskModal(id);
    }

    // Save task
    function saveTask(event) {
      event.preventDefault();
      
      const id = document.getElementById('taskId').value;
      const taskData = {
        id: id || `task_${Date.now()}`,
        title: document.getElementById('taskTitle').value,
        description: document.getElementById('taskDescription').value,
        priority: document.getElementById('taskPriority').value,
        notes: document.getElementById('taskNotes').value,
        completed: false,
        created: new Date().toISOString()
      };

      if (id) {
        // Update existing task
        const index = allTasks.findIndex(t => t.id === id);
        if (index !== -1) {
          // Preserve completion status and dates
          taskData.completed = allTasks[index].completed;
          taskData.completedDate = allTasks[index].completedDate;
          taskData.created = allTasks[index].created;
          allTasks[index] = taskData;
        }
      } else {
        // Add new task
        allTasks.unshift(taskData);
      }

      queueSave();
      closeTaskModal();
      applyFilters();
      updateStats();
    }

    // Delete task
    function deleteTask() {
      if (!confirm('Are you sure you want to delete this task?')) return;
      
      const id = document.getElementById('taskId').value;
      allTasks = allTasks.filter(t => t.id !== id);
      
      queueSave();
      closeTaskModal();
      applyFilters();
      updateStats();
    }

    // Export tasks as markdown
    function exportTasks() {
      const byPriority = {
        critical: allTasks.filter(t => t.priority === 'critical'),
        high: allTasks.filter(t => t.priority === 'high'),
        normal: allTasks.filter(t => t.priority === 'normal')
      };

      let markdown = '# Task Vault Export\n';
      markdown += `Generated: ${new Date().toLocaleString()}\n\n`;
      markdown += `**Total Tasks:** ${allTasks.length}\n`;
      markdown += `**Completed:** ${allTasks.filter(t => t.completed).length}\n`;
      markdown += `**Active:** ${allTasks.filter(t => !t.completed).length}\n\n`;
      markdown += '---\n\n';

      ['critical', 'high', 'normal'].forEach(priority => {
        const tasks = byPriority[priority];
        if (tasks.length === 0) return;

        const icon = priority === 'critical' ? 'ğŸ”´' : priority === 'high' ? 'ğŸŸ¡' : 'âšª';
        markdown += `## ${icon} ${priority.charAt(0).toUpperCase() + priority.slice(1)} Priority\n\n`;
        
        tasks.forEach(task => {
          const checkbox = task.completed ? '[x]' : '[ ]';
          markdown += `- ${checkbox} **${task.title}**\n`;
          if (task.description) {
            markdown += `  ${task.description}\n`;
          }
          if (task.notes) {
            markdown += `  ğŸ’¡ _${task.notes}_\n`;
          }
          markdown += '\n';
        });
      });

      const blob = new Blob([markdown], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'tasks.md';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Show help
    function showHelp() {
      alert('Task Vault Help\n\n' +
            'â€¢ Click "+ New Task" to create a task\n' +
            'â€¢ Click on task titles to edit\n' +
            'â€¢ Use checkboxes to mark complete\n' +
            'â€¢ Filter by priority or search\n' +
            'â€¢ Export creates markdown checklist\n' +
            'â€¢ Tasks sync to GitHub Gist (cloud storage)\n' +
            'â€¢ Click ğŸ”‘ Token to set GitHub credentials\n' +
            'â€¢ Data persists across devices');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      addToolNavigation('task-vault');
      loadTasks();
      setSyncStatus('idle');
    });

    // Close modal on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeTaskModal();
      }
    });

    // Close modal on background click
    document.getElementById('taskModal').addEventListener('click', (e) => {
      if (e.target.id === 'taskModal') {
        closeTaskModal();
      }
    });
  </script>
</body>
</html>
