<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Savage Worlds Character Builder — Free Online Tool | Character Forge by DiceForge Studios</title>
<meta name="description" content="Free Savage Worlds character builder. Step-by-step creation with live validation, budget tracking, powers, gear, and export to Fantasy Grounds, PDF, and HTML. No login required.">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:#0A0908; color:#D4C9B8; font-family:'Crimson Pro','Georgia',serif; font-size:15px; line-height:1.5; }
  ::-webkit-scrollbar { width:6px; }
  ::-webkit-scrollbar-track { background:#0A0908; }
  ::-webkit-scrollbar-thumb { background:#2A2520; border-radius:3px; }
  ::selection { background:#C4A44A; color:#0A0908; }

/* ── SITE NAV ── */
.site-nav {
  position: fixed; top: 0; left: 0; right: 0; z-index: 9000;
  background: #0A0908E8; backdrop-filter: blur(12px);
  border-bottom: 1px solid #2A2520; padding: 0 40px;
  display: flex; align-items: center; justify-content: space-between; height: 64px;
}
.site-nav .nav-brand {
  font-family: 'Cinzel', serif; font-weight: 700; font-size: 16px;
  color: #C4A44A; letter-spacing: 3px; text-transform: uppercase;
  text-decoration: none; display: flex; align-items: center; gap: 10px;
}
.site-nav .nav-brand .anvil { font-size: 22px; color: #D4B45A; }
.site-nav .nav-links {
  display: flex; gap: 32px; list-style: none; margin: 0; padding: 0;
}
.site-nav .nav-links a {
  font-family: 'Cinzel', serif; font-size: 12px; font-weight: 600;
  letter-spacing: 2px; text-transform: uppercase; color: #8A8070;
  text-decoration: none; transition: color 0.3s; position: relative;
}
.site-nav .nav-links a:hover, .site-nav .nav-links a.active { color: #C4A44A; }
.site-nav .nav-links a::after {
  content: ''; position: absolute; bottom: -4px; left: 0; right: 0;
  height: 1px; background: #C4A44A; transform: scaleX(0); transition: transform 0.3s;
}
.site-nav .nav-links a:hover::after, .site-nav .nav-links a.active::after { transform: scaleX(1); }
.site-nav .hamburger {
  display: none; flex-direction: column; gap: 5px; cursor: pointer;
  padding: 8px; background: none; border: none; z-index: 9001;
}
.site-nav .hamburger span { display: block; width: 24px; height: 2px; background: #C4A44A; transition: all 0.3s; }
.site-nav .hamburger.open span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
.site-nav .hamburger.open span:nth-child(2) { opacity: 0; }
.site-nav .hamburger.open span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }
@media (max-width: 768px) {
  .site-nav { padding: 0 20px; }
  .site-nav .hamburger { display: flex; }
  .site-nav .nav-links {
    position: fixed; top: 64px; left: 0; right: 0; background: #0A0908F5;
    backdrop-filter: blur(16px); flex-direction: column; padding: 32px 40px;
    gap: 24px; border-bottom: 1px solid #2A2520;
    transform: translateY(-100%); opacity: 0; pointer-events: none; transition: all 0.3s;
  }
  .site-nav .nav-links.open { transform: translateY(0); opacity: 1; pointer-events: all; }
  .site-nav .nav-links a { font-size: 14px; letter-spacing: 3px; }
}

</style>
</head>
<body>
<nav class="site-nav">
  <a href="/" class="nav-brand"><span class="anvil">⚒</span> DiceForge Studios</a>
  <button class="hamburger" onclick="this.classList.toggle('open');document.getElementById('bldrNav').classList.toggle('open')" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>
  <ul class="nav-links" id="bldrNav">
    <li><a href="/">Home</a></li>
    <li><a href="/builder" class="active">Character Builder</a></li>
    <li><a href="/#page-arrath">World of Arr'ath</a></li>
    <li><a href="/#page-about">About</a></li>
  </ul>
</nav>
<div id="root" style="padding-top:64px"></div>

<!-- ═══ MODULE REGISTRY — must load before data modules ═══ -->
<script>
window.CharacterForge = (function(){
  var modules = [];
  return {
    data: {},
    modules: modules,
    registerModule: function(mod) {
      modules.push(mod);
      if (mod.alwaysOn) {
        ['edges','hindrances','skills','ancestries','powers','gear','skillLinks','coreSkills','arcaneBGs'].forEach(function(k){
          if (mod[k]) {
            if (Array.isArray(mod[k])) { if (!this.data[k]) this.data[k] = []; this.data[k] = this.data[k].concat(mod[k]); }
            else if (typeof mod[k] === 'object') { if (!this.data[k]) this.data[k] = {}; Object.assign(this.data[k], mod[k]); }
          }
        }.bind(this));
      }
    },
    getModules: function() { return modules; },
    getModule: function(id) { return modules.find(function(m){ return m.id === id; }); }
  };
})();
</script>

<!-- ═══ DATA MODULES — add more script tags here for supplements ═══ -->
<script src="swade-rules.js"></script>
<script src="swade-core.js"></script>
<script src="ammaria.js"></script>

<!-- ═══ ENGINE ═══ -->
<script type="text/babel">
const { useState, useMemo, useEffect } = React;

// ── Theme ──
const C = {
  bg:'#0A0908', bgCard:'#141210',
  border:'#2A2520', borderLight:'#3A3530',
  gold:'#C4A44A', goldDim:'#8A7A3A', goldBright:'#D4B45A',
  text:'#D4C9B8', textDim:'#8A8070', textBright:'#EAE0D0',
  red:'#8A3030', redBright:'#B04040',
  green:'#3A6A3A', greenBright:'#50A050',
  blue:'#4A7A9A',
};
const DICE = [4,6,8,10,12];
const dieCost = function(f,t) { var fi=f>12?4+(f-12):DICE.indexOf(f), ti=t>12?4+(t-12):DICE.indexOf(t); return ti-fi; };
const dieLabel = function(v) { return v>12?'d12+'+(v-12):'d'+v; };
const STEPS = ['Concept','Ancestry','Attributes','Skills','Hindrances & Edges','Powers','Gear','Summary','Export'];
const RANK_LABELS = {N:'Novice',S:'Seasoned',V:'Veteran',H:'Heroic'};
const START_FUNDS_BASE = 500;

// ══════════════════════════════════════════════════════════════
// MODULE DATA MERGER — reads from all active modules
// ══════════════════════════════════════════════════════════════
function mergeModuleData(activeModuleIds) {
  var mods = window.CharacterForge.modules.filter(function(m) {
    return m.alwaysOn || activeModuleIds.indexOf(m.id) >= 0;
  });
  var skillLinks = {};
  var coreSkills = [];
  var ancestries = {};
  var edges = [];
  var hindrances = [];
  var arcaneBGs = [];
  var powers = [];
  var gear = { melee:[], ranged:[], armor:[], shields:[], general:[] };

  mods.forEach(function(m) {
    if (m.skillLinks) Object.assign(skillLinks, m.skillLinks);
    if (m.coreSkills) m.coreSkills.forEach(function(s) { if (coreSkills.indexOf(s)<0) coreSkills.push(s); });
    if (m.ancestries) Object.entries(m.ancestries).forEach(function(p) {
      ancestries[p[0]] = p[1];
    });
    if (m.edges) m.edges.forEach(function(e) { edges.push(Object.assign({}, e, {source:m.id, sourceName:m.name, sourceColour:m.colour})); });
    if (m.hindrances) m.hindrances.forEach(function(h) { hindrances.push(Object.assign({}, h, {source:m.id, sourceName:m.name, sourceColour:m.colour})); });
    if (m.arcaneBGs) arcaneBGs = arcaneBGs.concat(m.arcaneBGs);
    if (m.powers) m.powers.forEach(function(p) { if (!powers.some(function(x){return x.name===p.name})) powers.push(p); });
    if (m.gear) {
      ['melee','ranged','armor','shields','general'].forEach(function(cat) {
        if (m.gear[cat]) gear[cat] = gear[cat].concat(m.gear[cat].map(function(g) {
          return Object.assign({}, g, {source:m.id});
        }));
      });
    }
  });

  return { skillLinks, coreSkills, ancestries, edges, hindrances, arcaneBGs, powers, gear };
}

// ══════════════════════════════════════════════════════════════
// MAIN COMPONENT
// ══════════════════════════════════════════════════════════════
function CharacterForgeApp() {
  const allModules = window.CharacterForge.modules;
  const toggleableModules = allModules.filter(function(m) { return !m.alwaysOn; });

  const [step, setStep] = useState(0);
  const [activeSupplements, setActiveSupplements] = useState([]);
  const [edgeCatFilter, setEdgeCatFilter] = useState('All');
  const [charName, setCharName] = useState('');
  const [charConcept, setCharConcept] = useState('');
  const [ancestry, setAncestry] = useState(null);
  const [attrs, setAttrs] = useState({agility:4,smarts:4,spirit:4,strength:4,vigor:4});
  const [skills, setSkills] = useState({});
  const [selectedHindrances, setSelectedHindrances] = useState([]);
  const [hindranceSeverities, setHindranceSeverities] = useState({});
  const [selectedEdges, setSelectedEdges] = useState([]);
  const [hindAlloc, setHindAlloc] = useState({edges:0,attrs:0,skills:0,funds:0});
  const [arcaneBg, setArcaneBg] = useState(null);
  const [selectedPowers, setSelectedPowers] = useState([]);
  const [gear, setGear] = useState([]);
  const [gearTab, setGearTab] = useState('melee');
  const [portrait, setPortrait] = useState(null);

  // ── Merged data from active modules ──
  const data = useMemo(function() {
    return mergeModuleData(activeSupplements);
  }, [activeSupplements]);

  function toggleSupplement(id) {
    setActiveSupplements(function(prev) {
      return prev.indexOf(id) >= 0 ? prev.filter(function(x){return x!==id}) : prev.concat([id]);
    });
  }

  // ── Derived from selections ──
  var hasAB = selectedEdges.includes('Arcane Background');
  var abData = arcaneBg ? data.arcaneBGs.find(function(a){return a.name===arcaneBg}) : null;
  var newPowersCount = selectedEdges.filter(function(e){return e==='New Powers'}).length;
  var ppEdgeCount = selectedEdges.filter(function(e){return e==='Power Points'}).length;
  var maxPowers = abData ? abData.startPowers + (newPowersCount * 2) : 0;
  var totalPP = abData ? abData.startPP + (ppEdgeCount * 5) : 0;

  // Apply ancestry starting attributes
  useEffect(function() {
    if (ancestry && data.ancestries[ancestry] && data.ancestries[ancestry].startAttrs) {
      setAttrs(function(prev) {
        var next = Object.assign({}, prev);
        Object.entries(data.ancestries[ancestry].startAttrs).forEach(function(p){next[p[0]]=Math.max(next[p[0]],p[1]);});
        return next;
      });
    }
  }, [ancestry]);

  useEffect(function() {
    if (!hasAB) { setArcaneBg(null); setSelectedPowers([]); }
  }, [hasAB]);

  // ── BUDGETS ──
  var attrPoints = useMemo(function() {
    var anc = ancestry && data.ancestries[ancestry] ? data.ancestries[ancestry] : {};
    var r = window.SWADERules.calcAttributeBudget(attrs, anc, hindAlloc.attrs);
    return {total:r.total, spent:r.spent, rem:r.remaining};
  }, [attrs,ancestry,hindAlloc.attrs,data]);

  var skillPoints = useMemo(function() {
    var r = window.SWADERules.calcSkillBudget(skills, attrs, data.skillLinks, data.coreSkills, hindAlloc.skills);
    return {total:r.total, spent:r.spent, rem:r.remaining};
  }, [skills,attrs,hindAlloc.skills,data]);

  var hindCalc = useMemo(function() {
    return window.SWADERules.calcHindrancePoints(selectedHindrances, hindranceSeverities);
  }, [selectedHindrances,hindranceSeverities]);
  var hindPtsRaw = hindCalc.raw;
  var hindPts = hindCalc.effective;

  useEffect(function() {
    var used=hindAlloc.edges*2+hindAlloc.attrs*2+hindAlloc.skills+hindAlloc.funds;
    if(used>hindPts) setHindAlloc({edges:0,attrs:0,skills:0,funds:0});
  }, [hindPts]);

  var edgeBudget = useMemo(function() {
    var anc = ancestry && data.ancestries[ancestry] ? data.ancestries[ancestry] : {};
    var r = window.SWADERules.calcEdgeBudget(selectedEdges.length, anc, hindAlloc.edges);
    return {total:r.total, spent:r.spent};
  }, [ancestry,hindAlloc.edges,selectedEdges,data]);

  var gearCost = useMemo(function(){var t=0;gear.forEach(function(g){t+=g.cost*(g.qty||1);});return t;}, [gear]);
  var gearWeight = useMemo(function(){var t=0;gear.forEach(function(g){t+=g.wt*(g.qty||1);});return t;}, [gear]);
  var startFunds = START_FUNDS_BASE + (hindAlloc.funds * START_FUNDS_BASE * 2);

  var derived = useMemo(function() {
    var anc = ancestry && data.ancestries[ancestry] ? data.ancestries[ancestry] : {pace:6,size:0,toughMod:0};
    var r = window.SWADERules.calcDerived(attrs, skills, anc, gear);
    var bennies = 3 + (anc.bonusBennies || 0) + (selectedEdges.includes('Luck') ? 1 : 0) + (selectedEdges.includes('Great Luck') ? 1 : 0);
    return {pace:r.pace, size:r.size, runDie:r.runDie, bennies:bennies, parry:r.parry, toughness:r.toughness, armor:r.armor};
  }, [attrs,skills,ancestry,gear,selectedEdges,data]);

  var edgeCats = useMemo(function(){return ['All'].concat(Array.from(new Set(data.edges.map(function(e){return e.cat;}))));}, [data]);

  // ── STYLES ──
  var card = {background:C.bgCard,border:'1px solid '+C.border,padding:'20px',marginBottom:'16px'};
  var cTitle = {fontFamily:"'Cinzel',serif",fontSize:'16px',fontWeight:700,color:C.goldBright,marginBottom:'12px',letterSpacing:'1px'};
  var lbl = {fontSize:'13px',color:C.goldDim,textTransform:'uppercase',letterSpacing:'1px',marginBottom:'6px',display:'block',fontFamily:"'Cinzel',serif"};

  function SourceTag(props) {
    if (!props.source || props.source === 'swade-core') return null;
    var mod = allModules.find(function(m){return m.id===props.source});
    var colour = mod ? mod.colour : C.gold;
    var name = mod ? mod.name.replace('Savage Worlds ','').replace(' Supplement','') : props.source;
    return <span style={{display:'inline-block',padding:'2px 8px',fontSize:'10px',fontWeight:700,letterSpacing:'1px',textTransform:'uppercase',color:C.bg,background:colour,marginLeft:'6px',fontFamily:"'Cinzel',serif"}}>{name}</span>;
  }

  function BudgetBar(props) {
    var over=props.spent>props.total,pct=props.total>0?(props.spent/props.total)*100:0,color=props.color||C.gold;
    return (<div style={{marginBottom:'12px'}}>
      <div style={{display:'flex',justifyContent:'space-between'}}>
        <span style={{fontSize:'13px',color:C.goldDim,textTransform:'uppercase',letterSpacing:'1px',fontFamily:"'Cinzel',serif"}}>{props.label}</span>
        <span style={{fontSize:'15px',color:over?C.redBright:C.text,fontWeight:600}}>{props.spent} / {props.total}</span>
      </div>
      <div style={{height:'6px',background:C.bg,borderRadius:'3px',marginTop:'6px'}}>
        <div style={{height:'100%',width:Math.min(100,pct)+'%',background:over?C.redBright:color,transition:'width .3s',borderRadius:'3px'}} />
      </div>
    </div>);
  }

  function addGear(item) {
    setGear(function(prev) {
      var existing = prev.find(function(g){return g.name===item.name;});
      if(existing) return prev.map(function(g){return g.name===item.name?Object.assign({},g,{qty:(g.qty||1)+1}):g;});
      return prev.concat([Object.assign({},item,{qty:1})]);
    });
  }
  function removeGear(name) {
    setGear(function(prev) {
      return prev.map(function(g){
        if(g.name!==name) return g;
        if((g.qty||1)<=1) return null;
        return Object.assign({},g,{qty:g.qty-1});
      }).filter(Boolean);
    });
  }

  // ═══════════════════════════════════════════════════════════
  // STEP 0: CONCEPT + MODULE TOGGLES
  // ═══════════════════════════════════════════════════════════
  function renderConcept() {
    return (<div>
      <div style={card}>
        <div style={cTitle}>Character Concept</div>
        <p style={{fontSize:'15px',color:C.textDim,lineHeight:'1.6',marginBottom:'16px'}}>Start with a name and a concept. A sentence that captures who this person is and what drives them.</p>
        <div style={{marginBottom:'16px'}}>
          <label style={lbl}>Name</label>
          <input style={{background:C.bg,border:'1px solid '+C.border,color:C.text,padding:'10px 14px',fontSize:'16px',fontFamily:"'Crimson Pro',serif",width:'100%',boxSizing:'border-box',outline:'none'}}
            value={charName} onChange={function(e){setCharName(e.target.value)}} placeholder="What do they call you?" />
        </div>
        <div>
          <label style={lbl}>Concept</label>
          <textarea style={{background:C.bg,border:'1px solid '+C.border,color:C.text,padding:'10px 14px',fontSize:'16px',fontFamily:"'Crimson Pro',serif",width:'100%',minHeight:'60px',boxSizing:'border-box',outline:'none',resize:'vertical'}}
            value={charConcept} onChange={function(e){setCharConcept(e.target.value)}} placeholder="Who are you, and what drives you?" />
        </div>
        <div style={{marginTop:'16px'}}>
          <label style={lbl}>Portrait</label>
          <div style={{display:'flex',alignItems:'center',gap:'16px'}}>
            <div style={{width:'100px',height:'120px',border:'1px solid '+C.border,background:C.bg,display:'flex',alignItems:'center',justifyContent:'center',overflow:'hidden',flexShrink:0}}>
              {portrait ? <img src={portrait} style={{width:'100%',height:'100%',objectFit:'cover'}} /> : <span style={{fontSize:'12px',color:C.textDim,textAlign:'center',padding:'8px'}}>No portrait</span>}
            </div>
            <div>
              <label style={{display:'inline-block',padding:'8px 16px',border:'1px solid '+C.border,background:'transparent',color:C.gold,fontSize:'13px',fontWeight:600,letterSpacing:'1px',textTransform:'uppercase',cursor:'pointer',fontFamily:"'Cinzel',serif"}}>
                Upload Image
                <input type="file" accept="image/*" style={{display:'none'}} onChange={function(e){
                  var file=e.target.files[0]; if(!file) return;
                  var reader=new FileReader();
                  reader.onload=function(ev){setPortrait(ev.target.result);};
                  reader.readAsDataURL(file);
                }} />
              </label>
              {portrait && <button onClick={function(){setPortrait(null)}} style={{marginLeft:'8px',padding:'8px 12px',border:'1px solid '+C.border,background:'transparent',color:C.redBright,fontSize:'12px',cursor:'pointer'}}>Remove</button>}
              <div style={{fontSize:'12px',color:C.textDim,marginTop:'6px'}}>JPG or PNG. Used in exports.</div>
            </div>
          </div>
        </div>
      </div>

      {toggleableModules.length > 0 && <div style={card}>
        <div style={cTitle}>Setting Modules</div>
        <p style={{fontSize:'14px',color:C.textDim,lineHeight:'1.6',marginBottom:'16px'}}>Enable supplements to add their character options. Core rules are always active.</p>
        {toggleableModules.map(function(mod) {
          var active = activeSupplements.indexOf(mod.id) >= 0;
          return (<div key={mod.id} style={{display:'flex',alignItems:'center',gap:'14px',marginBottom:'12px'}}>
            <div onClick={function(){toggleSupplement(mod.id)}} style={{width:'44px',height:'24px',borderRadius:'12px',cursor:'pointer',position:'relative',background:active?(mod.colour||C.gold):C.border,transition:'background .2s',flexShrink:0}}>
              <div style={{width:'20px',height:'20px',borderRadius:'10px',background:active?C.bg:C.textDim,position:'absolute',top:'2px',left:active?'22px':'2px',transition:'left .2s'}} />
            </div>
            <div>
              <div style={{fontSize:'15px',fontWeight:600,color:active?(mod.colour||C.gold):C.textDim}}>{active?'\u2694 '+mod.name+' Active':mod.name}</div>
              {mod.description && <div style={{fontSize:'13px',color:C.textDim,marginTop:'2px'}}>{mod.description}</div>}
            </div>
          </div>);
        })}
      </div>}

      <div style={Object.assign({},card,{background:'transparent',border:'1px solid '+C.border,padding:'14px 20px'})}>
        <div style={{fontSize:'13px',color:C.textDim,lineHeight:'1.6'}}>
          <strong style={{color:C.goldDim}}>Active content:</strong> {allModules.filter(function(m){return m.alwaysOn || activeSupplements.indexOf(m.id)>=0}).map(function(m){return m.name}).join(', ')}
          <span style={{marginLeft:'12px',color:C.textDim}}>({Object.keys(data.ancestries).length} ancestries, {data.edges.length} edges, {data.hindrances.length} hindrances, {data.powers.length} powers)</span>
        </div>
      </div>
    </div>);
  }

  // STEP 1: ANCESTRY
  function renderAncestry() {
    return (<div>
      <div style={Object.assign({},card,{paddingBottom:'10px'})}><div style={cTitle}>Choose Your Ancestry</div><p style={{fontSize:'14px',color:C.textDim,margin:0}}>Select one. Each ancestry provides unique abilities.</p></div>
      <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(260px,1fr))',gap:'8px'}}>
        {Object.entries(data.ancestries).map(function(pair) {
          var name=pair[0],a=pair[1],sel=ancestry===name;
          return (<div key={name} onClick={function(){setAncestry(name)}} style={Object.assign({},card,{marginBottom:0,cursor:'pointer',transition:'all .2s',borderColor:sel?C.gold:C.border,background:sel?C.gold+'10':C.bgCard})}>
            <div style={{display:'flex',justifyContent:'space-between',marginBottom:'8px'}}>
              <span style={{fontFamily:"'Cinzel',serif",fontSize:'16px',fontWeight:700,color:sel?C.gold:C.textBright}}>{name}</span>
              {sel && <span style={{color:C.gold}}>{'\u2713'}</span>}
            </div>
            <p style={{fontSize:'14px',color:C.textDim,lineHeight:'1.4',margin:'0 0 8px'}}>{a.summary}</p>
            <div style={{marginTop:'8px',fontSize:'12px',color:C.textDim}}>{'Pace '+a.pace+' | Size '+(a.size>=0?'+':'')+a.size+' | Tough mod '+(a.toughMod>=0?'+':'')+a.toughMod+(a.freeEdges>0?' | +'+a.freeEdges+' free Edge':'')+(a.attrBonus>0?' | +'+a.attrBonus+' attr pt':'')}</div>
          </div>);
        })}
      </div>
    </div>);
  }

  // STEP 2: ATTRIBUTES
  function renderAttributes() {
    var starts = (ancestry && data.ancestries[ancestry] && data.ancestries[ancestry].startAttrs) || {};
    return (<div style={card}>
      <div style={cTitle}>Attributes</div>
      <p style={{fontSize:'14px',color:C.textDim,lineHeight:'1.6',marginBottom:'16px'}}>All begin at d4. You have <strong style={{color:C.gold}}>{attrPoints.total} points</strong> to raise them. Each die step costs one point.</p>
      <BudgetBar label="Attribute Points" spent={attrPoints.spent} total={attrPoints.total} />
      <div style={{display:'flex',flexDirection:'column',gap:'12px',marginTop:'16px'}}>
        {['agility','smarts','spirit','strength','vigor'].map(function(a) {
          var minD=starts[a]||4;
          var maxD=starts[a]?13:12;
          var steps=DICE.concat(maxD>12?[13]:[]);
          return (<div key={a} style={{display:'flex',alignItems:'center',gap:'8px'}}>
            <span style={{fontSize:'15px',color:C.text,minWidth:'100px',textTransform:'capitalize'}}>{a}</span>
            <div style={{display:'flex',gap:'4px'}}>{steps.map(function(d){
              return <button key={d} disabled={d<minD||d>maxD} onClick={function(){setAttrs(function(p){var n=Object.assign({},p);n[a]=d;return n;})}} style={{width:'42px',height:'32px',border:'1px solid '+(d===attrs[a]?C.gold:C.border),background:d===attrs[a]?C.gold:'transparent',color:d===attrs[a]?C.bg:d<minD?C.border:C.textDim,fontSize:d>12?'11px':'13px',fontWeight:d===attrs[a]?700:400,cursor:d<minD||d>maxD?'default':'pointer',fontFamily:"'Crimson Pro',serif",opacity:d<minD?0.3:1}}>{dieLabel(d)}</button>;
            })}</div>
          </div>);
        })}
      </div>
    </div>);
  }

  // STEP 3: SKILLS
  function renderSkills() {
    var grouped={};
    Object.entries(data.skillLinks).forEach(function(p){if(!grouped[p[1]])grouped[p[1]]=[];grouped[p[1]].push(p[0]);});
    return (<div style={card}>
      <div style={cTitle}>Skills</div>
      <p style={{fontSize:'14px',color:C.textDim,lineHeight:'1.6',marginBottom:'12px'}}><strong style={{color:C.gold}}>{skillPoints.total} points</strong>. Core skills start at d4 free. Each step costs 1 up to linked attribute, 2 above.</p>
      <BudgetBar label="Skill Points" spent={skillPoints.spent} total={skillPoints.total} />
      {hasAB&&abData?<div style={{padding:'10px 14px',background:C.blue+'15',border:'1px solid '+C.blue+'40',marginBottom:'12px',fontSize:'14px',color:C.text,lineHeight:'1.5'}}>{'\u26A0'} Your Arcane Background ({abData.name}) requires <strong style={{color:C.blue}}>{abData.skill}</strong> (linked to {abData.linked.charAt(0).toUpperCase()+abData.linked.slice(1)}). Remember to purchase it here.</div>:null}
      <div style={{marginTop:'12px'}}>
        {['agility','smarts','spirit'].map(function(attr) {
          var list=(grouped[attr]||[]).sort();
          return (<div key={attr} style={{marginBottom:'16px'}}>
            <div style={{fontSize:'13px',color:C.goldDim,textTransform:'uppercase',letterSpacing:'1px',fontFamily:"'Cinzel',serif",borderBottom:'1px solid '+C.border,paddingBottom:'4px',marginBottom:'8px'}}>{attr.charAt(0).toUpperCase()+attr.slice(1)+' ('+dieLabel(attrs[attr])+')'}</div>
            {list.map(function(sk) {
              var isCore=data.coreSkills.includes(sk),cur=skills[sk]||(isCore?4:0),linked=attrs[attr];
              var minVal=isCore?4:0, maxVal=12;
              var canDown=cur>minVal, canUp=cur<maxVal;
              var stepBtn=function(label,enabled,fn){return <button onClick={enabled?fn:undefined} style={{width:'26px',height:'26px',border:'1px solid '+(enabled?C.border:C.border+'40'),background:'transparent',color:enabled?(label==='+'?C.greenBright:C.red):C.border+'40',fontSize:'15px',cursor:enabled?'pointer':'default',lineHeight:'24px',textAlign:'center',fontWeight:700,opacity:enabled?1:0.3}}>{label}</button>;};
              return (<div key={sk} style={{display:'flex',alignItems:'center',marginBottom:'3px'}}>
                <span style={{fontSize:'14px',color:cur>minVal?C.text:C.textDim,minWidth:'140px',flexShrink:0}}>{sk}{isCore?<span style={{fontSize:'11px',color:C.goldDim}}> (core)</span>:null}</span>
                <div style={{display:'flex',alignItems:'center',gap:'4px',minWidth:'110px',justifyContent:'center'}}>
                  {stepBtn('\u2212',canDown,function(){if(!isCore&&cur<=4)setSkills(function(p){var n=Object.assign({},p);delete n[sk];return n;});else setSkills(function(p){var n=Object.assign({},p);n[sk]=DICE[DICE.indexOf(cur)-1];return n;});})}
                  <span style={{width:'36px',textAlign:'center',fontSize:'14px',fontWeight:600,color:cur>0?C.text:C.textDim}}>{cur>0?dieLabel(cur):'\u2014'}</span>
                  {stepBtn('+',canUp,function(){if(cur===0)setSkills(function(p){var n=Object.assign({},p);n[sk]=4;return n;});else{var i=DICE.indexOf(cur);if(i<DICE.length-1)setSkills(function(p){var n=Object.assign({},p);n[sk]=DICE[i+1];return n;});}})}
                </div>
                <span style={{fontSize:'11px',color:C.red,marginLeft:'4px',width:'20px'}}>{cur>linked?'\u00d72':''}</span>
              </div>);
            })}
          </div>);
        })}
      </div>
    </div>);
  }

  // STEP 4: HINDRANCES & EDGES
  function renderHindrancesEdges() {
    return (<div>
      <div style={card}>
        <div style={cTitle}>Hindrances</div>
        <p style={{fontSize:'14px',color:C.textDim,lineHeight:'1.6',marginBottom:'12px'}}>Up to <strong style={{color:C.gold}}>4 points</strong>. Minor = 1, Major = 2.</p>
        <BudgetBar label="Hindrance Points" spent={hindPts} total={4} color={C.redBright} />
        <div style={{maxHeight:'300px',overflowY:'auto',marginTop:'8px'}}>
          {data.hindrances.map(function(h) {
            var sel=selectedHindrances.includes(h.name),isSupplement=h.source!=='swade-core',multi=h.sev.includes('/'),sev=hindranceSeverities[h.name]||(multi?'Minor':h.sev);
            return (<div key={h.name+h.source} onClick={function(){setSelectedHindrances(function(p){return p.includes(h.name)?p.filter(function(x){return x!==h.name}):[].concat(p,[h.name])});setHindranceSeverities(function(p){var n=Object.assign({},p);n[h.name]=multi?sev:h.sev;return n;});}} style={{padding:'8px 12px',marginBottom:'2px',cursor:'pointer',background:sel?C.redBright+'15':'transparent',borderLeft:sel?'3px solid '+C.redBright:'3px solid transparent'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                <div><span style={{fontSize:'15px',fontWeight:600,color:sel?C.textBright:C.text}}>{h.name}</span><SourceTag source={h.source} /></div>
                {multi&&sel?(<div style={{display:'flex',gap:'3px'}} onClick={function(e){e.stopPropagation()}}>
                  {['Minor','Major'].map(function(s){return <button key={s} onClick={function(){setHindranceSeverities(function(p){var n=Object.assign({},p);n[h.name]=s;return n;})}} style={{padding:'2px 6px',fontSize:'11px',border:'1px solid '+(sev===s?(s==='Major'?C.redBright:C.gold):C.border),background:sev===s?(s==='Major'?C.redBright:C.gold):'transparent',color:sev===s?C.bg:C.textDim,cursor:'pointer'}}>{s}</button>;})}
                </div>):(<span style={{fontSize:'12px',color:h.sev==='Major'?C.redBright:C.goldDim,fontWeight:600}}>{h.sev}</span>)}
              </div>
              {sel&&h.summary?<div style={{fontSize:'13px',color:C.textDim,marginTop:'4px',lineHeight:'1.5',fontStyle:'italic'}}>{h.summary}</div>:null}
              {sel&&!h.summary?<div style={{fontSize:'13px',color:C.textDim,marginTop:'4px',lineHeight:'1.5',fontStyle:'italic'}}>See Savage Worlds core rules for full description.</div>:null}
            </div>);
          })}
        </div>
      </div>

      {hindPts>0?(function(){
        var used=hindAlloc.edges*2+hindAlloc.attrs*2+hindAlloc.skills+hindAlloc.funds,remaining=hindPts-used;
        function adj(key,cost,delta){return function(e){e.stopPropagation();setHindAlloc(function(p){var n=Object.assign({},p),nv=n[key]+delta;if(nv<0)return p;var nu=(key==='edges'?nv:n.edges)*2+(key==='attrs'?nv:n.attrs)*2+(key==='skills'?nv:n.skills)+(key==='funds'?nv:n.funds);if(nu>hindPts)return p;n[key]=nv;return n;});};}
        var bs=function(a){return{width:'28px',height:'28px',border:'1px solid '+(a?C.gold:C.border),background:'transparent',color:a?C.gold:C.textDim,fontSize:'15px',cursor:a?'pointer':'default',opacity:a?1:0.3,lineHeight:'26px',textAlign:'center'};};
        return (<div style={card}>
          <div style={cTitle}>Spend Hindrance Points</div>
          <p style={{fontSize:'14px',color:C.textDim,lineHeight:'1.6',marginBottom:'8px'}}>You have <strong style={{color:C.gold}}>{hindPts} point{hindPts!==1?'s':''}</strong> to spend{hindPtsRaw>4?<span style={{color:C.goldDim}}> (benefit capped at 4)</span>:null}. Each Edge or attribute step costs 2. Each skill point or funds boost costs 1.</p>
          <div style={{display:'flex',justifyContent:'center',marginBottom:'16px'}}><span style={{fontSize:'15px',color:remaining>0?C.gold:remaining===0?C.greenBright:C.redBright,fontWeight:600}}>{remaining} remaining</span></div>
          {[['Edges','edges',2,hindAlloc.edges],['Attribute Steps','attrs',2,hindAlloc.attrs],['Skill Points','skills',1,hindAlloc.skills],['Starting Funds (+'+START_FUNDS_BASE*2+')','funds',1,hindAlloc.funds]].map(function(r){
            return (<div key={r[1]} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 0',borderBottom:'1px solid '+C.border}}>
              <div><span style={{fontSize:'15px',color:C.text}}>{r[0]}</span><span style={{fontSize:'12px',color:C.textDim,marginLeft:'8px'}}>({r[2]} pt{r[2]!==1?'s':''} each)</span></div>
              <div style={{display:'flex',alignItems:'center',gap:'8px'}}>
                <button onClick={adj(r[1],r[2],-1)} style={bs(r[3]>0)}>{'\u2212'}</button>
                <span style={{width:'24px',textAlign:'center',fontSize:'16px',fontWeight:700,color:r[3]>0?C.gold:C.textDim}}>{r[3]}</span>
                <button onClick={adj(r[1],r[2],1)} style={bs(remaining>=r[2])}>+</button>
              </div>
            </div>);
          })}
        </div>);
      })():null}

      <div style={card}>
        <div style={cTitle}>Edges</div>
        <p style={{fontSize:'14px',color:C.textDim,lineHeight:'1.6',marginBottom:'12px'}}><strong style={{color:C.gold}}>{edgeBudget.total} Edge{edgeBudget.total!==1?'s':''}</strong> available. All requirements must be met.</p>
        <BudgetBar label="Edges" spent={edgeBudget.spent} total={edgeBudget.total} color={C.greenBright} />
        <div style={{display:'flex',gap:'4px',marginBottom:'12px',flexWrap:'wrap'}}>
          {edgeCats.map(function(cat){return <button key={cat} onClick={function(){setEdgeCatFilter(cat)}} style={{padding:'4px 10px',fontSize:'11px',fontWeight:600,letterSpacing:'1px',textTransform:'uppercase',border:'1px solid '+(edgeCatFilter===cat?C.gold:C.border),background:edgeCatFilter===cat?C.gold:'transparent',color:edgeCatFilter===cat?C.bg:C.textDim,cursor:'pointer',fontFamily:"'Cinzel',serif"}}>{cat}</button>;})}
        </div>
        <div style={{maxHeight:'400px',overflowY:'auto'}}>
          {data.edges.filter(function(e){return edgeCatFilter==='All'||e.cat===edgeCatFilter}).map(function(e) {
            var sel=selectedEdges.includes(e.name),isSupplement=e.source!=='swade-core';
            return (<div key={e.name+e.source} onClick={function(){
              if (e.stackable) { setSelectedEdges(function(p){return [].concat(p,[e.name])}); }
              else { setSelectedEdges(function(p){return p.includes(e.name)?p.filter(function(x){return x!==e.name}):[].concat(p,[e.name])}); }
            }} style={{padding:'8px 12px',marginBottom:'2px',cursor:'pointer',background:sel?C.greenBright+'15':'transparent',borderLeft:sel?'3px solid '+C.greenBright:'3px solid transparent'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'baseline'}}>
                <div><span style={{fontSize:'15px',fontWeight:600,color:sel?C.textBright:C.text}}>{e.name}</span><SourceTag source={e.source} /><span style={{fontSize:'11px',color:C.textDim,marginLeft:'6px'}}>{e.cat}</span></div>
                <span style={{fontSize:'12px',color:C.goldDim}}>{RANK_LABELS[e.rank]||e.rank}</span>
              </div>
              <div style={{fontSize:'12px',color:C.textDim,marginTop:'2px'}}>{'Requires: '+e.reqs}</div>
              {sel&&e.summary?<div style={{fontSize:'12px',color:C.textDim,marginTop:'2px',fontStyle:'italic'}}>{e.summary}</div>:null}
            </div>);
          })}
        </div>
      </div>
    </div>);
  }

  // STEP 5: POWERS
  function renderPowers() {
    if (!hasAB) return (<div style={card}>
      <div style={cTitle}>Powers</div>
      <p style={{fontSize:'15px',color:C.textDim,lineHeight:'1.6'}}>You have not taken the Arcane Background Edge. Select it on the Hindrances & Edges step to unlock powers.</p>
    </div>);
    return (<div>
      <div style={card}>
        <div style={cTitle}>Arcane Background</div>
        <p style={{fontSize:'14px',color:C.textDim,lineHeight:'1.6',marginBottom:'16px'}}>Choose your tradition. This determines your arcane skill, starting powers, and Power Points.</p>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(200px,1fr))',gap:'8px'}}>
          {data.arcaneBGs.map(function(ab) {
            var sel=arcaneBg===ab.name;
            return (<div key={ab.name} onClick={function(){setArcaneBg(ab.name);setSelectedPowers([]);}} style={Object.assign({},card,{marginBottom:0,cursor:'pointer',borderColor:sel?C.gold:C.border,background:sel?C.gold+'10':C.bgCard})}>
              <div style={{fontFamily:"'Cinzel',serif",fontSize:'15px',fontWeight:700,color:sel?C.gold:C.textBright,marginBottom:'6px'}}>{ab.name}</div>
              <div style={{fontSize:'13px',color:C.text,lineHeight:'1.6'}}>
                <div>Skill: {ab.skill} ({ab.linked})</div>
                <div>Starting Powers: {ab.startPowers}</div>
                <div>Power Points: {ab.startPP}</div>
                <div style={{color:C.textDim,fontStyle:'italic',marginTop:'4px'}}>{ab.notes}</div>
              </div>
            </div>);
          })}
        </div>
      </div>
      {abData && <div style={card}>
        <div style={cTitle}>Select Powers</div>
        <p style={{fontSize:'14px',color:C.textDim,lineHeight:'1.6',marginBottom:'12px'}}>Choose up to <strong style={{color:C.gold}}>{maxPowers}</strong> powers. You have <strong style={{color:C.gold}}>{totalPP} PP</strong>. Powers must meet Rank requirements.</p>
        <BudgetBar label="Powers" spent={selectedPowers.length} total={maxPowers} color={C.blue} />
        <div style={{maxHeight:'400px',overflowY:'auto'}}>
          {data.powers.map(function(pw) {
            var sel=selectedPowers.includes(pw.name);
            return (<div key={pw.name} onClick={function(){setSelectedPowers(function(p){return p.includes(pw.name)?p.filter(function(x){return x!==pw.name}):[].concat(p,[pw.name])})}} style={{padding:'8px 12px',marginBottom:'2px',cursor:'pointer',background:sel?C.blue+'20':'transparent',borderLeft:sel?'3px solid '+C.blue:'3px solid transparent'}}>
              <div style={{display:'flex',justifyContent:'space-between',alignItems:'baseline'}}>
                <span style={{fontSize:'15px',fontWeight:600,color:sel?C.textBright:C.text}}>{pw.name}</span>
                <span style={{fontSize:'12px',color:C.goldDim}}>{RANK_LABELS[pw.rank]}</span>
              </div>
              <div style={{fontSize:'12px',color:C.textDim,marginTop:'2px'}}>{'PP: '+pw.pp+' | Range: '+pw.range+' | Duration: '+pw.dur}</div>
              {sel&&pw.summary?<div style={{fontSize:'12px',color:C.textDim,marginTop:'2px',fontStyle:'italic'}}>{pw.summary}</div>:null}
            </div>);
          })}
        </div>
      </div>}
    </div>);
  }

  // STEP 6: GEAR
  function renderGear() {
    var tabs=[['melee','Melee'],['ranged','Ranged'],['armor','Armour'],['shields','Shields'],['general','General']];
    var tableData = data.gear[gearTab] || [];
    return (<div>
      <div style={card}>
        <div style={cTitle}>Equipment</div>
        <p style={{fontSize:'14px',color:C.textDim,lineHeight:'1.6',marginBottom:'12px'}}>Starting funds: <strong style={{color:C.gold}}>{startFunds}</strong>. Spent: <strong style={{color:gearCost>startFunds?C.redBright:C.text}}>{gearCost}</strong>. Remaining: <strong style={{color:gearCost>startFunds?C.redBright:C.greenBright}}>{startFunds-gearCost}</strong>.</p>
        <BudgetBar label="Funds" spent={gearCost} total={startFunds} />
        <div style={{display:'flex',gap:'4px',marginBottom:'12px',flexWrap:'wrap'}}>
          {tabs.map(function(t){return <button key={t[0]} onClick={function(){setGearTab(t[0])}} style={{padding:'4px 10px',fontSize:'11px',fontWeight:600,letterSpacing:'1px',textTransform:'uppercase',border:'1px solid '+(gearTab===t[0]?C.gold:C.border),background:gearTab===t[0]?C.gold:'transparent',color:gearTab===t[0]?C.bg:C.textDim,cursor:'pointer',fontFamily:"'Cinzel',serif"}}>{t[1]}</button>;})}
        </div>
        <div style={{maxHeight:'350px',overflowY:'auto'}}>
          {tableData.map(function(item, idx) {
            var owned=gear.find(function(g){return g.name===item.name && g.armor===item.armor && g.dmg===item.dmg;});
            return (<div key={gearTab+'-'+idx} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'8px 12px',borderBottom:'1px solid '+C.border}}>
              <div style={{flex:1}}>
                <div style={{fontSize:'14px',fontWeight:600,color:C.text}}>{item.name}{owned?<span style={{color:C.gold,marginLeft:'6px'}}>{'(\u00d7'+(owned.qty||1)+')'}</span>:null}<span style={{fontSize:'12px',color:C.textDim,fontWeight:400,marginLeft:'8px'}}>{'Cost: '+item.cost}</span></div>
                {owned?<div style={{fontSize:'12px',color:C.textDim,marginTop:'2px',fontStyle:'italic'}}>
                  {item.dmg?'Dmg: '+item.dmg+' | ':''}
                  {item.range?'Range: '+item.range+' | ':''}
                  {item.ap?'AP '+item.ap+' | ':''}
                  {item.armor?'Armour +'+item.armor+' | ':''}
                  {item.parry?'Parry +'+item.parry+' | ':''}
                  {item.cover?'Cover +'+item.cover+' | ':''}
                  {item.minStr?'Min Str: '+item.minStr+' | ':''}
                  {'Wt: '+(item.wt||0)}
                  {item.notes?' | '+item.notes:''}
                </div>:null}
              </div>
              <div style={{display:'flex',gap:'4px',flexShrink:0}}>
                {owned?<button onClick={function(e){e.stopPropagation();removeGear(item.name)}} style={{width:'28px',height:'28px',border:'1px solid '+C.border,background:'transparent',color:C.redBright,fontSize:'15px',cursor:'pointer',lineHeight:'26px',textAlign:'center'}}>{'\u2212'}</button>:null}
                <button onClick={function(e){e.stopPropagation();addGear(item)}} style={{width:'28px',height:'28px',border:'1px solid '+C.border,background:'transparent',color:C.greenBright,fontSize:'15px',cursor:'pointer',lineHeight:'26px',textAlign:'center'}}>+</button>
              </div>
            </div>);
          })}
        </div>
      </div>
      {gear.length>0 && <div style={card}>
        <div style={cTitle}>Inventory ({gear.reduce(function(t,g){return t+(g.qty||1)},0)} items, {gearWeight.toFixed(1)} lbs)</div>
        {gear.map(function(g) {
          return <div key={g.name} style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'4px 0',borderBottom:'1px solid '+C.border}}>
            <span style={{fontSize:'14px',color:C.text}}>{g.name}{(g.qty||1)>1?' \u00d7'+g.qty:''}</span>
            <span style={{fontSize:'13px',color:C.goldDim}}>{g.cost*(g.qty||1)}</span>
          </div>;
        })}
      </div>}
    </div>);
  }

  // STEP 7: SUMMARY
  function renderSummary() {
    return (<div style={card}>
      {/* Character Name & Concept */}
      <div style={{textAlign:'center',marginBottom:'16px'}}>
        {portrait && <div style={{marginBottom:'12px'}}><img src={portrait} style={{width:'120px',height:'150px',objectFit:'cover',border:'2px solid '+C.gold}} /></div>}
        <div style={{fontFamily:"'Cinzel',serif",fontSize:'24px',fontWeight:700,color:C.gold,letterSpacing:'2px'}}>{charName||'Unnamed Hero'}</div>
        {charConcept?<div style={{fontSize:'15px',color:C.textDim,fontStyle:'italic',marginTop:'4px'}}>{charConcept}</div>:null}
        {ancestry?<div style={{fontSize:'14px',color:C.text,marginTop:'6px'}}>{ancestry}</div>:null}
      </div>
      {/* SWADE Canonical Stat Block */}
      <div style={{fontSize:'15px',color:C.text,lineHeight:'2'}}>
        <div><strong style={{color:C.gold}}>Attributes:</strong> {['agility','smarts','spirit','strength','vigor'].map(function(a){return a.charAt(0).toUpperCase()+a.slice(1)+' '+dieLabel(attrs[a])}).join(', ')}</div>
        <div><strong style={{color:C.gold}}>Skills:</strong> {(function(){var all=data.coreSkills.filter(function(s){return !skills[s]}).map(function(s){return{name:s,die:4}}).concat(Object.entries(skills).filter(function(p){return p[1]>0}).map(function(p){return{name:p[0],die:p[1]}})).sort(function(a,b){return a.name.localeCompare(b.name)});return all.map(function(s){return s.name+' '+dieLabel(s.die)}).join(', ')})()}</div>
        <div><strong style={{color:C.gold}}>Pace:</strong> {derived.pace}; <strong style={{color:C.gold}}>Parry:</strong> {derived.parry}; <strong style={{color:C.gold}}>Toughness:</strong> {derived.toughness}{derived.armor>0?' ('+derived.armor+')':''}</div>
        {selectedHindrances.length>0?<div><strong style={{color:C.gold}}>Hindrances:</strong> {selectedHindrances.map(function(h){return h+' ('+hindranceSeverities[h]+')'}).join(', ')}</div>:null}
        {selectedEdges.length>0?<div><strong style={{color:C.gold}}>Edges:</strong> {selectedEdges.join(', ')}</div>:null}
        {gear.length>0?<div><strong style={{color:C.gold}}>Gear:</strong> {gear.map(function(g){var s=g.name+((g.qty||1)>1?' \u00d7'+g.qty:'');if(g.dmg)s+=' ('+g.dmg+')';if(g.armor)s+=' (+'+g.armor+' Armour)';return s}).join(', ')}.</div>:null}
        {hasAB&&abData&&selectedPowers.length>0?<div><strong style={{color:C.blue}}>Powers</strong> <span style={{color:C.textDim}}>({totalPP} PP, {abData.name})</span><strong style={{color:C.blue}}>:</strong> {selectedPowers.map(function(n){var pw=data.powers.find(function(x){return x.name===n});return n+(pw?' ('+pw.pp+' PP)':'')}).join(', ')}</div>:null}
        {ancestry&&data.ancestries[ancestry]?<div><strong style={{color:C.gold}}>Special Abilities:</strong> {data.ancestries[ancestry].summary||Object.keys(data.ancestries[ancestry].abilities||{}).join(', ')}</div>:null}
      </div>
      <div style={{fontSize:'13px',color:C.textDim,marginTop:'16px',paddingTop:'8px',borderTop:'1px solid '+C.border}}>
        <strong style={{color:C.goldDim}}>Modules:</strong> {allModules.filter(function(m){return m.alwaysOn || activeSupplements.indexOf(m.id)>=0}).map(function(m){return m.name}).join(', ')}
      </div>
    </div>);
  }

  // ═══════════════════════════════════════════════════════════
  // EXPORT UTILITIES
  // ═══════════════════════════════════════════════════════════
  function collectCharData() {
    var anc = ancestry && data.ancestries[ancestry] ? data.ancestries[ancestry] : null;
    var allSkills = data.coreSkills.filter(function(s){return !skills[s]}).map(function(s){return {name:s,die:4}})
      .concat(Object.entries(skills).filter(function(p){return p[1]>0}).map(function(p){return {name:p[0],die:p[1]}}))
      .sort(function(a,b){return a.name.localeCompare(b.name)});
    var hindList = selectedHindrances.map(function(h){
      var hd = data.hindrances.find(function(x){return x.name===h});
      return {name:h, severity:hindranceSeverities[h]||'Minor', summary:hd?hd.summary:null, source:hd?hd.source:'swade-core'};
    });
    var edgeList = selectedEdges.map(function(n,i){
      var ed = data.edges.find(function(x){return x.name===n});
      return {name:n, summary:ed?ed.summary:null, source:ed?ed.source:'swade-core'};
    });
    var powerList = selectedPowers.map(function(n){
      var pw = data.powers.find(function(x){return x.name===n});
      return pw ? {name:n,pp:pw.pp,range:pw.range,dur:pw.dur,summary:pw.summary||''} : {name:n};
    });
    var gearList = gear.map(function(g){return {name:g.name,qty:g.qty||1,cost:g.cost,wt:g.wt||0,dmg:g.dmg,armor:g.armor,parry:g.parry,range:g.range,notes:g.notes}});
    return {
      name: charName||'Unnamed Hero', concept: charConcept, ancestry: ancestry||'Human', ancestryData: anc, portrait: portrait,
      attrs: Object.assign({},attrs), skills: allSkills, hindrances: hindList, edges: edgeList,
      powers: powerList, gear: gearList, derived: Object.assign({},derived),
      hasAB: hasAB, abData: abData, totalPP: totalPP, startFunds: startFunds, gearCost: gearCost,
      modules: allModules.filter(function(m){return m.alwaysOn||activeSupplements.indexOf(m.id)>=0}).map(function(m){return m.name})
    };
  }

  function esc(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  function downloadFile(filename, content, mime) {
    var blob = new Blob([content], {type:mime});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a'); a.href=url; a.download=filename; a.click();
    URL.revokeObjectURL(url);
  }

  // ── FG XML EXPORT ──
  function exportFGXML() {
    var ch = collectCharData();
    var slug = ch.name.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'') || 'character';
    var xml = '<?xml version="1.0" encoding="utf-8"?>\n';
    xml += '<root version="4.8">\n';
    xml += '  <charsheet>\n';
    xml += '    <' + slug + '>\n';
    xml += '      <name type="string">' + esc(ch.name) + '</name>\n';
    xml += '      <race type="string">' + esc(ch.ancestry) + '</race>\n';
    xml += '      <rank type="string">Novice</rank>\n';
    xml += '      <concept type="string">' + esc(ch.concept) + '</concept>\n';
    xml += '      <wildcard type="number">1</wildcard>\n';
    xml += '      <bennies type="number">' + ch.derived.bennies + '</bennies>\n';
    // Attributes
    xml += '      <attributes>\n';
    ['agility','smarts','spirit','strength','vigor'].forEach(function(a){
      xml += '        <' + a + '><die type="dice">' + dieLabel(ch.attrs[a]) + '</die><modifier type="number">0</modifier></' + a + '>\n';
    });
    xml += '      </attributes>\n';
    // Skills
    xml += '      <skills>\n';
    ch.skills.forEach(function(s,i){
      var id = 'id-' + String(i+1).padStart(5,'0');
      xml += '        <' + id + '>\n';
      xml += '          <name type="string">' + esc(s.name) + '</name>\n';
      xml += '          <skill type="dice">' + dieLabel(s.die) + '</skill>\n';
      xml += '          <adjustment type="number">0</adjustment>\n';
      xml += '          <skillmod type="number">0</skillmod>\n';
      xml += '        </' + id + '>\n';
    });
    xml += '      </skills>\n';
    // Edges
    xml += '      <edges>\n';
    ch.edges.forEach(function(e,i){
      var id = 'id-' + String(i+1).padStart(5,'0');
      xml += '        <' + id + '><name type="string">' + esc(e.name) + '</name></' + id + '>\n';
    });
    xml += '      </edges>\n';
    // Hindrances
    xml += '      <hindrances>\n';
    ch.hindrances.forEach(function(h,i){
      var id = 'id-' + String(i+1).padStart(5,'0');
      xml += '        <' + id + '><name type="string">' + esc(h.name) + ' (' + h.severity + ')</name></' + id + '>\n';
    });
    xml += '      </hindrances>\n';
    // Derived
    xml += '      <pace type="number">' + ch.derived.pace + '</pace>\n';
    xml += '      <parry type="number">' + ch.derived.parry + '</parry>\n';
    xml += '      <toughness type="number">' + ch.derived.toughness + '</toughness>\n';
    xml += '      <toughnessmod type="number">' + ch.derived.armor + '</toughnessmod>\n';
    // Weapons
    var weapons = ch.gear.filter(function(g){return g.dmg});
    if (weapons.length) {
      xml += '      <weaponlist>\n';
      weapons.forEach(function(w,i){
        var id = 'id-' + String(i+1).padStart(5,'0');
        var isRanged = !!w.range;
        xml += '        <' + id + '>\n';
        xml += '          <name type="string">' + esc(w.name) + '</name>\n';
        xml += '          <damage type="string">' + esc(w.dmg) + '</damage>\n';
        xml += '          <damagedice type="dice">' + esc(w.dmg.replace(/Str/,dieLabel(ch.attrs.strength))) + '</damagedice>\n';
        xml += '          <armorpiercing type="number">0</armorpiercing>\n';
        xml += '          <damagebonus type="number">0</damagebonus>\n';
        xml += '          <fumble type="number">1</fumble>\n';
        xml += '          <reach type="number">0</reach>\n';
        if (w.range) xml += '          <range type="string">' + esc(w.range) + '</range>\n';
        xml += '          <traittype type="string">' + (isRanged?'Ranged':'Melee') + '</traittype>\n';
        xml += '          <traitcount type="number">0</traitcount>\n';
        xml += '          <notes type="string">' + esc(w.notes||'') + '</notes>\n';
        xml += '          <bonuslist />\n';
        xml += '        </' + id + '>\n';
      });
      xml += '      </weaponlist>\n';
    }
    // Powers
    if (ch.hasAB && ch.abData) {
      xml += '      <powerpoints type="number">' + ch.totalPP + '</powerpoints>\n';
      xml += '      <powers>\n';
      ch.powers.forEach(function(p,i){
        var id = 'id-' + String(i+1).padStart(5,'0');
        xml += '        <' + id + '><name type="string">' + esc(p.name) + '</name><pp type="string">' + esc(p.pp) + '</pp><range type="string">' + esc(p.range) + '</range><duration type="string">' + esc(p.dur) + '</duration></' + id + '>\n';
      });
      xml += '      </powers>\n';
    }
    // Inventory
    xml += '      <inventorylist>\n';
    ch.gear.forEach(function(g,i){
      var id = 'id-' + String(i+1).padStart(5,'0');
      xml += '        <' + id + '><name type="string">' + esc(g.name) + '</name><count type="number">' + g.qty + '</count><weight type="number">' + g.wt + '</weight><cost type="string">' + g.cost + '</cost></' + id + '>\n';
    });
    xml += '      </inventorylist>\n';
    xml += '    </' + slug + '>\n';
    xml += '  </charsheet>\n';
    xml += '</root>';
    downloadFile(slug + '.xml', xml, 'application/xml');
  }

  // ── PDF EXPORT (Pinnacle canonical layout) ──
  function exportPDF() {
    var ch = collectCharData();
    var jsPDF = window.jspdf.jsPDF;
    var doc = new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    var W=210, H=297, M=15, CW=W-2*M;
    var y = M;
    var colGold = [196,164,74], colDark = [20,18,16], colText = [60,55,48], colDim = [120,110,100];

    // Header bar
    doc.setFillColor(colDark[0],colDark[1],colDark[2]);
    doc.rect(0,0,W,32,'F');
    doc.setFillColor(colGold[0],colGold[1],colGold[2]);
    doc.rect(0,30,W,2,'F');

    // Portrait
    if (ch.portrait) {
      try { doc.addImage(ch.portrait, 'JPEG', M, 5, 22, 24); } catch(e){}
    }
    var nameX = ch.portrait ? M+26 : M;
    doc.setFont('helvetica','bold'); doc.setFontSize(22); doc.setTextColor(colGold[0],colGold[1],colGold[2]);
    doc.text(ch.name, nameX, 15);
    doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.setTextColor(200,190,175);
    var subtitleParts = [];
    if (ch.ancestry) subtitleParts.push(ch.ancestry);
    if (ch.concept) subtitleParts.push(ch.concept);
    if (subtitleParts.length) doc.text(subtitleParts.join(' \u2014 '), nameX, 22);
    doc.setFontSize(9); doc.setTextColor(160,150,135);
    doc.text('Novice  |  Savage Worlds', nameX, 28);
    y = 40;

    function checkPage(need) { if (y+need > H-M) { doc.addPage(); y=M; } }
    function statLine(label, value) {
      checkPage(8);
      var lines = doc.splitTextToSize(value, CW - 30);
      doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.setTextColor(colGold[0],colGold[1],colGold[2]);
      doc.text(label, M, y);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(colText[0],colText[1],colText[2]);
      doc.text(lines, M + doc.getTextWidth(label) + 2, y);
      y += lines.length * 5 + 2;
    }

    // SWADE Canonical Stat Block
    statLine('Attributes: ', ['agility','smarts','spirit','strength','vigor'].map(function(a){
      return a.charAt(0).toUpperCase()+a.slice(1)+' '+dieLabel(ch.attrs[a]);
    }).join(', '));

    statLine('Skills: ', ch.skills.map(function(s){return s.name+' '+dieLabel(s.die)}).join(', '));

    // Pace; Parry; Toughness on one line
    var derivedLine = ch.derived.pace+';  Parry: '+ch.derived.parry+';  Toughness: '+ch.derived.toughness+(ch.derived.armor>0?' ('+ch.derived.armor+')':'');
    statLine('Pace: ', derivedLine);

    if (ch.hindrances.length) {
      statLine('Hindrances: ', ch.hindrances.map(function(h){return h.name+' ('+h.severity+')'}).join(', '));
    }
    if (ch.edges.length) {
      statLine('Edges: ', ch.edges.map(function(e){return e.name}).join(', '));
    }
    if (ch.gear.length) {
      var gearStr = ch.gear.map(function(g){
        var s = g.name; if(g.qty>1) s+=' \u00d7'+g.qty;
        if(g.dmg) s+=' ('+g.dmg+')'; if(g.armor) s+=' (+'+g.armor+' Armour)';
        return s;
      }).join(', ')+'.';
      statLine('Gear: ', gearStr);
      doc.setFont('helvetica','normal'); doc.setFontSize(8); doc.setTextColor(colDim[0],colDim[1],colDim[2]);
      doc.text('Remaining funds: '+(ch.startFunds-ch.gearCost), M, y); y+=6;
    }
    if (ch.hasAB && ch.abData && ch.powers.length) {
      statLine('Powers ('+ch.abData.name+', '+ch.totalPP+' PP): ',
        ch.powers.map(function(p){return p.name+' ('+p.pp+' PP)'}).join(', '));
    }
    if (ch.ancestry && ch.ancestryData) {
      var abils = Object.keys(ch.ancestryData.abilities||{}).join(', ');
      if (abils) statLine('Special Abilities: ', abils);
    }

    // Footer
    y = H-12;
    doc.setDrawColor(colGold[0],colGold[1],colGold[2]); doc.setLineWidth(0.3);
    doc.line(M, y, M+CW, y); y+=4;
    doc.setFont('helvetica','normal'); doc.setFontSize(7); doc.setTextColor(colDim[0],colDim[1],colDim[2]);
    doc.text('Savage Worlds, property of Pinnacle Entertainment Group. Created with Character Forge by DiceForge Studios.', M, y);
    y+=3;
    doc.text('Modules: '+ch.modules.join(', '), M, y);

    doc.save((ch.name.replace(/[^a-zA-Z0-9]+/g,'_')||'character')+'.pdf');
  }

  // ── HTML EXPORT (Pinnacle pre-gen canonical format) ──
  function exportHTML() {
    var ch = collectCharData();
    var portraitBlock = ch.portrait ? '<div style="text-align:center;margin-bottom:16px"><img src="'+ch.portrait+'" style="width:140px;height:175px;object-fit:cover;border:3px solid #C4A44A" /></div>' : '';
    var html = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">';
    html += '<title>'+esc(ch.name)+' \u2014 Savage Worlds Character Sheet</title>';
    html += '<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">';
    html += '<style>';
    html += 'body{margin:0;padding:40px;background:#F5F0E8;font-family:"Crimson Pro",Georgia,serif;color:#3C3730;font-size:15px;line-height:1.8}';
    html += '.sheet{max-width:700px;margin:0 auto;background:#fff;padding:40px;box-shadow:0 2px 20px rgba(0,0,0,.12);border:1px solid #E0D8C8}';
    html += '.header{border-bottom:3px solid #C4A44A;padding-bottom:16px;margin-bottom:20px}';
    html += 'h1{font-family:Cinzel,serif;font-size:28px;color:#2A2520;margin:0;letter-spacing:2px}';
    html += '.subtitle{font-size:14px;color:#8A8070;font-style:italic;margin-top:4px}';
    html += '.stat-block{margin:0}';
    html += '.stat-block p{margin:0 0 4px}.stat-block strong{color:#2A2520}';
    html += '.footer{margin-top:24px;padding-top:12px;border-top:1px solid #E0D8C8;font-size:10px;color:#AAA098;text-align:center}';
    html += '@media print{body{padding:0;background:#fff}.sheet{box-shadow:none;border:none}}';
    html += '</style></head><body><div class="sheet">';
    html += '<div class="header">';
    html += portraitBlock;
    html += '<h1>'+esc(ch.name)+'</h1>';
    var subtParts = [];
    if (ch.ancestry) subtParts.push(ch.ancestry);
    if (ch.concept) subtParts.push(ch.concept);
    if (subtParts.length) html += '<div class="subtitle">'+esc(subtParts.join(' \u2014 '))+'</div>';
    html += '</div>';
    // SWADE Canonical Stat Block
    html += '<div class="stat-block">';
    html += '<p><strong>Attributes:</strong> '+['agility','smarts','spirit','strength','vigor'].map(function(a){return a.charAt(0).toUpperCase()+a.slice(1)+' '+dieLabel(ch.attrs[a])}).join(', ')+'</p>';
    html += '<p><strong>Skills:</strong> '+ch.skills.map(function(s){return esc(s.name)+' '+dieLabel(s.die)}).join(', ')+'</p>';
    html += '<p><strong>Pace:</strong> '+ch.derived.pace+'; <strong>Parry:</strong> '+ch.derived.parry+'; <strong>Toughness:</strong> '+ch.derived.toughness+(ch.derived.armor>0?' ('+ch.derived.armor+')':'')+'</p>';
    if (ch.hindrances.length) {
      html += '<p><strong>Hindrances:</strong> '+ch.hindrances.map(function(h){return esc(h.name)+' ('+h.severity+')'}).join(', ')+'</p>';
    }
    if (ch.edges.length) {
      html += '<p><strong>Edges:</strong> '+ch.edges.map(function(e){return esc(e.name)}).join(', ')+'</p>';
    }
    if (ch.gear.length) {
      html += '<p><strong>Gear:</strong> '+ch.gear.map(function(g){
        var s = esc(g.name); if(g.qty>1) s+=' \u00d7'+g.qty;
        if(g.dmg) s+=' ('+esc(g.dmg)+')'; if(g.armor) s+=' (+'+g.armor+' Armour)';
        return s;
      }).join(', ')+'.</p>';
      html += '<p style="font-size:13px;color:#8A8070">Remaining funds: '+(ch.startFunds-ch.gearCost)+'</p>';
    }
    if (ch.hasAB && ch.abData && ch.powers.length) {
      html += '<p><strong>Powers</strong> ('+esc(ch.abData.name)+', '+ch.totalPP+' PP)<strong>:</strong> '+ch.powers.map(function(p){return esc(p.name)+' ('+p.pp+' PP)'}).join(', ')+'</p>';
    }
    if (ch.ancestry && ch.ancestryData) {
      var abils = Object.keys(ch.ancestryData.abilities||{}).join(', ');
      if (abils) html += '<p><strong>Special Abilities:</strong> '+esc(abils)+'</p>';
    }
    html += '</div>';
    html += '<div class="footer">Savage Worlds, property of Pinnacle Entertainment Group. Created with Character Forge by DiceForge Studios.<br/>Modules: '+ch.modules.join(', ')+'</div>';
    html += '</div></body></html>';
    downloadFile((ch.name.replace(/[^a-zA-Z0-9]+/g,'_')||'character')+'.html', html, 'text/html');
  }

  // ── RTF EXPORT (Pinnacle pre-gen format) ──
  function exportRTF() {
    var ch = collectCharData();
    var rtf = '{\\rtf1\\ansi\\deff0';
    rtf += '{\\fonttbl{\\f0\\fswiss Helvetica;}{\\f1\\froman Georgia;}}';
    rtf += '{\\colortbl;\\red196\\green164\\blue74;\\red42\\green37\\blue32;\\red138\\green128\\blue112;}';
    rtf += '\\paperw11906\\paperh16838\\margl1134\\margr1134\\margt1134\\margb1134\n';
    // Title
    rtf += '\\pard\\qc\\f0\\b\\fs36\\cf2 '+rtfEsc(ch.name)+'\\b0\\par\n';
    var subtParts = [];
    if (ch.ancestry) subtParts.push(ch.ancestry);
    if (ch.concept) subtParts.push(ch.concept);
    if (subtParts.length) rtf += '\\pard\\qc\\f1\\fs22\\cf3\\i '+rtfEsc(subtParts.join(' \\u8212? '))+'\\i0\\par\n';
    rtf += '\\pard\\qc\\f0\\fs18\\cf1 \\u9472?\\u9472?\\u9472?\\u9472?\\u9472?\\u9472?\\u9472?\\u9472?\\u9472?\\u9472?\\u9472?\\u9472?\\u9472?\\u9472?\\u9472?\\par\\par\n';
    // SWADE Canonical Stat Block
    rtf += '\\pard\\f1\\fs20\\cf2 \\b\\cf1 Attributes:\\b0\\cf2  '+['agility','smarts','spirit','strength','vigor'].map(function(a){return a.charAt(0).toUpperCase()+a.slice(1)+' '+dieLabel(ch.attrs[a])}).join(', ')+'\\par\n';
    rtf += '\\pard\\f1\\fs20\\cf2 \\b\\cf1 Skills:\\b0\\cf2  '+ch.skills.map(function(s){return rtfEsc(s.name)+' '+dieLabel(s.die)}).join(', ')+'\\par\n';
    rtf += '\\pard\\f1\\fs20\\cf2 \\b\\cf1 Pace:\\b0\\cf2  '+ch.derived.pace+';  \\b\\cf1 Parry:\\b0\\cf2  '+ch.derived.parry+';  \\b\\cf1 Toughness:\\b0\\cf2  '+ch.derived.toughness+(ch.derived.armor>0?' ('+ch.derived.armor+')':'')+'\\par\n';
    if (ch.hindrances.length) {
      rtf += '\\pard\\f1\\fs20\\cf2 \\b\\cf1 Hindrances:\\b0\\cf2  '+ch.hindrances.map(function(h){return rtfEsc(h.name)+' ('+h.severity+')'}).join(', ')+'\\par\n';
    }
    if (ch.edges.length) {
      rtf += '\\pard\\f1\\fs20\\cf2 \\b\\cf1 Edges:\\b0\\cf2  '+ch.edges.map(function(e){return rtfEsc(e.name)}).join(', ')+'\\par\n';
    }
    if (ch.gear.length) {
      rtf += '\\pard\\f1\\fs20\\cf2 \\b\\cf1 Gear:\\b0\\cf2  '+ch.gear.map(function(g){
        var s = rtfEsc(g.name); if(g.qty>1) s+=' \\u215?'+g.qty;
        if(g.dmg) s+=' ('+rtfEsc(g.dmg)+')'; if(g.armor) s+=' (+'+g.armor+' Armour)';
        return s;
      }).join(', ')+'.\\par\n';
      rtf += '\\pard\\f1\\fs18\\cf3 Remaining funds: '+(ch.startFunds-ch.gearCost)+'\\par\n';
    }
    if (ch.hasAB && ch.abData && ch.powers.length) {
      rtf += '\\pard\\f1\\fs20\\cf2 \\b\\cf1 Powers\\b0\\cf2  ('+rtfEsc(ch.abData.name)+', '+ch.totalPP+' PP): '+ch.powers.map(function(p){return rtfEsc(p.name)+' ('+p.pp+' PP)'}).join(', ')+'\\par\n';
    }
    if (ch.ancestry && ch.ancestryData) {
      var abils = Object.keys(ch.ancestryData.abilities||{}).join(', ');
      if (abils) rtf += '\\pard\\f1\\fs20\\cf2 \\b\\cf1 Special Abilities:\\b0\\cf2  '+rtfEsc(abils)+'\\par\n';
    }
    rtf += '\\par\n';
    // Footer
    rtf += '\\pard\\qc\\f0\\fs14\\cf3 Savage Worlds, property of Pinnacle Entertainment Group. Created with Character Forge by DiceForge Studios.\\par\n';
    rtf += '}';
    downloadFile((ch.name.replace(/[^a-zA-Z0-9]+/g,'_')||'character')+'.rtf', rtf, 'application/rtf');
  }
  function rtfEsc(s) { return String(s).replace(/\\/g,'\\\\').replace(/\{/g,'\\{').replace(/\}/g,'\\}'); }

  // ── EXPORT PANEL ──
  function renderExport() {
    var ch = collectCharData();
    var btnStyle = function(colour) { return {
      display:'flex',alignItems:'center',gap:'12px',padding:'16px 20px',
      border:'1px solid '+C.border,background:C.bgCard,cursor:'pointer',
      transition:'all .15s',width:'100%',textAlign:'left'
    }};
    var formats = [
      {id:'fgxml', label:'Fantasy Grounds XML', desc:'Import directly into Fantasy Grounds Unity as a character sheet. Includes attributes, skills, edges, hindrances, weapons, powers, and inventory.', icon:'\u2694', colour:'#5A9A5A', fn:exportFGXML},
      {id:'pdf', label:'PDF Character Sheet', desc:'Print-ready A4 character sheet styled to Pinnacle canon. Portrait, derived stats bar, all sections formatted for table use.', icon:'\uD83D\uDCC4', colour:'#4A7A9A', fn:exportPDF},
      {id:'html', label:'HTML Character Sheet', desc:'Standalone web page in Pinnacle pre-generated character format. Print-friendly, works in any browser.', icon:'\uD83C\uDF10', colour:'#9A7A4A', fn:exportHTML},
      {id:'rtf', label:'RTF Document', desc:'Rich text format compatible with Word, LibreOffice, and Google Docs. Pinnacle section headers, bold labels, comma-separated lists.', icon:'\uD83D\uDCDD', colour:'#7A5A9A', fn:exportRTF}
    ];
    return (<div>
      <div style={card}>
        <div style={cTitle}>Export Character</div>
        <p style={{fontSize:'15px',color:C.textDim,lineHeight:'1.6',marginBottom:'4px'}}>
          Export <strong style={{color:C.gold}}>{ch.name}</strong> in any format below. All exports follow the canonical Pinnacle Entertainment character sheet layout.
        </p>
        {portrait && <p style={{fontSize:'13px',color:C.greenBright,marginTop:'4px'}}>{'\u2713'} Portrait included in exports.</p>}
      </div>
      <div style={{display:'flex',flexDirection:'column',gap:'8px'}}>
        {formats.map(function(f) {
          return (<div key={f.id} onClick={f.fn}
            onMouseEnter={function(e){e.currentTarget.style.borderColor=f.colour;e.currentTarget.style.background=f.colour+'10'}}
            onMouseLeave={function(e){e.currentTarget.style.borderColor=C.border;e.currentTarget.style.background=C.bgCard}}
            style={btnStyle(f.colour)}>
            <div style={{fontSize:'28px',width:'40px',textAlign:'center',flexShrink:0}}>{f.icon}</div>
            <div style={{flex:1}}>
              <div style={{fontFamily:"'Cinzel',serif",fontSize:'16px',fontWeight:700,color:C.textBright,letterSpacing:'1px'}}>{f.label}</div>
              <div style={{fontSize:'14px',color:C.textDim,marginTop:'4px',lineHeight:'1.5'}}>{f.desc}</div>
            </div>
            <div style={{fontSize:'20px',color:C.goldDim,flexShrink:0}}>{'\u2913'}</div>
          </div>);
        })}
      </div>
      <div style={Object.assign({},card,{marginTop:'16px',background:'transparent',border:'1px solid '+C.border,padding:'14px 20px'})}>
        <div style={{fontSize:'13px',color:C.textDim,lineHeight:'1.8'}}>
          <strong style={{color:C.goldDim}}>Export notes</strong><br/>
          FG XML imports into Fantasy Grounds Unity via the charsheet node. PDF is A4, print-ready. HTML is self-contained with embedded fonts. RTF opens in any word processor. All formats include the Pinnacle Fan License attribution.
        </div>
      </div>
    </div>);
  }

  var renderers = [renderConcept,renderAncestry,renderAttributes,renderSkills,renderHindrancesEdges,renderPowers,renderGear,renderSummary,renderExport];

  // ── VALIDATION ──
  var STATUS_COLORS = {green:'#50A050',red:'#B04040',yellow:'#C4A44A'};
  var stepStatus = useMemo(function() {
    var s = ['yellow','yellow','yellow','yellow','yellow','yellow','yellow','yellow'];
    if(charName.trim().length>0) s[0]='green';
    if(ancestry) s[1]='green';
    if(attrPoints.spent>attrPoints.total) s[2]='red'; else if(attrPoints.spent===attrPoints.total) s[2]='green';
    if(skillPoints.spent>skillPoints.total) s[3]='red'; else if(skillPoints.spent===skillPoints.total) s[3]='green';
    var hindUsed=hindAlloc.edges*2+hindAlloc.attrs*2+hindAlloc.skills+hindAlloc.funds;
    if(selectedEdges.length>edgeBudget.total) s[4]='red';
    else if(hindPts>0&&hindUsed>hindPts) s[4]='red';
    else if(selectedEdges.length===edgeBudget.total&&hindUsed===hindPts) s[4]='green';
    if(!hasAB) s[5]='green';
    else if(selectedPowers.length>maxPowers) s[5]='red';
    else if(arcaneBg&&selectedPowers.length===maxPowers) s[5]='green';
    if(gearCost>startFunds) s[6]='red';
    else if(gear.length>0&&gearCost<=startFunds) s[6]='green';
    var hasRed=s.slice(0,7).indexOf('red')>=0,allGreen=s.slice(0,7).every(function(v){return v==='green';});
    if(hasRed) s[7]='red'; else if(allGreen) s[7]='green';
    return s;
  }, [charName,ancestry,attrPoints,skillPoints,selectedEdges,edgeBudget,hindPts,hindAlloc,hasAB,arcaneBg,selectedPowers,maxPowers,gearCost,gear,startFunds]);

  // ── RENDER ──
  return (
    <div style={{background:C.bg,color:C.text,minHeight:'100vh',fontFamily:"'Crimson Pro','Georgia',serif",padding:0}}>
      <div style={{background:'linear-gradient(180deg,'+C.bgCard+','+C.bg+')',borderBottom:'1px solid '+C.border,padding:'24px 20px 16px',textAlign:'center'}}>
        <h1 style={{fontFamily:"'Cinzel',serif",fontSize:'28px',fontWeight:700,color:C.gold,letterSpacing:'3px',margin:0,textTransform:'uppercase'}}>Character Forge</h1>
        <div style={{fontSize:'14px',color:C.textDim,letterSpacing:'2px',marginTop:'4px',textTransform:'uppercase'}}>For Savage Worlds</div>
      </div>
      <div style={{maxWidth:'860px',margin:'0 auto',padding:'0 16px 40px'}}>
        <div style={{display:'flex',gap:'2px',margin:'20px 0',overflow:'auto'}}>
          {STEPS.map(function(s,i){
            var active=i===step,status=stepStatus[i];
            var tc=active?STATUS_COLORS[status]:(status==='red'?C.redBright:status==='green'?C.green:C.textDim);
            var bc=active?STATUS_COLORS[status]:(status==='red'?C.redBright:status==='green'?C.green:C.border);
            return <div key={i} onClick={function(){setStep(i)}} style={{flex:1,padding:'10px 4px',textAlign:'center',fontSize:'11px',fontWeight:600,letterSpacing:'1px',textTransform:'uppercase',cursor:'pointer',fontFamily:"'Cinzel',serif",color:tc,borderBottom:'2px solid '+bc,whiteSpace:'nowrap'}}>{s}</div>;
          })}
        </div>
        {step>=2&&ancestry?(<div style={{display:'flex',justifyContent:'center',gap:'16px',padding:'8px 0',marginBottom:'8px',borderBottom:'1px solid '+C.border,flexWrap:'wrap'}}>
          {[['Pace',derived.pace+(derived.runDie!==6?' (d'+derived.runDie+')':'')],['Parry',derived.parry],['Tough',derived.toughness+(derived.armor>0?' ('+derived.armor+')':'')],['Bennies',derived.bennies]].map(function(p){return <span key={p[0]} style={{fontSize:'13px',color:C.textDim}}>{p[0]+' '}<strong style={{color:C.gold}}>{p[1]}</strong></span>;})}
          {hasAB&&abData?<span style={{fontSize:'13px',color:C.textDim}}>{'PP '}<strong style={{color:C.blue}}>{totalPP}</strong></span>:null}
        </div>):null}
        {renderers[step]()}
        <div style={{display:'flex',justifyContent:'space-between',marginTop:'20px'}}>
          {step>0?<button onClick={function(){setStep(step-1)}} style={{padding:'12px 28px',border:'1px solid '+C.border,background:'transparent',color:C.text,fontSize:'14px',fontWeight:700,letterSpacing:'2px',textTransform:'uppercase',cursor:'pointer',fontFamily:"'Cinzel',serif"}}>{'\u2190 Back'}</button>:<div/>}
          {step<STEPS.length-1?<button onClick={function(){setStep(step+1)}} style={{padding:'12px 28px',border:'none',background:C.gold,color:C.bg,fontSize:'14px',fontWeight:700,letterSpacing:'2px',textTransform:'uppercase',cursor:'pointer',fontFamily:"'Cinzel',serif"}}>{step===0?'Begin \u2192':'Continue \u2192'}</button>:null}
        </div>
        <div style={{fontSize:'11px',color:C.textDim,textAlign:'center',marginTop:'32px',lineHeight:'1.5',padding:'12px',borderTop:'1px solid '+C.border}}>
          This tool references Savage Worlds, property of Pinnacle Entertainment Group, under the Fan License. Not for resale. You will need the Savage Worlds core rules to play.
          {activeSupplements.length > 0 ? ' Supplement content \u00A9 DiceForge Studios.' : ''}
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<CharacterForgeApp />);
</script>
</body>
</html>


