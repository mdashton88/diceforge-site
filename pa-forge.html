<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Power Armour Forge ‚Äî DiceForge Studios</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root{--bg-deep:#0E0C0A;--bg-dark:#141210;--bg-card:#1A1816;--bg-panel:#201E1A;--border:#3A3530;--border-light:#4A4540;--accent:#C4A44A;--accent-dim:#C4A44A40;--accent-glow:#C4A44A20;--text:#D4C8B0;--text-bright:#EDE4D4;--text-dim:#8A7A60;--green:#5A9A5A;--red:#8C3030;--red-bright:#B04040;--blue:#4A7A9A;--orange:#B07830}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;background:var(--bg-deep);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:15px;line-height:1.6}
.tool-nav{display:flex;gap:0;background:#141210;border-bottom:1px solid #3A3530;padding:0 12px;font-family:'Cinzel',serif}
.tool-nav-item{background:transparent;border:none;color:#8A7A60;padding:8px 16px;font-size:11px;letter-spacing:1.5px;cursor:pointer;font-family:'Cinzel',serif;text-transform:uppercase;transition:all .15s}
.tool-nav-item:hover{color:#D4C8B0}
.tool-nav-item.active{color:#C4A44A;border-bottom:2px solid #C4A44A}
.app{display:flex;height:calc(100vh - 38px);overflow:hidden}
.sidebar{width:320px;min-width:320px;background:var(--bg-dark);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.header{background:var(--bg-dark);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;gap:16px}
.header-brand{font-family:'Cinzel',serif;font-size:11px;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase}
.header-title{font-family:'Cinzel',serif;font-size:18px;color:var(--accent);letter-spacing:2px}
.header-spacer{flex:1}
.header-btn{background:transparent;border:1px solid var(--border);color:var(--text-dim);padding:6px 14px;font-family:'Crimson Pro',serif;font-size:13px;cursor:pointer;transition:all .15s}
.header-btn:hover{border-color:var(--accent);color:var(--accent)}
.header-btn.primary{background:var(--accent);color:var(--bg-deep);border-color:var(--accent);font-weight:700}
.header-btn.primary:hover{background:#D4B45A}
.sidebar-header{padding:16px;border-bottom:1px solid var(--border)}
.sidebar-header h2{font-family:'Cinzel',serif;font-size:13px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;margin-bottom:8px}
.sidebar-section{padding:12px 16px;border-bottom:1px solid var(--border)}
.sidebar-section h3{font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px}
.field-row input[type="text"]{background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:5px 10px;font-family:'Crimson Pro',serif;font-size:14px;width:100%}
.field-row input[type="text"]:focus{outline:none;border-color:var(--accent)}
.chassis-grid{display:flex;flex-direction:column;gap:4px}
.chassis-btn{background:var(--bg-deep);border:1px solid var(--border);color:var(--text);padding:8px 12px;cursor:pointer;font-family:'Crimson Pro',serif;font-size:13px;text-align:left;transition:all .15s;display:flex;justify-content:space-between;align-items:center}
.chassis-btn:hover{border-color:var(--accent);color:var(--accent)}
.chassis-btn.active{background:var(--accent-glow);border-color:var(--accent);color:var(--accent)}
.chassis-btn .chassis-size{font-size:11px;color:var(--text-dim)}
.chassis-btn.active .chassis-size{color:var(--accent);opacity:.7}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.stat-box{background:var(--bg-deep);border:1px solid var(--border);padding:8px 10px;text-align:center}
.stat-box .stat-label{font-size:10px;letter-spacing:1.5px;color:var(--text-dim);text-transform:uppercase;font-family:'Cinzel',serif}
.stat-box .stat-value{font-size:16px;font-weight:700;color:var(--text-bright);margin-top:2px}
.stat-box .stat-value.danger{color:var(--red-bright)}
.mods-remaining{background:var(--bg-deep);border:1px solid var(--border);padding:10px;text-align:center;margin-top:8px}
.mods-remaining .big-num{font-size:28px;font-weight:700;font-family:'Cinzel',serif}
.mods-remaining .big-num.ok{color:var(--green)}
.mods-remaining .big-num.low{color:var(--orange)}
.mods-remaining .big-num.over{color:var(--red-bright)}
.mods-remaining .sub{font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase}
.cost-display{background:var(--bg-deep);border:1px solid var(--accent-dim);padding:10px;text-align:center;margin-top:6px}
.cost-display .cost-val{font-size:18px;font-weight:700;color:var(--accent);font-family:'Cinzel',serif}
.cost-display .cost-label{font-size:10px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase}
.content{flex:1;overflow-y:auto;padding:20px}
.content::-webkit-scrollbar{width:6px}
.content::-webkit-scrollbar-track{background:var(--bg-dark)}
.content::-webkit-scrollbar-thumb{background:var(--border)}
.tab-bar{display:flex;gap:0;border-bottom:1px solid var(--border)}
.tab{padding:10px 20px;font-family:'Cinzel',serif;font-size:12px;letter-spacing:1.5px;color:var(--text-dim);cursor:pointer;border-bottom:2px solid transparent;text-transform:uppercase;transition:all .15s}
.tab:hover{color:var(--text)}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.panel{display:none}
.panel.active{display:block}
.dnd-layout{display:grid;grid-template-columns:1fr 1fr;gap:20px;min-height:400px}
.dnd-column h3{font-family:'Cinzel',serif;font-size:12px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;padding-bottom:8px;border-bottom:1px solid var(--border);margin-bottom:10px}
.drag-item{display:flex;align-items:center;gap:10px;padding:10px 12px;margin-bottom:5px;background:var(--bg-card);border:1px solid var(--border);cursor:grab;transition:transform .15s,box-shadow .15s,border-color .15s;user-select:none;touch-action:none;-webkit-user-select:none}
.drag-item:hover{border-color:var(--border-light)}.drag-item:active{cursor:grabbing}
.drag-item .drag-handle{color:var(--text-dim);font-size:14px;opacity:.4}
.drag-item .di-info{flex:1;min-width:0}.drag-item .di-name{font-weight:600;color:var(--text-bright);font-size:13px}
.drag-item .di-desc{font-size:11px;color:var(--text-dim);font-style:italic;line-height:1.3;margin-top:1px}
.drag-item .di-meta{text-align:right;min-width:55px}.drag-item .di-mods{font-weight:700;color:var(--accent);font-size:12px}
.drag-item .di-price{font-size:10px;color:var(--text-dim)}.drag-item .di-max{font-size:10px;color:var(--text-dim)}
.drag-item.dragging{opacity:.5;transform:scale(.97);border-color:var(--accent-dim)}
.drag-ghost{position:fixed;pointer-events:none;z-index:1000;padding:8px 14px;background:var(--bg-panel);border:1px solid var(--accent);box-shadow:0 8px 32px rgba(196,164,74,.3),0 0 12px rgba(196,164,74,.15);font-family:'Cinzel',serif;font-size:13px;color:var(--accent);letter-spacing:1px;white-space:nowrap}
.drag-ghost.near-target{box-shadow:0 12px 48px rgba(196,164,74,.5),0 0 20px rgba(196,164,74,.25);transform:scale(1.05)}
.drop-bay{min-height:120px;padding:8px;background:var(--bg-deep);border:2px dashed var(--border);transition:border-color .2s,background .2s,box-shadow .2s}
.drop-bay.drag-over{border-color:var(--accent);border-style:solid;background:var(--accent-glow);box-shadow:inset 0 0 30px rgba(196,164,74,.08)}
.drop-bay .empty-bay{text-align:center;padding:30px 16px;color:var(--text-dim);font-style:italic;font-size:13px}
.bay-item{display:flex;align-items:center;gap:8px;padding:8px 12px;margin-bottom:4px;background:var(--bg-card);border:1px solid var(--accent-dim);position:relative;overflow:hidden}
.bay-item .bi-info{flex:1}.bay-item .bi-name{font-weight:600;color:var(--accent);font-size:13px}
.bay-item .bi-detail{font-size:11px;color:var(--text-dim)}
.bay-item .bi-count{font-family:'Cinzel',serif;font-size:14px;color:var(--text-bright);font-weight:700;min-width:24px;text-align:center}
.bay-item .bi-controls{display:flex;gap:3px}
.bay-item .bi-controls button{width:24px;height:24px;background:var(--bg-deep);border:1px solid var(--border);color:var(--text-dim);font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:'Crimson Pro',serif;transition:all .1s}
.bay-item .bi-controls button:hover{border-color:var(--accent);color:var(--accent)}
.bay-item .bi-remove{background:transparent;border:none;color:var(--text-dim);cursor:pointer;font-size:13px;padding:2px 6px;margin-left:4px}
.bay-item .bi-remove:hover{color:var(--red-bright)}
@keyframes snapIn{0%{transform:translateY(-8px) scale(1.03);opacity:.6}40%{transform:translateY(2px) scale(.98);opacity:1}70%{transform:translateY(-1px) scale(1.005)}100%{transform:translateY(0) scale(1)}}
.bay-item.snap-in,.weapon-bay-item.snap-in{animation:snapIn .3s ease-out}
@keyframes impactFlash{0%{box-shadow:inset 0 0 20px rgba(196,164,74,.4)}100%{box-shadow:inset 0 0 0 rgba(196,164,74,0)}}
.drop-bay.impact{animation:impactFlash .35s ease-out}
.cat-header{font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;padding:8px 0 4px;margin-top:8px}
.cat-header:first-child{margin-top:0}
.weapon-drag-item{display:flex;align-items:center;gap:10px;padding:10px 12px;margin-bottom:5px;background:var(--bg-card);border:1px solid var(--border);cursor:grab;transition:transform .15s,box-shadow .15s,border-color .15s;user-select:none;touch-action:none;-webkit-user-select:none}
.weapon-drag-item:hover{border-color:var(--border-light)}.weapon-drag-item:active{cursor:grabbing}
.weapon-drag-item.dragging{opacity:.5;transform:scale(.97)}
.weapon-drag-item .wdi-info{flex:1}.weapon-drag-item .wdi-name{font-weight:600;color:var(--text-bright);font-size:13px}
.weapon-drag-item .wdi-stats{font-size:11px;color:var(--text-dim)}
.weapon-drag-item .wdi-meta{text-align:right;min-width:55px}
.weapon-drag-item .wdi-mods{font-weight:700;color:var(--accent);font-size:12px}
.weapon-drag-item .wdi-price{font-size:10px;color:var(--text-dim)}
.weapon-bay-item{display:flex;align-items:center;gap:8px;padding:10px 12px;margin-bottom:4px;background:var(--bg-card);border:1px solid var(--accent-dim)}
.weapon-bay-item .wbi-info{flex:1}.weapon-bay-item .wbi-name{font-weight:600;color:var(--accent);font-size:13px}
.weapon-bay-item .wbi-stats{font-size:11px;color:var(--text-dim)}
.weapon-bay-item .wbi-mount{font-size:10px;color:var(--text-dim);font-style:italic}
.weapon-bay-item select{background:var(--bg-deep);border:1px solid var(--border);color:var(--text);padding:2px 6px;font-family:'Crimson Pro',serif;font-size:11px;cursor:pointer}
.weapon-bay-item .wbi-remove{background:transparent;border:none;color:var(--text-dim);cursor:pointer;font-size:13px;padding:2px 6px}
.weapon-bay-item .wbi-remove:hover{color:var(--red-bright)}
.stat-block{background:var(--bg-deep);border:1px solid var(--accent-dim);padding:24px;font-size:14px;line-height:1.8;max-width:700px}
.stat-block .sb-name{font-family:'Cinzel',serif;font-size:22px;color:var(--accent);letter-spacing:3px;text-align:center;margin-bottom:2px}
.stat-block .sb-type{text-align:center;color:var(--text-dim);font-style:italic;font-size:13px;margin-bottom:14px}
.stat-block .sb-divider{border:none;border-top:1px solid var(--accent-dim);margin:10px 0}
.stat-block .sb-line{margin-bottom:2px}.stat-block .sb-label{color:var(--accent);font-weight:700}
.stat-block .sb-notes{color:var(--text-dim);font-style:italic;margin-top:8px;font-size:13px;line-height:1.5}
.rules-ref{max-width:700px}.rules-ref h3{font-family:'Cinzel',serif;font-size:14px;color:var(--accent);letter-spacing:1.5px;margin:16px 0 8px}
.rules-ref h3:first-child{margin-top:0}.rules-ref p{margin-bottom:8px;font-size:14px;color:var(--text)}
.rules-ref .rule-key{color:var(--accent);font-weight:700}
.rules-ref .rule-note{color:var(--text-dim);font-style:italic;font-size:13px}
.saved-list{display:flex;flex-direction:column;gap:4px}
.saved-item{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);cursor:pointer;transition:all .15s}
.saved-item:hover{border-color:var(--accent)}
.saved-item .si-name{flex:1;font-weight:600;color:var(--text-bright);font-size:14px}
.saved-item .si-chassis{font-size:12px;color:var(--text-dim)}
.saved-item .si-delete{background:transparent;border:none;color:var(--text-dim);cursor:pointer;font-size:14px;padding:2px 6px}
.saved-item .si-delete:hover{color:var(--red-bright)}
.empty-state{text-align:center;padding:40px 20px;color:var(--text-dim)}.empty-state p{font-size:13px;font-style:italic}
.sidebar-footer{margin-top:auto;padding:10px 16px;border-top:1px solid var(--border);font-size:11px;color:var(--text-dim);text-align:center;font-style:italic}
.mount-tabs{display:flex;gap:0;margin-bottom:10px}
.mount-tab{padding:6px 14px;font-family:'Cinzel',serif;font-size:11px;letter-spacing:1px;color:var(--text-dim);cursor:pointer;border:1px solid var(--border);background:transparent;text-transform:uppercase;transition:all .15s}
.mount-tab:first-child{border-radius:3px 0 0 3px}.mount-tab:last-child{border-radius:0 3px 3px 0}
.mount-tab:not(:first-child){border-left:none}
.mount-tab:hover{color:var(--text)}.mount-tab.active{background:var(--accent-glow);color:var(--accent);border-color:var(--accent)}
</style>
</head>
<body>
<div id="toolNavContainer"></div>
<div class="app">
  <div class="sidebar">
    <div class="sidebar-header"><h2>Power Armour Forge</h2><div class="field-row"><input type="text" id="suitName" placeholder="Name your suit..." value="Untitled Suit"></div></div>
    <div class="sidebar-section"><h3>Frame</h3><div class="chassis-grid" id="chassisGrid"></div></div>
    <div class="sidebar-section"><h3>Statistics</h3><div class="stats-grid" id="statsGrid"></div><div class="mods-remaining" id="modsRemaining"></div><div class="cost-display" id="costDisplay"></div></div>
    <div class="sidebar-section" style="flex:1;overflow-y:auto"><h3>Saved Suits</h3><div class="saved-list" id="savedList"></div></div>
    <div class="sidebar-footer">Savage Worlds &copy; Pinnacle Entertainment Group. &copy; DiceForge Studios Ltd.</div>
  </div>
  <div class="main">
    <div class="header"><div><div class="header-brand">DiceForge Studios</div><div class="header-title">Power Armour Forge</div></div><div class="header-spacer"></div><button class="header-btn" onclick="newSuit()">New</button><button class="header-btn" onclick="saveSuit()">Save</button><button class="header-btn primary" onclick="switchTab('output')">Export</button></div>
    <div class="tab-bar">
      <div class="tab active" data-tab="mods" onclick="switchTab('mods')">Modifications</div>
      <div class="tab" data-tab="weapons" onclick="switchTab('weapons')">Weapon Systems</div>
      <div class="tab" data-tab="output" onclick="switchTab('output')">Stat Block</div>
      <div class="tab" data-tab="rules" onclick="switchTab('rules')">Rules Reference</div>
    </div>
    <div class="content">
      <div class="panel active" id="panel-mods"><div class="dnd-layout"><div class="dnd-column"><h3>Available Modifications</h3><div id="modCatalogue"></div></div><div class="dnd-column"><h3>Installed Systems</h3><div class="drop-bay" id="modBay"><div class="empty-bay">Drag modifications here to install them</div></div></div></div></div>
      <div class="panel" id="panel-weapons"><div class="dnd-layout"><div class="dnd-column"><h3>Vehicular Weapons</h3><div id="weaponCatalogue"></div></div><div class="dnd-column"><h3>Weapon Hardpoints</h3><div class="mount-tabs"><div class="mount-tab active" data-mount="pintle" onclick="switchMount('pintle')">Pintle</div><div class="mount-tab" data-mount="fixed" onclick="switchMount('fixed')">Fixed (&frac12; Mods)</div></div><div class="drop-bay" id="weaponBay"><div class="empty-bay">Drag weapons here to mount them</div></div></div></div></div>
      <div class="panel" id="panel-output"></div>
      <div class="panel" id="panel-rules"><div class="rules-ref">
        <h3>Power Armour Basics</h3>
        <p><span class="rule-key">Armor:</span> All power armour provides Heavy Armor (unless the Light Duty mod is taken). Users may only wear light clothing or a skinsuit within.</p>
        <p><span class="rule-key">HUD:</span> Integrated optics negate up to 4 points of Illumination penalties and add +2 to sight-based Notice totals when rolled as an action.</p>
        <p><span class="rule-key">Comms:</span> Built-in communications suite, 20-mile range.</p>
        <p><span class="rule-key">Sealed:</span> Hermetically sealed against cold, heat, pathogens, gas, and radiation. Provides heating, cooling, and oxygen.</p>
        <p><span class="rule-key">Strength:</span> The suit&rsquo;s Strength replaces the wearer&rsquo;s.</p>
        <p><span class="rule-key">Pace:</span> Characters use the suit&rsquo;s Pace with a d6 running die. Servo-assisted movement ignores Hindrances that reduce Pace &mdash; but also Edges that increase it.</p>
        <p><span class="rule-key">Weight:</span> No encumbrance while powered. Without power: 100 lbs &times; Size, Min Str d12+Size.</p>
        <p><span class="rule-key">Energy:</span> Three days of operation. Batteries replaced/recharged in one hour from a high-energy source.</p>
        <h3>Trait Penalties</h3>
        <p>Hacking, Repair, Thievery, or arcane skills at &minus;4 (heavy gloves). Persuasion and Performance at &minus;4 while helmet is worn. Stealth at &minus;2 (negated by Stealth System).</p>
        <h3>Damage &amp; Critical Hits</h3>
        <p>When Wounded, the suit is breached and a Critical Hit is rolled: 2 = Shut Down, 3 = Weapon, 4&ndash;5 = Locomotion (&minus;2 Pace), 6&ndash;8 = Frame (no effect), 9&ndash;10 = Strength Servos (&minus;2 steps), 11 = Power (see Unpowered), 12 = Structural Integrity (&minus;4 Armor).</p>
        <h3>Weapon Mounts</h3>
        <p><span class="rule-key">Pintle:</span> Standard mount; full Mod cost. 360&deg; arc of fire.</p>
        <p><span class="rule-key">Fixed:</span> 45&deg; arc only. Reduces Mod cost by half (round up).</p>
        <p><span class="rule-key">Linked:</span> Dual linked: +1 hit, +2 damage. Quad linked: +2 hit, +4 damage. Each additional linked weapon costs +1 Mod.</p>
        <p><span class="rule-key">Integrated Gear:</span> Up to 10 lbs of gear built into the suit (1 Mod each). Can&rsquo;t be dropped or disarmed.</p>
        <p class="rule-note">References the Savage Worlds Sci-Fi Companion. Always defer to your physical rulebook.</p>
      </div></div>
    </div>
  </div>
</div>
<script>
// ‚ïê‚ïê‚ïê AUDIO ‚ïê‚ïê‚ïê
var AudioEngine={ctx:null,
init:function(){if(!this.ctx)this.ctx=new(window.AudioContext||window.webkitAudioContext)();if(this.ctx.state==='suspended')this.ctx.resume()},
clunk:function(){this.init();var c=this.ctx;if(c.state==='suspended')c.resume();var n=c.currentTime;var buf=c.createBuffer(1,c.sampleRate*.02,c.sampleRate);var d=buf.getChannelData(0);for(var i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,12);var ns=c.createBufferSource();ns.buffer=buf;var bp=c.createBiquadFilter();bp.type='bandpass';bp.frequency.value=4200;bp.Q.value=2;var o1=c.createOscillator();o1.type='sine';o1.frequency.value=820;var g1=c.createGain();g1.gain.setValueAtTime(.06,n);g1.gain.exponentialRampToValueAtTime(.001,n+.06);var o2=c.createOscillator();o2.type='sine';o2.frequency.value=2200;var g2=c.createGain();g2.gain.setValueAtTime(.02,n);g2.gain.exponentialRampToValueAtTime(.001,n+.03);var m=c.createGain();m.gain.value=.3;ns.connect(bp).connect(m);o1.connect(g1).connect(m);o2.connect(g2).connect(m);m.connect(c.destination);ns.start(n);ns.stop(n+.02);o1.start(n);o1.stop(n+.08);o2.start(n);o2.stop(n+.05)},
click:function(){this.init();var c=this.ctx;if(c.state==='suspended')c.resume();var n=c.currentTime;var o=c.createOscillator();o.type='sine';o.frequency.value=600;var g=c.createGain();g.gain.setValueAtTime(.08,n);g.gain.exponentialRampToValueAtTime(.001,n+.04);o.connect(g).connect(c.destination);o.start(n);o.stop(n+.05)},
remove:function(){this.init();var c=this.ctx;if(c.state==='suspended')c.resume();var n=c.currentTime;var o=c.createOscillator();o.type='triangle';o.frequency.setValueAtTime(500,n);o.frequency.exponentialRampToValueAtTime(200,n+.1);var g=c.createGain();g.gain.setValueAtTime(.1,n);g.gain.exponentialRampToValueAtTime(.001,n+.12);o.connect(g).connect(c.destination);o.start(n);o.stop(n+.15)}};

// ‚ïê‚ïê‚ïê CANONICAL SFC DATA ‚ïê‚ïê‚ïê
// Power Armor Frames (SFC p122)
// Size 1: Armor +8 (max 12), Pace 12, Str d12, Mods 3, Weight 100lbs, Cost $50K
// Size 2: Armor +10 (max 16), Pace 6, Str d12+1, Mods 6, Weight 200lbs, Cost $100K
// Size 3: Armor +12 (max 20), Pace 4, Str d12+2, Mods 9, Weight 300lbs, Cost $150K
// Size 4+ = walkers (separate tool)
var FRAMES=[
  {id:'s1',name:'Size 1 (Light)',size:1,armor:8,maxArmor:12,pace:12,str:'d12',mods:3,weight:100,cost:50000},
  {id:'s2',name:'Size 2 (Standard)',size:2,armor:10,maxArmor:16,pace:6,str:'d12+1',mods:6,weight:200,cost:100000},
  {id:'s3',name:'Size 3 (Heavy)',size:3,armor:12,maxArmor:20,pace:4,str:'d12+2',mods:9,weight:300,cost:150000}
];

// Modifications (SFC pp122-125) ‚Äî canonical Mods(Max) and Cost
// Negative values for mods = gives slots back
var MODS=[
  // NEGATIVE QUALITIES
  {id:'battered',name:'Battered',cat:'Negative Qualities',maxTimes:2,modsCost:-2,costFn:function(s){return -5000*s},desc:'Reduce Armor by 2 each time taken.'},
  {id:'exposed',name:'Exposed Pilot',cat:'Negative Qualities',maxTimes:1,modsCost:-2,costFn:function(s){return -10000*s},desc:'Pilot targetable at -4 Called Shot, no Armor bonus.'},
  {id:'finicky',name:'Finicky',cat:'Negative Qualities',maxTimes:2,modsCost:-2,costFn:function(s){return -5000*s},desc:'Repair at -2 (-4 if taken twice).'},
  {id:'fragile',name:'Fragile',cat:'Negative Qualities',maxTimes:1,modsCost:-2,costFn:function(s){return -10000*s},desc:'Critical Hit when Shaken (not just Wounded).'},
  {id:'inefficient',name:'Inefficient',cat:'Negative Qualities',maxTimes:2,modsCost:-1,costFn:function(s){return -5000*s},desc:'Reduce operating days by 1.'},
  {id:'light_duty',name:'Light Duty',cat:'Negative Qualities',maxTimes:1,modsCost:-2,costFn:function(s){return -10000*s},desc:'Armor no longer counts as Heavy Armor.'},
  {id:'reduced_pace',name:'Reduced Pace',cat:'Negative Qualities',maxTimes:2,modsCost:-2,costFn:function(s){return -10000*s},desc:'-2 Pace (min 4). Cannot combine with Increased Pace.'},
  {id:'reduced_str',name:'Reduced Strength',cat:'Negative Qualities',maxTimes:1,modsCost:-2,costFn:function(s){return -10000*s},desc:'Use pilot\'s Str instead of suit\'s. Cannot combine with Strength.'},
  // CORE SYSTEMS
  {id:'command',name:'Command Suite',cat:'Core Systems',maxTimes:1,modsCost:1,costFn:function(){return 10000},desc:'See/hear through linked allies. Extend Command Range.'},
  {id:'entangled',name:'Entangled Comms',cat:'Core Systems',maxTimes:'U',modsCost:1,costFn:function(){return 50000},desc:'Quantum-entangled comms. Unlimited range, unjammable.'},
  {id:'scanner',name:'Scanner',cat:'Core Systems',maxTimes:2,modsCost:1,costFn:function(){return 5000},desc:'Detect matter/energy 50yds (500yds if taken twice). +2 Notice.'},
  // DEFENSIVE SYSTEMS
  {id:'amecm',name:'AM/ECM',cat:'Defensive Systems',maxTimes:1,modsCost:1,costFn:function(s){return 5000*s},desc:'+2 to Evasion vs Guided Weapons.'},
  {id:'armor',name:'Armor',cat:'Defensive Systems',maxTimes:'frame',modsCost:1,costFn:function(s){return 5000*s},desc:'+2 Armor per application (up to frame max). Heavy Armor.'},
  {id:'ballistic',name:'Ballistic Protection',cat:'Defensive Systems',maxTimes:1,modsCost:1,costFn:function(){return 500},desc:'Slugthrower bullets reduce damage by 4.'},
  {id:'emp_shield',name:'EMP Shielding',cat:'Defensive Systems',maxTimes:1,modsCost:1,costFn:function(s){return 5000*s},desc:'Ignore 2 points of -4 EMP penalty.'},
  {id:'energy_skin',name:'Energy Skin',cat:'Defensive Systems',maxTimes:1,modsCost:0,costFn:function(s){return 5000*s},desc:'Laser damage reduced by 4. -2 Stealth vs vision.'},
  {id:'repair_nano',name:'Repair Nanomachines',cat:'Defensive Systems',maxTimes:1,modsCost:3,costFn:function(s){return 50000*s},desc:'d6 Repair as limited action. 3 hits max per 24hrs.'},
  {id:'self_seal',name:'Self-Sealing',cat:'Defensive Systems',maxTimes:1,modsCost:1,costFn:function(){return 10000},desc:'Auto-seal breaches on Wound. No effect on 3+ Wounds.'},
  {id:'sensor_array',name:'Sensor Array',cat:'Defensive Systems',maxTimes:1,modsCost:4,costFn:function(){return 25000},desc:'Scan 1 light-year (space) or LOS (planet). Full round, Vulnerable.'},
  {id:'shields',name:'Shields',cat:'Defensive Systems',maxTimes:1,modsCost:'half',costFn:function(s){return 50000*s},desc:'Charges = Size. Soak with Electronics (free action). Recharge 10 min.'},
  {id:'stealth',name:'Stealth System',cat:'Defensive Systems',maxTimes:1,modsCost:'size',costFn:function(s){return 50000*s},desc:'-2 Stealth penalty negated. -4 to lock on with Electronics.'},
  {id:'strength',name:'Strength',cat:'Defensive Systems',maxTimes:5,modsCost:2,costFn:function(s){return 5000*s},desc:'+1 die type to suit Strength.'},
  {id:'trauma',name:'Trauma Pack',cat:'Defensive Systems',maxTimes:1,modsCost:1,costFn:function(){return 10000},desc:'Ignore 2 Wound/Fatigue penalties, +2 vs Bleeding Out. 1hr duration.'},
  {id:'toughness',name:'Toughness',cat:'Defensive Systems',maxTimes:5,modsCost:1,costFn:function(s){return 5000*s},desc:'+1 Toughness.'},
  // LOCOMOTION
  {id:'energy_pod',name:'Energy Pod',cat:'Locomotion',maxTimes:'U',modsCost:'half',costFn:function(s){return 5000*s},desc:'+6 days operating time.'},
  {id:'flight',name:'Flight',cat:'Locomotion',maxTimes:3,modsCost:'half',costFn:function(s){return 10000*s},desc:'VTOL Pace 6. 2nd: 60 MPH. 3rd: 200 MPH.'},
  {id:'inc_pace',name:'Increased Pace',cat:'Locomotion',maxTimes:3,modsCost:1,costFn:function(){return 5000},desc:'+2 Pace, running die +1 step. Cannot combine with Reduced Pace.'},
  {id:'jump_pack',name:'Jump Pack',cat:'Locomotion',maxTimes:1,modsCost:1,costFn:function(){return 10000},desc:'Leap 8" horiz / 4" vert. +2 damage on Wild Attack + leap.'},
  {id:'mag_pads',name:'Magnetic Pads',cat:'Locomotion',maxTimes:1,modsCost:1,costFn:function(){return 5000},desc:'Walk on metal surfaces at half Pace (full at Dev II).'},
  {id:'pressure',name:'Pressure Jets',cat:'Locomotion',maxTimes:2,modsCost:'half',costFn:function(s){return 5000*s},desc:'Swim at Pace, 500ft depth. 2nd: 25 MPH, 3000ft.'},
  {id:'wall_walk',name:'Wall Walker',cat:'Locomotion',maxTimes:1,modsCost:1,costFn:function(){return 5000},desc:'Move on vertical surfaces at half Pace.'},
  // OFFENSIVE SYSTEMS
  {id:'anti_pers',name:'Anti-Personnel Pack',cat:'Offensive Systems',maxTimes:1,modsCost:1,costFn:function(){return 5000},desc:'LBT 4d6 damage (suit takes 2d6). One use, reload with mine.'},
  {id:'claws',name:'Claws',cat:'Offensive Systems',maxTimes:2,modsCost:1,costFn:function(){return 5000},desc:'Str+d4 (Str+d6 AP 2 if taken twice). Cannot use claw hand otherwise.'},
  {id:'hw_brace',name:'Heavy Weapon Brace',cat:'Offensive Systems',maxTimes:1,modsCost:1,costFn:function(){return 50000},desc:'Deploy: Vulnerable, can\'t move, counts as Size +5 for firing.'},
  {id:'int_gear',name:'Integrated Gear',cat:'Offensive Systems',maxTimes:'U',modsCost:1,costFn:function(){return 5000},desc:'Up to 10 lbs gear built in. Can\'t be dropped/disarmed.'},
  {id:'stabilizer',name:'Stabilizer',cat:'Offensive Systems',maxTimes:1,modsCost:1,costFn:function(){return 5000},desc:'Negate Unstable Platform, Recoil, running penalties.'},
  {id:'targeting',name:'Targeting System',cat:'Offensive Systems',maxTimes:1,modsCost:1,costFn:function(){return 25000},desc:'-2 Shooting penalties (Called Shot, Cover, Range, Scale, Speed).'}
];

// Vehicular weapons suitable for PA mounting (SFC pp58-64)
// Min Size column determines if weapon can mount on this frame
var WEAPONS=[
  // Slugthrowers (not HW except Heavy)
  {id:'slug_light',name:'Light Slugthrower',cat:'Slugthrowers',range:'30/60/120',damage:'2d8',ap:2,rof:3,shots:200,minSize:1,mods:1,cost:700,notes:'Point Defense, Reaction Fire, not HW'},
  {id:'slug_med',name:'Medium Slugthrower',cat:'Slugthrowers',range:'30/60/120',damage:'2d8+1',ap:2,rof:3,shots:100,minSize:2,mods:1,cost:1000,notes:'Point Defense, Reaction Fire, not HW'},
  {id:'slug_heavy',name:'Heavy Slugthrower',cat:'Slugthrowers',range:'50/100/200',damage:'2d10 (I)',ap:4,rof:3,shots:50,minSize:3,mods:1,cost:2000,notes:'Point Defense, Reaction Fire'},
  {id:'minigun',name:'Minigun',cat:'Slugthrowers',range:'50/100/200',damage:'2d8+1 (I)',ap:2,rof:5,shots:2000,minSize:3,mods:1,cost:10000,notes:'Min RoF 3, Point Defense, Reaction Fire'},
  // Autocannons
  {id:'ac_light',name:'Light Autocannon',cat:'Autocannons',range:'50/100/200',damage:'3d8 (I)',ap:4,rof:4,shots:100,minSize:2,mods:1,cost:10000,notes:'Min RoF 2, Point Defense, Reaction Fire'},
  {id:'ac_med',name:'Medium Autocannon',cat:'Autocannons',range:'50/100/200',damage:'4d8 (II)',ap:6,rof:4,shots:80,minSize:8,mods:2,cost:20000,notes:'Min RoF 2'},
  // Lasers
  {id:'laser_gat',name:'Gatling Laser',cat:'Lasers',range:'50/100/200',damage:'3d6+4 (I)',ap:4,rof:4,shots:80,minSize:1,mods:1,cost:3000,notes:'Cauterize, Overcharge, Pt Def, Rxn Fire'},
  {id:'laser_light',name:'Light Laser',cat:'Lasers',range:'150/300/600',damage:'2d10 (II)',ap:10,rof:3,shots:80,minSize:2,mods:1,cost:20000,notes:'Cauterize, Overcharge, Reaction Fire'},
  {id:'laser_med',name:'Medium Laser',cat:'Lasers',range:'150/300/600',damage:'3d10 (III)',ap:20,rof:2,shots:60,minSize:4,mods:3,cost:50000,notes:'Cauterize, Overcharge'},
  // Cannons
  {id:'cannon_light',name:'Light Cannon',cat:'Cannons',range:'50/100/200',damage:'3d10 (II)',ap:5,rof:1,shots:80,minSize:1,mods:1,cost:15000,notes:'Reaction Fire, SBT'},
  {id:'cannon_med',name:'Medium Cannon',cat:'Cannons',range:'75/150/300',damage:'4d10 (III)',ap:10,rof:1,shots:60,minSize:2,mods:3,cost:30000,notes:'SBT'},
  // Grenade Launcher
  {id:'grenade',name:'Grenade Launcher',cat:'Launchers',range:'24/48/96',damage:'3d6 (I)',ap:0,rof:3,shots:12,minSize:0,mods:1,cost:2600,notes:'MBT, includes space for 1 reload'},
  // Flamethrower
  {id:'flamer',name:'Heavy Flamethrower',cat:'Flamethrowers',range:'Cone',damage:'3d12 (I)',ap:0,rof:1,shots:30,minSize:1,mods:1,cost:5000,notes:'Cauterize, Incendiary, Cone or MBT 18"'}
];

// ‚ïê‚ïê‚ïê STATE & DRAG-DROP ‚ïê‚ïê‚ïê
var state={name:'Untitled Suit',frameId:'s1',mods:{},weapons:[],currentMount:'pintle',savedSuits:[]};
var dragState={active:false,type:null,id:null,ghost:null};

function getXY(e){if(e.touches&&e.touches.length)return{x:e.touches[0].clientX,y:e.touches[0].clientY};if(e.changedTouches&&e.changedTouches.length)return{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY};return{x:e.clientX,y:e.clientY}}
function startDrag(e,type,id,label){e.preventDefault();AudioEngine.init();var pt=getXY(e);dragState={active:true,type:type,id:id,ghost:null};var ghost=document.createElement('div');ghost.className='drag-ghost';ghost.textContent=label;ghost.style.left=pt.x+'px';ghost.style.top=pt.y+'px';document.body.appendChild(ghost);dragState.ghost=ghost;var src=e.target.closest('.drag-item')||e.target.closest('.weapon-drag-item');if(src)src.classList.add('dragging');document.addEventListener('mousemove',onDragMove);document.addEventListener('mouseup',onDragEnd);document.addEventListener('touchmove',onDragMove,{passive:false});document.addEventListener('touchend',onDragEnd);document.addEventListener('touchcancel',onDragEnd)}
function onDragMove(e){if(!dragState.active||!dragState.ghost)return;if(e.cancelable)e.preventDefault();var pt=getXY(e);var bayId=dragState.type==='mod'?'modBay':'weaponBay';var bay=document.getElementById(bayId);var gx=pt.x,gy=pt.y;if(bay){var r=bay.getBoundingClientRect();var inside=gx>=r.left&&gx<=r.right&&gy>=r.top&&gy<=r.bottom;var near=gx>=r.left-80&&gx<=r.right+80&&gy>=r.top-80&&gy<=r.bottom+80;bay.classList.toggle('drag-over',inside);dragState.ghost.classList.toggle('near-target',near&&!inside);if(near&&!inside){gx+=(r.left+r.width/2-gx)*.08;gy+=(r.top+r.height/2-gy)*.08}}dragState.ghost.style.left=gx+'px';dragState.ghost.style.top=gy+'px'}
function onDragEnd(e){document.removeEventListener('mousemove',onDragMove);document.removeEventListener('mouseup',onDragEnd);document.removeEventListener('touchmove',onDragMove);document.removeEventListener('touchend',onDragEnd);document.removeEventListener('touchcancel',onDragEnd);if(dragState.ghost)dragState.ghost.remove();document.querySelectorAll('.dragging').forEach(function(el){el.classList.remove('dragging')});var pt=getXY(e);var bayId=dragState.type==='mod'?'modBay':'weaponBay';var bay=document.getElementById(bayId);if(bay){var r=bay.getBoundingClientRect();if(pt.x>=r.left&&pt.x<=r.right&&pt.y>=r.top&&pt.y<=r.bottom){if(dragState.type==='mod')dropMod(dragState.id);else if(dragState.type==='weapon')dropWeapon(dragState.id);bay.classList.remove('impact');void bay.offsetWidth;bay.classList.add('impact')}bay.classList.remove('drag-over')}dragState={active:false,type:null,id:null,ghost:null}}

function dropMod(id){var m=MODS.find(function(x){return x.id===id});var max=m.maxTimes==='U'?99:m.maxTimes==='frame'?getMaxArmorTakes():m.maxTimes==='half'?99:m.maxTimes;var cur=state.mods[id]||0;
  if(id==='inc_pace'&&(state.mods['reduced_pace']||0)>0)return;
  if(id==='reduced_pace'&&(state.mods['inc_pace']||0)>0)return;
  if(id==='strength'&&(state.mods['reduced_str']||0)>0)return;
  if(id==='reduced_str'&&(state.mods['strength']||0)>0)return;
  if(cur<max){state.mods[id]=cur+1;AudioEngine.clunk();renderModBay(id);renderStats();renderOutput()}}
function dropWeapon(id){var w=WEAPONS.find(function(x){return x.id===id});var f=getFrame();if(w.minSize>f.size)return;// can't mount weapon too large
  state.weapons.push({weaponId:id,mount:state.currentMount});AudioEngine.clunk();renderWeaponBay(id);renderStats();renderOutput()}

function getFrame(){return FRAMES.find(function(f){return f.id===state.frameId})}
function getMaxArmorTakes(){var f=getFrame();return Math.floor((f.maxArmor-f.armor)/2)}

// ‚ïê‚ïê‚ïê CALCULATIONS ‚ïê‚ïê‚ïê
function getModCost(m,s){// s = frame size
  if(m.modsCost==='half')return Math.ceil(s/2);
  if(m.modsCost==='size')return s;
  return m.modsCost}
function calcTotalModsUsed(){var t=0,f=getFrame();
  for(var id in state.mods){var m=MODS.find(function(x){return x.id===id});var mc=getModCost(m,f.size);if(mc>0)t+=mc*state.mods[id]}
  state.weapons.forEach(function(w){var wp=WEAPONS.find(function(x){return x.id===w.weaponId});if(wp){var mc=wp.mods;if(w.mount==='fixed')mc=Math.ceil(mc/2);t+=mc}});return t}
function calcModsGained(){var t=0,f=getFrame();
  for(var id in state.mods){var m=MODS.find(function(x){return x.id===id});var mc=getModCost(m,f.size);if(mc<0)t+=Math.abs(mc)*state.mods[id]}
  return t}
function calcStr(){var f=getFrame();if(state.mods['reduced_str'])return 'Pilot\'s';
  var steps=['d4','d6','d8','d10','d12','d12+1','d12+2','d12+3','d12+4','d12+5'];
  var idx=steps.indexOf(f.str);var boost=state.mods['strength']||0;return steps[Math.min(idx+boost,steps.length-1)]}
function calcArmor(){var f=getFrame(),a=f.armor;if(state.mods['armor'])a+=2*state.mods['armor'];if(state.mods['battered'])a-=2*state.mods['battered'];return Math.max(0,Math.min(a,f.maxArmor))}
function calcToughness(){var t=0;if(state.mods['toughness'])t+=state.mods['toughness'];return t}
function calcPace(){var f=getFrame(),p=f.pace;if(state.mods['inc_pace'])p+=2*state.mods['inc_pace'];if(state.mods['reduced_pace'])p-=2*state.mods['reduced_pace'];return Math.max(4,p)}
function calcRunDie(){var base=6;if(state.mods['inc_pace']){var n=state.mods['inc_pace'];base=n>=3?12:n===2?10:8}return 'd'+base}
function calcCost(){var f=getFrame(),cost=f.cost;
  for(var id in state.mods){var m=MODS.find(function(x){return x.id===id});cost+=m.costFn(f.size)*state.mods[id]}
  state.weapons.forEach(function(w){var wp=WEAPONS.find(function(x){return x.id===w.weaponId});if(wp)cost+=wp.cost});return cost}

// ‚ïê‚ïê‚ïê INIT & RENDER ‚ïê‚ïê‚ïê
function init(){loadSaved();renderFrames();renderModCatalogue();renderModBay();renderWeaponCatalogue();renderWeaponBay();renderStats();renderSaved();renderOutput();
  document.getElementById('suitName').addEventListener('input',function(e){state.name=e.target.value||'Untitled Suit'})}
function renderFrames(){document.getElementById('chassisGrid').innerHTML=FRAMES.map(function(f){
  return '<div class="chassis-btn '+(f.id===state.frameId?'active':'')+'" onclick="selectFrame(\''+f.id+'\')"><span>'+f.name+'</span><span class="chassis-size">Str '+f.str+' &middot; Armor +'+f.armor+' &middot; '+f.mods+' Mods</span></div>'}).join('')}
function selectFrame(id){state.frameId=id;state.mods={};state.weapons=[];renderFrames();renderModCatalogue();renderModBay();renderWeaponCatalogue();renderWeaponBay();renderStats();renderOutput()}

function renderModCatalogue(){var el=document.getElementById('modCatalogue'),cats={},f=getFrame();
  MODS.forEach(function(m){if(!cats[m.cat])cats[m.cat]=[];cats[m.cat].push(m)});
  var h='';for(var cat in cats){h+='<div class="cat-header">'+cat+'</div>';
    cats[cat].forEach(function(m){var mc=getModCost(m,f.size);var price=m.costFn(f.size);
      h+='<div class="drag-item" onmousedown="startDrag(event,\'mod\',\''+m.id+'\',\''+m.name+'\')" ontouchstart="startDrag(event,\'mod\',\''+m.id+'\',\''+m.name+'\')">'
        +'<span class="drag-handle">&#x2807;</span>'
        +'<div class="di-info"><div class="di-name">'+m.name+'</div><div class="di-desc">'+m.desc+'</div></div>'
        +'<div class="di-meta"><div class="di-mods">'+(mc>0?mc+' mod'+(mc>1?'s':''):mc<0?'+'+Math.abs(mc)+' mod'+(Math.abs(mc)>1?'s':''):'&mdash;')+'</div>'
        +'<div class="di-price">'+(price>=0?'$'+fmtN(price):'-$'+fmtN(Math.abs(price)))+'</div></div></div>'})}
  el.innerHTML=h}

function renderModBay(animId){var bay=document.getElementById('modBay'),f=getFrame();
  var inst=[];for(var k in state.mods){if(state.mods[k]>0)inst.push([k,state.mods[k]])}
  if(!inst.length){bay.innerHTML='<div class="empty-bay">Drag modifications here to install them</div>';return}
  bay.innerHTML=inst.map(function(pair){var id=pair[0],ct=pair[1];
    var m=MODS.find(function(x){return x.id===id});var mc=getModCost(m,f.size)*ct;var tp=m.costFn(f.size)*ct;
    return '<div class="bay-item '+(id===animId?'snap-in':'')+'">'
      +'<div class="bi-info"><div class="bi-name">'+m.name+'</div>'
      +'<div class="bi-detail">'+(mc>0?mc+' mods':mc<0?'Grants '+Math.abs(mc)+' mods':'0 mods')+' &middot; '+(tp>=0?'$'+fmtN(tp):'-$'+fmtN(Math.abs(tp)))+'</div></div>'
      +'<div class="bi-controls"><button onclick="modDec(\''+id+'\')">&minus;</button><span class="bi-count">'+ct+'</span><button onclick="modInc(\''+id+'\')">+</button></div>'
      +'<span class="bi-remove" onclick="modRemoveAll(\''+id+'\')">&times;</span></div>'}).join('')}
function modInc(id){dropMod(id);AudioEngine.click()}
function modDec(id){var cur=state.mods[id]||0;if(cur>0){state.mods[id]=cur-1;if(!state.mods[id])delete state.mods[id];AudioEngine.click();renderModBay();renderStats();renderOutput()}}
function modRemoveAll(id){delete state.mods[id];AudioEngine.remove();renderModBay();renderStats();renderOutput()}
// ‚ïê‚ïê‚ïê WEAPONS ‚ïê‚ïê‚ïê
function renderWeaponCatalogue(){var f=getFrame();
  var cats={};WEAPONS.forEach(function(w){if(!cats[w.cat])cats[w.cat]=[];cats[w.cat].push(w)});
  var h='';for(var cat in cats){h+='<div class="cat-header">'+cat+'</div>';
    cats[cat].forEach(function(w){var avail=w.minSize<=f.size;
      h+='<div class="weapon-drag-item" style="'+(avail?'':'opacity:.4;pointer-events:none')+'" onmousedown="startDrag(event,\'weapon\',\''+w.id+'\',\''+w.name+'\')" ontouchstart="startDrag(event,\'weapon\',\''+w.id+'\',\''+w.name+'\')">'
        +'<span class="drag-handle" style="color:var(--text-dim);font-size:14px;opacity:.4">&#x2807;</span>'
        +'<div class="wdi-info"><div class="wdi-name">'+w.name+(avail?'':' (Min Size '+w.minSize+')')+'</div>'
        +'<div class="wdi-stats">'+w.range+' &middot; '+w.damage+' &middot; AP '+w.ap+' &middot; RoF '+w.rof+'</div>'
        +'<div class="wdi-stats">'+w.notes+'</div></div>'
        +'<div class="wdi-meta"><div class="wdi-mods">'+w.mods+' mod'+(w.mods>1?'s':'')+'</div>'
        +'<div class="wdi-price">$'+fmtN(w.cost)+'</div></div></div>'})}
  document.getElementById('weaponCatalogue').innerHTML=h}

function renderWeaponBay(animId){var bay=document.getElementById('weaponBay');
  if(!state.weapons.length){bay.innerHTML='<div class="empty-bay">Drag weapons here to mount them</div>';return}
  bay.innerHTML=state.weapons.map(function(w,i){
    var wp=WEAPONS.find(function(x){return x.id===w.weaponId});if(!wp)return '';
    var isNew=w.weaponId===animId&&i===state.weapons.length-1;
    var mc=wp.mods;if(w.mount==='fixed')mc=Math.ceil(mc/2);
    return '<div class="weapon-bay-item '+(isNew?'snap-in':'')+'">'
      +'<div class="wbi-info"><div class="wbi-name">'+wp.name+'</div>'
      +'<div class="wbi-stats">'+wp.range+' &middot; '+wp.damage+' &middot; AP '+wp.ap+' &middot; '+wp.notes+'</div>'
      +'<div class="wbi-mount">'+(w.mount==='fixed'?'Fixed Front':'Pintle Mount')+' &middot; '+mc+' mod'+(mc>1?'s':'')+' &middot; $'+fmtN(wp.cost)+'</div></div>'
      +'<span class="wbi-remove" onclick="removeWeapon('+i+')">&times;</span></div>'}).join('')}
function switchMount(m){state.currentMount=m;document.querySelectorAll('.mount-tab').forEach(function(t){t.classList.toggle('active',t.dataset.mount===m)})}
function removeWeapon(i){state.weapons.splice(i,1);AudioEngine.remove();renderWeaponBay();renderStats();renderOutput()}

// ‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê
function renderStats(){var f=getFrame(),used=calcTotalModsUsed(),gained=calcModsGained(),total=f.mods+gained,left=total-used;
  document.getElementById('statsGrid').innerHTML=
    '<div class="stat-box"><div class="stat-label">Size</div><div class="stat-value">'+f.size+'</div></div>'
    +'<div class="stat-box"><div class="stat-label">Armor</div><div class="stat-value">+'+calcArmor()+(state.mods['light_duty']?'':'<span style="font-size:10px;color:var(--text-dim)"> HW</span>')+'</div></div>'
    +'<div class="stat-box"><div class="stat-label">Strength</div><div class="stat-value">'+calcStr()+'</div></div>'
    +'<div class="stat-box"><div class="stat-label">Pace</div><div class="stat-value">'+calcPace()+' ('+calcRunDie()+')</div></div>'
    +'<div class="stat-box"><div class="stat-label">Toughness</div><div class="stat-value">'+(calcToughness()?'+'+calcToughness():'&mdash;')+'</div></div>'
    +'<div class="stat-box"><div class="stat-label">Mods Used</div><div class="stat-value '+(used>total?'danger':'')+'>'+used+'/'+total+'</div></div>';
  var cls='ok';if(left<=1&&left>0)cls='low';if(left<0)cls='over';
  document.getElementById('modsRemaining').innerHTML='<div class="big-num '+cls+'">'+left+'</div><div class="sub">Mods Remaining</div>';
  document.getElementById('costDisplay').innerHTML='<div class="cost-val">$'+fmtC(calcCost())+'</div><div class="cost-label">Total Cost</div>'}

// ‚ïê‚ïê‚ïê OUTPUT ‚ïê‚ïê‚ïê
function renderOutput(){var p=document.getElementById('panel-output'),f=getFrame();
  var used=calcTotalModsUsed(),gained=calcModsGained(),left=(f.mods+gained)-used;
  var notes=[];
  MODS.forEach(function(m){if(state.mods[m.id]>0)notes.push(state.mods[m.id]>1?state.mods[m.id]+'√ó '+m.name:m.name)});
  var wl=[];state.weapons.forEach(function(w){var wp=WEAPONS.find(function(x){return x.id===w.weaponId});
    if(wp)wl.push(wp.name+' ('+(w.mount==='fixed'?'Fixed Front':'Pintle Mount')+'): Range '+wp.range+', Damage '+wp.damage+', AP '+wp.ap+', RoF '+wp.rof+(wp.notes?', '+wp.notes:''))});
  var tough=calcToughness()?', Toughness +'+calcToughness():'';
  var hw=state.mods['light_duty']?'':'Heavy Armor. ';

  p.innerHTML='<div class="stat-block">'
    +'<div class="sb-name">'+(state.name||'Untitled Suit')+'</div>'
    +'<div class="sb-type">Size '+f.size+', Armor +'+calcArmor()+tough+', Pace '+calcPace()+' ('+calcRunDie()+' running), Str '+calcStr()+', Cost $'+fmtC(calcCost())+', Mods '+left+' remaining</div>'
    +'<hr class="sb-divider">'
    +(notes.length?'<div class="sb-line"><span class="sb-label">Mods:</span> '+notes.join(', ')+'.</div>':'')
    +(wl.length?'<div class="sb-line"><span class="sb-label">Weapons:</span></div>'+wl.map(function(w){return '<div class="sb-line">&nbsp;&nbsp;&bull; '+w+'</div>'}).join(''):'')
    +'<hr class="sb-divider">'
    +'<div class="sb-notes"><span class="sb-label">Special:</span> '+hw+'HUD negates 4 Illumination, +2 sight Notice. Sealed. Comms 20 mi. 3-day energy. Trait penalties: -4 fine motor/-4 face-to-face/-2 Stealth.'
    +(state.mods['shields']?' <strong>Shields:</strong> '+f.size+' charges, Soak with Electronics.':'')
    +(state.mods['flight']?' <strong>Flight:</strong> '+(state.mods['flight']>=3?'200 MPH':state.mods['flight']>=2?'60 MPH':'VTOL Pace 6')+'.':'')
    +(state.mods['jump_pack']?' <strong>Jump Pack:</strong> 8" horiz / 4" vert, +2 Wild Attack damage.':'')
    +'</div></div>'
    +'<div style="margin-top:16px"><button class="header-btn" onclick="copyStatBlock()">Copy to Clipboard</button></div>'}

function copyStatBlock(){var f=getFrame(),notes=[],wl=[];
  MODS.forEach(function(m){if(state.mods[m.id]>0)notes.push(state.mods[m.id]>1?state.mods[m.id]+'x '+m.name:m.name)});
  state.weapons.forEach(function(w){var wp=WEAPONS.find(function(x){return x.id===w.weaponId});if(wp)wl.push('  * '+wp.name+' ('+(w.mount==='fixed'?'Fixed':'Pintle')+'): '+wp.range+', '+wp.damage+', AP '+wp.ap+', RoF '+wp.rof)});
  var left=(f.mods+calcModsGained())-calcTotalModsUsed();
  var t=state.name+'\nSize '+f.size+', Armor +'+calcArmor()+', Pace '+calcPace()+' ('+calcRunDie()+'), Str '+calcStr()+', Cost $'+fmtC(calcCost())+', Mods '+left+' remaining\n';
  if(notes.length)t+='Mods: '+notes.join(', ')+'.\n';
  if(wl.length)t+='Weapons:\n'+wl.join('\n')+'\n';
  navigator.clipboard.writeText(t).then(function(){var btn=event.target;btn.textContent='Copied!';btn.style.borderColor='var(--green)';btn.style.color='var(--green)';setTimeout(function(){btn.textContent='Copy to Clipboard';btn.style.borderColor='';btn.style.color=''},1500)})}

// ‚ïê‚ïê‚ïê TABS, SAVE/LOAD, UTILS ‚ïê‚ïê‚ïê
function switchTab(tab){document.querySelectorAll('.tab').forEach(function(t){t.classList.toggle('active',t.dataset.tab===tab)});document.querySelectorAll('.panel').forEach(function(p){p.classList.toggle('active',p.id==='panel-'+tab)});if(tab==='output')renderOutput()}
function saveSuit(){var d={name:state.name,frameId:state.frameId,mods:JSON.parse(JSON.stringify(state.mods)),weapons:JSON.parse(JSON.stringify(state.weapons))};var i=state.savedSuits.findIndex(function(s){return s.name===state.name});if(i>=0)state.savedSuits[i]=d;else state.savedSuits.push(d);localStorage.setItem('diceforge-pa',JSON.stringify(state.savedSuits));renderSaved()}
function loadSuit(i){var d=state.savedSuits[i];state.name=d.name;state.frameId=d.frameId;state.mods=JSON.parse(JSON.stringify(d.mods));state.weapons=JSON.parse(JSON.stringify(d.weapons));document.getElementById('suitName').value=state.name;renderFrames();renderModCatalogue();renderModBay();renderWeaponCatalogue();renderWeaponBay();renderStats();renderOutput();renderSaved()}
function deleteSavedSuit(i){state.savedSuits.splice(i,1);localStorage.setItem('diceforge-pa',JSON.stringify(state.savedSuits));renderSaved()}
function newSuit(){state.name='Untitled Suit';state.frameId='s1';state.mods={};state.weapons=[];document.getElementById('suitName').value=state.name;renderFrames();renderModCatalogue();renderModBay();renderWeaponCatalogue();renderWeaponBay();renderStats();renderOutput()}
function loadSaved(){try{var d=localStorage.getItem('diceforge-pa');if(d)state.savedSuits=JSON.parse(d)}catch(e){}}
function renderSaved(){var list=document.getElementById('savedList');
  if(!state.savedSuits.length){list.innerHTML='<div class="empty-state"><p>No saved suits yet.</p></div>';return}
  list.innerHTML=state.savedSuits.map(function(s,i){var f=FRAMES.find(function(x){return x.id===s.frameId});
    return '<div class="saved-item" onclick="loadSuit('+i+')"><span class="si-name">'+s.name+'</span><span class="si-chassis">'+(f?f.name:'?')+'</span><button class="si-delete" onclick="event.stopPropagation();deleteSavedSuit('+i+')">&times;</button></div>'}).join('')}
function fmtN(n){return n.toLocaleString()}
function fmtC(n){if(n>=1e9)return(n/1e9).toFixed(2)+'B';if(n>=1e6)return(n/1e6).toFixed(n%1e6===0?0:2)+'M';if(n>=1e3)return(n/1e3).toFixed(n%1e3===0?0:1)+'K';return n.toString()}

// ‚ïê‚ïê‚ïê NAV BAR ‚ïê‚ïê‚ïê
(function(){var tools=[{id:'foundry',label:'üè≠ The Foundry',url:'foundry'},{id:'adventure-vault',label:'üé≠ Adventure Vault',url:'adventure-vault'},{id:'character-vault',label:'üë§ Character Vault',url:'character-vault'},{id:'walker-workshop',label:'‚öô Walker Workshop',url:'walker-workshop'},{id:'pa-forge',label:'üõ° PA Forge',url:'pa-forge'}];
  var nav=document.createElement('div');nav.className='tool-nav';
  tools.forEach(function(t){var btn=document.createElement('button');btn.className='tool-nav-item'+(t.id==='pa-forge'?' active':'');btn.textContent=t.label;btn.onclick=function(){if(t.id!=='pa-forge')window.location.href=t.url};nav.appendChild(btn)});
  document.getElementById('toolNavContainer').appendChild(nav)})();

// ‚ïê‚ïê‚ïê BOOT ‚ïê‚ïê‚ïê
var audioUnlocked=false;
(function(){function unlockAudio(){if(audioUnlocked)return;AudioEngine.init();var c=AudioEngine.ctx;if(c.state==='suspended')c.resume();var buf=c.createBuffer(1,1,c.sampleRate);var src=c.createBufferSource();src.buffer=buf;src.connect(c.destination);src.start(0);audioUnlocked=true;document.removeEventListener('touchstart',unlockAudio,true);document.removeEventListener('touchend',unlockAudio,true);document.removeEventListener('mousedown',unlockAudio,true);document.removeEventListener('click',unlockAudio,true)}
  document.addEventListener('touchstart',unlockAudio,true);document.addEventListener('touchend',unlockAudio,true);document.addEventListener('mousedown',unlockAudio,true);document.addEventListener('click',unlockAudio,true)})();
init();
</script>
</body>
</html>
