<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tribute Lands â€” Character Vault</title>
<script src="vault-integration.js"></script>
<link rel="stylesheet" href="tribute-lands.css">
  <script src="tool-navigation.js"></script>
</head>
<body>
<div id="saveOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;align-items:center;justify-content:center;transition:background 0.3s">
  <div class="save-msg" style="font-family:'Cinzel',serif;font-size:22px;color:#fff;letter-spacing:2px;text-shadow:0 0 20px rgba(255,180,0,0.5);padding:30px 50px;border:2px solid var(--accent);border-radius:8px;background:rgba(0,0,0,0.8)">â³ SAVING...</div>
</div>
<script>
var DICEFORGE_AUTH=false;
(function(){
  if(localStorage.getItem('diceforge_npcdb_auth')==='54546-44-56456-7567-2345') DICEFORGE_AUTH=true;
})();
</script>
<header>
  <div><h1>TRIBUTE LANDS â€” CHARACTER VAULT</h1><div class="subtitle">DiceForge Studios Ltd</div></div>
  <div id="headerButtons" style="display:flex;align-items:center;gap:8px;">
    <!-- Populated by integration script -->
  </div>
  <div id="navButtons" style="display:flex;gap:4px;align-items:center">
    <button id="navBack" class="btn sm" onclick="navBack()" style="font-size:14px;padding:2px 8px;opacity:0.3;cursor:default" title="Back (Alt+â†)">â—€</button>
    <button id="navFwd" class="btn sm" onclick="navForward()" style="font-size:14px;padding:2px 8px;opacity:0.3;cursor:default" title="Forward (Alt+â†’)">â–¶</button>
    <button class="btn sm" onclick="toggleShortcutHelp()" style="font-size:12px;padding:2px 8px;margin-left:4px" title="Keyboard shortcuts (?)">âŒ¨</button>
  </div>
  <div class="header-stats" id="headerStats"></div>
  <div id="syncIndicator" style="text-align:right;padding:2px 10px;display:flex;align-items:center;justify-content:flex-end;gap:8px">
    <span id="syncLabel" style="font-size:11px;font-family:monospace;color:var(--text-dim)">â—</span>
    <button onclick="forceRefresh()" style="font-size:10px;padding:1px 6px;background:none;border:1px solid var(--border);color:var(--text-dim);border-radius:3px;cursor:pointer" title="Reload from remote">â†» Refresh</button>
    <button onclick="promptForToken()" id="tokenBtn" style="font-size:10px;padding:1px 6px;background:none;border:1px solid var(--border);color:var(--text-dim);border-radius:3px;cursor:pointer;display:none" title="Set GitHub token">ğŸ”‘ Token</button>
    <button onclick="manageOpenAIKey()" style="font-size:10px;padding:1px 6px;background:none;border:1px solid var(--border);color:var(--text-dim);border-radius:3px;cursor:pointer" title="Manage OpenAI API key for portrait generation">ğŸ¨ AI Key</button>
  </div>
</header>
<div id="breadcrumb"><span class="bc-current">Home</span></div>
<div id="kbOverlay" onclick="if(event.target===this)toggleKBHelp()">
  <div class="kb-panel">
    <div class="kb-title">âŒ¨ Keyboard Shortcuts</div>
    <div class="kb-section"><h4>Navigation</h4>
      <div class="kb-row"><span>Navigate roster</span><span><span class="kb-key">â†‘</span> <span class="kb-key">â†“</span></span></div>
      <div class="kb-row"><span>Go back</span><span><span class="kb-key">Alt</span> + <span class="kb-key">â†</span></span></div>
      <div class="kb-row"><span>Go forward</span><span><span class="kb-key">Alt</span> + <span class="kb-key">â†’</span></span></div>
    </div>
    <div class="kb-section"><h4>Editing</h4>
      <div class="kb-row"><span>Undo</span><span><span class="kb-key">Ctrl</span> + <span class="kb-key">Z</span></span></div>
      <div class="kb-row"><span>Redo</span><span><span class="kb-key">Ctrl</span> + <span class="kb-key">Y</span></span></div>
    </div>
    <div class="kb-section"><h4>Panels</h4>
      <div class="kb-row"><span>Show shortcuts</span><span><span class="kb-key">?</span></span></div>
      <div class="kb-row"><span>Close panel / overlay</span><span><span class="kb-key">Esc</span></span></div>
    </div>
    <div style="text-align:center;margin-top:14px;font-size:12px;color:var(--text-dim)">Press <span class="kb-key">?</span> or <span class="kb-key">Esc</span> to close</div>
  </div>
</div>
<div class="container">
  <div class="sidebar">
    <div id="sidebarInner">
    <div class="sidebar-controls">
      <input type="text" id="searchInput" placeholder="Search characters..." oninput="filterNPCs()">
      <div class="filter-row">
        <select id="categoryFilter" onchange="filterNPCs()"><option value="">All Types</option><option>Pre-gen</option><option>NPC</option></select>
        <select id="regionFilter" onchange="filterNPCs()"><option value="">All Regions</option><option>Ammaria</option><option>Saltlands</option><option>Vinlands</option><option>Concordium</option><option>Glasrya</option><option>Global</option></select>
        <select id="tierFilter" onchange="filterNPCs()"><option value="">All Tiers</option><option>Wild Card</option><option>Extra</option><option>Walk-on</option></select>
        <select id="lifecycleFilter" onchange="filterNPCs()" title="Filter by lifecycle state"><option value="">All States</option><option value="draft">ğŸ“ Draft</option><option value="committed">ğŸ“¦ Committed</option><option value="published">ğŸ”’ Published</option><option value="dirty">âœï¸ Pending Edits</option><option value="errata">âš  Errata</option></select>
      </div>
      <div class="filter-row" id="productFilterRow" style="display:none">
        <select id="productFilter" onchange="filterNPCs()" title="Filter by product" style="flex:1"><option value="">All Products</option></select>
      </div>
    </div>
    <div class="npc-list" id="npcList"></div>
    <div class="sidebar-footer">
      <button class="btn primary" onclick="openNewNPCModal()" style="flex:1 1 100%">+ New Character</button>
      <button class="btn sm" onclick="showReviewPanel()" id="reviewBtn" title="Review pending changes" style="flex:1">Review</button>
      <button class="btn sm" onclick="showProductsModal()" title="Product registry" style="flex:1">Products</button>
      <button class="btn sm" onclick="showStatusView()" style="flex:1">Status</button>
      <button class="btn sm" onclick="showChangelog()" style="flex:1">Changes</button>
    </div>
    </div>
  </div>
  <div class="main empty-state" id="mainContent">
    <div id="welcomeGate" style="text-align:center;max-width:400px">
      <h2 style="color:var(--accent);margin-bottom:6px;font-size:22px">TRIBUTE LANDS</h2>
      <div style="color:var(--text-dim);font-size:13px;margin-bottom:24px;letter-spacing:1px">CHARACTER VAULT â€” DICEFORGE STUDIOS</div>
      <div id="pinForm">
        <input id="pinInput" type="password" placeholder="Enter PIN" style="width:200px;text-align:center;padding:10px 14px;font-size:16px;letter-spacing:4px;background:var(--bg-card);border:1px solid var(--border);border-radius:4px;color:var(--text);margin-bottom:12px" onkeydown="if(event.key==='Enter')checkPin()">
        <br><button class="btn primary" onclick="checkPin()" style="padding:8px 28px">Enter</button>
        <button class="btn" onclick="skipPinAndLoadLocal()" style="padding:8px 28px;margin-left:10px">Skip / Use Local Data</button>
        <div id="pinError" style="color:var(--red);font-size:12px;margin-top:10px"></div>
      </div>
    </div>
  </div>
</div>
<div id="charBottomBar" style="display:none"></div>
<div class="modal-overlay" id="newNpcModal">
  <div class="modal">
    <h3>New Character</h3>
    <div class="form-row"><div class="form-group"><label>Name *</label><input id="new_name"></div><div class="form-group"><label>Title / Role</label><input id="new_concept" placeholder="e.g. Professional Fixer"></div></div>
    <div class="form-row">
      <div class="form-group"><label>Category *</label><select id="new_category"><option>NPC</option><option>Pre-gen</option></select></div>
      <div class="form-group"><label>Region *</label><select id="new_region"><option>Ammaria</option><option>Saltlands</option><option>Vinlands</option><option>Concordium</option><option>Glasrya</option><option>Global</option></select></div>
      <div class="form-group"><label>Tier *</label><select id="new_tier"><option>Wild Card</option><option>Extra</option><option>Walk-on</option></select></div>
      <div class="form-group"><label>Ancestry</label><select id="new_ancestry"><option>Human</option><option>Dwarf</option><option>Elf</option><option>Half-Folk</option><option>Other</option></select></div>
    </div>
    <div class="form-actions"><button class="btn" onclick="closeNewNPCModal()">Cancel</button><button class="btn primary" onclick="createNPC()">Create NPC</button></div>
  </div>
</div>
<script>
// CharacterForge Engine Bootstrap
window.CharacterForge = (function(){
  var modules = [];
  return {
    data: {},
    registerModule: function(mod) {
      modules.push(mod);
      if (mod.alwaysOn) {
        ['edges','hindrances','skills','ancestries','powers','gear','skillLinks','coreSkills','skillDescs'].forEach(function(k){
          if (mod[k]) {
            if (Array.isArray(mod[k])) { if (!this.data[k]) this.data[k] = []; this.data[k] = this.data[k].concat(mod[k]); }
            else if (typeof mod[k] === 'object') { if (!this.data[k]) this.data[k] = {}; Object.assign(this.data[k], mod[k]); }
          }
        }.bind(this));
      }
    },
    getModules: function() { return modules; },
    getModule: function(id) { return modules.find(function(m){ return m.id === id; }); }
  };
})();
</script>
<script src="swade-rules.js"></script>
<script src="swade-core.js"></script>
<script src="ammaria.js"></script>
<script>
let allNPCs=[], currentNPC=null, activePanel=null;
let canonCommitted=new Set();
let _canonSnapshots={};  // name â†’ {snapshot, committedAt, changeId}
let _canonLog=[];         // [{action, target, changeId, date, summary}]
let _canonSeq=0;          // auto-increment for change IDs
/* â•â•â• NAVIGATION HISTORY â•â•â• */
let _navHistory=[], _navFwdStack=[], _navPushing=false;
function navPush(view){
  if(_navPushing)return;
  _navHistory.push(view);_navFwdStack=[];
  updateNavButtons();
}
function navBack(){
  if(_navHistory.length<2)return;
  _navFwdStack.push(_navHistory.pop());
  const prev=_navHistory[_navHistory.length-1];
  _navPushing=true;
  navGo(prev);
  _navPushing=false;
  updateNavButtons();updateBreadcrumb();
}
function navForward(){
  if(!_navFwdStack.length)return;
  const next=_navFwdStack.pop();
  _navHistory.push(next);
  _navPushing=true;
  navGo(next);
  _navPushing=false;
  updateNavButtons();updateBreadcrumb();
}
function navGo(view){
  if(view.type==='character') selectNPC(view.name);
  else if(view.type==='status') showStatusView();
  else if(view.type==='review') showReviewPanel();
  else if(view.type==='products') showProductsModal();
  else if(view.type==='changelog') showChangelog();
}
function updateNavButtons(){
  const back=document.getElementById('navBack');
  const fwd=document.getElementById('navFwd');
  if(back){back.style.opacity=_navHistory.length>1?'1':'0.3';back.style.cursor=_navHistory.length>1?'pointer':'default';}
  if(fwd){fwd.style.opacity=_navFwdStack.length>0?'1':'0.3';fwd.style.cursor=_navFwdStack.length>0?'pointer':'default';}
}

/* â•â•â• BREADCRUMB TRAIL â•â•â• */
function updateBreadcrumb(){
  const el=document.getElementById('breadcrumb');if(!el)return;
  const sep='<span class="bc-sep">â€º</span>';
  const home='<span class="bc-link" onclick="clearView()">Vault</span>';
  let trail=home;
  if(currentNPC){
    const cat=(currentNPC.category||'NPC')==='Pre-gen'?'Pre-gens':'NPCs';
    trail+=sep+'<span class="bc-link" onclick="headerFilter(\'category\',\''+cat+'\')">'+cat+'</span>';
    trail+=sep+'<span class="bc-current">'+esc(currentNPC.name)+'</span>';
    if(activePanel&&activePanel!=='audit'){
      const panelNames={edit:'Edit',hindrances:'Hindrances',edges:'Edges',skills:'Skills',weapons:'Weapons',armour:'Armour',gear:'Gear',powers:'Powers',narrative:'Narrative',statblock:'Stat Block',transfer:'Import / Export'};
      trail+=sep+'<span class="bc-current" style="font-weight:normal">'+esc(panelNames[activePanel]||activePanel)+'</span>';
    }
  } else {
    const view=_navHistory.length?_navHistory[_navHistory.length-1]:null;
    if(view){
      const names={status:'Production Status',review:'Review Pending Changes',products:'Product Registry',changelog:'Canon Changelog'};
      if(names[view.type]) trail+=sep+'<span class="bc-current">'+names[view.type]+'</span>';
    }
  }
  el.innerHTML=trail;
}
function clearView(){
  hideBottomBar();currentNPC=null;activePanel=null;
  const el=document.getElementById('mainContent');
  el.innerHTML='Select an NPC or create a new one';
  el.classList.add('empty-state');
  document.getElementById('categoryFilter').value='';
  document.getElementById('regionFilter').value='';
  document.getElementById('lifecycleFilter').value='';
  document.getElementById('searchInput').value='';
  filterNPCs();updateBreadcrumb();
}

/* â•â•â• KEYBOARD SHORTCUT OVERLAY â•â•â• */
function toggleShortcutHelp(){
  let overlay=document.getElementById('shortcutOverlay');
  if(overlay){overlay.remove();return;}
  overlay=document.createElement('div');
  overlay.id='shortcutOverlay';
  overlay.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:300;display:flex;align-items:center;justify-content:center';
  overlay.onclick=e=>{if(e.target===overlay)overlay.remove();};
  const shortcuts=[
    ['Navigation',''],
    ['â†‘ / â†“','Move through character roster'],
    ['Alt + â†','Navigate back'],
    ['Alt + â†’','Navigate forward'],
    ['',''],
    ['Editing',''],
    ['Ctrl + Z','Undo last edit'],
    ['Ctrl + Y','Redo last edit'],
    ['Ctrl + Shift + Z','Redo (alternative)'],
    ['',''],
    ['Views',''],
    ['?','Toggle this shortcut help'],
  ];
  let rows=shortcuts.map(([key,desc])=>{
    if(!key&&!desc) return '';
    if(!desc) return '<tr><td colspan="2" style="padding:10px 0 4px;font-weight:bold;color:var(--accent);font-size:13px;border-bottom:1px solid var(--border)">'+key+'</td></tr>';
    return '<tr><td style="padding:4px 16px 4px 0;text-align:right"><kbd style="background:var(--bg-input);border:1px solid var(--border);border-radius:3px;padding:2px 8px;font-family:monospace;font-size:12px;color:var(--text-bright);min-width:60px;display:inline-block;text-align:center">'+key+'</kbd></td><td style="padding:4px 0;color:var(--text);font-size:13px">'+desc+'</td></tr>';
  }).join('');
  overlay.innerHTML='<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:24px 32px;max-width:480px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">âŒ¨ Keyboard Shortcuts</h3><button class="btn sm" onclick="document.getElementById(\'shortcutOverlay\').remove()">âœ•</button></div><table style="width:100%">'+rows+'</table><div style="margin-top:16px;font-size:11px;color:var(--text-dim);text-align:center">Press <kbd style="background:var(--bg-input);border:1px solid var(--border);border-radius:2px;padding:1px 5px;font-family:monospace;font-size:11px">?</kbd> or click anywhere to close</div></div>';
  document.body.appendChild(overlay);
}
function showCommitHelp(){
  let ov=document.getElementById('commitHelpOverlay');
  if(ov){ov.remove();return;}
  ov=document.createElement('div');
  ov.id='commitHelpOverlay';
  ov.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:300;display:flex;align-items:center;justify-content:center';
  ov.onclick=e=>{if(e.target===ov)ov.remove();};
  ov.innerHTML=`<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:24px 32px;max-width:560px;max-height:90vh;overflow-y:auto;line-height:1.7">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h3 style="margin:0;color:var(--accent)">ğŸ“¦ Canon Commit Workflow</h3>
      <button class="btn sm" onclick="document.getElementById('commitHelpOverlay').remove()">âœ•</button>
    </div>
    <div style="font-size:13px;color:var(--text)">
      <p style="margin:0 0 12px"><strong>Characters move through three lifecycle stages:</strong></p>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;font-size:14px">
        <span style="color:var(--text-dim)">ğŸ“ Draft</span> â†’ <span style="color:#e8b84e">ğŸ“¦ Committed</span> â†’ <span style="color:var(--green)">ğŸ”’ Published</span>
      </div>
      <p style="margin:0 0 10px"><strong style="color:var(--text-dim)">ğŸ“ DRAFT</strong> â€” Character exists but hasn't been approved. Edit freely. The sidebar shows no special badge.</p>
      <p style="margin:0 0 10px"><strong style="color:#e8b84e">ğŸ“¦ COMMITTED</strong> â€” Stats are locked as the canonical version. The header shows <span style="color:var(--green)">ğŸ“¦ In Canon</span>. If you edit a committed character, the sidebar shows <span style="color:#e8b84e">EDITED</span> until you commit again.</p>
      <p style="margin:0 0 10px"><strong style="color:var(--green)">ğŸ”’ PUBLISHED</strong> â€” Character is assigned to a released product. Edits require an errata reason and create an audit trail.</p>
      <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
      <p style="margin:0 0 10px"><strong>How to commit a character:</strong></p>
      <p style="margin:0 0 6px">1. Open a character and scroll to the <strong>Build Audit</strong></p>
      <p style="margin:0 0 6px">2. Review the build â€” green âœ“ means legal, amber âš  is a warning</p>
      <p style="margin:0 0 6px">3. At the bottom, click <strong style="color:var(--accent)">ğŸ“¦ Commit to Canon</strong></p>
      <p style="margin:0 0 6px">4. The button immediately greys to <strong>âœ“ Canon Up to Date</strong></p>
      <p style="margin:0 0 6px">5. Make any edit â†’ the button reactivates as <strong style="color:var(--accent)">ğŸ”„ Update Canon</strong></p>
      <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
      <p style="margin:0 0 10px"><strong>What each UI element tells you:</strong></p>
      <table style="width:100%;font-size:12px;border-collapse:collapse">
        <tr><td style="padding:4px 8px;border-bottom:1px solid var(--border)"><strong>Header badge</strong></td><td style="padding:4px;border-bottom:1px solid var(--border)">ğŸ“¦ In Canon / Not in Canon + âœï¸ Edited if changes pending</td></tr>
        <tr><td style="padding:4px 8px;border-bottom:1px solid var(--border)"><strong>Sidebar badge</strong></td><td style="padding:4px;border-bottom:1px solid var(--border)">ğŸ“¦ = committed, EDITED/ERRATA = changes pending</td></tr>
        <tr><td style="padding:4px 8px;border-bottom:1px solid var(--border)"><strong>Bottom bar</strong></td><td style="padding:4px;border-bottom:1px solid var(--border)">Green button = action needed, grey = up to date</td></tr>
        <tr><td style="padding:4px 8px;border-bottom:1px solid var(--border)"><strong>Audit panel</strong></td><td style="padding:4px;border-bottom:1px solid var(--border)">Lifecycle status, last commit timestamp, pending changes list</td></tr>
        <tr><td style="padding:4px 8px"><strong>Changelog</strong></td><td style="padding:4px">ğŸ“‹ in sidebar footer â€” full history of all commits</td></tr>
      </table>
      <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
      <p style="margin:0 0 10px"><strong>Batch operations:</strong></p>
      <p style="margin:0 0 4px">â€¢ <strong>Review Pending Changes</strong> (âœï¸ in sidebar footer) â€” all characters with uncommitted edits</p>
      <p style="margin:0">â€¢ <strong>Canon Changelog</strong> (ğŸ“‹ in sidebar footer) â€” full audit trail with change IDs</p>
    </div>
    <div style="margin-top:16px;text-align:center"><button class="btn primary sm" onclick="document.getElementById('commitHelpOverlay').remove()">Got it</button></div>
  </div>`;
  document.body.appendChild(ov);
}
/* â•â•â• UNDO / REDO â•â•â• */
const UNDO_CAP=40;
let _undoStack=[], _redoStack=[], _lastSnapshot=null;
function _snap(npc){return npc?JSON.parse(JSON.stringify(npc)):null;}
function _pushUndo(){if(!currentNPC)return;if(_lastSnapshot){_undoStack.push(_lastSnapshot);if(_undoStack.length>UNDO_CAP)_undoStack.shift();}_redoStack=[];_lastSnapshot=_snap(currentNPC);}
function _restoreSnap(snap){if(!snap||!currentNPC)return;const idx=allNPCs.findIndex(n=>n.name===currentNPC.name);Object.assign(currentNPC,snap);if(idx>=0)allNPCs[idx]=currentNPC;calcDerived(currentNPC);scheduleSave();if(activePanel){renderMiddleColumn(currentNPC);renderStatColumn(currentNPC);}else{renderDetail();}}
function undo(){if(!_undoStack.length||!currentNPC)return;_redoStack.push(_snap(currentNPC));const prev=_undoStack.pop();_lastSnapshot=_snap(prev);_restoreSnap(prev);}
function redo(){if(!_redoStack.length||!currentNPC)return;_undoStack.push(_snap(currentNPC));const next=_redoStack.pop();_lastSnapshot=_snap(next);_restoreSnap(next);}
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='z'&&!e.shiftKey){e.preventDefault();undo();}if((e.ctrlKey||e.metaKey)&&(e.key==='y'||(e.key==='z'&&e.shiftKey))){e.preventDefault();redo();}if(e.altKey&&e.key==='ArrowLeft'){e.preventDefault();navBack();}if(e.altKey&&e.key==='ArrowRight'){e.preventDefault();navForward();}const tag=document.activeElement?.tagName;if(e.key==='?'&&tag!=='INPUT'&&tag!=='TEXTAREA'&&tag!=='SELECT'){e.preventDefault();toggleShortcutHelp();}});

/* â•â•â• RELEASE MANAGEMENT â€” baselines, dirty tracking, product registry, locks â•â•â• */
let _baselines={};
let _productRegistry={products:[]};
const REGISTRY_FILENAME='product-registry.json';

/* â”€â”€ Baseline Management â”€â”€ */
function captureBaselines(){
  _baselines={};
  allNPCs.forEach(n=>{_baselines[n.name]=JSON.stringify(serialiseForBaseline(n));});
  console.log('ğŸ“¸ Baselines captured for',Object.keys(_baselines).length,'characters');
}
function captureBaseline(name){
  const n=allNPCs.find(c=>c.name===name);
  if(n)_baselines[name]=JSON.stringify(serialiseForBaseline(n));
}
function serialiseForCompare(n){
  return {
    attrs:{agility:n.agility||0,smarts:n.smarts||0,spirit:n.spirit||0,strength:n.strength||0,vigor:n.vigor||0},
    skills:Object.assign({},n.skills||{}),edges:[...(n.edges||[])].sort(),edgeNotes:Object.assign({},n.edgeNotes||{}),
    hindrances:[...(n.hindrances||[])].sort(),powers:[...(n.powers||[])].sort(),
    weapons:JSON.parse(JSON.stringify(n.weapons||[])),
    armour:JSON.parse(JSON.stringify(n.armour||[])),
    gearText:n.gearText||'',pace:n.pace||6,parry:n.parry||2,toughness:n.toughness||5,toughnessArmor:n.toughnessArmor||0,
    abName:n.abName||'',pp:n.pp||0,startingFunds:n.startingFunds||500,gearCost:n.gearCost||0,
    quote:n.quote||'',description:n.description||'',background:n.background||'',
    motivation:n.motivation||'',secret:n.secret||'',services:n.services||'',
    adventureHook:n.adventureHook||'',tactics:n.tactics||'',notes:n.notes||'',
    personality:n.personality||'',physicalDescription:n.physicalDescription||'',
    age:n.age||null,advancement:n.advancement||'',
    connections:JSON.stringify(n.connections||[]),appearances:JSON.stringify(n.appearances||[]),
    foreshadowing:JSON.stringify(n.foreshadowing||[]),
    refCode:n.refCode||'',concept:n.concept||'',ancestry:n.ancestry||'Human',
    region:n.region||'Ammaria',tier:n.tier||'Wild Card',rank:n.rank||'Novice',category:n.category||'NPC'
  };
}
function serialiseForBaseline(n){
  const base=serialiseForCompare(n);
  base.weapons=(n.weapons||[]).map(w=>({...w}));
  base.armour=(n.armour||[]).map(a=>({...a}));
  return base;
}

/* â”€â”€ Dirty Detection â”€â”€ */
function isCharDirty(name){
  const n=allNPCs.find(c=>c.name===name);
  if(!n)return false;
  const baseline=_baselines[name];
  if(!baseline)return true;
  return JSON.stringify(serialiseForBaseline(n))!==baseline;
}
function getAllDirty(){return allNPCs.filter(n=>isCharDirty(n.name));}
function getDirtyCount(){return getAllDirty().length;}

/* â”€â”€ Character Lifecycle â”€â”€ */
function getLifecycle(name){
  const n=allNPCs.find(c=>c.name===name);
  if(!n)return 'draft';
  if(isPublished(name))return 'published';
  if(canonCommitted.has(name))return 'committed';
  return 'draft';
}
function isPublished(name){
  return _productRegistry.products.some(p=>p.status==='released'&&(p.characters||[]).includes(name));
}
function getPublishedProducts(name){
  return _productRegistry.products.filter(p=>p.status==='released'&&(p.characters||[]).includes(name));
}
function isLocked(name){
  return isPublished(name);
}

/* â”€â”€ Human-Readable Diff Engine â”€â”€ */
function getCharDiff(name){
  const n=allNPCs.find(c=>c.name===name);
  if(!n)return [];
  const baseline=_baselines[name];
  if(!baseline)return [{type:'added',text:'New character (no baseline)'}];
  const old=JSON.parse(baseline);
  const cur=serialiseForCompare(n);
  const changes=[];
  // Identity
  if(old.concept!==cur.concept) changes.push({type:'changed',text:`Concept: "${old.concept||'â€”'}" â†’ "${cur.concept||'â€”'}"`});
  if(old.ancestry!==cur.ancestry) changes.push({type:'changed',text:`Ancestry: ${old.ancestry} â†’ ${cur.ancestry}`});
  if(old.tier!==cur.tier) changes.push({type:'changed',text:`Tier: ${old.tier} â†’ ${cur.tier}`});
  if(old.rank!==cur.rank) changes.push({type:'changed',text:`Rank: ${old.rank} â†’ ${cur.rank}`});
  if(old.refCode!==cur.refCode) changes.push({type:'changed',text:`RefCode: ${old.refCode||'â€”'} â†’ ${cur.refCode||'â€”'}`});
  // Attributes
  const attrNames=['agility','smarts','spirit','strength','vigor'];
  const attrLabels={agility:'Agi',smarts:'Sma',spirit:'Spi',strength:'Str',vigor:'Vig'};
  const attrChanges=[];
  attrNames.forEach(a=>{if(old.attrs[a]!==cur.attrs[a]) attrChanges.push(`${attrLabels[a]} ${d(old.attrs[a])}â†’${d(cur.attrs[a])}`);});
  if(attrChanges.length) changes.push({type:'changed',text:'Attributes: '+attrChanges.join(', ')});
  // Skills
  const allSkills=new Set([...Object.keys(old.skills),...Object.keys(cur.skills)]);
  const skillAdded=[],skillRemoved=[],skillChanged=[];
  allSkills.forEach(sk=>{
    if(!old.skills[sk]) skillAdded.push(sk+' '+d(cur.skills[sk]));
    else if(!cur.skills[sk]) skillRemoved.push(sk);
    else if(old.skills[sk]!==cur.skills[sk]) skillChanged.push(sk+' '+d(old.skills[sk])+'â†’'+d(cur.skills[sk]));
  });
  if(skillAdded.length) changes.push({type:'added',text:'Skills added: '+skillAdded.join(', ')});
  if(skillRemoved.length) changes.push({type:'removed',text:'Skills removed: '+skillRemoved.join(', ')});
  if(skillChanged.length) changes.push({type:'changed',text:'Skills changed: '+skillChanged.join(', ')});
  // Edges
  const edgeAdded=cur.edges.filter(e=>!old.edges.includes(e));
  const edgeRemoved=old.edges.filter(e=>!cur.edges.includes(e));
  if(edgeAdded.length) changes.push({type:'added',text:'Edges added: '+edgeAdded.join(', ')});
  if(edgeRemoved.length) changes.push({type:'removed',text:'Edges removed: '+edgeRemoved.join(', ')});
  // Edge notes
  const allEdgeNoteKeys=new Set([...Object.keys(old.edgeNotes||{}),...Object.keys(cur.edgeNotes||{})]);
  const noteChanges=[];
  allEdgeNoteKeys.forEach(k=>{if((old.edgeNotes||{})[k]!==(cur.edgeNotes||{})[k]) noteChanges.push(k);});
  if(noteChanges.length) changes.push({type:'changed',text:'Edge notes updated: '+noteChanges.join(', ')});
  // Hindrances
  const hindAdded=cur.hindrances.filter(h=>!old.hindrances.includes(h));
  const hindRemoved=old.hindrances.filter(h=>!cur.hindrances.includes(h));
  if(hindAdded.length) changes.push({type:'added',text:'Hindrances added: '+hindAdded.join(', ')});
  if(hindRemoved.length) changes.push({type:'removed',text:'Hindrances removed: '+hindRemoved.join(', ')});
  // Powers
  const powAdded=cur.powers.filter(p=>!old.powers.includes(p));
  const powRemoved=old.powers.filter(p=>!cur.powers.includes(p));
  if(powAdded.length) changes.push({type:'added',text:'Powers added: '+powAdded.join(', ')});
  if(powRemoved.length) changes.push({type:'removed',text:'Powers removed: '+powRemoved.join(', ')});
  if(old.pp!==cur.pp) changes.push({type:'changed',text:`Power Points: ${old.pp}â†’${cur.pp}`});
  // Weapons
  const oldWepNames=(old.weapons||[]).map(w=>typeof w==='string'?w:w.name).sort();
  const curWepNames=(cur.weapons||[]).map(w=>typeof w==='string'?w:w.name).sort();
  const wepAdded=curWepNames.filter(w=>!oldWepNames.includes(w));
  const wepRemoved=oldWepNames.filter(w=>!curWepNames.includes(w));
  if(wepAdded.length) changes.push({type:'added',text:'Weapons added: '+wepAdded.join(', ')});
  if(wepRemoved.length) changes.push({type:'removed',text:'Weapons removed: '+wepRemoved.join(', ')});
  // Armour
  const oldArmNames=(old.armour||[]).map(a=>typeof a==='string'?a:a.name).sort();
  const curArmNames=(cur.armour||[]).map(a=>typeof a==='string'?a:a.name).sort();
  const armAdded=curArmNames.filter(a=>!oldArmNames.includes(a));
  const armRemoved=oldArmNames.filter(a=>!curArmNames.includes(a));
  if(armAdded.length) changes.push({type:'added',text:'Armour added: '+armAdded.join(', ')});
  if(armRemoved.length) changes.push({type:'removed',text:'Armour removed: '+armRemoved.join(', ')});
  // Gear
  if(old.gearText!==cur.gearText) changes.push({type:'changed',text:'Gear list updated'});
  // Derived
  if(old.pace!==cur.pace) changes.push({type:'changed',text:`Pace: ${old.pace}â†’${cur.pace}`});
  // Funds
  if(old.startingFunds!==cur.startingFunds) changes.push({type:'changed',text:`Starting Funds: ${old.startingFunds}â‚¡â†’${cur.startingFunds}â‚¡`});
  if(old.gearCost!==cur.gearCost) changes.push({type:'changed',text:`Gear Cost: ${old.gearCost}â‚¡â†’${cur.gearCost}â‚¡`});
  // Narrative
  const narrativeFields=[{key:'description',label:'Description'},{key:'background',label:'Background'},{key:'motivation',label:'Motivation'},{key:'secret',label:'Secret'},{key:'services',label:'Services'},{key:'adventureHook',label:'Adventure Hook'},{key:'tactics',label:'Tactics'},{key:'notes',label:'Notes'},{key:'quote',label:'Quote'},{key:'personality',label:'Personality'},{key:'physicalDescription',label:'Physical Description'},{key:'advancement',label:'Advancement'},{key:'age',label:'Age'}];
  narrativeFields.forEach(f=>{if(old[f.key]!==cur[f.key]){
    if(!old[f.key]&&cur[f.key]) changes.push({type:'added',text:f.label+' added'});
    else if(old[f.key]&&!cur[f.key]) changes.push({type:'removed',text:f.label+' removed'});
    else changes.push({type:'changed',text:f.label+' updated'});
  }});
  // Structured array fields (compared as JSON strings)
  if(old.connections!==cur.connections) changes.push({type:'changed',text:'Connections updated'});
  if(old.appearances!==cur.appearances) changes.push({type:'changed',text:'Appearances updated'});
  if(old.foreshadowing!==cur.foreshadowing) changes.push({type:'changed',text:'Foreshadowing updated'});
  return changes;
}

/* â”€â”€ Product Registry â”€â”€ */
async function loadProductRegistry(){
  if(!GIST_ID||!GIST_TOKEN)return;
  try{
    const resp=await fetch(`https://api.github.com/gists/${GIST_ID}`,{headers:{'Authorization':`token ${GIST_TOKEN}`,'Accept':'application/vnd.github.v3+json'}});
    if(!resp.ok)return;
    const gist=await resp.json();
    const raw=gist.files[REGISTRY_FILENAME]?.content;
    if(raw){_productRegistry=JSON.parse(raw);console.log('ğŸ“¦ Product registry loaded:',_productRegistry.products.length,'products');refreshProductFilter();}
  }catch(e){console.warn('Registry load failed:',e);}
}
async function saveProductRegistry(){
  if(!GIST_ID||!GIST_TOKEN)return;
  try{
    await fetch(`https://api.github.com/gists/${GIST_ID}`,{
      method:'PATCH',
      headers:{'Authorization':`token ${GIST_TOKEN}`,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},
      body:JSON.stringify({files:{[REGISTRY_FILENAME]:{content:JSON.stringify(_productRegistry,null,2)}}})
    });
    console.log('ğŸ“¦ Registry saved');refreshProductFilter();
  }catch(e){console.error('Registry save failed:',e);}
}
function addProduct(code,title){
  if(_productRegistry.products.find(p=>p.code===code))return false;
  _productRegistry.products.push({code,title,status:'draft',characters:[],createdAt:new Date().toISOString(),releasedAt:null,platforms:[]});
  saveProductRegistry();return true;
}
function addCharToProduct(productCode,charName){
  const p=_productRegistry.products.find(x=>x.code===productCode);
  if(!p)return false;
  if(!p.characters.includes(charName))p.characters.push(charName);
  saveProductRegistry();return true;
}
function removeCharFromProduct(productCode,charName){
  const p=_productRegistry.products.find(x=>x.code===productCode);
  if(!p)return false;
  p.characters=p.characters.filter(c=>c!==charName);
  saveProductRegistry();return true;
}
function setProductStatus(code,status){
  const p=_productRegistry.products.find(x=>x.code===code);
  if(!p)return false;
  p.status=status;
  if(status==='released'&&!p.releasedAt)p.releasedAt=new Date().toISOString();
  saveProductRegistry();return true;
}
function removeProduct(code){
  const p=_productRegistry.products.find(x=>x.code===code);
  if(!p)return false;
  if(p.status==='released'){alert('Cannot delete a released product. Archive it instead.');return false;}
  _productRegistry.products=_productRegistry.products.filter(x=>x.code!==code);
  saveProductRegistry();return true;
}

/* â”€â”€ Override System for Published Characters â”€â”€ */
function requiresOverride(name){return isPublished(name)&&isCharDirty(name);}
function logOverride(name,reason){
  const n=allNPCs.find(c=>c.name===name);
  if(!n)return;
  if(!n.overrideLog)n.overrideLog=[];
  n.overrideLog.push({date:new Date().toISOString(),reason:reason,changes:getCharDiff(name)});
}

/* â”€â”€ Batch Review â€” approve/reject dirty characters â”€â”€ */
function approveCharacter(name){
  captureBaseline(name);
  filterNPCs();updateHeaderStats();
}
function revertCharacter(name){
  const baseline=_baselines[name];
  if(!baseline)return;
  const n=allNPCs.find(c=>c.name===name);
  if(!n)return;
  const old=JSON.parse(baseline);
  // Restore from baseline â€” rebuild the full character from serialised compare data
  n.agility=old.attrs.agility;n.smarts=old.attrs.smarts;n.spirit=old.attrs.spirit;n.strength=old.attrs.strength;n.vigor=old.attrs.vigor;
  n.skills=Object.assign({},old.skills);n.edges=[...old.edges];n.edgeNotes=Object.assign({},old.edgeNotes);
  n.hindrances=[...old.hindrances];n.powers=[...old.powers];n.gearText=old.gearText;
  n.pace=old.pace;n.parry=old.parry;n.toughness=old.toughness;n.toughnessArmor=old.toughnessArmor;
  n.abName=old.abName;n.pp=old.pp;n.startingFunds=old.startingFunds;n.gearCost=old.gearCost;
  n.quote=old.quote;n.description=old.description;n.background=old.background;
  n.motivation=old.motivation;n.secret=old.secret;n.services=old.services;
  n.adventureHook=old.adventureHook;n.tactics=old.tactics;n.notes=old.notes;
  n.refCode=old.refCode;n.concept=old.concept;n.ancestry=old.ancestry;
  n.region=old.region;n.tier=old.tier;n.rank=old.rank;n.category=old.category;
  n.weapons=(old.weapons||[]).map(w=>typeof w==='string'?{name:w}:{...w});
  n.armour=(old.armour||[]).map(a=>typeof a==='string'?{name:a}:{...a});
  calcDerived(n);scheduleSave();
  if(currentNPC&&currentNPC.name===name){currentNPC=n;renderDetail();}
  filterNPCs();updateHeaderStats();
}
const LS_KEY='tl_npc_db';
const CACHE_KEY='tl_npc_cache';

// â•â•â• REMOTE DATA STORE CONFIG â•â•â•
// Fill these in after creating your GitHub Gist.
// GIST_ID: the alphanumeric ID from the Gist URL (e.g. 'a1b2c3d4e5f6...')
// GIST_TOKEN: a GitHub personal access token with 'gist' scope only
// GIST_FILENAME: must match the filename in your Gist
const GIST_ID = '7fa2d50c458ed95c21a3c6d283f863d6';
const GIST_TOKEN = localStorage.getItem('diceforge_gist_token')||'';
const GIST_FILENAME = 'ammaria-characters.json';

function promptForToken(){
  const t=prompt('Enter your GitHub Gist token (one-time setup per device):');
  if(t&&t.startsWith('github_pat_')){localStorage.setItem('diceforge_gist_token',t);location.reload();}
  else if(t){alert('Token should start with github_pat_...');promptForToken();}
}

let syncStatus='idle'; // idle | loading | saving | error | offline
let saveTimer=null;
const SAVE_DEBOUNCE_MS=500; // batch rapid edits into one save

function setSyncStatus(s,msg){
  syncStatus=s;
  const el=document.getElementById('syncLabel');
  const overlay=document.getElementById('saveOverlay');
  if(!el)return;
  const map={idle:['â—','var(--green)','Synced'],loading:['â†»','var(--accent)','Loading...'],saving:['â†‘','var(--accent)','Saving...'],error:['âœ–','#c44','Sync error'],offline:['â—‹','var(--text-dim)','Offline (cached)']};
  const[icon,col,label]=map[s]||map.idle;
  el.style.color=col;
  el.textContent=`${icon} ${msg||label}`;
  el.title=msg||label;
  // Overlay only on errors â€” normal saves are silent
  if(overlay){
    if(s==='error'){
      overlay.style.display='flex';
      overlay.querySelector('.save-msg').textContent='âŒ SAVE FAILED â€” RETRYING...';
      overlay.style.background='rgba(80,0,0,0.7)';
    } else {
      overlay.style.display='none';
    }
  }
}

async function forceRefresh(){
  if(saveTimer){clearTimeout(saveTimer);saveTimer=null;}
  await loadData();captureBaselines();filterNPCs();updateHeaderStats();loadProductRegistry();
  if(currentNPC){const fresh=allNPCs.find(n=>n.name===currentNPC.name);if(fresh){currentNPC=fresh;renderDetail();}else{currentNPC=null;document.getElementById('mainContent').innerHTML='<span style="color:var(--text-dim)">Character no longer exists</span>';}}
}

async function loadData(){
  const CF=window.CharacterForge;
  // If no Gist configured, fall back to module-seeded + localStorage (legacy mode)
  if(!GIST_ID||!GIST_TOKEN){
    console.warn('No Gist configured â€” running in local-only mode');
    setSyncStatus('offline','No remote store â€” click ğŸ”‘ to set up');
    const tb=document.getElementById('tokenBtn');if(tb)tb.style.display='';
    loadDataLegacy(CF);
    return;
  }
  setSyncStatus('loading');
  try{
    const resp=await fetch(`https://api.github.com/gists/${GIST_ID}`,{headers:{'Authorization':`token ${GIST_TOKEN}`,'Accept':'application/vnd.github.v3+json'}});
    if(!resp.ok) throw new Error(`GitHub ${resp.status}: ${resp.statusText}`);
    const gist=await resp.json();
    const raw=gist.files[GIST_FILENAME]?.content;
    if(!raw) throw new Error(`File "${GIST_FILENAME}" not found in Gist`);
    const data=JSON.parse(raw);
    // Normalise each character
    allNPCs=data.characters.map(c=>normaliseChar(c,'ammaria'));
    // Load canon state from gist
    if(data.canonCommitted){
      _canonSnapshots=data.canonCommitted;
      canonCommitted=new Set(Object.keys(_canonSnapshots));
    }
    if(data.canonLog){_canonLog=data.canonLog;_canonSeq=_canonLog.length;}
    // Cache locally for offline fallback
    localStorage.setItem(CACHE_KEY,raw);
    setSyncStatus('idle',`Synced â€” ${allNPCs.length} characters`);
    console.log(`Loaded ${allNPCs.length} characters from Gist`);
  }catch(err){
    console.error('Gist load failed, trying cache:',err);
    const cached=localStorage.getItem(CACHE_KEY);
    if(cached){
      const data=JSON.parse(cached);
      allNPCs=data.characters.map(c=>normaliseChar(c,'ammaria'));
      if(data.canonCommitted){_canonSnapshots=data.canonCommitted;canonCommitted=new Set(Object.keys(_canonSnapshots));}
      if(data.canonLog){_canonLog=data.canonLog;_canonSeq=_canonLog.length;}
      setSyncStatus('offline',`Offline â€” ${allNPCs.length} characters (cached)`);
    }else{
      // Last resort: load from module seed data
      loadDataLegacy(CF);
      setSyncStatus('error','No remote data or cache available');
    }
  }
}

function loadDataLegacy(CF){
  if(!CF)return;
  const seeded=[];
  const modules=CF.getModules?CF.getModules():[];
  modules.forEach(m=>{if(m.characters) m.characters.forEach(c=>seeded.push(normaliseChar(c,m.id)));});
  const stored=JSON.parse(localStorage.getItem(LS_KEY)||'{}');
  const merged=[], usedNames=new Set();
  if(stored.custom) stored.custom.forEach(c=>{merged.push(c);usedNames.add(c.name);});
  seeded.forEach(s=>{
    if(usedNames.has(s.name)) return;
    const ov=stored.overrides?stored.overrides[s.name]:null;
    merged.push(ov?{...s,...ov,category:s.category}:s);
  });
  allNPCs=merged;
  if(stored.deleted) allNPCs=allNPCs.filter(n=>!stored.deleted.includes(n.name));
}

function saveCharacter(npc){_pushUndo();console.log("ğŸ’¾ saveCharacter called:",npc.name);
  // Update in allNPCs array
  const idx=allNPCs.findIndex(n=>n.name===npc.name);
  if(idx>=0) allNPCs[idx]=npc; else allNPCs.push(npc);
  // Debounced remote save
  scheduleSave();
}

function scheduleSave(){console.log("â± scheduleSave: will push in",SAVE_DEBOUNCE_MS,"ms");
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer=setTimeout(()=>pushToGist(),SAVE_DEBOUNCE_MS);
}

async function pushToGist(){console.log("â˜ï¸ pushToGist firing...");
  if(!GIST_ID||!GIST_TOKEN){
    // Legacy fallback: save to localStorage
    const s=JSON.parse(localStorage.getItem(LS_KEY)||'{}');
    if(!s.overrides)s.overrides={};
    if(currentNPC)s.overrides[currentNPC.name]=currentNPC;
    localStorage.setItem(LS_KEY,JSON.stringify(s));
    return;
  }
  setSyncStatus('saving');
  try{
    const data={
      version:'1.0',
      region:'ammaria',
      lastModified:new Date().toISOString(),
      lastModifiedBy:'character-vault',
      characterCount:allNPCs.length,
      characters:allNPCs.map(n=>({
        name:n.name,refCode:n.refCode||'',concept:n.concept||'',ancestry:n.ancestry||'Human',
        region:n.region||'Ammaria',tier:n.tier||'Wild Card',rank:n.rank||'Novice',
        category:n.category||'NPC',product:n.product||n.region||'Ammaria',
        attrs:{agility:n.agility||0,smarts:n.smarts||0,spirit:n.spirit||0,strength:n.strength||0,vigor:n.vigor||0},
        skills:n.skills||{},edges:n.edges||[],edgeNotes:n.edgeNotes||{},hindrances:n.hindrances||[],powers:n.powers||[],
        weapons:n.weapons||[],armour:n.armour||[],
        pace:n.pace||6,parry:n.parry||2,toughness:n.toughness||5,toughnessArmor:n.toughnessArmor||0,bennies:n.bennies||0,
        gearText:n.gearText||'',quote:n.quote||'',notes:n.notes||'',
        description:n.description||'',background:n.background||'',motivation:n.motivation||'',
        secret:n.secret||'',services:n.services||'',adventureHook:n.adventureHook||'',tactics:n.tactics||'',
        abName:n.abName||'',abSkill:n.abSkill||'',pp:n.pp||0,startingFunds:n.startingFunds||500,gearCost:n.gearCost||0,
        statComplete:n.statComplete||false,narrativeComplete:n.narrativeComplete||false,fgReady:n.fgReady||false,
        overrideLog:n.overrideLog||[],
        personality:n.personality||'',physicalDescription:n.physicalDescription||'',age:n.age||null,
        advancement:n.advancement||'',
        connections:n.connections||[],appearances:n.appearances||[],foreshadowing:n.foreshadowing||[],
        portrait:n.portrait||''
      })),
      canonCommitted:_canonSnapshots,
      canonLog:_canonLog
    };
    const raw=JSON.stringify(data,null,2);
    const resp=await fetch(`https://api.github.com/gists/${GIST_ID}`,{
      method:'PATCH',
      headers:{'Authorization':`token ${GIST_TOKEN}`,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},
      body:JSON.stringify({files:{[GIST_FILENAME]:{content:raw}}})
    });
    if(!resp.ok) throw new Error(`GitHub ${resp.status}: ${resp.statusText}`);
    // Update cache
    localStorage.setItem(CACHE_KEY,raw);
    console.log('âœ… Gist save success:',allNPCs.length,'characters');setSyncStatus('idle',`Saved â€” ${allNPCs.length} characters`);
  }catch(err){
    console.error('âŒ Gist save FAILED:',err);
    setSyncStatus('error','Save failed â€” will retry');
    // Retry once after 5 seconds
    setTimeout(()=>{if(syncStatus==='error')pushToGist();},5000);
  }
}

function normaliseChar(c,moduleId){
  const n={name:c.name,refCode:c.refCode||'',concept:c.concept||'',ancestry:c.ancestry||'Human',region:c.region||'Ammaria',tier:c.tier||'Wild Card',rank:c.rank||'Novice',category:c.category||'NPC',product:c.product||'',source:moduleId,agility:c.attrs?.agility||c.agility||0,smarts:c.attrs?.smarts||c.smarts||0,spirit:c.attrs?.spirit||c.spirit||0,strength:c.attrs?.strength||c.strength||0,vigor:c.attrs?.vigor||c.vigor||0,skills:c.skills||{},edges:c.edges||[],edgeNotes:c.edgeNotes||{},hindrances:c.hindrances||[],powers:c.powers||[],armour:c.armour||[],weapons:c.weapons||[],gearText:c.gearText||'',quote:c.quote||'',description:c.description||'',background:c.background||'',motivation:c.motivation||'',secret:c.secret||'',services:c.services||'',adventureHook:c.adventureHook||'',tactics:c.tactics||'',abName:c.abName||'',abSkill:c.abSkill||'',pp:c.pp||0,startingFunds:c.startingFunds||500,gearCost:c.gearCost||0,statComplete:c.statComplete||false,narrativeComplete:c.narrativeComplete||false,fgReady:c.fgReady||false,pace:c.pace||6,parry:c.parry||2,toughness:c.toughness||5,toughnessArmor:c.toughnessArmor||0,bennies:c.bennies||0};
  // Parse gear text into structured armour/weapons if not already populated
  if(!n.armour.length&&!n.weapons.length&&n.gearText) parseGearInto(n);
  n.toughnessArmor=n.armour.reduce((best,a)=>Math.max(best,a.armor||0),0);
  if(c.notes && !n.description && !n.motivation){
    const notes=c.notes;
    const motM=notes.match(/What (?:They|He|She) Want[s]?:\s*(.+?)(?:\n|$)/i);
    const secM=notes.match(/(?:Their|His|Her) Secret:\s*(.+?)(?:\n|$)/i);
    const svcM=notes.match(/Services:\s*(.+?)(?:\n|$)/i);
    const hookM=notes.match(/Hook:\s*(.+?)(?:\n|$)/i);
    if(motM) n.motivation=motM[1].trim();
    if(secM) n.secret=secM[1].trim();
    if(svcM) n.services=svcM[1].trim();
    if(hookM) n.adventureHook=hookM[1].trim();
    const lines=notes.split('\n').map(l=>l.trim()).filter(l=>l);
    const narr=[];
    for(const line of lines){
      if(/^(What|Their|His|Her|Services|Hook|Connections|Advancement)[\s:]/i.test(line)) break;
      if(/^Appendix|^Week/i.test(line)) continue;
      narr.push(line);
    }
    if(narr.length>=2){n.description=narr[0];n.background=narr.slice(1).join(' ');}
    else if(narr.length===1) n.description=narr[0];
  }
  calcDerived(n);
  // v2.0 narrative fields
  n.personality=c.personality||'';
  n.physicalDescription=c.physicalDescription||'';
  n.age=c.age||null;
  n.advancement=c.advancement||'';
  n.connections=JSON.parse(JSON.stringify(c.connections||[]));
  n.appearances=JSON.parse(JSON.stringify(c.appearances||[]));
  n.foreshadowing=JSON.parse(JSON.stringify(c.foreshadowing||[]));
  n.portrait=c.portrait||'';
  n.statComplete=n.agility>0&&Object.keys(n.skills).length>0;
  n.narrativeComplete=!!(n.description||n.quote);
  return n;
}

function calcDerived(n){
  var CF=window.CharacterForge;
  var ancestryData=(CF&&CF.data&&CF.data.ancestries&&CF.data.ancestries[n.ancestry])||{pace:6,size:0,toughMod:0};
  var d=window.SWADERules?window.SWADERules.calcDerived(
    {agility:n.agility,smarts:n.smarts,spirit:n.spirit,strength:n.strength,vigor:n.vigor},
    n.skills, ancestryData, []
  ):{pace:6,parry:2,toughness:5,armor:0};
  n.pace=d.pace; n.parry=d.parry; n.toughness=d.toughness+(n.toughnessArmor||0);
  n.bennies=n.tier==='Wild Card'?3:0;
}

// saveOverride and saveCustomNPC removed â€” replaced by saveCharacter with Gist sync
function d(v){return v<=0?'â€”':v<=12?'d'+v:'d12+'+(v-12);}
const DIE_STEPS=[4,6,8,10,12];
function dieStepUp(v,capped){if(v<4)return 4;if(v<12){const i=DIE_STEPS.indexOf(v);return i>=0&&i<4?DIE_STEPS[i+1]:12;}if(capped)return 12;return v+1;}
function dieStepDown(v){if(v>12)return v-1;const i=DIE_STEPS.indexOf(v);return i>0?DIE_STEPS[i-1]:4;}
function isPregen(){return currentNPC&&currentNPC.category==='Pre-gen';}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function csvToList(s){return s?s.split(',').map(x=>x.trim()).filter(x=>x):[];}

function getCatalogueEdges(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.edges) CF.data.edges.forEach(e=>all.push({...e,source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{if(m.edges)m.edges.forEach(e=>all.push({...e,source:m.name||m.id}));});
  return all;
}
function getCatalogueHindrances(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.hindrances) CF.data.hindrances.forEach(h=>all.push({...h,source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{if(m.hindrances)m.hindrances.forEach(h=>all.push({...h,source:m.name||m.id}));});
  return all;
}
function getCatalogueWeapons(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.gear?.melee) CF.data.gear.melee.forEach(w=>all.push({...w,type:'Melee',source:'Core'}));
  if(CF.data?.gear?.ranged) CF.data.gear.ranged.forEach(w=>all.push({...w,type:'Ranged',source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{
    if(m.gear?.melee) m.gear.melee.forEach(w=>all.push({...w,type:'Melee',source:m.name||m.id}));
    if(m.gear?.ranged) m.gear.ranged.forEach(w=>all.push({...w,type:'Ranged',source:m.name||m.id}));
  });
  return all;
}
function getCatalogueArmour(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.gear?.armor) CF.data.gear.armor.forEach(a=>all.push({...a,type:'Armour',source:'Core'}));
  if(CF.data?.gear?.shields) CF.data.gear.shields.forEach(s=>all.push({...s,type:'Shield',source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{
    if(m.gear?.armor) m.gear.armor.forEach(a=>all.push({...a,type:'Armour',source:m.name||m.id}));
    if(m.gear?.shields) m.gear.shields.forEach(s=>all.push({...s,type:'Shield',source:m.name||m.id}));
  });
  return all;
}
function getCatalogueSkills(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.skillLinks) Object.entries(CF.data.skillLinks).forEach(([name,attr])=>all.push({name,attr,source:'Core',summary:(CF.data.skillDescs&&CF.data.skillDescs[name])||'',core:(CF.data.coreSkills||[]).includes(name)}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{
    if(m.skillLinks) Object.entries(m.skillLinks).forEach(([name,attr])=>{if(!all.find(s=>s.name===name))all.push({name,attr,source:m.name||m.id,summary:(m.skillDescs&&m.skillDescs[name])||'',core:false});});
  });
  return all.sort((a,b)=>a.name.localeCompare(b.name));
}
function getCataloguePowers(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.powers) CF.data.powers.forEach(p=>all.push({...p,source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{
    if(m.powers) m.powers.forEach(p=>all.push({...p,source:m.name||m.id}));
  });
  return all;
}
function getCatalogueGear(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.gear?.general) CF.data.gear.general.forEach(g=>all.push({...g,source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{
    if(m.gear?.general) m.gear.general.forEach(g=>all.push({...g,source:m.name||m.id}));
  });
  return all;
}
function parseGearInto(n){
  if(!n.gearText) return;
  const items=n.gearText.split(',').map(g=>g.trim()).filter(g=>g);
  const catW=getCatalogueWeapons(), catA=getCatalogueArmour();
  const remaining=[];
  items.forEach(item=>{
    const normItem=item.toLowerCase().replace(/\s*\([^)]*\)/g,'').trim();
    const wMatch=catW.find(w=>normItem.includes(w.name.toLowerCase().split('(')[0].trim()));
    if(wMatch){n.weapons.push({name:wMatch.name,damage:wMatch.dmg,ap:wMatch.ap||0,range:wMatch.range||'',rof:wMatch.rof||0,notes:wMatch.notes||'',source:wMatch.source});return;}
    const aMatch=catA.find(a=>normItem.includes(a.name.toLowerCase().split('(')[0].trim()));
    if(aMatch){n.armour.push({name:aMatch.name,armor:aMatch.armor||aMatch.parry||0,parry:aMatch.parry||0,notes:aMatch.notes||'',source:aMatch.source});return;}
    remaining.push(item);
  });
  n.gearText=remaining.join(', ');
}

function getFilteredNPCs(){
  const search=document.getElementById('searchInput').value.toLowerCase();
  const region=document.getElementById('regionFilter').value;
  const tier=document.getElementById('tierFilter').value;
  const cat=document.getElementById('categoryFilter').value;
  const lf=document.getElementById('lifecycleFilter')?.value||'';
  const pf=document.getElementById('productFilter')?.value||'';
  return allNPCs.filter(n=>{
    if(cat&&(n.category||'NPC')!==cat)return false;
    if(region&&n.region!==region)return false;
    if(tier&&n.tier!==tier)return false;
    if(search&&!n.name.toLowerCase().includes(search)&&!(n.concept||'').toLowerCase().includes(search))return false;
    if(lf){
      const lc=getLifecycle(n.name);
      const dirty=isCharDirty(n.name);
      if(lf==='draft'&&lc!=='draft')return false;
      if(lf==='committed'&&lc!=='committed')return false;
      if(lf==='published'&&lc!=='published')return false;
      if(lf==='dirty'&&!dirty)return false;
      if(lf==='errata'&&!(lc==='published'&&dirty))return false;
    }
    if(pf){
      const prod=_productRegistry.products.find(p=>p.code===pf);
      if(!prod||!(prod.characters||[]).includes(n.name))return false;
    }
    return true;
  });
}

function refreshProductFilter(){
  const sel=document.getElementById('productFilter');
  const row=document.getElementById('productFilterRow');
  if(!sel||!row)return;
  const products=_productRegistry.products||[];
  if(!products.length){row.style.display='none';return;}
  row.style.display='';
  const cur=sel.value;
  sel.innerHTML='<option value="">All Products</option>'+products.map(p=>{
    const icon=p.status==='released'?'ğŸ”’':p.status==='in-review'?'â³':'ğŸ“';
    return `<option value="${esc(p.code)}">${icon} ${esc(p.code)} â€” ${esc(p.title)}</option>`;
  }).join('');
  if(cur)sel.value=cur;
}

function headerFilter(type,value){
  // Reset all filters first
  document.getElementById('categoryFilter').value='';
  document.getElementById('regionFilter').value='';
  document.getElementById('lifecycleFilter').value='';
  document.getElementById('searchInput').value='';
  const pf=document.getElementById('productFilter');if(pf)pf.value='';
  // Set the target filter
  if(type==='category') document.getElementById('categoryFilter').value=value;
  else if(type==='lifecycle') document.getElementById('lifecycleFilter').value=value;
  filterNPCs();
}

function filterNPCs(){
  renderNPCList(getFilteredNPCs());
}

function getVisualOrder(){
  const npcs=getFilteredNPCs();
  const sortByRef=(a,b)=>{if(!a.refCode&&!b.refCode)return a.name.localeCompare(b.name);if(!a.refCode)return 1;if(!b.refCode)return -1;return a.refCode.localeCompare(b.refCode);};
  const pregens=npcs.filter(n=>(n.category||'NPC')==='Pre-gen').sort(sortByRef);
  const npcWC=npcs.filter(n=>(n.category||'NPC')!=='Pre-gen'&&n.tier==='Wild Card').sort(sortByRef);
  const npcExt=npcs.filter(n=>(n.category||'NPC')!=='Pre-gen'&&n.tier==='Extra').sort(sortByRef);
  const npcWalk=npcs.filter(n=>(n.category||'NPC')!=='Pre-gen'&&n.tier==='Walk-on').sort(sortByRef);
  return [...pregens,...npcWC,...npcExt,...npcWalk];
}

document.addEventListener('keydown',function(e){
  if(!currentNPC)return;
  if(e.key!=='ArrowUp'&&e.key!=='ArrowDown')return;
  const tag=document.activeElement?.tagName;
  if(tag==='INPUT'||tag==='TEXTAREA'||tag==='SELECT')return;
  e.preventDefault();
  const list=getVisualOrder();
  const idx=list.findIndex(n=>n.name===currentNPC.name);
  if(idx<0)return;
  const next=e.key==='ArrowUp'?idx-1:idx+1;
  if(next<0||next>=list.length)return;
  selectNPC(list[next].name);
  const item=document.querySelectorAll('.npc-item')[next];
  if(item)item.scrollIntoView({block:'nearest'});
});

function renderNPCList(npcs){
  const el=document.getElementById('npcList');
  if(!npcs.length){el.innerHTML='<div style="padding:20px;text-align:center;color:var(--text-dim)">No characters found</div>';return;}
  const sortByRef=(a,b)=>{if(!a.refCode&&!b.refCode)return a.name.localeCompare(b.name);if(!a.refCode)return 1;if(!b.refCode)return -1;return a.refCode.localeCompare(b.refCode);};
  const pregens=npcs.filter(n=>(n.category||'NPC')==='Pre-gen').sort(sortByRef);
  const npcWC=npcs.filter(n=>(n.category||'NPC')!=='Pre-gen'&&n.tier==='Wild Card').sort(sortByRef);
  const npcExt=npcs.filter(n=>(n.category||'NPC')!=='Pre-gen'&&n.tier==='Extra').sort(sortByRef);
  const npcWalk=npcs.filter(n=>(n.category||'NPC')!=='Pre-gen'&&n.tier==='Walk-on').sort(sortByRef);
  function renderItem(n){
    const tc=n.tier==='Wild Card'?'wc':n.tier==='Walk-on'?'walkon':'extra';
    const tl=n.tier==='Wild Card'?'WC':n.tier==='Walk-on'?'W-O':'EXT';
    const catTag=(n.category||'NPC')==='Pre-gen'?'<span class="tier-tag pregen">PG</span>':'<span class="tier-tag npc">NPC</span>';
    const act=currentNPC&&currentNPC.name===n.name?'active':'';
    const title=n.concept?` â€” ${n.concept}`:'';
    const audit=runBuildAudit(n);
    const legal=audit.every(r=>r.pass);
    const hasWarns=audit.some(r=>r.warn);
    const legalIcon=n.agility>0?(legal?(hasWarns?'<span style="font-size:12px;margin-left:4px" title="Build Legal â€” optimisation warnings">âš ï¸</span>':'<span style="font-size:12px;margin-left:4px" title="Build Legal">âœ…</span>'):'<span style="font-size:12px;margin-left:4px" title="Build Issues">âŒ</span>'):'<span style="font-size:12px;margin-left:4px;opacity:0.4" title="No stats">â¬œ</span>';
    const canonIcon=canonCommitted.has(n.name)?'<span style="font-size:11px;margin-left:3px" title="Committed to Canon">ğŸ“¦</span>':'';
    const dirty=isCharDirty(n.name);
    const lifecycle=getLifecycle(n.name);
    let dirtyClass='',dirtyBadge='';
    if(dirty){
      if(lifecycle==='published'){dirtyClass='dirty-published';dirtyBadge='<span class="dirty-badge published" title="Published character â€” changes pending review">ERRATA</span>';}
      else if(lifecycle==='committed'){dirtyClass='dirty-committed';dirtyBadge='<span class="dirty-badge committed" title="Committed character â€” changes pending review">EDITED</span>';}
      else{dirtyClass='dirty-draft';dirtyBadge='<span class="dirty-badge draft" title="Draft â€” unsaved changes">DRAFT</span>';}
    }
    return `<div class="npc-item ${act} ${dirtyClass}" onclick="selectNPC('${esc(n.name).replace(/'/g,"\\'")}')">
      <div class="npc-name">${esc(n.name)}${catTag}<span class="tier-tag ${tc}">${tl}</span>${legalIcon}${canonIcon}${dirtyBadge}
        <span class="status-dots" title="Stats / Narrative / FG">
          <span class="status-dot ${n.statComplete?'on':'off'}"></span>
          <span class="status-dot ${n.narrativeComplete?'on':'off'}"></span>
          <span class="status-dot ${n.fgReady?'on':'off'}"></span>
        </span></div>
      <div class="npc-meta">${n.refCode?'<span style="font-family:monospace;font-size:10px;color:var(--accent);margin-right:6px">'+esc(n.refCode)+'</span>':''}${esc(n.region)}${esc(title)}</div></div>`;
  }
  let html='';
  if(pregens.length){html+=`<div class="list-section-header">Pre-gens (${pregens.length})</div>`;html+=pregens.map(renderItem).join('');}
  if(npcWC.length){html+=`<div class="list-section-header">NPCs â€” Wild Cards (${npcWC.length})</div>`;html+=npcWC.map(renderItem).join('');}
  if(npcExt.length){html+=`<div class="list-section-header">NPCs â€” Extras (${npcExt.length})</div>`;html+=npcExt.map(renderItem).join('');}
  if(npcWalk.length){html+=`<div class="list-section-header">NPCs â€” Walk-ons (${npcWalk.length})</div>`;html+=npcWalk.map(renderItem).join('');}
  el.innerHTML=html;
}

function updateHeaderStats(){
  const t=allNPCs.length,pg=allNPCs.filter(n=>(n.category||'NPC')==='Pre-gen').length,np=t-pg;
  const c=allNPCs.filter(n=>n.statComplete&&n.narrativeComplete).length,f=allNPCs.filter(n=>n.fgReady).length;
  const cn=allNPCs.filter(n=>canonCommitted.has(n.name)).length;
  const dc=getDirtyCount();
  const dirtySpan=dc>0?`<span style="cursor:pointer;border-bottom:1px dotted #e8b84e;padding-bottom:1px" onclick="showReviewPanel()" title="Click to review changes"><span class="stat-num" style="color:#e8b84e">${dc}</span> âœï¸ Pending</span>`:'';
  const hdrLink='cursor:pointer;border-bottom:1px dotted var(--text-dim);padding-bottom:1px';
  document.getElementById("headerStats").innerHTML=`<span style="${hdrLink}" onclick="headerFilter('category','Pre-gen')" title="Filter to Pre-gens"><span class="stat-num">${pg}</span> Pre-gens</span><span style="${hdrLink}" onclick="headerFilter('category','NPC')" title="Filter to NPCs"><span class="stat-num">${np}</span> NPCs</span><span style="${hdrLink}" onclick="headerFilter('lifecycle','committed')" title="Filter to committed characters"><span class="stat-num">${cn}</span> ğŸ“¦ Canon</span>${dirtySpan}<span style="${hdrLink}" onclick="showStatusView()" title="Open production status"><span class="stat-num">${c}</span> Complete</span><span style="${hdrLink}" onclick="showStatusView()" title="Open production status"><span class="stat-num">${f}</span> FG Ready</span>`;
}

function selectNPC(name){flushSave();currentNPC=allNPCs.find(n=>n.name===name);if(!currentNPC)return;currentNPC._lockAcknowledged=false;_undoStack=[];_redoStack=[];_lastSnapshot=_snap(currentNPC);if(!activePanel)activePanel='audit';renderDetail();filterNPCs();navPush({type:'character',name:name});updateBreadcrumb();}
function selectByRef(ref){const n=allNPCs.find(c=>c.refCode===ref);if(n)selectNPC(n.name);}

function renderDetail(){
  const n=currentNPC;if(!n)return;
  const el=document.getElementById('mainContent');
  el.classList.remove('empty-state');el.style.overflowY='hidden';
  const ancestryTag=n.ancestry&&n.ancestry!=='Human'?` Â· ${esc(n.ancestry)}`:'';
  const titleLine=n.concept?`<div class="npc-title-line">${esc(n.concept)}${ancestryTag}</div>`:(n.ancestry?`<div class="npc-title-line">${esc(n.ancestry)}</div>`:'');
  const canonBadge=canonCommitted.has(n.name)?'<span style="font-size:13px;margin-left:10px;color:var(--green)" title="Committed to Canon">ğŸ“¦ In Canon</span>':'<span style="font-size:13px;margin-left:10px;color:var(--text-dim)" title="Not yet committed">ğŸ“¦ Not in Canon</span>';
  const pubProds=getPublishedProducts(n.name);
  const pubBadge=pubProds.length?'<span style="font-size:13px;margin-left:10px;color:var(--green)" title="Published in: '+pubProds.map(p=>p.code).join(', ')+'">ğŸ”’ Published</span>':'';
  const dirtyBadge=isCharDirty(n.name)?'<span style="font-size:13px;margin-left:10px;color:#e8b84e" title="Changes pending review">âœï¸ Edited</span>':'';
  const catBadge=(n.category||'NPC')==='Pre-gen'?'<span class="tier-tag pregen" style="margin-left:10px;font-size:11px;padding:2px 8px">PRE-GEN</span>':'<span class="tier-tag npc" style="margin-left:10px;font-size:11px;padding:2px 8px">NPC</span>';
  const tierBadgeClass=n.tier==='Wild Card'?'wc':n.tier==='Walk-on'?'walkon':'extra';
  const tierBadgeText=n.tier==='Wild Card'?'WILD CARD':n.tier==='Walk-on'?'WALK-ON':'EXTRA';
  const tierBadge='<span class="tier-tag '+tierBadgeClass+'" style="margin-left:6px;font-size:11px;padding:2px 8px">'+tierBadgeText+'</span>';
  const refBadge=n.refCode?`<span style="font-family:monospace;font-size:11px;color:var(--text-dim);margin-right:8px;background:var(--bg-card);padding:2px 6px;border-radius:3px;border:1px solid var(--border)">${esc(n.refCode)}</span>`:'';
  const allProds=_productRegistry.products.filter(p=>(p.characters||[]).includes(n.name));
  const prodLine=allProds.length?`<div style="font-size:11px;color:var(--text-dim);margin-top:2px;margin-bottom:4px">${allProds.map(p=>{
    const col=p.status==='released'?'var(--green)':p.status==='in-review'?'#e8b84e':'var(--text-dim)';
    const icon=p.status==='released'?'ğŸ”’':p.status==='in-review'?'â³':'ğŸ“';
    return '<span style="margin-right:10px;color:'+col+'">'+icon+' '+esc(p.code)+' â€” '+esc(p.title)+'</span>';
  }).join('')}</div>`:'';
  el.innerHTML=`<div class="npc-header"><h2>${refBadge}${esc(n.name)}${catBadge}${tierBadge}${canonBadge}${pubBadge}${dirtyBadge}</h2>${titleLine}${prodLine}</div><div class="detail-columns"><div class="col-stats" id="colStats"></div><div class="col-middle" id="colMiddle"></div><div class="col-narrative" id="colNarrative"></div></div>`;
  renderStatColumn(n);renderMiddleColumn(n);renderNarrativeColumn(n);
}

function renderStatColumn(n){
  const el=document.getElementById('colStats');
  const wcStar=n.tier==='Wild Card'?' â˜…':'';
  const tierText=n.tier==='Wild Card'?'WILD CARD':n.tier.toUpperCase();
  const auditResults=runBuildAudit(n);
  const isLegal=auditResults.every(r=>r.pass);
  const warnCount=auditResults.filter(r=>r.warn).length;
  const warnTag=isLegal&&warnCount>0?` <span style="color:#e6a117">Â· ${warnCount} âš </span>`:'';
  const legalBadge=`<span class="build-legal-badge ${isLegal?'':'invalid'}" onclick="showPanel('audit')">${isLegal?'âœ“ Build Legal':'âœ— Issues'}${warnTag}</span>`;
  const attrStr=`Agility ${d(n.agility)}, Smarts ${d(n.smarts)}, Spirit ${d(n.spirit)}, Strength ${d(n.strength)}, Vigor ${d(n.vigor)}`;
  const _coreSkills=(window.CharacterForge?.data?.coreSkills||[]).map(s=>s.toLowerCase());
  const skillStr=Object.entries(n.skills).map(([k,v])=>`${k}${_coreSkills.includes(k.toLowerCase())?'<span style="color:var(--accent)"> â˜…</span>':''} ${d(v)}`).join(', ')||'<span style="color:var(--text-dim)">None</span>';
  const fDie=n.skills['Fighting']||0;
  const expParry=fDie>0?2+Math.floor(fDie/2):2;
  const expTough=2+(n.vigor>0?Math.floor(n.vigor/2):0)+(n.toughnessArmor||0);
  const paceCol=n.pace===6?'var(--green)':'var(--red)';
  const parryCol=n.parry===expParry?'var(--green)':'var(--red)';
  const toughCol=n.toughness===expTough?'var(--green)':'var(--red)';
  const toughDisp=n.toughnessArmor>0?`${n.toughness} (${n.toughnessArmor})`:`${n.toughness}`;
  const benniesItem=n.tier==='Wild Card'?`<div class="derived-item"><div class="derived-num">${n.bennies}</div><div class="derived-label">Bennies</div></div>`:'';
  const hindStr=n.hindrances.length?n.hindrances.map(h=>esc(h)).join(', '):'None';
  const edgeStr=n.edges.length?n.edges.map(e=>esc(e)).join(', '):'None';
  let statsHTML='';
  if(n.agility>0){
    statsHTML=`<div class="stat-block-panel"><div class="panel-header"><span class="tier-label">${tierText}${wcStar} Â· ${esc(n.ancestry||'?')}</span>${legalBadge}</div>
    <div class="stat-section"><div class="stat-section-label" onclick="showPanel('edit')">Attributes <span class="edit-icon">âœ</span></div><div class="stat-val">${attrStr}</div></div>
    <div class="stat-section"><div class="stat-section-label" onclick="showPanel('skills')">Skills <span class="edit-icon">âœ</span></div><div class="stat-val">${skillStr}</div></div>
    <div class="derived-row">
      <div class="derived-item" title="Base 6"><div class="derived-num" style="color:${paceCol}">${n.pace}</div><div class="derived-label">Pace</div></div>
      <div class="derived-item" title="2 + Fighting ${d(fDie)}/2 = ${expParry}"><div class="derived-num" style="color:${parryCol}">${n.parry}</div><div class="derived-label">Parry</div></div>
      <div class="derived-item" title="2 + Vigor ${d(n.vigor)}/2 = ${expTough}"><div class="derived-num" style="color:${toughCol}">${toughDisp}</div><div class="derived-label">Toughness</div></div>
      ${benniesItem}</div>
    <div class="stat-section" style="font-size:12px"><span style="color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;font-size:10px">Hindrances</span><div class="stat-val">${hindStr}</div></div>
    <div class="stat-section" style="font-size:12px"><span style="color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;font-size:10px">Edges</span><div class="stat-val">${edgeStr}</div></div></div>`;
  } else {
    statsHTML=`<div class="stat-block-panel"><div class="panel-header"><span class="tier-label">${tierText} Â· ${esc(n.ancestry||'?')}</span></div><div style="color:var(--text-dim);font-size:13px">No attributes set. <button class="btn sm" onclick="showPanel('edit')">Edit NPC</button></div></div>`;
  }
  const hindBox=buildSectionBox('Hindrances','hindrances',n.hindrances,h=>`<div class="item-entry">${esc(h)}</div>`);
  const edgeBox=buildSectionBox('Edges','edges',n.edges,e=>{const leg=isLegacyEdge(e)?' <span class="legacy-tag">(legacy)</span>':'';return `<div class="item-entry">${esc(e)}${leg}</div>`;});
  const armourBox=buildSectionBox('Armour','armour',n.armour,a=>`<div class="item-entry">${esc(a.name)} <span style="color:var(--accent)">(+${a.armor})</span></div>`);
  const weaponBox=buildSectionBox('Weapons','weapons',n.weapons,w=>`<div class="item-entry">${esc(w.name)} <span style="color:var(--text-dim)">${esc(w.damage)}${w.ap?' AP'+w.ap:''}${w.range?' '+w.range:''}</span></div>`);
  const powersBox=buildSectionBox('Powers','powers',n.powers,p=>`<div class="item-entry">${esc(p)}</div>`);
  const gearItems=n.gearText?n.gearText.split(',').map(g=>g.trim()).filter(g=>g):[];
  const gearBox=buildSectionBox('Gear','gear',gearItems,g=>`<div class="item-entry">${esc(g)}</div>`);
  const remaining=n.startingFunds-n.gearCost;
  const fundsColor=remaining>=0?'var(--green)':'var(--red)';
  const fundsLine=`<div style="text-align:center;font-size:12px;padding:6px 0;color:var(--text-dim)">Funds: <span style="color:${fundsColor};font-weight:bold">${n.gearCost}â‚¡</span> / ${n.startingFunds}â‚¡ <span style="color:${fundsColor}">(${remaining>=0?remaining+'â‚¡ left':'over by '+Math.abs(remaining)+'â‚¡'})</span></div>`;
  el.innerHTML=`<div class="col-stats-scroll">${statsHTML}<div class="section-box-pair">${hindBox}${edgeBox}</div><div class="section-box-pair">${armourBox}${weaponBox}</div><div class="section-box-pair">${powersBox}${gearBox}</div>${fundsLine}</div>`;
  renderBottomBar(n);
}

function renderBottomBar(n){
  const bar=document.getElementById('charBottomBar');
  if(!n){bar.style.display='none';return;}
  const inCanon=canonCommitted.has(n.name);
  const audit=runBuildAudit(n);const legal=audit.every(r=>r.pass);
  const dirty=isCharDirty(n.name);
  const needsCommit=!inCanon||dirty;
  const commitLabel=inCanon?(dirty?'ğŸ”„ Update Canon':'âœ“ Canon Up to Date'):'ğŸ“¦ Commit to Canon';
  const commitBtnClass=needsCommit?'btn primary':'btn';
  const commitBtnStyle=needsCommit?'':'opacity:0.4;cursor:default';
  const commitAction=needsCommit?`doCommitFromAudit().then(()=>{if(activePanel!=='audit')showPanel('audit')})`:'';
  const commitTitle=needsCommit?(inCanon?'Update canonical data â€” opens audit panel':'Commit to canon â€” opens audit panel'):'Canon is up to date';
  const legalLabel=legal?'<span style="color:var(--green)">âœ… Build legal</span>':'<span style="color:var(--red)">âŒ Build issues</span>';
  bar.style.display='';
  bar.innerHTML=`<div class="status-bar"><div class="status-row">
    <label><input type="checkbox" ${n.statComplete?'checked':''} onchange="toggleStatus('statComplete',this.checked)"> Stats</label>
    <label><input type="checkbox" ${n.narrativeComplete?'checked':''} onchange="toggleStatus('narrativeComplete',this.checked)"> Narrative</label>
    <label><input type="checkbox" ${n.fgReady?'checked':''} onchange="toggleStatus('fgReady',this.checked)"> FG Ready</label></div>
    <div class="action-btns"><button class="btn sm" onclick="showPanel('edit')">Edit</button><button class="btn sm" onclick="showPanel('statblock')">Stat Block</button><button class="btn sm" onclick="showPanel('audit')">Audit</button><button class="btn sm" onclick="showPanel('transfer')" style="color:var(--accent)">Import / Export</button><button class="btn sm danger" onclick="deleteNPC()">Delete</button></div>
    <div class="commit-area"><button class="${commitBtnClass}" onclick="${commitAction}" style="${commitBtnStyle}" title="${commitTitle}">${commitLabel}</button>${legalLabel}</div>
  </div>`;
}
function hideBottomBar(){const bar=document.getElementById('charBottomBar');if(bar)bar.style.display='none';}

function buildSectionBox(title,panel,items,renderItem,isLegacy){
  const content=items.length?items.map(renderItem).join('')+(isLegacy?'<div class="legacy-tag" style="margin-top:4px">Legacy</div>':''):'<div class="none-text">None</div>';
  return `<div class="section-box"><h3 onclick="showPanel('${panel}')">${title} <span class="edit-icon">âœ</span></h3>${content}</div>`;
}
function isLegacyEdge(name){if(name.startsWith('Arcane Background ('))return false;return !getCatalogueEdges().find(e=>e.name===name);}

function renderMiddleColumn(n){
  const el=document.getElementById('colMiddle');
  if(!activePanel){
    el.innerHTML=`<div class="middle-panel"><div class="middle-default"><div class="hint">Click any panel heading to edit</div><div class="quick-links">
      <a onclick="showPanel('weapons')">Weapons âœ</a><a onclick="showPanel('armour')">Armour âœ</a><a onclick="showPanel('gear')">Gear âœ</a>
      <a onclick="showPanel('hindrances')">Hindrances âœ</a><a onclick="showPanel('edges')">Edges âœ</a><a onclick="showPanel('powers')">Powers âœ</a></div></div></div>`;
    return;
  }
  const panelNames={edit:'Edit',hindrances:'Hindrances',edges:'Edges',skills:'Skills',weapons:'Weapons',armour:'Armour',gear:'Gear',powers:'Powers',narrative:'Narrative',statblock:'Stat Block',audit:'Build Audit',transfer:'Import / Export'};
  const editPanels=['edit','hindrances','edges','skills','weapons','armour','gear','powers','narrative'];
  const lockBanner=isLocked(n.name)&&editPanels.includes(activePanel)?'<div class="lock-warning" style="margin-bottom:8px">ğŸ”’ This character is published. Changes will be flagged as errata and require review approval.</div>':'';
  const undoCount=_undoStack.length;
  const redoCount=_redoStack.length;
  const undoStyle=undoCount>0?'color:var(--accent);border-color:var(--accent)':'color:var(--text-dim);border-color:var(--border);opacity:0.4;cursor:default';
  const redoStyle=redoCount>0?'color:var(--accent);border-color:var(--accent)':'color:var(--text-dim);border-color:var(--border);opacity:0.4;cursor:default';
  let undoBar='';
  if(editPanels.includes(activePanel)){
    const depthLabel=undoCount+redoCount>0?'<span style="font-size:10px;color:var(--text-dim)" title="'+undoCount+' undo / '+redoCount+' redo">'+undoCount+'/'+redoCount+'</span>':'';
    undoBar='<div style="display:flex;gap:4px;align-items:center;margin-left:auto;margin-right:8px">'
      +'<button class="btn sm" onclick="undo()" style="'+undoStyle+'" title="Undo (Ctrl+Z)">â†¶</button>'
      +'<button class="btn sm" onclick="redo()" style="'+redoStyle+'" title="Redo (Ctrl+Y)">â†·</button>'
      +depthLabel+'</div>';
  }
  el.innerHTML=`<div class="middle-panel"><div class="panel-title"><h3>${panelNames[activePanel]||activePanel}</h3>${undoBar}<button class="btn" onclick="closePanel()">âœ• Done</button></div>${lockBanner}<div id="panelContent"></div></div>`;
  const panels={edit:renderEditPanel,hindrances:renderHindrancesPanel,edges:renderEdgesPanel,skills:renderSkillsPanel,weapons:renderWeaponsPanel,armour:renderArmourPanel,gear:renderGearPanel,powers:renderPowersPanel,narrative:renderNarrativePanel,statblock:renderStatBlockPanel,audit:renderAuditPanel};
  const panels2={transfer:renderTransferPanel};
if(panels[activePanel]) panels[activePanel](n);
else if(panels2[activePanel]) panels2[activePanel](n);
}

function showPanel(name){
  const editPanels=['edit','hindrances','edges','skills','weapons','armour','gear','powers','narrative'];
  if(currentNPC&&editPanels.includes(name)&&isLocked(currentNPC.name)){
    if(!currentNPC._lockAcknowledged){
      if(!checkEditLock(currentNPC.name))return;
      currentNPC._lockAcknowledged=true;
    }
  }
  activePanel=name;if(currentNPC){renderMiddleColumn(currentNPC);renderStatColumn(currentNPC);}updateBreadcrumb();
}
function closePanel(){activePanel=null;if(currentNPC)renderDetail();updateBreadcrumb();}

function renderNarrativeColumn(n){
  const el=document.getElementById('colNarrative');
  const quote=n.quote?`<div class="npc-quote">"${esc(n.quote)}"</div>`:'';
  // Physical description and age
  let physLine='';
  if(n.physicalDescription||n.age){
    const agePart=n.age?`<span class="char-age">(Age ${n.age})</span>`:'';
    physLine=`<div class="phys-desc">${esc(n.physicalDescription||'')} ${agePart}</div>`;
  }
  const desc=n.description?`<div class="narrative-section"><h4 onclick="showPanel('narrative')">Description <span class="edit-icon">âœ</span></h4><p>${esc(n.description)}</p>${physLine}</div>`:(physLine?`<div class="narrative-section">${physLine}</div>`:'');
  const bg=n.background?`<div class="narrative-section"><h4 onclick="showPanel('narrative')">Background <span class="edit-icon">âœ</span></h4><p>${esc(n.background)}</p></div>`:'';
  // Personality
  const pers=n.personality?`<div class="narrative-section"><h4 onclick="showPanel('narrative')">Personality <span class="edit-icon">âœ</span></h4><p>${esc(n.personality)}</p></div>`:'';
  // Story parts
  let storyParts=[];
  if(n.motivation)storyParts.push(`<p><strong>What They Want:</strong> ${esc(n.motivation)}</p>`);
  if(n.secret)storyParts.push(`<p><strong>Their Secret:</strong> ${esc(n.secret)}</p>`);
  if(n.services)storyParts.push(`<p><strong>Services:</strong> ${esc(n.services)}</p>`);
  if(n.adventureHook)storyParts.push(`<p><strong>Adventure Hook:</strong> ${esc(n.adventureHook)}</p>`);
  if(n.tactics)storyParts.push(`<p><strong>Tactics:</strong> ${esc(n.tactics)}</p>`);
  const story=storyParts.length?`<div class="narrative-section"><h4 onclick="showPanel('narrative')">Story <span class="edit-icon">âœ</span></h4>${storyParts.join('')}</div>`:'';
  // Advancement (pre-gens mainly)
  const adv=n.advancement?`<div class="narrative-section"><h4 onclick="showPanel('narrative')">Advancement <span class="edit-icon">âœ</span></h4><p>${esc(n.advancement)}</p></div>`:'';
  // Connections
  let connHtml='';
  if(n.connections&&n.connections.length){
    const items=n.connections.map(c=>{
      const rel=c.relationship?`<span class="conn-rel">(${esc(c.relationship)})</span>`:'';
      const note=c.notes?` â€” ${esc(c.notes)}`:'';
      return `<li onclick="selectByRef('${esc(c.refCode)}')" title="Go to ${esc(c.name)}">${esc(c.name)} ${rel}${note}</li>`;
    }).join('');
    connHtml=`<div class="narrative-section"><h4 onclick="showPanel('narrative')">Connections <span class="edit-icon">âœ</span></h4><ul class="conn-list">${items}</ul></div>`;
  }
  // Appearances
  let appearHtml='';
  if(n.appearances&&n.appearances.length){
    const items=n.appearances.map(a=>{
      const role=a.role?`<span class="appear-role">${esc(a.role)}</span>`:'';
      return `<li><span class="appear-code">${esc(a.product)}</span>${esc(a.title||'')} ${role}</li>`;
    }).join('');
    appearHtml=`<div class="narrative-section"><h4 onclick="showPanel('narrative')">Appearances <span class="edit-icon">âœ</span></h4><ul class="appear-list">${items}</ul></div>`;
  }
  // Foreshadowing
  let fsHtml='';
  if(n.foreshadowing&&n.foreshadowing.length){
    const items=n.foreshadowing.map(f=>{
      return `<li><span class="fs-link">${esc(f.planted)}</span> â†’ <span class="fs-seed">${esc(f.seed)}</span> â†’ <span class="fs-link">${esc(f.paysOff)}</span></li>`;
    }).join('');
    fsHtml=`<div class="narrative-section"><h4 onclick="showPanel('narrative')">Foreshadowing <span class="edit-icon">âœ</span></h4><ul class="foreshadow-list">${items}</ul></div>`;
  }
  const portraitImg=n.portrait?`<div class="portrait-box"><img src="${n.portrait}" alt="${esc(n.name)}"></div>`:`<div class="portrait-box">No portrait</div>`;
  const portraitActions=n.portrait
    ?`<div class="portrait-actions"><a onclick="generatePortrait()">âœ¦ Generate</a> <a onclick="generatePortraitCustom()">âœ Prompt</a> <a onclick="uploadPortrait()">Replace</a> <a onclick="removePortrait()">Remove</a></div>`
    :`<div class="portrait-actions"><a onclick="generatePortrait()">âœ¦ Generate</a> <a onclick="generatePortraitCustom()">âœ Prompt</a> <a onclick="uploadPortrait()">Upload</a></div>`;
  el.innerHTML=`${portraitImg}${portraitActions}<input type="file" id="portraitInput" accept="image/*" style="display:none" onchange="handlePortraitUpload(this)"><div id="portraitStatus" style="font-size:11px;color:var(--text-dim);margin-bottom:6px"></div>${quote}${desc}${pers}${bg}${story}${adv}${connHtml}${appearHtml}${fsHtml}`;
}

// â•â•â• EDITOR PANELS â•â•â•
function renderEditPanel(n){
  const el=document.getElementById('panelContent');
  const dieSel=(id,val)=>{return `<div style="display:flex;align-items:center;gap:4px"><button class="btn sm" onclick="stepAttr('${id}',-1)" style="padding:1px 6px;font-size:13px;min-width:22px">âˆ’</button><span id="${id}" data-val="${val}" style="display:inline-block;min-width:36px;text-align:center;font-weight:bold;font-size:14px">${d(val)}</span><button class="btn sm" onclick="stepAttr('${id}',1)" style="padding:1px 6px;font-size:13px;min-width:22px">+</button></div>`;};
  el.innerHTML=`
    <div class="form-row"><div class="form-group" style="max-width:140px"><label>Ref Code</label><input id="ed_refCode" value="${esc(n.refCode||'')}" placeholder="AM-C001" style="font-family:monospace;font-size:13px;letter-spacing:0.5px"></div><div class="form-group"><label>Name *</label><input id="ed_name" value="${esc(n.name)}"></div><div class="form-group"><label>Title / Role</label><input id="ed_concept" value="${esc(n.concept)}"></div></div>
    <div class="form-row">
      <div class="form-group"><label>Region *</label><select id="ed_region">${['Ammaria','Saltlands','Vinlands','Concordium','Glasrya','Global'].map(r=>`<option ${n.region===r?'selected':''}>${r}</option>`).join('')}</select></div>
      <div class="form-group"><label>Tier *</label><select id="ed_tier">${['Wild Card','Extra','Walk-on'].map(t=>`<option ${n.tier===t?'selected':''}>${t}</option>`).join('')}</select></div>
      <div class="form-group"><label>Category</label><select id="ed_category">${['Pre-gen','NPC'].map(c=>`<option ${(n.category||'NPC')===c?'selected':''}>${c}</option>`).join('')}</select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Gender</label><select id="ed_gender">${['Unspecified','Male','Female','Other'].map(g=>`<option>${g}</option>`).join('')}</select></div>
      <div class="form-group"><label>Ancestry</label><select id="ed_ancestry">${['Human','Dwarf','Elf','Half-Folk','Other'].map(a=>`<option ${n.ancestry===a?'selected':''}>${a}</option>`).join('')}</select></div>
    </div>
    <div class="form-group"><label>Signature Quote</label><input id="ed_quote" value="${esc(n.quote)}"></div>
    <div class="form-group"><label>Description</label><textarea id="ed_description" rows="3">${esc(n.description)}</textarea></div>
    <div class="form-group"><label>Background</label><textarea id="ed_background" rows="3">${esc(n.background)}</textarea></div>
    <div class="form-row"><div class="form-group"><label>Agility</label>${dieSel('ed_agility',n.agility)}</div><div class="form-group"><label>Smarts</label>${dieSel('ed_smarts',n.smarts)}</div><div class="form-group"><label>Spirit</label>${dieSel('ed_spirit',n.spirit)}</div><div class="form-group"><label>Strength</label>${dieSel('ed_strength',n.strength)}</div><div class="form-group"><label>Vigor</label>${dieSel('ed_vigor',n.vigor)}</div></div>
    <div class="form-row"><div class="form-group"><label>Pace</label><input id="ed_pace" type="number" value="${n.pace}"></div><div class="form-group"><label>Parry</label><input id="ed_parry" type="number" value="${n.parry}"></div><div class="form-group"><label>Toughness</label><input id="ed_toughness" type="number" value="${n.toughness}"></div><div class="form-group"><label>Tough (Armor)</label><input id="ed_tougharmor" type="number" value="${n.toughnessArmor}"></div><div class="form-group"><label>Bennies</label><input id="ed_bennies" type="number" value="${n.bennies}"></div></div>
    <div class="form-row"><div class="form-group"><label>Starting Funds (â‚¡)</label><input id="ed_startFunds" type="number" value="${n.startingFunds}"></div><div class="form-group"><label>Gear Cost (â‚¡) <span style="font-size:10px;color:var(--text-dim)">auto</span></label><input id="ed_gearCost" type="number" value="${n.gearCost}" readonly style="opacity:0.7"></div><div class="form-group"><label>Remaining</label><span style="font-weight:bold;color:${n.startingFunds-n.gearCost>=0?'var(--green)':'var(--red)'}">${n.startingFunds-n.gearCost}â‚¡</span></div><div class="form-group" style="align-self:end"><button class="btn sm" onclick="recalcGearCost(currentNPC);renderEditPanel(currentNPC)" title="Recalculate gear cost from equipped items">âŸ³ Recalc</button></div></div>
    <div class="form-group"><label>Edges (legacy, comma-separated)</label><input id="ed_edges" value="${esc(n.edges.join(', '))}"></div>
    <div class="form-group"><label>Hindrances (legacy, comma-separated)</label><input id="ed_hindrances" value="${esc(n.hindrances.join(', '))}"></div>
    <div class="form-group"><label>Gear</label><input id="ed_gear" value="${esc(n.gearText)}"></div>
    <div class="form-actions"><button class="btn" onclick="closePanel()">Cancel</button><button class="btn primary" onclick="saveEdit()">Save Changes</button></div>`;
}
function saveEdit(){
  const n=currentNPC;
  n.name=document.getElementById('ed_name').value.trim();n.refCode=document.getElementById('ed_refCode').value.trim();n.concept=document.getElementById('ed_concept').value.trim();n.region=document.getElementById('ed_region').value;n.tier=document.getElementById('ed_tier').value;n.category=document.getElementById('ed_category').value;n.ancestry=document.getElementById('ed_ancestry').value;n.quote=document.getElementById('ed_quote').value.trim();n.description=document.getElementById('ed_description').value.trim();n.background=document.getElementById('ed_background').value.trim();
  n.agility=parseInt(document.getElementById('ed_agility').dataset.val);n.smarts=parseInt(document.getElementById('ed_smarts').dataset.val);n.spirit=parseInt(document.getElementById('ed_spirit').dataset.val);n.strength=parseInt(document.getElementById('ed_strength').dataset.val);n.vigor=parseInt(document.getElementById('ed_vigor').dataset.val);
  n.pace=parseInt(document.getElementById('ed_pace').value);n.parry=parseInt(document.getElementById('ed_parry').value);n.toughness=parseInt(document.getElementById('ed_toughness').value);n.toughnessArmor=parseInt(document.getElementById('ed_tougharmor').value);n.bennies=parseInt(document.getElementById('ed_bennies').value);n.startingFunds=parseInt(document.getElementById('ed_startFunds').value)||500;recalcGearCost(n);
  n.edges=csvToList(document.getElementById('ed_edges').value);n.hindrances=csvToList(document.getElementById('ed_hindrances').value);n.gearText=document.getElementById('ed_gear').value.trim();
  saveCharacter(n);closePanel();updateHeaderStats();
}

function renderHindrancesPanel(n){
  const el=document.getElementById('panelContent');
  const catalogue=getCatalogueHindrances();
  const items=n.hindrances.map((h,i)=>{
    const parsed=parseHindrance(h);
    return `<div class="item-entry" style="padding:4px 0">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="cursor:pointer" onclick="toggleHindNotes(${i})">${esc(parsed.name)} <span style="color:var(--text-dim);font-size:11px">(${esc(parsed.sev)}${parsed.notes?' â€” '+esc(parsed.notes):''})</span></span>
        <button class="btn sm danger" onclick="removeHindrance(this)" data-val="${esc(h)}">Ã—</button>
      </div>
      <div id="hindNotes_${i}" style="display:none;margin-top:4px">
        <input id="hindNotesInput_${i}" value="${esc(parsed.notes)}" placeholder="e.g. Wanted by the Brotherhood" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:3px;font-size:12px" onkeydown="if(event.key==='Enter')saveHindNotes(${i})">
        <button class="btn sm" onclick="saveHindNotes(${i})" style="margin-top:4px">Save</button>
      </div>
    </div>`;}).join('');
  el.innerHTML=`<div>${items||'<div style="color:var(--text-dim)">No hindrances yet</div>'}</div>
    <div class="catalogue-section"><h4>Add Hindrance</h4><div style="margin-bottom:4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Pick from Catalogue</div>
    <input type="text" id="hindSearch" placeholder="Search hindrances... (â†‘â†“ to browse)" oninput="filterHindCat()" onkeydown="hindCatKeyNav(event)" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:5px 8px;border-radius:3px;font-size:12px;margin-bottom:4px">
    <div style="display:flex;gap:8px;align-items:flex-start">
      <div class="catalogue-list" id="hindCatList" style="flex:1;min-width:0"></div>
      <div id="hindInfo" style="flex:1;min-width:0"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Name</label><input id="hind_name"></div><div class="form-group" style="max-width:120px"><label>Severity</label><select id="hind_sev"><option>Minor</option><option>Major</option></select></div></div>
    <div class="form-group"><label>Notes</label><input id="hind_notes" placeholder="Optional details"></div>
    <button class="btn primary" onclick="addHindrance()">Add Hindrance</button></div>`;
  filterHindCat();
}
var hindCatIdx=-1;
var hindCatFiltered=[];
function hasHindrance(name,n){
  if(!n)return false;
  return (n.hindrances||[]).some(h=>h.toLowerCase().startsWith(name.toLowerCase()));
}
function filterHindCat(){
  hindCatIdx=-1;
  const s=(document.getElementById('hindSearch')?.value||'').toLowerCase();
  hindCatFiltered=getCatalogueHindrances().filter(h=>!s||h.name.toLowerCase().includes(s));
  const el=document.getElementById('hindCatList');if(!el)return;
  el.innerHTML=hindCatFiltered.map((h,i)=>{const taken=hasHindrance(h.name,currentNPC);return `<div class="catalogue-item" onclick="selectHindInfo(${i})" style="color:${taken?'var(--text-dim)':'var(--green)'}"><span class="cat-name">${esc(h.name)}</span> <span class="cat-detail">(${esc(h.type||h.sev||'Minor')}) â€” ${esc(h.source)}</span></div>`;}).join('');
}
function hindCatKeyNav(e){
  const list=document.getElementById('hindCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');if(!items.length)return;
  if(e.key==='ArrowDown'){e.preventDefault();hindCatIdx=Math.min(hindCatIdx+1,items.length-1);highlightHindCat(items);}
  else if(e.key==='ArrowUp'){e.preventDefault();hindCatIdx=Math.max(hindCatIdx-1,0);highlightHindCat(items);}
  else if(e.key==='Enter'&&hindCatIdx>=0){e.preventDefault();selectHindInfo(hindCatIdx);}
}
function highlightHindCat(items){
  items.forEach((it,i)=>{it.style.background=i===hindCatIdx?'var(--accent)22':'';});
  if(items[hindCatIdx]){items[hindCatIdx].scrollIntoView({block:'nearest'});selectHindInfo(hindCatIdx);}
}
function selectHindInfo(idx){
  const h=hindCatFiltered[idx];if(!h)return;
  hindCatIdx=idx;
  document.getElementById('hind_name').value=h.name;
  document.getElementById('hind_sev').value=(h.type||h.sev||'Minor').includes('Major')?'Major':'Minor';
  const info=document.getElementById('hindInfo');if(!info)return;
  const taken=hasHindrance(h.name,currentNPC);
  const tagStyle=taken?'color:var(--text-dim)':'color:var(--green)';
  const tagText=taken?'Already taken':'Available';
  info.innerHTML=`<div class="cat-info" style="cursor:pointer" onclick="scrollToHindCatItem(${idx})"><div class="ci-name">${esc(h.name)} <span style="font-size:11px;${tagStyle}">${tagText}</span></div><div class="ci-meta">${esc(h.type||h.sev||'Minor')} Â· ${esc(h.source)}</div><div class="ci-desc">${esc(h.summary||'No description available.')}</div></div>`;
  const items=document.getElementById('hindCatList')?.querySelectorAll('.catalogue-item');
  if(items)items.forEach((it,i)=>{it.style.background=i===idx?'var(--accent)22':'';});
  setTimeout(()=>document.getElementById('hindSearch')?.focus(),0);
}
function scrollToHindCatItem(idx){
  const list=document.getElementById('hindCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');
  if(items[idx])items[idx].scrollIntoView({block:'nearest',behavior:'smooth'});
}
function addHindrance(){
  const name=document.getElementById('hind_name').value.trim();if(!name)return;
  const sev=document.getElementById('hind_sev').value;
  const notes=document.getElementById('hind_notes').value.trim();
  currentNPC.hindrances.push(notes?`${name} (${sev} â€” ${notes})`:`${name} (${sev})`);
  saveCharacter(currentNPC);renderHindrancesPanel(currentNPC);renderStatColumn(currentNPC);
}
function removeHindrance(btn){
  const val=btn.dataset.val;currentNPC.hindrances=currentNPC.hindrances.filter(x=>x!==val);
  saveCharacter(currentNPC);renderHindrancesPanel(currentNPC);renderStatColumn(currentNPC);
}
function parseHindrance(str){
  const m=str.match(/^(.+?)\s*\((\w+)(?:\s*â€”\s*(.*))?\)\s*$/);
  if(m)return{name:m[1].trim(),sev:m[2],notes:m[3]||''};
  return{name:str,sev:'Minor',notes:''};
}
function toggleHindNotes(idx){
  const el=document.getElementById('hindNotes_'+idx);if(!el)return;
  el.style.display=el.style.display==='none'?'block':'none';
  if(el.style.display==='block')document.getElementById('hindNotesInput_'+idx)?.focus();
}
function saveHindNotes(idx){
  const notes=document.getElementById('hindNotesInput_'+idx)?.value?.trim()||'';
  const parsed=parseHindrance(currentNPC.hindrances[idx]);
  currentNPC.hindrances[idx]=notes?`${parsed.name} (${parsed.sev} â€” ${notes})`:`${parsed.name} (${parsed.sev})`;
  saveCharacter(currentNPC);renderHindrancesPanel(currentNPC);renderStatColumn(currentNPC);
}

function renderEdgesPanel(n){
  if(!n.edgeNotes)n.edgeNotes={};
  const el=document.getElementById('panelContent');
  const items=n.edges.map((e,i)=>{const leg=isLegacyEdge(e)?' <span class="legacy-tag">(legacy)</span>':'';const note=n.edgeNotes[e]||'';const noteDisp=note?` <span style="color:var(--text-dim);font-size:11px">â€” ${esc(note)}</span>`:'';return `<div class="item-entry" style="padding:4px 0">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="cursor:pointer" onclick="showExistingEdgeInfo('${esc(e)}');toggleEdgeNotes(${i})">${esc(e)}${noteDisp}${leg}</span>
        <button class="btn sm danger" onclick="removeEdge(this)" data-val="${esc(e)}">Ã—</button>
      </div>
      <div id="edgeNotes_${i}" style="display:none;margin-top:4px">
        <input id="edgeNotesInput_${i}" value="${esc(note)}" placeholder="e.g. Thieves Guild, Brotherhood contacts" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:3px;font-size:12px" onkeydown="if(event.key==='Enter')saveEdgeNotes(${i})">
        <button class="btn sm" onclick="saveEdgeNotes(${i})" style="margin-top:4px">Save</button>
      </div>
    </div>`;}).join('');
  el.innerHTML=`<div>${items||'<div style="color:var(--text-dim)">No edges yet</div>'}</div>
    <div class="catalogue-section"><h4>Add Edge</h4>
    <input type="text" id="edgeSearch" placeholder="Search edges... (â†‘â†“ to browse)" oninput="filterEdgeCat()" onkeydown="edgeCatKeyNav(event)" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:5px 8px;border-radius:3px;font-size:12px;margin-bottom:4px">
    <div style="display:flex;gap:8px;align-items:flex-start">
      <div class="catalogue-list" id="edgeCatList" style="flex:1;min-width:0"></div>
      <div id="edgeInfo" style="flex:1;min-width:0"></div>
    </div>
    <div class="form-group"><label>Name</label><input id="edge_name"></div>
    <button class="btn primary" onclick="addEdge()">Add Edge</button></div>`;
  filterEdgeCat();
}
function filterEdgeCat(){
  edgeCatIdx=-1;
  const s=(document.getElementById('edgeSearch')?.value||'').toLowerCase();
  edgeCatFiltered=getCatalogueEdges().filter(e=>!s||e.name.toLowerCase().includes(s));
  const el=document.getElementById('edgeCatList');if(!el)return;
  el.innerHTML=edgeCatFiltered.map((e,i)=>{const ok=meetsEdgeReqs(e,currentNPC);return `<div class="catalogue-item" data-idx="${i}" onclick="selectEdgeInfo(${i})" style="color:${ok?'var(--green)':'var(--text-dim)'}"><span class="cat-name">${esc(e.name)}</span> <span class="cat-detail">${esc(e.rank||'')} ${esc(e.cat||e.type||'')} â€” ${esc(e.source)}</span></div>`;}).join('');
}
var edgeCatIdx=-1;
var edgeCatFiltered=[];
function meetsEdgeReqs(edge,n){
  if(!n)return false;
  const rankOrder={N:0,Novice:0,S:1,Seasoned:1,V:2,Veteran:2,H:3,Heroic:3,L:4,Legendary:4};
  const charRank=rankOrder[n.rank]||0;
  const edgeRank=rankOrder[edge.rank]||0;
  if(charRank<edgeRank)return false;
  const reqs=edge.reqs||'';
  if(reqs==='â€”'||!reqs)return true;
  const parts=reqs.split(',').map(s=>s.trim());
  const attrs={agility:n.agility||0,smarts:n.smarts||0,spirit:n.spirit||0,strength:n.strength||0,vigor:n.vigor||0};
  for(const p of parts){
    const attrMatch=p.match(/^(Agility|Smarts|Spirit|Strength|Vigor)\s+d(\d+)\+?$/i);
    if(attrMatch){if((attrs[attrMatch[1].toLowerCase()]||0)<parseInt(attrMatch[2]))return false;continue;}
    const skillMatch=p.match(/^(\w[\w\s]*?)\s+d(\d+)\+?$/);
    if(skillMatch){const has=Object.entries(n.skills||{}).find(([k])=>k.toLowerCase()===skillMatch[1].toLowerCase());if(!has||has[1]<parseInt(skillMatch[2]))return false;continue;}
    if(p.match(/only$/i)||p.match(/^d\d/)||p.match(/related skill/i))continue;
    const edgeReq=p.replace(/\s*\(.*\)/,'').trim();
    if(edgeReq.length>1&&edgeReq!=='â€”'){if(!(n.edges||[]).some(e=>e===edgeReq||e.startsWith(edgeReq+' (')))return false;}
  }
  return true;
}
function edgeCatKeyNav(e){
  const list=document.getElementById('edgeCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');if(!items.length)return;
  if(e.key==='ArrowDown'){e.preventDefault();edgeCatIdx=Math.min(edgeCatIdx+1,items.length-1);highlightEdgeCat(items);}
  else if(e.key==='ArrowUp'){e.preventDefault();edgeCatIdx=Math.max(edgeCatIdx-1,0);highlightEdgeCat(items);}
  else if(e.key==='Enter'&&edgeCatIdx>=0){e.preventDefault();items[edgeCatIdx].click();}
}
function highlightEdgeCat(items){
  items.forEach((it,i)=>{it.style.background=i===edgeCatIdx?'var(--accent)22':'';});
  if(items[edgeCatIdx]){items[edgeCatIdx].scrollIntoView({block:'nearest'});selectEdgeInfo(edgeCatIdx);}
}
function selectEdgeInfo(idx){
  const e=edgeCatFiltered[idx];if(!e)return;
  edgeCatIdx=idx;
  document.getElementById('edge_name').value=e.name;
  const info=document.getElementById('edgeInfo');if(!info)return;
  const ok=meetsEdgeReqs(e,currentNPC);
  const eligStyle=ok?'color:var(--green)':'color:var(--red)';
  const eligText=ok?'âœ“ Eligible':'âœ— Requirements not met';
  const reqs=e.reqs&&e.reqs!=='â€”'?`<div class="ci-meta">Requirements: ${esc(e.reqs)}</div>`:'';
  let abPicker='';
  if(e.name==='Arcane Background'){
    abPicker=`<div style="margin-top:6px"><label style="font-size:11px;text-transform:uppercase;color:var(--text-dim)">Type</label><select id="abTypePick" onchange="document.getElementById('edge_name').value='Arcane Background ('+this.value+')'" style="margin-left:6px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:3px;font-size:12px"><option value="Gifted">Gifted</option><option value="Magic">Magic</option><option value="Miracles">Miracles</option><option value="Psionics">Psionics</option><option value="Weird Science">Weird Science</option></select></div>`;
    document.getElementById('edge_name').value='Arcane Background (Gifted)';
  }
  info.innerHTML=`<div class="cat-info" style="cursor:pointer" onclick="scrollToEdgeCatItem(${idx})"><div class="ci-name">${esc(e.name)} <span style="font-size:11px;${eligStyle}">${eligText}</span></div><div class="ci-meta">${esc(e.rank||'N')} Â· ${esc(e.cat||e.type||'General')} Â· ${esc(e.source)}</div>${reqs}<div class="ci-desc">${esc(e.summary||'No description available.')}</div>${abPicker}</div>`;
  // highlight active in list
  const items=document.getElementById('edgeCatList')?.querySelectorAll('.catalogue-item');
  if(items)items.forEach((it,i)=>{it.style.background=i===idx?'var(--accent)22':'';});
  setTimeout(()=>document.getElementById('edgeSearch')?.focus(),0);
}
function scrollToEdgeCatItem(idx){
  const list=document.getElementById('edgeCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');
  if(items[idx]){items[idx].scrollIntoView({block:'nearest',behavior:'smooth'});}
}
function showExistingEdgeInfo(name){
  const search=document.getElementById('edgeSearch');if(search)search.value='';
  filterEdgeCat();
  const baseName=name.replace(/\s*\(.*\)/,'').trim();
  const idx=edgeCatFiltered.findIndex(e=>e.name===name||e.name===baseName);
  if(idx>=0){selectEdgeInfo(idx);scrollToEdgeCatItem(idx);}
  else{const info=document.getElementById('edgeInfo');if(info)info.innerHTML=`<div class="cat-info"><div class="ci-name">${esc(name)}</div><div class="ci-desc" style="color:var(--text-dim)">Custom edge â€” not in catalogue</div></div>`;}
}
function addEdge(){const name=document.getElementById('edge_name').value.trim();if(!name)return;currentNPC.edges.push(name);saveCharacter(currentNPC);renderEdgesPanel(currentNPC);renderStatColumn(currentNPC);}
function removeEdge(btn){const val=btn.dataset.val;currentNPC.edges=currentNPC.edges.filter(x=>x!==val);if(currentNPC.edgeNotes)delete currentNPC.edgeNotes[val];saveCharacter(currentNPC);renderEdgesPanel(currentNPC);renderStatColumn(currentNPC);}
function toggleEdgeNotes(idx){
  const el=document.getElementById('edgeNotes_'+idx);if(!el)return;
  el.style.display=el.style.display==='none'?'block':'none';
  if(el.style.display==='block')document.getElementById('edgeNotesInput_'+idx)?.focus();
}
function saveEdgeNotes(idx){
  const notes=document.getElementById('edgeNotesInput_'+idx)?.value?.trim()||'';
  const edge=currentNPC.edges[idx];if(!edge)return;
  if(!currentNPC.edgeNotes)currentNPC.edgeNotes={};
  if(notes)currentNPC.edgeNotes[edge]=notes;else delete currentNPC.edgeNotes[edge];
  saveCharacter(currentNPC);renderEdgesPanel(currentNPC);renderStatColumn(currentNPC);
}

function renderSkillsPanel(n){
  const el=document.getElementById('panelContent');
  const CF=window.CharacterForge;
  const Rules=window.SWADERules;
  const DICE=Rules.DICE;
  const coreSkillNames=(CF.data?.coreSkills||[]);
  const coreLC=coreSkillNames.map(s=>s.toLowerCase());
  const skillLinks=CF.data?.skillLinks||{};
  const attrs={agility:n.agility,smarts:n.smarts,spirit:n.spirit,strength:n.strength,vigor:n.vigor};
  const ancestryData=(CF.data.ancestries&&CF.data.ancestries[n.ancestry])||{attrBonus:1,freeEdges:1};
  // Calculate what hindrance points are consumed by attrs and edges
  const hindPts=Rules.calcHindrancePoints(n.hindrances);
  const attrBase=Rules.calcAttributeBudget(attrs,ancestryData,0);
  const attrHindSpend=Math.max(0,attrBase.spent-attrBase.total);
  const edgeBase=Rules.calcEdgeBudget(n.edges.length,ancestryData,0);
  const edgeHindSpend=Math.max(0,edgeBase.spent-edgeBase.total);
  // Remaining hindrance pts available for skills (attrs cost 2 hind pts each, edges 2 each)
  const hindUsedByOther=attrHindSpend*2+edgeHindSpend*2;
  const hindAvailForSkills=Math.max(0,hindPts.effective-hindUsedByOther);
  // Skill budget = 12 base + all hindrance pts that COULD go to skills
  const budget=Rules.calcSkillBudget(n.skills,attrs,skillLinks,coreSkillNames,hindAvailForSkills);
  const remaining=budget.remaining;
  const budgetColour=remaining<0?'var(--red)':remaining===0?'var(--text-dim)':'var(--green)';
  const rows=Object.entries(n.skills).sort((a,b)=>a[0].localeCompare(b[0])).map(([name,die])=>{
    const isCore=coreLC.includes(name.toLowerCase());
    const star=isCore?'<span style="color:var(--accent)" title="Core Skill"> â˜…</span>':'';
    // Determine colour for this skill row
    const linked=skillLinks[name];
    const linkedDie=linked?(attrs[linked]||4):4;
    const dIdx=DICE.indexOf(die);
    const atD12=dIdx>=DICE.length-1;
    let rowColour='var(--text-dim)';  // grey default
    let costHint='';
    if(!atD12){
      const nextDie=DICE[dIdx+1];
      const nextCost=nextDie>linkedDie?2:1;
      if(remaining>=nextCost){
        rowColour=nextCost===1?'var(--green)':'#e8b84e';
        costHint='<span style="font-size:10px;margin-left:6px;color:'+rowColour+'" title="Next step costs '+nextCost+'pt'+(nextCost>1?'s':'')+(nextCost===2?' (exceeds '+linked+' d'+linkedDie+')':'')+'">'+nextCost+'pt</span>';
      }
    }
    return '<tr style="border-left:3px solid '+rowColour+'">'
      +'<td style="cursor:pointer;padding-left:8px" onclick="showExistingSkillInfo(\''+esc(name)+'\')">'+esc(name)+star+costHint+'</td>'
      +'<td style="text-align:center"><button class="btn sm" onclick="stepSkill(\''+esc(name)+'\',-1)" style="padding:1px 6px;font-size:13px;min-width:22px">âˆ’</button> <span style="display:inline-block;min-width:42px;text-align:center;font-weight:bold;color:'+rowColour+'">'+d(die)+'</span> <button class="btn sm" onclick="stepSkill(\''+esc(name)+'\',1)" style="padding:1px 6px;font-size:13px;min-width:22px">+</button></td>'
      +'<td><button class="btn sm danger" onclick="removeSkill(\''+esc(name)+'\')" title="Remove skill">Ã—</button></td></tr>';
  }).join('');
  const budgetLine='<div style="margin-bottom:8px;font-size:12px;padding:6px 10px;background:var(--bg-body);border:1px solid var(--border);border-radius:3px"><span style="color:var(--text-dim)">Skill Points:</span> <strong style="color:'+budgetColour+'">'+budget.spent+' / '+budget.total+'</strong> <span style="color:var(--text-dim)">('+remaining+' remaining)</span></div>';
  el.innerHTML=budgetLine+`<table class="data-table"><tr><th>Skill</th><th>Die</th><th></th></tr>${rows||'<tr><td colspan="3" style="color:var(--text-dim)">No skills</td></tr>'}</table>
    <div class="catalogue-section"><h4>Add Skill</h4>
    <div style="margin-bottom:4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Pick from Catalogue</div>
    <input placeholder="Search skills... (â†‘â†“ to browse)" oninput="filterSkillCatalogue(this.value)" onkeydown="skillCatKeyNav(event)" id="skillSearch" style="width:100%;margin-bottom:4px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px">
    <div style="display:flex;gap:8px;align-items:flex-start">
      <div class="catalogue-list" id="skillCatList" style="flex:1;min-width:0"></div>
      <div id="skillInfo" style="flex:1;min-width:0"></div>
    </div>
    <div style="margin:10px 0 4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Or Enter Custom</div>
    <div class="form-row"><div class="form-group"><label>Skill Name</label><input id="skill_name"></div></div>
    <button class="btn primary" onclick="addSkill()">Add Skill (d4)</button></div>`;
  filterSkillCatalogue('');
}
var skillCatIdx=-1;
var skillCatFiltered=[];
function filterSkillCatalogue(s){
  skillCatIdx=-1;
  s=s.toLowerCase();
  const existing=currentNPC?Object.keys(currentNPC.skills).map(k=>k.toLowerCase()):[];
  skillCatFiltered=getCatalogueSkills().filter(sk=>(!s||sk.name.toLowerCase().includes(s)));
  const el=document.getElementById('skillCatList');if(!el)return;
  el.innerHTML=skillCatFiltered.map((sk,i)=>{const taken=existing.includes(sk.name.toLowerCase());return `<div class="catalogue-item" data-idx="${i}" onclick="selectSkillInfo(${i})" style="color:${taken?'var(--text-dim)':'var(--green)'}"><span class="cat-name">${esc(sk.name)}</span> <span class="cat-detail">(${esc(sk.attr)})${sk.core?' â˜…':''} â€” ${esc(sk.source)}</span></div>`;}).join('');
}
function skillCatKeyNav(e){
  const list=document.getElementById('skillCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');if(!items.length)return;
  if(e.key==='ArrowDown'){e.preventDefault();skillCatIdx=Math.min(skillCatIdx+1,items.length-1);highlightSkillCat(items);}
  else if(e.key==='ArrowUp'){e.preventDefault();skillCatIdx=Math.max(skillCatIdx-1,0);highlightSkillCat(items);}
  else if(e.key==='Enter'&&skillCatIdx>=0){e.preventDefault();selectSkillInfo(skillCatIdx);}
}
function highlightSkillCat(items){
  items.forEach((it,i)=>{it.style.background=i===skillCatIdx?'var(--accent)22':'';});
  if(items[skillCatIdx]){items[skillCatIdx].scrollIntoView({block:'nearest'});selectSkillInfo(skillCatIdx);}
}
function selectSkillInfo(idx){
  const sk=skillCatFiltered[idx];if(!sk)return;
  skillCatIdx=idx;
  document.getElementById('skill_name').value=sk.name;
  const info=document.getElementById('skillInfo');if(!info)return;
  const existing=currentNPC?Object.keys(currentNPC.skills).map(k=>k.toLowerCase()):[];
  const taken=existing.includes(sk.name.toLowerCase());
  const tagStyle=taken?'color:var(--text-dim)':'color:var(--green)';
  const tagText=taken?'Already taken':'Available';
  const coreTag=sk.core?'<span style="color:var(--accent);font-size:10px;margin-left:4px">â˜… CORE</span>':'';
  info.innerHTML=`<div class="cat-info" style="cursor:pointer" onclick="scrollToSkillCatItem(${idx})"><div class="ci-name">${esc(sk.name)}${coreTag} <span style="font-size:11px;${tagStyle}">${tagText}</span></div><div class="ci-meta">Linked Attribute: ${esc(sk.attr.charAt(0).toUpperCase()+sk.attr.slice(1))} Â· ${esc(sk.source)}</div><div class="ci-desc">${esc(sk.summary||'No description available.')}</div></div>`;
  const items=document.getElementById('skillCatList')?.querySelectorAll('.catalogue-item');
  if(items)items.forEach((it,i)=>{it.style.background=i===idx?'var(--accent)22':'';});
  setTimeout(()=>document.getElementById('skillSearch')?.focus(),0);
}
function scrollToSkillCatItem(idx){
  const list=document.getElementById('skillCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');
  if(items[idx])items[idx].scrollIntoView({block:'nearest',behavior:'smooth'});
}
function showExistingSkillInfo(name){
  const search=document.getElementById('skillSearch');if(search)search.value='';
  filterSkillCatalogue('');
  const idx=skillCatFiltered.findIndex(s=>s.name===name);
  if(idx>=0){selectSkillInfo(idx);scrollToSkillCatItem(idx);}
  else{const info=document.getElementById('skillInfo');if(info)info.innerHTML=`<div class="cat-info"><div class="ci-name">${esc(name)}</div><div class="ci-desc" style="color:var(--text-dim)">Custom skill â€” not in catalogue</div></div>`;}
}
function selectCatalogueSkill(name){document.getElementById('skill_name').value=name;}
function addSkill(){const name=document.getElementById('skill_name').value.trim();if(!name)return;currentNPC.skills[name]=4;calcDerived(currentNPC);saveCharacter(currentNPC);renderSkillsPanel(currentNPC);renderStatColumn(currentNPC);}
function stepAttr(id,dir){const el=document.getElementById(id);if(!el)return;let v=parseInt(el.dataset.val)||0;const cap=isPregen();v=dir>0?dieStepUp(v,cap):dieStepDown(v);if(v<0)v=0;el.dataset.val=v;el.textContent=d(v);}
function stepSkill(name,dir){console.log("ğŸ¯ stepSkill:",name,dir>0?"+":"-");if(!currentNPC||!currentNPC.skills[name])return;const v=currentNPC.skills[name];const cap=isPregen();currentNPC.skills[name]=dir>0?dieStepUp(v,cap):dieStepDown(v);calcDerived(currentNPC);saveCharacter(currentNPC);renderSkillsPanel(currentNPC);renderStatColumn(currentNPC);}
function removeSkill(name){
  const coreSkills=(window.CharacterForge?.data?.coreSkills||[]).map(s=>s.toLowerCase());
  if(coreSkills.includes(name.toLowerCase())){if(!confirm(name+' is a Core Skill. Are you sure you want to remove it?'))return;}
  delete currentNPC.skills[name];calcDerived(currentNPC);saveCharacter(currentNPC);renderSkillsPanel(currentNPC);renderStatColumn(currentNPC);
}

/* â•â•â• WEAPONS PANEL â€” full catalogue with info, keyboard nav, colour coding â•â•â• */
var wepCatIdx=-1, wepCatFiltered=[];
function renderWeaponsPanel(n){
  const owned=n.weapons.map(w=>w.name.toLowerCase());
  const current=n.weapons.map((w,i)=>`<div class="item-entry" style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;cursor:pointer" onclick="showExistingWepInfo('${esc(w.name).replace(/'/g,"\\'")}')"><span>${esc(w.name)} <span style="color:var(--text-dim)">${esc(w.damage)}${w.ap?' AP'+w.ap:''}${w.range?' '+w.range:''}</span>${w.cost?` <span style="color:var(--accent);font-size:11px">${w.cost}â‚¡</span>`:''}</span><button class="btn sm danger" onclick="event.stopPropagation();removeWeapon(${i})">Ã—</button></div>`).join('');
  document.getElementById('panelContent').innerHTML=`${renderBudgetBar(n)}<div>${current||'<div style="color:var(--text-dim)">No weapons</div>'}</div>
    <div class="catalogue-section"><h4>Add Weapon</h4>
    <input placeholder="Search weapons... (â†‘â†“ to browse)" id="wepSearch" oninput="filterWeaponCatalogue(this.value)" onkeydown="wepCatKeyNav(event)" style="width:100%;margin-bottom:4px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px">
    <div style="display:flex;gap:8px;align-items:flex-start">
      <div class="catalogue-list" id="wepCatList" style="flex:1;min-width:0"></div>
      <div id="wepInfo" style="flex:1;min-width:0"></div>
    </div>
    <div style="margin:10px 0 4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Or Enter Custom</div>
    <div class="form-row"><div class="form-group"><label>Name</label><input id="wep_name"></div><div class="form-group"><label>Damage</label><input id="wep_damage" placeholder="Str+d8"></div></div>
    <div class="form-row"><div class="form-group" style="max-width:80px"><label>AP</label><input id="wep_ap" type="number" value="0"></div><div class="form-group"><label>Range</label><input id="wep_range" placeholder=""></div><div class="form-group"><label>Notes</label><input id="wep_notes"></div></div>
    <button class="btn primary" onclick="addWeapon()">Add Weapon</button></div>`;
  filterWeaponCatalogue('');
}
function filterWeaponCatalogue(s){
  wepCatIdx=-1;
  s=(s||'').toLowerCase();
  const owned=currentNPC?currentNPC.weapons.map(w=>w.name.toLowerCase()):[];
  wepCatFiltered=getCatalogueWeapons().filter(w=>!s||w.name.toLowerCase().includes(s));
  const el=document.getElementById('wepCatList');if(!el)return;
  el.innerHTML=wepCatFiltered.map((w,i)=>{const has=owned.includes(w.name.toLowerCase());return `<div class="catalogue-item" data-idx="${i}" onclick="selectWepInfo(${i})" style="color:${has?'var(--text-dim)':'var(--green)'}"><span class="cat-name">${esc(w.name)}</span> <span class="cat-detail">${esc(w.dmg)}${w.ap?' AP'+w.ap:''}${w.range?' '+w.range:''} â€” ${esc(w.source)}</span></div>`;}).join('');
  window._wepCatList=wepCatFiltered;
}
function selectWepInfo(idx){
  const w=wepCatFiltered[idx];if(!w)return;
  wepCatIdx=idx;
  document.getElementById('wep_name').value=w.name;
  document.getElementById('wep_damage').value=w.dmg;
  document.getElementById('wep_ap').value=w.ap||0;
  document.getElementById('wep_range').value=w.range||'';
  document.getElementById('wep_notes').value=w.notes||'';
  const info=document.getElementById('wepInfo');if(!info)return;
  const owned=currentNPC?currentNPC.weapons.some(x=>x.name.toLowerCase()===w.name.toLowerCase()):false;
  const ownStyle=owned?'color:var(--text-dim)':'color:var(--green)';
  const ownText=owned?'Already equipped':'Available';
  let details=`<div class="ci-meta">${esc(w.type||'Melee')} Â· ${esc(w.source)}</div>`;
  details+=`<div class="ci-meta">Damage: ${esc(w.dmg)}${w.ap?' Â· AP '+w.ap:''}${w.range?' Â· Range '+w.range:''}${w.rof?' Â· ROF '+w.rof:''}</div>`;
  if(w.cost||w.wt) details+=`<div class="ci-meta">${w.cost?w.cost+'â‚¡':''}${w.cost&&w.wt?' Â· ':''}${w.wt?w.wt+' lbs':''}</div>`;
  if(w.notes) details+=`<div class="ci-desc">${esc(w.notes)}</div>`;
  info.innerHTML=`<div class="cat-info" style="cursor:pointer" onclick="scrollToWepCatItem(${idx})"><div class="ci-name">${esc(w.name)} <span style="font-size:11px;${ownStyle}">${ownText}</span></div>${details}</div>`;
  const items=document.getElementById('wepCatList')?.querySelectorAll('.catalogue-item');
  if(items)items.forEach((it,i)=>{it.style.background=i===idx?'var(--accent)22':'';});
  setTimeout(()=>document.getElementById('wepSearch')?.focus(),0);
}
function wepCatKeyNav(e){
  const list=document.getElementById('wepCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');if(!items.length)return;
  if(e.key==='ArrowDown'){e.preventDefault();wepCatIdx=Math.min(wepCatIdx+1,items.length-1);highlightWepCat(items);}
  else if(e.key==='ArrowUp'){e.preventDefault();wepCatIdx=Math.max(wepCatIdx-1,0);highlightWepCat(items);}
  else if(e.key==='Enter'&&wepCatIdx>=0){e.preventDefault();items[wepCatIdx].click();}
}
function highlightWepCat(items){
  items.forEach((it,i)=>{it.style.background=i===wepCatIdx?'var(--accent)22':'';});
  if(items[wepCatIdx]){items[wepCatIdx].scrollIntoView({block:'nearest'});selectWepInfo(wepCatIdx);}
}
function scrollToWepCatItem(idx){
  const list=document.getElementById('wepCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');
  if(items[idx]){items[idx].scrollIntoView({block:'nearest',behavior:'smooth'});}
}
function showExistingWepInfo(name){
  const search=document.getElementById('wepSearch');if(search)search.value='';
  filterWeaponCatalogue('');
  const idx=wepCatFiltered.findIndex(w=>w.name.toLowerCase()===name.toLowerCase());
  if(idx>=0){selectWepInfo(idx);scrollToWepCatItem(idx);}
  else{const info=document.getElementById('wepInfo');if(info)info.innerHTML=`<div class="cat-info"><div class="ci-name">${esc(name)}</div><div class="ci-desc" style="color:var(--text-dim)">Custom weapon â€” not in catalogue</div></div>`;}
}
function addWeapon(){
  const name=document.getElementById('wep_name').value.trim(),dmg=document.getElementById('wep_damage').value.trim();
  if(!name||!dmg)return;
  // Look up cost from catalogue
  const catMatch=getCatalogueWeapons().find(w=>w.name.toLowerCase()===name.toLowerCase());
  const cost=catMatch&&catMatch.cost?catMatch.cost:0;
  currentNPC.weapons.push({name,damage:dmg,ap:parseInt(document.getElementById('wep_ap').value)||0,range:document.getElementById('wep_range').value.trim(),notes:document.getElementById('wep_notes').value.trim(),source:'Manual',cost:cost});
  recalcGearCost(currentNPC);saveCharacter(currentNPC);renderWeaponsPanel(currentNPC);renderStatColumn(currentNPC);
}
function removeWeapon(idx){currentNPC.weapons.splice(idx,1);recalcGearCost(currentNPC);saveCharacter(currentNPC);renderWeaponsPanel(currentNPC);renderStatColumn(currentNPC);}
function addWeaponToGear(){addWeapon();}

/* â•â•â• ARMOUR PANEL â€” full catalogue with info, keyboard nav, colour coding â•â•â• */
var armCatIdx=-1, armCatFiltered=[];
function renderArmourPanel(n){
  const current=n.armour.map((a,i)=>`<div class="item-entry" style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;cursor:pointer" onclick="showExistingArmInfo('${esc(a.name).replace(/'/g,"\\'")}')"><span>${esc(a.name)} <span style="color:var(--accent)">(+${a.armor})</span>${a.notes?' <span style="color:var(--text-dim)">'+esc(a.notes)+'</span>':''}${a.cost?' <span style="color:var(--accent);font-size:11px">'+a.cost+'â‚¡</span>':''}</span><button class="btn sm danger" onclick="event.stopPropagation();removeArmour(${i})">Ã—</button></div>`).join('');
  document.getElementById('panelContent').innerHTML=`${renderBudgetBar(n)}<div>${current||'<div style="color:var(--text-dim)">No armour</div>'}</div>
    <div class="catalogue-section"><h4>Add Armour</h4>
    <input placeholder="Search armour & shields... (â†‘â†“ to browse)" id="armSearch" oninput="filterArmourCatalogue(this.value)" onkeydown="armCatKeyNav(event)" style="width:100%;margin-bottom:4px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px">
    <div style="display:flex;gap:8px;align-items:flex-start">
      <div class="catalogue-list" id="armCatList" style="flex:1;min-width:0"></div>
      <div id="armInfo" style="flex:1;min-width:0"></div>
    </div>
    <div style="margin:10px 0 4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Or Enter Custom</div>
    <div class="form-row"><div class="form-group"><label>Name</label><input id="arm_name"></div><div class="form-group" style="max-width:100px"><label>Protection</label><input id="arm_prot" type="number" value="2"></div></div>
    <div class="form-row"><div class="form-group"><label>Notes</label><input id="arm_notes"></div></div>
    <button class="btn primary" onclick="addArmour()">Add Armour</button></div>`;
  filterArmourCatalogue('');
}
function filterArmourCatalogue(s){
  armCatIdx=-1;
  s=(s||'').toLowerCase();
  const owned=currentNPC?currentNPC.armour.map(a=>a.name.toLowerCase()):[];
  armCatFiltered=getCatalogueArmour().filter(a=>!s||a.name.toLowerCase().includes(s));
  const el=document.getElementById('armCatList');if(!el)return;
  el.innerHTML=armCatFiltered.map((a,i)=>{
    const has=owned.includes(a.name.toLowerCase());
    const val=a.armor?'+'+a.armor:(a.parry?'Parry +'+a.parry:'');
    return `<div class="catalogue-item" data-idx="${i}" onclick="selectArmInfo(${i})" style="color:${has?'var(--text-dim)':'var(--green)'}"><span class="cat-name">${esc(a.name)}</span> <span class="cat-detail">(${val}) â€” ${esc(a.source)}</span></div>`;
  }).join('');
  window._armCatList=armCatFiltered;
}
function selectArmInfo(idx){
  const a=armCatFiltered[idx];if(!a)return;
  armCatIdx=idx;
  document.getElementById('arm_name').value=a.name;
  document.getElementById('arm_prot').value=a.armor||a.parry||0;
  document.getElementById('arm_notes').value=a.notes||'';
  const info=document.getElementById('armInfo');if(!info)return;
  const owned=currentNPC?currentNPC.armour.some(x=>x.name.toLowerCase()===a.name.toLowerCase()):false;
  const ownStyle=owned?'color:var(--text-dim)':'color:var(--green)';
  const ownText=owned?'Already equipped':'Available';
  let details=`<div class="ci-meta">${esc(a.type||'Armour')} Â· ${esc(a.source)}</div>`;
  if(a.armor) details+=`<div class="ci-meta">Protection: +${a.armor}</div>`;
  if(a.parry) details+=`<div class="ci-meta">Parry: +${a.parry}</div>`;
  if(a.cost||a.wt) details+=`<div class="ci-meta">${a.cost?a.cost+'â‚¡':''}${a.cost&&a.wt?' Â· ':''}${a.wt?a.wt+' lbs':''}</div>`;
  if(a.notes) details+=`<div class="ci-desc">${esc(a.notes)}</div>`;
  info.innerHTML=`<div class="cat-info" style="cursor:pointer" onclick="scrollToArmCatItem(${idx})"><div class="ci-name">${esc(a.name)} <span style="font-size:11px;${ownStyle}">${ownText}</span></div>${details}</div>`;
  const items=document.getElementById('armCatList')?.querySelectorAll('.catalogue-item');
  if(items)items.forEach((it,i)=>{it.style.background=i===idx?'var(--accent)22':'';});
  setTimeout(()=>document.getElementById('armSearch')?.focus(),0);
}
function armCatKeyNav(e){
  const list=document.getElementById('armCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');if(!items.length)return;
  if(e.key==='ArrowDown'){e.preventDefault();armCatIdx=Math.min(armCatIdx+1,items.length-1);highlightArmCat(items);}
  else if(e.key==='ArrowUp'){e.preventDefault();armCatIdx=Math.max(armCatIdx-1,0);highlightArmCat(items);}
  else if(e.key==='Enter'&&armCatIdx>=0){e.preventDefault();items[armCatIdx].click();}
}
function highlightArmCat(items){
  items.forEach((it,i)=>{it.style.background=i===armCatIdx?'var(--accent)22':'';});
  if(items[armCatIdx]){items[armCatIdx].scrollIntoView({block:'nearest'});selectArmInfo(armCatIdx);}
}
function scrollToArmCatItem(idx){
  const list=document.getElementById('armCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');
  if(items[idx]){items[idx].scrollIntoView({block:'nearest',behavior:'smooth'});}
}
function showExistingArmInfo(name){
  const search=document.getElementById('armSearch');if(search)search.value='';
  filterArmourCatalogue('');
  const idx=armCatFiltered.findIndex(a=>a.name.toLowerCase()===name.toLowerCase());
  if(idx>=0){selectArmInfo(idx);scrollToArmCatItem(idx);}
  else{const info=document.getElementById('armInfo');if(info)info.innerHTML=`<div class="cat-info"><div class="ci-name">${esc(name)}</div><div class="ci-desc" style="color:var(--text-dim)">Custom armour â€” not in catalogue</div></div>`;}
}
function addArmour(){
  const name=document.getElementById('arm_name').value.trim();if(!name)return;
  const armor=parseInt(document.getElementById('arm_prot').value)||0;
  const catMatch=getCatalogueArmour().find(a=>a.name.toLowerCase()===name.toLowerCase());
  const cost=catMatch&&catMatch.cost?catMatch.cost:0;
  currentNPC.armour.push({name,armor,notes:document.getElementById('arm_notes').value.trim(),source:'Manual',cost:cost});
  recalcArmour();recalcGearCost(currentNPC);saveCharacter(currentNPC);renderArmourPanel(currentNPC);renderStatColumn(currentNPC);
}
function removeArmour(idx){currentNPC.armour.splice(idx,1);recalcArmour();recalcGearCost(currentNPC);saveCharacter(currentNPC);renderArmourPanel(currentNPC);renderStatColumn(currentNPC);}
function addArmourToGear(){addArmour();}
function recalcArmour(){currentNPC.toughnessArmor=currentNPC.armour.reduce((best,a)=>Math.max(best,a.armor||0),0);calcDerived(currentNPC);}
function recalcGearCost(n){
  if(!n) n=currentNPC;if(!n) return;
  let total=0;
  // Weapons with stored cost
  (n.weapons||[]).forEach(w=>{total+=(w.cost||0);});
  // Armour with stored cost
  (n.armour||[]).forEach(a=>{total+=(a.cost||0);});
  // Gear items â€” look up cost from catalogue (only if catalogue loaded)
  const catG=getCatalogueGear();
  if(n.gearText&&catG.length>0){
    n.gearText.split(',').map(g=>g.trim()).filter(g=>g).forEach(item=>{
      const norm=item.toLowerCase().replace(/\s*\([^)]*\)/g,'').trim();
      const match=catG.find(g=>g.name.toLowerCase()===norm||norm.includes(g.name.toLowerCase()));
      if(match&&match.cost) total+=match.cost;
    });
  }
  // Only update if we actually computed something, or if total > 0
  // (avoids zeroing out on first load before catalogues are ready)
  if(total>0||catG.length>0) n.gearCost=total;
  return total;
}
function renderBudgetBar(n){
  if(!n) return '';
  const spent=n.gearCost||0;
  const budget=n.startingFunds||500;
  const remaining=budget-spent;
  const pct=budget>0?Math.min(100,Math.round((spent/budget)*100)):0;
  const cls=remaining>=0?'budget-ok':'budget-over';
  const barColor=remaining>=0?'var(--green)':'var(--red)';
  return `<div class="budget-bar"><span class="budget-label">Budget</span><span class="budget-spent">${spent}â‚¡ spent</span><span class="${cls}">${remaining>=0?remaining+'â‚¡ remaining':'Over by '+Math.abs(remaining)+'â‚¡'}</span><span class="budget-label">${budget}â‚¡ total</span></div><div class="budget-meter"><div class="budget-meter-fill" style="width:${pct}%;background:${barColor}"></div></div>`;
}

/* â•â•â• GEAR PANEL â€” full catalogue with info, keyboard nav, colour coding â•â•â• */
var gearCatIdx=-1, gearCatFiltered=[];
function renderGearPanel(n){
  const items=n.gearText?n.gearText.split(',').map(g=>g.trim()).filter(g=>g):[];
  const catG=getCatalogueGear();
  const rows=items.map((g,i)=>{
    const norm=g.toLowerCase().replace(/\s*\([^)]*\)/g,'').trim();
    const match=catG.find(c=>c.name.toLowerCase()===norm||norm.includes(c.name.toLowerCase()));
    const costTag=match&&match.cost?` <span style="color:var(--accent);font-size:11px">${match.cost}â‚¡</span>`:'';
    return `<div class="item-entry" style="display:flex;justify-content:space-between;padding:4px 0;cursor:pointer" onclick="showExistingGearInfo('${esc(g).replace(/'/g,"\\'")}')"><span>${esc(g)}${costTag}</span> <button class="btn sm danger" onclick="event.stopPropagation();removeGearItem(${i})">Ã—</button></div>`;
  }).join('');
  document.getElementById('panelContent').innerHTML=`${renderBudgetBar(n)}<div>${rows||'<div style="color:var(--text-dim)">No gear yet</div>'}</div>
    <div class="catalogue-section"><h4>Add Item</h4>
    <input placeholder="Search gear... (â†‘â†“ to browse)" id="gearSearch" oninput="filterGearCatalogue(this.value)" onkeydown="gearCatKeyNav(event)" style="width:100%;margin-bottom:4px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px">
    <div style="display:flex;gap:8px;align-items:flex-start">
      <div class="catalogue-list" id="gearCatList" style="flex:1;min-width:0"></div>
      <div id="gearInfo" style="flex:1;min-width:0"></div>
    </div>
    <div style="margin:10px 0 4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Or Enter Custom</div>
    <div class="form-group"><label>Item</label><input id="gear_name"></div>
    <button class="btn primary" onclick="addGearItem()">Add Item</button></div>`;
  filterGearCatalogue('');
}
function filterGearCatalogue(s){
  gearCatIdx=-1;
  s=(s||'').toLowerCase();
  const ownedText=currentNPC&&currentNPC.gearText?currentNPC.gearText.toLowerCase():'';
  gearCatFiltered=getCatalogueGear().filter(g=>!s||g.name.toLowerCase().includes(s));
  const el=document.getElementById('gearCatList');if(!el)return;
  el.innerHTML=gearCatFiltered.map((g,i)=>{
    const has=ownedText.includes(g.name.toLowerCase());
    const detail=g.notes?` â€” ${esc(g.notes)}`:'';
    return `<div class="catalogue-item" data-idx="${i}" onclick="selectGearInfo(${i})" style="color:${has?'var(--text-dim)':'var(--green)'}"><span class="cat-name">${esc(g.name)}</span> <span class="cat-detail">${g.cost?g.cost+'â‚¡':''}${detail} â€” ${esc(g.source)}</span></div>`;
  }).join('');
  window._gearCatList=gearCatFiltered;
}
function selectGearInfo(idx){
  const g=gearCatFiltered[idx];if(!g)return;
  gearCatIdx=idx;
  document.getElementById('gear_name').value=g.name;
  const info=document.getElementById('gearInfo');if(!info)return;
  const ownedText=currentNPC&&currentNPC.gearText?currentNPC.gearText.toLowerCase():'';
  const has=ownedText.includes(g.name.toLowerCase());
  const ownStyle=has?'color:var(--text-dim)':'color:var(--green)';
  const ownText=has?'Already carried':'Available';
  let details=`<div class="ci-meta">${esc(g.source)}</div>`;
  if(g.cost||g.wt) details+=`<div class="ci-meta">${g.cost?g.cost+'â‚¡':''}${g.cost&&g.wt?' Â· ':''}${g.wt?g.wt+' lbs':''}</div>`;
  if(g.notes) details+=`<div class="ci-desc">${esc(g.notes)}</div>`;
  info.innerHTML=`<div class="cat-info" style="cursor:pointer" onclick="scrollToGearCatItem(${idx})"><div class="ci-name">${esc(g.name)} <span style="font-size:11px;${ownStyle}">${ownText}</span></div>${details}</div>`;
  const items=document.getElementById('gearCatList')?.querySelectorAll('.catalogue-item');
  if(items)items.forEach((it,i)=>{it.style.background=i===idx?'var(--accent)22':'';});
  setTimeout(()=>document.getElementById('gearSearch')?.focus(),0);
}
function gearCatKeyNav(e){
  const list=document.getElementById('gearCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');if(!items.length)return;
  if(e.key==='ArrowDown'){e.preventDefault();gearCatIdx=Math.min(gearCatIdx+1,items.length-1);highlightGearCat(items);}
  else if(e.key==='ArrowUp'){e.preventDefault();gearCatIdx=Math.max(gearCatIdx-1,0);highlightGearCat(items);}
  else if(e.key==='Enter'&&gearCatIdx>=0){e.preventDefault();items[gearCatIdx].click();}
}
function highlightGearCat(items){
  items.forEach((it,i)=>{it.style.background=i===gearCatIdx?'var(--accent)22':'';});
  if(items[gearCatIdx]){items[gearCatIdx].scrollIntoView({block:'nearest'});selectGearInfo(gearCatIdx);}
}
function scrollToGearCatItem(idx){
  const list=document.getElementById('gearCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');
  if(items[idx]){items[idx].scrollIntoView({block:'nearest',behavior:'smooth'});}
}
function showExistingGearInfo(name){
  const search=document.getElementById('gearSearch');if(search)search.value='';
  filterGearCatalogue('');
  const baseName=name.replace(/\s*\(.*\)/,'').trim();
  const idx=gearCatFiltered.findIndex(g=>g.name.toLowerCase()===name.toLowerCase()||g.name.toLowerCase()===baseName.toLowerCase());
  if(idx>=0){selectGearInfo(idx);scrollToGearCatItem(idx);}
  else{const info=document.getElementById('gearInfo');if(info)info.innerHTML=`<div class="cat-info"><div class="ci-name">${esc(name)}</div><div class="ci-desc" style="color:var(--text-dim)">Custom item â€” not in catalogue</div></div>`;}
}
function addGearItem(){const item=document.getElementById('gear_name').value.trim();if(!item)return;currentNPC.gearText=currentNPC.gearText?currentNPC.gearText+', '+item:item;recalcGearCost(currentNPC);saveCharacter(currentNPC);renderGearPanel(currentNPC);renderStatColumn(currentNPC);}
function removeGearItem(idx){const items=currentNPC.gearText.split(',').map(g=>g.trim()).filter(g=>g);items.splice(idx,1);currentNPC.gearText=items.join(', ');recalcGearCost(currentNPC);saveCharacter(currentNPC);renderGearPanel(currentNPC);renderStatColumn(currentNPC);}

function renderPowersPanel(n){
  const rows=n.powers.map((p,i)=>`<div class="item-entry" style="display:flex;justify-content:space-between;padding:4px 0">${esc(p)} <button class="btn sm danger" onclick="removePower(${i})">Ã—</button></div>`).join('');
  document.getElementById('panelContent').innerHTML=`<div class="form-row" style="margin-bottom:10px"><div class="form-group"><label>Arcane Background</label><input id="pow_ab" value="${esc(n.abName)}"></div><div class="form-group" style="max-width:100px"><label>Power Points</label><input id="pow_pp" type="number" value="${n.pp}"></div></div>
    <div>${rows||'<div style="color:var(--text-dim)">No powers yet</div>'}</div>
    <div class="catalogue-section"><h4>Add Power</h4>
    <div style="margin-bottom:4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Pick from Catalogue</div>
    <input placeholder="Search powers... (â†‘â†“ to browse)" oninput="filterPowerCatalogue(this.value)" onkeydown="powCatKeyNav(event)" id="powSearch" style="width:100%;margin-bottom:4px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px">
    <div style="display:flex;gap:8px;align-items:flex-start">
      <div class="catalogue-list" id="powCatList" style="flex:1;min-width:0"></div>
      <div id="powInfo" style="flex:1;min-width:0"></div>
    </div>
    <div style="margin:10px 0 4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Or Enter Custom</div>
    <div class="form-group"><label>Power Name</label><input id="pow_name"></div>
    <button class="btn primary" onclick="addPower()">Add Power</button></div>
    <div class="form-actions"><button class="btn" onclick="savePowerSettings()">Save AB Settings</button></div>`;
  filterPowerCatalogue('');
}
var powCatIdx=-1;
var powCatFiltered=[];
function meetsPowerRank(pow,n){
  if(!n)return false;
  const rankOrder={N:0,Novice:0,S:1,Seasoned:1,V:2,Veteran:2,H:3,Heroic:3,L:4,Legendary:4};
  return (rankOrder[n.rank]||0)>=(rankOrder[pow.rank]||0);
}
function filterPowerCatalogue(s){
  powCatIdx=-1;
  s=s.toLowerCase();
  const existing=currentNPC?currentNPC.powers.map(p=>p.toLowerCase()):[];
  powCatFiltered=getCataloguePowers().filter(p=>(!s||p.name.toLowerCase().includes(s))&&!existing.includes(p.name.toLowerCase()));
  const el=document.getElementById('powCatList');if(!el)return;
  el.innerHTML=powCatFiltered.map((p,i)=>{const ok=meetsPowerRank(p,currentNPC);return `<div class="catalogue-item" onclick="selectPowInfo(${i})" style="color:${ok?'var(--green)':'var(--text-dim)'}"><span class="cat-name">${esc(p.name)}</span> <span class="cat-detail">${esc(p.rank)} ${esc(p.pp)}PP ${p.range?p.range:''} â€” ${esc(p.source)}</span></div>`;}).join('');
}
function powCatKeyNav(e){
  const list=document.getElementById('powCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');if(!items.length)return;
  if(e.key==='ArrowDown'){e.preventDefault();powCatIdx=Math.min(powCatIdx+1,items.length-1);highlightPowCat(items);}
  else if(e.key==='ArrowUp'){e.preventDefault();powCatIdx=Math.max(powCatIdx-1,0);highlightPowCat(items);}
  else if(e.key==='Enter'&&powCatIdx>=0){e.preventDefault();selectPowInfo(powCatIdx);}
}
function highlightPowCat(items){
  items.forEach((it,i)=>{it.style.background=i===powCatIdx?'var(--accent)22':'';});
  if(items[powCatIdx]){items[powCatIdx].scrollIntoView({block:'nearest'});selectPowInfo(powCatIdx);}
}
function selectPowInfo(idx){
  const p=powCatFiltered[idx];if(!p)return;
  powCatIdx=idx;
  document.getElementById('pow_name').value=p.name;
  const info=document.getElementById('powInfo');if(!info)return;
  const ok=meetsPowerRank(p,currentNPC);
  const eligStyle=ok?'color:var(--green)':'color:var(--red)';
  const eligText=ok?'âœ“ Eligible':'âœ— Rank too low';
  info.innerHTML=`<div class="cat-info" style="cursor:pointer" onclick="scrollToPowCatItem(${idx})"><div class="ci-name">${esc(p.name)} <span style="font-size:11px;${eligStyle}">${eligText}</span></div><div class="ci-meta">${esc(p.rank)} Â· ${esc(p.pp)} PP Â· Range: ${esc(p.range||'Self')} Â· Duration: ${esc(p.dur||'Instant')} Â· ${esc(p.source)}</div><div class="ci-desc">${esc(p.summary||'No description available.')}</div></div>`;
  const items=document.getElementById('powCatList')?.querySelectorAll('.catalogue-item');
  if(items)items.forEach((it,i)=>{it.style.background=i===idx?'var(--accent)22':'';});
  setTimeout(()=>document.getElementById('powSearch')?.focus(),0);
}
function scrollToPowCatItem(idx){
  const list=document.getElementById('powCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');
  if(items[idx])items[idx].scrollIntoView({block:'nearest',behavior:'smooth'});
}
function addPower(){const name=document.getElementById('pow_name').value.trim();if(!name)return;currentNPC.powers.push(name);saveCharacter(currentNPC);renderPowersPanel(currentNPC);renderStatColumn(currentNPC);}
function removePower(idx){currentNPC.powers.splice(idx,1);saveCharacter(currentNPC);renderPowersPanel(currentNPC);renderStatColumn(currentNPC);}
function savePowerSettings(){currentNPC.abName=document.getElementById('pow_ab').value.trim();currentNPC.pp=parseInt(document.getElementById('pow_pp').value)||0;saveCharacter(currentNPC);renderStatColumn(currentNPC);}

function renderNarrativePanel(n){
  // Build connections editor rows
  const connRows=(n.connections||[]).map((c,i)=>`<div class="form-row" style="align-items:end;gap:4px"><div class="form-group" style="flex:1"><input id="conn_ref_${i}" value="${esc(c.refCode)}" placeholder="AM-C019" style="font-family:monospace;font-size:12px"></div><div class="form-group" style="flex:2"><input id="conn_name_${i}" value="${esc(c.name)}" placeholder="Name"></div><div class="form-group" style="flex:1.5"><input id="conn_rel_${i}" value="${esc(c.relationship)}" placeholder="Relationship"></div><div class="form-group" style="flex:2"><input id="conn_note_${i}" value="${esc(c.notes||'')}" placeholder="Notes"></div><button class="btn sm" onclick="removeNarRow('conn',${i})" style="margin-bottom:8px;color:var(--red)">âœ•</button></div>`).join('');
  // Build appearances editor rows
  const appearRows=(n.appearances||[]).map((a,i)=>`<div class="form-row" style="align-items:end;gap:4px"><div class="form-group" style="flex:1"><input id="app_prod_${i}" value="${esc(a.product)}" placeholder="AM-W01" style="font-family:monospace;font-size:12px"></div><div class="form-group" style="flex:2"><input id="app_title_${i}" value="${esc(a.title||'')}" placeholder="Product Title"></div><div class="form-group" style="flex:1"><input id="app_role_${i}" value="${esc(a.role||'')}" placeholder="Role"></div><button class="btn sm" onclick="removeNarRow('app',${i})" style="margin-bottom:8px;color:var(--red)">âœ•</button></div>`).join('');
  // Build foreshadowing editor rows
  const fsRows=(n.foreshadowing||[]).map((f,i)=>`<div class="form-row" style="align-items:end;gap:4px"><div class="form-group" style="flex:1"><input id="fs_planted_${i}" value="${esc(f.planted)}" placeholder="AM-W01" style="font-family:monospace;font-size:12px"></div><div class="form-group" style="flex:3"><input id="fs_seed_${i}" value="${esc(f.seed)}" placeholder="Seed planted"></div><div class="form-group" style="flex:1"><input id="fs_pays_${i}" value="${esc(f.paysOff)}" placeholder="AM-W05" style="font-family:monospace;font-size:12px"></div><button class="btn sm" onclick="removeNarRow('fs',${i})" style="margin-bottom:8px;color:var(--red)">âœ•</button></div>`).join('');

  document.getElementById('panelContent').innerHTML=`
    <div class="form-group"><label>Description</label><textarea id="nar_desc" rows="3">${esc(n.description)}</textarea></div>
    <div class="form-group"><label>Personality</label><textarea id="nar_pers" rows="2">${esc(n.personality||'')}</textarea></div>
    <div class="form-row"><div class="form-group" style="flex:3"><label>Physical Description</label><input id="nar_phys" value="${esc(n.physicalDescription||'')}"></div><div class="form-group" style="flex:1"><label>Age</label><input id="nar_age" type="number" value="${n.age||''}"></div></div>
    <div class="form-group"><label>Background</label><textarea id="nar_bg" rows="3">${esc(n.background)}</textarea></div>
    <div class="form-group"><label>What They Want</label><textarea id="nar_mot" rows="2">${esc(n.motivation)}</textarea></div>
    <div class="form-group"><label>Their Secret</label><textarea id="nar_sec" rows="2">${esc(n.secret)}</textarea></div>
    <div class="form-group"><label>Services</label><input id="nar_svc" value="${esc(n.services)}"></div>
    <div class="form-group"><label>Adventure Hook</label><textarea id="nar_hook" rows="2">${esc(n.adventureHook)}</textarea></div>
    <div class="form-group"><label>Tactics</label><textarea id="nar_tac" rows="2">${esc(n.tactics)}</textarea></div>
    <div class="form-group"><label>Advancement Path</label><textarea id="nar_adv" rows="2">${esc(n.advancement||'')}</textarea></div>
    <div class="form-group"><label>Connections</label><div id="connRows">${connRows}</div><button class="btn sm" onclick="addNarRow('conn')" style="margin-top:4px">+ Connection</button></div>
    <div class="form-group"><label>Appearances</label><div id="appRows">${appearRows}</div><button class="btn sm" onclick="addNarRow('app')" style="margin-top:4px">+ Appearance</button></div>
    <div class="form-group"><label>Foreshadowing</label><div id="fsRows">${fsRows}</div><button class="btn sm" onclick="addNarRow('fs')" style="margin-top:4px">+ Foreshadowing</button></div>
    <div class="form-actions"><button class="btn" onclick="closePanel()">Cancel</button><button class="btn primary" onclick="saveNarrative()">Save Narrative</button></div>`;
}
function saveNarrative(){
  const n=currentNPC;
  n.description=document.getElementById('nar_desc').value.trim();
  n.personality=(document.getElementById('nar_pers')||{}).value?.trim()||'';
  n.physicalDescription=(document.getElementById('nar_phys')||{}).value?.trim()||'';
  const ageVal=parseInt((document.getElementById('nar_age')||{}).value);
  n.age=isNaN(ageVal)?null:ageVal;
  n.background=document.getElementById('nar_bg').value.trim();
  n.motivation=document.getElementById('nar_mot').value.trim();
  n.secret=document.getElementById('nar_sec').value.trim();
  n.services=document.getElementById('nar_svc').value.trim();
  n.adventureHook=document.getElementById('nar_hook').value.trim();
  n.tactics=document.getElementById('nar_tac').value.trim();
  n.advancement=(document.getElementById('nar_adv')||{}).value?.trim()||'';
  // Collect connections
  n.connections=[];
  let ci=0;
  while(document.getElementById('conn_ref_'+ci)){
    const ref=document.getElementById('conn_ref_'+ci).value.trim();
    const name=document.getElementById('conn_name_'+ci).value.trim();
    if(ref||name) n.connections.push({refCode:ref,name:name,relationship:document.getElementById('conn_rel_'+ci).value.trim(),notes:document.getElementById('conn_note_'+ci).value.trim()});
    ci++;
  }
  // Collect appearances
  n.appearances=[];
  let ai=0;
  while(document.getElementById('app_prod_'+ai)){
    const prod=document.getElementById('app_prod_'+ai).value.trim();
    if(prod) n.appearances.push({product:prod,title:document.getElementById('app_title_'+ai).value.trim(),role:document.getElementById('app_role_'+ai).value.trim()});
    ai++;
  }
  // Collect foreshadowing
  n.foreshadowing=[];
  let fi=0;
  while(document.getElementById('fs_planted_'+fi)){
    const planted=document.getElementById('fs_planted_'+fi).value.trim();
    const seed=document.getElementById('fs_seed_'+fi).value.trim();
    if(planted||seed) n.foreshadowing.push({planted:planted,seed:seed,paysOff:document.getElementById('fs_pays_'+fi).value.trim()});
    fi++;
  }
  syncReciprocalConnections(n);
  saveCharacter(n);closePanel();
}
function syncReciprocalConnections(source){
  // For each connection on this character, ensure the target has a link back
  (source.connections||[]).forEach(conn=>{
    if(!conn.refCode) return;
    const target=allNPCs.find(c=>c.refCode===conn.refCode);
    if(!target) return;
    if(!target.connections) target.connections=[];
    // Check if target already links back to source
    const hasReverse=target.connections.some(c=>c.refCode===source.refCode);
    if(!hasReverse){
      const reverseRel=invertRelationship(conn.relationship);
      target.connections.push({refCode:source.refCode,name:source.name,relationship:reverseRel,notes:conn.notes||''});
      saveCharacter(target);
      console.log(`ğŸ”— Auto-linked ${target.name} â†’ ${source.name} (${reverseRel})`);
    }
  });
}
function invertRelationship(rel){
  if(!rel) return '';
  const map={'Brother of':'Brother of','Sister of':'Sister of','Parent of':'Child of','Child of':'Parent of',
    'Employer of':'Employed by','Employed by':'Employer of','Mentor of':'Student of','Student of':'Mentor of',
    'Held by':'Holds','Holds':'Held by','Reports to':'Supervises','Supervises':'Reports to',
    'Ally of':'Ally of','Rival of':'Rival of','Friend of':'Friend of','Enemy of':'Enemy of',
    'Former colleague':'Former colleague','Married to':'Married to','Partner of':'Partner of'};
  return map[rel]||rel;
}
function uploadPortrait(){document.getElementById('portraitInput').click();}
function handlePortraitUpload(input){
  const file=input.files[0];if(!file) return;
  const reader=new FileReader();
  reader.onload=function(e){
    const img=new Image();
    img.onload=function(){
      // Resize to 300px wide, maintain 3:4 aspect ratio
      const canvas=document.createElement('canvas');
      const targetW=300,targetH=400;
      canvas.width=targetW;canvas.height=targetH;
      const ctx=canvas.getContext('2d');
      // Cover-crop: fill the canvas, cropping excess
      const srcRatio=img.width/img.height;
      const tgtRatio=targetW/targetH;
      let sx=0,sy=0,sw=img.width,sh=img.height;
      if(srcRatio>tgtRatio){sw=img.height*tgtRatio;sx=(img.width-sw)/2;}
      else{sh=img.width/tgtRatio;sy=(img.height-sh)/2;}
      ctx.drawImage(img,sx,sy,sw,sh,0,0,targetW,targetH);
      const dataUrl=canvas.toDataURL('image/jpeg',0.8);
      currentNPC.portrait=dataUrl;
      saveCharacter(currentNPC);
      renderNarrativeColumn(currentNPC);
      console.log('ğŸ“· Portrait saved:',Math.round(dataUrl.length/1024)+'KB');
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}
function removePortrait(){
  if(!confirm('Remove portrait for '+currentNPC.name+'?')) return;
  currentNPC.portrait='';
  saveCharacter(currentNPC);
  renderNarrativeColumn(currentNPC);
}

/* â•â•â• AI PORTRAIT GENERATION â€” DALL-E 3 via OpenAI API â•â•â• */
const PORTRAIT_STYLE='Grimdark fantasy portrait, oil painting style, dark atmospheric lighting, Warhammer Fantasy Old World aesthetic. Moody and weathered. Head and shoulders composition, looking at viewer, highly detailed face. No text, no watermark, no signature, no border, no frame.';

const ANCESTRY_DESC={
  'Human':'a human','Dwarf':'a dwarf with thick beard and weathered features',
  'Elf':'an elf with sharp angular features and pointed ears','Half-Elf':'a half-elf with subtle pointed ears',
  'Orc':'an orc with greenish skin and tusks','Half-Orc':'a half-orc with orcish features',
  'Halfling':'a halfling with youthful rounded features','Gnome':'a gnome with exaggerated features',
  'Saurian':'a reptilian saurian with scaled skin and slitted eyes','Rakashani':'a feline rakashani with cat-like features and fur'
};
const REGION_FLAVOUR={
  'Ammaria':'from a wealthy merchant city-state; fine but practical clothing, guild insignia, trade-worn hands',
  'Saltlands':'from a harsh corsair confederation; weathered by salt and sun, nautical clothing, scarred',
  'Vinlands':'from the northern resistance lands; furs and practical armour, Germanic warrior aesthetic, defiant',
  'Concordium':'from a sky city; elaborate robes, artificer goggles, crystal-touched aesthetic',
  'Glasrya':'from the demon-blooded empire; decadent cruel beauty, pale skin, MelnibonÃ©an aesthetic, otherworldly'
};

function buildPortraitPrompt(n){
  const parts=[PORTRAIT_STYLE];
  const anc=ANCESTRY_DESC[n.ancestry]||'a human';
  const concept=n.concept?', '+n.concept.toLowerCase():'';
  parts.push('Portrait of '+anc+concept+'.');
  if(n.region&&REGION_FLAVOUR[n.region]) parts.push(REGION_FLAVOUR[n.region]+'.');
  if(n.physicalDescription) parts.push('Appearance: '+n.physicalDescription.slice(0,200));
  else if(n.description&&n.description.length<200) parts.push('Character: '+n.description.slice(0,200));
  if(n.age) parts.push('Apparent age: approximately '+n.age+' years old.');
  if(n.tier==='Wild Card') parts.push('Commanding presence, memorable face, protagonist energy.');
  if(n.tier==='Extra') parts.push('Common, unremarkable, could be anyone in a crowd.');
  return parts.join(' ');
}

function getOpenAIKey(){
  let key=localStorage.getItem('openai_api_key');
  if(key) return key;
  key=prompt('Enter your OpenAI API key (starts with sk-).\nGet one free at platform.openai.com/api-keys\n\nThis is stored locally in your browser only.');
  if(key&&key.startsWith('sk-')){localStorage.setItem('openai_api_key',key);return key;}
  return null;
}
function clearOpenAIKey(){localStorage.removeItem('openai_api_key');console.log('ğŸ”‘ OpenAI key cleared');}
function manageOpenAIKey(){
  const current=localStorage.getItem('openai_api_key');
  if(current){
    const action=confirm('OpenAI API key is set ('+current.slice(0,8)+'â€¦).\n\nOK = Clear key\nCancel = Keep it');
    if(action){localStorage.removeItem('openai_api_key');alert('API key cleared.');}
  } else {
    const key=prompt('Enter your OpenAI API key (starts with sk-).\nGet one at platform.openai.com/api-keys\n\nStored locally in your browser only â€” never sent to GitHub.');
    if(key&&key.startsWith('sk-')){localStorage.setItem('openai_api_key',key);alert('API key saved. âœ¦ Generate buttons are now active.');}
    else if(key) alert('Key should start with sk-. Try again.');
  }
}

async function generatePortrait(){
  const n=currentNPC;if(!n) return;
  const key=getOpenAIKey();
  if(!key){setPortraitStatus('No API key provided.','var(--red)');return;}
  const prompt=buildPortraitPrompt(n);
  console.log('ğŸ¨ Portrait prompt:',prompt);
  setPortraitStatus('Generating portraitâ€¦ (10-20 seconds)','var(--accent)');
  // Show spinner in portrait box
  const box=document.querySelector('.portrait-box');
  if(box&&!n.portrait) box.innerHTML='<div style="font-size:24px;animation:spin 1s linear infinite">âŸ³</div>';
  try{
    const resp=await fetch('https://api.openai.com/v1/images/generations',{
      method:'POST',
      headers:{'Authorization':'Bearer '+key,'Content-Type':'application/json'},
      body:JSON.stringify({model:'dall-e-3',prompt:prompt,n:1,size:'1024x1024',quality:'standard',response_format:'b64_json'})
    });
    if(!resp.ok){
      const err=await resp.json().catch(()=>({error:{message:'HTTP '+resp.status}}));
      const msg=err.error?.message||'API error '+resp.status;
      if(resp.status===401){localStorage.removeItem('openai_api_key');setPortraitStatus('Invalid API key â€” cleared. Try again.','var(--red)');}
      else setPortraitStatus('Error: '+msg,'var(--red)');
      renderNarrativeColumn(n);return;
    }
    const data=await resp.json();
    const b64=data.data[0].b64_json;
    // Convert to image, resize to thumbnail, save
    const img=new Image();
    img.onload=function(){
      const canvas=document.createElement('canvas');
      const tw=300,th=400;
      canvas.width=tw;canvas.height=th;
      const ctx=canvas.getContext('2d');
      const srcR=img.width/img.height,tgtR=tw/th;
      let sx=0,sy=0,sw=img.width,sh=img.height;
      if(srcR>tgtR){sw=img.height*tgtR;sx=(img.width-sw)/2;}
      else{sh=img.width/tgtR;sy=(img.height-sh)/2;}
      ctx.drawImage(img,sx,sy,sw,sh,0,0,tw,th);
      const dataUrl=canvas.toDataURL('image/jpeg',0.85);
      n.portrait=dataUrl;
      saveCharacter(n);
      renderNarrativeColumn(n);
      setPortraitStatus('Portrait generated âœ“','var(--green)');
      console.log('ğŸ“· AI portrait saved:',Math.round(dataUrl.length/1024)+'KB');
    };
    img.src='data:image/png;base64,'+b64;
  }catch(e){
    setPortraitStatus('Network error: '+e.message,'var(--red)');
    renderNarrativeColumn(n);
  }
}
function setPortraitStatus(msg,color){
  const el=document.getElementById('portraitStatus');
  if(el){el.textContent=msg;el.style.color=color||'var(--text-dim)';}
}
async function generatePortraitCustom(){
  const n=currentNPC;if(!n) return;
  const autoPrompt=buildPortraitPrompt(n);
  const edited=prompt('Edit portrait prompt (or paste your own):\n\n',autoPrompt);
  if(!edited) return;
  const key=getOpenAIKey();
  if(!key){setPortraitStatus('No API key provided.','var(--red)');return;}
  setPortraitStatus('Generating from custom promptâ€¦','var(--accent)');
  const box=document.querySelector('.portrait-box');
  if(box&&!n.portrait) box.innerHTML='<div style="font-size:24px;animation:spin 1s linear infinite">âŸ³</div>';
  try{
    const resp=await fetch('https://api.openai.com/v1/images/generations',{
      method:'POST',
      headers:{'Authorization':'Bearer '+key,'Content-Type':'application/json'},
      body:JSON.stringify({model:'dall-e-3',prompt:edited,n:1,size:'1024x1024',quality:'standard',response_format:'b64_json'})
    });
    if(!resp.ok){
      const err=await resp.json().catch(()=>({error:{message:'HTTP '+resp.status}}));
      if(resp.status===401){localStorage.removeItem('openai_api_key');setPortraitStatus('Invalid API key â€” cleared.','var(--red)');}
      else setPortraitStatus('Error: '+(err.error?.message||resp.status),'var(--red)');
      renderNarrativeColumn(n);return;
    }
    const data=await resp.json();
    const b64=data.data[0].b64_json;
    const img=new Image();
    img.onload=function(){
      const canvas=document.createElement('canvas');
      canvas.width=300;canvas.height=400;
      const ctx=canvas.getContext('2d');
      const srcR=img.width/img.height,tgtR=300/400;
      let sx=0,sy=0,sw=img.width,sh=img.height;
      if(srcR>tgtR){sw=img.height*tgtR;sx=(img.width-sw)/2;}
      else{sh=img.width/tgtR;sy=(img.height-sh)/2;}
      ctx.drawImage(img,sx,sy,sw,sh,0,0,300,400);
      n.portrait=canvas.toDataURL('image/jpeg',0.85);
      saveCharacter(n);renderNarrativeColumn(n);
      setPortraitStatus('Portrait generated from custom prompt âœ“','var(--green)');
    };
    img.src='data:image/png;base64,'+b64;
  }catch(e){setPortraitStatus('Network error: '+e.message,'var(--red)');renderNarrativeColumn(n);}
}
function addNarRow(type){
  const n=currentNPC;
  if(type==='conn')(n.connections=n.connections||[]).push({refCode:'',name:'',relationship:'',notes:''});
  else if(type==='app')(n.appearances=n.appearances||[]).push({product:'',title:'',role:''});
  else if(type==='fs')(n.foreshadowing=n.foreshadowing||[]).push({planted:'',seed:'',paysOff:''});
  renderNarrativePanel(n);
}
function removeNarRow(type,idx){
  const n=currentNPC;
  if(type==='conn')n.connections.splice(idx,1);
  else if(type==='app')n.appearances.splice(idx,1);
  else if(type==='fs')n.foreshadowing.splice(idx,1);
  renderNarrativePanel(n);
}

function renderStatBlockPanel(n){
  const skillStr=Object.entries(n.skills).map(([k,v])=>`${k} ${d(v)}`).join(', ');
  const toughDisp=n.toughnessArmor>0?`${n.toughness} (${n.toughnessArmor})`:`${n.toughness}`;
  let fmt=`<strong>${esc(n.name)}</strong>\n`;
  if(n.quote)fmt+=`<em>"${esc(n.quote)}"</em>\n\n`;
  if(n.description)fmt+=`${esc(n.description)}\n\n`;
  fmt+=`<span class="label">Attributes:</span> Agility ${d(n.agility)}, Smarts ${d(n.smarts)}, Spirit ${d(n.spirit)}, Strength ${d(n.strength)}, Vigor ${d(n.vigor)}\n`;
  fmt+=`<span class="label">Skills:</span> ${skillStr}\n`;
  fmt+=`<span class="label">Pace:</span> ${n.pace}; <span class="label">Parry:</span> ${n.parry}; <span class="label">Toughness:</span> ${toughDisp}\n`;
  if(n.edges.length)fmt+=`<span class="label">Edges:</span> ${n.edges.join(', ')}\n`;
  if(n.hindrances.length)fmt+=`<span class="label">Hindrances:</span> ${n.hindrances.join(', ')}\n`;
  if(n.gearText)fmt+=`<span class="label">Gear:</span> ${esc(n.gearText)}\n`;
  if(n.pp>0)fmt+=`<span class="label">Powers (${n.pp} PP):</span> ${n.powers.join(', ')}\n`;
  if(n.tactics)fmt+=`<span class="label">Tactics:</span> ${esc(n.tactics)}\n`;
  let md=`**${n.name}**\n`;
  if(n.quote)md+=`*"${n.quote}"*\n\n`;
  if(n.description)md+=`${n.description}\n\n`;
  md+=`**Attributes:** Agility ${d(n.agility)}, Smarts ${d(n.smarts)}, Spirit ${d(n.spirit)}, Strength ${d(n.strength)}, Vigor ${d(n.vigor)}\n`;
  md+=`**Skills:** ${skillStr}\n**Pace:** ${n.pace}; **Parry:** ${n.parry}; **Toughness:** ${toughDisp}\n`;
  if(n.edges.length)md+=`**Edges:** ${n.edges.join(', ')}\n`;
  if(n.hindrances.length)md+=`**Hindrances:** ${n.hindrances.join(', ')}\n`;
  if(n.gearText)md+=`**Gear:** ${n.gearText}\n`;
  if(n.pp>0)md+=`**Powers (${n.pp} PP):** ${n.powers.join(', ')}\n`;
  if(n.tactics)md+=`**Tactics:** ${n.tactics}\n`;
  document.getElementById('panelContent').innerHTML=`<div class="export-tabs"><div class="export-tab active" onclick="switchExportTab(this,'fmt')">Formatted</div><div class="export-tab" onclick="switchExportTab(this,'md')">Markdown</div></div><div class="export-content" id="exportFmt">${fmt}</div><div class="export-content" id="exportMd" style="display:none">${esc(md)}</div><div class="form-actions" style="margin-top:8px"><button class="btn" onclick="copyExport('html')">Copy HTML</button><button class="btn" onclick="copyExport('md')">Copy Markdown</button></div>`;
}
function switchExportTab(el,tab){document.querySelectorAll('.export-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');document.getElementById('exportFmt').style.display=tab==='fmt'?'block':'none';document.getElementById('exportMd').style.display=tab==='md'?'block':'none';}
function copyExport(type){const el=type==='html'?document.getElementById('exportFmt'):document.getElementById('exportMd');navigator.clipboard.writeText(el.innerText).then(()=>alert('Copied to clipboard'));}

function runBuildAudit(n){
  var CF=window.CharacterForge;
  var ancestryData=(CF.data.ancestries&&CF.data.ancestries[n.ancestry])||{attrBonus:1,freeEdges:1,pace:6,size:0,toughMod:0};
  var skillLinks=CF.data.skillLinks||{};
  var coreSkills=CF.data.coreSkills||['Athletics','Common Knowledge','Notice','Persuasion','Stealth'];
  var results=window.SWADERules.runBuildAudit({
    attrs:{agility:n.agility,smarts:n.smarts,spirit:n.spirit,strength:n.strength,vigor:n.vigor},
    skills:n.skills, edges:n.edges, hindrances:n.hindrances,
    tier:n.tier, ancestryData:ancestryData, ancestry:n.ancestry||'',
    skillLinks:skillLinks, coreSkills:coreSkills,
    pace:n.pace, parry:n.parry, toughness:n.toughness, toughnessArmor:n.toughnessArmor||0
  });
  // â”€â”€ Core Skills Check â”€â”€
  var missingCore=coreSkills.filter(function(sk){return !n.skills[sk];});
  if(missingCore.length){
    results.push({section:'Core Skills',label:'Missing: '+missingCore.join(', '),pass:true,warn:true,detail:'All characters should have core skills at d4'});
  }
  // â”€â”€ Arcane Background Prerequisite Check â”€â”€
  var edges=n.edges||[];
  var hasWizard=edges.some(function(e){return e.toLowerCase()==='wizard';});
  var hasABMagic=edges.some(function(e){return e.toLowerCase().includes('arcane background')&&e.toLowerCase().includes('magic');});
  var hasABBare=edges.some(function(e){var l=e.toLowerCase().trim();return l==='arcane background';});
  if(hasWizard&&!hasABMagic){
    results.push({section:'Edge Prerequisites',label:'Wizard requires Arcane Background (Magic)',pass:true,warn:true,detail:'Arcane Background should specify tradition'});
  }
  if(hasABBare){
    results.push({section:'Edge Prerequisites',label:'Arcane Background missing tradition (Magic/Miracles/etc)',pass:true,warn:true,detail:'Specify tradition in parentheses'});
  }
  var hasChampion=edges.some(function(e){return e.toLowerCase()==='champion';});
  var hasABMiracles=edges.some(function(e){return e.toLowerCase().includes('arcane background')&&e.toLowerCase().includes('miracles');});
  if(hasChampion&&!hasABMiracles){
    results.push({section:'Edge Prerequisites',label:'Champion requires Arcane Background (Miracles)',pass:true,warn:true,detail:'Check Arcane Background tradition'});
  }
  // â”€â”€ Hindrance Overflow Check â”€â”€
  var hindPts=window.SWADERules.calcHindrancePoints(n.hindrances||[]);
  if(hindPts.raw>4){
    results.push({section:'Hindrance Overflow',label:hindPts.raw+' raw hindrance points ('+hindPts.majorCount+' Major, '+hindPts.minorCount+' Minor) â€” only 4 effective',pass:true,warn:true,detail:'Extra hindrances add flavour but no mechanical benefit'});
  }
  return results;
}

function renderAuditPanel(n){
  const results=runBuildAudit(n);
  const legal=results.every(r=>r.pass);
  let html=`<div class="audit-block"><h4 style="color:var(--accent);margin-bottom:8px;font-size:14px">${esc(n.name)} â€” Build Audit</h4>`,curSec='';
  results.forEach(r=>{
    if(r.section!==curSec){curSec=r.section;html+=`<div class="audit-section"><h4>${esc(curSec)}</h4>`;}
    const cls=r.warn?'audit-warn':r.pass?'audit-pass':'audit-fail';
    const icon=r.warn?'âš ':r.pass?'âœ“':'âœ—';
    html+=`<div class="audit-line ${cls}">${icon} ${esc(r.label)} ${esc(r.detail)}</div>`;
    // Add fix button after Core Skills warnings
    if(r.section==='Core Skills'&&r.warn){
      html+='<div style="margin:4px 0 6px"><button class="btn sm" onclick="fixMissingCoreSkills()" style="color:var(--green);border-color:var(--green)">+ Add Missing Core Skills (d4)</button></div>';
    }
  });
  html+='</div></div>';
  // Funds audit
  let baseFunds=500,fundsNote='';
  if(n.edges.some(e=>e.toLowerCase().includes('filthy rich'))){baseFunds=2500;fundsNote=' (Filthy Rich x5)';}
  else if(n.edges.some(e=>e.toLowerCase()==='rich')){baseFunds=1500;fundsNote=' (Rich x3)';}
  if(n.hindrances.some(h=>h.toLowerCase().includes('poverty'))){baseFunds=Math.floor(baseFunds/2);fundsNote+=' (Poverty half)';}
  const funds=n.startingFunds||baseFunds, spent=n.gearCost||0, remaining=funds-spent;
  const fundsPass=remaining>=0;
  const fundsWarn=remaining>50&&n.category==='Pre-gen';
  html+='<div class="audit-block"><div class="audit-section"><h4>Equipment Funds</h4>';
  html+=`<div class="audit-line ${fundsPass?'audit-pass':'audit-fail'}">${fundsPass?'âœ“':'âœ—'} Starting funds: ${funds}${fundsNote}â‚¡</div>`;
  html+=`<div class="audit-line ${fundsPass?'audit-pass':'audit-fail'}">${fundsPass?'âœ“':'âœ—'} Gear cost: ${spent}â‚¡ â€” Remaining: ${remaining}â‚¡ ${fundsPass?'âœ“':'OVER BUDGET'}</div>`;
  if(fundsWarn) html+='<div class="audit-line audit-warn">âš  '+remaining+'â‚¡ unspent â€” consider additional gear</div>';
  html+='</div></div>';
  const inCanon=canonCommitted.has(n.name);
  const removeBtn=inCanon?'<button class="btn" onclick="removeFromCanon()" style="color:var(--red);border-color:var(--red)" title="Remove this character from canonical data">ğŸ—‘ Remove from Canon</button>':'';
  // Lifecycle info
  const lc=getLifecycle(n.name);
  const dirty=isCharDirty(n.name);
  const pubProds=getPublishedProducts(n.name);
  const snap=_canonSnapshots[n.name];
  html+='<div class="audit-block"><div class="audit-section"><h4>Release Lifecycle <span style="font-size:11px;font-weight:normal;color:var(--text-dim);cursor:pointer;text-decoration:underline" onclick="showCommitHelp()" title="How does the commit workflow work?">â“˜ help</span></h4>';
  const lcColour=lc==='published'?'var(--green)':lc==='committed'?'#e8b84e':'var(--text-dim)';
  const lcIcon=lc==='published'?'ğŸ”’':lc==='committed'?'ğŸ“¦':'ğŸ“';
  html+=`<div class="audit-line audit-pass">${lcIcon} Status: <span style="color:${lcColour};text-transform:uppercase">${lc}</span></div>`;
  if(snap){
    const commitDate=new Date(snap.committedAt).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});
    html+=`<div class="audit-line audit-pass" style="font-size:12px">Last committed: ${commitDate} Â· ${esc(snap.changeId)}</div>`;
  }
  if(pubProds.length) html+=`<div class="audit-line audit-pass">Published in: ${pubProds.map(p=>esc(p.code)+' â€” '+esc(p.title)+' ('+new Date(p.releasedAt).toLocaleDateString()+')').join(', ')}</div>`;
  if(dirty){
    const diff=getCharDiff(n.name);
    html+=`<div class="audit-line audit-warn">âœï¸ ${diff.length} pending change${diff.length===1?'':'s'} since last ${inCanon?'commit':'baseline'}</div>`;
    diff.forEach(d=>html+=`<div class="audit-line" style="padding-left:20px;font-size:11px;color:${d.type==='added'?'var(--green)':d.type==='removed'?'var(--red)':'var(--accent)'}">${d.type==='added'?'+':d.type==='removed'?'âˆ’':'~'} ${esc(d.text)}</div>`);
  }else{
    html+='<div class="audit-line audit-pass">âœ“ No pending changes â€” matches '+(inCanon?'committed version':'baseline')+'</div>';
  }
  // Override log
  if(n.overrideLog&&n.overrideLog.length){
    html+='<h4 style="margin-top:10px">Errata Log</h4>';
    n.overrideLog.forEach(o=>{
      html+=`<div class="audit-line" style="font-size:11px;border-left:2px solid #cc3333;padding-left:8px;margin-bottom:4px">
        <span style="color:var(--text-dim)">${new Date(o.date).toLocaleDateString()}</span> â€” <span style="color:#ee6666">${esc(o.reason)}</span>
        ${o.changes?'<br>'+o.changes.map(c=>esc(c.text)).join(', '):''}
      </div>`;
    });
  }
  html+='</div></div>';
  // Commit area
  const needsCommit=!inCanon||dirty;
  const commitBtnClass=needsCommit?'btn primary':'btn';
  const commitBtnStyle=needsCommit?'':'opacity:0.4;cursor:default;pointer-events:none';
  const commitLabel=needsCommit?(inCanon?'ğŸ”„ Update Canon':'ğŸ“¦ Commit to Canon'):'âœ“ Canon Up to Date';
  const commitHint=needsCommit?(inCanon?'Changes detected â€” click to save the new canonical version':'Click to lock this character into the canonical record'):'All changes saved. Edit the character to enable commits.';
  // Show last commit result if it was for this character
  let resultMsg='';
  if(_lastCommitResult&&_lastCommitResult.name===n.name){
    if(_lastCommitResult.ok) resultMsg=`<div style="margin-top:6px;padding:6px 10px;background:rgba(80,200,80,0.1);border:1px solid rgba(80,200,80,0.3);border-radius:4px;font-size:12px;color:var(--green)">âœ… Committed as <strong>${esc(_lastCommitResult.changeId)}</strong> â€” canon updated</div>`;
    else resultMsg=`<div style="margin-top:6px;padding:6px 10px;background:rgba(200,50,50,0.1);border:1px solid rgba(200,50,50,0.3);border-radius:4px;font-size:12px;color:var(--red)">âŒ Commit failed: ${esc(_lastCommitResult.error||'Unknown error')}</div>`;
  }
  html+=`<div id="commitArea" style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border)">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button id="auditCommitBtn" class="${commitBtnClass}" onclick="doCommitFromAudit()" style="${commitBtnStyle}" title="${commitHint}">${commitLabel}</button>
      ${removeBtn}
    </div>
    <div style="margin-top:6px;font-size:12px;color:var(--text-dim)">${commitHint}</div>
    ${resultMsg}
    <div id="commitFeedback" style="margin-top:6px;font-size:13px"></div>
  </div>`;
  document.getElementById('panelContent').innerHTML=html;
}

function toggleStatus(field,val){currentNPC[field]=val;saveCharacter(currentNPC);filterNPCs();updateHeaderStats();}
function deleteNPC(){
  if(!confirm(`Delete ${currentNPC.name}?`))return;
  allNPCs=allNPCs.filter(n=>n.name!==currentNPC.name);currentNPC=null;
  hideBottomBar();scheduleSave();
  document.getElementById('mainContent').innerHTML='Select an NPC or create a new one';
  document.getElementById('mainContent').classList.add('empty-state');
  filterNPCs();updateHeaderStats();
}
function openNewNPCModal(){document.getElementById('newNpcModal').classList.add('active');}
function closeNewNPCModal(){document.getElementById('newNpcModal').classList.remove('active');}
function ensureCoreSkills(npc){
  const core=window.CharacterForge?.data?.coreSkills||['Athletics','Common Knowledge','Notice','Persuasion','Stealth'];
  let added=0;
  core.forEach(sk=>{if(!npc.skills[sk]){npc.skills[sk]=4;added++;}});
  return added;
}
function fixMissingCoreSkills(){
  if(!currentNPC)return;
  const added=ensureCoreSkills(currentNPC);
  if(added){calcDerived(currentNPC);saveCharacter(currentNPC);renderDetail();}
}
function batchFixCoreSkills(){
  const coreNames=window.CharacterForge?.data?.coreSkills||['Athletics','Common Knowledge','Notice','Persuasion','Stealth'];
  const affected=allNPCs.filter(n=>coreNames.some(sk=>!n.skills[sk]));
  if(!affected.length){alert('All characters already have core skills.');return;}
  if(!confirm('Add missing core skills (d4) to '+affected.length+' character'+(affected.length>1?'s':'')+'?\n\nThis will mark them as edited.')){return;}
  let total=0;
  affected.forEach(n=>{total+=ensureCoreSkills(n);calcDerived(n);saveCharacter(n);});
  filterNPCs();updateHeaderStats();showStatusView();
}
function createNPC(){
  const name=document.getElementById('new_name').value.trim();if(!name){alert('Name is required');return;}
  const npc={name,refCode:'',concept:document.getElementById('new_concept')?.value?.trim()||'',ancestry:document.getElementById('new_ancestry').value,region:document.getElementById('new_region').value,tier:document.getElementById('new_tier').value,rank:'Novice',category:document.getElementById('new_category').value,product:'',source:'custom',agility:0,smarts:0,spirit:0,strength:0,vigor:0,skills:{},edges:[],edgeNotes:{},hindrances:[],powers:[],gearText:'',quote:'',description:'',background:'',motivation:'',secret:'',services:'',adventureHook:'',tactics:'',abName:'',abSkill:'',pp:0,statComplete:false,narrativeComplete:false,fgReady:false,pace:6,parry:2,toughness:5,toughnessArmor:0,bennies:0,startingFunds:500,gearCost:0};
  ensureCoreSkills(npc);
  calcDerived(npc);allNPCs.push(npc);saveCharacter(npc);captureBaseline(name);closeNewNPCModal();filterNPCs();updateHeaderStats();selectNPC(name);
}

// === TRANSFER (IMPORT / EXPORT) ===
function buildExportJSON(n){
  return {
    _format:'diceforge-character-v1',
    name:n.name,refCode:n.refCode||'',concept:n.concept||'',ancestry:n.ancestry||'Human',
    region:n.region||'Ammaria',tier:n.tier||'Wild Card',rank:n.rank||'Novice',
    category:n.category||'NPC',product:n.product||'',
    attributes:{agility:n.agility||4,smarts:n.smarts||4,spirit:n.spirit||4,strength:n.strength||4,vigor:n.vigor||4},
    skills:Object.assign({},n.skills),edges:[...(n.edges||[])],hindrances:[...(n.hindrances||[])],
    powers:[...(n.powers||[])],weapons:[...(n.weapons||[])],armour:[...(n.armour||[])],
    gearText:n.gearText||'',
    abName:n.abName||'',abSkill:n.abSkill||'',pp:n.pp||0,
    pace:n.pace||6,parry:n.parry||2,toughness:n.toughness||5,toughnessArmor:n.toughnessArmor||0,
    bennies:n.bennies||0,startingFunds:n.startingFunds||500,gearCost:n.gearCost||0,
    quote:n.quote||'',description:n.description||'',background:n.background||'',
    motivation:n.motivation||'',secret:n.secret||'',services:n.services||'',
    adventureHook:n.adventureHook||'',tactics:n.tactics||''
  };
}

function buildStatBlockText(n){
  const lines=[];
  lines.push(n.name+(n.concept?' â€” '+n.concept:''));
  lines.push('');
  if(n.quote) lines.push('"'+n.quote+'"','');
  if(n.description) lines.push(n.description,'');
  lines.push('Attributes: Agility d'+n.agility+', Smarts d'+n.smarts+', Spirit d'+n.spirit+', Strength d'+n.strength+', Vigor d'+n.vigor);
  lines.push('Skills: '+Object.entries(n.skills).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>k+' d'+v).join(', '));
  const tDisp=n.toughnessArmor>0?n.toughness+' ('+n.toughnessArmor+')':''+n.toughness;
  lines.push('Pace: '+n.pace+'; Parry: '+n.parry+'; Toughness: '+tDisp);
  if(n.edges.length) lines.push('Edges: '+n.edges.join(', '));
  if(n.hindrances.length) lines.push('Hindrances: '+n.hindrances.join(', '));
  if(n.powers.length) lines.push('Powers: '+n.powers.join(', ')+(n.pp?' ('+n.pp+' Power Points)':''));
  if(n.weapons.length) lines.push('Weapons: '+n.weapons.map(w=>w.name+' ('+w.damage+(w.ap?', AP '+w.ap:'')+(w.range?', '+w.range:'')+')').join(', '));
  if(n.armour.length) lines.push('Armour: '+n.armour.map(a=>a.name+' (+'+a.armor+')').join(', '));
  if(n.gearText) lines.push('Gear: '+n.gearText);
  if(n.abName) lines.push('Arcane Background: '+n.abName+(n.abSkill?' ('+n.abSkill+')':''));
  return lines.join('\n');
}

function renderTransferPanel(n){
  document.getElementById('panelContent').innerHTML=`
    <div style="margin-bottom:16px">
      <h4 style="color:var(--accent);margin-bottom:8px">Export: ${esc(n.name)}</h4>
      <div style="display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap">
        <button class="btn sm" onclick="setExportFmt('json')" id="expFmtJSON" style="border-color:var(--accent);color:var(--accent)">JSON</button>
        <button class="btn sm" onclick="setExportFmt('text')" id="expFmtText">Text</button>
        <button class="btn sm" onclick="setExportFmt('html')" id="expFmtHTML">HTML</button>
        <button class="btn sm" onclick="setExportFmt('rtf')" id="expFmtRTF">RTF</button>
      </div>
      <div id="exportFormatNote" style="font-size:11px;color:var(--text-dim);margin-bottom:6px"></div>
      <textarea id="exportPreview" readonly rows="12" style="width:100%;box-sizing:border-box;font-family:monospace;font-size:11px;background:var(--bg-body);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:8px;resize:vertical"></textarea>
      <div style="display:flex;gap:6px;margin-top:8px">
        <button class="btn primary" onclick="copyExport()">ğŸ“‹ Copy to Clipboard</button>
        <button class="btn" onclick="downloadExport()">ğŸ’¾ Download File</button>
      </div>
    </div>
    <hr style="border-color:var(--border);margin:16px 0">
    <div>
      <h4 style="color:var(--accent);margin-bottom:8px">Import Character</h4>
      <div style="margin-bottom:8px;font-size:12px;color:var(--text-dim)">
        <strong style="color:var(--green)">JSON</strong> â€” lossless, recommended.
        <strong style="color:#e6a117">Text / HTML / RTF</strong> â€” best-effort parse, review carefully.
      </div>
      <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
        <label style="font-size:11px;text-transform:uppercase;color:var(--text-dim)">Source</label>
        <button class="btn sm" id="impSrcPaste" onclick="setImportSource('paste')" style="border-color:var(--accent);color:var(--accent)">Paste Text</button>
        <button class="btn sm" id="impSrcFile" onclick="setImportSource('file')">Upload File</button>
      </div>
      <div id="importPasteArea">
        <textarea id="import_data" rows="6" placeholder="Paste character JSON, stat block text, or HTML here..." style="width:100%;box-sizing:border-box;font-family:monospace;font-size:11px;background:var(--bg-input);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:8px;resize:vertical"></textarea>
      </div>
      <div id="importFileArea" style="display:none">
        <div style="border:2px dashed var(--border);border-radius:6px;padding:14px;text-align:center;margin-bottom:6px">
          <div style="font-size:12px;color:var(--text-dim);margin-bottom:6px">Drop a file or click to browse</div>
          <input type="file" id="import_file" accept=".json,.txt,.html,.htm,.rtf" onchange="handleImportFile(this)" style="display:block;margin:0 auto;font-size:12px">
          <div style="font-size:10px;color:var(--text-dim);margin-top:4px">Accepts: .json, .txt, .html, .rtf</div>
        </div>
        <div id="importFileName" style="font-size:12px;color:var(--accent)"></div>
      </div>
      <div id="importPreview" style="margin-top:6px;font-size:12px;max-height:120px;overflow-y:auto"></div>
      <div id="importStatus" style="margin-top:4px;font-size:13px"></div>
      <div style="display:flex;gap:6px;margin-top:8px">
        <button class="btn" onclick="previewImport()">ğŸ‘ Preview</button>
        <button class="btn primary" id="importBtn" onclick="executeImport()">â‡„ Import Character</button>
      </div>
    </div>`;
  setExportFmt('json');
}

var currentExportFmt='json';
function setExportFmt(fmt){
  currentExportFmt=fmt;
  const ta=document.getElementById('exportPreview');
  const note=document.getElementById('exportFormatNote');
  if(!ta||!currentNPC) return;
  ['json','text','html','rtf'].forEach(f=>{
    const btn=document.getElementById('expFmt'+f.toUpperCase());
    if(btn){btn.style.borderColor=f===fmt?'var(--accent)':'var(--border)';btn.style.color=f===fmt?'var(--accent)':'var(--text-dim)';}
  });
  const notes={
    json:'Lossless â€” full character data. Use for Forge/Vault transfer.',
    text:'Plain text stat block â€” for documents, sharing with players. Not reliably re-importable.',
    html:'Formatted HTML â€” opens in any browser. Import is experimental.',
    rtf:'Rich Text Format â€” Download opens in Word/LibreOffice. Copy pastes as formatted text into Word.'
  };
  note.textContent=notes[fmt]||'';
  if(fmt==='json') ta.value=JSON.stringify(buildExportJSON(currentNPC),null,2);
  else if(fmt==='text') ta.value=buildStatBlockText(currentNPC);
  else if(fmt==='html') ta.value=buildExportHTML(currentNPC);
  else if(fmt==='rtf') ta.value=buildStatBlockText(currentNPC);
}

function copyExport(){
  if(!currentNPC) return;
  if(currentExportFmt==='rtf'){
    // Copy as HTML so Word pastes formatted text, not RTF codes
    const html=buildExportHTML(currentNPC);
    const blob=new Blob([html],{type:'text/html'});
    const item=new ClipboardItem({'text/html':blob,'text/plain':new Blob([buildStatBlockText(currentNPC)],{type:'text/plain'})});
    navigator.clipboard.write([item]).then(()=>showCopyToast('Formatted text copied â€” paste into Word'));
    return;
  }
  const ta=document.getElementById('exportPreview');
  if(!ta) return;
  navigator.clipboard.writeText(ta.value).then(()=>showCopyToast(currentExportFmt.toUpperCase()+' copied to clipboard'));
}

function downloadExport(){
  if(!currentNPC) return;
  const safeName=currentNPC.name.replace(/[^a-zA-Z0-9_-]/g,'_');
  const exts={json:'.json',text:'.txt',html:'.html',rtf:'.rtf'};
  const mimes={json:'application/json',text:'text/plain',html:'text/html',rtf:'application/rtf'};
  const ext=exts[currentExportFmt]||'.txt';
  const mime=mimes[currentExportFmt]||'text/plain';
  // For RTF download, use actual RTF content, not the preview text
  const content=currentExportFmt==='rtf'?buildExportRTF(currentNPC):document.getElementById('exportPreview').value;
  const blob=new Blob([content],{type:mime});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=safeName+ext;
  a.click();
  URL.revokeObjectURL(a.href);
  showCopyToast('Downloaded '+safeName+ext);
}

function buildExportJSON(n){
  return {
    _format:'diceforge-character-v1',
    name:n.name,refCode:n.refCode||'',concept:n.concept||'',ancestry:n.ancestry||'Human',
    region:n.region||'Ammaria',tier:n.tier||'Wild Card',rank:n.rank||'Novice',
    category:n.category||'NPC',product:n.product||'',
    attributes:{agility:n.agility||4,smarts:n.smarts||4,spirit:n.spirit||4,strength:n.strength||4,vigor:n.vigor||4},
    skills:Object.assign({},n.skills),edges:[...(n.edges||[])],hindrances:[...(n.hindrances||[])],
    powers:[...(n.powers||[])],weapons:[...(n.weapons||[])],armour:[...(n.armour||[])],
    gearText:n.gearText||'',
    abName:n.abName||'',abSkill:n.abSkill||'',pp:n.pp||0,
    pace:n.pace||6,parry:n.parry||2,toughness:n.toughness||5,toughnessArmor:n.toughnessArmor||0,
    bennies:n.bennies||0,startingFunds:n.startingFunds||500,gearCost:n.gearCost||0,
    quote:n.quote||'',description:n.description||'',background:n.background||'',
    motivation:n.motivation||'',secret:n.secret||'',services:n.services||'',
    adventureHook:n.adventureHook||'',tactics:n.tactics||''
  };
}

function buildStatBlockText(n){
  const lines=[];
  lines.push(n.name+(n.concept?' â€” '+n.concept:''));
  lines.push('');
  if(n.quote) lines.push('"'+n.quote+'"','');
  if(n.description) lines.push(n.description,'');
  lines.push('Attributes: Agility d'+n.agility+', Smarts d'+n.smarts+', Spirit d'+n.spirit+', Strength d'+n.strength+', Vigor d'+n.vigor);
  lines.push('Skills: '+Object.entries(n.skills).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>k+' d'+v).join(', '));
  const tDisp=n.toughnessArmor>0?n.toughness+' ('+n.toughnessArmor+')':''+n.toughness;
  lines.push('Pace: '+n.pace+'; Parry: '+n.parry+'; Toughness: '+tDisp);
  if(n.edges.length) lines.push('Edges: '+n.edges.join(', '));
  if(n.hindrances.length) lines.push('Hindrances: '+n.hindrances.join(', '));
  if(n.powers.length) lines.push('Powers: '+n.powers.join(', ')+(n.pp?' ('+n.pp+' Power Points)':''));
  if(n.weapons.length) lines.push('Weapons: '+n.weapons.map(w=>w.name+' ('+w.damage+(w.ap?', AP '+w.ap:'')+(w.range?', '+w.range:'')+')').join(', '));
  if(n.armour.length) lines.push('Armour: '+n.armour.map(a=>a.name+' (+'+a.armor+')').join(', '));
  if(n.gearText) lines.push('Gear: '+n.gearText);
  if(n.abName) lines.push('Arcane Background: '+n.abName+(n.abSkill?' ('+n.abSkill+')':''));
  return lines.join('\n');
}

function buildExportHTML(n){
  const tDisp=n.toughnessArmor>0?n.toughness+' ('+n.toughnessArmor+')':''+n.toughness;
  const wcStar=n.tier==='Wild Card'?' â˜…':'';
  let h='<!DOCTYPE html>\n<html><head><meta charset="utf-8"><title>'+esc(n.name)+'</title>\n';
  h+='<style>body{font-family:Georgia,serif;max-width:700px;margin:40px auto;padding:20px;color:#222;line-height:1.6}';
  h+='h1{font-size:22px;margin-bottom:2px;color:#8b0000}h2{font-size:14px;color:#666;font-weight:normal;margin-top:0}';
  h+='.quote{font-style:italic;color:#555;margin:12px 0;border-left:3px solid #8b0000;padding-left:12px}';
  h+='.desc{margin:12px 0}.stat-label{font-weight:bold;color:#8b0000}.stat-line{margin:4px 0}';
  h+='.section{margin:8px 0}.footer{margin-top:20px;padding-top:10px;border-top:1px solid #ccc;font-size:11px;color:#999}</style>  <script src="tool-navigation.js"></script>
</head><body>\n';
  h+='<h1>'+esc(n.name)+wcStar+'</h1>\n';
  if(n.concept) h+='<h2>'+esc(n.concept)+'</h2>\n';
  if(n.quote) h+='<div class="quote">"'+esc(n.quote)+'"</div>\n';
  if(n.description) h+='<div class="desc">'+esc(n.description)+'</div>\n';
  h+='<div class="stat-line"><span class="stat-label">Attributes:</span> Agility d'+n.agility+', Smarts d'+n.smarts+', Spirit d'+n.spirit+', Strength d'+n.strength+', Vigor d'+n.vigor+'</div>\n';
  h+='<div class="stat-line"><span class="stat-label">Skills:</span> '+Object.entries(n.skills).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>k+' d'+v).join(', ')+'</div>\n';
  h+='<div class="stat-line"><span class="stat-label">Pace:</span> '+n.pace+'; <span class="stat-label">Parry:</span> '+n.parry+'; <span class="stat-label">Toughness:</span> '+tDisp+'</div>\n';
  if(n.edges.length) h+='<div class="stat-line"><span class="stat-label">Edges:</span> '+n.edges.map(e=>esc(e)).join(', ')+'</div>\n';
  if(n.hindrances.length) h+='<div class="stat-line"><span class="stat-label">Hindrances:</span> '+n.hindrances.map(x=>esc(x)).join(', ')+'</div>\n';
  if(n.powers.length) h+='<div class="stat-line"><span class="stat-label">Powers:</span> '+n.powers.map(p=>esc(p)).join(', ')+(n.pp?' ('+n.pp+' PP)':'')+'</div>\n';
  if(n.weapons.length) h+='<div class="stat-line"><span class="stat-label">Weapons:</span> '+n.weapons.map(w=>esc(w.name)+' ('+esc(w.damage)+(w.ap?', AP '+w.ap:'')+(w.range?', '+esc(w.range):'')+')').join(', ')+'</div>\n';
  if(n.armour.length) h+='<div class="stat-line"><span class="stat-label">Armour:</span> '+n.armour.map(a=>esc(a.name)+' (+'+a.armor+')').join(', ')+'</div>\n';
  if(n.gearText) h+='<div class="stat-line"><span class="stat-label">Gear:</span> '+esc(n.gearText)+'</div>\n';
  if(n.abName) h+='<div class="stat-line"><span class="stat-label">Arcane Background:</span> '+esc(n.abName)+(n.abSkill?' ('+esc(n.abSkill)+')':'')+'</div>\n';
  h+='<div class="footer">Exported from DiceForge Character Vault â€” diceforge-character-v1</div>\n';
  h+='</body></html>';
  return h;
}

function buildExportRTF(n){
  const tDisp=n.toughnessArmor>0?n.toughness+' ('+n.toughnessArmor+')':''+n.toughness;
  const wcStar=n.tier==='Wild Card'?' *':'';
  const re=s=>(s||'').replace(/\\/g,'\\\\').replace(/\{/g,'\\{').replace(/\}/g,'\\}');
  let r='{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Georgia;}{\\f1 Arial;}}{\\colortbl;\\red139\\green0\\blue0;\\red100\\green100\\blue100;}\n';
  r+='\\f0\\fs24\\b '+re(n.name)+wcStar+'\\b0\\par\n';
  if(n.concept) r+='{\\f1\\fs20\\cf2 '+re(n.concept)+'}\\par\n';
  if(n.quote) r+='\\par{\\i "'+re(n.quote)+'"}\\par\n';
  if(n.description) r+='\\par '+re(n.description)+'\\par\n';
  r+='\\par{\\b\\cf1 Attributes:} Agility d'+n.agility+', Smarts d'+n.smarts+', Spirit d'+n.spirit+', Strength d'+n.strength+', Vigor d'+n.vigor+'\\par\n';
  r+='{\\b\\cf1 Skills:} '+Object.entries(n.skills).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>re(k)+' d'+v).join(', ')+'\\par\n';
  r+='{\\b\\cf1 Pace:} '+n.pace+'; {\\b\\cf1 Parry:} '+n.parry+'; {\\b\\cf1 Toughness:} '+tDisp+'\\par\n';
  if(n.edges.length) r+='{\\b\\cf1 Edges:} '+n.edges.map(e=>re(e)).join(', ')+'\\par\n';
  if(n.hindrances.length) r+='{\\b\\cf1 Hindrances:} '+n.hindrances.map(x=>re(x)).join(', ')+'\\par\n';
  if(n.powers.length) r+='{\\b\\cf1 Powers:} '+n.powers.map(p=>re(p)).join(', ')+(n.pp?' ('+n.pp+' PP)':'')+'\\par\n';
  if(n.weapons.length) r+='{\\b\\cf1 Weapons:} '+n.weapons.map(w=>re(w.name)+' ('+re(w.damage)+(w.ap?', AP '+w.ap:'')+(w.range?', '+re(w.range):'')+')').join(', ')+'\\par\n';
  if(n.armour.length) r+='{\\b\\cf1 Armour:} '+n.armour.map(a=>re(a.name)+' (+'+a.armor+')').join(', ')+'\\par\n';
  if(n.gearText) r+='{\\b\\cf1 Gear:} '+re(n.gearText)+'\\par\n';
  if(n.abName) r+='{\\b\\cf1 Arcane Background:} '+re(n.abName)+(n.abSkill?' ('+re(n.abSkill)+')':'')+'\\par\n';
  r+='\\par{\\f1\\fs16\\cf2 Exported from DiceForge Character Vault}\\par\n}';
  return r;
}

function showCopyToast(msg){
  const t=document.createElement('div');
  t.textContent=msg;
  t.style.cssText='position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--green);color:#000;padding:8px 16px;border-radius:4px;font-size:13px;z-index:9999;font-weight:600';
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2000);
}

// === IMPORT ===
function openImportModal(){/* legacy â€” import is now inline in the transfer panel */}
function closeImportModal(){/* legacy â€” no modal to close */}

function setImportSource(mode){
  document.getElementById('importPasteArea').style.display=mode==='paste'?'block':'none';
  document.getElementById('importFileArea').style.display=mode==='file'?'block':'none';
  document.getElementById('impSrcPaste').style.borderColor=mode==='paste'?'var(--accent)':'var(--border)';
  document.getElementById('impSrcPaste').style.color=mode==='paste'?'var(--accent)':'var(--text-dim)';
  document.getElementById('impSrcFile').style.borderColor=mode==='file'?'var(--accent)':'var(--border)';
  document.getElementById('impSrcFile').style.color=mode==='file'?'var(--accent)':'var(--text-dim)';
}

function handleImportFile(input){
  const file=input.files[0];if(!file) return;
  document.getElementById('importFileName').textContent='ğŸ“„ '+file.name+' ('+Math.round(file.size/1024)+'KB)';
  const reader=new FileReader();
  reader.onload=function(e){
    const text=e.target.result;
    document.getElementById('import_data').value=text;
    // Auto-detect format
    const ext=file.name.split('.').pop().toLowerCase();
    document.getElementById('importStatus').innerHTML='<span style="color:var(--accent)">File loaded â€” '+ext.toUpperCase()+' detected. Click Preview to validate.</span>';
  };
  reader.readAsText(file);
}

function previewImport(){
  let raw=document.getElementById('import_data').value.trim();
  const prev=document.getElementById('importPreview');
  const stat=document.getElementById('importStatus');
  if(!raw){stat.innerHTML='<span style="color:var(--red)">Nothing to preview â€” paste data or upload a file first</span>';return;}
  try{
    const npc=autoParseImport(raw);
    prev.innerHTML=`<div style="padding:8px;background:var(--bg-body);border:1px solid var(--border);border-radius:4px">
      <strong style="color:var(--accent)">${esc(npc.name)}</strong> ${esc(npc.concept||'')}
      <div style="margin-top:4px;font-size:11px">
      <div><strong>Ancestry:</strong> ${esc(npc.ancestry)} | <strong>Tier:</strong> ${esc(npc.tier)} | <strong>Category:</strong> ${esc(npc.category)}</div>
      <div><strong>Attributes:</strong> Agi d${npc.agility}, Sma d${npc.smarts}, Spi d${npc.spirit}, Str d${npc.strength}, Vig d${npc.vigor}</div>
      <div><strong>Skills:</strong> ${Object.entries(npc.skills).map(([k,v])=>k+' d'+v).join(', ')||'None'}</div>
      <div><strong>Edges:</strong> ${(npc.edges||[]).join(', ')||'None'}</div>
      <div><strong>Hindrances:</strong> ${(npc.hindrances||[]).join(', ')||'None'}</div>
      <div><strong>Weapons:</strong> ${(npc.weapons||[]).map(w=>w.name).join(', ')||'None'}</div>
      <div><strong>Armour:</strong> ${(npc.armour||[]).map(a=>a.name).join(', ')||'None'}</div>
      ${npc._importWarning?'<div style="color:#e6a117;margin-top:4px">'+npc._importWarning+'</div>':''}
      </div></div>`;
    prev._parsedNPC=npc;
    stat.innerHTML='<span style="color:var(--green)">âœ“ Parsed successfully â€” click Import to add</span>';
    const exists=allNPCs.find(n=>n.name===npc.name);
    if(exists) stat.innerHTML+='<br><span style="color:#e6a117">âš  "'+esc(npc.name)+'" already exists â€” importing will create a duplicate</span>';
  }catch(e){
    prev.innerHTML='';prev._parsedNPC=null;
    stat.innerHTML='<span style="color:var(--red)">âŒ Parse error: '+esc(e.message)+'</span>';
  }
}

function executeImport(){
  const prev=document.getElementById('importPreview');
  const stat=document.getElementById('importStatus');
  if(!prev._parsedNPC){stat.innerHTML='<span style="color:var(--red)">Preview first to validate the data</span>';return;}
  const npc=prev._parsedNPC;
  delete npc._importWarning;
  npc.weapons=npc.weapons||[];npc.armour=npc.armour||[];
  ensureCoreSkills(npc);
  calcDerived(npc);
  allNPCs.push(npc);
  saveCharacter(npc);captureBaseline(npc.name);
  filterNPCs();updateHeaderStats();selectNPC(npc.name);
}

function autoParseImport(raw){
  // Try JSON first
  const trimmed=raw.trim();
  if(trimmed.startsWith('{')){
    try{return parseImportJSON(trimmed);}catch(e){}
  }
  // Strip HTML tags if present
  if(trimmed.includes('<html')||trimmed.includes('<div')||trimmed.includes('<span')||trimmed.includes('<p')){
    const stripped=stripHTML(trimmed);
    const npc=parseImportStatBlock(stripped);
    npc._importWarning='âš  Imported from HTML â€” weapons, armour and gear require manual entry. Review all fields.';
    return npc;
  }
  // Strip RTF codes if present
  if(trimmed.startsWith('{\\rtf')){
    const stripped=stripRTF(trimmed);
    const npc=parseImportStatBlock(stripped);
    npc._importWarning='âš  Imported from RTF â€” weapons, armour and gear require manual entry. Review all fields.';
    return npc;
  }
  // Plain text stat block
  const npc=parseImportStatBlock(trimmed);
  npc._importWarning='âš  Imported from text â€” weapons, armour and gear require manual entry. Review all fields.';
  return npc;
}

function stripHTML(html){
  const tmp=document.createElement('div');
  tmp.innerHTML=html;
  return tmp.textContent||tmp.innerText||'';
}

function stripRTF(rtf){
  // Remove RTF header, control words, groups
  let text=rtf;
  text=text.replace(/\{\\fonttbl[^}]*\}/g,'');
  text=text.replace(/\{\\colortbl[^}]*\}/g,'');
  text=text.replace(/\\par\b/g,'\n');
  text=text.replace(/\\tab\b/g,' ');
  text=text.replace(/\\line\b/g,'\n');
  text=text.replace(/\\'([0-9a-fA-F]{2})/g,(m,hex)=>String.fromCharCode(parseInt(hex,16)));
  text=text.replace(/\\[a-z]+\d*\s?/gi,'');
  text=text.replace(/[{}]/g,'');
  text=text.replace(/\n{3,}/g,'\n\n');
  return text.trim();
}

function parseImportJSON(raw){
  let obj;
  try{obj=JSON.parse(raw);}catch(e){throw new Error('Invalid JSON â€” check formatting');}
  if(!obj.name) throw new Error('Missing required field: name');
  const a=obj.attributes||obj.attrs||{};
  return {
    name:obj.name,refCode:obj.refCode||'',concept:obj.concept||'',ancestry:obj.ancestry||'Human',
    region:obj.region||'Ammaria',tier:obj.tier||'Wild Card',rank:obj.rank||'Novice',
    category:obj.category||'NPC',product:obj.product||'',source:'import',
    agility:a.agility||obj.agility||4,smarts:a.smarts||obj.smarts||4,spirit:a.spirit||obj.spirit||4,
    strength:a.strength||obj.strength||4,vigor:a.vigor||obj.vigor||4,
    skills:obj.skills||{},edges:obj.edges||[],edgeNotes:obj.edgeNotes||{},hindrances:obj.hindrances||[],
    powers:obj.powers||[],weapons:obj.weapons||[],armour:obj.armour||[],
    gearText:obj.gearText||'',quote:obj.quote||'',description:obj.description||'',
    background:obj.background||'',motivation:obj.motivation||'',secret:obj.secret||'',
    services:obj.services||'',adventureHook:obj.adventureHook||'',tactics:obj.tactics||'',
    abName:obj.abName||'',abSkill:obj.abSkill||'',pp:obj.pp||0,
    startingFunds:obj.startingFunds||500,gearCost:obj.gearCost||0,
    pace:obj.pace||6,parry:obj.parry||2,toughness:obj.toughness||5,
    toughnessArmor:obj.toughnessArmor||0,bennies:obj.bennies||0,
    statComplete:false,narrativeComplete:false,fgReady:false
  };
}

function parseImportStatBlock(raw){
  const lines=raw.split('\n').map(l=>l.trim()).filter(l=>l);
  const npc={name:'',refCode:'',concept:'',ancestry:'Human',region:'Ammaria',tier:'Wild Card',rank:'Novice',
    category:'NPC',product:'',source:'import-statblock',agility:4,smarts:4,spirit:4,strength:4,vigor:4,
    skills:{},edges:[],hindrances:[],powers:[],weapons:[],armour:[],gearText:'',quote:'',description:'',
    background:'',motivation:'',secret:'',services:'',adventureHook:'',tactics:'',
    abName:'',abSkill:'',pp:0,startingFunds:500,gearCost:0,pace:6,parry:2,toughness:5,toughnessArmor:0,bennies:0,
    statComplete:false,narrativeComplete:false,fgReady:false};
  if(lines.length) npc.name=lines[0].replace(/\*+/g,'').replace(/â€”.*/,'').replace(/--.*/,'').trim();
  for(const line of lines){
    const lo=line.toLowerCase();
    if(lo.startsWith('attributes:')){
      const m=line.match(/agility\s*d(\d+)/i);if(m) npc.agility=parseInt(m[1]);
      const m2=line.match(/smarts\s*d(\d+)/i);if(m2) npc.smarts=parseInt(m2[1]);
      const m3=line.match(/spirit\s*d(\d+)/i);if(m3) npc.spirit=parseInt(m3[1]);
      const m4=line.match(/strength\s*d(\d+)/i);if(m4) npc.strength=parseInt(m4[1]);
      const m5=line.match(/vigor\s*d(\d+)/i);if(m5) npc.vigor=parseInt(m5[1]);
    }
    else if(lo.startsWith('skills:')){
      const parts=line.substring(7).split(',');
      parts.forEach(p=>{const m=p.trim().match(/^(.+?)\s+d(\d+)/);if(m) npc.skills[m[1].trim()]=parseInt(m[2]);});
    }
    else if(lo.startsWith('edges:')) npc.edges=line.substring(6).split(',').map(s=>s.trim()).filter(s=>s);
    else if(lo.startsWith('hindrances:')) npc.hindrances=line.substring(11).split(',').map(s=>s.trim()).filter(s=>s);
    else if(lo.startsWith('powers:')) npc.powers=line.substring(7).replace(/\(.*?\)/g,'').split(',').map(s=>s.trim()).filter(s=>s);
    else if(lo.startsWith('pace:')){
      const pm=line.match(/pace[:\s]*(\d+)/i);if(pm) npc.pace=parseInt(pm[1]);
      const prm=line.match(/parry[:\s]*(\d+)/i);if(prm) npc.parry=parseInt(prm[1]);
      const tm=line.match(/toughness[:\s]*(\d+)/i);if(tm) npc.toughness=parseInt(tm[1]);
      const tam=line.match(/toughness[:\s]*\d+\s*\((\d+)\)/i);if(tam) npc.toughnessArmor=parseInt(tam[1]);
    }
    else if(lo.startsWith('gear:')) npc.gearText=line.substring(5).trim();
    else if(lo.startsWith('arcane background')){
      const abm=line.match(/arcane background[:\s]*(.+?)(?:\s*\((.+?)\))?$/i);
      if(abm){npc.abName=abm[1].trim();if(abm[2]) npc.abSkill=abm[2].trim();}
    }
  }
  if(!npc.name) throw new Error('Could not find character name â€” expected it on the first line');
  if(npc.agility===4&&npc.smarts===4&&npc.spirit===4&&npc.strength===4&&npc.vigor===4&&Object.keys(npc.skills).length===0)
    throw new Error('No attributes or skills found â€” check format: "Attributes: Agility d6, Smarts d8..."');
  return npc;
}
function showStatusView(){
  hideBottomBar();currentNPC=null;activePanel=null;navPush({type:'status'});updateBreadcrumb();
  const el=document.getElementById('mainContent');el.classList.remove('empty-state');el.style.overflowY='auto';
  const rows=allNPCs.map(n=>{
    const audit=runBuildAudit(n);const legal=audit.every(r=>r.pass);
    const inCanon=canonCommitted.has(n.name);
    const lc=getLifecycle(n.name);
    const dirty=isCharDirty(n.name);
    const lcColour=lc==='published'?'var(--green)':lc==='committed'?'#e8b84e':'var(--text-dim)';
    const lcIcon=lc==='published'?'ğŸ”’':lc==='committed'?'ğŸ“¦':'ğŸ“';
    const dirtyIcon=dirty?(lc==='published'?'<span style="color:#ee6666" title="Errata pending">âš </span>':'<span style="color:#e8b84e" title="Edited">âœï¸</span>'):'';
    return `<tr><td style="font-family:monospace;font-size:11px;color:var(--text-dim)">${esc(n.refCode||'â€”')}</td><td style="cursor:pointer;color:var(--accent)" onclick="selectNPC('${esc(n.name).replace(/'/g,"\\'")}')">${esc(n.name)}</td><td>${esc(n.category||'NPC')}</td><td>${esc(n.region)}</td><td>${esc(n.tier)}</td><td>${legal?'âœ…':'âŒ'}</td><td style="color:${lcColour}">${lcIcon} ${lc}</td><td>${dirtyIcon}</td><td style="color:${n.statComplete?'var(--green)':'var(--text-dim)'}">&#${n.statComplete?'10003':'8212'};</td><td style="color:${n.narrativeComplete?'var(--green)':'var(--text-dim)'}">&#${n.narrativeComplete?'10003':'8212'};</td><td style="color:${n.fgReady?'var(--green)':'var(--text-dim)'}">&#${n.fgReady?'10003':'8212'};</td></tr>`;
  }).join('');
  const prodSummary=_productRegistry.products.length?`<div style="margin-bottom:14px;font-size:13px;color:var(--text-dim)">Products: ${_productRegistry.products.map(p=>`<span style="color:${p.status==='released'?'var(--green)':p.status==='in-review'?'#e8b84e':'var(--text-dim)'}">${esc(p.code)}</span>`).join(', ')} Â· <a style="color:var(--accent);cursor:pointer" onclick="showProductsModal()">Manage</a></div>`:'';
  const coreNames=window.CharacterForge?.data?.coreSkills||['Athletics','Common Knowledge','Notice','Persuasion','Stealth'];
  const missingCore=allNPCs.filter(n=>coreNames.some(sk=>!n.skills[sk]));
  const coreFix=missingCore.length?`<div style="margin-bottom:14px;padding:8px 12px;background:#e8b84e15;border:1px solid #e8b84e44;border-radius:4px;font-size:12px"><span style="color:#e8b84e">âš  ${missingCore.length} character${missingCore.length>1?'s':''} missing core skills:</span> ${missingCore.slice(0,8).map(n=>esc(n.name)).join(', ')}${missingCore.length>8?'â€¦':''} <button class="btn sm" onclick="batchFixCoreSkills()" style="margin-left:8px;color:var(--green);border-color:var(--green)">Fix All (add d4)</button></div>`:'';
  el.innerHTML=`<h2 style="color:var(--accent);margin-bottom:14px">Production Status</h2>${prodSummary}${coreFix}<table class="data-table"><tr><th>Ref</th><th>Name</th><th>Type</th><th>Region</th><th>Tier</th><th>Build</th><th>Lifecycle</th><th>Edits</th><th>Stats</th><th>Narrative</th><th>FG Ready</th></tr>${rows}</table>`;
}

// â”€â”€ CANON COMMIT SYSTEM â”€â”€
// Canon system â€” all data stored in gist, no external API needed

function buildCanonCharacter(n){
  return {
    name:n.name, refCode:n.refCode||'', concept:n.concept||'', ancestry:n.ancestry||'Human', region:n.region||'Ammaria',
    tier:n.tier||'Wild Card', rank:n.rank||'Novice', category:n.category||'NPC', product:n.product||n.region||'Ammaria',
    attrs:{agility:n.agility||4,smarts:n.smarts||4,spirit:n.spirit||4,strength:n.strength||4,vigor:n.vigor||4},
    skills:Object.assign({},n.skills), edges:[...(n.edges||[])], hindrances:[...(n.hindrances||[])],
    powers:[...(n.powers||[])], weapons:[...(n.weapons||[])], armour:[...(n.armour||[])],
    gear:[...(n.gear||[])], gearText:n.gearText||'',
    abName:n.abName||'', abSkill:n.abSkill||'', pp:n.pp||0,
    pace:n.pace||6, parry:n.parry||2, toughness:n.toughness||5, toughnessArmor:n.toughnessArmor||0, bennies:n.bennies||0,
    startingFunds:n.startingFunds||500, gearCost:n.gearCost||0,
    quote:n.quote||'', description:n.description||'', background:n.background||'',
    motivation:n.motivation||'', secret:n.secret||'', services:n.services||'',
    adventureHook:n.adventureHook||'', tactics:n.tactics||'', notes:n.notes||''
  };
}

function canonFilePath(n){
  const region=(n.region||'ammaria').toLowerCase();
  const cat=(n.category||'NPC').toLowerCase();
  if(cat==='pregen'||cat==='pre-gen') return `${region}/${region}-pregens.json`;
  return `${region}/${region}-npcs.json`;
}

async function doCommitFromAudit(){
  if(!currentNPC)return;
  const inCanon=canonCommitted.has(currentNPC.name);
  const dirty=isCharDirty(currentNPC.name);
  if(inCanon&&!dirty)return;
  const btn=document.getElementById('auditCommitBtn');
  const fb=document.getElementById('commitFeedback');
  if(btn){btn.disabled=true;btn.textContent='\u23f3 Committing...';}
  if(fb)fb.innerHTML='<span style="color:var(--accent)">Saving to canon...</span>';
  try{
    await flushSave();
    const canon=buildCanonCharacter(currentNPC);
    const changeId='CV-'+(++_canonSeq).toString().padStart(4,'0');
    const prevSnap=_canonSnapshots[currentNPC.name]?.snapshot;
    const diff={};
    if(prevSnap){['attrs','skills','edges','hindrances','powers','weapons','armour','pace','parry','toughness'].forEach(k=>{if(JSON.stringify(prevSnap[k])!==JSON.stringify(canon[k]))diff[k]=true;});}else{diff.added=true;}
    _canonSnapshots[currentNPC.name]={snapshot:canon,committedAt:new Date().toISOString(),changeId:changeId};
    _canonLog.push({id:changeId,action:inCanon?'update':'commit',target:currentNPC.name,region:currentNPC.region||'Ammaria',timestamp:new Date().toISOString(),summary:(inCanon?'Updated ':'Committed ')+currentNPC.name,diff:diff});
    canonCommitted.add(currentNPC.name);
    captureBaseline(currentNPC.name);
    _lastCommitResult={changeId:changeId,name:currentNPC.name,ok:true};
    await pushToGist();
    // Full immediate refresh â€” header, sidebar, audit, bottom bar all update
    filterNPCs();updateHeaderStats();renderDetail();
  }catch(err){
    _lastCommitResult={name:currentNPC.name,ok:false,error:err.message};
    if(fb)fb.innerHTML='<span style="color:var(--red)">\u274c Failed: '+esc(err.message)+'</span>';
    if(btn){btn.disabled=false;btn.textContent=inCanon?'\ud83d\udd04 Update Canon':'\ud83d\udce6 Commit to Canon';}
  }
}
var _lastCommitResult=null;
async function flushSave(){if(saveTimer){clearTimeout(saveTimer);saveTimer=null;await pushToGist();}}
// â”€â”€ REMOVE FROM CANON â”€â”€
async function removeFromCanon(){
  if(!currentNPC||!canonCommitted.has(currentNPC.name))return;
  if(!confirm(`Remove ${currentNPC.name} from canon?\n\nThis will clear the canonical snapshot and log the removal.`))return;
  const summary=prompt('Removal reason:','Character removed from canon');
  if(!summary)return;
  try{
    const changeId='CV-'+(++_canonSeq).toString().padStart(4,'0');
    _canonLog.push({id:changeId,action:'remove',target:currentNPC.name,region:currentNPC.region||'Ammaria',timestamp:new Date().toISOString(),summary:summary});
    delete _canonSnapshots[currentNPC.name];
    canonCommitted.delete(currentNPC.name);
    await pushToGist();
    filterNPCs();updateHeaderStats();renderDetail();
    alert(`${currentNPC.name} removed from canon (${changeId})`);
  }catch(err){
    alert('Save failed: '+err.message);
  }
}

// â”€â”€ CHANGELOG VIEW â”€â”€
function showChangelog(){
  hideBottomBar();currentNPC=null;activePanel=null;navPush({type:'changelog'});updateBreadcrumb();
  const el=document.getElementById('mainContent');el.classList.remove('empty-state');el.style.overflowY='auto';
  el.innerHTML='<h2 style="color:var(--accent);margin-bottom:14px">ğŸ“‹ Canon Changelog</h2><div id="changelogContent" style="font-size:13px">Loading...</div>';
  loadChangelog();filterNPCs();
}
function closeChangelogModal(){}

async function loadChangelog(){
  const el=document.getElementById('changelogContent');
  const log=_canonLog;
  if(!log.length){el.innerHTML='<div style="color:var(--text-dim);padding:20px;text-align:center">No changes recorded yet. Commit a character to start the audit trail.</div>';return;}
  let html=`<div style="margin-bottom:10px;color:var(--text-dim);font-size:12px">${log.length} change${log.length===1?'':'s'} recorded</div>`;
  html+='<table class="data-table" style="font-size:13px"><tr><th>ID</th><th>Date</th><th>Action</th><th>Character</th><th>Region</th><th>Summary</th><th>Fields Changed</th></tr>';
  log.slice().reverse().forEach(entry=>{
    const date=new Date(entry.timestamp).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
    const time=new Date(entry.timestamp).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    const actionIcon=entry.action==='commit'?'ğŸ”’':entry.action==='update'?'ğŸ”„':'ğŸ—‘ï¸';
    const diffKeys=Object.keys(entry.diff||{}).filter(k=>k!=='added');
    const diffSummary=entry.diff?.added?'<em>New</em>':diffKeys.join(', ')||'â€”';
    html+=`<tr>
      <td style="color:var(--accent);white-space:nowrap;font-weight:bold">${esc(entry.id)}</td>
      <td style="white-space:nowrap">${date}<br><span style="color:var(--text-dim);font-size:11px">${time}</span></td>
      <td>${actionIcon} ${esc(entry.action)}</td>
      <td style="cursor:pointer;color:var(--accent)" onclick="selectNPC('${esc(entry.target).replace(/'/g,"\\\\'")}')">${esc(entry.target)}</td>
      <td>${esc(entry.region)}</td>
      <td>${esc(entry.summary)}</td>
      <td style="font-size:11px">${diffSummary}</td>
    </tr>`;
  });
  html+='</table>';
  el.innerHTML=html;
}

function checkPin(){
  var pin=document.getElementById('pinInput').value;
  if(pin==='54546-44-56456-7567-2345'){
    localStorage.setItem('diceforge_npcdb_auth',pin);
    DICEFORGE_AUTH=true;
    unlockApp();
  } else {
    document.getElementById('pinError').textContent='Invalid PIN';
    document.getElementById('pinInput').value='';
    document.getElementById('pinInput').focus();
  }
}

// Skip PIN and load with local data only
function skipPinAndLoadLocal(){
  DICEFORGE_AUTH=false; // No Gist access
  localStorage.removeItem('diceforge_npcdb_auth'); // Clear any stored auth
  // Clear Gist credentials to force local-only mode
  window.GIST_ID = null;
  window.GIST_TOKEN = null;
  unlockApp(); // Load the app with local data
}

/* â•â•â• REVIEW PANEL â€” batch review/approve/reject dirty characters â•â•â• */
function showReviewPanel(){
  hideBottomBar();currentNPC=null;activePanel=null;navPush({type:'review'});updateBreadcrumb();
  const el=document.getElementById('mainContent');
  el.classList.remove('empty-state');el.style.overflowY='auto';
  el.innerHTML='<div id="reviewInline" style="padding:0"><h2 style="color:var(--accent);margin-bottom:14px">âœï¸ Review Pending Changes</h2><div id="reviewContent" style="font-size:13px">Loading...</div><div id="reviewActions" style="margin-top:14px;display:flex;gap:8px"></div></div>';
  renderReviewContent();
  filterNPCs();
}
function closeReviewModal(){
  if(currentNPC){renderDetail();}
  else{const el=document.getElementById('mainContent');el.innerHTML='Select an NPC or create a new one';el.classList.add('empty-state');}
}

function renderReviewContent(){
  const dirty=getAllDirty();
  const el=document.getElementById('reviewContent');
  const actions=document.getElementById('reviewActions');
  if(!dirty.length){
    el.innerHTML='<div style="text-align:center;color:var(--text-dim);padding:20px">No pending changes. All characters match their baselines.</div>';
    actions.innerHTML='';
    return;
  }
  // Sort: published first (red), then committed (amber), then drafts (blue)
  const order={published:0,committed:1,draft:2};
  dirty.sort((a,b)=>(order[getLifecycle(a.name)]||2)-(order[getLifecycle(b.name)]||2));
  let html=`<div style="margin-bottom:10px;color:var(--text-dim)">${dirty.length} character${dirty.length===1?'':'s'} with pending changes:</div>`;
  dirty.forEach(n=>{
    const lc=getLifecycle(n.name);
    const diff=getCharDiff(n.name);
    const pubProducts=getPublishedProducts(n.name);
    const pubWarning=pubProducts.length?`<div class="lock-warning" style="margin-bottom:6px">âš  Published in: ${pubProducts.map(p=>p.title+' ('+p.code+')').join(', ')}. Changes to this character require an errata justification.</div>`:'';
    const diffHtml=diff.map(d=>`<div class="${d.type}">${d.type==='added'?'+ ':d.type==='removed'?'âˆ’ ':'~ '}${esc(d.text)}</div>`).join('');
    html+=`<div class="review-card ${lc}" id="rc-${esc(n.name).replace(/\s/g,'_')}">
      ${pubWarning}
      <div class="rc-header">
        <div><span class="rc-name" style="cursor:pointer" onclick="selectNPC('${esc(n.name).replace(/'/g,"\\'")}')">${esc(n.name)}</span> <span style="font-size:11px;color:var(--text-dim)">${esc(n.refCode||'')} Â· ${esc(n.category||'NPC')} Â· ${esc(n.tier)}</span></div>
        <span style="font-size:11px;text-transform:uppercase;color:${lc==='published'?'#ee6666':lc==='committed'?'#e8b84e':'#88bbee'}">${lc}</span>
      </div>
      <div class="rc-diff">${diffHtml||'<span style="color:var(--text-dim)">No details available</span>'}</div>
      <div class="rc-actions">
        ${pubProducts.length?`<input id="override-reason-${esc(n.name).replace(/\s/g,'_')}" placeholder="Errata reason (required for published characters)" style="flex:1;background:var(--bg-input);border:1px solid #cc3333;color:var(--text);padding:4px 8px;border-radius:3px;font-size:12px">`:''} 
        <button class="btn sm" style="color:var(--green);border-color:var(--green)" onclick="reviewApprove('${esc(n.name).replace(/'/g,"\\'")}')">âœ“ Approve</button>
        ${lc!=='draft'?`<button class="btn sm" style="color:var(--accent);border-color:var(--accent)" onclick="reviewApproveAndCommit('${esc(n.name).replace(/'/g,"\\'")}')">âœ“ Approve &amp; Commit</button>`:''}
        <button class="btn sm" style="color:var(--red);border-color:var(--red)" onclick="reviewRevert('${esc(n.name).replace(/'/g,"\\'")}')">â†¶ Revert</button>
      </div>
    </div>`;
  });
  el.innerHTML=html;
  actions.innerHTML=`<button class="btn primary" onclick="reviewApproveAll()">âœ“ Approve All</button><button class="btn" onclick="closeReviewModal()">Close</button><span style="flex:1"></span><span style="font-size:11px;color:var(--text-dim)">${dirty.length} pending</span>`;
}

function reviewApprove(name){
  const lc=getLifecycle(name);
  if(lc==='published'){
    const reasonEl=document.getElementById('override-reason-'+name.replace(/\s/g,'_'));
    const reason=reasonEl?reasonEl.value.trim():'';
    if(!reason){alert('An errata reason is required for published characters.');if(reasonEl)reasonEl.focus();return;}
    logOverride(name,reason);
  }
  approveCharacter(name);
  renderReviewContent();
}
function reviewRevert(name){
  const lc=getLifecycle(name);
  const msg=lc==='published'
    ?`Revert ${name} to its last approved state?\n\nThis character is published â€” all changes since last approval will be lost.`
    :`Revert ${name} to its last approved state?\n\nAll changes since last approval will be lost.`;
  if(!confirm(msg))return;
  revertCharacter(name);
  renderReviewContent();
}
function reviewApproveAll(){
  const dirty=getAllDirty();
  const published=dirty.filter(n=>getLifecycle(n.name)==='published');
  if(published.length){
    alert(`${published.length} published character${published.length===1?'':'s'} require individual review with errata reasons. Approve non-published characters first, then review published ones individually.`);
    dirty.filter(n=>getLifecycle(n.name)!=='published').forEach(n=>approveCharacter(n.name));
  }else{
    if(!confirm(`Approve all ${dirty.length} pending changes?`))return;
    dirty.forEach(n=>approveCharacter(n.name));
  }
  renderReviewContent();
}

async function reviewApproveAndCommit(name){
  const lc=getLifecycle(name);
  if(lc==='published'){
    const reasonEl=document.getElementById('override-reason-'+name.replace(/\s/g,'_'));
    const reason=reasonEl?reasonEl.value.trim():'';
    if(!reason){alert('An errata reason is required for published characters.');if(reasonEl)reasonEl.focus();return;}
    logOverride(name,reason);
  }
  approveCharacter(name);
  const savedNPC=currentNPC;
  currentNPC=allNPCs.find(n=>n.name===name);
  if(!currentNPC){currentNPC=savedNPC;return;}
  try{
    await flushSave();
    const canon=buildCanonCharacter(currentNPC);
    const changeId='CV-'+(++_canonSeq).toString().padStart(4,'0');
    const prevSnap=_canonSnapshots[name]?.snapshot;
    const diff={};
    if(prevSnap){['attrs','skills','edges','hindrances','powers','weapons','armour'].forEach(k=>{if(JSON.stringify(prevSnap[k])!==JSON.stringify(canon[k]))diff[k]=true;});}else{diff.added=true;}
    _canonSnapshots[name]={snapshot:canon,committedAt:new Date().toISOString(),changeId:changeId};
    _canonLog.push({id:changeId,action:prevSnap?'update':'commit',target:name,region:currentNPC.region||'Ammaria',timestamp:new Date().toISOString(),summary:'Approved & committed '+name,diff:diff});
    canonCommitted.add(name);
    captureBaseline(name);
    await pushToGist();
  }catch(e){/* canon commit is best-effort from review panel */}
  currentNPC=savedNPC;
  filterNPCs();updateHeaderStats();renderReviewContent();
}

/* â•â•â• PRODUCT REGISTRY UI â•â•â• */
function showProductsModal(){
  hideBottomBar();currentNPC=null;activePanel=null;navPush({type:'products'});updateBreadcrumb();
  const el=document.getElementById('mainContent');el.classList.remove('empty-state');el.style.overflowY='auto';
  el.innerHTML='<h2 style="color:var(--accent);margin-bottom:14px">ğŸ“¦ Product Registry</h2><div id="productsContent" style="font-size:13px">Loading...</div>';
  renderProductsContent();filterNPCs();
}
function closeProductsModal(){}

function renderProductsContent(){
  const el=document.getElementById('productsContent');
  const products=_productRegistry.products||[];
  let html=`<div style="margin-bottom:12px;display:flex;gap:8px;align-items:center">
    <input id="newProdCode" placeholder="Product code (e.g. AM-W03)" style="padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);border-radius:3px;font-size:12px;width:180px">
    <input id="newProdTitle" placeholder="Product title" style="flex:1;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);border-radius:3px;font-size:12px">
    <button class="btn primary sm" onclick="uiAddProduct()">+ Add Product</button>
  </div>`;
  if(!products.length){
    html+='<div style="text-align:center;color:var(--text-dim);padding:20px">No products registered yet. Add your first product above.</div>';
  }else{
    // Sort: released first, then in-review, then draft
    const sorted=[...products].sort((a,b)=>{const o={released:0,'in-review':1,draft:2};return (o[a.status]||2)-(o[b.status]||2);});
    sorted.forEach(p=>{
      const statusColour=p.status==='released'?'var(--green)':p.status==='in-review'?'#e8b84e':'var(--text-dim)';
      const statusIcon=p.status==='released'?'ğŸ”’':p.status==='in-review'?'â³':'ğŸ“';
      const chars=(p.characters||[]).map(c=>allNPCs.find(x=>x.name===c)).filter(Boolean);
      const charCount=chars.length;
      const charList=(p.characters||[]).map(c=>{
        const n=allNPCs.find(x=>x.name===c);
        const ref=n&&n.refCode?n.refCode+' ':'';
        const missing=!n;
        return `<span style="display:inline-block;margin:2px 4px 2px 0;padding:1px 6px;background:var(--bg-body);border:1px solid ${missing?'var(--red)':'var(--border)'};border-radius:3px;font-size:11px;${missing?'color:var(--red)':''}">${esc(ref+c)}${missing?' âš ':''} <span onclick="uiRemoveCharFromProduct('${esc(p.code).replace(/'/g,"\\'")}','${esc(c).replace(/'/g,"\\'")}');event.stopPropagation()" style="cursor:pointer;color:var(--red);margin-left:2px">Ã—</span></span>`;
      }).join('');
      // Readiness metrics
      const buildsLegal=chars.filter(n=>{const a=runBuildAudit(n);return a.every(r=>r.pass);}).length;
      const statDone=chars.filter(n=>n.statComplete).length;
      const narrDone=chars.filter(n=>n.narrativeComplete).length;
      const dirtyChars=chars.filter(n=>isCharDirty(n.name)).length;
      const allGreen=charCount>0&&buildsLegal===charCount&&statDone===charCount&&narrDone===charCount&&dirtyChars===0;
      const readinessColour=allGreen?'var(--green)':charCount===0?'var(--text-dim)':'#e8b84e';
      const readinessHtml=charCount>0?`<div style="font-size:11px;margin:6px 0;padding:6px 8px;background:var(--bg-body);border-radius:3px;border-left:3px solid ${readinessColour}">
        <span style="color:${buildsLegal===charCount?'var(--green)':'var(--red)'}">${buildsLegal}/${charCount} builds legal</span> Â· 
        <span style="color:${statDone===charCount?'var(--green)':'#e8b84e'}">${statDone}/${charCount} stats</span> Â· 
        <span style="color:${narrDone===charCount?'var(--green)':'#e8b84e'}">${narrDone}/${charCount} narrative</span> Â· 
        <span style="color:${dirtyChars===0?'var(--green)':'#ee6666'}">${dirtyChars} pending edit${dirtyChars===1?'':'s'}</span>
        ${allGreen?' Â· <strong style="color:var(--green)">âœ“ READY TO SHIP</strong>':''}
      </div>`:'';
      // Release checklist (expandable)
      const checklistId='checklist-'+p.code.replace(/[^a-zA-Z0-9]/g,'_');
      let checklistHtml='';
      if(charCount>0){
        checklistHtml=`<div id="${checklistId}" style="display:none;margin:6px 0;font-size:11px;line-height:1.8">`;
        // Sort: needs attention first (illegal builds, missing completions, dirty edits)
        const sortedChars=[...chars].sort((a,b)=>{
          const scoreN=n=>{let s=0;const au=runBuildAudit(n);if(!au.every(r=>r.pass))s+=4;if(!n.statComplete)s+=2;if(!n.narrativeComplete)s+=2;if(isCharDirty(n.name))s+=1;return s;};
          return scoreN(b)-scoreN(a);
        });
        sortedChars.forEach(n=>{
          const audit=runBuildAudit(n);const legal=audit.every(r=>r.pass);
          const dirty=isCharDirty(n.name);
          const ref=n.refCode?n.refCode+' â€” ':'';
          const needsWork=!legal||!n.statComplete||!n.narrativeComplete||dirty;
          checklistHtml+=`<div style="padding:2px 0;border-bottom:1px solid var(--border);${needsWork?'background:rgba(238,102,102,0.05)':''}">
            <span style="cursor:pointer;color:var(--accent)" onclick="closeProductsModal();selectNPC('${esc(n.name).replace(/'/g,"\\'")}')">${esc(ref+n.name)}</span>
            <span style="margin-left:8px;color:${legal?'var(--green)':'var(--red)'}">${legal?'âœ“':'âœ—'} Build</span>
            <span style="margin-left:6px;color:${n.statComplete?'var(--green)':'var(--text-dim)'}">${n.statComplete?'âœ“':'â€”'} Stats</span>
            <span style="margin-left:6px;color:${n.narrativeComplete?'var(--green)':'var(--text-dim)'}">${n.narrativeComplete?'âœ“':'â€”'} Narr</span>
            <span style="margin-left:6px;color:${dirty?'#ee6666':'var(--green)'}">${dirty?'âœï¸ Edited':'âœ“ Clean'}</span>
          </div>`;
        });
        checklistHtml+=`</div>`;
      }
      const statusBtns=p.status==='draft'
        ?`<button class="btn sm" onclick="uiSetProductStatus('${esc(p.code)}','in-review')" style="color:#e8b84e;border-color:#e8b84e">â†’ In Review</button><button class="btn sm danger" onclick="uiRemoveProduct('${esc(p.code)}')">Delete</button>`
        :p.status==='in-review'
        ?`<button class="btn sm" onclick="uiSetProductStatus('${esc(p.code)}','released')" style="color:var(--green);border-color:var(--green)">ğŸ”’ Release</button><button class="btn sm" onclick="uiSetProductStatus('${esc(p.code)}','draft')">â† Draft</button>`
        :`<span style="font-size:11px;color:var(--text-dim)">Released ${p.releasedAt?new Date(p.releasedAt).toLocaleDateString():''}</span>`;
      html+=`<div class="product-card ${p.status}">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div><strong style="color:var(--accent);font-family:monospace">${esc(p.code)}</strong> â€” ${esc(p.title)} <span style="font-size:11px;color:${statusColour}">${statusIcon} ${p.status.toUpperCase()}</span> <span style="font-size:11px;color:var(--text-dim)">(${charCount} character${charCount===1?'':'s'})</span></div>
          <div style="display:flex;gap:4px">${statusBtns}</div>
        </div>
        ${readinessHtml}
        <div style="margin-bottom:6px">${charList||'<span style="color:var(--text-dim);font-size:12px">No characters assigned</span>'}</div>
        ${checklistHtml}
        <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap">
          <select id="addChar-${esc(p.code)}" style="flex:1;padding:4px 8px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);border-radius:3px;font-size:12px;min-width:200px">
            <option value="">Add character...</option>
            ${allNPCs.filter(n=>!(p.characters||[]).includes(n.name)).sort((a,b)=>(a.refCode||'').localeCompare(b.refCode||'')).map(n=>`<option value="${esc(n.name)}">${n.refCode?esc(n.refCode)+' â€” ':''}${esc(n.name)}</option>`).join('')}
          </select>
          <button class="btn sm" onclick="uiAddCharToProduct('${esc(p.code)}')">+ Add</button>
          ${charCount>0?`<button class="btn sm" onclick="toggleChecklist('${checklistId}')" style="color:var(--accent);border-color:var(--accent)">ğŸ“‹ Checklist</button>`:''}
          ${charCount>0?`<button class="btn sm" onclick="exportProductStatBlocks('${esc(p.code).replace(/'/g,"\\'")}')" style="color:var(--accent);border-color:var(--accent)">ğŸ“„ Export Stat Blocks</button>`:''}
        </div>
      </div>`;
    });
  }
  el.innerHTML=html;
}

function uiAddProduct(){
  const code=document.getElementById('newProdCode').value.trim();
  const title=document.getElementById('newProdTitle').value.trim();
  if(!code||!title){alert('Both product code and title are required.');return;}
  if(!addProduct(code,title)){alert('A product with that code already exists.');return;}
  renderProductsContent();
}
function uiRemoveProduct(code){
  if(!confirm(`Delete product ${code}? This cannot be undone.`))return;
  removeProduct(code);renderProductsContent();
}
function uiSetProductStatus(code,status){
  if(status==='released'){
    const p=_productRegistry.products.find(x=>x.code===code);
    const charCount=(p?.characters||[]).length;
    if(!confirm(`Release ${code} â€” "${p?.title}"?\n\n${charCount} character${charCount===1?'':'s'} will be locked. Changes after release will require errata override with justification.\n\nThis action sets the release date and cannot be easily undone.`))return;
  }
  setProductStatus(code,status);
  renderProductsContent();filterNPCs();updateHeaderStats();
}
function uiAddCharToProduct(code){
  const sel=document.getElementById('addChar-'+code);
  if(!sel||!sel.value)return;
  addCharToProduct(code,sel.value);
  renderProductsContent();filterNPCs();
}
function uiRemoveCharFromProduct(code,name){
  const p=_productRegistry.products.find(x=>x.code===code);
  if(p&&p.status==='released'){alert('Cannot remove characters from a released product.');return;}
  removeCharFromProduct(code,name);
  renderProductsContent();filterNPCs();
}

function toggleChecklist(id){
  const el=document.getElementById(id);
  if(!el)return;
  el.style.display=el.style.display==='none'?'block':'none';
}

function buildStatBlockHTML(n){
  const d=v=>v?'d'+v:'â€”';
  const tDisp=n.toughnessArmor>0?n.toughness+' ('+n.toughnessArmor+')':''+n.toughness;
  let html=`<div style="border:1px solid #666;border-radius:4px;padding:12px;margin-bottom:16px;font-family:Georgia,serif;font-size:13px;max-width:600px">`;
  html+=`<div style="font-size:16px;font-weight:bold;border-bottom:2px solid #333;padding-bottom:4px;margin-bottom:8px">${esc(n.name)}${n.concept?' <span style="font-weight:normal;font-style:italic;font-size:13px">â€” '+esc(n.concept)+'</span>':''}</div>`;
  if(n.quote) html+=`<div style="font-style:italic;color:#666;margin-bottom:6px">"${esc(n.quote)}"</div>`;
  if(n.description) html+=`<div style="margin-bottom:8px">${esc(n.description)}</div>`;
  html+=`<div style="margin-bottom:4px"><strong>Attributes:</strong> Agility ${d(n.agility)}, Smarts ${d(n.smarts)}, Spirit ${d(n.spirit)}, Strength ${d(n.strength)}, Vigor ${d(n.vigor)}</div>`;
  if(Object.keys(n.skills||{}).length) html+=`<div style="margin-bottom:4px"><strong>Skills:</strong> ${Object.entries(n.skills).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>k+' '+d(v)).join(', ')}</div>`;
  html+=`<div style="margin-bottom:4px"><strong>Pace:</strong> ${n.pace}; <strong>Parry:</strong> ${n.parry}; <strong>Toughness:</strong> ${tDisp}</div>`;
  if(n.edges&&n.edges.length) html+=`<div style="margin-bottom:4px"><strong>Edges:</strong> ${n.edges.map(e=>esc(e)).join(', ')}</div>`;
  if(n.hindrances&&n.hindrances.length) html+=`<div style="margin-bottom:4px"><strong>Hindrances:</strong> ${n.hindrances.map(h=>esc(h)).join(', ')}</div>`;
  if(n.powers&&n.powers.length) html+=`<div style="margin-bottom:4px"><strong>Powers:</strong> ${n.powers.map(p=>esc(p)).join(', ')}${n.pp?' ('+n.pp+' Power Points)':''}</div>`;
  if(n.weapons&&n.weapons.length) html+=`<div style="margin-bottom:4px"><strong>Weapons:</strong> ${n.weapons.map(w=>esc(w.name)+' ('+esc(w.damage||'')+(w.ap?', AP '+w.ap:'')+(w.range?', '+esc(w.range):'')+')').join(', ')}</div>`;
  if(n.armour&&n.armour.length) html+=`<div style="margin-bottom:4px"><strong>Armour:</strong> ${n.armour.map(a=>esc(a.name)+' (+'+a.armor+')').join(', ')}</div>`;
  if(n.gearText) html+=`<div style="margin-bottom:4px"><strong>Gear:</strong> ${esc(n.gearText)}</div>`;
  if(n.abName) html+=`<div style="margin-bottom:4px"><strong>Arcane Background:</strong> ${esc(n.abName)}${n.abSkill?' ('+esc(n.abSkill)+')':''}</div>`;
  html+=`</div>`;
  return html;
}

function exportProductStatBlocks(code){
  const p=_productRegistry.products.find(x=>x.code===code);
  if(!p)return;
  const chars=(p.characters||[]).map(c=>allNPCs.find(x=>x.name===c)).filter(Boolean);
  if(!chars.length){alert('No characters assigned to this product.');return;}
  // Build both formats
  const separator='\n'+('â•'.repeat(60))+'\n\n';
  const headerTxt=`STAT BLOCKS â€” ${p.code}: ${p.title}\nGenerated: ${new Date().toLocaleDateString()}\nCharacters: ${chars.length}\n`;
  const textBlocks=headerTxt+'\n'+separator+chars.map(n=>buildStatBlockText(n)).join(separator);
  const htmlBlocks=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Stat Blocks â€” ${esc(p.code)}: ${esc(p.title)}</title><style>body{font-family:Georgia,serif;max-width:700px;margin:20px auto;color:#222;background:#fff}h1{font-size:20px;border-bottom:2px solid #333;padding-bottom:6px}p.meta{font-size:12px;color:#888}</style>  <script src="tool-navigation.js"></script>
</head><body><h1>${esc(p.code)}: ${esc(p.title)}</h1><p class="meta">Generated: ${new Date().toLocaleDateString()} Â· ${chars.length} character${chars.length===1?'':'s'}</p>${chars.map(n=>buildStatBlockHTML(n)).join('')}</body></html>`;
  // State
  let currentFmt='text';
  const modal=document.createElement('div');
  modal.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:200;display:flex;align-items:center;justify-content:center';
  modal.innerHTML=`<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:16px;width:800px;max-height:85vh;display:flex;flex-direction:column">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 style="margin:0;color:var(--accent)">ğŸ“„ Stat Blocks â€” ${esc(p.code)}: ${esc(p.title)}</h3>
      <button class="btn" onclick="this.closest('div[style*=fixed]').remove()">âœ• Close</button>
    </div>
    <div style="display:flex;gap:4px;margin-bottom:8px">
      <button class="btn sm" id="expFmtTxt" style="border-color:var(--accent);color:var(--accent)" onclick="setExpFmt('text')">Plain Text</button>
      <button class="btn sm" id="expFmtHtml" onclick="setExpFmt('html')">HTML</button>
      <span style="flex:1"></span>
      <span id="expMeta" style="font-size:11px;color:var(--text-dim);align-self:center">${chars.length} characters Â· ${textBlocks.length.toLocaleString()} chars</span>
    </div>
    <div id="expPreviewArea" style="flex:1;min-height:300px;overflow:auto;border:1px solid var(--border);border-radius:4px;background:var(--bg-body)">
      <textarea id="expTextArea" readonly style="width:100%;height:100%;box-sizing:border-box;font-family:monospace;font-size:11px;background:transparent;color:var(--text);border:none;padding:8px;resize:none">${esc(textBlocks)}</textarea>
      <div id="expHtmlArea" style="display:none;padding:8px"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn primary" id="copyStatBlocksBtn">ğŸ“‹ Copy</button>
      <button class="btn" id="downloadStatBlocksBtn">ğŸ’¾ Download</button>
    </div>
  </div>`;
  document.body.appendChild(modal);
  // HTML preview
  const htmlArea=modal.querySelector('#expHtmlArea');
  const iframe=document.createElement('iframe');
  iframe.style.cssText='width:100%;border:none;min-height:400px';
  htmlArea.appendChild(iframe);
  iframe.srcdoc=htmlBlocks;
  function setExpFmt(fmt){
    currentFmt=fmt;
    modal.querySelector('#expFmtTxt').style.cssText=fmt==='text'?'border-color:var(--accent);color:var(--accent)':'';
    modal.querySelector('#expFmtHtml').style.cssText=fmt==='html'?'border-color:var(--accent);color:var(--accent)':'';
    modal.querySelector('#expTextArea').style.display=fmt==='text'?'':'none';
    modal.querySelector('#expHtmlArea').style.display=fmt==='html'?'':'none';
    const len=fmt==='text'?textBlocks.length:htmlBlocks.length;
    modal.querySelector('#expMeta').textContent=chars.length+' characters Â· '+len.toLocaleString()+' chars';
  }
  window.setExpFmt=setExpFmt;
  modal.querySelector('#copyStatBlocksBtn').onclick=()=>{
    const content=currentFmt==='text'?textBlocks:htmlBlocks;
    navigator.clipboard.writeText(content).then(()=>{modal.querySelector('#copyStatBlocksBtn').textContent='âœ… Copied!';setTimeout(()=>{modal.querySelector('#copyStatBlocksBtn').textContent='ğŸ“‹ Copy';},1500);});
  };
  modal.querySelector('#downloadStatBlocksBtn').onclick=()=>{
    const content=currentFmt==='text'?textBlocks:htmlBlocks;
    const ext=currentFmt==='text'?'.txt':'.html';
    const mime=currentFmt==='text'?'text/plain':'text/html';
    const blob=new Blob([content],{type:mime});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download=p.code.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-stat-blocks'+ext;
    a.click();URL.revokeObjectURL(a.href);
  };
  modal.addEventListener('click',(e)=>{if(e.target===modal)modal.remove();});
}

/* â”€â”€ Published character edit gate â”€â”€ */
function checkEditLock(name){
  if(!isLocked(name))return true;
  const products=getPublishedProducts(name);
  const prodList=products.map(p=>p.code+' â€” '+p.title).join('\n');
  return confirm(`âš  ${name} is published in:\n\n${prodList}\n\nEditing a published character creates an errata situation. All changes will be flagged for review.\n\nProceed?`);
}

async function loadCanonStatus(){
  // Canon state now loaded from gist in loadData() â€” this is a no-op retained for compatibility
  filterNPCs();updateHeaderStats();
  if(currentNPC)renderDetail();
}

async function unlockApp(){
  document.getElementById('mainContent').innerHTML='<span style="color:var(--text-dim)">Loading characters...</span>';
  document.getElementById('mainContent').classList.add('empty-state');
  document.getElementById('sidebarInner').style.display='';
  await loadData();captureBaselines();filterNPCs();updateHeaderStats();loadCanonStatus();loadProductRegistry();
  document.getElementById('mainContent').innerHTML='<span style="color:var(--text-dim)">Select an NPC or create a new one</span>';
}

window.addEventListener('beforeunload',(e)=>{if(saveTimer){clearTimeout(saveTimer);saveTimer=null;pushToGist();e.returnValue='Save in progress...';}});
document.addEventListener('DOMContentLoaded',()=>{
  addToolNavigation('character-vault');
  document.getElementById('sidebarInner').style.display=DICEFORGE_AUTH?'':'none';
  if(DICEFORGE_AUTH){
    const check=setInterval(()=>{if(window.CharacterForge){clearInterval(check);unlockApp();}},50);
  } else {
    document.getElementById('pinInput').focus();
  }
});
  // â•â•â• VAULT INTEGRATION â•â•â•
(function initVaultIntegration() {
  // Add navigation buttons to header
  const headerButtons = document.getElementById('headerButtons');
  if (headerButtons && window.VaultIntegration) {
    headerButtons.appendChild(VaultIntegration.createVaultNavigationButton('adventure'));
    headerButtons.appendChild(VaultIntegration.createHelpButton('character'));
  }
  
  // Sync NPCs to storage whenever they change
  function syncToStorage() {
    if (window.VaultIntegration && allNPCs) {
      VaultIntegration.syncNPCsToStorage(allNPCs);
    }
  }
  
  // Sync on init and periodically
  setTimeout(syncToStorage, 1000);
  setInterval(syncToStorage, 5000);
  
  // Check for URL parameter to auto-select character
  const charParam = window.VaultIntegration.getURLParam('char');
  if (charParam) {
    setTimeout(() => {
      const npc = allNPCs.find(n => n.name === charParam);
      if (npc) selectNPC(charParam);
    }, 500);
  }
  
  // Add adventure appearances to character detail
  const originalRenderDetail = window.renderDetail;
  if (originalRenderDetail) {
    window.renderDetail = function() {
      originalRenderDetail();
      
      if (window.VaultIntegration && currentNPC) {
        const adventures = VaultIntegration.getAdventuresForNPC(currentNPC.name);
        
        if (adventures.length > 0) {
          const narrativeCol = document.querySelector('.col-narrative');
          if (narrativeCol) {
            const advSection = document.createElement('div');
            advSection.className = 'section-box';
            advSection.innerHTML = `
              <h3>ADVENTURE APPEARANCES</h3>
              <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;">
                ${adventures.map(adv => `
                  <span class="week-link" data-week="${adv.week}" style="display:inline-block;padding:4px 10px;background:rgba(196,154,74,0.2);border:1px solid rgba(196,154,74,0.5);border-radius:3px;font-size:11px;color:var(--accent);cursor:pointer;">
                    Week ${adv.week}: ${adv.title}
                  </span>
                `).join('')}
              </div>
            `;
            
            const firstSection = narrativeCol.querySelector('.section-box');
            if (firstSection) {
              firstSection.parentNode.insertBefore(advSection, firstSection.nextSibling);
            } else {
              narrativeCol.insertBefore(advSection, narrativeCol.firstChild);
            }
            
            advSection.querySelectorAll('.week-link').forEach(link => {
              const week = parseInt(link.dataset.week);
              VaultIntegration.makeWeekLinkClickable(link, week);
            });
          }
        }
      }
    };
  }
})();
</script>
</body>
</html>
