<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tribute Lands ‚Äî Character Vault</title>
<style>
:root {
  --bg-dark: #1a1a1a;
  --bg-card: #242424;
  --bg-input: #2e2e2e;
  --bg-hover: #333;
  --border: #444;
  --text: #d4d0c8;
  --text-dim: #888;
  --text-bright: #f0ece0;
  --accent: #c49a4a;
  --accent-dim: #8a6d33;
  --red: #a44;
  --green: #5a5;
  --blue: #4a7a9a;
  --tag-wc: #c49a4a;
  --tag-extra: #5a8a5a;
  --tag-walkon: #7a7a8a;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
body { font-family: 'Segoe UI', Tahoma, Geneva, sans-serif; background: var(--bg-dark); color: var(--text); line-height: 1.5; margin: 0; padding: 0; overflow: hidden; height: 100%; display: flex; flex-direction: column; }
header { background: linear-gradient(135deg, #1a1a1a 0%, #2a2218 100%); border-bottom: 2px solid var(--accent-dim); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
header h1 { font-size: 18px; color: var(--accent); font-weight: 600; letter-spacing: 1px; }
header .subtitle { font-size: 11px; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; }
.header-stats { display: flex; gap: 16px; font-size: 13px; color: var(--text-dim); }
.header-stats > span:hover { color: var(--accent); }
.header-stats .stat-num { color: var(--accent); font-weight: 600; }
#breadcrumb { background: var(--bg-dark); border-bottom: 1px solid var(--border); padding: 4px 24px 4px 324px; font-size: 11px; color: var(--text-dim); flex-shrink: 0; display: flex; align-items: center; gap: 6px; min-height: 22px; }
#breadcrumb .bc-sep { color: var(--border); margin: 0 2px; }
#breadcrumb .bc-link { color: var(--text-dim); cursor: pointer; text-decoration: none; }
#breadcrumb .bc-link:hover { color: var(--accent); }
#breadcrumb .bc-current { color: var(--accent); font-weight: 600; }
#kbOverlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.75); z-index: 300; align-items: center; justify-content: center; }
#kbOverlay.active { display: flex; }
#kbOverlay .kb-panel { background: var(--bg-card); border: 1px solid var(--accent-dim); border-radius: 8px; padding: 24px 32px; max-width: 560px; width: 90%; max-height: 80vh; overflow-y: auto; }
#kbOverlay .kb-title { font-size: 18px; color: var(--accent); font-weight: 600; margin-bottom: 16px; }
#kbOverlay .kb-section { margin-bottom: 14px; }
#kbOverlay .kb-section h4 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 6px; }
#kbOverlay .kb-row { display: flex; justify-content: space-between; padding: 3px 0; font-size: 13px; }
#kbOverlay .kb-key { font-family: monospace; background: var(--bg-body); border: 1px solid var(--border); border-radius: 3px; padding: 1px 8px; font-size: 12px; color: var(--accent); }
.container { display: flex; flex: 1; min-height: 0; }
.sidebar { width: 300px; min-width: 300px; background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
#sidebarInner { display: flex; flex-direction: column; flex: 1 1 0; min-height: 0; overflow: hidden; }
.sidebar-controls { padding: 10px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px; flex-shrink: 0; }
.filter-row { display: flex; gap: 6px; }
.sidebar-controls input, .sidebar-controls select { background: var(--bg-input); border: 1px solid var(--border); color: var(--text); padding: 6px 8px; border-radius: 3px; font-size: 13px; }
.sidebar-controls input { flex: 1; }
.sidebar-controls select { min-width: 100px; }
.npc-list { flex: 1 1 0; min-height: 0; overflow-y: scroll; padding: 4px; scrollbar-width: auto; scrollbar-color: var(--accent-dim) var(--bg-dark); }
.npc-list::-webkit-scrollbar { width: 10px; }
.npc-list::-webkit-scrollbar-track { background: var(--bg-dark); }
.npc-list::-webkit-scrollbar-thumb { background: var(--accent-dim); border-radius: 5px; border: 2px solid var(--bg-dark); }
.npc-list::-webkit-scrollbar-thumb:hover { background: var(--accent); }
.npc-item { padding: 8px 10px; border-radius: 4px; cursor: pointer; border: 1px solid transparent; margin-bottom: 2px; }
.npc-item:hover { background: var(--bg-hover); }
.npc-item.active { background: var(--bg-hover); border-color: var(--accent-dim); }
.npc-item.dirty-draft { border-left: 3px solid #5588cc; }
.npc-item.dirty-committed { background: rgba(200,150,30,0.08); border-left: 3px solid #c8961e; }
.npc-item.dirty-published { background: rgba(200,50,50,0.1); border-left: 3px solid #cc3333; }
.npc-item .dirty-badge { font-size: 9px; padding: 1px 5px; border-radius: 3px; margin-left: 4px; font-weight: 600; letter-spacing: 0.5px; vertical-align: middle; }
.npc-item .dirty-badge.draft { background: #5588cc33; color: #88bbee; }
.npc-item .dirty-badge.committed { background: #c8961e33; color: #e8b84e; }
.npc-item .dirty-badge.published { background: #cc333333; color: #ee6666; }
.review-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 10px; margin-bottom: 8px; }
.review-card.published { border-color: #cc3333; }
.review-card.committed { border-color: #c8961e; }
.review-card .rc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.review-card .rc-name { font-weight: bold; color: var(--text-bright); }
.review-card .rc-diff { font-size: 12px; color: var(--text-dim); line-height: 1.6; }
.review-card .rc-diff .added { color: var(--green); }
.review-card .rc-diff .removed { color: var(--red); }
.review-card .rc-diff .changed { color: var(--accent); }
.review-card .rc-actions { margin-top: 6px; display: flex; gap: 6px; }
.product-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 10px; margin-bottom: 8px; }
.product-card.released { border-color: var(--green); }
.product-card.in-review { border-color: #c8961e; }
.lock-warning { background: rgba(200,50,50,0.1); border: 1px solid #cc3333; border-radius: 4px; padding: 8px 10px; margin-bottom: 8px; font-size: 12px; color: #ee6666; }
.npc-item .npc-name { font-size: 14px; font-weight: 600; color: var(--text-bright); }
.npc-item .npc-meta { font-size: 12px; color: var(--text-dim); margin-top: 1px; }
.tier-tag { display: inline-block; padding: 0 6px; border-radius: 2px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; vertical-align: middle; margin-left: 4px; }
.tier-tag.wc { background: var(--tag-wc); color: #1a1a1a; }
.tier-tag.extra { background: var(--tag-extra); color: #fff; }
.tier-tag.walkon { background: var(--tag-walkon); color: #fff; }
.tier-tag.pregen { background: #6a5aaa; color: #fff; }
.tier-tag.npc { background: #5a7a9a; color: #fff; }
.list-section-header { padding: 8px 16px 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--accent); border-bottom: 1px solid var(--border); margin-top: 4px; }
.status-dots { display: inline-flex; gap: 3px; margin-left: 6px; vertical-align: middle; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
.status-dot.on { background: var(--green); }
.status-dot.off { background: var(--border); }
.sidebar-footer { padding: 8px 10px; border-top: 1px solid var(--border); display: flex; gap: 4px; flex-shrink: 0; flex-wrap: wrap; }
.main { flex: 1; overflow: hidden; padding: 20px 28px 52px 28px; display: flex; flex-direction: column; }
.main.empty-state { display: flex; align-items: center; justify-content: center; color: var(--text-dim); font-size: 15px; }
.npc-header { margin-bottom: 16px; flex-shrink: 0; }
.npc-header h2 { font-size: 24px; color: var(--text-bright); font-weight: 600; }
.npc-header .npc-title-line { font-size: 15px; color: var(--accent); margin-top: 2px; }
.detail-columns { display: flex; gap: 16px; flex: 1; min-height: 0; }
.col-stats { width: 400px; min-width: 400px; flex-shrink: 0; display: flex; flex-direction: column; }
.col-stats-scroll { flex: 1; overflow-y: auto; }
.col-stats-footer { flex-shrink: 0; border-top: 1px solid var(--border); background: var(--bg-card); padding-bottom: 4px; }
#charBottomBar { position: fixed; bottom: 0; left: 300px; right: 0; z-index: 50; background: var(--bg-card); border-top: 1px solid var(--border); padding: 6px 20px; display: none; }
#charBottomBar .status-bar { display: flex; align-items: center; gap: 0; }
#charBottomBar .status-row { display: flex; align-items: center; gap: 14px; font-size: 13px; }
#charBottomBar .action-btns { display: flex; gap: 4px; margin-left: 20px; padding-left: 20px; border-left: 1px solid var(--border); }
#charBottomBar .commit-area { margin-left: auto; padding-left: 20px; border-left: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
.col-middle { min-width: 380px; flex: 1; overflow-y: auto; }
.col-narrative { width: 360px; min-width: 300px; flex-shrink: 0; overflow-y: auto; }
.stat-block-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 14px 16px; font-size: 13px; }
.stat-block-panel .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.stat-block-panel .tier-label { font-size: 13px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
.build-legal-badge { background: var(--green); color: #fff; font-size: 11px; padding: 2px 8px; border-radius: 3px; font-weight: 600; cursor: pointer; }
.build-legal-badge.invalid { background: var(--red); }
.stat-section { margin-bottom: 8px; }
.stat-section-label { font-size: 11px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; cursor: pointer; }
.stat-section-label:hover { text-decoration: underline; }
.stat-section-label .edit-icon { font-size: 10px; color: var(--text-dim); margin-left: 2px; }
.stat-val { color: var(--text-bright); font-size: 13px; line-height: 1.6; }
.derived-row { display: flex; gap: 16px; padding: 8px 0; border-top: 1px solid #2a2a2a; border-bottom: 1px solid #2a2a2a; margin: 8px 0; }
.derived-item { text-align: center; }
.derived-item .derived-num { font-size: 20px; font-weight: 700; color: var(--accent); }
.derived-item .derived-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; }
.section-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 12px 16px; margin-top: 10px; font-size: 13px; }
.section-box-pair { display: flex; gap: 10px; margin-top: 10px; }
.section-box-pair .section-box { flex: 1; }
.section-box h3 { font-size: 12px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; cursor: pointer; font-weight: 600; }
.section-box h3:hover { text-decoration: underline; }
.section-box h3 .edit-icon { font-size: 10px; color: var(--text-dim); margin-left: 2px; }
.section-box .item-entry { padding: 3px 0; border-bottom: 1px solid #2a2a2a; font-size: 13px; }
.section-box .item-entry:last-child { border-bottom: none; }
.section-box .legacy-tag { font-size: 10px; color: var(--text-dim); font-style: italic; }
.section-box .none-text { color: var(--text-dim); font-size: 12px; }
.status-bar { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 10px 16px; margin-top: 10px; }
.status-bar .status-row { display: flex; gap: 16px; margin-bottom: 6px; }
.status-bar label { font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; }
.status-bar input[type="checkbox"] { accent-color: var(--accent); }
.action-btns { display: flex; gap: 6px; flex-wrap: wrap; }
.middle-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 16px 20px; min-height: 200px; }
.middle-panel .panel-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
.middle-panel .panel-title h3 { font-size: 16px; color: var(--text-bright); font-weight: 600; }
.middle-default { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; color: var(--text-dim); }
.middle-default .hint { font-size: 14px; margin-bottom: 12px; }
.middle-default .quick-links { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
.middle-default .quick-links a { color: var(--accent); font-size: 13px; cursor: pointer; text-decoration: none; }
.middle-default .quick-links a:hover { text-decoration: underline; }
.portrait-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; width: 100%; aspect-ratio: 3/4; display: flex; align-items: center; justify-content: center; color: var(--text-dim); font-size: 13px; margin-bottom: 6px; }
.portrait-actions { text-align: right; margin-bottom: 10px; font-size: 12px; }
.portrait-actions a { color: var(--accent); cursor: pointer; text-decoration: none; margin-left: 8px; }
.npc-quote { font-style: italic; color: var(--accent); margin: 12px 0; padding-left: 12px; border-left: 2px solid var(--accent-dim); font-size: 14px; line-height: 1.5; }
.narrative-section { margin-top: 12px; }
.narrative-section h4 { font-size: 13px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; cursor: pointer; font-weight: 600; }
.narrative-section h4:hover { text-decoration: underline; }
.narrative-section h4 .edit-icon { font-size: 10px; color: var(--text-dim); margin-left: 2px; }
.narrative-section p { font-size: 13px; line-height: 1.6; color: var(--text); }
.btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--text); padding: 5px 12px; border-radius: 3px; cursor: pointer; font-size: 13px; font-family: inherit; }
.btn:hover { background: var(--bg-hover); border-color: var(--accent-dim); }
.btn.primary { background: var(--accent-dim); color: var(--text-bright); border-color: var(--accent); }
.btn.primary:hover { background: var(--accent); color: #1a1a1a; }
.btn.danger { border-color: var(--red); }
.btn.danger:hover { background: var(--red); color: #fff; }
.btn.sm { padding: 3px 8px; font-size: 11px; }
.form-group { margin-bottom: 10px; }
.form-group label { display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; }
.form-group input, .form-group select, .form-group textarea { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text); padding: 6px 8px; border-radius: 3px; font-size: 13px; font-family: inherit; }
.form-group textarea { resize: vertical; min-height: 60px; }
.form-row { display: flex; gap: 10px; }
.form-row .form-group { flex: 1; }
.form-actions { margin-top: 14px; display: flex; gap: 8px; justify-content: flex-end; }
.catalogue-section { margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); }
.catalogue-section h4 { font-size: 12px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px; }
.catalogue-list { max-height: 200px; overflow-y: auto; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 3px; margin-bottom: 8px; }
.cat-info { background: var(--bg-dark); border: 1px solid var(--accent); border-radius: 4px; padding: 10px 12px; margin-bottom: 10px; font-size: 12px; line-height: 1.6; }
.cat-info .ci-name { color: var(--accent); font-weight: bold; font-size: 13px; }
.cat-info .ci-meta { color: var(--text-dim); font-size: 11px; margin-bottom: 4px; }
.cat-info .ci-desc { color: var(--text); }
.catalogue-item { padding: 4px 8px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #2a2a2a; }
.catalogue-item:hover { background: var(--bg-hover); }
.catalogue-item .cat-name { color: inherit; }
.catalogue-item .cat-detail { color: inherit; opacity: 0.6; font-size: 11px; }
.export-tabs { display: flex; gap: 2px; margin-bottom: 10px; }
.export-tab { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-dim); padding: 4px 12px; border-radius: 3px 3px 0 0; cursor: pointer; font-size: 12px; }
.export-tab.active { background: var(--bg-card); color: var(--accent); border-bottom-color: var(--bg-card); }
.export-content { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 0 3px 3px 3px; padding: 14px; font-size: 13px; line-height: 1.6; max-height: 500px; overflow-y: auto; white-space: pre-wrap; }
.export-content .label { font-weight: 700; color: var(--text-bright); }
.audit-block { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; padding: 14px; font-size: 13px; }
.audit-section { margin-bottom: 10px; }
.audit-section h4 { font-size: 12px; font-weight: 700; color: var(--text-bright); text-transform: uppercase; margin-bottom: 4px; }
.audit-pass { color: var(--green); }
.audit-fail { color: var(--red); }
.audit-warn { color: #e6a117; }
.audit-line { padding: 2px 0; }
.modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 100; align-items: center; justify-content: center; }
.modal-overlay.active { display: flex; }
.modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 20px; width: 600px; max-height: 85vh; overflow-y: auto; }
.modal h3 { color: var(--accent); margin-bottom: 14px; font-size: 16px; }
table.data-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 4px; }
table.data-table th { text-align: left; color: var(--text-dim); font-weight: 600; padding: 4px 8px; border-bottom: 1px solid var(--border); }
table.data-table td { padding: 4px 8px; border-bottom: 1px solid #2a2a2a; }
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-dark); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #555; }
</style>
</head>
<body>
<div id="saveOverlay" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;align-items:center;justify-content:center;transition:background 0.3s">
  <div class="save-msg" style="font-family:'Cinzel',serif;font-size:22px;color:#fff;letter-spacing:2px;text-shadow:0 0 20px rgba(255,180,0,0.5);padding:30px 50px;border:2px solid var(--accent);border-radius:8px;background:rgba(0,0,0,0.8)">‚è≥ SAVING...</div>
</div>
<script>
var DICEFORGE_AUTH=false;
(function(){
  if(localStorage.getItem('diceforge_npcdb_auth')==='54546-44-56456-7567-2345') DICEFORGE_AUTH=true;
})();
</script>
<header>
  <div><h1>TRIBUTE LANDS ‚Äî CHARACTER VAULT</h1><div class="subtitle">DiceForge Studios Ltd <a href="vault-help.html" target="_blank" style="margin-left:10px;font-size:10px;color:var(--text-dim);letter-spacing:1px;text-decoration:none;border:1px solid var(--border);padding:1px 7px;border-radius:3px">? Help</a></div></div>
  <div id="navButtons" style="display:flex;gap:4px;align-items:center">
    <button id="navBack" class="btn sm" onclick="navBack()" style="font-size:14px;padding:2px 8px;opacity:0.3;cursor:default" title="Back (Alt+‚Üê)">‚óÄ</button>
    <button id="navFwd" class="btn sm" onclick="navForward()" style="font-size:14px;padding:2px 8px;opacity:0.3;cursor:default" title="Forward (Alt+‚Üí)">‚ñ∂</button>
    <button class="btn sm" onclick="toggleShortcutHelp()" style="font-size:12px;padding:2px 8px;margin-left:4px" title="Keyboard shortcuts (?)">‚å®</button>
  </div>
  <div class="header-stats" id="headerStats"></div>
  <div id="syncIndicator" style="text-align:right;padding:2px 10px;display:flex;align-items:center;justify-content:flex-end;gap:8px">
    <span id="syncLabel" style="font-size:11px;font-family:monospace;color:var(--text-dim)">‚óè</span>
    <button onclick="forceRefresh()" style="font-size:10px;padding:1px 6px;background:none;border:1px solid var(--border);color:var(--text-dim);border-radius:3px;cursor:pointer" title="Reload from remote">‚Üª Refresh</button>
    <button onclick="promptForToken()" id="tokenBtn" style="font-size:10px;padding:1px 6px;background:none;border:1px solid var(--border);color:var(--text-dim);border-radius:3px;cursor:pointer;display:none" title="Set GitHub token">üîë Token</button>
  </div>
</header>
<div id="breadcrumb"><span class="bc-current">Home</span></div>
<div id="kbOverlay" onclick="if(event.target===this)toggleKBHelp()">
  <div class="kb-panel">
    <div class="kb-title">‚å® Keyboard Shortcuts</div>
    <div class="kb-section"><h4>Navigation</h4>
      <div class="kb-row"><span>Navigate roster</span><span><span class="kb-key">‚Üë</span> <span class="kb-key">‚Üì</span></span></div>
      <div class="kb-row"><span>Go back</span><span><span class="kb-key">Alt</span> + <span class="kb-key">‚Üê</span></span></div>
      <div class="kb-row"><span>Go forward</span><span><span class="kb-key">Alt</span> + <span class="kb-key">‚Üí</span></span></div>
    </div>
    <div class="kb-section"><h4>Editing</h4>
      <div class="kb-row"><span>Undo</span><span><span class="kb-key">Ctrl</span> + <span class="kb-key">Z</span></span></div>
      <div class="kb-row"><span>Redo</span><span><span class="kb-key">Ctrl</span> + <span class="kb-key">Y</span></span></div>
    </div>
    <div class="kb-section"><h4>Panels</h4>
      <div class="kb-row"><span>Show shortcuts</span><span><span class="kb-key">?</span></span></div>
      <div class="kb-row"><span>Close panel / overlay</span><span><span class="kb-key">Esc</span></span></div>
    </div>
    <div style="text-align:center;margin-top:14px;font-size:12px;color:var(--text-dim)">Press <span class="kb-key">?</span> or <span class="kb-key">Esc</span> to close</div>
  </div>
</div>
<div class="container">
  <div class="sidebar">
    <div id="sidebarInner">
    <div class="sidebar-controls">
      <input type="text" id="searchInput" placeholder="Search characters..." oninput="filterNPCs()">
      <div class="filter-row">
        <select id="categoryFilter" onchange="filterNPCs()"><option value="">All Types</option><option>Pre-gen</option><option>NPC</option></select>
        <select id="regionFilter" onchange="filterNPCs()"><option value="">All Regions</option><option>Ammaria</option><option>Saltlands</option><option>Vinlands</option><option>Concordium</option><option>Glasrya</option><option>Global</option></select>
        <select id="tierFilter" onchange="filterNPCs()"><option value="">All Tiers</option><option>Wild Card</option><option>Extra</option><option>Walk-on</option></select>
        <select id="lifecycleFilter" onchange="filterNPCs()" title="Filter by lifecycle state"><option value="">All States</option><option value="draft">üìù Draft</option><option value="committed">üì¶ Committed</option><option value="published">üîí Published</option><option value="dirty">‚úèÔ∏è Pending Edits</option><option value="errata">‚ö† Errata</option></select>
      </div>
      <div class="filter-row" id="productFilterRow" style="display:none">
        <select id="productFilter" onchange="filterNPCs()" title="Filter by product" style="flex:1"><option value="">All Products</option></select>
      </div>
    </div>
    <div class="npc-list" id="npcList"></div>
    <div class="sidebar-footer">
      <button class="btn primary" onclick="openNewNPCModal()" style="flex:1 1 100%">+ New Character</button>
      <button class="btn sm" onclick="showReviewPanel()" id="reviewBtn" title="Review pending changes" style="flex:1">Review</button>
      <button class="btn sm" onclick="showProductsModal()" title="Product registry" style="flex:1">Products</button>
      <button class="btn sm" onclick="showStatusView()" style="flex:1">Status</button>
      <button class="btn sm" onclick="showChangelog()" style="flex:1">Changes</button>
    </div>
    </div>
  </div>
  <div class="main empty-state" id="mainContent">
    <div id="welcomeGate" style="text-align:center;max-width:400px">
      <h2 style="color:var(--accent);margin-bottom:6px;font-size:22px">TRIBUTE LANDS</h2>
      <div style="color:var(--text-dim);font-size:13px;margin-bottom:24px;letter-spacing:1px">CHARACTER VAULT ‚Äî DICEFORGE STUDIOS</div>
      <div id="pinForm">
        <input id="pinInput" type="password" placeholder="Enter PIN" style="width:200px;text-align:center;padding:10px 14px;font-size:16px;letter-spacing:4px;background:var(--bg-card);border:1px solid var(--border);border-radius:4px;color:var(--text);margin-bottom:12px" onkeydown="if(event.key==='Enter')checkPin()">
        <br><button class="btn primary" onclick="checkPin()" style="padding:8px 28px">Enter</button>
        <div id="pinError" style="color:var(--red);font-size:12px;margin-top:10px"></div>
      </div>
    </div>
  </div>
</div>
<div id="charBottomBar" style="display:none"></div>
<div class="modal-overlay" id="newNpcModal">
  <div class="modal">
    <h3>New Character</h3>
    <div class="form-row"><div class="form-group"><label>Name *</label><input id="new_name"></div><div class="form-group"><label>Title / Role</label><input id="new_concept" placeholder="e.g. Professional Fixer"></div></div>
    <div class="form-row">
      <div class="form-group"><label>Category *</label><select id="new_category"><option>NPC</option><option>Pre-gen</option></select></div>
      <div class="form-group"><label>Region *</label><select id="new_region"><option>Ammaria</option><option>Saltlands</option><option>Vinlands</option><option>Concordium</option><option>Glasrya</option><option>Global</option></select></div>
      <div class="form-group"><label>Tier *</label><select id="new_tier"><option>Wild Card</option><option>Extra</option><option>Walk-on</option></select></div>
      <div class="form-group"><label>Ancestry</label><select id="new_ancestry"><option>Human</option><option>Dwarf</option><option>Elf</option><option>Half-Folk</option><option>Other</option></select></div>
    </div>
    <div class="form-actions"><button class="btn" onclick="closeNewNPCModal()">Cancel</button><button class="btn primary" onclick="createNPC()">Create NPC</button></div>
  </div>
</div>
<script>
// CharacterForge Engine Bootstrap
window.CharacterForge = (function(){
  var modules = [];
  return {
    data: {},
    registerModule: function(mod) {
      modules.push(mod);
      if (mod.alwaysOn) {
        ['edges','hindrances','skills','ancestries','powers','gear','skillLinks','coreSkills','skillDescs'].forEach(function(k){
          if (mod[k]) {
            if (Array.isArray(mod[k])) { if (!this.data[k]) this.data[k] = []; this.data[k] = this.data[k].concat(mod[k]); }
            else if (typeof mod[k] === 'object') { if (!this.data[k]) this.data[k] = {}; Object.assign(this.data[k], mod[k]); }
          }
        }.bind(this));
      }
    },
    getModules: function() { return modules; },
    getModule: function(id) { return modules.find(function(m){ return m.id === id; }); }
  };
})();
</script>
<script src="swade-rules.js"></script>
<script src="swade-core.js"></script>
<script src="ammaria.js"></script>
<script>
let allNPCs=[], currentNPC=null, activePanel=null;
let canonCommitted=new Set();
/* ‚ïê‚ïê‚ïê NAVIGATION HISTORY ‚ïê‚ïê‚ïê */
let _navHistory=[], _navFwdStack=[], _navPushing=false;
function navPush(view){
  if(_navPushing)return;
  _navHistory.push(view);_navFwdStack=[];
  updateNavButtons();
}
function navBack(){
  if(_navHistory.length<2)return;
  _navFwdStack.push(_navHistory.pop());
  const prev=_navHistory[_navHistory.length-1];
  _navPushing=true;
  navGo(prev);
  _navPushing=false;
  updateNavButtons();updateBreadcrumb();
}
function navForward(){
  if(!_navFwdStack.length)return;
  const next=_navFwdStack.pop();
  _navHistory.push(next);
  _navPushing=true;
  navGo(next);
  _navPushing=false;
  updateNavButtons();updateBreadcrumb();
}
function navGo(view){
  if(view.type==='character') selectNPC(view.name);
  else if(view.type==='status') showStatusView();
  else if(view.type==='review') showReviewPanel();
  else if(view.type==='products') showProductsModal();
  else if(view.type==='changelog') showChangelog();
}
function updateNavButtons(){
  const back=document.getElementById('navBack');
  const fwd=document.getElementById('navFwd');
  if(back){back.style.opacity=_navHistory.length>1?'1':'0.3';back.style.cursor=_navHistory.length>1?'pointer':'default';}
  if(fwd){fwd.style.opacity=_navFwdStack.length>0?'1':'0.3';fwd.style.cursor=_navFwdStack.length>0?'pointer':'default';}
}

/* ‚ïê‚ïê‚ïê BREADCRUMB TRAIL ‚ïê‚ïê‚ïê */
function updateBreadcrumb(){
  const el=document.getElementById('breadcrumb');if(!el)return;
  const sep='<span class="bc-sep">‚Ä∫</span>';
  const home='<span class="bc-link" onclick="clearView()">Vault</span>';
  let trail=home;
  if(currentNPC){
    const cat=(currentNPC.category||'NPC')==='Pre-gen'?'Pre-gens':'NPCs';
    trail+=sep+'<span class="bc-link" onclick="headerFilter(\'category\',\''+cat+'\')">'+cat+'</span>';
    trail+=sep+'<span class="bc-current">'+esc(currentNPC.name)+'</span>';
    if(activePanel&&activePanel!=='audit'){
      const panelNames={edit:'Edit',hindrances:'Hindrances',edges:'Edges',skills:'Skills',weapons:'Weapons',armour:'Armour',gear:'Gear',powers:'Powers',narrative:'Narrative',statblock:'Stat Block',transfer:'Import / Export'};
      trail+=sep+'<span class="bc-current" style="font-weight:normal">'+esc(panelNames[activePanel]||activePanel)+'</span>';
    }
  } else {
    const view=_navHistory.length?_navHistory[_navHistory.length-1]:null;
    if(view){
      const names={status:'Production Status',review:'Review Pending Changes',products:'Product Registry',changelog:'Canon Changelog'};
      if(names[view.type]) trail+=sep+'<span class="bc-current">'+names[view.type]+'</span>';
    }
  }
  el.innerHTML=trail;
}
function clearView(){
  hideBottomBar();currentNPC=null;activePanel=null;
  const el=document.getElementById('mainContent');
  el.innerHTML='Select an NPC or create a new one';
  el.classList.add('empty-state');
  document.getElementById('categoryFilter').value='';
  document.getElementById('regionFilter').value='';
  document.getElementById('lifecycleFilter').value='';
  document.getElementById('searchInput').value='';
  filterNPCs();updateBreadcrumb();
}

/* ‚ïê‚ïê‚ïê KEYBOARD SHORTCUT OVERLAY ‚ïê‚ïê‚ïê */
function toggleShortcutHelp(){
  let overlay=document.getElementById('shortcutOverlay');
  if(overlay){overlay.remove();return;}
  overlay=document.createElement('div');
  overlay.id='shortcutOverlay';
  overlay.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:300;display:flex;align-items:center;justify-content:center';
  overlay.onclick=e=>{if(e.target===overlay)overlay.remove();};
  const shortcuts=[
    ['Navigation',''],
    ['‚Üë / ‚Üì','Move through character roster'],
    ['Alt + ‚Üê','Navigate back'],
    ['Alt + ‚Üí','Navigate forward'],
    ['',''],
    ['Editing',''],
    ['Ctrl + Z','Undo last edit'],
    ['Ctrl + Y','Redo last edit'],
    ['Ctrl + Shift + Z','Redo (alternative)'],
    ['',''],
    ['Views',''],
    ['?','Toggle this shortcut help'],
  ];
  let rows=shortcuts.map(([key,desc])=>{
    if(!key&&!desc) return '';
    if(!desc) return '<tr><td colspan="2" style="padding:10px 0 4px;font-weight:bold;color:var(--accent);font-size:13px;border-bottom:1px solid var(--border)">'+key+'</td></tr>';
    return '<tr><td style="padding:4px 16px 4px 0;text-align:right"><kbd style="background:var(--bg-input);border:1px solid var(--border);border-radius:3px;padding:2px 8px;font-family:monospace;font-size:12px;color:var(--text-bright);min-width:60px;display:inline-block;text-align:center">'+key+'</kbd></td><td style="padding:4px 0;color:var(--text);font-size:13px">'+desc+'</td></tr>';
  }).join('');
  overlay.innerHTML='<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:24px 32px;max-width:480px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px"><h3 style="margin:0;color:var(--accent)">‚å® Keyboard Shortcuts</h3><button class="btn sm" onclick="document.getElementById(\'shortcutOverlay\').remove()">‚úï</button></div><table style="width:100%">'+rows+'</table><div style="margin-top:16px;font-size:11px;color:var(--text-dim);text-align:center">Press <kbd style="background:var(--bg-input);border:1px solid var(--border);border-radius:2px;padding:1px 5px;font-family:monospace;font-size:11px">?</kbd> or click anywhere to close</div></div>';
  document.body.appendChild(overlay);
}
/* ‚ïê‚ïê‚ïê UNDO / REDO ‚ïê‚ïê‚ïê */
const UNDO_CAP=40;
let _undoStack=[], _redoStack=[], _lastSnapshot=null;
function _snap(npc){return npc?JSON.parse(JSON.stringify(npc)):null;}
function _pushUndo(){if(!currentNPC)return;if(_lastSnapshot){_undoStack.push(_lastSnapshot);if(_undoStack.length>UNDO_CAP)_undoStack.shift();}_redoStack=[];_lastSnapshot=_snap(currentNPC);}
function _restoreSnap(snap){if(!snap||!currentNPC)return;const idx=allNPCs.findIndex(n=>n.name===currentNPC.name);Object.assign(currentNPC,snap);if(idx>=0)allNPCs[idx]=currentNPC;calcDerived(currentNPC);scheduleSave();if(activePanel){renderMiddleColumn(currentNPC);renderStatColumn(currentNPC);}else{renderDetail();}}
function undo(){if(!_undoStack.length||!currentNPC)return;_redoStack.push(_snap(currentNPC));const prev=_undoStack.pop();_lastSnapshot=_snap(prev);_restoreSnap(prev);}
function redo(){if(!_redoStack.length||!currentNPC)return;_undoStack.push(_snap(currentNPC));const next=_redoStack.pop();_lastSnapshot=_snap(next);_restoreSnap(next);}
document.addEventListener('keydown',e=>{if((e.ctrlKey||e.metaKey)&&e.key==='z'&&!e.shiftKey){e.preventDefault();undo();}if((e.ctrlKey||e.metaKey)&&(e.key==='y'||(e.key==='z'&&e.shiftKey))){e.preventDefault();redo();}if(e.altKey&&e.key==='ArrowLeft'){e.preventDefault();navBack();}if(e.altKey&&e.key==='ArrowRight'){e.preventDefault();navForward();}const tag=document.activeElement?.tagName;if(e.key==='?'&&tag!=='INPUT'&&tag!=='TEXTAREA'&&tag!=='SELECT'){e.preventDefault();toggleShortcutHelp();}});

/* ‚ïê‚ïê‚ïê RELEASE MANAGEMENT ‚Äî baselines, dirty tracking, product registry, locks ‚ïê‚ïê‚ïê */
let _baselines={};
let _productRegistry={products:[]};
const REGISTRY_FILENAME='product-registry.json';

/* ‚îÄ‚îÄ Baseline Management ‚îÄ‚îÄ */
function captureBaselines(){
  _baselines={};
  allNPCs.forEach(n=>{_baselines[n.name]=JSON.stringify(serialiseForBaseline(n));});
  console.log('üì∏ Baselines captured for',Object.keys(_baselines).length,'characters');
}
function captureBaseline(name){
  const n=allNPCs.find(c=>c.name===name);
  if(n)_baselines[name]=JSON.stringify(serialiseForBaseline(n));
}
function serialiseForCompare(n){
  return {
    attrs:{agility:n.agility||0,smarts:n.smarts||0,spirit:n.spirit||0,strength:n.strength||0,vigor:n.vigor||0},
    skills:Object.assign({},n.skills||{}),edges:[...(n.edges||[])].sort(),edgeNotes:Object.assign({},n.edgeNotes||{}),
    hindrances:[...(n.hindrances||[])].sort(),powers:[...(n.powers||[])].sort(),
    weapons:JSON.parse(JSON.stringify(n.weapons||[])),
    armour:JSON.parse(JSON.stringify(n.armour||[])),
    gearText:n.gearText||'',pace:n.pace||6,parry:n.parry||2,toughness:n.toughness||5,toughnessArmor:n.toughnessArmor||0,
    abName:n.abName||'',pp:n.pp||0,startingFunds:n.startingFunds||500,gearCost:n.gearCost||0,
    quote:n.quote||'',description:n.description||'',background:n.background||'',
    motivation:n.motivation||'',secret:n.secret||'',services:n.services||'',
    adventureHook:n.adventureHook||'',tactics:n.tactics||'',notes:n.notes||'',
    refCode:n.refCode||'',concept:n.concept||'',ancestry:n.ancestry||'Human',
    region:n.region||'Ammaria',tier:n.tier||'Wild Card',rank:n.rank||'Novice',category:n.category||'NPC'
  };
}
function serialiseForBaseline(n){
  const base=serialiseForCompare(n);
  base.weapons=(n.weapons||[]).map(w=>({...w}));
  base.armour=(n.armour||[]).map(a=>({...a}));
  return base;
}

/* ‚îÄ‚îÄ Dirty Detection ‚îÄ‚îÄ */
function isCharDirty(name){
  const n=allNPCs.find(c=>c.name===name);
  if(!n)return false;
  const baseline=_baselines[name];
  if(!baseline)return true;
  // Compare using the compare-only serialisation (names not objects) for stable comparison
  const oldFull=JSON.parse(baseline);
  // Re-normalise baseline through compare path (strips weapon/armour objects to sorted names)
  const oldCompare={...oldFull,
    weapons:(oldFull.weapons||[]).map(w=>typeof w==='string'?w:w.name).sort(),
    armour:(oldFull.armour||[]).map(a=>typeof a==='string'?a:a.name).sort()
  };
  return JSON.stringify(serialiseForCompare(n))!==JSON.stringify(oldCompare);
}
function getAllDirty(){return allNPCs.filter(n=>isCharDirty(n.name));}
function getDirtyCount(){return getAllDirty().length;}

/* ‚îÄ‚îÄ Character Lifecycle ‚îÄ‚îÄ */
function getLifecycle(name){
  const n=allNPCs.find(c=>c.name===name);
  if(!n)return 'draft';
  if(isPublished(name))return 'published';
  if(canonCommitted.has(name))return 'committed';
  return 'draft';
}
function isPublished(name){
  return _productRegistry.products.some(p=>p.status==='released'&&(p.characters||[]).includes(name));
}
function getPublishedProducts(name){
  return _productRegistry.products.filter(p=>p.status==='released'&&(p.characters||[]).includes(name));
}
function isLocked(name){
  return isPublished(name);
}

/* ‚îÄ‚îÄ Human-Readable Diff Engine ‚îÄ‚îÄ */
function getCharDiff(name){
  const n=allNPCs.find(c=>c.name===name);
  if(!n)return [];
  const baseline=_baselines[name];
  if(!baseline)return [{type:'added',text:'New character (no baseline)'}];
  const old=JSON.parse(baseline);
  const cur=serialiseForCompare(n);
  const changes=[];
  // Identity
  if(old.concept!==cur.concept) changes.push({type:'changed',text:`Concept: "${old.concept||'‚Äî'}" ‚Üí "${cur.concept||'‚Äî'}"`});
  if(old.ancestry!==cur.ancestry) changes.push({type:'changed',text:`Ancestry: ${old.ancestry} ‚Üí ${cur.ancestry}`});
  if(old.tier!==cur.tier) changes.push({type:'changed',text:`Tier: ${old.tier} ‚Üí ${cur.tier}`});
  if(old.rank!==cur.rank) changes.push({type:'changed',text:`Rank: ${old.rank} ‚Üí ${cur.rank}`});
  if(old.refCode!==cur.refCode) changes.push({type:'changed',text:`RefCode: ${old.refCode||'‚Äî'} ‚Üí ${cur.refCode||'‚Äî'}`});
  // Attributes
  const attrNames=['agility','smarts','spirit','strength','vigor'];
  const attrLabels={agility:'Agi',smarts:'Sma',spirit:'Spi',strength:'Str',vigor:'Vig'};
  const attrChanges=[];
  attrNames.forEach(a=>{if(old.attrs[a]!==cur.attrs[a]) attrChanges.push(`${attrLabels[a]} ${d(old.attrs[a])}‚Üí${d(cur.attrs[a])}`);});
  if(attrChanges.length) changes.push({type:'changed',text:'Attributes: '+attrChanges.join(', ')});
  // Skills
  const allSkills=new Set([...Object.keys(old.skills),...Object.keys(cur.skills)]);
  const skillAdded=[],skillRemoved=[],skillChanged=[];
  allSkills.forEach(sk=>{
    if(!old.skills[sk]) skillAdded.push(sk+' '+d(cur.skills[sk]));
    else if(!cur.skills[sk]) skillRemoved.push(sk);
    else if(old.skills[sk]!==cur.skills[sk]) skillChanged.push(sk+' '+d(old.skills[sk])+'‚Üí'+d(cur.skills[sk]));
  });
  if(skillAdded.length) changes.push({type:'added',text:'Skills added: '+skillAdded.join(', ')});
  if(skillRemoved.length) changes.push({type:'removed',text:'Skills removed: '+skillRemoved.join(', ')});
  if(skillChanged.length) changes.push({type:'changed',text:'Skills changed: '+skillChanged.join(', ')});
  // Edges
  const edgeAdded=cur.edges.filter(e=>!old.edges.includes(e));
  const edgeRemoved=old.edges.filter(e=>!cur.edges.includes(e));
  if(edgeAdded.length) changes.push({type:'added',text:'Edges added: '+edgeAdded.join(', ')});
  if(edgeRemoved.length) changes.push({type:'removed',text:'Edges removed: '+edgeRemoved.join(', ')});
  // Edge notes
  const allEdgeNoteKeys=new Set([...Object.keys(old.edgeNotes||{}),...Object.keys(cur.edgeNotes||{})]);
  const noteChanges=[];
  allEdgeNoteKeys.forEach(k=>{if((old.edgeNotes||{})[k]!==(cur.edgeNotes||{})[k]) noteChanges.push(k);});
  if(noteChanges.length) changes.push({type:'changed',text:'Edge notes updated: '+noteChanges.join(', ')});
  // Hindrances
  const hindAdded=cur.hindrances.filter(h=>!old.hindrances.includes(h));
  const hindRemoved=old.hindrances.filter(h=>!cur.hindrances.includes(h));
  if(hindAdded.length) changes.push({type:'added',text:'Hindrances added: '+hindAdded.join(', ')});
  if(hindRemoved.length) changes.push({type:'removed',text:'Hindrances removed: '+hindRemoved.join(', ')});
  // Powers
  const powAdded=cur.powers.filter(p=>!old.powers.includes(p));
  const powRemoved=old.powers.filter(p=>!cur.powers.includes(p));
  if(powAdded.length) changes.push({type:'added',text:'Powers added: '+powAdded.join(', ')});
  if(powRemoved.length) changes.push({type:'removed',text:'Powers removed: '+powRemoved.join(', ')});
  if(old.pp!==cur.pp) changes.push({type:'changed',text:`Power Points: ${old.pp}‚Üí${cur.pp}`});
  // Weapons
  const oldWepNames=(old.weapons||[]).map(w=>typeof w==='string'?w:w.name).sort();
  const curWepNames=(cur.weapons||[]).map(w=>typeof w==='string'?w:w.name).sort();
  const wepAdded=curWepNames.filter(w=>!oldWepNames.includes(w));
  const wepRemoved=oldWepNames.filter(w=>!curWepNames.includes(w));
  if(wepAdded.length) changes.push({type:'added',text:'Weapons added: '+wepAdded.join(', ')});
  if(wepRemoved.length) changes.push({type:'removed',text:'Weapons removed: '+wepRemoved.join(', ')});
  // Armour
  const oldArmNames=(old.armour||[]).map(a=>typeof a==='string'?a:a.name).sort();
  const curArmNames=(cur.armour||[]).map(a=>typeof a==='string'?a:a.name).sort();
  const armAdded=curArmNames.filter(a=>!oldArmNames.includes(a));
  const armRemoved=oldArmNames.filter(a=>!curArmNames.includes(a));
  if(armAdded.length) changes.push({type:'added',text:'Armour added: '+armAdded.join(', ')});
  if(armRemoved.length) changes.push({type:'removed',text:'Armour removed: '+armRemoved.join(', ')});
  // Gear
  if(old.gearText!==cur.gearText) changes.push({type:'changed',text:'Gear list updated'});
  // Derived
  if(old.pace!==cur.pace) changes.push({type:'changed',text:`Pace: ${old.pace}‚Üí${cur.pace}`});
  // Funds
  if(old.startingFunds!==cur.startingFunds) changes.push({type:'changed',text:`Starting Funds: ${old.startingFunds}‚Ç°‚Üí${cur.startingFunds}‚Ç°`});
  if(old.gearCost!==cur.gearCost) changes.push({type:'changed',text:`Gear Cost: ${old.gearCost}‚Ç°‚Üí${cur.gearCost}‚Ç°`});
  // Narrative
  const narrativeFields=[{key:'description',label:'Description'},{key:'background',label:'Background'},{key:'motivation',label:'Motivation'},{key:'secret',label:'Secret'},{key:'services',label:'Services'},{key:'adventureHook',label:'Adventure Hook'},{key:'tactics',label:'Tactics'},{key:'notes',label:'Notes'},{key:'quote',label:'Quote'}];
  narrativeFields.forEach(f=>{if(old[f.key]!==cur[f.key]){
    if(!old[f.key]&&cur[f.key]) changes.push({type:'added',text:f.label+' added'});
    else if(old[f.key]&&!cur[f.key]) changes.push({type:'removed',text:f.label+' removed'});
    else changes.push({type:'changed',text:f.label+' updated'});
  }});
  return changes;
}

/* ‚îÄ‚îÄ Product Registry ‚îÄ‚îÄ */
async function loadProductRegistry(){
  if(!GIST_ID||!GIST_TOKEN)return;
  try{
    const resp=await fetch(`https://api.github.com/gists/${GIST_ID}`,{headers:{'Authorization':`token ${GIST_TOKEN}`,'Accept':'application/vnd.github.v3+json'}});
    if(!resp.ok)return;
    const gist=await resp.json();
    const raw=gist.files[REGISTRY_FILENAME]?.content;
    if(raw){_productRegistry=JSON.parse(raw);console.log('üì¶ Product registry loaded:',_productRegistry.products.length,'products');refreshProductFilter();}
  }catch(e){console.warn('Registry load failed:',e);}
}
async function saveProductRegistry(){
  if(!GIST_ID||!GIST_TOKEN)return;
  try{
    await fetch(`https://api.github.com/gists/${GIST_ID}`,{
      method:'PATCH',
      headers:{'Authorization':`token ${GIST_TOKEN}`,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},
      body:JSON.stringify({files:{[REGISTRY_FILENAME]:{content:JSON.stringify(_productRegistry,null,2)}}})
    });
    console.log('üì¶ Registry saved');refreshProductFilter();
  }catch(e){console.error('Registry save failed:',e);}
}
function addProduct(code,title){
  if(_productRegistry.products.find(p=>p.code===code))return false;
  _productRegistry.products.push({code,title,status:'draft',characters:[],createdAt:new Date().toISOString(),releasedAt:null,platforms:[]});
  saveProductRegistry();return true;
}
function addCharToProduct(productCode,charName){
  const p=_productRegistry.products.find(x=>x.code===productCode);
  if(!p)return false;
  if(!p.characters.includes(charName))p.characters.push(charName);
  saveProductRegistry();return true;
}
function removeCharFromProduct(productCode,charName){
  const p=_productRegistry.products.find(x=>x.code===productCode);
  if(!p)return false;
  p.characters=p.characters.filter(c=>c!==charName);
  saveProductRegistry();return true;
}
function setProductStatus(code,status){
  const p=_productRegistry.products.find(x=>x.code===code);
  if(!p)return false;
  p.status=status;
  if(status==='released'&&!p.releasedAt)p.releasedAt=new Date().toISOString();
  saveProductRegistry();return true;
}
function removeProduct(code){
  const p=_productRegistry.products.find(x=>x.code===code);
  if(!p)return false;
  if(p.status==='released'){alert('Cannot delete a released product. Archive it instead.');return false;}
  _productRegistry.products=_productRegistry.products.filter(x=>x.code!==code);
  saveProductRegistry();return true;
}

/* ‚îÄ‚îÄ Override System for Published Characters ‚îÄ‚îÄ */
function requiresOverride(name){return isPublished(name)&&isCharDirty(name);}
function logOverride(name,reason){
  const n=allNPCs.find(c=>c.name===name);
  if(!n)return;
  if(!n.overrideLog)n.overrideLog=[];
  n.overrideLog.push({date:new Date().toISOString(),reason:reason,changes:getCharDiff(name)});
}

/* ‚îÄ‚îÄ Batch Review ‚Äî approve/reject dirty characters ‚îÄ‚îÄ */
function approveCharacter(name){
  captureBaseline(name);
  filterNPCs();updateHeaderStats();
}
function revertCharacter(name){
  const baseline=_baselines[name];
  if(!baseline)return;
  const n=allNPCs.find(c=>c.name===name);
  if(!n)return;
  const old=JSON.parse(baseline);
  // Restore from baseline ‚Äî rebuild the full character from serialised compare data
  n.agility=old.attrs.agility;n.smarts=old.attrs.smarts;n.spirit=old.attrs.spirit;n.strength=old.attrs.strength;n.vigor=old.attrs.vigor;
  n.skills=Object.assign({},old.skills);n.edges=[...old.edges];n.edgeNotes=Object.assign({},old.edgeNotes);
  n.hindrances=[...old.hindrances];n.powers=[...old.powers];n.gearText=old.gearText;
  n.pace=old.pace;n.parry=old.parry;n.toughness=old.toughness;n.toughnessArmor=old.toughnessArmor;
  n.abName=old.abName;n.pp=old.pp;n.startingFunds=old.startingFunds;n.gearCost=old.gearCost;
  n.quote=old.quote;n.description=old.description;n.background=old.background;
  n.motivation=old.motivation;n.secret=old.secret;n.services=old.services;
  n.adventureHook=old.adventureHook;n.tactics=old.tactics;n.notes=old.notes;
  n.refCode=old.refCode;n.concept=old.concept;n.ancestry=old.ancestry;
  n.region=old.region;n.tier=old.tier;n.rank=old.rank;n.category=old.category;
  n.weapons=(old.weapons||[]).map(w=>typeof w==='string'?{name:w}:{...w});
  n.armour=(old.armour||[]).map(a=>typeof a==='string'?{name:a}:{...a});
  calcDerived(n);scheduleSave();
  if(currentNPC&&currentNPC.name===name){currentNPC=n;renderDetail();}
  filterNPCs();updateHeaderStats();
}
const LS_KEY='tl_npc_db';
const CACHE_KEY='tl_npc_cache';

// ‚ïê‚ïê‚ïê REMOTE DATA STORE CONFIG ‚ïê‚ïê‚ïê
// Fill these in after creating your GitHub Gist.
// GIST_ID: the alphanumeric ID from the Gist URL (e.g. 'a1b2c3d4e5f6...')
// GIST_TOKEN: a GitHub personal access token with 'gist' scope only
// GIST_FILENAME: must match the filename in your Gist
const GIST_ID = '7fa2d50c458ed95c21a3c6d283f863d6';
const GIST_TOKEN = localStorage.getItem('diceforge_gist_token')||'';
const GIST_FILENAME = 'ammaria-characters.json';

function promptForToken(){
  const t=prompt('Enter your GitHub Gist token (one-time setup per device):');
  if(t&&t.startsWith('github_pat_')){localStorage.setItem('diceforge_gist_token',t);location.reload();}
  else if(t){alert('Token should start with github_pat_...');promptForToken();}
}

let syncStatus='idle'; // idle | loading | saving | error | offline
let saveTimer=null;
const SAVE_DEBOUNCE_MS=500; // batch rapid edits into one save

function setSyncStatus(s,msg){
  syncStatus=s;
  const el=document.getElementById('syncLabel');
  const overlay=document.getElementById('saveOverlay');
  if(!el)return;
  const map={idle:['‚óè','var(--green)','Synced'],loading:['‚Üª','var(--accent)','Loading...'],saving:['‚Üë','var(--accent)','Saving...'],error:['‚úñ','#c44','Sync error'],offline:['‚óã','var(--text-dim)','Offline (cached)']};
  const[icon,col,label]=map[s]||map.idle;
  el.style.color=col;
  el.textContent=`${icon} ${msg||label}`;
  el.title=msg||label;
  // Overlay only on errors ‚Äî normal saves are silent
  if(overlay){
    if(s==='error'){
      overlay.style.display='flex';
      overlay.querySelector('.save-msg').textContent='‚ùå SAVE FAILED ‚Äî RETRYING...';
      overlay.style.background='rgba(80,0,0,0.7)';
    } else {
      overlay.style.display='none';
    }
  }
}

async function forceRefresh(){
  if(saveTimer){clearTimeout(saveTimer);saveTimer=null;}
  await loadData();captureBaselines();filterNPCs();updateHeaderStats();loadProductRegistry();
  if(currentNPC){const fresh=allNPCs.find(n=>n.name===currentNPC.name);if(fresh){currentNPC=fresh;renderDetail();}else{currentNPC=null;document.getElementById('mainContent').innerHTML='<span style="color:var(--text-dim)">Character no longer exists</span>';}}
}

async function loadData(){
  const CF=window.CharacterForge;
  // If no Gist configured, fall back to module-seeded + localStorage (legacy mode)
  if(!GIST_ID||!GIST_TOKEN){
    console.warn('No Gist configured ‚Äî running in local-only mode');
    setSyncStatus('offline','No remote store ‚Äî click üîë to set up');
    const tb=document.getElementById('tokenBtn');if(tb)tb.style.display='';
    loadDataLegacy(CF);
    return;
  }
  setSyncStatus('loading');
  try{
    const resp=await fetch(`https://api.github.com/gists/${GIST_ID}`,{headers:{'Authorization':`token ${GIST_TOKEN}`,'Accept':'application/vnd.github.v3+json'}});
    if(!resp.ok) throw new Error(`GitHub ${resp.status}: ${resp.statusText}`);
    const gist=await resp.json();
    const raw=gist.files[GIST_FILENAME]?.content;
    if(!raw) throw new Error(`File "${GIST_FILENAME}" not found in Gist`);
    const data=JSON.parse(raw);
    // Normalise each character
    allNPCs=data.characters.map(c=>normaliseChar(c,'ammaria'));
    // Cache locally for offline fallback
    localStorage.setItem(CACHE_KEY,raw);
    setSyncStatus('idle',`Synced ‚Äî ${allNPCs.length} characters`);
    console.log(`Loaded ${allNPCs.length} characters from Gist`);
  }catch(err){
    console.error('Gist load failed, trying cache:',err);
    const cached=localStorage.getItem(CACHE_KEY);
    if(cached){
      const data=JSON.parse(cached);
      allNPCs=data.characters.map(c=>normaliseChar(c,'ammaria'));
      setSyncStatus('offline',`Offline ‚Äî ${allNPCs.length} characters (cached)`);
    }else{
      // Last resort: load from module seed data
      loadDataLegacy(CF);
      setSyncStatus('error','No remote data or cache available');
    }
  }
}

function loadDataLegacy(CF){
  if(!CF)return;
  const seeded=[];
  const modules=CF.getModules?CF.getModules():[];
  modules.forEach(m=>{if(m.characters) m.characters.forEach(c=>seeded.push(normaliseChar(c,m.id)));});
  const stored=JSON.parse(localStorage.getItem(LS_KEY)||'{}');
  const merged=[], usedNames=new Set();
  if(stored.custom) stored.custom.forEach(c=>{merged.push(c);usedNames.add(c.name);});
  seeded.forEach(s=>{
    if(usedNames.has(s.name)) return;
    const ov=stored.overrides?stored.overrides[s.name]:null;
    merged.push(ov?{...s,...ov,category:s.category}:s);
  });
  allNPCs=merged;
  if(stored.deleted) allNPCs=allNPCs.filter(n=>!stored.deleted.includes(n.name));
}

function saveCharacter(npc){_pushUndo();console.log("üíæ saveCharacter called:",npc.name);
  // Update in allNPCs array
  const idx=allNPCs.findIndex(n=>n.name===npc.name);
  if(idx>=0) allNPCs[idx]=npc; else allNPCs.push(npc);
  // Debounced remote save
  scheduleSave();
}

function scheduleSave(){console.log("‚è± scheduleSave: will push in",SAVE_DEBOUNCE_MS,"ms");
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer=setTimeout(()=>pushToGist(),SAVE_DEBOUNCE_MS);
}

async function pushToGist(){console.log("‚òÅÔ∏è pushToGist firing...");
  if(!GIST_ID||!GIST_TOKEN){
    // Legacy fallback: save to localStorage
    const s=JSON.parse(localStorage.getItem(LS_KEY)||'{}');
    if(!s.overrides)s.overrides={};
    if(currentNPC)s.overrides[currentNPC.name]=currentNPC;
    localStorage.setItem(LS_KEY,JSON.stringify(s));
    return;
  }
  setSyncStatus('saving');
  try{
    const data={
      version:'1.0',
      region:'ammaria',
      lastModified:new Date().toISOString(),
      lastModifiedBy:'character-vault',
      characterCount:allNPCs.length,
      characters:allNPCs.map(n=>({
        name:n.name,refCode:n.refCode||'',concept:n.concept||'',ancestry:n.ancestry||'Human',
        region:n.region||'Ammaria',tier:n.tier||'Wild Card',rank:n.rank||'Novice',
        category:n.category||'NPC',product:n.product||n.region||'Ammaria',
        attrs:{agility:n.agility||0,smarts:n.smarts||0,spirit:n.spirit||0,strength:n.strength||0,vigor:n.vigor||0},
        skills:n.skills||{},edges:n.edges||[],edgeNotes:n.edgeNotes||{},hindrances:n.hindrances||[],powers:n.powers||[],
        weapons:n.weapons||[],armour:n.armour||[],
        pace:n.pace||6,parry:n.parry||2,toughness:n.toughness||5,toughnessArmor:n.toughnessArmor||0,bennies:n.bennies||0,
        gearText:n.gearText||'',quote:n.quote||'',notes:n.notes||'',
        description:n.description||'',background:n.background||'',motivation:n.motivation||'',
        secret:n.secret||'',services:n.services||'',adventureHook:n.adventureHook||'',tactics:n.tactics||'',
        abName:n.abName||'',abSkill:n.abSkill||'',pp:n.pp||0,startingFunds:n.startingFunds||500,gearCost:n.gearCost||0,
        statComplete:n.statComplete||false,narrativeComplete:n.narrativeComplete||false,fgReady:n.fgReady||false,
        overrideLog:n.overrideLog||[]
      }))
    };
    const raw=JSON.stringify(data,null,2);
    const resp=await fetch(`https://api.github.com/gists/${GIST_ID}`,{
      method:'PATCH',
      headers:{'Authorization':`token ${GIST_TOKEN}`,'Accept':'application/vnd.github.v3+json','Content-Type':'application/json'},
      body:JSON.stringify({files:{[GIST_FILENAME]:{content:raw}}})
    });
    if(!resp.ok) throw new Error(`GitHub ${resp.status}: ${resp.statusText}`);
    // Update cache
    localStorage.setItem(CACHE_KEY,raw);
    console.log('‚úÖ Gist save success:',allNPCs.length,'characters');setSyncStatus('idle',`Saved ‚Äî ${allNPCs.length} characters`);
  }catch(err){
    console.error('‚ùå Gist save FAILED:',err);
    setSyncStatus('error','Save failed ‚Äî will retry');
    // Retry once after 5 seconds
    setTimeout(()=>{if(syncStatus==='error')pushToGist();},5000);
  }
}

function normaliseChar(c,moduleId){
  const n={name:c.name,refCode:c.refCode||'',concept:c.concept||'',ancestry:c.ancestry||'Human',region:c.region||'Ammaria',tier:c.tier||'Wild Card',rank:c.rank||'Novice',category:c.category||'NPC',product:c.product||'',source:moduleId,agility:c.attrs?.agility||c.agility||0,smarts:c.attrs?.smarts||c.smarts||0,spirit:c.attrs?.spirit||c.spirit||0,strength:c.attrs?.strength||c.strength||0,vigor:c.attrs?.vigor||c.vigor||0,skills:c.skills||{},edges:c.edges||[],edgeNotes:c.edgeNotes||{},hindrances:c.hindrances||[],powers:c.powers||[],armour:c.armour||[],weapons:c.weapons||[],gearText:c.gearText||'',quote:c.quote||'',description:c.description||'',background:c.background||'',motivation:c.motivation||'',secret:c.secret||'',services:c.services||'',adventureHook:c.adventureHook||'',tactics:c.tactics||'',abName:c.abName||'',abSkill:c.abSkill||'',pp:c.pp||0,startingFunds:c.startingFunds||500,gearCost:c.gearCost||0,statComplete:c.statComplete||false,narrativeComplete:c.narrativeComplete||false,fgReady:c.fgReady||false,pace:c.pace||6,parry:c.parry||2,toughness:c.toughness||5,toughnessArmor:c.toughnessArmor||0,bennies:c.bennies||0};
  // Parse gear text into structured armour/weapons if not already populated
  if(!n.armour.length&&!n.weapons.length&&n.gearText) parseGearInto(n);
  n.toughnessArmor=n.armour.reduce((best,a)=>Math.max(best,a.armor||0),0);
  if(c.notes && !n.description && !n.motivation){
    const notes=c.notes;
    const motM=notes.match(/What (?:They|He|She) Want[s]?:\s*(.+?)(?:\n|$)/i);
    const secM=notes.match(/(?:Their|His|Her) Secret:\s*(.+?)(?:\n|$)/i);
    const svcM=notes.match(/Services:\s*(.+?)(?:\n|$)/i);
    const hookM=notes.match(/Hook:\s*(.+?)(?:\n|$)/i);
    if(motM) n.motivation=motM[1].trim();
    if(secM) n.secret=secM[1].trim();
    if(svcM) n.services=svcM[1].trim();
    if(hookM) n.adventureHook=hookM[1].trim();
    const lines=notes.split('\n').map(l=>l.trim()).filter(l=>l);
    const narr=[];
    for(const line of lines){
      if(/^(What|Their|His|Her|Services|Hook|Connections|Advancement)[\s:]/i.test(line)) break;
      if(/^Appendix|^Week/i.test(line)) continue;
      narr.push(line);
    }
    if(narr.length>=2){n.description=narr[0];n.background=narr.slice(1).join(' ');}
    else if(narr.length===1) n.description=narr[0];
  }
  calcDerived(n);
  n.statComplete=n.agility>0&&Object.keys(n.skills).length>0;
  n.narrativeComplete=!!(n.description||n.quote);
  return n;
}

function calcDerived(n){
  var CF=window.CharacterForge;
  var ancestryData=(CF&&CF.data&&CF.data.ancestries&&CF.data.ancestries[n.ancestry])||{pace:6,size:0,toughMod:0};
  var d=window.SWADERules?window.SWADERules.calcDerived(
    {agility:n.agility,smarts:n.smarts,spirit:n.spirit,strength:n.strength,vigor:n.vigor},
    n.skills, ancestryData, []
  ):{pace:6,parry:2,toughness:5,armor:0};
  n.pace=d.pace; n.parry=d.parry; n.toughness=d.toughness+(n.toughnessArmor||0);
  n.bennies=n.tier==='Wild Card'?3:0;
}

// saveOverride and saveCustomNPC removed ‚Äî replaced by saveCharacter with Gist sync
function d(v){return v<=0?'‚Äî':v<=12?'d'+v:'d12+'+(v-12);}
const DIE_STEPS=[4,6,8,10,12];
function dieStepUp(v,capped){if(v<4)return 4;if(v<12){const i=DIE_STEPS.indexOf(v);return i>=0&&i<4?DIE_STEPS[i+1]:12;}if(capped)return 12;return v+1;}
function dieStepDown(v){if(v>12)return v-1;const i=DIE_STEPS.indexOf(v);return i>0?DIE_STEPS[i-1]:4;}
function isPregen(){return currentNPC&&currentNPC.category==='Pre-gen';}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function csvToList(s){return s?s.split(',').map(x=>x.trim()).filter(x=>x):[];}

function getCatalogueEdges(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.edges) CF.data.edges.forEach(e=>all.push({...e,source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{if(m.edges)m.edges.forEach(e=>all.push({...e,source:m.name||m.id}));});
  return all;
}
function getCatalogueHindrances(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.hindrances) CF.data.hindrances.forEach(h=>all.push({...h,source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{if(m.hindrances)m.hindrances.forEach(h=>all.push({...h,source:m.name||m.id}));});
  return all;
}
function getCatalogueWeapons(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.gear?.melee) CF.data.gear.melee.forEach(w=>all.push({...w,type:'Melee',source:'Core'}));
  if(CF.data?.gear?.ranged) CF.data.gear.ranged.forEach(w=>all.push({...w,type:'Ranged',source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{
    if(m.gear?.melee) m.gear.melee.forEach(w=>all.push({...w,type:'Melee',source:m.name||m.id}));
    if(m.gear?.ranged) m.gear.ranged.forEach(w=>all.push({...w,type:'Ranged',source:m.name||m.id}));
  });
  return all;
}
function getCatalogueArmour(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.gear?.armor) CF.data.gear.armor.forEach(a=>all.push({...a,type:'Armour',source:'Core'}));
  if(CF.data?.gear?.shields) CF.data.gear.shields.forEach(s=>all.push({...s,type:'Shield',source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{
    if(m.gear?.armor) m.gear.armor.forEach(a=>all.push({...a,type:'Armour',source:m.name||m.id}));
    if(m.gear?.shields) m.gear.shields.forEach(s=>all.push({...s,type:'Shield',source:m.name||m.id}));
  });
  return all;
}
function getCatalogueSkills(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.skillLinks) Object.entries(CF.data.skillLinks).forEach(([name,attr])=>all.push({name,attr,source:'Core',summary:(CF.data.skillDescs&&CF.data.skillDescs[name])||'',core:(CF.data.coreSkills||[]).includes(name)}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{
    if(m.skillLinks) Object.entries(m.skillLinks).forEach(([name,attr])=>{if(!all.find(s=>s.name===name))all.push({name,attr,source:m.name||m.id,summary:(m.skillDescs&&m.skillDescs[name])||'',core:false});});
  });
  return all.sort((a,b)=>a.name.localeCompare(b.name));
}
function getCataloguePowers(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.powers) CF.data.powers.forEach(p=>all.push({...p,source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{
    if(m.powers) m.powers.forEach(p=>all.push({...p,source:m.name||m.id}));
  });
  return all;
}
function getCatalogueGear(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.gear?.general) CF.data.gear.general.forEach(g=>all.push({...g,source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{
    if(m.gear?.general) m.gear.general.forEach(g=>all.push({...g,source:m.name||m.id}));
  });
  return all;
}
function parseGearInto(n){
  if(!n.gearText) return;
  const items=n.gearText.split(',').map(g=>g.trim()).filter(g=>g);
  const catW=getCatalogueWeapons(), catA=getCatalogueArmour();
  const remaining=[];
  items.forEach(item=>{
    const normItem=item.toLowerCase().replace(/\s*\([^)]*\)/g,'').trim();
    const wMatch=catW.find(w=>normItem.includes(w.name.toLowerCase().split('(')[0].trim()));
    if(wMatch){n.weapons.push({name:wMatch.name,damage:wMatch.dmg,ap:wMatch.ap||0,range:wMatch.range||'',rof:wMatch.rof||0,notes:wMatch.notes||'',source:wMatch.source});return;}
    const aMatch=catA.find(a=>normItem.includes(a.name.toLowerCase().split('(')[0].trim()));
    if(aMatch){n.armour.push({name:aMatch.name,armor:aMatch.armor||aMatch.parry||0,parry:aMatch.parry||0,notes:aMatch.notes||'',source:aMatch.source});return;}
    remaining.push(item);
  });
  n.gearText=remaining.join(', ');
}

function getFilteredNPCs(){
  const search=document.getElementById('searchInput').value.toLowerCase();
  const region=document.getElementById('regionFilter').value;
  const tier=document.getElementById('tierFilter').value;
  const cat=document.getElementById('categoryFilter').value;
  const lf=document.getElementById('lifecycleFilter')?.value||'';
  const pf=document.getElementById('productFilter')?.value||'';
  return allNPCs.filter(n=>{
    if(cat&&(n.category||'NPC')!==cat)return false;
    if(region&&n.region!==region)return false;
    if(tier&&n.tier!==tier)return false;
    if(search&&!n.name.toLowerCase().includes(search)&&!(n.concept||'').toLowerCase().includes(search))return false;
    if(lf){
      const lc=getLifecycle(n.name);
      const dirty=isCharDirty(n.name);
      if(lf==='draft'&&lc!=='draft')return false;
      if(lf==='committed'&&lc!=='committed')return false;
      if(lf==='published'&&lc!=='published')return false;
      if(lf==='dirty'&&!dirty)return false;
      if(lf==='errata'&&!(lc==='published'&&dirty))return false;
    }
    if(pf){
      const prod=_productRegistry.products.find(p=>p.code===pf);
      if(!prod||!(prod.characters||[]).includes(n.name))return false;
    }
    return true;
  });
}

function refreshProductFilter(){
  const sel=document.getElementById('productFilter');
  const row=document.getElementById('productFilterRow');
  if(!sel||!row)return;
  const products=_productRegistry.products||[];
  if(!products.length){row.style.display='none';return;}
  row.style.display='';
  const cur=sel.value;
  sel.innerHTML='<option value="">All Products</option>'+products.map(p=>{
    const icon=p.status==='released'?'üîí':p.status==='in-review'?'‚è≥':'üìù';
    return `<option value="${esc(p.code)}">${icon} ${esc(p.code)} ‚Äî ${esc(p.title)}</option>`;
  }).join('');
  if(cur)sel.value=cur;
}

function headerFilter(type,value){
  // Reset all filters first
  document.getElementById('categoryFilter').value='';
  document.getElementById('regionFilter').value='';
  document.getElementById('lifecycleFilter').value='';
  document.getElementById('searchInput').value='';
  const pf=document.getElementById('productFilter');if(pf)pf.value='';
  // Set the target filter
  if(type==='category') document.getElementById('categoryFilter').value=value;
  else if(type==='lifecycle') document.getElementById('lifecycleFilter').value=value;
  filterNPCs();
}

function filterNPCs(){
  renderNPCList(getFilteredNPCs());
}

function getVisualOrder(){
  const npcs=getFilteredNPCs();
  const sortByRef=(a,b)=>{if(!a.refCode&&!b.refCode)return a.name.localeCompare(b.name);if(!a.refCode)return 1;if(!b.refCode)return -1;return a.refCode.localeCompare(b.refCode);};
  const pregens=npcs.filter(n=>(n.category||'NPC')==='Pre-gen').sort(sortByRef);
  const npcWC=npcs.filter(n=>(n.category||'NPC')!=='Pre-gen'&&n.tier==='Wild Card').sort(sortByRef);
  const npcExt=npcs.filter(n=>(n.category||'NPC')!=='Pre-gen'&&n.tier==='Extra').sort(sortByRef);
  const npcWalk=npcs.filter(n=>(n.category||'NPC')!=='Pre-gen'&&n.tier==='Walk-on').sort(sortByRef);
  return [...pregens,...npcWC,...npcExt,...npcWalk];
}

document.addEventListener('keydown',function(e){
  if(!currentNPC)return;
  if(e.key!=='ArrowUp'&&e.key!=='ArrowDown')return;
  const tag=document.activeElement?.tagName;
  if(tag==='INPUT'||tag==='TEXTAREA'||tag==='SELECT')return;
  e.preventDefault();
  const list=getVisualOrder();
  const idx=list.findIndex(n=>n.name===currentNPC.name);
  if(idx<0)return;
  const next=e.key==='ArrowUp'?idx-1:idx+1;
  if(next<0||next>=list.length)return;
  selectNPC(list[next].name);
  const item=document.querySelectorAll('.npc-item')[next];
  if(item)item.scrollIntoView({block:'nearest'});
});

function renderNPCList(npcs){
  const el=document.getElementById('npcList');
  if(!npcs.length){el.innerHTML='<div style="padding:20px;text-align:center;color:var(--text-dim)">No characters found</div>';return;}
  const sortByRef=(a,b)=>{if(!a.refCode&&!b.refCode)return a.name.localeCompare(b.name);if(!a.refCode)return 1;if(!b.refCode)return -1;return a.refCode.localeCompare(b.refCode);};
  const pregens=npcs.filter(n=>(n.category||'NPC')==='Pre-gen').sort(sortByRef);
  const npcWC=npcs.filter(n=>(n.category||'NPC')!=='Pre-gen'&&n.tier==='Wild Card').sort(sortByRef);
  const npcExt=npcs.filter(n=>(n.category||'NPC')!=='Pre-gen'&&n.tier==='Extra').sort(sortByRef);
  const npcWalk=npcs.filter(n=>(n.category||'NPC')!=='Pre-gen'&&n.tier==='Walk-on').sort(sortByRef);
  function renderItem(n){
    const tc=n.tier==='Wild Card'?'wc':n.tier==='Walk-on'?'walkon':'extra';
    const tl=n.tier==='Wild Card'?'WC':n.tier==='Walk-on'?'W-O':'EXT';
    const catTag=(n.category||'NPC')==='Pre-gen'?'<span class="tier-tag pregen">PG</span>':'<span class="tier-tag npc">NPC</span>';
    const act=currentNPC&&currentNPC.name===n.name?'active':'';
    const title=n.concept?` ‚Äî ${n.concept}`:'';
    const audit=runBuildAudit(n);
    const legal=audit.every(r=>r.pass);
    const hasWarns=audit.some(r=>r.warn);
    const legalIcon=n.agility>0?(legal?(hasWarns?'<span style="font-size:12px;margin-left:4px" title="Build Legal ‚Äî optimisation warnings">‚ö†Ô∏è</span>':'<span style="font-size:12px;margin-left:4px" title="Build Legal">‚úÖ</span>'):'<span style="font-size:12px;margin-left:4px" title="Build Issues">‚ùå</span>'):'<span style="font-size:12px;margin-left:4px;opacity:0.4" title="No stats">‚¨ú</span>';
    const canonIcon=canonCommitted.has(n.name)?'<span style="font-size:11px;margin-left:3px" title="Committed to Canon">üì¶</span>':'';
    const dirty=isCharDirty(n.name);
    const lifecycle=getLifecycle(n.name);
    let dirtyClass='',dirtyBadge='';
    if(dirty){
      if(lifecycle==='published'){dirtyClass='dirty-published';dirtyBadge='<span class="dirty-badge published" title="Published character ‚Äî changes pending review">ERRATA</span>';}
      else if(lifecycle==='committed'){dirtyClass='dirty-committed';dirtyBadge='<span class="dirty-badge committed" title="Committed character ‚Äî changes pending review">EDITED</span>';}
      else{dirtyClass='dirty-draft';dirtyBadge='<span class="dirty-badge draft" title="Draft ‚Äî unsaved changes">DRAFT</span>';}
    }
    return `<div class="npc-item ${act} ${dirtyClass}" onclick="selectNPC('${esc(n.name).replace(/'/g,"\\'")}')">
      <div class="npc-name">${esc(n.name)}${catTag}<span class="tier-tag ${tc}">${tl}</span>${legalIcon}${canonIcon}${dirtyBadge}
        <span class="status-dots" title="Stats / Narrative / FG">
          <span class="status-dot ${n.statComplete?'on':'off'}"></span>
          <span class="status-dot ${n.narrativeComplete?'on':'off'}"></span>
          <span class="status-dot ${n.fgReady?'on':'off'}"></span>
        </span></div>
      <div class="npc-meta">${n.refCode?'<span style="font-family:monospace;font-size:10px;color:var(--accent);margin-right:6px">'+esc(n.refCode)+'</span>':''}${esc(n.region)}${esc(title)}</div></div>`;
  }
  let html='';
  if(pregens.length){html+=`<div class="list-section-header">Pre-gens (${pregens.length})</div>`;html+=pregens.map(renderItem).join('');}
  if(npcWC.length){html+=`<div class="list-section-header">NPCs ‚Äî Wild Cards (${npcWC.length})</div>`;html+=npcWC.map(renderItem).join('');}
  if(npcExt.length){html+=`<div class="list-section-header">NPCs ‚Äî Extras (${npcExt.length})</div>`;html+=npcExt.map(renderItem).join('');}
  if(npcWalk.length){html+=`<div class="list-section-header">NPCs ‚Äî Walk-ons (${npcWalk.length})</div>`;html+=npcWalk.map(renderItem).join('');}
  el.innerHTML=html;
}

function updateHeaderStats(){
  const t=allNPCs.length,pg=allNPCs.filter(n=>(n.category||'NPC')==='Pre-gen').length,np=t-pg;
  const c=allNPCs.filter(n=>n.statComplete&&n.narrativeComplete).length,f=allNPCs.filter(n=>n.fgReady).length;
  const cn=allNPCs.filter(n=>canonCommitted.has(n.name)).length;
  const dc=getDirtyCount();
  const dirtySpan=dc>0?`<span style="cursor:pointer;border-bottom:1px dotted #e8b84e;padding-bottom:1px" onclick="showReviewPanel()" title="Click to review changes"><span class="stat-num" style="color:#e8b84e">${dc}</span> ‚úèÔ∏è Pending</span>`:'';
  const hdrLink='cursor:pointer;border-bottom:1px dotted var(--text-dim);padding-bottom:1px';
  document.getElementById("headerStats").innerHTML=`<span style="${hdrLink}" onclick="headerFilter('category','Pre-gen')" title="Filter to Pre-gens"><span class="stat-num">${pg}</span> Pre-gens</span><span style="${hdrLink}" onclick="headerFilter('category','NPC')" title="Filter to NPCs"><span class="stat-num">${np}</span> NPCs</span><span style="${hdrLink}" onclick="headerFilter('lifecycle','committed')" title="Filter to committed characters"><span class="stat-num">${cn}</span> üì¶ Canon</span>${dirtySpan}<span style="${hdrLink}" onclick="showStatusView()" title="Open production status"><span class="stat-num">${c}</span> Complete</span><span style="${hdrLink}" onclick="showStatusView()" title="Open production status"><span class="stat-num">${f}</span> FG Ready</span>`;
}

function selectNPC(name){flushSave();currentNPC=allNPCs.find(n=>n.name===name);if(!currentNPC)return;currentNPC._lockAcknowledged=false;_undoStack=[];_redoStack=[];_lastSnapshot=_snap(currentNPC);activePanel='audit';renderDetail();filterNPCs();navPush({type:'character',name:name});updateBreadcrumb();}

function renderDetail(){
  const n=currentNPC;if(!n)return;
  const el=document.getElementById('mainContent');
  el.classList.remove('empty-state');el.style.overflowY='hidden';
  const ancestryTag=n.ancestry&&n.ancestry!=='Human'?` ¬∑ ${esc(n.ancestry)}`:'';
  const titleLine=n.concept?`<div class="npc-title-line">${esc(n.concept)}${ancestryTag}</div>`:(n.ancestry?`<div class="npc-title-line">${esc(n.ancestry)}</div>`:'');
  const canonBadge=canonCommitted.has(n.name)?'<span style="font-size:13px;margin-left:10px;color:var(--green)" title="Committed to Canon">üì¶ In Canon</span>':'<span style="font-size:13px;margin-left:10px;color:var(--text-dim)" title="Not yet committed">üì¶ Not in Canon</span>';
  const pubProds=getPublishedProducts(n.name);
  const pubBadge=pubProds.length?'<span style="font-size:13px;margin-left:10px;color:var(--green)" title="Published in: '+pubProds.map(p=>p.code).join(', ')+'">üîí Published</span>':'';
  const dirtyBadge=isCharDirty(n.name)?'<span style="font-size:13px;margin-left:10px;color:#e8b84e" title="Changes pending review">‚úèÔ∏è Edited</span>':'';
  const catBadge=(n.category||'NPC')==='Pre-gen'?'<span class="tier-tag pregen" style="margin-left:10px;font-size:11px;padding:2px 8px">PRE-GEN</span>':'<span class="tier-tag npc" style="margin-left:10px;font-size:11px;padding:2px 8px">NPC</span>';
  const tierBadgeClass=n.tier==='Wild Card'?'wc':n.tier==='Walk-on'?'walkon':'extra';
  const tierBadgeText=n.tier==='Wild Card'?'WILD CARD':n.tier==='Walk-on'?'WALK-ON':'EXTRA';
  const tierBadge='<span class="tier-tag '+tierBadgeClass+'" style="margin-left:6px;font-size:11px;padding:2px 8px">'+tierBadgeText+'</span>';
  const refBadge=n.refCode?`<span style="font-family:monospace;font-size:11px;color:var(--text-dim);margin-right:8px;background:var(--bg-card);padding:2px 6px;border-radius:3px;border:1px solid var(--border)">${esc(n.refCode)}</span>`:'';
  const allProds=_productRegistry.products.filter(p=>(p.characters||[]).includes(n.name));
  const prodLine=allProds.length?`<div style="font-size:11px;color:var(--text-dim);margin-top:2px;margin-bottom:4px">${allProds.map(p=>{
    const col=p.status==='released'?'var(--green)':p.status==='in-review'?'#e8b84e':'var(--text-dim)';
    const icon=p.status==='released'?'üîí':p.status==='in-review'?'‚è≥':'üìù';
    return '<span style="margin-right:10px;color:'+col+'">'+icon+' '+esc(p.code)+' ‚Äî '+esc(p.title)+'</span>';
  }).join('')}</div>`:'';
  el.innerHTML=`<div class="npc-header"><h2>${refBadge}${esc(n.name)}${catBadge}${tierBadge}${canonBadge}${pubBadge}${dirtyBadge}</h2>${titleLine}${prodLine}</div><div class="detail-columns"><div class="col-stats" id="colStats"></div><div class="col-middle" id="colMiddle"></div><div class="col-narrative" id="colNarrative"></div></div>`;
  renderStatColumn(n);renderMiddleColumn(n);renderNarrativeColumn(n);
}

function renderStatColumn(n){
  const el=document.getElementById('colStats');
  const wcStar=n.tier==='Wild Card'?' ‚òÖ':'';
  const tierText=n.tier==='Wild Card'?'WILD CARD':n.tier.toUpperCase();
  const auditResults=runBuildAudit(n);
  const isLegal=auditResults.every(r=>r.pass);
  const warnCount=auditResults.filter(r=>r.warn).length;
  const warnTag=isLegal&&warnCount>0?` <span style="color:#e6a117">¬∑ ${warnCount} ‚ö†</span>`:'';
  const legalBadge=`<span class="build-legal-badge ${isLegal?'':'invalid'}" onclick="showPanel('audit')">${isLegal?'‚úì Build Legal':'‚úó Issues'}${warnTag}</span>`;
  const attrStr=`Agility ${d(n.agility)}, Smarts ${d(n.smarts)}, Spirit ${d(n.spirit)}, Strength ${d(n.strength)}, Vigor ${d(n.vigor)}`;
  const _coreSkills=(window.CharacterForge?.data?.coreSkills||[]).map(s=>s.toLowerCase());
  const skillStr=Object.entries(n.skills).map(([k,v])=>`${k}${_coreSkills.includes(k.toLowerCase())?'<span style="color:var(--accent)"> ‚òÖ</span>':''} ${d(v)}`).join(', ')||'<span style="color:var(--text-dim)">None</span>';
  const fDie=n.skills['Fighting']||0;
  const expParry=fDie>0?2+Math.floor(fDie/2):2;
  const expTough=2+(n.vigor>0?Math.floor(n.vigor/2):0)+(n.toughnessArmor||0);
  const paceCol=n.pace===6?'var(--green)':'var(--red)';
  const parryCol=n.parry===expParry?'var(--green)':'var(--red)';
  const toughCol=n.toughness===expTough?'var(--green)':'var(--red)';
  const toughDisp=n.toughnessArmor>0?`${n.toughness} (${n.toughnessArmor})`:`${n.toughness}`;
  const benniesItem=n.tier==='Wild Card'?`<div class="derived-item"><div class="derived-num">${n.bennies}</div><div class="derived-label">Bennies</div></div>`:'';
  const hindStr=n.hindrances.length?n.hindrances.map(h=>esc(h)).join(', '):'None';
  const edgeStr=n.edges.length?n.edges.map(e=>esc(e)).join(', '):'None';
  let statsHTML='';
  if(n.agility>0){
    statsHTML=`<div class="stat-block-panel"><div class="panel-header"><span class="tier-label">${tierText}${wcStar} ¬∑ ${esc(n.ancestry||'?')}</span>${legalBadge}</div>
    <div class="stat-section"><div class="stat-section-label" onclick="showPanel('edit')">Attributes <span class="edit-icon">‚úé</span></div><div class="stat-val">${attrStr}</div></div>
    <div class="stat-section"><div class="stat-section-label" onclick="showPanel('skills')">Skills <span class="edit-icon">‚úé</span></div><div class="stat-val">${skillStr}</div></div>
    <div class="derived-row">
      <div class="derived-item" title="Base 6"><div class="derived-num" style="color:${paceCol}">${n.pace}</div><div class="derived-label">Pace</div></div>
      <div class="derived-item" title="2 + Fighting ${d(fDie)}/2 = ${expParry}"><div class="derived-num" style="color:${parryCol}">${n.parry}</div><div class="derived-label">Parry</div></div>
      <div class="derived-item" title="2 + Vigor ${d(n.vigor)}/2 = ${expTough}"><div class="derived-num" style="color:${toughCol}">${toughDisp}</div><div class="derived-label">Toughness</div></div>
      ${benniesItem}</div>
    <div class="stat-section" style="font-size:12px"><span style="color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;font-size:10px">Hindrances</span><div class="stat-val">${hindStr}</div></div>
    <div class="stat-section" style="font-size:12px"><span style="color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;font-size:10px">Edges</span><div class="stat-val">${edgeStr}</div></div></div>`;
  } else {
    statsHTML=`<div class="stat-block-panel"><div class="panel-header"><span class="tier-label">${tierText} ¬∑ ${esc(n.ancestry||'?')}</span></div><div style="color:var(--text-dim);font-size:13px">No attributes set. <button class="btn sm" onclick="showPanel('edit')">Edit NPC</button></div></div>`;
  }
  const hindBox=buildSectionBox('Hindrances','hindrances',n.hindrances,h=>`<div class="item-entry">${esc(h)}</div>`);
  const edgeBox=buildSectionBox('Edges','edges',n.edges,e=>{const leg=isLegacyEdge(e)?' <span class="legacy-tag">(legacy)</span>':'';return `<div class="item-entry">${esc(e)}${leg}</div>`;});
  const armourBox=buildSectionBox('Armour','armour',n.armour,a=>`<div class="item-entry">${esc(a.name)} <span style="color:var(--accent)">(+${a.armor})</span></div>`);
  const weaponBox=buildSectionBox('Weapons','weapons',n.weapons,w=>`<div class="item-entry">${esc(w.name)} <span style="color:var(--text-dim)">${esc(w.damage)}${w.ap?' AP'+w.ap:''}${w.range?' '+w.range:''}</span></div>`);
  const powersBox=buildSectionBox('Powers','powers',n.powers,p=>`<div class="item-entry">${esc(p)}</div>`);
  const gearItems=n.gearText?n.gearText.split(',').map(g=>g.trim()).filter(g=>g):[];
  const gearBox=buildSectionBox('Gear','gear',gearItems,g=>`<div class="item-entry">${esc(g)}</div>`);
  el.innerHTML=`<div class="col-stats-scroll">${statsHTML}<div class="section-box-pair">${hindBox}${edgeBox}</div><div class="section-box-pair">${armourBox}${weaponBox}</div><div class="section-box-pair">${powersBox}${gearBox}</div></div>`;
  renderBottomBar(n);
}

function renderBottomBar(n){
  const bar=document.getElementById('charBottomBar');
  if(!n){bar.style.display='none';return;}
  const inCanon=canonCommitted.has(n.name);
  const audit=runBuildAudit(n);const legal=audit.every(r=>r.pass);
  const commitLabel=inCanon?'üîÑ Update Canon':'üì¶ Commit to Canon';
  const legalLabel=legal?'<span style="color:var(--green)">‚úÖ Build legal ‚Äî ready to commit</span>':'<span style="color:var(--red)">‚ùå Build has issues</span>';
  bar.style.display='';
  bar.innerHTML=`<div class="status-bar"><div class="status-row">
    <label><input type="checkbox" ${n.statComplete?'checked':''} onchange="toggleStatus('statComplete',this.checked)"> Stats</label>
    <label><input type="checkbox" ${n.narrativeComplete?'checked':''} onchange="toggleStatus('narrativeComplete',this.checked)"> Narrative</label>
    <label><input type="checkbox" ${n.fgReady?'checked':''} onchange="toggleStatus('fgReady',this.checked)"> FG Ready</label></div>
    <div class="action-btns"><button class="btn sm" onclick="showPanel('edit')">Edit</button><button class="btn sm" onclick="showPanel('statblock')">Stat Block</button><button class="btn sm" onclick="showPanel('audit')">Audit</button><button class="btn sm" onclick="showPanel('transfer')" style="color:var(--accent)">Import / Export</button><button class="btn sm danger" onclick="deleteNPC()">Delete</button></div>
    <div class="commit-area"><button class="btn primary" onclick="showPanel('audit');setTimeout(prepareCommit,100)" title="${inCanon?'Update canonical data':'Commit to canon'}">${commitLabel}</button>${legalLabel}</div>
  </div>`;
}
function hideBottomBar(){const bar=document.getElementById('charBottomBar');if(bar)bar.style.display='none';}

function buildSectionBox(title,panel,items,renderItem,isLegacy){
  const content=items.length?items.map(renderItem).join('')+(isLegacy?'<div class="legacy-tag" style="margin-top:4px">Legacy</div>':''):'<div class="none-text">None</div>';
  return `<div class="section-box"><h3 onclick="showPanel('${panel}')">${title} <span class="edit-icon">‚úé</span></h3>${content}</div>`;
}
function isLegacyEdge(name){if(name.startsWith('Arcane Background ('))return false;return !getCatalogueEdges().find(e=>e.name===name);}

function renderMiddleColumn(n){
  const el=document.getElementById('colMiddle');
  if(!activePanel){
    el.innerHTML=`<div class="middle-panel"><div class="middle-default"><div class="hint">Click any panel heading to edit</div><div class="quick-links">
      <a onclick="showPanel('weapons')">Weapons ‚úé</a><a onclick="showPanel('armour')">Armour ‚úé</a><a onclick="showPanel('gear')">Gear ‚úé</a>
      <a onclick="showPanel('hindrances')">Hindrances ‚úé</a><a onclick="showPanel('edges')">Edges ‚úé</a><a onclick="showPanel('powers')">Powers ‚úé</a></div></div></div>`;
    return;
  }
  const panelNames={edit:'Edit',hindrances:'Hindrances',edges:'Edges',skills:'Skills',weapons:'Weapons',armour:'Armour',gear:'Gear',powers:'Powers',narrative:'Narrative',statblock:'Stat Block',audit:'Build Audit',transfer:'Import / Export'};
  const editPanels=['edit','hindrances','edges','skills','weapons','armour','gear','powers','narrative'];
  const lockBanner=isLocked(n.name)&&editPanels.includes(activePanel)?'<div class="lock-warning" style="margin-bottom:8px">üîí This character is published. Changes will be flagged as errata and require review approval.</div>':'';
  const undoCount=_undoStack.length;
  const redoCount=_redoStack.length;
  const undoStyle=undoCount>0?'color:var(--accent);border-color:var(--accent)':'color:var(--text-dim);border-color:var(--border);opacity:0.4;cursor:default';
  const redoStyle=redoCount>0?'color:var(--accent);border-color:var(--accent)':'color:var(--text-dim);border-color:var(--border);opacity:0.4;cursor:default';
  let undoBar='';
  if(editPanels.includes(activePanel)){
    const depthLabel=undoCount+redoCount>0?'<span style="font-size:10px;color:var(--text-dim)" title="'+undoCount+' undo / '+redoCount+' redo">'+undoCount+'/'+redoCount+'</span>':'';
    undoBar='<div style="display:flex;gap:4px;align-items:center;margin-left:auto;margin-right:8px">'
      +'<button class="btn sm" onclick="undo()" style="'+undoStyle+'" title="Undo (Ctrl+Z)">‚Ü∂</button>'
      +'<button class="btn sm" onclick="redo()" style="'+redoStyle+'" title="Redo (Ctrl+Y)">‚Ü∑</button>'
      +depthLabel+'</div>';
  }
  el.innerHTML=`<div class="middle-panel"><div class="panel-title"><h3>${panelNames[activePanel]||activePanel}</h3>${undoBar}<button class="btn" onclick="closePanel()">‚úï Done</button></div>${lockBanner}<div id="panelContent"></div></div>`;
  const panels={edit:renderEditPanel,hindrances:renderHindrancesPanel,edges:renderEdgesPanel,skills:renderSkillsPanel,weapons:renderWeaponsPanel,armour:renderArmourPanel,gear:renderGearPanel,powers:renderPowersPanel,narrative:renderNarrativePanel,statblock:renderStatBlockPanel,audit:renderAuditPanel};
  const panels2={transfer:renderTransferPanel};
if(panels[activePanel]) panels[activePanel](n);
else if(panels2[activePanel]) panels2[activePanel](n);
}

function showPanel(name){
  const editPanels=['edit','hindrances','edges','skills','weapons','armour','gear','powers','narrative'];
  if(currentNPC&&editPanels.includes(name)&&isLocked(currentNPC.name)){
    if(!currentNPC._lockAcknowledged){
      if(!checkEditLock(currentNPC.name))return;
      currentNPC._lockAcknowledged=true;
    }
  }
  activePanel=name;if(currentNPC){renderMiddleColumn(currentNPC);renderStatColumn(currentNPC);}updateBreadcrumb();
}
function closePanel(){activePanel=null;if(currentNPC)renderDetail();updateBreadcrumb();}

function renderNarrativeColumn(n){
  const el=document.getElementById('colNarrative');
  const quote=n.quote?`<div class="npc-quote">"${esc(n.quote)}"</div>`:'';
  const desc=n.description?`<div class="narrative-section"><h4 onclick="showPanel('narrative')">Description <span class="edit-icon">‚úé</span></h4><p>${esc(n.description)}</p></div>`:'';
  const bg=n.background?`<div class="narrative-section"><h4 onclick="showPanel('narrative')">Background <span class="edit-icon">‚úé</span></h4><p>${esc(n.background)}</p></div>`:'';
  let storyParts=[];
  if(n.motivation)storyParts.push(`<p><strong>What They Want:</strong> ${esc(n.motivation)}</p>`);
  if(n.secret)storyParts.push(`<p><strong>Their Secret:</strong> ${esc(n.secret)}</p>`);
  if(n.services)storyParts.push(`<p><strong>Services:</strong> ${esc(n.services)}</p>`);
  if(n.adventureHook)storyParts.push(`<p><strong>Adventure Hook:</strong> ${esc(n.adventureHook)}</p>`);
  if(n.tactics)storyParts.push(`<p><strong>Tactics:</strong> ${esc(n.tactics)}</p>`);
  const story=storyParts.length?`<div class="narrative-section"><h4 onclick="showPanel('narrative')">Story <span class="edit-icon">‚úé</span></h4>${storyParts.join('')}</div>`:'';
  el.innerHTML=`<div class="portrait-box">No portrait</div><div class="portrait-actions"><a>‚ú¶ Generate</a> <a>Upload</a></div>${quote}${desc}${bg}${story}`;
}

// ‚ïê‚ïê‚ïê EDITOR PANELS ‚ïê‚ïê‚ïê
function renderEditPanel(n){
  const el=document.getElementById('panelContent');
  const dieSel=(id,val)=>{return `<div style="display:flex;align-items:center;gap:4px"><button class="btn sm" onclick="stepAttr('${id}',-1)" style="padding:1px 6px;font-size:13px;min-width:22px">‚àí</button><span id="${id}" data-val="${val}" style="display:inline-block;min-width:36px;text-align:center;font-weight:bold;font-size:14px">${d(val)}</span><button class="btn sm" onclick="stepAttr('${id}',1)" style="padding:1px 6px;font-size:13px;min-width:22px">+</button></div>`;};
  el.innerHTML=`
    <div class="form-row"><div class="form-group" style="max-width:140px"><label>Ref Code</label><input id="ed_refCode" value="${esc(n.refCode||'')}" placeholder="AM-C001" style="font-family:monospace;font-size:13px;letter-spacing:0.5px"></div><div class="form-group"><label>Name *</label><input id="ed_name" value="${esc(n.name)}"></div><div class="form-group"><label>Title / Role</label><input id="ed_concept" value="${esc(n.concept)}"></div></div>
    <div class="form-row">
      <div class="form-group"><label>Region *</label><select id="ed_region">${['Ammaria','Saltlands','Vinlands','Concordium','Glasrya','Global'].map(r=>`<option ${n.region===r?'selected':''}>${r}</option>`).join('')}</select></div>
      <div class="form-group"><label>Tier *</label><select id="ed_tier">${['Wild Card','Extra','Walk-on'].map(t=>`<option ${n.tier===t?'selected':''}>${t}</option>`).join('')}</select></div>
      <div class="form-group"><label>Category</label><select id="ed_category">${['Pre-gen','NPC'].map(c=>`<option ${(n.category||'NPC')===c?'selected':''}>${c}</option>`).join('')}</select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Gender</label><select id="ed_gender">${['Unspecified','Male','Female','Other'].map(g=>`<option>${g}</option>`).join('')}</select></div>
      <div class="form-group"><label>Ancestry</label><select id="ed_ancestry">${['Human','Dwarf','Elf','Half-Folk','Other'].map(a=>`<option ${n.ancestry===a?'selected':''}>${a}</option>`).join('')}</select></div>
    </div>
    <div class="form-group"><label>Signature Quote</label><input id="ed_quote" value="${esc(n.quote)}"></div>
    <div class="form-group"><label>Description</label><textarea id="ed_description" rows="3">${esc(n.description)}</textarea></div>
    <div class="form-group"><label>Background</label><textarea id="ed_background" rows="3">${esc(n.background)}</textarea></div>
    <div class="form-row"><div class="form-group"><label>Agility</label>${dieSel('ed_agility',n.agility)}</div><div class="form-group"><label>Smarts</label>${dieSel('ed_smarts',n.smarts)}</div><div class="form-group"><label>Spirit</label>${dieSel('ed_spirit',n.spirit)}</div><div class="form-group"><label>Strength</label>${dieSel('ed_strength',n.strength)}</div><div class="form-group"><label>Vigor</label>${dieSel('ed_vigor',n.vigor)}</div></div>
    <div class="form-row"><div class="form-group"><label>Pace</label><input id="ed_pace" type="number" value="${n.pace}"></div><div class="form-group"><label>Parry</label><input id="ed_parry" type="number" value="${n.parry}"></div><div class="form-group"><label>Toughness</label><input id="ed_toughness" type="number" value="${n.toughness}"></div><div class="form-group"><label>Tough (Armor)</label><input id="ed_tougharmor" type="number" value="${n.toughnessArmor}"></div><div class="form-group"><label>Bennies</label><input id="ed_bennies" type="number" value="${n.bennies}"></div></div>
    <div class="form-row"><div class="form-group"><label>Starting Funds (‚Ç°)</label><input id="ed_startFunds" type="number" value="${n.startingFunds}"></div><div class="form-group"><label>Gear Cost (‚Ç°)</label><input id="ed_gearCost" type="number" value="${n.gearCost}"></div><div class="form-group"><label>Remaining</label><span style="font-weight:bold;color:${n.startingFunds-n.gearCost>=0?'var(--green)':'var(--red)'}">${n.startingFunds-n.gearCost}‚Ç°</span></div></div>
    <div class="form-group"><label>Edges (legacy, comma-separated)</label><input id="ed_edges" value="${esc(n.edges.join(', '))}"></div>
    <div class="form-group"><label>Hindrances (legacy, comma-separated)</label><input id="ed_hindrances" value="${esc(n.hindrances.join(', '))}"></div>
    <div class="form-group"><label>Gear</label><input id="ed_gear" value="${esc(n.gearText)}"></div>
    <div class="form-actions"><button class="btn" onclick="closePanel()">Cancel</button><button class="btn primary" onclick="saveEdit()">Save Changes</button></div>`;
}
function saveEdit(){
  const n=currentNPC;
  n.name=document.getElementById('ed_name').value.trim();n.refCode=document.getElementById('ed_refCode').value.trim();n.concept=document.getElementById('ed_concept').value.trim();n.region=document.getElementById('ed_region').value;n.tier=document.getElementById('ed_tier').value;n.category=document.getElementById('ed_category').value;n.ancestry=document.getElementById('ed_ancestry').value;n.quote=document.getElementById('ed_quote').value.trim();n.description=document.getElementById('ed_description').value.trim();n.background=document.getElementById('ed_background').value.trim();
  n.agility=parseInt(document.getElementById('ed_agility').dataset.val);n.smarts=parseInt(document.getElementById('ed_smarts').dataset.val);n.spirit=parseInt(document.getElementById('ed_spirit').dataset.val);n.strength=parseInt(document.getElementById('ed_strength').dataset.val);n.vigor=parseInt(document.getElementById('ed_vigor').dataset.val);
  n.pace=parseInt(document.getElementById('ed_pace').value);n.parry=parseInt(document.getElementById('ed_parry').value);n.toughness=parseInt(document.getElementById('ed_toughness').value);n.toughnessArmor=parseInt(document.getElementById('ed_tougharmor').value);n.bennies=parseInt(document.getElementById('ed_bennies').value);n.startingFunds=parseInt(document.getElementById('ed_startFunds').value)||500;n.gearCost=parseInt(document.getElementById('ed_gearCost').value)||0;
  n.edges=csvToList(document.getElementById('ed_edges').value);n.hindrances=csvToList(document.getElementById('ed_hindrances').value);n.gearText=document.getElementById('ed_gear').value.trim();
  saveCharacter(n);closePanel();updateHeaderStats();
}

function renderHindrancesPanel(n){
  const el=document.getElementById('panelContent');
  const catalogue=getCatalogueHindrances();
  const items=n.hindrances.map((h,i)=>{
    const parsed=parseHindrance(h);
    return `<div class="item-entry" style="padding:4px 0">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="cursor:pointer" onclick="toggleHindNotes(${i})">${esc(parsed.name)} <span style="color:var(--text-dim);font-size:11px">(${esc(parsed.sev)}${parsed.notes?' ‚Äî '+esc(parsed.notes):''})</span></span>
        <button class="btn sm danger" onclick="removeHindrance(this)" data-val="${esc(h)}">√ó</button>
      </div>
      <div id="hindNotes_${i}" style="display:none;margin-top:4px">
        <input id="hindNotesInput_${i}" value="${esc(parsed.notes)}" placeholder="e.g. Wanted by the Brotherhood" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:3px;font-size:12px" onkeydown="if(event.key==='Enter')saveHindNotes(${i})">
        <button class="btn sm" onclick="saveHindNotes(${i})" style="margin-top:4px">Save</button>
      </div>
    </div>`;}).join('');
  el.innerHTML=`<div>${items||'<div style="color:var(--text-dim)">No hindrances yet</div>'}</div>
    <div class="catalogue-section"><h4>Add Hindrance</h4><div style="margin-bottom:4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Pick from Catalogue</div>
    <input type="text" id="hindSearch" placeholder="Search hindrances... (‚Üë‚Üì to browse)" oninput="filterHindCat()" onkeydown="hindCatKeyNav(event)" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:5px 8px;border-radius:3px;font-size:12px;margin-bottom:4px">
    <div style="display:flex;gap:8px;align-items:flex-start">
      <div class="catalogue-list" id="hindCatList" style="flex:1;min-width:0"></div>
      <div id="hindInfo" style="flex:1;min-width:0"></div>
    </div>
    <div class="form-row"><div class="form-group"><label>Name</label><input id="hind_name"></div><div class="form-group" style="max-width:120px"><label>Severity</label><select id="hind_sev"><option>Minor</option><option>Major</option></select></div></div>
    <div class="form-group"><label>Notes</label><input id="hind_notes" placeholder="Optional details"></div>
    <button class="btn primary" onclick="addHindrance()">Add Hindrance</button></div>`;
  filterHindCat();
}
var hindCatIdx=-1;
var hindCatFiltered=[];
function hasHindrance(name,n){
  if(!n)return false;
  return (n.hindrances||[]).some(h=>h.toLowerCase().startsWith(name.toLowerCase()));
}
function filterHindCat(){
  hindCatIdx=-1;
  const s=(document.getElementById('hindSearch')?.value||'').toLowerCase();
  hindCatFiltered=getCatalogueHindrances().filter(h=>!s||h.name.toLowerCase().includes(s));
  const el=document.getElementById('hindCatList');if(!el)return;
  el.innerHTML=hindCatFiltered.map((h,i)=>{const taken=hasHindrance(h.name,currentNPC);return `<div class="catalogue-item" onclick="selectHindInfo(${i})" style="color:${taken?'var(--text-dim)':'var(--green)'}"><span class="cat-name">${esc(h.name)}</span> <span class="cat-detail">(${esc(h.type||h.sev||'Minor')}) ‚Äî ${esc(h.source)}</span></div>`;}).join('');
}
function hindCatKeyNav(e){
  const list=document.getElementById('hindCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');if(!items.length)return;
  if(e.key==='ArrowDown'){e.preventDefault();hindCatIdx=Math.min(hindCatIdx+1,items.length-1);highlightHindCat(items);}
  else if(e.key==='ArrowUp'){e.preventDefault();hindCatIdx=Math.max(hindCatIdx-1,0);highlightHindCat(items);}
  else if(e.key==='Enter'&&hindCatIdx>=0){e.preventDefault();selectHindInfo(hindCatIdx);}
}
function highlightHindCat(items){
  items.forEach((it,i)=>{it.style.background=i===hindCatIdx?'var(--accent)22':'';});
  if(items[hindCatIdx]){items[hindCatIdx].scrollIntoView({block:'nearest'});selectHindInfo(hindCatIdx);}
}
function selectHindInfo(idx){
  const h=hindCatFiltered[idx];if(!h)return;
  hindCatIdx=idx;
  document.getElementById('hind_name').value=h.name;
  document.getElementById('hind_sev').value=(h.type||h.sev||'Minor').includes('Major')?'Major':'Minor';
  const info=document.getElementById('hindInfo');if(!info)return;
  const taken=hasHindrance(h.name,currentNPC);
  const tagStyle=taken?'color:var(--text-dim)':'color:var(--green)';
  const tagText=taken?'Already taken':'Available';
  info.innerHTML=`<div class="cat-info" style="cursor:pointer" onclick="scrollToHindCatItem(${idx})"><div class="ci-name">${esc(h.name)} <span style="font-size:11px;${tagStyle}">${tagText}</span></div><div class="ci-meta">${esc(h.type||h.sev||'Minor')} ¬∑ ${esc(h.source)}</div><div class="ci-desc">${esc(h.summary||'No description available.')}</div></div>`;
  const items=document.getElementById('hindCatList')?.querySelectorAll('.catalogue-item');
  if(items)items.forEach((it,i)=>{it.style.background=i===idx?'var(--accent)22':'';});
  setTimeout(()=>document.getElementById('hindSearch')?.focus(),0);
}
function scrollToHindCatItem(idx){
  const list=document.getElementById('hindCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');
  if(items[idx])items[idx].scrollIntoView({block:'nearest',behavior:'smooth'});
}
function addHindrance(){
  const name=document.getElementById('hind_name').value.trim();if(!name)return;
  const sev=document.getElementById('hind_sev').value;
  const notes=document.getElementById('hind_notes').value.trim();
  currentNPC.hindrances.push(notes?`${name} (${sev} ‚Äî ${notes})`:`${name} (${sev})`);
  saveCharacter(currentNPC);renderHindrancesPanel(currentNPC);renderStatColumn(currentNPC);
}
function removeHindrance(btn){
  const val=btn.dataset.val;currentNPC.hindrances=currentNPC.hindrances.filter(x=>x!==val);
  saveCharacter(currentNPC);renderHindrancesPanel(currentNPC);renderStatColumn(currentNPC);
}
function parseHindrance(str){
  const m=str.match(/^(.+?)\s*\((\w+)(?:\s*‚Äî\s*(.*))?\)\s*$/);
  if(m)return{name:m[1].trim(),sev:m[2],notes:m[3]||''};
  return{name:str,sev:'Minor',notes:''};
}
function toggleHindNotes(idx){
  const el=document.getElementById('hindNotes_'+idx);if(!el)return;
  el.style.display=el.style.display==='none'?'block':'none';
  if(el.style.display==='block')document.getElementById('hindNotesInput_'+idx)?.focus();
}
function saveHindNotes(idx){
  const notes=document.getElementById('hindNotesInput_'+idx)?.value?.trim()||'';
  const parsed=parseHindrance(currentNPC.hindrances[idx]);
  currentNPC.hindrances[idx]=notes?`${parsed.name} (${parsed.sev} ‚Äî ${notes})`:`${parsed.name} (${parsed.sev})`;
  saveCharacter(currentNPC);renderHindrancesPanel(currentNPC);renderStatColumn(currentNPC);
}

function renderEdgesPanel(n){
  if(!n.edgeNotes)n.edgeNotes={};
  const el=document.getElementById('panelContent');
  const items=n.edges.map((e,i)=>{const leg=isLegacyEdge(e)?' <span class="legacy-tag">(legacy)</span>':'';const note=n.edgeNotes[e]||'';const noteDisp=note?` <span style="color:var(--text-dim);font-size:11px">‚Äî ${esc(note)}</span>`:'';return `<div class="item-entry" style="padding:4px 0">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span style="cursor:pointer" onclick="showExistingEdgeInfo('${esc(e)}');toggleEdgeNotes(${i})">${esc(e)}${noteDisp}${leg}</span>
        <button class="btn sm danger" onclick="removeEdge(this)" data-val="${esc(e)}">√ó</button>
      </div>
      <div id="edgeNotes_${i}" style="display:none;margin-top:4px">
        <input id="edgeNotesInput_${i}" value="${esc(note)}" placeholder="e.g. Thieves Guild, Brotherhood contacts" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:3px;font-size:12px" onkeydown="if(event.key==='Enter')saveEdgeNotes(${i})">
        <button class="btn sm" onclick="saveEdgeNotes(${i})" style="margin-top:4px">Save</button>
      </div>
    </div>`;}).join('');
  el.innerHTML=`<div>${items||'<div style="color:var(--text-dim)">No edges yet</div>'}</div>
    <div class="catalogue-section"><h4>Add Edge</h4>
    <input type="text" id="edgeSearch" placeholder="Search edges... (‚Üë‚Üì to browse)" oninput="filterEdgeCat()" onkeydown="edgeCatKeyNav(event)" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:5px 8px;border-radius:3px;font-size:12px;margin-bottom:4px">
    <div style="display:flex;gap:8px;align-items:flex-start">
      <div class="catalogue-list" id="edgeCatList" style="flex:1;min-width:0"></div>
      <div id="edgeInfo" style="flex:1;min-width:0"></div>
    </div>
    <div class="form-group"><label>Name</label><input id="edge_name"></div>
    <button class="btn primary" onclick="addEdge()">Add Edge</button></div>`;
  filterEdgeCat();
}
function filterEdgeCat(){
  edgeCatIdx=-1;
  const s=(document.getElementById('edgeSearch')?.value||'').toLowerCase();
  edgeCatFiltered=getCatalogueEdges().filter(e=>!s||e.name.toLowerCase().includes(s));
  const el=document.getElementById('edgeCatList');if(!el)return;
  el.innerHTML=edgeCatFiltered.map((e,i)=>{const ok=meetsEdgeReqs(e,currentNPC);return `<div class="catalogue-item" data-idx="${i}" onclick="selectEdgeInfo(${i})" style="color:${ok?'var(--green)':'var(--text-dim)'}"><span class="cat-name">${esc(e.name)}</span> <span class="cat-detail">${esc(e.rank||'')} ${esc(e.cat||e.type||'')} ‚Äî ${esc(e.source)}</span></div>`;}).join('');
}
var edgeCatIdx=-1;
var edgeCatFiltered=[];
function meetsEdgeReqs(edge,n){
  if(!n)return false;
  const rankOrder={N:0,Novice:0,S:1,Seasoned:1,V:2,Veteran:2,H:3,Heroic:3,L:4,Legendary:4};
  const charRank=rankOrder[n.rank]||0;
  const edgeRank=rankOrder[edge.rank]||0;
  if(charRank<edgeRank)return false;
  const reqs=edge.reqs||'';
  if(reqs==='‚Äî'||!reqs)return true;
  const parts=reqs.split(',').map(s=>s.trim());
  const attrs={agility:n.agility||0,smarts:n.smarts||0,spirit:n.spirit||0,strength:n.strength||0,vigor:n.vigor||0};
  for(const p of parts){
    const attrMatch=p.match(/^(Agility|Smarts|Spirit|Strength|Vigor)\s+d(\d+)\+?$/i);
    if(attrMatch){if((attrs[attrMatch[1].toLowerCase()]||0)<parseInt(attrMatch[2]))return false;continue;}
    const skillMatch=p.match(/^(\w[\w\s]*?)\s+d(\d+)\+?$/);
    if(skillMatch){const has=Object.entries(n.skills||{}).find(([k])=>k.toLowerCase()===skillMatch[1].toLowerCase());if(!has||has[1]<parseInt(skillMatch[2]))return false;continue;}
    if(p.match(/only$/i)||p.match(/^d\d/)||p.match(/related skill/i))continue;
    const edgeReq=p.replace(/\s*\(.*\)/,'').trim();
    if(edgeReq.length>1&&edgeReq!=='‚Äî'){if(!(n.edges||[]).some(e=>e===edgeReq||e.startsWith(edgeReq+' (')))return false;}
  }
  return true;
}
function edgeCatKeyNav(e){
  const list=document.getElementById('edgeCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');if(!items.length)return;
  if(e.key==='ArrowDown'){e.preventDefault();edgeCatIdx=Math.min(edgeCatIdx+1,items.length-1);highlightEdgeCat(items);}
  else if(e.key==='ArrowUp'){e.preventDefault();edgeCatIdx=Math.max(edgeCatIdx-1,0);highlightEdgeCat(items);}
  else if(e.key==='Enter'&&edgeCatIdx>=0){e.preventDefault();items[edgeCatIdx].click();}
}
function highlightEdgeCat(items){
  items.forEach((it,i)=>{it.style.background=i===edgeCatIdx?'var(--accent)22':'';});
  if(items[edgeCatIdx]){items[edgeCatIdx].scrollIntoView({block:'nearest'});selectEdgeInfo(edgeCatIdx);}
}
function selectEdgeInfo(idx){
  const e=edgeCatFiltered[idx];if(!e)return;
  edgeCatIdx=idx;
  document.getElementById('edge_name').value=e.name;
  const info=document.getElementById('edgeInfo');if(!info)return;
  const ok=meetsEdgeReqs(e,currentNPC);
  const eligStyle=ok?'color:var(--green)':'color:var(--red)';
  const eligText=ok?'‚úì Eligible':'‚úó Requirements not met';
  const reqs=e.reqs&&e.reqs!=='‚Äî'?`<div class="ci-meta">Requirements: ${esc(e.reqs)}</div>`:'';
  let abPicker='';
  if(e.name==='Arcane Background'){
    abPicker=`<div style="margin-top:6px"><label style="font-size:11px;text-transform:uppercase;color:var(--text-dim)">Type</label><select id="abTypePick" onchange="document.getElementById('edge_name').value='Arcane Background ('+this.value+')'" style="margin-left:6px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:4px 8px;border-radius:3px;font-size:12px"><option value="Gifted">Gifted</option><option value="Magic">Magic</option><option value="Miracles">Miracles</option><option value="Psionics">Psionics</option><option value="Weird Science">Weird Science</option></select></div>`;
    document.getElementById('edge_name').value='Arcane Background (Gifted)';
  }
  info.innerHTML=`<div class="cat-info" style="cursor:pointer" onclick="scrollToEdgeCatItem(${idx})"><div class="ci-name">${esc(e.name)} <span style="font-size:11px;${eligStyle}">${eligText}</span></div><div class="ci-meta">${esc(e.rank||'N')} ¬∑ ${esc(e.cat||e.type||'General')} ¬∑ ${esc(e.source)}</div>${reqs}<div class="ci-desc">${esc(e.summary||'No description available.')}</div>${abPicker}</div>`;
  // highlight active in list
  const items=document.getElementById('edgeCatList')?.querySelectorAll('.catalogue-item');
  if(items)items.forEach((it,i)=>{it.style.background=i===idx?'var(--accent)22':'';});
  setTimeout(()=>document.getElementById('edgeSearch')?.focus(),0);
}
function scrollToEdgeCatItem(idx){
  const list=document.getElementById('edgeCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');
  if(items[idx]){items[idx].scrollIntoView({block:'nearest',behavior:'smooth'});}
}
function showExistingEdgeInfo(name){
  const search=document.getElementById('edgeSearch');if(search)search.value='';
  filterEdgeCat();
  const baseName=name.replace(/\s*\(.*\)/,'').trim();
  const idx=edgeCatFiltered.findIndex(e=>e.name===name||e.name===baseName);
  if(idx>=0){selectEdgeInfo(idx);scrollToEdgeCatItem(idx);}
  else{const info=document.getElementById('edgeInfo');if(info)info.innerHTML=`<div class="cat-info"><div class="ci-name">${esc(name)}</div><div class="ci-desc" style="color:var(--text-dim)">Custom edge ‚Äî not in catalogue</div></div>`;}
}
function addEdge(){const name=document.getElementById('edge_name').value.trim();if(!name)return;currentNPC.edges.push(name);saveCharacter(currentNPC);renderEdgesPanel(currentNPC);renderStatColumn(currentNPC);}
function removeEdge(btn){const val=btn.dataset.val;currentNPC.edges=currentNPC.edges.filter(x=>x!==val);if(currentNPC.edgeNotes)delete currentNPC.edgeNotes[val];saveCharacter(currentNPC);renderEdgesPanel(currentNPC);renderStatColumn(currentNPC);}
function toggleEdgeNotes(idx){
  const el=document.getElementById('edgeNotes_'+idx);if(!el)return;
  el.style.display=el.style.display==='none'?'block':'none';
  if(el.style.display==='block')document.getElementById('edgeNotesInput_'+idx)?.focus();
}
function saveEdgeNotes(idx){
  const notes=document.getElementById('edgeNotesInput_'+idx)?.value?.trim()||'';
  const edge=currentNPC.edges[idx];if(!edge)return;
  if(!currentNPC.edgeNotes)currentNPC.edgeNotes={};
  if(notes)currentNPC.edgeNotes[edge]=notes;else delete currentNPC.edgeNotes[edge];
  saveCharacter(currentNPC);renderEdgesPanel(currentNPC);renderStatColumn(currentNPC);
}

function renderSkillsPanel(n){
  const el=document.getElementById('panelContent');
  const CF=window.CharacterForge;
  const Rules=window.SWADERules;
  const DICE=Rules.DICE;
  const coreSkillNames=(CF.data?.coreSkills||[]);
  const coreLC=coreSkillNames.map(s=>s.toLowerCase());
  const skillLinks=CF.data?.skillLinks||{};
  const attrs={agility:n.agility,smarts:n.smarts,spirit:n.spirit,strength:n.strength,vigor:n.vigor};
  // Calculate budget ‚Äî replicate the hindrance-inference from audit
  const hindAlloc=null;
  let budget=Rules.calcSkillBudget(n.skills,attrs,skillLinks,coreSkillNames,0);
  if(budget.spent>budget.total){
    const hp=Rules.calcHindrancePoints(n.hindrances);
    const overspend=budget.spent-budget.total;
    if(overspend<=hp.effective) budget=Rules.calcSkillBudget(n.skills,attrs,skillLinks,coreSkillNames,overspend);
  }
  const remaining=budget.remaining;
  const budgetColour=remaining<0?'var(--red)':remaining===0?'var(--text-dim)':'var(--green)';
  const rows=Object.entries(n.skills).sort((a,b)=>a[0].localeCompare(b[0])).map(([name,die])=>{
    const isCore=coreLC.includes(name.toLowerCase());
    const star=isCore?'<span style="color:var(--accent)" title="Core Skill"> ‚òÖ</span>':'';
    // Determine colour for this skill row
    const linked=skillLinks[name];
    const linkedDie=linked?(attrs[linked]||4):4;
    const dIdx=DICE.indexOf(die);
    const atD12=dIdx>=DICE.length-1;
    let rowColour='var(--text-dim)';  // grey default
    let costHint='';
    if(!atD12){
      const nextDie=DICE[dIdx+1];
      const nextCost=nextDie>linkedDie?2:1;
      if(remaining>=nextCost){
        rowColour=nextCost===1?'var(--green)':'#e8b84e';
        costHint='<span style="font-size:10px;margin-left:6px;color:'+rowColour+'" title="Next step costs '+nextCost+'pt'+(nextCost>1?'s':'')+(nextCost===2?' (exceeds '+linked+' d'+linkedDie+')':'')+'">'+nextCost+'pt</span>';
      }
    }
    return '<tr style="border-left:3px solid '+rowColour+'">'
      +'<td style="cursor:pointer;padding-left:8px" onclick="showExistingSkillInfo(\''+esc(name)+'\')">'+esc(name)+star+costHint+'</td>'
      +'<td style="text-align:center"><button class="btn sm" onclick="stepSkill(\''+esc(name)+'\',-1)" style="padding:1px 6px;font-size:13px;min-width:22px">‚àí</button> <span style="display:inline-block;min-width:42px;text-align:center;font-weight:bold;color:'+rowColour+'">'+d(die)+'</span> <button class="btn sm" onclick="stepSkill(\''+esc(name)+'\',1)" style="padding:1px 6px;font-size:13px;min-width:22px">+</button></td>'
      +'<td><button class="btn sm danger" onclick="removeSkill(\''+esc(name)+'\')" title="Remove skill">√ó</button></td></tr>';
  }).join('');
  const budgetLine='<div style="margin-bottom:8px;font-size:12px;padding:6px 10px;background:var(--bg-body);border:1px solid var(--border);border-radius:3px"><span style="color:var(--text-dim)">Skill Points:</span> <strong style="color:'+budgetColour+'">'+budget.spent+' / '+budget.total+'</strong> <span style="color:var(--text-dim)">('+remaining+' remaining)</span></div>';
  el.innerHTML=budgetLine+`<table class="data-table"><tr><th>Skill</th><th>Die</th><th></th></tr>${rows||'<tr><td colspan="3" style="color:var(--text-dim)">No skills</td></tr>'}</table>
    <div class="catalogue-section"><h4>Add Skill</h4>
    <div style="margin-bottom:4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Pick from Catalogue</div>
    <input placeholder="Search skills... (‚Üë‚Üì to browse)" oninput="filterSkillCatalogue(this.value)" onkeydown="skillCatKeyNav(event)" id="skillSearch" style="width:100%;margin-bottom:4px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px">
    <div style="display:flex;gap:8px;align-items:flex-start">
      <div class="catalogue-list" id="skillCatList" style="flex:1;min-width:0"></div>
      <div id="skillInfo" style="flex:1;min-width:0"></div>
    </div>
    <div style="margin:10px 0 4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Or Enter Custom</div>
    <div class="form-row"><div class="form-group"><label>Skill Name</label><input id="skill_name"></div></div>
    <button class="btn primary" onclick="addSkill()">Add Skill (d4)</button></div>`;
  filterSkillCatalogue('');
}
var skillCatIdx=-1;
var skillCatFiltered=[];
function filterSkillCatalogue(s){
  skillCatIdx=-1;
  s=s.toLowerCase();
  const existing=currentNPC?Object.keys(currentNPC.skills).map(k=>k.toLowerCase()):[];
  skillCatFiltered=getCatalogueSkills().filter(sk=>(!s||sk.name.toLowerCase().includes(s)));
  const el=document.getElementById('skillCatList');if(!el)return;
  el.innerHTML=skillCatFiltered.map((sk,i)=>{const taken=existing.includes(sk.name.toLowerCase());return `<div class="catalogue-item" data-idx="${i}" onclick="selectSkillInfo(${i})" style="color:${taken?'var(--text-dim)':'var(--green)'}"><span class="cat-name">${esc(sk.name)}</span> <span class="cat-detail">(${esc(sk.attr)})${sk.core?' ‚òÖ':''} ‚Äî ${esc(sk.source)}</span></div>`;}).join('');
}
function skillCatKeyNav(e){
  const list=document.getElementById('skillCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');if(!items.length)return;
  if(e.key==='ArrowDown'){e.preventDefault();skillCatIdx=Math.min(skillCatIdx+1,items.length-1);highlightSkillCat(items);}
  else if(e.key==='ArrowUp'){e.preventDefault();skillCatIdx=Math.max(skillCatIdx-1,0);highlightSkillCat(items);}
  else if(e.key==='Enter'&&skillCatIdx>=0){e.preventDefault();selectSkillInfo(skillCatIdx);}
}
function highlightSkillCat(items){
  items.forEach((it,i)=>{it.style.background=i===skillCatIdx?'var(--accent)22':'';});
  if(items[skillCatIdx]){items[skillCatIdx].scrollIntoView({block:'nearest'});selectSkillInfo(skillCatIdx);}
}
function selectSkillInfo(idx){
  const sk=skillCatFiltered[idx];if(!sk)return;
  skillCatIdx=idx;
  document.getElementById('skill_name').value=sk.name;
  const info=document.getElementById('skillInfo');if(!info)return;
  const existing=currentNPC?Object.keys(currentNPC.skills).map(k=>k.toLowerCase()):[];
  const taken=existing.includes(sk.name.toLowerCase());
  const tagStyle=taken?'color:var(--text-dim)':'color:var(--green)';
  const tagText=taken?'Already taken':'Available';
  const coreTag=sk.core?'<span style="color:var(--accent);font-size:10px;margin-left:4px">‚òÖ CORE</span>':'';
  info.innerHTML=`<div class="cat-info" style="cursor:pointer" onclick="scrollToSkillCatItem(${idx})"><div class="ci-name">${esc(sk.name)}${coreTag} <span style="font-size:11px;${tagStyle}">${tagText}</span></div><div class="ci-meta">Linked Attribute: ${esc(sk.attr.charAt(0).toUpperCase()+sk.attr.slice(1))} ¬∑ ${esc(sk.source)}</div><div class="ci-desc">${esc(sk.summary||'No description available.')}</div></div>`;
  const items=document.getElementById('skillCatList')?.querySelectorAll('.catalogue-item');
  if(items)items.forEach((it,i)=>{it.style.background=i===idx?'var(--accent)22':'';});
  setTimeout(()=>document.getElementById('skillSearch')?.focus(),0);
}
function scrollToSkillCatItem(idx){
  const list=document.getElementById('skillCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');
  if(items[idx])items[idx].scrollIntoView({block:'nearest',behavior:'smooth'});
}
function showExistingSkillInfo(name){
  const search=document.getElementById('skillSearch');if(search)search.value='';
  filterSkillCatalogue('');
  const idx=skillCatFiltered.findIndex(s=>s.name===name);
  if(idx>=0){selectSkillInfo(idx);scrollToSkillCatItem(idx);}
  else{const info=document.getElementById('skillInfo');if(info)info.innerHTML=`<div class="cat-info"><div class="ci-name">${esc(name)}</div><div class="ci-desc" style="color:var(--text-dim)">Custom skill ‚Äî not in catalogue</div></div>`;}
}
function selectCatalogueSkill(name){document.getElementById('skill_name').value=name;}
function addSkill(){const name=document.getElementById('skill_name').value.trim();if(!name)return;currentNPC.skills[name]=4;calcDerived(currentNPC);saveCharacter(currentNPC);renderSkillsPanel(currentNPC);renderStatColumn(currentNPC);}
function stepAttr(id,dir){const el=document.getElementById(id);if(!el)return;let v=parseInt(el.dataset.val)||0;const cap=isPregen();v=dir>0?dieStepUp(v,cap):dieStepDown(v);if(v<0)v=0;el.dataset.val=v;el.textContent=d(v);}
function stepSkill(name,dir){console.log("üéØ stepSkill:",name,dir>0?"+":"-");if(!currentNPC||!currentNPC.skills[name])return;const v=currentNPC.skills[name];const cap=isPregen();currentNPC.skills[name]=dir>0?dieStepUp(v,cap):dieStepDown(v);calcDerived(currentNPC);saveCharacter(currentNPC);renderSkillsPanel(currentNPC);renderStatColumn(currentNPC);}
function removeSkill(name){
  const coreSkills=(window.CharacterForge?.data?.coreSkills||[]).map(s=>s.toLowerCase());
  if(coreSkills.includes(name.toLowerCase())){if(!confirm(name+' is a Core Skill. Are you sure you want to remove it?'))return;}
  delete currentNPC.skills[name];calcDerived(currentNPC);saveCharacter(currentNPC);renderSkillsPanel(currentNPC);renderStatColumn(currentNPC);
}

/* ‚ïê‚ïê‚ïê WEAPONS PANEL ‚Äî full catalogue with info, keyboard nav, colour coding ‚ïê‚ïê‚ïê */
var wepCatIdx=-1, wepCatFiltered=[];
function renderWeaponsPanel(n){
  const owned=n.weapons.map(w=>w.name.toLowerCase());
  const current=n.weapons.map((w,i)=>`<div class="item-entry" style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;cursor:pointer" onclick="showExistingWepInfo('${esc(w.name).replace(/'/g,"\\'")}')"><span>${esc(w.name)} <span style="color:var(--text-dim)">${esc(w.damage)}${w.ap?' AP'+w.ap:''}${w.range?' '+w.range:''}</span></span><button class="btn sm danger" onclick="event.stopPropagation();removeWeapon(${i})">√ó</button></div>`).join('');
  document.getElementById('panelContent').innerHTML=`<div>${current||'<div style="color:var(--text-dim)">No weapons</div>'}</div>
    <div class="catalogue-section"><h4>Add Weapon</h4>
    <input placeholder="Search weapons... (‚Üë‚Üì to browse)" id="wepSearch" oninput="filterWeaponCatalogue(this.value)" onkeydown="wepCatKeyNav(event)" style="width:100%;margin-bottom:4px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px">
    <div style="display:flex;gap:8px;align-items:flex-start">
      <div class="catalogue-list" id="wepCatList" style="flex:1;min-width:0"></div>
      <div id="wepInfo" style="flex:1;min-width:0"></div>
    </div>
    <div style="margin:10px 0 4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Or Enter Custom</div>
    <div class="form-row"><div class="form-group"><label>Name</label><input id="wep_name"></div><div class="form-group"><label>Damage</label><input id="wep_damage" placeholder="Str+d8"></div></div>
    <div class="form-row"><div class="form-group" style="max-width:80px"><label>AP</label><input id="wep_ap" type="number" value="0"></div><div class="form-group"><label>Range</label><input id="wep_range" placeholder=""></div><div class="form-group"><label>Notes</label><input id="wep_notes"></div></div>
    <button class="btn primary" onclick="addWeapon()">Add Weapon</button></div>`;
  filterWeaponCatalogue('');
}
function filterWeaponCatalogue(s){
  wepCatIdx=-1;
  s=(s||'').toLowerCase();
  const owned=currentNPC?currentNPC.weapons.map(w=>w.name.toLowerCase()):[];
  wepCatFiltered=getCatalogueWeapons().filter(w=>!s||w.name.toLowerCase().includes(s));
  const el=document.getElementById('wepCatList');if(!el)return;
  el.innerHTML=wepCatFiltered.map((w,i)=>{const has=owned.includes(w.name.toLowerCase());return `<div class="catalogue-item" data-idx="${i}" onclick="selectWepInfo(${i})" style="color:${has?'var(--text-dim)':'var(--green)'}"><span class="cat-name">${esc(w.name)}</span> <span class="cat-detail">${esc(w.dmg)}${w.ap?' AP'+w.ap:''}${w.range?' '+w.range:''} ‚Äî ${esc(w.source)}</span></div>`;}).join('');
  window._wepCatList=wepCatFiltered;
}
function selectWepInfo(idx){
  const w=wepCatFiltered[idx];if(!w)return;
  wepCatIdx=idx;
  document.getElementById('wep_name').value=w.name;
  document.getElementById('wep_damage').value=w.dmg;
  document.getElementById('wep_ap').value=w.ap||0;
  document.getElementById('wep_range').value=w.range||'';
  document.getElementById('wep_notes').value=w.notes||'';
  const info=document.getElementById('wepInfo');if(!info)return;
  const owned=currentNPC?currentNPC.weapons.some(x=>x.name.toLowerCase()===w.name.toLowerCase()):false;
  const ownStyle=owned?'color:var(--text-dim)':'color:var(--green)';
  const ownText=owned?'Already equipped':'Available';
  let details=`<div class="ci-meta">${esc(w.type||'Melee')} ¬∑ ${esc(w.source)}</div>`;
  details+=`<div class="ci-meta">Damage: ${esc(w.dmg)}${w.ap?' ¬∑ AP '+w.ap:''}${w.range?' ¬∑ Range '+w.range:''}${w.rof?' ¬∑ ROF '+w.rof:''}</div>`;
  if(w.cost||w.wt) details+=`<div class="ci-meta">${w.cost?w.cost+'‚Ç°':''}${w.cost&&w.wt?' ¬∑ ':''}${w.wt?w.wt+' lbs':''}</div>`;
  if(w.notes) details+=`<div class="ci-desc">${esc(w.notes)}</div>`;
  info.innerHTML=`<div class="cat-info" style="cursor:pointer" onclick="scrollToWepCatItem(${idx})"><div class="ci-name">${esc(w.name)} <span style="font-size:11px;${ownStyle}">${ownText}</span></div>${details}</div>`;
  const items=document.getElementById('wepCatList')?.querySelectorAll('.catalogue-item');
  if(items)items.forEach((it,i)=>{it.style.background=i===idx?'var(--accent)22':'';});
  setTimeout(()=>document.getElementById('wepSearch')?.focus(),0);
}
function wepCatKeyNav(e){
  const list=document.getElementById('wepCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');if(!items.length)return;
  if(e.key==='ArrowDown'){e.preventDefault();wepCatIdx=Math.min(wepCatIdx+1,items.length-1);highlightWepCat(items);}
  else if(e.key==='ArrowUp'){e.preventDefault();wepCatIdx=Math.max(wepCatIdx-1,0);highlightWepCat(items);}
  else if(e.key==='Enter'&&wepCatIdx>=0){e.preventDefault();items[wepCatIdx].click();}
}
function highlightWepCat(items){
  items.forEach((it,i)=>{it.style.background=i===wepCatIdx?'var(--accent)22':'';});
  if(items[wepCatIdx]){items[wepCatIdx].scrollIntoView({block:'nearest'});selectWepInfo(wepCatIdx);}
}
function scrollToWepCatItem(idx){
  const list=document.getElementById('wepCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');
  if(items[idx]){items[idx].scrollIntoView({block:'nearest',behavior:'smooth'});}
}
function showExistingWepInfo(name){
  const search=document.getElementById('wepSearch');if(search)search.value='';
  filterWeaponCatalogue('');
  const idx=wepCatFiltered.findIndex(w=>w.name.toLowerCase()===name.toLowerCase());
  if(idx>=0){selectWepInfo(idx);scrollToWepCatItem(idx);}
  else{const info=document.getElementById('wepInfo');if(info)info.innerHTML=`<div class="cat-info"><div class="ci-name">${esc(name)}</div><div class="ci-desc" style="color:var(--text-dim)">Custom weapon ‚Äî not in catalogue</div></div>`;}
}
function addWeapon(){
  const name=document.getElementById('wep_name').value.trim(),dmg=document.getElementById('wep_damage').value.trim();
  if(!name||!dmg)return;
  currentNPC.weapons.push({name,damage:dmg,ap:parseInt(document.getElementById('wep_ap').value)||0,range:document.getElementById('wep_range').value.trim(),notes:document.getElementById('wep_notes').value.trim(),source:'Manual'});
  saveCharacter(currentNPC);renderWeaponsPanel(currentNPC);renderStatColumn(currentNPC);
}
function removeWeapon(idx){currentNPC.weapons.splice(idx,1);saveCharacter(currentNPC);renderWeaponsPanel(currentNPC);renderStatColumn(currentNPC);}
function addWeaponToGear(){addWeapon();}

/* ‚ïê‚ïê‚ïê ARMOUR PANEL ‚Äî full catalogue with info, keyboard nav, colour coding ‚ïê‚ïê‚ïê */
var armCatIdx=-1, armCatFiltered=[];
function renderArmourPanel(n){
  const current=n.armour.map((a,i)=>`<div class="item-entry" style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;cursor:pointer" onclick="showExistingArmInfo('${esc(a.name).replace(/'/g,"\\'")}')"><span>${esc(a.name)} <span style="color:var(--accent)">(+${a.armor})</span>${a.notes?' <span style="color:var(--text-dim)">'+esc(a.notes)+'</span>':''}</span><button class="btn sm danger" onclick="event.stopPropagation();removeArmour(${i})">√ó</button></div>`).join('');
  document.getElementById('panelContent').innerHTML=`<div>${current||'<div style="color:var(--text-dim)">No armour</div>'}</div>
    <div class="catalogue-section"><h4>Add Armour</h4>
    <input placeholder="Search armour & shields... (‚Üë‚Üì to browse)" id="armSearch" oninput="filterArmourCatalogue(this.value)" onkeydown="armCatKeyNav(event)" style="width:100%;margin-bottom:4px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px">
    <div style="display:flex;gap:8px;align-items:flex-start">
      <div class="catalogue-list" id="armCatList" style="flex:1;min-width:0"></div>
      <div id="armInfo" style="flex:1;min-width:0"></div>
    </div>
    <div style="margin:10px 0 4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Or Enter Custom</div>
    <div class="form-row"><div class="form-group"><label>Name</label><input id="arm_name"></div><div class="form-group" style="max-width:100px"><label>Protection</label><input id="arm_prot" type="number" value="2"></div></div>
    <div class="form-row"><div class="form-group"><label>Notes</label><input id="arm_notes"></div></div>
    <button class="btn primary" onclick="addArmour()">Add Armour</button></div>`;
  filterArmourCatalogue('');
}
function filterArmourCatalogue(s){
  armCatIdx=-1;
  s=(s||'').toLowerCase();
  const owned=currentNPC?currentNPC.armour.map(a=>a.name.toLowerCase()):[];
  armCatFiltered=getCatalogueArmour().filter(a=>!s||a.name.toLowerCase().includes(s));
  const el=document.getElementById('armCatList');if(!el)return;
  el.innerHTML=armCatFiltered.map((a,i)=>{
    const has=owned.includes(a.name.toLowerCase());
    const val=a.armor?'+'+a.armor:(a.parry?'Parry +'+a.parry:'');
    return `<div class="catalogue-item" data-idx="${i}" onclick="selectArmInfo(${i})" style="color:${has?'var(--text-dim)':'var(--green)'}"><span class="cat-name">${esc(a.name)}</span> <span class="cat-detail">(${val}) ‚Äî ${esc(a.source)}</span></div>`;
  }).join('');
  window._armCatList=armCatFiltered;
}
function selectArmInfo(idx){
  const a=armCatFiltered[idx];if(!a)return;
  armCatIdx=idx;
  document.getElementById('arm_name').value=a.name;
  document.getElementById('arm_prot').value=a.armor||a.parry||0;
  document.getElementById('arm_notes').value=a.notes||'';
  const info=document.getElementById('armInfo');if(!info)return;
  const owned=currentNPC?currentNPC.armour.some(x=>x.name.toLowerCase()===a.name.toLowerCase()):false;
  const ownStyle=owned?'color:var(--text-dim)':'color:var(--green)';
  const ownText=owned?'Already equipped':'Available';
  let details=`<div class="ci-meta">${esc(a.type||'Armour')} ¬∑ ${esc(a.source)}</div>`;
  if(a.armor) details+=`<div class="ci-meta">Protection: +${a.armor}</div>`;
  if(a.parry) details+=`<div class="ci-meta">Parry: +${a.parry}</div>`;
  if(a.cost||a.wt) details+=`<div class="ci-meta">${a.cost?a.cost+'‚Ç°':''}${a.cost&&a.wt?' ¬∑ ':''}${a.wt?a.wt+' lbs':''}</div>`;
  if(a.notes) details+=`<div class="ci-desc">${esc(a.notes)}</div>`;
  info.innerHTML=`<div class="cat-info" style="cursor:pointer" onclick="scrollToArmCatItem(${idx})"><div class="ci-name">${esc(a.name)} <span style="font-size:11px;${ownStyle}">${ownText}</span></div>${details}</div>`;
  const items=document.getElementById('armCatList')?.querySelectorAll('.catalogue-item');
  if(items)items.forEach((it,i)=>{it.style.background=i===idx?'var(--accent)22':'';});
  setTimeout(()=>document.getElementById('armSearch')?.focus(),0);
}
function armCatKeyNav(e){
  const list=document.getElementById('armCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');if(!items.length)return;
  if(e.key==='ArrowDown'){e.preventDefault();armCatIdx=Math.min(armCatIdx+1,items.length-1);highlightArmCat(items);}
  else if(e.key==='ArrowUp'){e.preventDefault();armCatIdx=Math.max(armCatIdx-1,0);highlightArmCat(items);}
  else if(e.key==='Enter'&&armCatIdx>=0){e.preventDefault();items[armCatIdx].click();}
}
function highlightArmCat(items){
  items.forEach((it,i)=>{it.style.background=i===armCatIdx?'var(--accent)22':'';});
  if(items[armCatIdx]){items[armCatIdx].scrollIntoView({block:'nearest'});selectArmInfo(armCatIdx);}
}
function scrollToArmCatItem(idx){
  const list=document.getElementById('armCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');
  if(items[idx]){items[idx].scrollIntoView({block:'nearest',behavior:'smooth'});}
}
function showExistingArmInfo(name){
  const search=document.getElementById('armSearch');if(search)search.value='';
  filterArmourCatalogue('');
  const idx=armCatFiltered.findIndex(a=>a.name.toLowerCase()===name.toLowerCase());
  if(idx>=0){selectArmInfo(idx);scrollToArmCatItem(idx);}
  else{const info=document.getElementById('armInfo');if(info)info.innerHTML=`<div class="cat-info"><div class="ci-name">${esc(name)}</div><div class="ci-desc" style="color:var(--text-dim)">Custom armour ‚Äî not in catalogue</div></div>`;}
}
function addArmour(){
  const name=document.getElementById('arm_name').value.trim();if(!name)return;
  const armor=parseInt(document.getElementById('arm_prot').value)||0;
  currentNPC.armour.push({name,armor,notes:document.getElementById('arm_notes').value.trim(),source:'Manual'});
  recalcArmour();saveCharacter(currentNPC);renderArmourPanel(currentNPC);renderStatColumn(currentNPC);
}
function removeArmour(idx){currentNPC.armour.splice(idx,1);recalcArmour();saveCharacter(currentNPC);renderArmourPanel(currentNPC);renderStatColumn(currentNPC);}
function addArmourToGear(){addArmour();}
function recalcArmour(){currentNPC.toughnessArmor=currentNPC.armour.reduce((best,a)=>Math.max(best,a.armor||0),0);calcDerived(currentNPC);}

/* ‚ïê‚ïê‚ïê GEAR PANEL ‚Äî full catalogue with info, keyboard nav, colour coding ‚ïê‚ïê‚ïê */
var gearCatIdx=-1, gearCatFiltered=[];
function renderGearPanel(n){
  const items=n.gearText?n.gearText.split(',').map(g=>g.trim()).filter(g=>g):[];
  const rows=items.map((g,i)=>`<div class="item-entry" style="display:flex;justify-content:space-between;padding:4px 0;cursor:pointer" onclick="showExistingGearInfo('${esc(g).replace(/'/g,"\\'")}')"><span>${esc(g)}</span> <button class="btn sm danger" onclick="event.stopPropagation();removeGearItem(${i})">√ó</button></div>`).join('');
  document.getElementById('panelContent').innerHTML=`<div>${rows||'<div style="color:var(--text-dim)">No gear yet</div>'}</div>
    <div class="catalogue-section"><h4>Add Item</h4>
    <input placeholder="Search gear... (‚Üë‚Üì to browse)" id="gearSearch" oninput="filterGearCatalogue(this.value)" onkeydown="gearCatKeyNav(event)" style="width:100%;margin-bottom:4px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px">
    <div style="display:flex;gap:8px;align-items:flex-start">
      <div class="catalogue-list" id="gearCatList" style="flex:1;min-width:0"></div>
      <div id="gearInfo" style="flex:1;min-width:0"></div>
    </div>
    <div style="margin:10px 0 4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Or Enter Custom</div>
    <div class="form-group"><label>Item</label><input id="gear_name"></div>
    <button class="btn primary" onclick="addGearItem()">Add Item</button></div>`;
  filterGearCatalogue('');
}
function filterGearCatalogue(s){
  gearCatIdx=-1;
  s=(s||'').toLowerCase();
  const ownedText=currentNPC&&currentNPC.gearText?currentNPC.gearText.toLowerCase():'';
  gearCatFiltered=getCatalogueGear().filter(g=>!s||g.name.toLowerCase().includes(s));
  const el=document.getElementById('gearCatList');if(!el)return;
  el.innerHTML=gearCatFiltered.map((g,i)=>{
    const has=ownedText.includes(g.name.toLowerCase());
    const detail=g.notes?` ‚Äî ${esc(g.notes)}`:'';
    return `<div class="catalogue-item" data-idx="${i}" onclick="selectGearInfo(${i})" style="color:${has?'var(--text-dim)':'var(--green)'}"><span class="cat-name">${esc(g.name)}</span> <span class="cat-detail">${g.cost?g.cost+'‚Ç°':''}${detail} ‚Äî ${esc(g.source)}</span></div>`;
  }).join('');
  window._gearCatList=gearCatFiltered;
}
function selectGearInfo(idx){
  const g=gearCatFiltered[idx];if(!g)return;
  gearCatIdx=idx;
  document.getElementById('gear_name').value=g.name;
  const info=document.getElementById('gearInfo');if(!info)return;
  const ownedText=currentNPC&&currentNPC.gearText?currentNPC.gearText.toLowerCase():'';
  const has=ownedText.includes(g.name.toLowerCase());
  const ownStyle=has?'color:var(--text-dim)':'color:var(--green)';
  const ownText=has?'Already carried':'Available';
  let details=`<div class="ci-meta">${esc(g.source)}</div>`;
  if(g.cost||g.wt) details+=`<div class="ci-meta">${g.cost?g.cost+'‚Ç°':''}${g.cost&&g.wt?' ¬∑ ':''}${g.wt?g.wt+' lbs':''}</div>`;
  if(g.notes) details+=`<div class="ci-desc">${esc(g.notes)}</div>`;
  info.innerHTML=`<div class="cat-info" style="cursor:pointer" onclick="scrollToGearCatItem(${idx})"><div class="ci-name">${esc(g.name)} <span style="font-size:11px;${ownStyle}">${ownText}</span></div>${details}</div>`;
  const items=document.getElementById('gearCatList')?.querySelectorAll('.catalogue-item');
  if(items)items.forEach((it,i)=>{it.style.background=i===idx?'var(--accent)22':'';});
  setTimeout(()=>document.getElementById('gearSearch')?.focus(),0);
}
function gearCatKeyNav(e){
  const list=document.getElementById('gearCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');if(!items.length)return;
  if(e.key==='ArrowDown'){e.preventDefault();gearCatIdx=Math.min(gearCatIdx+1,items.length-1);highlightGearCat(items);}
  else if(e.key==='ArrowUp'){e.preventDefault();gearCatIdx=Math.max(gearCatIdx-1,0);highlightGearCat(items);}
  else if(e.key==='Enter'&&gearCatIdx>=0){e.preventDefault();items[gearCatIdx].click();}
}
function highlightGearCat(items){
  items.forEach((it,i)=>{it.style.background=i===gearCatIdx?'var(--accent)22':'';});
  if(items[gearCatIdx]){items[gearCatIdx].scrollIntoView({block:'nearest'});selectGearInfo(gearCatIdx);}
}
function scrollToGearCatItem(idx){
  const list=document.getElementById('gearCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');
  if(items[idx]){items[idx].scrollIntoView({block:'nearest',behavior:'smooth'});}
}
function showExistingGearInfo(name){
  const search=document.getElementById('gearSearch');if(search)search.value='';
  filterGearCatalogue('');
  const baseName=name.replace(/\s*\(.*\)/,'').trim();
  const idx=gearCatFiltered.findIndex(g=>g.name.toLowerCase()===name.toLowerCase()||g.name.toLowerCase()===baseName.toLowerCase());
  if(idx>=0){selectGearInfo(idx);scrollToGearCatItem(idx);}
  else{const info=document.getElementById('gearInfo');if(info)info.innerHTML=`<div class="cat-info"><div class="ci-name">${esc(name)}</div><div class="ci-desc" style="color:var(--text-dim)">Custom item ‚Äî not in catalogue</div></div>`;}
}
function addGearItem(){const item=document.getElementById('gear_name').value.trim();if(!item)return;currentNPC.gearText=currentNPC.gearText?currentNPC.gearText+', '+item:item;saveCharacter(currentNPC);renderGearPanel(currentNPC);renderStatColumn(currentNPC);}
function removeGearItem(idx){const items=currentNPC.gearText.split(',').map(g=>g.trim()).filter(g=>g);items.splice(idx,1);currentNPC.gearText=items.join(', ');saveCharacter(currentNPC);renderGearPanel(currentNPC);renderStatColumn(currentNPC);}

function renderPowersPanel(n){
  const rows=n.powers.map((p,i)=>`<div class="item-entry" style="display:flex;justify-content:space-between;padding:4px 0">${esc(p)} <button class="btn sm danger" onclick="removePower(${i})">√ó</button></div>`).join('');
  document.getElementById('panelContent').innerHTML=`<div class="form-row" style="margin-bottom:10px"><div class="form-group"><label>Arcane Background</label><input id="pow_ab" value="${esc(n.abName)}"></div><div class="form-group" style="max-width:100px"><label>Power Points</label><input id="pow_pp" type="number" value="${n.pp}"></div></div>
    <div>${rows||'<div style="color:var(--text-dim)">No powers yet</div>'}</div>
    <div class="catalogue-section"><h4>Add Power</h4>
    <div style="margin-bottom:4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Pick from Catalogue</div>
    <input placeholder="Search powers... (‚Üë‚Üì to browse)" oninput="filterPowerCatalogue(this.value)" onkeydown="powCatKeyNav(event)" id="powSearch" style="width:100%;margin-bottom:4px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px">
    <div style="display:flex;gap:8px;align-items:flex-start">
      <div class="catalogue-list" id="powCatList" style="flex:1;min-width:0"></div>
      <div id="powInfo" style="flex:1;min-width:0"></div>
    </div>
    <div style="margin:10px 0 4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Or Enter Custom</div>
    <div class="form-group"><label>Power Name</label><input id="pow_name"></div>
    <button class="btn primary" onclick="addPower()">Add Power</button></div>
    <div class="form-actions"><button class="btn" onclick="savePowerSettings()">Save AB Settings</button></div>`;
  filterPowerCatalogue('');
}
var powCatIdx=-1;
var powCatFiltered=[];
function meetsPowerRank(pow,n){
  if(!n)return false;
  const rankOrder={N:0,Novice:0,S:1,Seasoned:1,V:2,Veteran:2,H:3,Heroic:3,L:4,Legendary:4};
  return (rankOrder[n.rank]||0)>=(rankOrder[pow.rank]||0);
}
function filterPowerCatalogue(s){
  powCatIdx=-1;
  s=s.toLowerCase();
  const existing=currentNPC?currentNPC.powers.map(p=>p.toLowerCase()):[];
  powCatFiltered=getCataloguePowers().filter(p=>(!s||p.name.toLowerCase().includes(s))&&!existing.includes(p.name.toLowerCase()));
  const el=document.getElementById('powCatList');if(!el)return;
  el.innerHTML=powCatFiltered.map((p,i)=>{const ok=meetsPowerRank(p,currentNPC);return `<div class="catalogue-item" onclick="selectPowInfo(${i})" style="color:${ok?'var(--green)':'var(--text-dim)'}"><span class="cat-name">${esc(p.name)}</span> <span class="cat-detail">${esc(p.rank)} ${esc(p.pp)}PP ${p.range?p.range:''} ‚Äî ${esc(p.source)}</span></div>`;}).join('');
}
function powCatKeyNav(e){
  const list=document.getElementById('powCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');if(!items.length)return;
  if(e.key==='ArrowDown'){e.preventDefault();powCatIdx=Math.min(powCatIdx+1,items.length-1);highlightPowCat(items);}
  else if(e.key==='ArrowUp'){e.preventDefault();powCatIdx=Math.max(powCatIdx-1,0);highlightPowCat(items);}
  else if(e.key==='Enter'&&powCatIdx>=0){e.preventDefault();selectPowInfo(powCatIdx);}
}
function highlightPowCat(items){
  items.forEach((it,i)=>{it.style.background=i===powCatIdx?'var(--accent)22':'';});
  if(items[powCatIdx]){items[powCatIdx].scrollIntoView({block:'nearest'});selectPowInfo(powCatIdx);}
}
function selectPowInfo(idx){
  const p=powCatFiltered[idx];if(!p)return;
  powCatIdx=idx;
  document.getElementById('pow_name').value=p.name;
  const info=document.getElementById('powInfo');if(!info)return;
  const ok=meetsPowerRank(p,currentNPC);
  const eligStyle=ok?'color:var(--green)':'color:var(--red)';
  const eligText=ok?'‚úì Eligible':'‚úó Rank too low';
  info.innerHTML=`<div class="cat-info" style="cursor:pointer" onclick="scrollToPowCatItem(${idx})"><div class="ci-name">${esc(p.name)} <span style="font-size:11px;${eligStyle}">${eligText}</span></div><div class="ci-meta">${esc(p.rank)} ¬∑ ${esc(p.pp)} PP ¬∑ Range: ${esc(p.range||'Self')} ¬∑ Duration: ${esc(p.dur||'Instant')} ¬∑ ${esc(p.source)}</div><div class="ci-desc">${esc(p.summary||'No description available.')}</div></div>`;
  const items=document.getElementById('powCatList')?.querySelectorAll('.catalogue-item');
  if(items)items.forEach((it,i)=>{it.style.background=i===idx?'var(--accent)22':'';});
  setTimeout(()=>document.getElementById('powSearch')?.focus(),0);
}
function scrollToPowCatItem(idx){
  const list=document.getElementById('powCatList');if(!list)return;
  const items=list.querySelectorAll('.catalogue-item');
  if(items[idx])items[idx].scrollIntoView({block:'nearest',behavior:'smooth'});
}
function addPower(){const name=document.getElementById('pow_name').value.trim();if(!name)return;currentNPC.powers.push(name);saveCharacter(currentNPC);renderPowersPanel(currentNPC);renderStatColumn(currentNPC);}
function removePower(idx){currentNPC.powers.splice(idx,1);saveCharacter(currentNPC);renderPowersPanel(currentNPC);renderStatColumn(currentNPC);}
function savePowerSettings(){currentNPC.abName=document.getElementById('pow_ab').value.trim();currentNPC.pp=parseInt(document.getElementById('pow_pp').value)||0;saveCharacter(currentNPC);renderStatColumn(currentNPC);}

function renderNarrativePanel(n){
  document.getElementById('panelContent').innerHTML=`
    <div class="form-group"><label>Description</label><textarea id="nar_desc" rows="3">${esc(n.description)}</textarea></div>
    <div class="form-group"><label>Background</label><textarea id="nar_bg" rows="3">${esc(n.background)}</textarea></div>
    <div class="form-group"><label>What They Want</label><textarea id="nar_mot" rows="2">${esc(n.motivation)}</textarea></div>
    <div class="form-group"><label>Their Secret</label><textarea id="nar_sec" rows="2">${esc(n.secret)}</textarea></div>
    <div class="form-group"><label>Services</label><input id="nar_svc" value="${esc(n.services)}"></div>
    <div class="form-group"><label>Adventure Hook</label><textarea id="nar_hook" rows="2">${esc(n.adventureHook)}</textarea></div>
    <div class="form-group"><label>Tactics</label><textarea id="nar_tac" rows="2">${esc(n.tactics)}</textarea></div>
    <div class="form-actions"><button class="btn" onclick="closePanel()">Cancel</button><button class="btn primary" onclick="saveNarrative()">Save Narrative</button></div>`;
}
function saveNarrative(){const n=currentNPC;n.description=document.getElementById('nar_desc').value.trim();n.background=document.getElementById('nar_bg').value.trim();n.motivation=document.getElementById('nar_mot').value.trim();n.secret=document.getElementById('nar_sec').value.trim();n.services=document.getElementById('nar_svc').value.trim();n.adventureHook=document.getElementById('nar_hook').value.trim();n.tactics=document.getElementById('nar_tac').value.trim();saveCharacter(n);closePanel();}

function renderStatBlockPanel(n){
  const skillStr=Object.entries(n.skills).map(([k,v])=>`${k} ${d(v)}`).join(', ');
  const toughDisp=n.toughnessArmor>0?`${n.toughness} (${n.toughnessArmor})`:`${n.toughness}`;
  let fmt=`<strong>${esc(n.name)}</strong>\n`;
  if(n.quote)fmt+=`<em>"${esc(n.quote)}"</em>\n\n`;
  if(n.description)fmt+=`${esc(n.description)}\n\n`;
  fmt+=`<span class="label">Attributes:</span> Agility ${d(n.agility)}, Smarts ${d(n.smarts)}, Spirit ${d(n.spirit)}, Strength ${d(n.strength)}, Vigor ${d(n.vigor)}\n`;
  fmt+=`<span class="label">Skills:</span> ${skillStr}\n`;
  fmt+=`<span class="label">Pace:</span> ${n.pace}; <span class="label">Parry:</span> ${n.parry}; <span class="label">Toughness:</span> ${toughDisp}\n`;
  if(n.edges.length)fmt+=`<span class="label">Edges:</span> ${n.edges.join(', ')}\n`;
  if(n.hindrances.length)fmt+=`<span class="label">Hindrances:</span> ${n.hindrances.join(', ')}\n`;
  if(n.gearText)fmt+=`<span class="label">Gear:</span> ${esc(n.gearText)}\n`;
  if(n.pp>0)fmt+=`<span class="label">Powers (${n.pp} PP):</span> ${n.powers.join(', ')}\n`;
  if(n.tactics)fmt+=`<span class="label">Tactics:</span> ${esc(n.tactics)}\n`;
  let md=`**${n.name}**\n`;
  if(n.quote)md+=`*"${n.quote}"*\n\n`;
  if(n.description)md+=`${n.description}\n\n`;
  md+=`**Attributes:** Agility ${d(n.agility)}, Smarts ${d(n.smarts)}, Spirit ${d(n.spirit)}, Strength ${d(n.strength)}, Vigor ${d(n.vigor)}\n`;
  md+=`**Skills:** ${skillStr}\n**Pace:** ${n.pace}; **Parry:** ${n.parry}; **Toughness:** ${toughDisp}\n`;
  if(n.edges.length)md+=`**Edges:** ${n.edges.join(', ')}\n`;
  if(n.hindrances.length)md+=`**Hindrances:** ${n.hindrances.join(', ')}\n`;
  if(n.gearText)md+=`**Gear:** ${n.gearText}\n`;
  if(n.pp>0)md+=`**Powers (${n.pp} PP):** ${n.powers.join(', ')}\n`;
  if(n.tactics)md+=`**Tactics:** ${n.tactics}\n`;
  document.getElementById('panelContent').innerHTML=`<div class="export-tabs"><div class="export-tab active" onclick="switchExportTab(this,'fmt')">Formatted</div><div class="export-tab" onclick="switchExportTab(this,'md')">Markdown</div></div><div class="export-content" id="exportFmt">${fmt}</div><div class="export-content" id="exportMd" style="display:none">${esc(md)}</div><div class="form-actions" style="margin-top:8px"><button class="btn" onclick="copyExport('html')">Copy HTML</button><button class="btn" onclick="copyExport('md')">Copy Markdown</button></div>`;
}
function switchExportTab(el,tab){document.querySelectorAll('.export-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');document.getElementById('exportFmt').style.display=tab==='fmt'?'block':'none';document.getElementById('exportMd').style.display=tab==='md'?'block':'none';}
function copyExport(type){const el=type==='html'?document.getElementById('exportFmt'):document.getElementById('exportMd');navigator.clipboard.writeText(el.innerText).then(()=>alert('Copied to clipboard'));}

function runBuildAudit(n){
  var CF=window.CharacterForge;
  var ancestryData=(CF.data.ancestries&&CF.data.ancestries[n.ancestry])||{attrBonus:1,freeEdges:1,pace:6,size:0,toughMod:0};
  var skillLinks=CF.data.skillLinks||{};
  var coreSkills=CF.data.coreSkills||['Athletics','Common Knowledge','Notice','Persuasion','Stealth'];
  return window.SWADERules.runBuildAudit({
    attrs:{agility:n.agility,smarts:n.smarts,spirit:n.spirit,strength:n.strength,vigor:n.vigor},
    skills:n.skills, edges:n.edges, hindrances:n.hindrances,
    tier:n.tier, ancestryData:ancestryData, ancestry:n.ancestry||'',
    skillLinks:skillLinks, coreSkills:coreSkills,
    pace:n.pace, parry:n.parry, toughness:n.toughness, toughnessArmor:n.toughnessArmor||0
  });
}

function renderAuditPanel(n){
  const results=runBuildAudit(n);
  const legal=results.every(r=>r.pass);
  let html=`<div class="audit-block"><h4 style="color:var(--accent);margin-bottom:8px;font-size:14px">${esc(n.name)} ‚Äî Build Audit</h4>`,curSec='';
  results.forEach(r=>{
    if(r.section!==curSec){curSec=r.section;html+=`<div class="audit-section"><h4>${esc(curSec)}</h4>`;}
    const cls=r.warn?'audit-warn':r.pass?'audit-pass':'audit-fail';
    const icon=r.warn?'‚ö†':r.pass?'‚úì':'‚úó';
    html+=`<div class="audit-line ${cls}">${icon} ${esc(r.label)} ${esc(r.detail)}</div>`;
  });
  html+='</div></div>';
  // Funds audit
  let baseFunds=500,fundsNote='';
  if(n.edges.some(e=>e.toLowerCase().includes('filthy rich'))){baseFunds=2500;fundsNote=' (Filthy Rich x5)';}
  else if(n.edges.some(e=>e.toLowerCase()==='rich')){baseFunds=1500;fundsNote=' (Rich x3)';}
  if(n.hindrances.some(h=>h.toLowerCase().includes('poverty'))){baseFunds=Math.floor(baseFunds/2);fundsNote+=' (Poverty half)';}
  const funds=n.startingFunds||baseFunds, spent=n.gearCost||0, remaining=funds-spent;
  const fundsPass=remaining>=0;
  const fundsWarn=remaining>50&&n.category==='Pre-gen';
  html+='<div class="audit-block"><div class="audit-section"><h4>Equipment Funds</h4>';
  html+=`<div class="audit-line ${fundsPass?'audit-pass':'audit-fail'}">${fundsPass?'‚úì':'‚úó'} Starting funds: ${funds}${fundsNote}‚Ç°</div>`;
  html+=`<div class="audit-line ${fundsPass?'audit-pass':'audit-fail'}">${fundsPass?'‚úì':'‚úó'} Gear cost: ${spent}‚Ç° ‚Äî Remaining: ${remaining}‚Ç° ${fundsPass?'‚úì':'OVER BUDGET'}</div>`;
  if(fundsWarn) html+='<div class="audit-line audit-warn">‚ö† '+remaining+'‚Ç° unspent ‚Äî consider additional gear</div>';
  html+='</div></div>';
  const inCanon=canonCommitted.has(n.name);
  const commitLabel=inCanon?'üîÑ Update Canon':'üì¶ Commit to Canon';
  const removeBtn=inCanon?'<button class="btn" onclick="removeFromCanon()" style="color:var(--red);border-color:var(--red)" title="Remove this character from canonical data">üóë Remove from Canon</button>':'';
  // Lifecycle info
  const lc=getLifecycle(n.name);
  const dirty=isCharDirty(n.name);
  const pubProds=getPublishedProducts(n.name);
  html+='<div class="audit-block"><div class="audit-section"><h4>Release Lifecycle</h4>';
  const lcColour=lc==='published'?'var(--green)':lc==='committed'?'#e8b84e':'var(--text-dim)';
  const lcIcon=lc==='published'?'üîí':lc==='committed'?'üì¶':'üìù';
  html+=`<div class="audit-line audit-pass">${lcIcon} Status: <span style="color:${lcColour};text-transform:uppercase">${lc}</span></div>`;
  if(pubProds.length) html+=`<div class="audit-line audit-pass">Published in: ${pubProds.map(p=>esc(p.code)+' ‚Äî '+esc(p.title)+' ('+new Date(p.releasedAt).toLocaleDateString()+')').join(', ')}</div>`;
  if(dirty){
    const diff=getCharDiff(n.name);
    html+=`<div class="audit-line audit-warn">‚úèÔ∏è ${diff.length} pending change${diff.length===1?'':'s'} since last approval</div>`;
    diff.forEach(d=>html+=`<div class="audit-line" style="padding-left:20px;font-size:11px;color:${d.type==='added'?'var(--green)':d.type==='removed'?'var(--red)':'var(--accent)'}">${d.type==='added'?'+':d.type==='removed'?'‚àí':'~'} ${esc(d.text)}</div>`);
  }else{
    html+='<div class="audit-line audit-pass">‚úì No pending changes ‚Äî matches baseline</div>';
  }
  // Override log
  if(n.overrideLog&&n.overrideLog.length){
    html+='<h4 style="margin-top:10px">Errata Log</h4>';
    n.overrideLog.forEach(o=>{
      html+=`<div class="audit-line" style="font-size:11px;border-left:2px solid #cc3333;padding-left:8px;margin-bottom:4px">
        <span style="color:var(--text-dim)">${new Date(o.date).toLocaleDateString()}</span> ‚Äî <span style="color:#ee6666">${esc(o.reason)}</span>
        ${o.changes?'<br>'+o.changes.map(c=>esc(c.text)).join(', '):''}
      </div>`;
    });
  }
  html+='</div></div>';
  html+=`<div id="commitArea" style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border)">
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button class="btn primary" onclick="prepareCommit()" title="${inCanon?'Update canonical data':'Commit current state to canon repository'}">${commitLabel}</button>
      ${removeBtn}
      <span style="font-size:12px;color:var(--text-dim)">${legal?'‚úÖ Build legal ‚Äî ready to commit':'‚ùå Build has issues ‚Äî commit with caution'}</span>
    </div>
    <div id="commitPreview" style="margin-top:10px"></div>
  </div>`;
  document.getElementById('panelContent').innerHTML=html;
}

function toggleStatus(field,val){currentNPC[field]=val;saveCharacter(currentNPC);filterNPCs();updateHeaderStats();}
function deleteNPC(){
  if(!confirm(`Delete ${currentNPC.name}?`))return;
  allNPCs=allNPCs.filter(n=>n.name!==currentNPC.name);currentNPC=null;
  hideBottomBar();scheduleSave();
  document.getElementById('mainContent').innerHTML='Select an NPC or create a new one';
  document.getElementById('mainContent').classList.add('empty-state');
  filterNPCs();updateHeaderStats();
}
function openNewNPCModal(){document.getElementById('newNpcModal').classList.add('active');}
function closeNewNPCModal(){document.getElementById('newNpcModal').classList.remove('active');}
function createNPC(){
  const name=document.getElementById('new_name').value.trim();if(!name){alert('Name is required');return;}
  const npc={name,refCode:'',concept:document.getElementById('new_concept')?.value?.trim()||'',ancestry:document.getElementById('new_ancestry').value,region:document.getElementById('new_region').value,tier:document.getElementById('new_tier').value,rank:'Novice',category:document.getElementById('new_category').value,product:'',source:'custom',agility:0,smarts:0,spirit:0,strength:0,vigor:0,skills:{},edges:[],edgeNotes:{},hindrances:[],powers:[],gearText:'',quote:'',description:'',background:'',motivation:'',secret:'',services:'',adventureHook:'',tactics:'',abName:'',abSkill:'',pp:0,statComplete:false,narrativeComplete:false,fgReady:false,pace:6,parry:2,toughness:5,toughnessArmor:0,bennies:0,startingFunds:500,gearCost:0};
  calcDerived(npc);allNPCs.push(npc);saveCharacter(npc);captureBaseline(name);closeNewNPCModal();filterNPCs();updateHeaderStats();selectNPC(name);
}

// === TRANSFER (IMPORT / EXPORT) ===
function buildExportJSON(n){
  return {
    _format:'diceforge-character-v1',
    name:n.name,refCode:n.refCode||'',concept:n.concept||'',ancestry:n.ancestry||'Human',
    region:n.region||'Ammaria',tier:n.tier||'Wild Card',rank:n.rank||'Novice',
    category:n.category||'NPC',product:n.product||'',
    attributes:{agility:n.agility||4,smarts:n.smarts||4,spirit:n.spirit||4,strength:n.strength||4,vigor:n.vigor||4},
    skills:Object.assign({},n.skills),edges:[...(n.edges||[])],hindrances:[...(n.hindrances||[])],
    powers:[...(n.powers||[])],weapons:[...(n.weapons||[])],armour:[...(n.armour||[])],
    gearText:n.gearText||'',
    abName:n.abName||'',abSkill:n.abSkill||'',pp:n.pp||0,
    pace:n.pace||6,parry:n.parry||2,toughness:n.toughness||5,toughnessArmor:n.toughnessArmor||0,
    bennies:n.bennies||0,startingFunds:n.startingFunds||500,gearCost:n.gearCost||0,
    quote:n.quote||'',description:n.description||'',background:n.background||'',
    motivation:n.motivation||'',secret:n.secret||'',services:n.services||'',
    adventureHook:n.adventureHook||'',tactics:n.tactics||''
  };
}

function buildStatBlockText(n){
  const lines=[];
  lines.push(n.name+(n.concept?' ‚Äî '+n.concept:''));
  lines.push('');
  if(n.quote) lines.push('"'+n.quote+'"','');
  if(n.description) lines.push(n.description,'');
  lines.push('Attributes: Agility d'+n.agility+', Smarts d'+n.smarts+', Spirit d'+n.spirit+', Strength d'+n.strength+', Vigor d'+n.vigor);
  lines.push('Skills: '+Object.entries(n.skills).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>k+' d'+v).join(', '));
  const tDisp=n.toughnessArmor>0?n.toughness+' ('+n.toughnessArmor+')':''+n.toughness;
  lines.push('Pace: '+n.pace+'; Parry: '+n.parry+'; Toughness: '+tDisp);
  if(n.edges.length) lines.push('Edges: '+n.edges.join(', '));
  if(n.hindrances.length) lines.push('Hindrances: '+n.hindrances.join(', '));
  if(n.powers.length) lines.push('Powers: '+n.powers.join(', ')+(n.pp?' ('+n.pp+' Power Points)':''));
  if(n.weapons.length) lines.push('Weapons: '+n.weapons.map(w=>w.name+' ('+w.damage+(w.ap?', AP '+w.ap:'')+(w.range?', '+w.range:'')+')').join(', '));
  if(n.armour.length) lines.push('Armour: '+n.armour.map(a=>a.name+' (+'+a.armor+')').join(', '));
  if(n.gearText) lines.push('Gear: '+n.gearText);
  if(n.abName) lines.push('Arcane Background: '+n.abName+(n.abSkill?' ('+n.abSkill+')':''));
  return lines.join('\n');
}

function renderTransferPanel(n){
  document.getElementById('panelContent').innerHTML=`
    <div style="margin-bottom:16px">
      <h4 style="color:var(--accent);margin-bottom:8px">Export: ${esc(n.name)}</h4>
      <div style="display:flex;gap:4px;margin-bottom:8px;flex-wrap:wrap">
        <button class="btn sm" onclick="setExportFmt('json')" id="expFmtJSON" style="border-color:var(--accent);color:var(--accent)">JSON</button>
        <button class="btn sm" onclick="setExportFmt('text')" id="expFmtText">Text</button>
        <button class="btn sm" onclick="setExportFmt('html')" id="expFmtHTML">HTML</button>
        <button class="btn sm" onclick="setExportFmt('rtf')" id="expFmtRTF">RTF</button>
      </div>
      <div id="exportFormatNote" style="font-size:11px;color:var(--text-dim);margin-bottom:6px"></div>
      <textarea id="exportPreview" readonly rows="12" style="width:100%;box-sizing:border-box;font-family:monospace;font-size:11px;background:var(--bg-body);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:8px;resize:vertical"></textarea>
      <div style="display:flex;gap:6px;margin-top:8px">
        <button class="btn primary" onclick="copyExport()">üìã Copy to Clipboard</button>
        <button class="btn" onclick="downloadExport()">üíæ Download File</button>
      </div>
    </div>
    <hr style="border-color:var(--border);margin:16px 0">
    <div>
      <h4 style="color:var(--accent);margin-bottom:8px">Import Character</h4>
      <div style="margin-bottom:8px;font-size:12px;color:var(--text-dim)">
        <strong style="color:var(--green)">JSON</strong> ‚Äî lossless, recommended.
        <strong style="color:#e6a117">Text / HTML / RTF</strong> ‚Äî best-effort parse, review carefully.
      </div>
      <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
        <label style="font-size:11px;text-transform:uppercase;color:var(--text-dim)">Source</label>
        <button class="btn sm" id="impSrcPaste" onclick="setImportSource('paste')" style="border-color:var(--accent);color:var(--accent)">Paste Text</button>
        <button class="btn sm" id="impSrcFile" onclick="setImportSource('file')">Upload File</button>
      </div>
      <div id="importPasteArea">
        <textarea id="import_data" rows="6" placeholder="Paste character JSON, stat block text, or HTML here..." style="width:100%;box-sizing:border-box;font-family:monospace;font-size:11px;background:var(--bg-input);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:8px;resize:vertical"></textarea>
      </div>
      <div id="importFileArea" style="display:none">
        <div style="border:2px dashed var(--border);border-radius:6px;padding:14px;text-align:center;margin-bottom:6px">
          <div style="font-size:12px;color:var(--text-dim);margin-bottom:6px">Drop a file or click to browse</div>
          <input type="file" id="import_file" accept=".json,.txt,.html,.htm,.rtf" onchange="handleImportFile(this)" style="display:block;margin:0 auto;font-size:12px">
          <div style="font-size:10px;color:var(--text-dim);margin-top:4px">Accepts: .json, .txt, .html, .rtf</div>
        </div>
        <div id="importFileName" style="font-size:12px;color:var(--accent)"></div>
      </div>
      <div id="importPreview" style="margin-top:6px;font-size:12px;max-height:120px;overflow-y:auto"></div>
      <div id="importStatus" style="margin-top:4px;font-size:13px"></div>
      <div style="display:flex;gap:6px;margin-top:8px">
        <button class="btn" onclick="previewImport()">üëÅ Preview</button>
        <button class="btn primary" id="importBtn" onclick="executeImport()">‚áÑ Import Character</button>
      </div>
    </div>`;
  setExportFmt('json');
}

var currentExportFmt='json';
function setExportFmt(fmt){
  currentExportFmt=fmt;
  const ta=document.getElementById('exportPreview');
  const note=document.getElementById('exportFormatNote');
  if(!ta||!currentNPC) return;
  ['json','text','html','rtf'].forEach(f=>{
    const btn=document.getElementById('expFmt'+f.toUpperCase());
    if(btn){btn.style.borderColor=f===fmt?'var(--accent)':'var(--border)';btn.style.color=f===fmt?'var(--accent)':'var(--text-dim)';}
  });
  const notes={
    json:'Lossless ‚Äî full character data. Use for Forge/Vault transfer.',
    text:'Plain text stat block ‚Äî for documents, sharing with players. Not reliably re-importable.',
    html:'Formatted HTML ‚Äî opens in any browser. Import is experimental.',
    rtf:'Rich Text Format ‚Äî Download opens in Word/LibreOffice. Copy pastes as formatted text into Word.'
  };
  note.textContent=notes[fmt]||'';
  if(fmt==='json') ta.value=JSON.stringify(buildExportJSON(currentNPC),null,2);
  else if(fmt==='text') ta.value=buildStatBlockText(currentNPC);
  else if(fmt==='html') ta.value=buildExportHTML(currentNPC);
  else if(fmt==='rtf') ta.value=buildStatBlockText(currentNPC);
}

function copyExport(){
  if(!currentNPC) return;
  if(currentExportFmt==='rtf'){
    // Copy as HTML so Word pastes formatted text, not RTF codes
    const html=buildExportHTML(currentNPC);
    const blob=new Blob([html],{type:'text/html'});
    const item=new ClipboardItem({'text/html':blob,'text/plain':new Blob([buildStatBlockText(currentNPC)],{type:'text/plain'})});
    navigator.clipboard.write([item]).then(()=>showCopyToast('Formatted text copied ‚Äî paste into Word'));
    return;
  }
  const ta=document.getElementById('exportPreview');
  if(!ta) return;
  navigator.clipboard.writeText(ta.value).then(()=>showCopyToast(currentExportFmt.toUpperCase()+' copied to clipboard'));
}

function downloadExport(){
  if(!currentNPC) return;
  const safeName=currentNPC.name.replace(/[^a-zA-Z0-9_-]/g,'_');
  const exts={json:'.json',text:'.txt',html:'.html',rtf:'.rtf'};
  const mimes={json:'application/json',text:'text/plain',html:'text/html',rtf:'application/rtf'};
  const ext=exts[currentExportFmt]||'.txt';
  const mime=mimes[currentExportFmt]||'text/plain';
  // For RTF download, use actual RTF content, not the preview text
  const content=currentExportFmt==='rtf'?buildExportRTF(currentNPC):document.getElementById('exportPreview').value;
  const blob=new Blob([content],{type:mime});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=safeName+ext;
  a.click();
  URL.revokeObjectURL(a.href);
  showCopyToast('Downloaded '+safeName+ext);
}

function buildExportJSON(n){
  return {
    _format:'diceforge-character-v1',
    name:n.name,refCode:n.refCode||'',concept:n.concept||'',ancestry:n.ancestry||'Human',
    region:n.region||'Ammaria',tier:n.tier||'Wild Card',rank:n.rank||'Novice',
    category:n.category||'NPC',product:n.product||'',
    attributes:{agility:n.agility||4,smarts:n.smarts||4,spirit:n.spirit||4,strength:n.strength||4,vigor:n.vigor||4},
    skills:Object.assign({},n.skills),edges:[...(n.edges||[])],hindrances:[...(n.hindrances||[])],
    powers:[...(n.powers||[])],weapons:[...(n.weapons||[])],armour:[...(n.armour||[])],
    gearText:n.gearText||'',
    abName:n.abName||'',abSkill:n.abSkill||'',pp:n.pp||0,
    pace:n.pace||6,parry:n.parry||2,toughness:n.toughness||5,toughnessArmor:n.toughnessArmor||0,
    bennies:n.bennies||0,startingFunds:n.startingFunds||500,gearCost:n.gearCost||0,
    quote:n.quote||'',description:n.description||'',background:n.background||'',
    motivation:n.motivation||'',secret:n.secret||'',services:n.services||'',
    adventureHook:n.adventureHook||'',tactics:n.tactics||''
  };
}

function buildStatBlockText(n){
  const lines=[];
  lines.push(n.name+(n.concept?' ‚Äî '+n.concept:''));
  lines.push('');
  if(n.quote) lines.push('"'+n.quote+'"','');
  if(n.description) lines.push(n.description,'');
  lines.push('Attributes: Agility d'+n.agility+', Smarts d'+n.smarts+', Spirit d'+n.spirit+', Strength d'+n.strength+', Vigor d'+n.vigor);
  lines.push('Skills: '+Object.entries(n.skills).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>k+' d'+v).join(', '));
  const tDisp=n.toughnessArmor>0?n.toughness+' ('+n.toughnessArmor+')':''+n.toughness;
  lines.push('Pace: '+n.pace+'; Parry: '+n.parry+'; Toughness: '+tDisp);
  if(n.edges.length) lines.push('Edges: '+n.edges.join(', '));
  if(n.hindrances.length) lines.push('Hindrances: '+n.hindrances.join(', '));
  if(n.powers.length) lines.push('Powers: '+n.powers.join(', ')+(n.pp?' ('+n.pp+' Power Points)':''));
  if(n.weapons.length) lines.push('Weapons: '+n.weapons.map(w=>w.name+' ('+w.damage+(w.ap?', AP '+w.ap:'')+(w.range?', '+w.range:'')+')').join(', '));
  if(n.armour.length) lines.push('Armour: '+n.armour.map(a=>a.name+' (+'+a.armor+')').join(', '));
  if(n.gearText) lines.push('Gear: '+n.gearText);
  if(n.abName) lines.push('Arcane Background: '+n.abName+(n.abSkill?' ('+n.abSkill+')':''));
  return lines.join('\n');
}

function buildExportHTML(n){
  const tDisp=n.toughnessArmor>0?n.toughness+' ('+n.toughnessArmor+')':''+n.toughness;
  const wcStar=n.tier==='Wild Card'?' ‚òÖ':'';
  let h='<!DOCTYPE html>\n<html><head><meta charset="utf-8"><title>'+esc(n.name)+'</title>\n';
  h+='<style>body{font-family:Georgia,serif;max-width:700px;margin:40px auto;padding:20px;color:#222;line-height:1.6}';
  h+='h1{font-size:22px;margin-bottom:2px;color:#8b0000}h2{font-size:14px;color:#666;font-weight:normal;margin-top:0}';
  h+='.quote{font-style:italic;color:#555;margin:12px 0;border-left:3px solid #8b0000;padding-left:12px}';
  h+='.desc{margin:12px 0}.stat-label{font-weight:bold;color:#8b0000}.stat-line{margin:4px 0}';
  h+='.section{margin:8px 0}.footer{margin-top:20px;padding-top:10px;border-top:1px solid #ccc;font-size:11px;color:#999}</style></head><body>\n';
  h+='<h1>'+esc(n.name)+wcStar+'</h1>\n';
  if(n.concept) h+='<h2>'+esc(n.concept)+'</h2>\n';
  if(n.quote) h+='<div class="quote">"'+esc(n.quote)+'"</div>\n';
  if(n.description) h+='<div class="desc">'+esc(n.description)+'</div>\n';
  h+='<div class="stat-line"><span class="stat-label">Attributes:</span> Agility d'+n.agility+', Smarts d'+n.smarts+', Spirit d'+n.spirit+', Strength d'+n.strength+', Vigor d'+n.vigor+'</div>\n';
  h+='<div class="stat-line"><span class="stat-label">Skills:</span> '+Object.entries(n.skills).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>k+' d'+v).join(', ')+'</div>\n';
  h+='<div class="stat-line"><span class="stat-label">Pace:</span> '+n.pace+'; <span class="stat-label">Parry:</span> '+n.parry+'; <span class="stat-label">Toughness:</span> '+tDisp+'</div>\n';
  if(n.edges.length) h+='<div class="stat-line"><span class="stat-label">Edges:</span> '+n.edges.map(e=>esc(e)).join(', ')+'</div>\n';
  if(n.hindrances.length) h+='<div class="stat-line"><span class="stat-label">Hindrances:</span> '+n.hindrances.map(x=>esc(x)).join(', ')+'</div>\n';
  if(n.powers.length) h+='<div class="stat-line"><span class="stat-label">Powers:</span> '+n.powers.map(p=>esc(p)).join(', ')+(n.pp?' ('+n.pp+' PP)':'')+'</div>\n';
  if(n.weapons.length) h+='<div class="stat-line"><span class="stat-label">Weapons:</span> '+n.weapons.map(w=>esc(w.name)+' ('+esc(w.damage)+(w.ap?', AP '+w.ap:'')+(w.range?', '+esc(w.range):'')+')').join(', ')+'</div>\n';
  if(n.armour.length) h+='<div class="stat-line"><span class="stat-label">Armour:</span> '+n.armour.map(a=>esc(a.name)+' (+'+a.armor+')').join(', ')+'</div>\n';
  if(n.gearText) h+='<div class="stat-line"><span class="stat-label">Gear:</span> '+esc(n.gearText)+'</div>\n';
  if(n.abName) h+='<div class="stat-line"><span class="stat-label">Arcane Background:</span> '+esc(n.abName)+(n.abSkill?' ('+esc(n.abSkill)+')':'')+'</div>\n';
  h+='<div class="footer">Exported from DiceForge Character Vault ‚Äî diceforge-character-v1</div>\n';
  h+='</body></html>';
  return h;
}

function buildExportRTF(n){
  const tDisp=n.toughnessArmor>0?n.toughness+' ('+n.toughnessArmor+')':''+n.toughness;
  const wcStar=n.tier==='Wild Card'?' *':'';
  const re=s=>(s||'').replace(/\\/g,'\\\\').replace(/\{/g,'\\{').replace(/\}/g,'\\}');
  let r='{\\rtf1\\ansi\\deff0{\\fonttbl{\\f0 Georgia;}{\\f1 Arial;}}{\\colortbl;\\red139\\green0\\blue0;\\red100\\green100\\blue100;}\n';
  r+='\\f0\\fs24\\b '+re(n.name)+wcStar+'\\b0\\par\n';
  if(n.concept) r+='{\\f1\\fs20\\cf2 '+re(n.concept)+'}\\par\n';
  if(n.quote) r+='\\par{\\i "'+re(n.quote)+'"}\\par\n';
  if(n.description) r+='\\par '+re(n.description)+'\\par\n';
  r+='\\par{\\b\\cf1 Attributes:} Agility d'+n.agility+', Smarts d'+n.smarts+', Spirit d'+n.spirit+', Strength d'+n.strength+', Vigor d'+n.vigor+'\\par\n';
  r+='{\\b\\cf1 Skills:} '+Object.entries(n.skills).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>re(k)+' d'+v).join(', ')+'\\par\n';
  r+='{\\b\\cf1 Pace:} '+n.pace+'; {\\b\\cf1 Parry:} '+n.parry+'; {\\b\\cf1 Toughness:} '+tDisp+'\\par\n';
  if(n.edges.length) r+='{\\b\\cf1 Edges:} '+n.edges.map(e=>re(e)).join(', ')+'\\par\n';
  if(n.hindrances.length) r+='{\\b\\cf1 Hindrances:} '+n.hindrances.map(x=>re(x)).join(', ')+'\\par\n';
  if(n.powers.length) r+='{\\b\\cf1 Powers:} '+n.powers.map(p=>re(p)).join(', ')+(n.pp?' ('+n.pp+' PP)':'')+'\\par\n';
  if(n.weapons.length) r+='{\\b\\cf1 Weapons:} '+n.weapons.map(w=>re(w.name)+' ('+re(w.damage)+(w.ap?', AP '+w.ap:'')+(w.range?', '+re(w.range):'')+')').join(', ')+'\\par\n';
  if(n.armour.length) r+='{\\b\\cf1 Armour:} '+n.armour.map(a=>re(a.name)+' (+'+a.armor+')').join(', ')+'\\par\n';
  if(n.gearText) r+='{\\b\\cf1 Gear:} '+re(n.gearText)+'\\par\n';
  if(n.abName) r+='{\\b\\cf1 Arcane Background:} '+re(n.abName)+(n.abSkill?' ('+re(n.abSkill)+')':'')+'\\par\n';
  r+='\\par{\\f1\\fs16\\cf2 Exported from DiceForge Character Vault}\\par\n}';
  return r;
}

function showCopyToast(msg){
  const t=document.createElement('div');
  t.textContent=msg;
  t.style.cssText='position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--green);color:#000;padding:8px 16px;border-radius:4px;font-size:13px;z-index:9999;font-weight:600';
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),2000);
}

// === IMPORT ===
function openImportModal(){/* legacy ‚Äî import is now inline in the transfer panel */}
function closeImportModal(){/* legacy ‚Äî no modal to close */}

function setImportSource(mode){
  document.getElementById('importPasteArea').style.display=mode==='paste'?'block':'none';
  document.getElementById('importFileArea').style.display=mode==='file'?'block':'none';
  document.getElementById('impSrcPaste').style.borderColor=mode==='paste'?'var(--accent)':'var(--border)';
  document.getElementById('impSrcPaste').style.color=mode==='paste'?'var(--accent)':'var(--text-dim)';
  document.getElementById('impSrcFile').style.borderColor=mode==='file'?'var(--accent)':'var(--border)';
  document.getElementById('impSrcFile').style.color=mode==='file'?'var(--accent)':'var(--text-dim)';
}

function handleImportFile(input){
  const file=input.files[0];if(!file) return;
  document.getElementById('importFileName').textContent='üìÑ '+file.name+' ('+Math.round(file.size/1024)+'KB)';
  const reader=new FileReader();
  reader.onload=function(e){
    const text=e.target.result;
    document.getElementById('import_data').value=text;
    // Auto-detect format
    const ext=file.name.split('.').pop().toLowerCase();
    document.getElementById('importStatus').innerHTML='<span style="color:var(--accent)">File loaded ‚Äî '+ext.toUpperCase()+' detected. Click Preview to validate.</span>';
  };
  reader.readAsText(file);
}

function previewImport(){
  let raw=document.getElementById('import_data').value.trim();
  const prev=document.getElementById('importPreview');
  const stat=document.getElementById('importStatus');
  if(!raw){stat.innerHTML='<span style="color:var(--red)">Nothing to preview ‚Äî paste data or upload a file first</span>';return;}
  try{
    const npc=autoParseImport(raw);
    prev.innerHTML=`<div style="padding:8px;background:var(--bg-body);border:1px solid var(--border);border-radius:4px">
      <strong style="color:var(--accent)">${esc(npc.name)}</strong> ${esc(npc.concept||'')}
      <div style="margin-top:4px;font-size:11px">
      <div><strong>Ancestry:</strong> ${esc(npc.ancestry)} | <strong>Tier:</strong> ${esc(npc.tier)} | <strong>Category:</strong> ${esc(npc.category)}</div>
      <div><strong>Attributes:</strong> Agi d${npc.agility}, Sma d${npc.smarts}, Spi d${npc.spirit}, Str d${npc.strength}, Vig d${npc.vigor}</div>
      <div><strong>Skills:</strong> ${Object.entries(npc.skills).map(([k,v])=>k+' d'+v).join(', ')||'None'}</div>
      <div><strong>Edges:</strong> ${(npc.edges||[]).join(', ')||'None'}</div>
      <div><strong>Hindrances:</strong> ${(npc.hindrances||[]).join(', ')||'None'}</div>
      <div><strong>Weapons:</strong> ${(npc.weapons||[]).map(w=>w.name).join(', ')||'None'}</div>
      <div><strong>Armour:</strong> ${(npc.armour||[]).map(a=>a.name).join(', ')||'None'}</div>
      ${npc._importWarning?'<div style="color:#e6a117;margin-top:4px">'+npc._importWarning+'</div>':''}
      </div></div>`;
    prev._parsedNPC=npc;
    stat.innerHTML='<span style="color:var(--green)">‚úì Parsed successfully ‚Äî click Import to add</span>';
    const exists=allNPCs.find(n=>n.name===npc.name);
    if(exists) stat.innerHTML+='<br><span style="color:#e6a117">‚ö† "'+esc(npc.name)+'" already exists ‚Äî importing will create a duplicate</span>';
  }catch(e){
    prev.innerHTML='';prev._parsedNPC=null;
    stat.innerHTML='<span style="color:var(--red)">‚ùå Parse error: '+esc(e.message)+'</span>';
  }
}

function executeImport(){
  const prev=document.getElementById('importPreview');
  const stat=document.getElementById('importStatus');
  if(!prev._parsedNPC){stat.innerHTML='<span style="color:var(--red)">Preview first to validate the data</span>';return;}
  const npc=prev._parsedNPC;
  delete npc._importWarning;
  npc.weapons=npc.weapons||[];npc.armour=npc.armour||[];
  calcDerived(npc);
  allNPCs.push(npc);
  saveCharacter(npc);captureBaseline(npc.name);
  filterNPCs();updateHeaderStats();selectNPC(npc.name);
}

function autoParseImport(raw){
  // Try JSON first
  const trimmed=raw.trim();
  if(trimmed.startsWith('{')){
    try{return parseImportJSON(trimmed);}catch(e){}
  }
  // Strip HTML tags if present
  if(trimmed.includes('<html')||trimmed.includes('<div')||trimmed.includes('<span')||trimmed.includes('<p')){
    const stripped=stripHTML(trimmed);
    const npc=parseImportStatBlock(stripped);
    npc._importWarning='‚ö† Imported from HTML ‚Äî weapons, armour and gear require manual entry. Review all fields.';
    return npc;
  }
  // Strip RTF codes if present
  if(trimmed.startsWith('{\\rtf')){
    const stripped=stripRTF(trimmed);
    const npc=parseImportStatBlock(stripped);
    npc._importWarning='‚ö† Imported from RTF ‚Äî weapons, armour and gear require manual entry. Review all fields.';
    return npc;
  }
  // Plain text stat block
  const npc=parseImportStatBlock(trimmed);
  npc._importWarning='‚ö† Imported from text ‚Äî weapons, armour and gear require manual entry. Review all fields.';
  return npc;
}

function stripHTML(html){
  const tmp=document.createElement('div');
  tmp.innerHTML=html;
  return tmp.textContent||tmp.innerText||'';
}

function stripRTF(rtf){
  // Remove RTF header, control words, groups
  let text=rtf;
  text=text.replace(/\{\\fonttbl[^}]*\}/g,'');
  text=text.replace(/\{\\colortbl[^}]*\}/g,'');
  text=text.replace(/\\par\b/g,'\n');
  text=text.replace(/\\tab\b/g,' ');
  text=text.replace(/\\line\b/g,'\n');
  text=text.replace(/\\'([0-9a-fA-F]{2})/g,(m,hex)=>String.fromCharCode(parseInt(hex,16)));
  text=text.replace(/\\[a-z]+\d*\s?/gi,'');
  text=text.replace(/[{}]/g,'');
  text=text.replace(/\n{3,}/g,'\n\n');
  return text.trim();
}

function parseImportJSON(raw){
  let obj;
  try{obj=JSON.parse(raw);}catch(e){throw new Error('Invalid JSON ‚Äî check formatting');}
  if(!obj.name) throw new Error('Missing required field: name');
  const a=obj.attributes||obj.attrs||{};
  return {
    name:obj.name,refCode:obj.refCode||'',concept:obj.concept||'',ancestry:obj.ancestry||'Human',
    region:obj.region||'Ammaria',tier:obj.tier||'Wild Card',rank:obj.rank||'Novice',
    category:obj.category||'NPC',product:obj.product||'',source:'import',
    agility:a.agility||obj.agility||4,smarts:a.smarts||obj.smarts||4,spirit:a.spirit||obj.spirit||4,
    strength:a.strength||obj.strength||4,vigor:a.vigor||obj.vigor||4,
    skills:obj.skills||{},edges:obj.edges||[],edgeNotes:obj.edgeNotes||{},hindrances:obj.hindrances||[],
    powers:obj.powers||[],weapons:obj.weapons||[],armour:obj.armour||[],
    gearText:obj.gearText||'',quote:obj.quote||'',description:obj.description||'',
    background:obj.background||'',motivation:obj.motivation||'',secret:obj.secret||'',
    services:obj.services||'',adventureHook:obj.adventureHook||'',tactics:obj.tactics||'',
    abName:obj.abName||'',abSkill:obj.abSkill||'',pp:obj.pp||0,
    startingFunds:obj.startingFunds||500,gearCost:obj.gearCost||0,
    pace:obj.pace||6,parry:obj.parry||2,toughness:obj.toughness||5,
    toughnessArmor:obj.toughnessArmor||0,bennies:obj.bennies||0,
    statComplete:false,narrativeComplete:false,fgReady:false
  };
}

function parseImportStatBlock(raw){
  const lines=raw.split('\n').map(l=>l.trim()).filter(l=>l);
  const npc={name:'',refCode:'',concept:'',ancestry:'Human',region:'Ammaria',tier:'Wild Card',rank:'Novice',
    category:'NPC',product:'',source:'import-statblock',agility:4,smarts:4,spirit:4,strength:4,vigor:4,
    skills:{},edges:[],hindrances:[],powers:[],weapons:[],armour:[],gearText:'',quote:'',description:'',
    background:'',motivation:'',secret:'',services:'',adventureHook:'',tactics:'',
    abName:'',abSkill:'',pp:0,startingFunds:500,gearCost:0,pace:6,parry:2,toughness:5,toughnessArmor:0,bennies:0,
    statComplete:false,narrativeComplete:false,fgReady:false};
  if(lines.length) npc.name=lines[0].replace(/\*+/g,'').replace(/‚Äî.*/,'').replace(/--.*/,'').trim();
  for(const line of lines){
    const lo=line.toLowerCase();
    if(lo.startsWith('attributes:')){
      const m=line.match(/agility\s*d(\d+)/i);if(m) npc.agility=parseInt(m[1]);
      const m2=line.match(/smarts\s*d(\d+)/i);if(m2) npc.smarts=parseInt(m2[1]);
      const m3=line.match(/spirit\s*d(\d+)/i);if(m3) npc.spirit=parseInt(m3[1]);
      const m4=line.match(/strength\s*d(\d+)/i);if(m4) npc.strength=parseInt(m4[1]);
      const m5=line.match(/vigor\s*d(\d+)/i);if(m5) npc.vigor=parseInt(m5[1]);
    }
    else if(lo.startsWith('skills:')){
      const parts=line.substring(7).split(',');
      parts.forEach(p=>{const m=p.trim().match(/^(.+?)\s+d(\d+)/);if(m) npc.skills[m[1].trim()]=parseInt(m[2]);});
    }
    else if(lo.startsWith('edges:')) npc.edges=line.substring(6).split(',').map(s=>s.trim()).filter(s=>s);
    else if(lo.startsWith('hindrances:')) npc.hindrances=line.substring(11).split(',').map(s=>s.trim()).filter(s=>s);
    else if(lo.startsWith('powers:')) npc.powers=line.substring(7).replace(/\(.*?\)/g,'').split(',').map(s=>s.trim()).filter(s=>s);
    else if(lo.startsWith('pace:')){
      const pm=line.match(/pace[:\s]*(\d+)/i);if(pm) npc.pace=parseInt(pm[1]);
      const prm=line.match(/parry[:\s]*(\d+)/i);if(prm) npc.parry=parseInt(prm[1]);
      const tm=line.match(/toughness[:\s]*(\d+)/i);if(tm) npc.toughness=parseInt(tm[1]);
      const tam=line.match(/toughness[:\s]*\d+\s*\((\d+)\)/i);if(tam) npc.toughnessArmor=parseInt(tam[1]);
    }
    else if(lo.startsWith('gear:')) npc.gearText=line.substring(5).trim();
    else if(lo.startsWith('arcane background')){
      const abm=line.match(/arcane background[:\s]*(.+?)(?:\s*\((.+?)\))?$/i);
      if(abm){npc.abName=abm[1].trim();if(abm[2]) npc.abSkill=abm[2].trim();}
    }
  }
  if(!npc.name) throw new Error('Could not find character name ‚Äî expected it on the first line');
  if(npc.agility===4&&npc.smarts===4&&npc.spirit===4&&npc.strength===4&&npc.vigor===4&&Object.keys(npc.skills).length===0)
    throw new Error('No attributes or skills found ‚Äî check format: "Attributes: Agility d6, Smarts d8..."');
  return npc;
}
function showStatusView(){
  hideBottomBar();currentNPC=null;activePanel=null;navPush({type:'status'});updateBreadcrumb();
  const el=document.getElementById('mainContent');el.classList.remove('empty-state');el.style.overflowY='auto';
  const rows=allNPCs.map(n=>{
    const audit=runBuildAudit(n);const legal=audit.every(r=>r.pass);
    const inCanon=canonCommitted.has(n.name);
    const lc=getLifecycle(n.name);
    const dirty=isCharDirty(n.name);
    const lcColour=lc==='published'?'var(--green)':lc==='committed'?'#e8b84e':'var(--text-dim)';
    const lcIcon=lc==='published'?'üîí':lc==='committed'?'üì¶':'üìù';
    const dirtyIcon=dirty?(lc==='published'?'<span style="color:#ee6666" title="Errata pending">‚ö†</span>':'<span style="color:#e8b84e" title="Edited">‚úèÔ∏è</span>'):'';
    return `<tr><td style="font-family:monospace;font-size:11px;color:var(--text-dim)">${esc(n.refCode||'‚Äî')}</td><td style="cursor:pointer;color:var(--accent)" onclick="selectNPC('${esc(n.name).replace(/'/g,"\\'")}')">${esc(n.name)}</td><td>${esc(n.category||'NPC')}</td><td>${esc(n.region)}</td><td>${esc(n.tier)}</td><td>${legal?'‚úÖ':'‚ùå'}</td><td style="color:${lcColour}">${lcIcon} ${lc}</td><td>${dirtyIcon}</td><td style="color:${n.statComplete?'var(--green)':'var(--text-dim)'}">&#${n.statComplete?'10003':'8212'};</td><td style="color:${n.narrativeComplete?'var(--green)':'var(--text-dim)'}">&#${n.narrativeComplete?'10003':'8212'};</td><td style="color:${n.fgReady?'var(--green)':'var(--text-dim)'}">&#${n.fgReady?'10003':'8212'};</td></tr>`;
  }).join('');
  const prodSummary=_productRegistry.products.length?`<div style="margin-bottom:14px;font-size:13px;color:var(--text-dim)">Products: ${_productRegistry.products.map(p=>`<span style="color:${p.status==='released'?'var(--green)':p.status==='in-review'?'#e8b84e':'var(--text-dim)'}">${esc(p.code)}</span>`).join(', ')} ¬∑ <a style="color:var(--accent);cursor:pointer" onclick="showProductsModal()">Manage</a></div>`:'';
  el.innerHTML=`<h2 style="color:var(--accent);margin-bottom:14px">Production Status</h2>${prodSummary}<table class="data-table"><tr><th>Ref</th><th>Name</th><th>Type</th><th>Region</th><th>Tier</th><th>Build</th><th>Lifecycle</th><th>Edits</th><th>Stats</th><th>Narrative</th><th>FG Ready</th></tr>${rows}</table>`;
}

// ‚îÄ‚îÄ CANON COMMIT SYSTEM ‚îÄ‚îÄ
const CANON_API='/api/commit';

function buildCanonCharacter(n){
  return {
    name:n.name, refCode:n.refCode||'', concept:n.concept||'', ancestry:n.ancestry||'Human', region:n.region||'Ammaria',
    tier:n.tier||'Wild Card', rank:n.rank||'Novice', category:n.category||'NPC', product:n.product||n.region||'Ammaria',
    attrs:{agility:n.agility||4,smarts:n.smarts||4,spirit:n.spirit||4,strength:n.strength||4,vigor:n.vigor||4},
    skills:Object.assign({},n.skills), edges:[...(n.edges||[])], hindrances:[...(n.hindrances||[])],
    powers:[...(n.powers||[])], weapons:[...(n.weapons||[])], armour:[...(n.armour||[])],
    gear:[...(n.gear||[])], gearText:n.gearText||'',
    abName:n.abName||'', abSkill:n.abSkill||'', pp:n.pp||0,
    pace:n.pace||6, parry:n.parry||2, toughness:n.toughness||5, toughnessArmor:n.toughnessArmor||0, bennies:n.bennies||0,
    startingFunds:n.startingFunds||500, gearCost:n.gearCost||0,
    quote:n.quote||'', description:n.description||'', background:n.background||'',
    motivation:n.motivation||'', secret:n.secret||'', services:n.services||'',
    adventureHook:n.adventureHook||'', tactics:n.tactics||'', notes:n.notes||''
  };
}

function canonFilePath(n){
  const region=(n.region||'ammaria').toLowerCase();
  const cat=(n.category||'NPC').toLowerCase();
  if(cat==='pregen'||cat==='pre-gen') return `${region}/${region}-pregens.json`;
  return `${region}/${region}-npcs.json`;
}

async function flushSave(){if(saveTimer){clearTimeout(saveTimer);saveTimer=null;await pushToGist();}}
async function prepareCommit(){await flushSave();
  if(!currentNPC)return;
  const inCanon=canonCommitted.has(currentNPC.name);
  const canon=buildCanonCharacter(currentNPC);
  const path=canonFilePath(currentNPC);
  const preview=document.getElementById('commitPreview');if(!preview)return;
  preview.innerHTML=`<div style="background:var(--bg-body);border:1px solid var(--border);border-radius:4px;padding:10px;font-size:12px;line-height:1.7;margin-bottom:8px">
    <div style="color:var(--accent);font-weight:bold;margin-bottom:4px">${esc(currentNPC.name)} ‚Üí <code style="color:var(--text-dim);font-size:11px">${esc(path)}</code></div>
    <div><strong>Attributes:</strong> Agi d${canon.attrs.agility}, Sma d${canon.attrs.smarts}, Spi d${canon.attrs.spirit}, Str d${canon.attrs.strength}, Vig d${canon.attrs.vigor}</div>
    <div><strong>Skills:</strong> ${Object.entries(canon.skills).map(([k,v])=>k+' d'+v).join(', ')}</div>
    <div><strong>Edges:</strong> ${canon.edges.join(', ')||'None'}</div>
    <div><strong>Hindrances:</strong> ${canon.hindrances.join(', ')||'None'}</div>
    <div><strong>Powers:</strong> ${canon.powers.join(', ')||'None'}</div>
    <div><strong>Weapons:</strong> ${canon.weapons.map(w=>w.name).join(', ')||'None'}</div>
    <div><strong>Armour:</strong> ${canon.armour.map(a=>a.name+' (+'+a.armor+')').join(', ')||'None'}</div>
    <div><strong>Gear:</strong> ${canon.gearText||canon.gear.map(g=>typeof g==='string'?g:g.name).join(', ')||'None'}</div>
    <div><strong>Derived:</strong> Pace ${canon.pace}, Parry ${canon.parry}, Toughness ${canon.toughness}${canon.toughnessArmor?' ('+canon.toughnessArmor+')':''}</div>
    <div><strong>Funds:</strong> ${canon.startingFunds}‚Ç° starting, ${canon.gearCost}‚Ç° spent</div>
  </div>
  <div style="display:flex;gap:8px;align-items:center">
    <button class="btn primary" id="commitBtn" onclick="executeCommit()">${inCanon?'üîÑ Confirm Update':'üîí Confirm Commit'}</button>
    <button class="btn" onclick="document.getElementById('commitPreview').innerHTML=''">Cancel</button>
  </div>
  <div id="commitStatus" style="margin-top:6px;font-size:13px"></div>`;
}
function openCommitModal(){prepareCommit();}
function closeCommitModal(){const p=document.getElementById('commitPreview');if(p)p.innerHTML='';}

async function executeCommit(){
  const summary='Updated '+currentNPC.name;
  const statusEl=document.getElementById('commitStatus');
  document.getElementById('commitBtn').disabled=true;
  statusEl.innerHTML='<span style="color:var(--accent)">‚è≥ Committing to canon...</span>';
  try{
    const canon=buildCanonCharacter(currentNPC);
    const res=await fetch(CANON_API,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        action:'commit_character',
        secret:'diceforge2026',
        character:canon,
        filePath:canonFilePath(currentNPC),
        summary:summary,
        author:'Character Vault'
      })
    });
    const data=await res.json();
    if(data.success){
      const products=Object.keys(data.affectedProducts||{});
      statusEl.innerHTML=`<span style="color:var(--green)">‚úÖ Committed as <strong>${esc(data.changeId)}</strong></span>
        <div style="margin-top:6px;font-size:12px;color:var(--text-dim)">Pending updates: ${products.filter(p=>p!==canonFilePath(currentNPC)).join(', ')||'None'}</div>`;
      canonCommitted.add(currentNPC.name);
      captureBaseline(currentNPC.name);
      filterNPCs();updateHeaderStats();renderDetail();
      const s=JSON.parse(localStorage.getItem(LS_KEY)||'{}');
      if(s.overrides&&s.overrides[currentNPC.name]){delete s.overrides[currentNPC.name];localStorage.setItem(LS_KEY,JSON.stringify(s));}
    } else {
      statusEl.innerHTML=`<span style="color:var(--red)">‚ùå ${esc(data.error||'Commit failed')}</span>`;
      document.getElementById('commitBtn').disabled=false;
    }
  }catch(err){
    statusEl.innerHTML=`<span style="color:var(--red)">‚ùå Network error: ${esc(err.message)}</span>`;
    document.getElementById('commitBtn').disabled=false;
  }
}

// ‚îÄ‚îÄ REMOVE FROM CANON ‚îÄ‚îÄ
async function removeFromCanon(){
  if(!currentNPC||!canonCommitted.has(currentNPC.name))return;
  if(!confirm(`Remove ${currentNPC.name} from canon?\n\nThis will delete them from the canonical JSON and log the removal in the changelog.`))return;
  const summary=prompt('Removal reason:','Character removed from canon');
  if(!summary)return;
  try{
    const res=await fetch(CANON_API,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        action:'remove_character',
        secret:'diceforge2026',
        characterName:currentNPC.name,
        filePath:canonFilePath(currentNPC),
        region:currentNPC.region||'Ammaria',
        summary:summary,
        author:'Character Vault'
      })
    });
    const data=await res.json();
    if(data.success){
      canonCommitted.delete(currentNPC.name);
      filterNPCs();updateHeaderStats();renderDetail();
      alert(`${currentNPC.name} removed from canon (${data.changeId})`);
    } else {
      alert('Remove failed: '+(data.error||'Unknown error'));
    }
  }catch(err){
    alert('Network error: '+err.message);
  }
}

// ‚îÄ‚îÄ CHANGELOG VIEW ‚îÄ‚îÄ
function showChangelog(){
  hideBottomBar();currentNPC=null;activePanel=null;navPush({type:'changelog'});updateBreadcrumb();
  const el=document.getElementById('mainContent');el.classList.remove('empty-state');el.style.overflowY='auto';
  el.innerHTML='<h2 style="color:var(--accent);margin-bottom:14px">üìã Canon Changelog</h2><div id="changelogContent" style="font-size:13px">Loading...</div>';
  loadChangelog();filterNPCs();
}
function closeChangelogModal(){}

async function loadChangelog(){
  const el=document.getElementById('changelogContent');
  el.innerHTML='<span style="color:var(--accent)">‚è≥ Loading changelog...</span>';
  try{
    const res=await fetch(CANON_API,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'get_changelog',secret:'diceforge2026'})
    });
    const data=await res.json();
    const log=data.changelog||[];
    if(!log.length){el.innerHTML='<div style="color:var(--text-dim);padding:20px;text-align:center">No changes recorded yet. Commit a character correction to start the audit trail.</div>';return;}
    let html=`<div style="margin-bottom:10px;color:var(--text-dim);font-size:12px">${log.length} change${log.length===1?'':'s'} recorded</div>`;
    html+='<table class="data-table" style="font-size:13px"><tr><th>ID</th><th>Date</th><th>Character</th><th>Region</th><th>Summary</th><th>Products</th></tr>';
    log.slice().reverse().forEach(entry=>{
      const date=new Date(entry.timestamp).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
      const time=new Date(entry.timestamp).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
      const products=Object.entries(entry.affectedProducts||{}).map(([p,applied])=>{
        const icon=applied?'‚úÖ':'‚è≥';
        const label=p.replace(/\.js$/,' (module)').replace(/\.json$/,' (canon)');
        return `<span title="${applied?'Applied: '+new Date(applied).toLocaleDateString('en-GB'):'Pending update'}">${icon} ${esc(label)}</span>`;
      }).join('<br>');
      const diffKeys=Object.keys(entry.diff||{}).filter(k=>k!=='added');
      const diffSummary=diffKeys.length?`<div style="font-size:11px;color:var(--text-dim);margin-top:4px">Changed: ${diffKeys.join(', ')}</div>`:'';
      html+=`<tr>
        <td style="color:var(--accent);white-space:nowrap;font-weight:bold">${esc(entry.id)}</td>
        <td style="white-space:nowrap">${date}<br><span style="color:var(--text-dim);font-size:11px">${time}</span></td>
        <td>${esc(entry.target)}</td>
        <td>${esc(entry.region)}</td>
        <td>${esc(entry.summary)}${diffSummary}</td>
        <td style="font-size:11px;line-height:1.8">${products}</td>
      </tr>`;
    });
    html+='</table>';
    el.innerHTML=html;
  }catch(err){
    el.innerHTML=`<span style="color:var(--red)">‚ùå Could not load changelog: ${esc(err.message)}</span>`;
  }
}

function checkPin(){
  var pin=document.getElementById('pinInput').value;
  if(pin==='54546-44-56456-7567-2345'){
    localStorage.setItem('diceforge_npcdb_auth',pin);
    DICEFORGE_AUTH=true;
    unlockApp();
  } else {
    document.getElementById('pinError').textContent='Invalid PIN';
    document.getElementById('pinInput').value='';
    document.getElementById('pinInput').focus();
  }
}

/* ‚ïê‚ïê‚ïê REVIEW PANEL ‚Äî batch review/approve/reject dirty characters ‚ïê‚ïê‚ïê */
function showReviewPanel(){
  hideBottomBar();currentNPC=null;activePanel=null;navPush({type:'review'});updateBreadcrumb();
  const el=document.getElementById('mainContent');
  el.classList.remove('empty-state');el.style.overflowY='auto';
  el.innerHTML='<div id="reviewInline" style="padding:0"><h2 style="color:var(--accent);margin-bottom:14px">‚úèÔ∏è Review Pending Changes</h2><div id="reviewContent" style="font-size:13px">Loading...</div><div id="reviewActions" style="margin-top:14px;display:flex;gap:8px"></div></div>';
  renderReviewContent();
  filterNPCs();
}
function closeReviewModal(){
  if(currentNPC){renderDetail();}
  else{const el=document.getElementById('mainContent');el.innerHTML='Select an NPC or create a new one';el.classList.add('empty-state');}
}

function renderReviewContent(){
  const dirty=getAllDirty();
  const el=document.getElementById('reviewContent');
  const actions=document.getElementById('reviewActions');
  if(!dirty.length){
    el.innerHTML='<div style="text-align:center;color:var(--text-dim);padding:20px">No pending changes. All characters match their baselines.</div>';
    actions.innerHTML='';
    return;
  }
  // Sort: published first (red), then committed (amber), then drafts (blue)
  const order={published:0,committed:1,draft:2};
  dirty.sort((a,b)=>(order[getLifecycle(a.name)]||2)-(order[getLifecycle(b.name)]||2));
  let html=`<div style="margin-bottom:10px;color:var(--text-dim)">${dirty.length} character${dirty.length===1?'':'s'} with pending changes:</div>`;
  dirty.forEach(n=>{
    const lc=getLifecycle(n.name);
    const diff=getCharDiff(n.name);
    const pubProducts=getPublishedProducts(n.name);
    const pubWarning=pubProducts.length?`<div class="lock-warning" style="margin-bottom:6px">‚ö† Published in: ${pubProducts.map(p=>p.title+' ('+p.code+')').join(', ')}. Changes to this character require an errata justification.</div>`:'';
    const diffHtml=diff.map(d=>`<div class="${d.type}">${d.type==='added'?'+ ':d.type==='removed'?'‚àí ':'~ '}${esc(d.text)}</div>`).join('');
    html+=`<div class="review-card ${lc}" id="rc-${esc(n.name).replace(/\s/g,'_')}">
      ${pubWarning}
      <div class="rc-header">
        <div><span class="rc-name" style="cursor:pointer" onclick="selectNPC('${esc(n.name).replace(/'/g,"\\'")}')">${esc(n.name)}</span> <span style="font-size:11px;color:var(--text-dim)">${esc(n.refCode||'')} ¬∑ ${esc(n.category||'NPC')} ¬∑ ${esc(n.tier)}</span></div>
        <span style="font-size:11px;text-transform:uppercase;color:${lc==='published'?'#ee6666':lc==='committed'?'#e8b84e':'#88bbee'}">${lc}</span>
      </div>
      <div class="rc-diff">${diffHtml||'<span style="color:var(--text-dim)">No details available</span>'}</div>
      <div class="rc-actions">
        ${pubProducts.length?`<input id="override-reason-${esc(n.name).replace(/\s/g,'_')}" placeholder="Errata reason (required for published characters)" style="flex:1;background:var(--bg-input);border:1px solid #cc3333;color:var(--text);padding:4px 8px;border-radius:3px;font-size:12px">`:''} 
        <button class="btn sm" style="color:var(--green);border-color:var(--green)" onclick="reviewApprove('${esc(n.name).replace(/'/g,"\\'")}')">‚úì Approve</button>
        ${lc!=='draft'?`<button class="btn sm" style="color:var(--accent);border-color:var(--accent)" onclick="reviewApproveAndCommit('${esc(n.name).replace(/'/g,"\\'")}')">‚úì Approve &amp; Commit</button>`:''}
        <button class="btn sm" style="color:var(--red);border-color:var(--red)" onclick="reviewRevert('${esc(n.name).replace(/'/g,"\\'")}')">‚Ü∂ Revert</button>
      </div>
    </div>`;
  });
  el.innerHTML=html;
  actions.innerHTML=`<button class="btn primary" onclick="reviewApproveAll()">‚úì Approve All</button><button class="btn" onclick="closeReviewModal()">Close</button><span style="flex:1"></span><span style="font-size:11px;color:var(--text-dim)">${dirty.length} pending</span>`;
}

function reviewApprove(name){
  const lc=getLifecycle(name);
  if(lc==='published'){
    const reasonEl=document.getElementById('override-reason-'+name.replace(/\s/g,'_'));
    const reason=reasonEl?reasonEl.value.trim():'';
    if(!reason){alert('An errata reason is required for published characters.');if(reasonEl)reasonEl.focus();return;}
    logOverride(name,reason);
  }
  approveCharacter(name);
  renderReviewContent();
}
function reviewRevert(name){
  const lc=getLifecycle(name);
  const msg=lc==='published'
    ?`Revert ${name} to its last approved state?\n\nThis character is published ‚Äî all changes since last approval will be lost.`
    :`Revert ${name} to its last approved state?\n\nAll changes since last approval will be lost.`;
  if(!confirm(msg))return;
  revertCharacter(name);
  renderReviewContent();
}
function reviewApproveAll(){
  const dirty=getAllDirty();
  const published=dirty.filter(n=>getLifecycle(n.name)==='published');
  if(published.length){
    alert(`${published.length} published character${published.length===1?'':'s'} require individual review with errata reasons. Approve non-published characters first, then review published ones individually.`);
    dirty.filter(n=>getLifecycle(n.name)!=='published').forEach(n=>approveCharacter(n.name));
  }else{
    if(!confirm(`Approve all ${dirty.length} pending changes?`))return;
    dirty.forEach(n=>approveCharacter(n.name));
  }
  renderReviewContent();
}

async function reviewApproveAndCommit(name){
  const lc=getLifecycle(name);
  if(lc==='published'){
    const reasonEl=document.getElementById('override-reason-'+name.replace(/\s/g,'_'));
    const reason=reasonEl?reasonEl.value.trim():'';
    if(!reason){alert('An errata reason is required for published characters.');if(reasonEl)reasonEl.focus();return;}
    logOverride(name,reason);
  }
  // Approve baseline first
  approveCharacter(name);
  // Then fire canon commit
  const prev=currentNPC;
  currentNPC=allNPCs.find(n=>n.name===name);
  if(!currentNPC){currentNPC=prev;return;}
  try{
    await flushSave();
    const canon=buildCanonCharacter(currentNPC);
    const res=await fetch(CANON_API,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'commit_character',secret:'diceforge2026',character:canon,filePath:canonFilePath(currentNPC),summary:'Approved & committed '+name,author:'Character Vault ‚Äî Review Panel'})
    });
    const data=await res.json();
    if(data.success){canonCommitted.add(name);}
  }catch(e){/* canon commit is best-effort from review panel */}
  currentNPC=prev;
  filterNPCs();updateHeaderStats();renderReviewContent();
}

/* ‚ïê‚ïê‚ïê PRODUCT REGISTRY UI ‚ïê‚ïê‚ïê */
function showProductsModal(){
  hideBottomBar();currentNPC=null;activePanel=null;navPush({type:'products'});updateBreadcrumb();
  const el=document.getElementById('mainContent');el.classList.remove('empty-state');el.style.overflowY='auto';
  el.innerHTML='<h2 style="color:var(--accent);margin-bottom:14px">üì¶ Product Registry</h2><div id="productsContent" style="font-size:13px">Loading...</div>';
  renderProductsContent();filterNPCs();
}
function closeProductsModal(){}

function renderProductsContent(){
  const el=document.getElementById('productsContent');
  const products=_productRegistry.products||[];
  let html=`<div style="margin-bottom:12px;display:flex;gap:8px;align-items:center">
    <input id="newProdCode" placeholder="Product code (e.g. AM-W03)" style="padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);border-radius:3px;font-size:12px;width:180px">
    <input id="newProdTitle" placeholder="Product title" style="flex:1;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);border-radius:3px;font-size:12px">
    <button class="btn primary sm" onclick="uiAddProduct()">+ Add Product</button>
  </div>`;
  if(!products.length){
    html+='<div style="text-align:center;color:var(--text-dim);padding:20px">No products registered yet. Add your first product above.</div>';
  }else{
    // Sort: released first, then in-review, then draft
    const sorted=[...products].sort((a,b)=>{const o={released:0,'in-review':1,draft:2};return (o[a.status]||2)-(o[b.status]||2);});
    sorted.forEach(p=>{
      const statusColour=p.status==='released'?'var(--green)':p.status==='in-review'?'#e8b84e':'var(--text-dim)';
      const statusIcon=p.status==='released'?'üîí':p.status==='in-review'?'‚è≥':'üìù';
      const chars=(p.characters||[]).map(c=>allNPCs.find(x=>x.name===c)).filter(Boolean);
      const charCount=chars.length;
      const charList=(p.characters||[]).map(c=>{
        const n=allNPCs.find(x=>x.name===c);
        const ref=n&&n.refCode?n.refCode+' ':'';
        const missing=!n;
        return `<span style="display:inline-block;margin:2px 4px 2px 0;padding:1px 6px;background:var(--bg-body);border:1px solid ${missing?'var(--red)':'var(--border)'};border-radius:3px;font-size:11px;${missing?'color:var(--red)':''}">${esc(ref+c)}${missing?' ‚ö†':''} <span onclick="uiRemoveCharFromProduct('${esc(p.code).replace(/'/g,"\\'")}','${esc(c).replace(/'/g,"\\'")}');event.stopPropagation()" style="cursor:pointer;color:var(--red);margin-left:2px">√ó</span></span>`;
      }).join('');
      // Readiness metrics
      const buildsLegal=chars.filter(n=>{const a=runBuildAudit(n);return a.every(r=>r.pass);}).length;
      const statDone=chars.filter(n=>n.statComplete).length;
      const narrDone=chars.filter(n=>n.narrativeComplete).length;
      const dirtyChars=chars.filter(n=>isCharDirty(n.name)).length;
      const allGreen=charCount>0&&buildsLegal===charCount&&statDone===charCount&&narrDone===charCount&&dirtyChars===0;
      const readinessColour=allGreen?'var(--green)':charCount===0?'var(--text-dim)':'#e8b84e';
      const readinessHtml=charCount>0?`<div style="font-size:11px;margin:6px 0;padding:6px 8px;background:var(--bg-body);border-radius:3px;border-left:3px solid ${readinessColour}">
        <span style="color:${buildsLegal===charCount?'var(--green)':'var(--red)'}">${buildsLegal}/${charCount} builds legal</span> ¬∑ 
        <span style="color:${statDone===charCount?'var(--green)':'#e8b84e'}">${statDone}/${charCount} stats</span> ¬∑ 
        <span style="color:${narrDone===charCount?'var(--green)':'#e8b84e'}">${narrDone}/${charCount} narrative</span> ¬∑ 
        <span style="color:${dirtyChars===0?'var(--green)':'#ee6666'}">${dirtyChars} pending edit${dirtyChars===1?'':'s'}</span>
        ${allGreen?' ¬∑ <strong style="color:var(--green)">‚úì READY TO SHIP</strong>':''}
      </div>`:'';
      // Release checklist (expandable)
      const checklistId='checklist-'+p.code.replace(/[^a-zA-Z0-9]/g,'_');
      let checklistHtml='';
      if(charCount>0){
        checklistHtml=`<div id="${checklistId}" style="display:none;margin:6px 0;font-size:11px;line-height:1.8">`;
        // Sort: needs attention first (illegal builds, missing completions, dirty edits)
        const sortedChars=[...chars].sort((a,b)=>{
          const scoreN=n=>{let s=0;const au=runBuildAudit(n);if(!au.every(r=>r.pass))s+=4;if(!n.statComplete)s+=2;if(!n.narrativeComplete)s+=2;if(isCharDirty(n.name))s+=1;return s;};
          return scoreN(b)-scoreN(a);
        });
        sortedChars.forEach(n=>{
          const audit=runBuildAudit(n);const legal=audit.every(r=>r.pass);
          const dirty=isCharDirty(n.name);
          const ref=n.refCode?n.refCode+' ‚Äî ':'';
          const needsWork=!legal||!n.statComplete||!n.narrativeComplete||dirty;
          checklistHtml+=`<div style="padding:2px 0;border-bottom:1px solid var(--border);${needsWork?'background:rgba(238,102,102,0.05)':''}">
            <span style="cursor:pointer;color:var(--accent)" onclick="closeProductsModal();selectNPC('${esc(n.name).replace(/'/g,"\\'")}')">${esc(ref+n.name)}</span>
            <span style="margin-left:8px;color:${legal?'var(--green)':'var(--red)'}">${legal?'‚úì':'‚úó'} Build</span>
            <span style="margin-left:6px;color:${n.statComplete?'var(--green)':'var(--text-dim)'}">${n.statComplete?'‚úì':'‚Äî'} Stats</span>
            <span style="margin-left:6px;color:${n.narrativeComplete?'var(--green)':'var(--text-dim)'}">${n.narrativeComplete?'‚úì':'‚Äî'} Narr</span>
            <span style="margin-left:6px;color:${dirty?'#ee6666':'var(--green)'}">${dirty?'‚úèÔ∏è Edited':'‚úì Clean'}</span>
          </div>`;
        });
        checklistHtml+=`</div>`;
      }
      const statusBtns=p.status==='draft'
        ?`<button class="btn sm" onclick="uiSetProductStatus('${esc(p.code)}','in-review')" style="color:#e8b84e;border-color:#e8b84e">‚Üí In Review</button><button class="btn sm danger" onclick="uiRemoveProduct('${esc(p.code)}')">Delete</button>`
        :p.status==='in-review'
        ?`<button class="btn sm" onclick="uiSetProductStatus('${esc(p.code)}','released')" style="color:var(--green);border-color:var(--green)">üîí Release</button><button class="btn sm" onclick="uiSetProductStatus('${esc(p.code)}','draft')">‚Üê Draft</button>`
        :`<span style="font-size:11px;color:var(--text-dim)">Released ${p.releasedAt?new Date(p.releasedAt).toLocaleDateString():''}</span>`;
      html+=`<div class="product-card ${p.status}">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div><strong style="color:var(--accent);font-family:monospace">${esc(p.code)}</strong> ‚Äî ${esc(p.title)} <span style="font-size:11px;color:${statusColour}">${statusIcon} ${p.status.toUpperCase()}</span> <span style="font-size:11px;color:var(--text-dim)">(${charCount} character${charCount===1?'':'s'})</span></div>
          <div style="display:flex;gap:4px">${statusBtns}</div>
        </div>
        ${readinessHtml}
        <div style="margin-bottom:6px">${charList||'<span style="color:var(--text-dim);font-size:12px">No characters assigned</span>'}</div>
        ${checklistHtml}
        <div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap">
          <select id="addChar-${esc(p.code)}" style="flex:1;padding:4px 8px;background:var(--bg-input);border:1px solid var(--border);color:var(--text);border-radius:3px;font-size:12px;min-width:200px">
            <option value="">Add character...</option>
            ${allNPCs.filter(n=>!(p.characters||[]).includes(n.name)).sort((a,b)=>(a.refCode||'').localeCompare(b.refCode||'')).map(n=>`<option value="${esc(n.name)}">${n.refCode?esc(n.refCode)+' ‚Äî ':''}${esc(n.name)}</option>`).join('')}
          </select>
          <button class="btn sm" onclick="uiAddCharToProduct('${esc(p.code)}')">+ Add</button>
          ${charCount>0?`<button class="btn sm" onclick="toggleChecklist('${checklistId}')" style="color:var(--accent);border-color:var(--accent)">üìã Checklist</button>`:''}
          ${charCount>0?`<button class="btn sm" onclick="exportProductStatBlocks('${esc(p.code).replace(/'/g,"\\'")}')" style="color:var(--accent);border-color:var(--accent)">üìÑ Export Stat Blocks</button>`:''}
        </div>
      </div>`;
    });
  }
  el.innerHTML=html;
}

function uiAddProduct(){
  const code=document.getElementById('newProdCode').value.trim();
  const title=document.getElementById('newProdTitle').value.trim();
  if(!code||!title){alert('Both product code and title are required.');return;}
  if(!addProduct(code,title)){alert('A product with that code already exists.');return;}
  renderProductsContent();
}
function uiRemoveProduct(code){
  if(!confirm(`Delete product ${code}? This cannot be undone.`))return;
  removeProduct(code);renderProductsContent();
}
function uiSetProductStatus(code,status){
  if(status==='released'){
    const p=_productRegistry.products.find(x=>x.code===code);
    const charCount=(p?.characters||[]).length;
    if(!confirm(`Release ${code} ‚Äî "${p?.title}"?\n\n${charCount} character${charCount===1?'':'s'} will be locked. Changes after release will require errata override with justification.\n\nThis action sets the release date and cannot be easily undone.`))return;
  }
  setProductStatus(code,status);
  renderProductsContent();filterNPCs();updateHeaderStats();
}
function uiAddCharToProduct(code){
  const sel=document.getElementById('addChar-'+code);
  if(!sel||!sel.value)return;
  addCharToProduct(code,sel.value);
  renderProductsContent();filterNPCs();
}
function uiRemoveCharFromProduct(code,name){
  const p=_productRegistry.products.find(x=>x.code===code);
  if(p&&p.status==='released'){alert('Cannot remove characters from a released product.');return;}
  removeCharFromProduct(code,name);
  renderProductsContent();filterNPCs();
}

function toggleChecklist(id){
  const el=document.getElementById(id);
  if(!el)return;
  el.style.display=el.style.display==='none'?'block':'none';
}

function buildStatBlockHTML(n){
  const d=v=>v?'d'+v:'‚Äî';
  const tDisp=n.toughnessArmor>0?n.toughness+' ('+n.toughnessArmor+')':''+n.toughness;
  let html=`<div style="border:1px solid #666;border-radius:4px;padding:12px;margin-bottom:16px;font-family:Georgia,serif;font-size:13px;max-width:600px">`;
  html+=`<div style="font-size:16px;font-weight:bold;border-bottom:2px solid #333;padding-bottom:4px;margin-bottom:8px">${esc(n.name)}${n.concept?' <span style="font-weight:normal;font-style:italic;font-size:13px">‚Äî '+esc(n.concept)+'</span>':''}</div>`;
  if(n.quote) html+=`<div style="font-style:italic;color:#666;margin-bottom:6px">"${esc(n.quote)}"</div>`;
  if(n.description) html+=`<div style="margin-bottom:8px">${esc(n.description)}</div>`;
  html+=`<div style="margin-bottom:4px"><strong>Attributes:</strong> Agility ${d(n.agility)}, Smarts ${d(n.smarts)}, Spirit ${d(n.spirit)}, Strength ${d(n.strength)}, Vigor ${d(n.vigor)}</div>`;
  if(Object.keys(n.skills||{}).length) html+=`<div style="margin-bottom:4px"><strong>Skills:</strong> ${Object.entries(n.skills).sort((a,b)=>a[0].localeCompare(b[0])).map(([k,v])=>k+' '+d(v)).join(', ')}</div>`;
  html+=`<div style="margin-bottom:4px"><strong>Pace:</strong> ${n.pace}; <strong>Parry:</strong> ${n.parry}; <strong>Toughness:</strong> ${tDisp}</div>`;
  if(n.edges&&n.edges.length) html+=`<div style="margin-bottom:4px"><strong>Edges:</strong> ${n.edges.map(e=>esc(e)).join(', ')}</div>`;
  if(n.hindrances&&n.hindrances.length) html+=`<div style="margin-bottom:4px"><strong>Hindrances:</strong> ${n.hindrances.map(h=>esc(h)).join(', ')}</div>`;
  if(n.powers&&n.powers.length) html+=`<div style="margin-bottom:4px"><strong>Powers:</strong> ${n.powers.map(p=>esc(p)).join(', ')}${n.pp?' ('+n.pp+' Power Points)':''}</div>`;
  if(n.weapons&&n.weapons.length) html+=`<div style="margin-bottom:4px"><strong>Weapons:</strong> ${n.weapons.map(w=>esc(w.name)+' ('+esc(w.damage||'')+(w.ap?', AP '+w.ap:'')+(w.range?', '+esc(w.range):'')+')').join(', ')}</div>`;
  if(n.armour&&n.armour.length) html+=`<div style="margin-bottom:4px"><strong>Armour:</strong> ${n.armour.map(a=>esc(a.name)+' (+'+a.armor+')').join(', ')}</div>`;
  if(n.gearText) html+=`<div style="margin-bottom:4px"><strong>Gear:</strong> ${esc(n.gearText)}</div>`;
  if(n.abName) html+=`<div style="margin-bottom:4px"><strong>Arcane Background:</strong> ${esc(n.abName)}${n.abSkill?' ('+esc(n.abSkill)+')':''}</div>`;
  html+=`</div>`;
  return html;
}

function exportProductStatBlocks(code){
  const p=_productRegistry.products.find(x=>x.code===code);
  if(!p)return;
  const chars=(p.characters||[]).map(c=>allNPCs.find(x=>x.name===c)).filter(Boolean);
  if(!chars.length){alert('No characters assigned to this product.');return;}
  // Build both formats
  const separator='\n'+('‚ïê'.repeat(60))+'\n\n';
  const headerTxt=`STAT BLOCKS ‚Äî ${p.code}: ${p.title}\nGenerated: ${new Date().toLocaleDateString()}\nCharacters: ${chars.length}\n`;
  const textBlocks=headerTxt+'\n'+separator+chars.map(n=>buildStatBlockText(n)).join(separator);
  const htmlBlocks=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Stat Blocks ‚Äî ${esc(p.code)}: ${esc(p.title)}</title><style>body{font-family:Georgia,serif;max-width:700px;margin:20px auto;color:#222;background:#fff}h1{font-size:20px;border-bottom:2px solid #333;padding-bottom:6px}p.meta{font-size:12px;color:#888}</style></head><body><h1>${esc(p.code)}: ${esc(p.title)}</h1><p class="meta">Generated: ${new Date().toLocaleDateString()} ¬∑ ${chars.length} character${chars.length===1?'':'s'}</p>${chars.map(n=>buildStatBlockHTML(n)).join('')}</body></html>`;
  // State
  let currentFmt='text';
  const modal=document.createElement('div');
  modal.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:200;display:flex;align-items:center;justify-content:center';
  modal.innerHTML=`<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:16px;width:800px;max-height:85vh;display:flex;flex-direction:column">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <h3 style="margin:0;color:var(--accent)">üìÑ Stat Blocks ‚Äî ${esc(p.code)}: ${esc(p.title)}</h3>
      <button class="btn" onclick="this.closest('div[style*=fixed]').remove()">‚úï Close</button>
    </div>
    <div style="display:flex;gap:4px;margin-bottom:8px">
      <button class="btn sm" id="expFmtTxt" style="border-color:var(--accent);color:var(--accent)" onclick="setExpFmt('text')">Plain Text</button>
      <button class="btn sm" id="expFmtHtml" onclick="setExpFmt('html')">HTML</button>
      <span style="flex:1"></span>
      <span id="expMeta" style="font-size:11px;color:var(--text-dim);align-self:center">${chars.length} characters ¬∑ ${textBlocks.length.toLocaleString()} chars</span>
    </div>
    <div id="expPreviewArea" style="flex:1;min-height:300px;overflow:auto;border:1px solid var(--border);border-radius:4px;background:var(--bg-body)">
      <textarea id="expTextArea" readonly style="width:100%;height:100%;box-sizing:border-box;font-family:monospace;font-size:11px;background:transparent;color:var(--text);border:none;padding:8px;resize:none">${esc(textBlocks)}</textarea>
      <div id="expHtmlArea" style="display:none;padding:8px"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn primary" id="copyStatBlocksBtn">üìã Copy</button>
      <button class="btn" id="downloadStatBlocksBtn">üíæ Download</button>
    </div>
  </div>`;
  document.body.appendChild(modal);
  // HTML preview
  const htmlArea=modal.querySelector('#expHtmlArea');
  const iframe=document.createElement('iframe');
  iframe.style.cssText='width:100%;border:none;min-height:400px';
  htmlArea.appendChild(iframe);
  iframe.srcdoc=htmlBlocks;
  function setExpFmt(fmt){
    currentFmt=fmt;
    modal.querySelector('#expFmtTxt').style.cssText=fmt==='text'?'border-color:var(--accent);color:var(--accent)':'';
    modal.querySelector('#expFmtHtml').style.cssText=fmt==='html'?'border-color:var(--accent);color:var(--accent)':'';
    modal.querySelector('#expTextArea').style.display=fmt==='text'?'':'none';
    modal.querySelector('#expHtmlArea').style.display=fmt==='html'?'':'none';
    const len=fmt==='text'?textBlocks.length:htmlBlocks.length;
    modal.querySelector('#expMeta').textContent=chars.length+' characters ¬∑ '+len.toLocaleString()+' chars';
  }
  window.setExpFmt=setExpFmt;
  modal.querySelector('#copyStatBlocksBtn').onclick=()=>{
    const content=currentFmt==='text'?textBlocks:htmlBlocks;
    navigator.clipboard.writeText(content).then(()=>{modal.querySelector('#copyStatBlocksBtn').textContent='‚úÖ Copied!';setTimeout(()=>{modal.querySelector('#copyStatBlocksBtn').textContent='üìã Copy';},1500);});
  };
  modal.querySelector('#downloadStatBlocksBtn').onclick=()=>{
    const content=currentFmt==='text'?textBlocks:htmlBlocks;
    const ext=currentFmt==='text'?'.txt':'.html';
    const mime=currentFmt==='text'?'text/plain':'text/html';
    const blob=new Blob([content],{type:mime});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);
    a.download=p.code.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'-stat-blocks'+ext;
    a.click();URL.revokeObjectURL(a.href);
  };
  modal.addEventListener('click',(e)=>{if(e.target===modal)modal.remove();});
}

/* ‚îÄ‚îÄ Published character edit gate ‚îÄ‚îÄ */
function checkEditLock(name){
  if(!isLocked(name))return true;
  const products=getPublishedProducts(name);
  const prodList=products.map(p=>p.code+' ‚Äî '+p.title).join('\n');
  return confirm(`‚ö† ${name} is published in:\n\n${prodList}\n\nEditing a published character creates an errata situation. All changes will be flagged for review.\n\nProceed?`);
}

async function loadCanonStatus(){
  try{
    const res=await fetch(CANON_API,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'get_changelog',secret:'diceforge2026'})
    });
    const data=await res.json();
    const log=data.changelog||[];
    canonCommitted=new Set(log.map(e=>e.target));
    filterNPCs();updateHeaderStats();
    if(currentNPC)renderDetail();
  }catch(e){/* silent fail ‚Äî just means no canon icons */}
}

async function unlockApp(){
  document.getElementById('mainContent').innerHTML='<span style="color:var(--text-dim)">Loading characters...</span>';
  document.getElementById('mainContent').classList.add('empty-state');
  document.getElementById('sidebarInner').style.display='';
  await loadData();captureBaselines();filterNPCs();updateHeaderStats();loadCanonStatus();loadProductRegistry();
  document.getElementById('mainContent').innerHTML='<span style="color:var(--text-dim)">Select an NPC or create a new one</span>';
}

window.addEventListener('beforeunload',(e)=>{if(saveTimer){clearTimeout(saveTimer);saveTimer=null;pushToGist();e.returnValue='Save in progress...';}});
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('sidebarInner').style.display=DICEFORGE_AUTH?'':'none';
  if(DICEFORGE_AUTH){
    const check=setInterval(()=>{if(window.CharacterForge){clearInterval(check);unlockApp();}},50);
  } else {
    document.getElementById('pinInput').focus();
  }
});
</script>
</body>
</html>



