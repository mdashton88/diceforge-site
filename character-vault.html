<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tribute Lands ‚Äî Character Vault</title>
<style>
:root {
  --bg-dark: #1a1a1a;
  --bg-card: #242424;
  --bg-input: #2e2e2e;
  --bg-hover: #333;
  --border: #444;
  --text: #d4d0c8;
  --text-dim: #888;
  --text-bright: #f0ece0;
  --accent: #c49a4a;
  --accent-dim: #8a6d33;
  --red: #a44;
  --green: #5a5;
  --blue: #4a7a9a;
  --tag-wc: #c49a4a;
  --tag-extra: #5a8a5a;
  --tag-walkon: #7a7a8a;
  --tag-walkon: #666;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
body { font-family: 'Segoe UI', Tahoma, Geneva, sans-serif; background: var(--bg-dark); color: var(--text); line-height: 1.5; margin: 0; padding: 0; overflow: hidden; height: 100%; display: flex; flex-direction: column; }
header { background: linear-gradient(135deg, #1a1a1a 0%, #2a2218 100%); border-bottom: 2px solid var(--accent-dim); padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
header h1 { font-size: 18px; color: var(--accent); font-weight: 600; letter-spacing: 1px; }
header .subtitle { font-size: 11px; color: var(--text-dim); letter-spacing: 2px; text-transform: uppercase; }
.header-stats { display: flex; gap: 16px; font-size: 13px; color: var(--text-dim); }
.header-stats .stat-num { color: var(--accent); font-weight: 600; }
.container { display: flex; flex: 1; min-height: 0; }
.sidebar { width: 300px; min-width: 300px; background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
#sidebarInner { display: flex; flex-direction: column; flex: 1 1 0; min-height: 0; overflow: hidden; }
.sidebar-controls { padding: 10px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px; flex-shrink: 0; }
.filter-row { display: flex; gap: 6px; }
.sidebar-controls input, .sidebar-controls select { background: var(--bg-input); border: 1px solid var(--border); color: var(--text); padding: 6px 8px; border-radius: 3px; font-size: 13px; }
.sidebar-controls input { flex: 1; }
.sidebar-controls select { min-width: 100px; }
.npc-list { flex: 1 1 0; min-height: 0; overflow-y: scroll; padding: 4px; scrollbar-width: auto; scrollbar-color: var(--accent-dim) var(--bg-dark); }
.npc-list::-webkit-scrollbar { width: 10px; }
.npc-list::-webkit-scrollbar-track { background: var(--bg-dark); }
.npc-list::-webkit-scrollbar-thumb { background: var(--accent-dim); border-radius: 5px; border: 2px solid var(--bg-dark); }
.npc-list::-webkit-scrollbar-thumb:hover { background: var(--accent); }
.npc-item { padding: 8px 10px; border-radius: 4px; cursor: pointer; border: 1px solid transparent; margin-bottom: 2px; }
.npc-item:hover { background: var(--bg-hover); }
.npc-item.active { background: var(--bg-hover); border-color: var(--accent-dim); }
.npc-item .npc-name { font-size: 14px; font-weight: 600; color: var(--text-bright); }
.npc-item .npc-meta { font-size: 12px; color: var(--text-dim); margin-top: 1px; }
.tier-tag { display: inline-block; padding: 0 6px; border-radius: 2px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; vertical-align: middle; margin-left: 4px; }
.tier-tag.wc { background: var(--tag-wc); color: #1a1a1a; }
.tier-tag.extra { background: var(--tag-extra); color: #fff; }
.tier-tag.walkon { background: var(--tag-walkon); color: #fff; }
.tier-tag.pregen { background: #6a5aaa; color: #fff; }
.list-section-header { padding: 8px 16px 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--accent); border-bottom: 1px solid var(--border); margin-top: 4px; }
.status-dots { display: inline-flex; gap: 3px; margin-left: 6px; vertical-align: middle; }
.status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
.status-dot.on { background: var(--green); }
.status-dot.off { background: var(--border); }
.sidebar-footer { padding: 8px 10px; border-top: 1px solid var(--border); display: flex; gap: 6px; flex-shrink: 0; }
.main { flex: 1; overflow: hidden; padding: 20px 28px; display: flex; flex-direction: column; }
.main.empty-state { display: flex; align-items: center; justify-content: center; color: var(--text-dim); font-size: 15px; }
.npc-header { margin-bottom: 16px; flex-shrink: 0; }
.npc-header h2 { font-size: 24px; color: var(--text-bright); font-weight: 600; }
.npc-header .npc-title-line { font-size: 15px; color: var(--accent); margin-top: 2px; }
.detail-columns { display: flex; gap: 16px; flex: 1; min-height: 0; }
.col-stats { width: 400px; min-width: 400px; flex-shrink: 0; display: flex; flex-direction: column; }
.col-stats-scroll { flex: 1; overflow-y: auto; }
.col-stats-footer { flex-shrink: 0; border-top: 1px solid var(--border); background: var(--bg-card); padding-bottom: 4px; }
.col-middle { min-width: 380px; flex: 1; overflow-y: auto; }
.col-narrative { width: 360px; min-width: 300px; flex-shrink: 0; overflow-y: auto; }
.stat-block-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 14px 16px; font-size: 13px; }
.stat-block-panel .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.stat-block-panel .tier-label { font-size: 13px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
.build-legal-badge { background: var(--green); color: #fff; font-size: 11px; padding: 2px 8px; border-radius: 3px; font-weight: 600; cursor: pointer; }
.build-legal-badge.invalid { background: var(--red); }
.stat-section { margin-bottom: 8px; }
.stat-section-label { font-size: 11px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; cursor: pointer; }
.stat-section-label:hover { text-decoration: underline; }
.stat-section-label .edit-icon { font-size: 10px; color: var(--text-dim); margin-left: 2px; }
.stat-val { color: var(--text-bright); font-size: 13px; line-height: 1.6; }
.derived-row { display: flex; gap: 16px; padding: 8px 0; border-top: 1px solid #2a2a2a; border-bottom: 1px solid #2a2a2a; margin: 8px 0; }
.derived-item { text-align: center; }
.derived-item .derived-num { font-size: 20px; font-weight: 700; color: var(--accent); }
.derived-item .derived-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; }
.section-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 12px 16px; margin-top: 10px; font-size: 13px; }
.section-box-pair { display: flex; gap: 10px; margin-top: 10px; }
.section-box-pair .section-box { flex: 1; }
.section-box h3 { font-size: 12px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; cursor: pointer; font-weight: 600; }
.section-box h3:hover { text-decoration: underline; }
.section-box h3 .edit-icon { font-size: 10px; color: var(--text-dim); margin-left: 2px; }
.section-box .item-entry { padding: 3px 0; border-bottom: 1px solid #2a2a2a; font-size: 13px; }
.section-box .item-entry:last-child { border-bottom: none; }
.section-box .legacy-tag { font-size: 10px; color: var(--text-dim); font-style: italic; }
.section-box .none-text { color: var(--text-dim); font-size: 12px; }
.status-bar { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 10px 16px; margin-top: 10px; }
.status-bar .status-row { display: flex; gap: 16px; margin-bottom: 6px; }
.status-bar label { font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; }
.status-bar input[type="checkbox"] { accent-color: var(--accent); }
.action-btns { display: flex; gap: 6px; flex-wrap: wrap; }
.middle-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 16px 20px; min-height: 200px; }
.middle-panel .panel-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
.middle-panel .panel-title h3 { font-size: 16px; color: var(--text-bright); font-weight: 600; }
.middle-default { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 300px; color: var(--text-dim); }
.middle-default .hint { font-size: 14px; margin-bottom: 12px; }
.middle-default .quick-links { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
.middle-default .quick-links a { color: var(--accent); font-size: 13px; cursor: pointer; text-decoration: none; }
.middle-default .quick-links a:hover { text-decoration: underline; }
.portrait-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; width: 100%; aspect-ratio: 3/4; display: flex; align-items: center; justify-content: center; color: var(--text-dim); font-size: 13px; margin-bottom: 6px; }
.portrait-actions { text-align: right; margin-bottom: 10px; font-size: 12px; }
.portrait-actions a { color: var(--accent); cursor: pointer; text-decoration: none; margin-left: 8px; }
.npc-quote { font-style: italic; color: var(--accent); margin: 12px 0; padding-left: 12px; border-left: 2px solid var(--accent-dim); font-size: 14px; line-height: 1.5; }
.narrative-section { margin-top: 12px; }
.narrative-section h4 { font-size: 13px; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; cursor: pointer; font-weight: 600; }
.narrative-section h4:hover { text-decoration: underline; }
.narrative-section h4 .edit-icon { font-size: 10px; color: var(--text-dim); margin-left: 2px; }
.narrative-section p { font-size: 13px; line-height: 1.6; color: var(--text); }
.btn { background: var(--bg-input); border: 1px solid var(--border); color: var(--text); padding: 5px 12px; border-radius: 3px; cursor: pointer; font-size: 13px; font-family: inherit; }
.btn:hover { background: var(--bg-hover); border-color: var(--accent-dim); }
.btn.primary { background: var(--accent-dim); color: var(--text-bright); border-color: var(--accent); }
.btn.primary:hover { background: var(--accent); color: #1a1a1a; }
.btn.danger { border-color: var(--red); }
.btn.danger:hover { background: var(--red); color: #fff; }
.btn.sm { padding: 3px 8px; font-size: 11px; }
.form-group { margin-bottom: 10px; }
.form-group label { display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 3px; text-transform: uppercase; letter-spacing: 0.5px; }
.form-group input, .form-group select, .form-group textarea { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: var(--text); padding: 6px 8px; border-radius: 3px; font-size: 13px; font-family: inherit; }
.form-group textarea { resize: vertical; min-height: 60px; }
.form-row { display: flex; gap: 10px; }
.form-row .form-group { flex: 1; }
.form-actions { margin-top: 14px; display: flex; gap: 8px; justify-content: flex-end; }
.catalogue-section { margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); }
.catalogue-section h4 { font-size: 12px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px; }
.catalogue-list { max-height: 200px; overflow-y: auto; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 3px; margin-bottom: 8px; }
.catalogue-item { padding: 4px 8px; cursor: pointer; font-size: 12px; border-bottom: 1px solid #2a2a2a; }
.catalogue-item:hover { background: var(--bg-hover); }
.catalogue-item .cat-name { color: var(--text-bright); }
.catalogue-item .cat-detail { color: var(--text-dim); font-size: 11px; }
.export-tabs { display: flex; gap: 2px; margin-bottom: 10px; }
.export-tab { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-dim); padding: 4px 12px; border-radius: 3px 3px 0 0; cursor: pointer; font-size: 12px; }
.export-tab.active { background: var(--bg-card); color: var(--accent); border-bottom-color: var(--bg-card); }
.export-content { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 0 3px 3px 3px; padding: 14px; font-size: 13px; line-height: 1.6; max-height: 500px; overflow-y: auto; white-space: pre-wrap; }
.export-content .label { font-weight: 700; color: var(--text-bright); }
.audit-block { background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; padding: 14px; font-size: 13px; }
.audit-section { margin-bottom: 10px; }
.audit-section h4 { font-size: 12px; font-weight: 700; color: var(--text-bright); text-transform: uppercase; margin-bottom: 4px; }
.audit-pass { color: var(--green); }
.audit-fail { color: var(--red); }
.audit-warn { color: #e6a117; }
.audit-line { padding: 2px 0; }
.modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 100; align-items: center; justify-content: center; }
.modal-overlay.active { display: flex; }
.modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 20px; width: 600px; max-height: 85vh; overflow-y: auto; }
.modal h3 { color: var(--accent); margin-bottom: 14px; font-size: 16px; }
table.data-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 4px; }
table.data-table th { text-align: left; color: var(--text-dim); font-weight: 600; padding: 4px 8px; border-bottom: 1px solid var(--border); }
table.data-table td { padding: 4px 8px; border-bottom: 1px solid #2a2a2a; }
::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg-dark); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #555; }
</style>
</head>
<body>
<script>
var DICEFORGE_AUTH=false;
(function(){
  if(localStorage.getItem('diceforge_npcdb_auth')==='54546-44-56456-7567-2345') DICEFORGE_AUTH=true;
})();
</script>
<header>
  <div><h1>TRIBUTE LANDS ‚Äî CHARACTER VAULT</h1><div class="subtitle">DiceForge Studios Ltd</div></div>
  <div class="header-stats" id="headerStats"></div>
</header>
<div class="container">
  <div class="sidebar">
    <div id="sidebarInner">
    <div class="sidebar-controls">
      <input type="text" id="searchInput" placeholder="Search characters..." oninput="filterNPCs()">
      <div class="filter-row">
        <select id="categoryFilter" onchange="filterNPCs()"><option value="">All Types</option><option>Pre-gen</option><option>NPC</option></select>
        <select id="regionFilter" onchange="filterNPCs()"><option value="">All Regions</option><option>Ammaria</option><option>Saltlands</option><option>Vinlands</option><option>Concordium</option><option>Glasrya</option><option>Global</option></select>
        <select id="tierFilter" onchange="filterNPCs()"><option value="">All Tiers</option><option>Wild Card</option><option>Extra</option><option>Walk-on</option></select>
      </div>
    </div>
    <div class="npc-list" id="npcList"></div>
    <div class="sidebar-footer">
      <button class="btn primary" onclick="openNewNPCModal()" style="flex:1">+ New Character</button>
      <button class="btn" onclick="showStatusView()">Status</button>
      <button class="btn" onclick="showChangelog()">Changes</button>
    </div>
    </div>
  </div>
  <div class="main empty-state" id="mainContent">
    <div id="welcomeGate" style="text-align:center;max-width:400px">
      <h2 style="color:var(--accent);margin-bottom:6px;font-size:22px">TRIBUTE LANDS</h2>
      <div style="color:var(--text-dim);font-size:13px;margin-bottom:24px;letter-spacing:1px">CHARACTER VAULT ‚Äî DICEFORGE STUDIOS</div>
      <div id="pinForm">
        <input id="pinInput" type="password" placeholder="Enter PIN" style="width:200px;text-align:center;padding:10px 14px;font-size:16px;letter-spacing:4px;background:var(--bg-card);border:1px solid var(--border);border-radius:4px;color:var(--text);margin-bottom:12px" onkeydown="if(event.key==='Enter')checkPin()">
        <br><button class="btn primary" onclick="checkPin()" style="padding:8px 28px">Enter</button>
        <div id="pinError" style="color:var(--red);font-size:12px;margin-top:10px"></div>
      </div>
    </div>
  </div>
</div>
<div class="modal-overlay" id="newNpcModal">
  <div class="modal">
    <h3>New Character</h3>
    <div class="form-row"><div class="form-group"><label>Name *</label><input id="new_name"></div><div class="form-group"><label>Title / Role</label><input id="new_concept" placeholder="e.g. Professional Fixer"></div></div>
    <div class="form-row">
      <div class="form-group"><label>Category *</label><select id="new_category"><option>NPC</option><option>Pre-gen</option></select></div>
      <div class="form-group"><label>Region *</label><select id="new_region"><option>Ammaria</option><option>Saltlands</option><option>Vinlands</option><option>Concordium</option><option>Glasrya</option><option>Global</option></select></div>
      <div class="form-group"><label>Tier *</label><select id="new_tier"><option>Wild Card</option><option>Extra</option><option>Walk-on</option></select></div>
      <div class="form-group"><label>Ancestry</label><select id="new_ancestry"><option>Human</option><option>Dwarf</option><option>Elf</option><option>Half-Folk</option><option>Other</option></select></div>
    </div>
    <div class="form-actions"><button class="btn" onclick="closeNewNPCModal()">Cancel</button><button class="btn primary" onclick="createNPC()">Create NPC</button></div>
  </div>
</div>
<div class="modal-overlay" id="commitModal">
  <div class="modal">
    <h3 id="commitModalTitle">üì¶ Commit to Canon</h3>
    <div id="commitDiff" style="margin-bottom:14px;font-size:13px;max-height:200px;overflow-y:auto;background:var(--bg-body);padding:10px;border-radius:4px;border:1px solid var(--border)"></div>
    <div class="form-group"><label>Summary *</label><input id="commit_summary" placeholder="e.g. Added missing hindrances for Vella Ashford" style="width:100%;box-sizing:border-box"></div>
    <div class="form-group"><label>Confirmation *</label><input id="commit_secret" placeholder="Type COMMIT to confirm" style="width:100%;box-sizing:border-box" autocomplete="off"></div>
    <div id="commitStatus" style="margin-top:8px;font-size:13px"></div>
    <div class="form-actions"><button class="btn" onclick="closeCommitModal()">Cancel</button><button class="btn primary" id="commitBtn" onclick="executeCommit()">üîí Commit to Canon</button></div>
  </div>
</div>
<div class="modal-overlay" id="changelogModal">
  <div class="modal" style="width:800px">
    <h3>üìã Canon Changelog</h3>
    <div id="changelogContent" style="font-size:13px">Loading...</div>
    <div class="form-actions" style="margin-top:14px"><button class="btn" onclick="closeChangelogModal()">Close</button></div>
  </div>
</div>
<script>
// CharacterForge Engine Bootstrap
window.CharacterForge = (function(){
  var modules = [];
  return {
    data: {},
    registerModule: function(mod) {
      modules.push(mod);
      if (mod.alwaysOn) {
        ['edges','hindrances','skills','ancestries','powers','gear','skillLinks','coreSkills'].forEach(function(k){
          if (mod[k]) {
            if (Array.isArray(mod[k])) { if (!this.data[k]) this.data[k] = []; this.data[k] = this.data[k].concat(mod[k]); }
            else if (typeof mod[k] === 'object') { if (!this.data[k]) this.data[k] = {}; Object.assign(this.data[k], mod[k]); }
          }
        }.bind(this));
      }
    },
    getModules: function() { return modules; },
    getModule: function(id) { return modules.find(function(m){ return m.id === id; }); }
  };
})();
</script>
<script src="swade-rules.js"></script>
<script src="swade-core.js"></script>
<script src="ammaria.js"></script>
<script>
let allNPCs=[], currentNPC=null, activePanel=null;
let canonCommitted=new Set();
const LS_KEY='tl_npc_db';

function loadData(){
  const CF=window.CharacterForge; if(!CF) return;
  const seeded=[];
  const modules=CF.getModules?CF.getModules():[];
  modules.forEach(m=>{if(m.characters) m.characters.forEach(c=>seeded.push(normaliseChar(c,m.id)));});
  const stored=JSON.parse(localStorage.getItem(LS_KEY)||'{}');
  const merged=[], usedNames=new Set();
  if(stored.custom) stored.custom.forEach(c=>{merged.push(c);usedNames.add(c.name);});
  seeded.forEach(s=>{
    if(usedNames.has(s.name)) return;
    const ov=stored.overrides?stored.overrides[s.name]:null;
    merged.push(ov?{...s,...ov}:s);
  });
  allNPCs=merged;
  if(stored.deleted) allNPCs=allNPCs.filter(n=>!stored.deleted.includes(n.name));
}

function normaliseChar(c,moduleId){
  const n={name:c.name,concept:c.concept||'',ancestry:c.ancestry||'Human',region:c.region||'Ammaria',tier:c.tier||'Wild Card',rank:c.rank||'Novice',category:c.category||'NPC',product:c.product||'',source:moduleId,agility:c.attrs?.agility||0,smarts:c.attrs?.smarts||0,spirit:c.attrs?.spirit||0,strength:c.attrs?.strength||0,vigor:c.attrs?.vigor||0,skills:c.skills||{},edges:c.edges||[],hindrances:c.hindrances||[],powers:c.powers||[],armour:c.armour||[],weapons:c.weapons||[],gearText:c.gearText||'',quote:c.quote||'',description:'',background:'',motivation:'',secret:'',services:'',adventureHook:'',tactics:'',abName:c.abName||'',abSkill:c.abSkill||'',pp:c.pp||0,statComplete:false,narrativeComplete:false,fgReady:false,pace:6,parry:2,toughness:5,toughnessArmor:0,bennies:0};
  // Parse gear text into structured armour/weapons if not already populated
  if(!n.armour.length&&!n.weapons.length&&n.gearText) parseGearInto(n);
  n.toughnessArmor=n.armour.reduce((best,a)=>Math.max(best,a.armor||0),0);
  if(c.notes){
    const notes=c.notes;
    const motM=notes.match(/What (?:They|He|She) Want[s]?:\s*(.+?)(?:\n|$)/i);
    const secM=notes.match(/(?:Their|His|Her) Secret:\s*(.+?)(?:\n|$)/i);
    const svcM=notes.match(/Services:\s*(.+?)(?:\n|$)/i);
    const hookM=notes.match(/Hook:\s*(.+?)(?:\n|$)/i);
    if(motM) n.motivation=motM[1].trim();
    if(secM) n.secret=secM[1].trim();
    if(svcM) n.services=svcM[1].trim();
    if(hookM) n.adventureHook=hookM[1].trim();
    const lines=notes.split('\n').map(l=>l.trim()).filter(l=>l);
    const narr=[];
    for(const line of lines){
      if(/^(What|Their|His|Her|Services|Hook|Connections|Advancement)[\s:]/i.test(line)) break;
      if(/^Appendix|^Week/i.test(line)) continue;
      narr.push(line);
    }
    if(narr.length>=2){n.description=narr[0];n.background=narr.slice(1).join(' ');}
    else if(narr.length===1) n.description=narr[0];
  }
  calcDerived(n);
  n.statComplete=n.agility>0&&Object.keys(n.skills).length>0;
  n.narrativeComplete=!!(n.description||n.quote);
  return n;
}

function calcDerived(n){
  var CF=window.CharacterForge;
  var ancestryData=(CF&&CF.data&&CF.data.ancestries&&CF.data.ancestries[n.ancestry])||{pace:6,size:0,toughMod:0};
  var d=window.SWADERules?window.SWADERules.calcDerived(
    {agility:n.agility,smarts:n.smarts,spirit:n.spirit,strength:n.strength,vigor:n.vigor},
    n.skills, ancestryData, []
  ):{pace:6,parry:2,toughness:5,armor:0};
  n.pace=d.pace; n.parry=d.parry; n.toughness=d.toughness+(n.toughnessArmor||0);
  n.bennies=n.tier==='Wild Card'?3:0;
}

function saveOverride(npc){const s=JSON.parse(localStorage.getItem(LS_KEY)||'{}');if(!s.overrides)s.overrides={};s.overrides[npc.name]=npc;localStorage.setItem(LS_KEY,JSON.stringify(s));}
function saveCustomNPC(npc){const s=JSON.parse(localStorage.getItem(LS_KEY)||'{}');if(!s.custom)s.custom=[];const i=s.custom.findIndex(c=>c.name===npc.name);if(i>=0)s.custom[i]=npc;else s.custom.push(npc);localStorage.setItem(LS_KEY,JSON.stringify(s));}
function d(v){return v>0?'d'+v:'‚Äî';}
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function csvToList(s){return s?s.split(',').map(x=>x.trim()).filter(x=>x):[];}

function getCatalogueEdges(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.edges) CF.data.edges.forEach(e=>all.push({...e,source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{if(m.edges)m.edges.forEach(e=>all.push({...e,source:m.name||m.id}));});
  return all;
}
function getCatalogueHindrances(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.hindrances) CF.data.hindrances.forEach(h=>all.push({...h,source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{if(m.hindrances)m.hindrances.forEach(h=>all.push({...h,source:m.name||m.id}));});
  return all;
}
function getCatalogueWeapons(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.gear?.melee) CF.data.gear.melee.forEach(w=>all.push({...w,type:'Melee',source:'Core'}));
  if(CF.data?.gear?.ranged) CF.data.gear.ranged.forEach(w=>all.push({...w,type:'Ranged',source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{
    if(m.gear?.melee) m.gear.melee.forEach(w=>all.push({...w,type:'Melee',source:m.name||m.id}));
    if(m.gear?.ranged) m.gear.ranged.forEach(w=>all.push({...w,type:'Ranged',source:m.name||m.id}));
  });
  return all;
}
function getCatalogueArmour(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.gear?.armor) CF.data.gear.armor.forEach(a=>all.push({...a,type:'Armour',source:'Core'}));
  if(CF.data?.gear?.shields) CF.data.gear.shields.forEach(s=>all.push({...s,type:'Shield',source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{
    if(m.gear?.armor) m.gear.armor.forEach(a=>all.push({...a,type:'Armour',source:m.name||m.id}));
    if(m.gear?.shields) m.gear.shields.forEach(s=>all.push({...s,type:'Shield',source:m.name||m.id}));
  });
  return all;
}
function getCatalogueSkills(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.skillLinks) Object.entries(CF.data.skillLinks).forEach(([name,attr])=>all.push({name,attr,source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{
    if(m.skillLinks) Object.entries(m.skillLinks).forEach(([name,attr])=>{if(!all.find(s=>s.name===name))all.push({name,attr,source:m.name||m.id});});
  });
  return all.sort((a,b)=>a.name.localeCompare(b.name));
}
function getCataloguePowers(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.powers) CF.data.powers.forEach(p=>all.push({...p,source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{
    if(m.powers) m.powers.forEach(p=>all.push({...p,source:m.name||m.id}));
  });
  return all;
}
function getCatalogueGear(){
  const CF=window.CharacterForge,all=[];
  if(CF.data?.gear?.general) CF.data.gear.general.forEach(g=>all.push({...g,source:'Core'}));
  (CF.getModules?CF.getModules():[]).filter(m=>!m.alwaysOn).forEach(m=>{
    if(m.gear?.general) m.gear.general.forEach(g=>all.push({...g,source:m.name||m.id}));
  });
  return all;
}
function parseGearInto(n){
  if(!n.gearText) return;
  const items=n.gearText.split(',').map(g=>g.trim()).filter(g=>g);
  const catW=getCatalogueWeapons(), catA=getCatalogueArmour();
  const remaining=[];
  items.forEach(item=>{
    const normItem=item.toLowerCase().replace(/\s*\([^)]*\)/g,'').trim();
    const wMatch=catW.find(w=>normItem.includes(w.name.toLowerCase().split('(')[0].trim()));
    if(wMatch){n.weapons.push({name:wMatch.name,damage:wMatch.dmg,ap:wMatch.ap||0,range:wMatch.range||'',rof:wMatch.rof||0,notes:wMatch.notes||'',source:wMatch.source});return;}
    const aMatch=catA.find(a=>normItem.includes(a.name.toLowerCase().split('(')[0].trim()));
    if(aMatch){n.armour.push({name:aMatch.name,armor:aMatch.armor||aMatch.parry||0,parry:aMatch.parry||0,notes:aMatch.notes||'',source:aMatch.source});return;}
    remaining.push(item);
  });
  n.gearText=remaining.join(', ');
}

function getFilteredNPCs(){
  const search=document.getElementById('searchInput').value.toLowerCase();
  const region=document.getElementById('regionFilter').value;
  const tier=document.getElementById('tierFilter').value;
  const cat=document.getElementById('categoryFilter').value;
  return allNPCs.filter(n=>{
    if(cat&&(n.category||'NPC')!==cat)return false;
    if(region&&n.region!==region)return false;
    if(tier&&n.tier!==tier)return false;
    if(search&&!n.name.toLowerCase().includes(search)&&!(n.concept||'').toLowerCase().includes(search))return false;
    return true;
  });
}

function filterNPCs(){
  renderNPCList(getFilteredNPCs());
}

document.addEventListener('keydown',function(e){
  if(!currentNPC)return;
  if(e.key!=='ArrowUp'&&e.key!=='ArrowDown')return;
  const tag=document.activeElement?.tagName;
  if(tag==='INPUT'||tag==='TEXTAREA'||tag==='SELECT')return;
  e.preventDefault();
  const list=getFilteredNPCs();
  const idx=list.findIndex(n=>n.name===currentNPC.name);
  if(idx<0)return;
  const next=e.key==='ArrowUp'?idx-1:idx+1;
  if(next<0||next>=list.length)return;
  selectNPC(list[next].name);
  const item=document.querySelectorAll('.npc-item')[next];
  if(item)item.scrollIntoView({block:'nearest'});
});

function renderNPCList(npcs){
  const el=document.getElementById('npcList');
  if(!npcs.length){el.innerHTML='<div style="padding:20px;text-align:center;color:var(--text-dim)">No characters found</div>';return;}
  const pregens=npcs.filter(n=>(n.category||'NPC')==='Pre-gen');
  const npcWC=npcs.filter(n=>(n.category||'NPC')!=='Pre-gen'&&n.tier==='Wild Card');
  const npcExt=npcs.filter(n=>(n.category||'NPC')!=='Pre-gen'&&n.tier==='Extra');
  const npcWalk=npcs.filter(n=>(n.category||'NPC')!=='Pre-gen'&&n.tier==='Walk-on');
  function renderItem(n){
    const tc=n.tier==='Wild Card'?'wc':n.tier==='Walk-on'?'walkon':'extra';
    const tl=n.tier==='Wild Card'?'WC':n.tier==='Walk-on'?'W-O':'EXT';
    const catTag=(n.category||'NPC')==='Pre-gen'?'<span class="tier-tag pregen">PG</span>':'';
    const act=currentNPC&&currentNPC.name===n.name?'active':'';
    const title=n.concept?` ‚Äî ${n.concept}`:'';
    const audit=runBuildAudit(n);
    const legal=audit.every(r=>r.pass);
    const hasWarns=audit.some(r=>r.warn);
    const legalIcon=n.agility>0?(legal?(hasWarns?'<span style="font-size:12px;margin-left:4px" title="Build Legal ‚Äî optimisation warnings">‚ö†Ô∏è</span>':'<span style="font-size:12px;margin-left:4px" title="Build Legal">‚úÖ</span>'):'<span style="font-size:12px;margin-left:4px" title="Build Issues">‚ùå</span>'):'<span style="font-size:12px;margin-left:4px;opacity:0.4" title="No stats">‚¨ú</span>';
    const canonIcon=canonCommitted.has(n.name)?'<span style="font-size:11px;margin-left:3px" title="Committed to Canon">üì¶</span>':'';
    return `<div class="npc-item ${act}" onclick="selectNPC('${esc(n.name).replace(/'/g,"\\'")}')">
      <div class="npc-name">${esc(n.name)}${catTag}<span class="tier-tag ${tc}">${tl}</span>${legalIcon}${canonIcon}
        <span class="status-dots" title="Stats / Narrative / FG">
          <span class="status-dot ${n.statComplete?'on':'off'}"></span>
          <span class="status-dot ${n.narrativeComplete?'on':'off'}"></span>
          <span class="status-dot ${n.fgReady?'on':'off'}"></span>
        </span></div>
      <div class="npc-meta">${esc(n.region)}${esc(title)}</div></div>`;
  }
  let html='';
  if(pregens.length){html+=`<div class="list-section-header">Pre-gens (${pregens.length})</div>`;html+=pregens.map(renderItem).join('');}
  if(npcWC.length){html+=`<div class="list-section-header">NPCs ‚Äî Wild Cards (${npcWC.length})</div>`;html+=npcWC.map(renderItem).join('');}
  if(npcExt.length){html+=`<div class="list-section-header">NPCs ‚Äî Extras (${npcExt.length})</div>`;html+=npcExt.map(renderItem).join('');}
  if(npcWalk.length){html+=`<div class="list-section-header">NPCs ‚Äî Walk-ons (${npcWalk.length})</div>`;html+=npcWalk.map(renderItem).join('');}
  el.innerHTML=html;
}

function updateHeaderStats(){
  const t=allNPCs.length,pg=allNPCs.filter(n=>(n.category||'NPC')==='Pre-gen').length,np=t-pg;
  const c=allNPCs.filter(n=>n.statComplete&&n.narrativeComplete).length,f=allNPCs.filter(n=>n.fgReady).length;
  const cn=allNPCs.filter(n=>canonCommitted.has(n.name)).length;
  document.getElementById("headerStats").innerHTML=`<span><span class="stat-num">${pg}</span> Pre-gens</span><span><span class="stat-num">${np}</span> NPCs</span><span><span class="stat-num">${cn}</span> üì¶ Canon</span><span><span class="stat-num">${c}</span> Complete</span><span><span class="stat-num">${f}</span> FG Ready</span>`;
}

function selectNPC(name){currentNPC=allNPCs.find(n=>n.name===name);if(!currentNPC)return;activePanel='audit';renderDetail();filterNPCs();}

function renderDetail(){
  const n=currentNPC;if(!n)return;
  const el=document.getElementById('mainContent');
  el.classList.remove('empty-state');el.style.overflowY='hidden';
  const ancestryTag=n.ancestry&&n.ancestry!=='Human'?` ¬∑ ${esc(n.ancestry)}`:'';
  const titleLine=n.concept?`<div class="npc-title-line">${esc(n.concept)}${ancestryTag}</div>`:(n.ancestry?`<div class="npc-title-line">${esc(n.ancestry)}</div>`:'');
  const canonBadge=canonCommitted.has(n.name)?'<span style="font-size:13px;margin-left:10px;color:var(--green)" title="Committed to Canon">üì¶ In Canon</span>':'<span style="font-size:13px;margin-left:10px;color:var(--text-dim)" title="Not yet committed">üì¶ Not in Canon</span>';
  el.innerHTML=`<div class="npc-header"><h2>${esc(n.name)}${canonBadge}</h2>${titleLine}</div><div class="detail-columns"><div class="col-stats" id="colStats"></div><div class="col-middle" id="colMiddle"></div><div class="col-narrative" id="colNarrative"></div></div>`;
  renderStatColumn(n);renderMiddleColumn(n);renderNarrativeColumn(n);
}

function renderStatColumn(n){
  const el=document.getElementById('colStats');
  const wcStar=n.tier==='Wild Card'?' ‚òÖ':'';
  const tierText=n.tier==='Wild Card'?'WILD CARD':n.tier.toUpperCase();
  const auditResults=runBuildAudit(n);
  const isLegal=auditResults.every(r=>r.pass);
  const warnCount=auditResults.filter(r=>r.warn).length;
  const warnTag=isLegal&&warnCount>0?` <span style="color:#e6a117">¬∑ ${warnCount} ‚ö†</span>`:'';
  const legalBadge=`<span class="build-legal-badge ${isLegal?'':'invalid'}" onclick="showPanel('audit')">${isLegal?'‚úì Build Legal':'‚úó Issues'}${warnTag}</span>`;
  const attrStr=`Agility ${d(n.agility)}, Smarts ${d(n.smarts)}, Spirit ${d(n.spirit)}, Strength ${d(n.strength)}, Vigor ${d(n.vigor)}`;
  const skillStr=Object.entries(n.skills).map(([k,v])=>`${k} ${d(v)}`).join(', ')||'<span style="color:var(--text-dim)">None</span>';
  const fDie=n.skills['Fighting']||0;
  const expParry=fDie>0?2+Math.floor(fDie/2):2;
  const expTough=2+(n.vigor>0?Math.floor(n.vigor/2):0)+(n.toughnessArmor||0);
  const paceCol=n.pace===6?'var(--green)':'var(--red)';
  const parryCol=n.parry===expParry?'var(--green)':'var(--red)';
  const toughCol=n.toughness===expTough?'var(--green)':'var(--red)';
  const toughDisp=n.toughnessArmor>0?`${n.toughness} (${n.toughnessArmor})`:`${n.toughness}`;
  const benniesItem=n.tier==='Wild Card'?`<div class="derived-item"><div class="derived-num">${n.bennies}</div><div class="derived-label">Bennies</div></div>`:'';
  const hindStr=n.hindrances.length?n.hindrances.map(h=>esc(h)).join(', '):'None';
  const edgeStr=n.edges.length?n.edges.map(e=>esc(e)).join(', '):'None';
  let statsHTML='';
  if(n.agility>0){
    statsHTML=`<div class="stat-block-panel"><div class="panel-header"><span class="tier-label">${tierText}${wcStar} ¬∑ ${esc(n.ancestry||'?')}</span>${legalBadge}</div>
    <div class="stat-section"><div class="stat-section-label" onclick="showPanel('edit')">Attributes <span class="edit-icon">‚úé</span></div><div class="stat-val">${attrStr}</div></div>
    <div class="stat-section"><div class="stat-section-label" onclick="showPanel('skills')">Skills <span class="edit-icon">‚úé</span></div><div class="stat-val">${skillStr}</div></div>
    <div class="derived-row">
      <div class="derived-item" title="Base 6"><div class="derived-num" style="color:${paceCol}">${n.pace}</div><div class="derived-label">Pace</div></div>
      <div class="derived-item" title="2 + Fighting ${d(fDie)}/2 = ${expParry}"><div class="derived-num" style="color:${parryCol}">${n.parry}</div><div class="derived-label">Parry</div></div>
      <div class="derived-item" title="2 + Vigor ${d(n.vigor)}/2 = ${expTough}"><div class="derived-num" style="color:${toughCol}">${toughDisp}</div><div class="derived-label">Toughness</div></div>
      ${benniesItem}</div>
    <div class="stat-section" style="font-size:12px"><span style="color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;font-size:10px">Hindrances</span><div class="stat-val">${hindStr}</div></div>
    <div class="stat-section" style="font-size:12px"><span style="color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;font-size:10px">Edges</span><div class="stat-val">${edgeStr}</div></div></div>`;
  } else {
    statsHTML=`<div class="stat-block-panel"><div class="panel-header"><span class="tier-label">${tierText} ¬∑ ${esc(n.ancestry||'?')}</span></div><div style="color:var(--text-dim);font-size:13px">No attributes set. <button class="btn sm" onclick="showPanel('edit')">Edit NPC</button></div></div>`;
  }
  const hindBox=buildSectionBox('Hindrances','hindrances',n.hindrances,h=>`<div class="item-entry">${esc(h)}</div>`);
  const edgeBox=buildSectionBox('Edges','edges',n.edges,e=>{const leg=isLegacyEdge(e)?' <span class="legacy-tag">(legacy)</span>':'';return `<div class="item-entry">${esc(e)}${leg}</div>`;});
  const armourBox=buildSectionBox('Armour','armour',n.armour,a=>`<div class="item-entry">${esc(a.name)} <span style="color:var(--accent)">(+${a.armor})</span></div>`);
  const weaponBox=buildSectionBox('Weapons','weapons',n.weapons,w=>`<div class="item-entry">${esc(w.name)} <span style="color:var(--text-dim)">${esc(w.damage)}${w.ap?' AP'+w.ap:''}${w.range?' '+w.range:''}</span></div>`);
  const powersBox=buildSectionBox('Powers','powers',n.powers,p=>`<div class="item-entry">${esc(p)}</div>`);
  const gearItems=n.gearText?n.gearText.split(',').map(g=>g.trim()).filter(g=>g):[];
  const gearBox=buildSectionBox('Gear','gear',gearItems,g=>`<div class="item-entry">${esc(g)}</div>`,true);
  const statusHTML=`<div class="status-bar"><div class="status-row">
    <label><input type="checkbox" ${n.statComplete?'checked':''} onchange="toggleStatus('statComplete',this.checked)"> Stats</label>
    <label><input type="checkbox" ${n.narrativeComplete?'checked':''} onchange="toggleStatus('narrativeComplete',this.checked)"> Narrative</label>
    <label><input type="checkbox" ${n.fgReady?'checked':''} onchange="toggleStatus('fgReady',this.checked)"> FG Ready</label></div>
    <div class="action-btns"><button class="btn sm" onclick="showPanel('edit')">Edit</button><button class="btn sm" onclick="showPanel('statblock')">Stat Block</button><button class="btn sm" onclick="showPanel('audit')">Audit</button><button class="btn sm danger" onclick="deleteNPC()" style="margin-left:auto">Delete</button></div></div>`;
  el.innerHTML=`<div class="col-stats-scroll">${statsHTML}<div class="section-box-pair">${hindBox}${edgeBox}</div><div class="section-box-pair">${armourBox}${weaponBox}</div><div class="section-box-pair">${powersBox}${gearBox}</div></div><div class="col-stats-footer">${statusHTML}</div>`;
}

function buildSectionBox(title,panel,items,renderItem,isLegacy){
  const content=items.length?items.map(renderItem).join('')+(isLegacy?'<div class="legacy-tag" style="margin-top:4px">Legacy</div>':''):'<div class="none-text">None</div>';
  return `<div class="section-box"><h3 onclick="showPanel('${panel}')">${title} <span class="edit-icon">‚úé</span></h3>${content}</div>`;
}
function isLegacyEdge(name){return !getCatalogueEdges().find(e=>e.name===name);}

function renderMiddleColumn(n){
  const el=document.getElementById('colMiddle');
  if(!activePanel){
    el.innerHTML=`<div class="middle-panel"><div class="middle-default"><div class="hint">Click any panel heading to edit</div><div class="quick-links">
      <a onclick="showPanel('weapons')">Weapons ‚úé</a><a onclick="showPanel('armour')">Armour ‚úé</a><a onclick="showPanel('gear')">Gear ‚úé</a>
      <a onclick="showPanel('hindrances')">Hindrances ‚úé</a><a onclick="showPanel('edges')">Edges ‚úé</a><a onclick="showPanel('powers')">Powers ‚úé</a></div></div></div>`;
    return;
  }
  const panelNames={edit:'Edit',hindrances:'Hindrances',edges:'Edges',skills:'Skills',weapons:'Weapons',armour:'Armour',gear:'Gear',powers:'Powers',narrative:'Narrative',statblock:'Stat Block',audit:'Build Audit'};
  el.innerHTML=`<div class="middle-panel"><div class="panel-title"><h3>${panelNames[activePanel]||activePanel}</h3><button class="btn" onclick="closePanel()">‚úï Done</button></div><div id="panelContent"></div></div>`;
  const panels={edit:renderEditPanel,hindrances:renderHindrancesPanel,edges:renderEdgesPanel,skills:renderSkillsPanel,weapons:renderWeaponsPanel,armour:renderArmourPanel,gear:renderGearPanel,powers:renderPowersPanel,narrative:renderNarrativePanel,statblock:renderStatBlockPanel,audit:renderAuditPanel};
  if(panels[activePanel]) panels[activePanel](n);
}

function showPanel(name){activePanel=name;if(currentNPC){renderMiddleColumn(currentNPC);renderStatColumn(currentNPC);}}
function closePanel(){activePanel=null;if(currentNPC)renderDetail();}

function renderNarrativeColumn(n){
  const el=document.getElementById('colNarrative');
  const quote=n.quote?`<div class="npc-quote">"${esc(n.quote)}"</div>`:'';
  const desc=n.description?`<div class="narrative-section"><h4 onclick="showPanel('narrative')">Description <span class="edit-icon">‚úé</span></h4><p>${esc(n.description)}</p></div>`:'';
  const bg=n.background?`<div class="narrative-section"><h4 onclick="showPanel('narrative')">Background <span class="edit-icon">‚úé</span></h4><p>${esc(n.background)}</p></div>`:'';
  let storyParts=[];
  if(n.motivation)storyParts.push(`<p><strong>What They Want:</strong> ${esc(n.motivation)}</p>`);
  if(n.secret)storyParts.push(`<p><strong>Their Secret:</strong> ${esc(n.secret)}</p>`);
  if(n.services)storyParts.push(`<p><strong>Services:</strong> ${esc(n.services)}</p>`);
  if(n.adventureHook)storyParts.push(`<p><strong>Adventure Hook:</strong> ${esc(n.adventureHook)}</p>`);
  if(n.tactics)storyParts.push(`<p><strong>Tactics:</strong> ${esc(n.tactics)}</p>`);
  const story=storyParts.length?`<div class="narrative-section"><h4 onclick="showPanel('narrative')">Story <span class="edit-icon">‚úé</span></h4>${storyParts.join('')}</div>`:'';
  el.innerHTML=`<div class="portrait-box">No portrait</div><div class="portrait-actions"><a>‚ú¶ Generate</a> <a>Upload</a></div>${quote}${desc}${bg}${story}`;
}

// ‚ïê‚ïê‚ïê EDITOR PANELS ‚ïê‚ïê‚ïê
function renderEditPanel(n){
  const el=document.getElementById('panelContent');
  const dieSel=(id,val)=>{const opts=[0,4,6,8,10,12].map(v=>`<option value="${v}" ${val===v?'selected':''}>${v?'d'+v:'‚Äî'}</option>`).join('');return `<select id="${id}">${opts}</select>`;};
  el.innerHTML=`
    <div class="form-row"><div class="form-group"><label>Name *</label><input id="ed_name" value="${esc(n.name)}"></div><div class="form-group"><label>Title / Role</label><input id="ed_concept" value="${esc(n.concept)}"></div></div>
    <div class="form-row">
      <div class="form-group"><label>Region *</label><select id="ed_region">${['Ammaria','Saltlands','Vinlands','Concordium','Glasrya','Global'].map(r=>`<option ${n.region===r?'selected':''}>${r}</option>`).join('')}</select></div>
      <div class="form-group"><label>Tier *</label><select id="ed_tier">${['Wild Card','Extra','Walk-on'].map(t=>`<option ${n.tier===t?'selected':''}>${t}</option>`).join('')}</select></div>
      <div class="form-group"><label>Category</label><select id="ed_category">${['Pre-gen','NPC'].map(c=>`<option ${(n.category||'NPC')===c?'selected':''}>${c}</option>`).join('')}</select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Gender</label><select id="ed_gender">${['Unspecified','Male','Female','Other'].map(g=>`<option>${g}</option>`).join('')}</select></div>
      <div class="form-group"><label>Ancestry</label><select id="ed_ancestry">${['Human','Dwarf','Elf','Half-Folk','Other'].map(a=>`<option ${n.ancestry===a?'selected':''}>${a}</option>`).join('')}</select></div>
    </div>
    <div class="form-group"><label>Signature Quote</label><input id="ed_quote" value="${esc(n.quote)}"></div>
    <div class="form-group"><label>Description</label><textarea id="ed_description" rows="3">${esc(n.description)}</textarea></div>
    <div class="form-group"><label>Background</label><textarea id="ed_background" rows="3">${esc(n.background)}</textarea></div>
    <div class="form-row"><div class="form-group"><label>Agility</label>${dieSel('ed_agility',n.agility)}</div><div class="form-group"><label>Smarts</label>${dieSel('ed_smarts',n.smarts)}</div><div class="form-group"><label>Spirit</label>${dieSel('ed_spirit',n.spirit)}</div><div class="form-group"><label>Strength</label>${dieSel('ed_strength',n.strength)}</div><div class="form-group"><label>Vigor</label>${dieSel('ed_vigor',n.vigor)}</div></div>
    <div class="form-row"><div class="form-group"><label>Pace</label><input id="ed_pace" type="number" value="${n.pace}"></div><div class="form-group"><label>Parry</label><input id="ed_parry" type="number" value="${n.parry}"></div><div class="form-group"><label>Toughness</label><input id="ed_toughness" type="number" value="${n.toughness}"></div><div class="form-group"><label>Tough (Armor)</label><input id="ed_tougharmor" type="number" value="${n.toughnessArmor}"></div><div class="form-group"><label>Bennies</label><input id="ed_bennies" type="number" value="${n.bennies}"></div></div>
    <div class="form-group"><label>Edges (legacy, comma-separated)</label><input id="ed_edges" value="${esc(n.edges.join(', '))}"></div>
    <div class="form-group"><label>Hindrances (legacy, comma-separated)</label><input id="ed_hindrances" value="${esc(n.hindrances.join(', '))}"></div>
    <div class="form-group"><label>Gear</label><input id="ed_gear" value="${esc(n.gearText)}"></div>
    <div class="form-actions"><button class="btn" onclick="closePanel()">Cancel</button><button class="btn primary" onclick="saveEdit()">Save Changes</button></div>`;
}
function saveEdit(){
  const n=currentNPC;
  n.name=document.getElementById('ed_name').value.trim();n.concept=document.getElementById('ed_concept').value.trim();n.region=document.getElementById('ed_region').value;n.tier=document.getElementById('ed_tier').value;n.category=document.getElementById('ed_category').value;n.ancestry=document.getElementById('ed_ancestry').value;n.quote=document.getElementById('ed_quote').value.trim();n.description=document.getElementById('ed_description').value.trim();n.background=document.getElementById('ed_background').value.trim();
  n.agility=parseInt(document.getElementById('ed_agility').value);n.smarts=parseInt(document.getElementById('ed_smarts').value);n.spirit=parseInt(document.getElementById('ed_spirit').value);n.strength=parseInt(document.getElementById('ed_strength').value);n.vigor=parseInt(document.getElementById('ed_vigor').value);
  n.pace=parseInt(document.getElementById('ed_pace').value);n.parry=parseInt(document.getElementById('ed_parry').value);n.toughness=parseInt(document.getElementById('ed_toughness').value);n.toughnessArmor=parseInt(document.getElementById('ed_tougharmor').value);n.bennies=parseInt(document.getElementById('ed_bennies').value);
  n.edges=csvToList(document.getElementById('ed_edges').value);n.hindrances=csvToList(document.getElementById('ed_hindrances').value);n.gearText=document.getElementById('ed_gear').value.trim();
  saveOverride(n);closePanel();updateHeaderStats();
}

function renderHindrancesPanel(n){
  const el=document.getElementById('panelContent');
  const catalogue=getCatalogueHindrances();
  const items=n.hindrances.map(h=>`<div class="item-entry" style="display:flex;justify-content:space-between;align-items:center;padding:4px 0">${esc(h)} <button class="btn sm danger" onclick="removeHindrance(this)" data-val="${esc(h)}">√ó</button></div>`).join('');
  el.innerHTML=`<div>${items||'<div style="color:var(--text-dim)">No hindrances yet</div>'}</div>
    <div class="catalogue-section"><h4>Add Hindrance</h4><div style="margin-bottom:4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Pick from Catalogue</div>
    <input type="text" id="hindSearch" placeholder="Search hindrances..." oninput="filterHindCat()" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:5px 8px;border-radius:3px;font-size:12px;margin-bottom:4px">
    <div class="catalogue-list" id="hindCatList"></div>
    <div class="form-row"><div class="form-group"><label>Name</label><input id="hind_name"></div><div class="form-group" style="max-width:120px"><label>Severity</label><select id="hind_sev"><option>Minor</option><option>Major</option></select></div></div>
    <div class="form-group"><label>Notes</label><input id="hind_notes" placeholder="Optional details"></div>
    <button class="btn primary" onclick="addHindrance()">Add Hindrance</button></div>`;
  filterHindCat();
}
function filterHindCat(){
  const s=(document.getElementById('hindSearch')?.value||'').toLowerCase();
  const cat=getCatalogueHindrances().filter(h=>!s||h.name.toLowerCase().includes(s));
  const el=document.getElementById('hindCatList');if(!el)return;
  el.innerHTML=cat.slice(0,30).map(h=>`<div class="catalogue-item" onclick="document.getElementById('hind_name').value='${esc(h.name)}';document.getElementById('hind_sev').value='${(h.type||'Minor').includes('Major')?'Major':'Minor'}'"><span class="cat-name">${esc(h.name)}</span> <span class="cat-detail">(${esc(h.type||'Minor')}) ‚Äî ${esc(h.source)}</span></div>`).join('');
}
function addHindrance(){
  const name=document.getElementById('hind_name').value.trim();if(!name)return;
  const sev=document.getElementById('hind_sev').value;
  const notes=document.getElementById('hind_notes').value.trim();
  currentNPC.hindrances.push(notes?`${name} (${sev} ‚Äî ${notes})`:`${name} (${sev})`);
  saveOverride(currentNPC);renderHindrancesPanel(currentNPC);renderStatColumn(currentNPC);
}
function removeHindrance(btn){
  const val=btn.dataset.val;currentNPC.hindrances=currentNPC.hindrances.filter(x=>x!==val);
  saveOverride(currentNPC);renderHindrancesPanel(currentNPC);renderStatColumn(currentNPC);
}

function renderEdgesPanel(n){
  const el=document.getElementById('panelContent');
  const items=n.edges.map(e=>{const leg=isLegacyEdge(e)?' <span class="legacy-tag">(legacy)</span>':'';return `<div class="item-entry" style="display:flex;justify-content:space-between;align-items:center;padding:4px 0">${esc(e)}${leg} <button class="btn sm danger" onclick="removeEdge(this)" data-val="${esc(e)}">√ó</button></div>`;}).join('');
  el.innerHTML=`<div>${items||'<div style="color:var(--text-dim)">No edges yet</div>'}</div>
    <div class="catalogue-section"><h4>Add Edge</h4>
    <input type="text" id="edgeSearch" placeholder="Search edges..." oninput="filterEdgeCat()" style="width:100%;background:var(--bg-input);border:1px solid var(--border);color:var(--text);padding:5px 8px;border-radius:3px;font-size:12px;margin-bottom:4px">
    <div class="catalogue-list" id="edgeCatList"></div>
    <div class="form-group"><label>Name</label><input id="edge_name"></div>
    <button class="btn primary" onclick="addEdge()">Add Edge</button></div>`;
  filterEdgeCat();
}
function filterEdgeCat(){
  const s=(document.getElementById('edgeSearch')?.value||'').toLowerCase();
  const cat=getCatalogueEdges().filter(e=>!s||e.name.toLowerCase().includes(s));
  const el=document.getElementById('edgeCatList');if(!el)return;
  el.innerHTML=cat.slice(0,30).map(e=>`<div class="catalogue-item" onclick="document.getElementById('edge_name').value='${esc(e.name)}'"><span class="cat-name">${esc(e.name)}</span> <span class="cat-detail">${esc(e.rank||'')} ${esc(e.type||'')} ‚Äî ${esc(e.source)}</span></div>`).join('');
}
function addEdge(){const name=document.getElementById('edge_name').value.trim();if(!name)return;currentNPC.edges.push(name);saveOverride(currentNPC);renderEdgesPanel(currentNPC);renderStatColumn(currentNPC);}
function removeEdge(btn){const val=btn.dataset.val;currentNPC.edges=currentNPC.edges.filter(x=>x!==val);saveOverride(currentNPC);renderEdgesPanel(currentNPC);renderStatColumn(currentNPC);}

function renderSkillsPanel(n){
  const el=document.getElementById('panelContent');
  const rows=Object.entries(n.skills).sort((a,b)=>a[0].localeCompare(b[0])).map(([name,die])=>`<tr><td>${esc(name)}</td><td>${d(die)}</td><td><button class="btn sm danger" onclick="removeSkill('${esc(name)}')">√ó</button></td></tr>`).join('');
  el.innerHTML=`<table class="data-table"><tr><th>Skill</th><th>Die</th><th></th></tr>${rows||'<tr><td colspan="3" style="color:var(--text-dim)">No skills</td></tr>'}</table>
    <div class="catalogue-section"><h4>Add Skill</h4>
    <div style="margin-bottom:4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Pick from Catalogue</div>
    <input placeholder="Search skills..." oninput="filterSkillCatalogue(this.value)" style="width:100%;margin-bottom:4px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px">
    <div class="catalogue-list" id="skillCatList"></div>
    <div style="margin:10px 0 4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Or Enter Custom</div>
    <div class="form-row"><div class="form-group"><label>Skill Name</label><input id="skill_name"></div>
    <div class="form-group" style="max-width:100px"><label>Die</label><select id="skill_die"><option value="4">d4</option><option value="6">d6</option><option value="8" selected>d8</option><option value="10">d10</option><option value="12">d12</option></select></div></div>
    <button class="btn primary" onclick="addSkill()">Add Skill</button></div>`;
  filterSkillCatalogue('');
}
function filterSkillCatalogue(s){
  s=s.toLowerCase();
  const existing=currentNPC?Object.keys(currentNPC.skills).map(k=>k.toLowerCase()):[];
  const cat=getCatalogueSkills().filter(sk=>(!s||sk.name.toLowerCase().includes(s))&&!existing.includes(sk.name.toLowerCase()));
  const el=document.getElementById('skillCatList');if(!el)return;
  el.innerHTML=cat.slice(0,30).map(sk=>`<div class="catalogue-item" onclick="selectCatalogueSkill('${esc(sk.name)}')"><span class="cat-name">${esc(sk.name)}</span> <span class="cat-detail">(${esc(sk.attr)}) ‚Äî ${esc(sk.source)}</span></div>`).join('');
}
function selectCatalogueSkill(name){document.getElementById('skill_name').value=name;}
function addSkill(){const name=document.getElementById('skill_name').value.trim(),die=parseInt(document.getElementById('skill_die').value);if(!name)return;currentNPC.skills[name]=die;calcDerived(currentNPC);saveOverride(currentNPC);renderSkillsPanel(currentNPC);renderStatColumn(currentNPC);}
function removeSkill(name){delete currentNPC.skills[name];calcDerived(currentNPC);saveOverride(currentNPC);renderSkillsPanel(currentNPC);renderStatColumn(currentNPC);}

function renderWeaponsPanel(n){
  const current=n.weapons.map((w,i)=>`<div class="item-entry" style="display:flex;justify-content:space-between;align-items:center;padding:4px 0"><span>${esc(w.name)} <span style="color:var(--text-dim)">${esc(w.damage)}${w.ap?' AP'+w.ap:''}${w.range?' '+w.range:''}</span></span><button class="btn sm danger" onclick="removeWeapon(${i})">√ó</button></div>`).join('');
  document.getElementById('panelContent').innerHTML=`<div>${current||'<div style="color:var(--text-dim)">No weapons</div>'}</div>
    <div class="catalogue-section"><h4>Add Weapon</h4>
    <div style="margin-bottom:4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Pick from Catalogue</div>
    <input placeholder="Search weapons..." oninput="filterWeaponCatalogue(this.value)" style="width:100%;margin-bottom:4px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px">
    <div class="catalogue-list" id="wepCatList"></div>
    <div style="margin:10px 0 4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Or Enter Custom</div>
    <div class="form-row"><div class="form-group"><label>Name</label><input id="wep_name"></div><div class="form-group"><label>Damage</label><input id="wep_damage" placeholder="Str+d8"></div></div>
    <div class="form-row"><div class="form-group" style="max-width:80px"><label>AP</label><input id="wep_ap" type="number" value="0"></div><div class="form-group"><label>Range</label><input id="wep_range" placeholder=""></div><div class="form-group"><label>Notes</label><input id="wep_notes"></div></div>
    <button class="btn primary" onclick="addWeapon()">Add Weapon</button></div>`;
  filterWeaponCatalogue('');
}
function filterWeaponCatalogue(s){
  s=s.toLowerCase();
  const cat=getCatalogueWeapons().filter(w=>!s||w.name.toLowerCase().includes(s));
  const el=document.getElementById('wepCatList');if(!el)return;
  el.innerHTML=cat.slice(0,30).map(w=>`<div class="catalogue-item" onclick="selectCatalogueWeapon('${esc(w.name)}')"><span class="cat-name">${esc(w.name)}</span> <span class="cat-detail">${esc(w.dmg)}${w.ap?' AP'+w.ap:''}${w.range?' '+w.range:''} ‚Äî ${esc(w.source)}</span></div>`).join('');
}
function selectCatalogueWeapon(name){
  const w=getCatalogueWeapons().find(x=>x.name===name);if(!w)return;
  document.getElementById('wep_name').value=w.name;
  document.getElementById('wep_damage').value=w.dmg;
  document.getElementById('wep_ap').value=w.ap||0;
  document.getElementById('wep_range').value=w.range||'';
  document.getElementById('wep_notes').value=w.notes||'';
}
function addWeapon(){
  const name=document.getElementById('wep_name').value.trim(),dmg=document.getElementById('wep_damage').value.trim();
  if(!name||!dmg)return;
  currentNPC.weapons.push({name,damage:dmg,ap:parseInt(document.getElementById('wep_ap').value)||0,range:document.getElementById('wep_range').value.trim(),notes:document.getElementById('wep_notes').value.trim(),source:'Manual'});
  saveOverride(currentNPC);renderWeaponsPanel(currentNPC);renderStatColumn(currentNPC);
}
function removeWeapon(idx){currentNPC.weapons.splice(idx,1);saveOverride(currentNPC);renderWeaponsPanel(currentNPC);renderStatColumn(currentNPC);}
function addWeaponToGear(){addWeapon();}

function renderArmourPanel(n){
  const current=n.armour.map((a,i)=>`<div class="item-entry" style="display:flex;justify-content:space-between;align-items:center;padding:4px 0"><span>${esc(a.name)} <span style="color:var(--accent)">(+${a.armor})</span>${a.notes?' <span style="color:var(--text-dim)">'+esc(a.notes)+'</span>':''}</span><button class="btn sm danger" onclick="removeArmour(${i})">√ó</button></div>`).join('');
  document.getElementById('panelContent').innerHTML=`<div>${current||'<div style="color:var(--text-dim)">No armour</div>'}</div>
    <div class="catalogue-section"><h4>Add Armour</h4>
    <div style="margin-bottom:4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Pick from Catalogue</div>
    <input placeholder="Search armour & shields..." oninput="filterArmourCatalogue(this.value)" style="width:100%;margin-bottom:4px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px">
    <div class="catalogue-list" id="armCatList"></div>
    <div style="margin:10px 0 4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Or Enter Custom</div>
    <div class="form-row"><div class="form-group"><label>Name</label><input id="arm_name"></div><div class="form-group" style="max-width:100px"><label>Protection</label><input id="arm_prot" type="number" value="2"></div></div>
    <div class="form-row"><div class="form-group"><label>Notes</label><input id="arm_notes"></div></div>
    <button class="btn primary" onclick="addArmour()">Add Armour</button></div>`;
  filterArmourCatalogue('');
}
function filterArmourCatalogue(s){
  s=s.toLowerCase();
  const cat=getCatalogueArmour().filter(a=>!s||a.name.toLowerCase().includes(s));
  const el=document.getElementById('armCatList');if(!el)return;
  el.innerHTML=cat.slice(0,30).map(a=>{
    const val=a.armor?'+'+a.armor:(a.parry?'Parry +'+a.parry:'');
    return `<div class="catalogue-item" onclick="selectCatalogueArmour('${esc(a.name)}')"><span class="cat-name">${esc(a.name)}</span> <span class="cat-detail">(${val}) ‚Äî ${esc(a.source)}</span></div>`;
  }).join('');
}
function selectCatalogueArmour(name){
  const a=getCatalogueArmour().find(x=>x.name===name);if(!a)return;
  document.getElementById('arm_name').value=a.name;
  document.getElementById('arm_prot').value=a.armor||a.parry||0;
  document.getElementById('arm_notes').value=a.notes||'';
}
function addArmour(){
  const name=document.getElementById('arm_name').value.trim();if(!name)return;
  const armor=parseInt(document.getElementById('arm_prot').value)||0;
  currentNPC.armour.push({name,armor,notes:document.getElementById('arm_notes').value.trim(),source:'Manual'});
  recalcArmour();saveOverride(currentNPC);renderArmourPanel(currentNPC);renderStatColumn(currentNPC);
}
function removeArmour(idx){currentNPC.armour.splice(idx,1);recalcArmour();saveOverride(currentNPC);renderArmourPanel(currentNPC);renderStatColumn(currentNPC);}
function addArmourToGear(){addArmour();}
function recalcArmour(){currentNPC.toughnessArmor=currentNPC.armour.reduce((best,a)=>Math.max(best,a.armor||0),0);calcDerived(currentNPC);}

function renderGearPanel(n){
  const items=n.gearText?n.gearText.split(',').map(g=>g.trim()).filter(g=>g):[];
  const rows=items.map((g,i)=>`<div class="item-entry" style="display:flex;justify-content:space-between;padding:4px 0">${esc(g)} <button class="btn sm danger" onclick="removeGearItem(${i})">√ó</button></div>`).join('');
  document.getElementById('panelContent').innerHTML=`<div>${rows||'<div style="color:var(--text-dim)">No gear yet</div>'}</div>
    <div class="catalogue-section"><h4>Add Item</h4>
    <div style="margin-bottom:4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Pick from Catalogue</div>
    <input placeholder="Search gear..." oninput="filterGearCatalogue(this.value)" style="width:100%;margin-bottom:4px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px">
    <div class="catalogue-list" id="gearCatList"></div>
    <div style="margin:10px 0 4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Or Enter Custom</div>
    <div class="form-group"><label>Item</label><input id="gear_name"></div>
    <button class="btn primary" onclick="addGearItem()">Add Item</button></div>`;
  filterGearCatalogue('');
}
function filterGearCatalogue(s){
  s=s.toLowerCase();
  const cat=getCatalogueGear().filter(g=>!s||g.name.toLowerCase().includes(s));
  const el=document.getElementById('gearCatList');if(!el)return;
  el.innerHTML=cat.slice(0,30).map(g=>{
    const detail=g.notes?` ‚Äî ${g.notes}`:'';
    return `<div class="catalogue-item" onclick="document.getElementById('gear_name').value='${esc(g.name)}'"><span class="cat-name">${esc(g.name)}</span> <span class="cat-detail">${g.cost?g.cost+'‚Ç°':''}${detail} ‚Äî ${esc(g.source)}</span></div>`;
  }).join('');
}
function addGearItem(){const item=document.getElementById('gear_name').value.trim();if(!item)return;currentNPC.gearText=currentNPC.gearText?currentNPC.gearText+', '+item:item;saveOverride(currentNPC);renderGearPanel(currentNPC);renderStatColumn(currentNPC);}
function removeGearItem(idx){const items=currentNPC.gearText.split(',').map(g=>g.trim()).filter(g=>g);items.splice(idx,1);currentNPC.gearText=items.join(', ');saveOverride(currentNPC);renderGearPanel(currentNPC);renderStatColumn(currentNPC);}

function renderPowersPanel(n){
  const rows=n.powers.map((p,i)=>`<div class="item-entry" style="display:flex;justify-content:space-between;padding:4px 0">${esc(p)} <button class="btn sm danger" onclick="removePower(${i})">√ó</button></div>`).join('');
  document.getElementById('panelContent').innerHTML=`<div class="form-row" style="margin-bottom:10px"><div class="form-group"><label>Arcane Background</label><input id="pow_ab" value="${esc(n.abName)}"></div><div class="form-group" style="max-width:100px"><label>Power Points</label><input id="pow_pp" type="number" value="${n.pp}"></div></div>
    <div>${rows||'<div style="color:var(--text-dim)">No powers yet</div>'}</div>
    <div class="catalogue-section"><h4>Add Power</h4>
    <div style="margin-bottom:4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Pick from Catalogue</div>
    <input placeholder="Search powers..." oninput="filterPowerCatalogue(this.value)" style="width:100%;margin-bottom:4px;padding:5px 8px;background:var(--bg-input);border:1px solid var(--border);border-radius:3px;color:var(--text);font-size:12px">
    <div class="catalogue-list" id="powCatList"></div>
    <div style="margin:10px 0 4px;font-size:11px;color:var(--text-dim);text-transform:uppercase">Or Enter Custom</div>
    <div class="form-group"><label>Power Name</label><input id="pow_name"></div>
    <button class="btn primary" onclick="addPower()">Add Power</button></div>
    <div class="form-actions"><button class="btn" onclick="savePowerSettings()">Save AB Settings</button></div>`;
  filterPowerCatalogue('');
}
function filterPowerCatalogue(s){
  s=s.toLowerCase();
  const existing=currentNPC?currentNPC.powers.map(p=>p.toLowerCase()):[];
  const cat=getCataloguePowers().filter(p=>(!s||p.name.toLowerCase().includes(s))&&!existing.includes(p.name.toLowerCase()));
  const el=document.getElementById('powCatList');if(!el)return;
  el.innerHTML=cat.slice(0,30).map(p=>`<div class="catalogue-item" onclick="document.getElementById('pow_name').value='${esc(p.name)}'"><span class="cat-name">${esc(p.name)}</span> <span class="cat-detail">${esc(p.rank)} ${esc(p.pp)}PP ${p.range?p.range:''} ‚Äî ${esc(p.source)}</span></div>`).join('');
}
function addPower(){const name=document.getElementById('pow_name').value.trim();if(!name)return;currentNPC.powers.push(name);saveOverride(currentNPC);renderPowersPanel(currentNPC);renderStatColumn(currentNPC);}
function removePower(idx){currentNPC.powers.splice(idx,1);saveOverride(currentNPC);renderPowersPanel(currentNPC);renderStatColumn(currentNPC);}
function savePowerSettings(){currentNPC.abName=document.getElementById('pow_ab').value.trim();currentNPC.pp=parseInt(document.getElementById('pow_pp').value)||0;saveOverride(currentNPC);renderStatColumn(currentNPC);}

function renderNarrativePanel(n){
  document.getElementById('panelContent').innerHTML=`
    <div class="form-group"><label>Description</label><textarea id="nar_desc" rows="3">${esc(n.description)}</textarea></div>
    <div class="form-group"><label>Background</label><textarea id="nar_bg" rows="3">${esc(n.background)}</textarea></div>
    <div class="form-group"><label>What They Want</label><textarea id="nar_mot" rows="2">${esc(n.motivation)}</textarea></div>
    <div class="form-group"><label>Their Secret</label><textarea id="nar_sec" rows="2">${esc(n.secret)}</textarea></div>
    <div class="form-group"><label>Services</label><input id="nar_svc" value="${esc(n.services)}"></div>
    <div class="form-group"><label>Adventure Hook</label><textarea id="nar_hook" rows="2">${esc(n.adventureHook)}</textarea></div>
    <div class="form-group"><label>Tactics</label><textarea id="nar_tac" rows="2">${esc(n.tactics)}</textarea></div>
    <div class="form-actions"><button class="btn" onclick="closePanel()">Cancel</button><button class="btn primary" onclick="saveNarrative()">Save Narrative</button></div>`;
}
function saveNarrative(){const n=currentNPC;n.description=document.getElementById('nar_desc').value.trim();n.background=document.getElementById('nar_bg').value.trim();n.motivation=document.getElementById('nar_mot').value.trim();n.secret=document.getElementById('nar_sec').value.trim();n.services=document.getElementById('nar_svc').value.trim();n.adventureHook=document.getElementById('nar_hook').value.trim();n.tactics=document.getElementById('nar_tac').value.trim();saveOverride(n);closePanel();}

function renderStatBlockPanel(n){
  const skillStr=Object.entries(n.skills).map(([k,v])=>`${k} ${d(v)}`).join(', ');
  const toughDisp=n.toughnessArmor>0?`${n.toughness} (${n.toughnessArmor})`:`${n.toughness}`;
  let fmt=`<strong>${esc(n.name)}</strong>\n`;
  if(n.quote)fmt+=`<em>"${esc(n.quote)}"</em>\n\n`;
  if(n.description)fmt+=`${esc(n.description)}\n\n`;
  fmt+=`<span class="label">Attributes:</span> Agility ${d(n.agility)}, Smarts ${d(n.smarts)}, Spirit ${d(n.spirit)}, Strength ${d(n.strength)}, Vigor ${d(n.vigor)}\n`;
  fmt+=`<span class="label">Skills:</span> ${skillStr}\n`;
  fmt+=`<span class="label">Pace:</span> ${n.pace}; <span class="label">Parry:</span> ${n.parry}; <span class="label">Toughness:</span> ${toughDisp}\n`;
  if(n.edges.length)fmt+=`<span class="label">Edges:</span> ${n.edges.join(', ')}\n`;
  if(n.hindrances.length)fmt+=`<span class="label">Hindrances:</span> ${n.hindrances.join(', ')}\n`;
  if(n.gearText)fmt+=`<span class="label">Gear:</span> ${esc(n.gearText)}\n`;
  if(n.pp>0)fmt+=`<span class="label">Powers (${n.pp} PP):</span> ${n.powers.join(', ')}\n`;
  if(n.tactics)fmt+=`<span class="label">Tactics:</span> ${esc(n.tactics)}\n`;
  let md=`**${n.name}**\n`;
  if(n.quote)md+=`*"${n.quote}"*\n\n`;
  if(n.description)md+=`${n.description}\n\n`;
  md+=`**Attributes:** Agility ${d(n.agility)}, Smarts ${d(n.smarts)}, Spirit ${d(n.spirit)}, Strength ${d(n.strength)}, Vigor ${d(n.vigor)}\n`;
  md+=`**Skills:** ${skillStr}\n**Pace:** ${n.pace}; **Parry:** ${n.parry}; **Toughness:** ${toughDisp}\n`;
  if(n.edges.length)md+=`**Edges:** ${n.edges.join(', ')}\n`;
  if(n.hindrances.length)md+=`**Hindrances:** ${n.hindrances.join(', ')}\n`;
  if(n.gearText)md+=`**Gear:** ${n.gearText}\n`;
  if(n.pp>0)md+=`**Powers (${n.pp} PP):** ${n.powers.join(', ')}\n`;
  if(n.tactics)md+=`**Tactics:** ${n.tactics}\n`;
  document.getElementById('panelContent').innerHTML=`<div class="export-tabs"><div class="export-tab active" onclick="switchExportTab(this,'fmt')">Formatted</div><div class="export-tab" onclick="switchExportTab(this,'md')">Markdown</div></div><div class="export-content" id="exportFmt">${fmt}</div><div class="export-content" id="exportMd" style="display:none">${esc(md)}</div><div class="form-actions" style="margin-top:8px"><button class="btn" onclick="copyExport('html')">Copy HTML</button><button class="btn" onclick="copyExport('md')">Copy Markdown</button></div>`;
}
function switchExportTab(el,tab){document.querySelectorAll('.export-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');document.getElementById('exportFmt').style.display=tab==='fmt'?'block':'none';document.getElementById('exportMd').style.display=tab==='md'?'block':'none';}
function copyExport(type){const el=type==='html'?document.getElementById('exportFmt'):document.getElementById('exportMd');navigator.clipboard.writeText(el.innerText).then(()=>alert('Copied to clipboard'));}

function runBuildAudit(n){
  var CF=window.CharacterForge;
  var ancestryData=(CF.data.ancestries&&CF.data.ancestries[n.ancestry])||{attrBonus:1,freeEdges:1,pace:6,size:0,toughMod:0};
  var skillLinks=CF.data.skillLinks||{};
  var coreSkills=CF.data.coreSkills||['Athletics','Common Knowledge','Notice','Persuasion','Stealth'];
  return window.SWADERules.runBuildAudit({
    attrs:{agility:n.agility,smarts:n.smarts,spirit:n.spirit,strength:n.strength,vigor:n.vigor},
    skills:n.skills, edges:n.edges, hindrances:n.hindrances,
    tier:n.tier, ancestryData:ancestryData, ancestry:n.ancestry||'',
    skillLinks:skillLinks, coreSkills:coreSkills,
    pace:n.pace, parry:n.parry, toughness:n.toughness, toughnessArmor:n.toughnessArmor||0
  });
}

function renderAuditPanel(n){
  const results=runBuildAudit(n);
  const legal=results.every(r=>r.pass);
  let html=`<div class="audit-block"><h4 style="color:var(--accent);margin-bottom:8px;font-size:14px">${esc(n.name)} ‚Äî Build Audit</h4>`,curSec='';
  results.forEach(r=>{
    if(r.section!==curSec){curSec=r.section;html+=`<div class="audit-section"><h4>${esc(curSec)}</h4>`;}
    const cls=r.warn?'audit-warn':r.pass?'audit-pass':'audit-fail';
    const icon=r.warn?'‚ö†':r.pass?'‚úì':'‚úó';
    html+=`<div class="audit-line ${cls}">${icon} ${esc(r.label)} ${esc(r.detail)}</div>`;
  });
  html+='</div></div>';
  const inCanon=canonCommitted.has(n.name);
  const commitLabel=inCanon?'üîÑ Update Canon':'üì¶ Commit to Canon';
  const removeBtn=inCanon?'<button class="btn" onclick="removeFromCanon()" style="color:var(--red);border-color:var(--red)" title="Remove this character from canonical data">üóë Remove from Canon</button>':'';
  html+=`<div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <button class="btn primary" onclick="openCommitModal()" title="${inCanon?'Update canonical data':'Commit current state to canon repository'}">${commitLabel}</button>
    ${removeBtn}
    <span style="font-size:12px;color:var(--text-dim)">${legal?'‚úÖ Build legal ‚Äî ready to commit':'‚ùå Build has issues ‚Äî commit with caution'}</span>
  </div>`;
  document.getElementById('panelContent').innerHTML=html;
}

function toggleStatus(field,val){currentNPC[field]=val;saveOverride(currentNPC);filterNPCs();updateHeaderStats();}
function deleteNPC(){
  if(!confirm(`Delete ${currentNPC.name}?`))return;
  const s=JSON.parse(localStorage.getItem(LS_KEY)||'{}');
  if(s.custom)s.custom=s.custom.filter(c=>c.name!==currentNPC.name);
  if(!s.deleted)s.deleted=[];s.deleted.push(currentNPC.name);
  localStorage.setItem(LS_KEY,JSON.stringify(s));
  allNPCs=allNPCs.filter(n=>n.name!==currentNPC.name);currentNPC=null;
  document.getElementById('mainContent').innerHTML='Select an NPC or create a new one';
  document.getElementById('mainContent').classList.add('empty-state');
  filterNPCs();updateHeaderStats();
}
function openNewNPCModal(){document.getElementById('newNpcModal').classList.add('active');}
function closeNewNPCModal(){document.getElementById('newNpcModal').classList.remove('active');}
function createNPC(){
  const name=document.getElementById('new_name').value.trim();if(!name){alert('Name is required');return;}
  const npc={name,concept:document.getElementById('new_concept')?.value?.trim()||'',ancestry:document.getElementById('new_ancestry').value,region:document.getElementById('new_region').value,tier:document.getElementById('new_tier').value,rank:'Novice',category:document.getElementById('new_category').value,product:'',source:'custom',agility:0,smarts:0,spirit:0,strength:0,vigor:0,skills:{},edges:[],hindrances:[],powers:[],gearText:'',quote:'',description:'',background:'',motivation:'',secret:'',services:'',adventureHook:'',tactics:'',abName:'',abSkill:'',pp:0,statComplete:false,narrativeComplete:false,fgReady:false,pace:6,parry:2,toughness:5,toughnessArmor:0,bennies:0};
  calcDerived(npc);allNPCs.push(npc);saveCustomNPC(npc);closeNewNPCModal();filterNPCs();updateHeaderStats();selectNPC(name);
}
function showStatusView(){
  const el=document.getElementById('mainContent');el.classList.remove('empty-state');el.style.overflowY='auto';
  const rows=allNPCs.map(n=>{
    const audit=runBuildAudit(n);const legal=audit.every(r=>r.pass);
    const inCanon=canonCommitted.has(n.name);
    return `<tr><td>${esc(n.name)}</td><td>${esc(n.category||'NPC')}</td><td>${esc(n.region)}</td><td>${esc(n.tier)}</td><td>${legal?'‚úÖ':'‚ùå'}</td><td>${inCanon?'üì¶':'‚Äî'}</td><td style="color:${n.statComplete?'var(--green)':'var(--text-dim)'}">&#${n.statComplete?'10003':'8212'};</td><td style="color:${n.narrativeComplete?'var(--green)':'var(--text-dim)'}">&#${n.narrativeComplete?'10003':'8212'};</td><td style="color:${n.fgReady?'var(--green)':'var(--text-dim)'}">&#${n.fgReady?'10003':'8212'};</td></tr>`;
  }).join('');
  el.innerHTML=`<h2 style="color:var(--accent);margin-bottom:14px">Production Status</h2><table class="data-table"><tr><th>Name</th><th>Type</th><th>Region</th><th>Tier</th><th>Build</th><th>Canon</th><th>Stats</th><th>Narrative</th><th>FG Ready</th></tr>${rows}</table>`;
}

// ‚îÄ‚îÄ CANON COMMIT SYSTEM ‚îÄ‚îÄ
const CANON_API='/api/commit';

function buildCanonCharacter(n){
  return {
    name:n.name, concept:n.concept||'', ancestry:n.ancestry||'Human', region:n.region||'Ammaria',
    tier:n.tier||'Wild Card', rank:n.rank||'Novice', category:n.category||'NPC', product:n.product||n.region||'Ammaria',
    attrs:{agility:n.agility||4,smarts:n.smarts||4,spirit:n.spirit||4,strength:n.strength||4,vigor:n.vigor||4},
    skills:Object.assign({},n.skills), edges:[...(n.edges||[])], hindrances:[...(n.hindrances||[])],
    powers:[...(n.powers||[])], gear:[...(n.gear||[])],
    gearText:n.gearText||'', abName:n.abName||'', abSkill:n.abSkill||'', pp:n.pp||0,
    notes:n.notes||'', tactics:n.tactics||'', quote:n.quote||''
  };
}

function canonFilePath(n){
  const region=(n.region||'ammaria').toLowerCase();
  const cat=(n.category||'NPC').toLowerCase();
  if(cat==='pregen'||cat==='pre-gen') return `${region}/${region}-pregens.json`;
  return `${region}/${region}-npcs.json`;
}

function openCommitModal(){
  if(!currentNPC)return;
  const inCanon=canonCommitted.has(currentNPC.name);
  const canon=buildCanonCharacter(currentNPC);
  const path=canonFilePath(currentNPC);
  const diffHtml=`<div><strong style="color:var(--accent)">${esc(currentNPC.name)}</strong> ‚Üí <code style="color:var(--text-dim)">${esc(path)}</code></div>
    <div style="margin-top:8px"><strong>Attributes:</strong> Agi d${canon.attrs.agility}, Sma d${canon.attrs.smarts}, Spi d${canon.attrs.spirit}, Str d${canon.attrs.strength}, Vig d${canon.attrs.vigor}</div>
    <div><strong>Skills:</strong> ${Object.entries(canon.skills).map(([k,v])=>k+' d'+v).join(', ')}</div>
    <div><strong>Edges:</strong> ${canon.edges.join(', ')||'None'}</div>
    <div><strong>Hindrances:</strong> ${canon.hindrances.join(', ')||'None'}</div>
    <div><strong>Powers:</strong> ${canon.powers.join(', ')||'None'}</div>
    <div><strong>Gear:</strong> ${canon.gearText||canon.gear.map(g=>typeof g==='string'?g:g.name).join(', ')||'None'}</div>`;
  document.getElementById('commitDiff').innerHTML=diffHtml;
  document.getElementById('commit_summary').value='';
  document.getElementById('commitStatus').innerHTML='';
  document.getElementById('commitBtn').disabled=false;
  document.getElementById('commitModalTitle').textContent=inCanon?'üîÑ Update Canon':'üì¶ Commit to Canon';
  document.getElementById('commitBtn').textContent=inCanon?'üîÑ Update Canon':'üîí Commit to Canon';
  document.getElementById('commitModal').classList.add('active');
}
function closeCommitModal(){document.getElementById('commitModal').classList.remove('active');}

async function executeCommit(){
  const confirmation=document.getElementById('commit_secret').value.trim();
  const summary=document.getElementById('commit_summary').value.trim();
  const statusEl=document.getElementById('commitStatus');
  if(confirmation!=='COMMIT'){statusEl.innerHTML='<span style="color:var(--red)">‚ùå Type COMMIT to confirm</span>';return;}
  if(!summary){statusEl.innerHTML='<span style="color:var(--red)">‚ùå Summary required</span>';return;}
  document.getElementById('commitBtn').disabled=true;
  statusEl.innerHTML='<span style="color:var(--accent)">‚è≥ Committing to canon...</span>';
  try{
    const canon=buildCanonCharacter(currentNPC);
    const res=await fetch(CANON_API,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        action:'commit_character',
        secret:'diceforge2026',
        character:canon,
        filePath:canonFilePath(currentNPC),
        summary:summary,
        author:'Character Vault'
      })
    });
    const data=await res.json();
    if(data.success){
      const products=Object.keys(data.affectedProducts||{});
      statusEl.innerHTML=`<span style="color:var(--green)">‚úÖ Committed as <strong>${esc(data.changeId)}</strong></span>
        <div style="margin-top:6px;font-size:12px;color:var(--text-dim)">Pending updates: ${products.filter(p=>p!==canonFilePath(currentNPC)).join(', ')||'None'}</div>`;
      canonCommitted.add(currentNPC.name);
      filterNPCs();updateHeaderStats();renderDetail();
      const s=JSON.parse(localStorage.getItem(LS_KEY)||'{}');
      if(s.overrides&&s.overrides[currentNPC.name]){delete s.overrides[currentNPC.name];localStorage.setItem(LS_KEY,JSON.stringify(s));}
    } else {
      statusEl.innerHTML=`<span style="color:var(--red)">‚ùå ${esc(data.error||'Commit failed')}</span>`;
      document.getElementById('commitBtn').disabled=false;
    }
  }catch(err){
    statusEl.innerHTML=`<span style="color:var(--red)">‚ùå Network error: ${esc(err.message)}</span>`;
    document.getElementById('commitBtn').disabled=false;
  }
}

// ‚îÄ‚îÄ REMOVE FROM CANON ‚îÄ‚îÄ
async function removeFromCanon(){
  if(!currentNPC||!canonCommitted.has(currentNPC.name))return;
  if(!confirm(`Remove ${currentNPC.name} from canon?\n\nThis will delete them from the canonical JSON and log the removal in the changelog.`))return;
  const summary=prompt('Removal reason:','Character removed from canon');
  if(!summary)return;
  try{
    const res=await fetch(CANON_API,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        action:'remove_character',
        secret:'diceforge2026',
        characterName:currentNPC.name,
        filePath:canonFilePath(currentNPC),
        region:currentNPC.region||'Ammaria',
        summary:summary,
        author:'Character Vault'
      })
    });
    const data=await res.json();
    if(data.success){
      canonCommitted.delete(currentNPC.name);
      filterNPCs();updateHeaderStats();renderDetail();
      alert(`${currentNPC.name} removed from canon (${data.changeId})`);
    } else {
      alert('Remove failed: '+(data.error||'Unknown error'));
    }
  }catch(err){
    alert('Network error: '+err.message);
  }
}

// ‚îÄ‚îÄ CHANGELOG VIEW ‚îÄ‚îÄ
function showChangelog(){document.getElementById('changelogModal').classList.add('active');loadChangelog();}
function closeChangelogModal(){document.getElementById('changelogModal').classList.remove('active');}

async function loadChangelog(){
  const el=document.getElementById('changelogContent');
  el.innerHTML='<span style="color:var(--accent)">‚è≥ Loading changelog...</span>';
  try{
    const res=await fetch(CANON_API,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'get_changelog',secret:'diceforge2026'})
    });
    const data=await res.json();
    const log=data.changelog||[];
    if(!log.length){el.innerHTML='<div style="color:var(--text-dim);padding:20px;text-align:center">No changes recorded yet. Commit a character correction to start the audit trail.</div>';return;}
    let html=`<div style="margin-bottom:10px;color:var(--text-dim);font-size:12px">${log.length} change${log.length===1?'':'s'} recorded</div>`;
    html+='<table class="data-table" style="font-size:13px"><tr><th>ID</th><th>Date</th><th>Character</th><th>Region</th><th>Summary</th><th>Products</th></tr>';
    log.slice().reverse().forEach(entry=>{
      const date=new Date(entry.timestamp).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
      const time=new Date(entry.timestamp).toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
      const products=Object.entries(entry.affectedProducts||{}).map(([p,applied])=>{
        const icon=applied?'‚úÖ':'‚è≥';
        const label=p.replace(/\.js$/,' (module)').replace(/\.json$/,' (canon)');
        return `<span title="${applied?'Applied: '+new Date(applied).toLocaleDateString('en-GB'):'Pending update'}">${icon} ${esc(label)}</span>`;
      }).join('<br>');
      const diffKeys=Object.keys(entry.diff||{}).filter(k=>k!=='added');
      const diffSummary=diffKeys.length?`<div style="font-size:11px;color:var(--text-dim);margin-top:4px">Changed: ${diffKeys.join(', ')}</div>`:'';
      html+=`<tr>
        <td style="color:var(--accent);white-space:nowrap;font-weight:bold">${esc(entry.id)}</td>
        <td style="white-space:nowrap">${date}<br><span style="color:var(--text-dim);font-size:11px">${time}</span></td>
        <td>${esc(entry.target)}</td>
        <td>${esc(entry.region)}</td>
        <td>${esc(entry.summary)}${diffSummary}</td>
        <td style="font-size:11px;line-height:1.8">${products}</td>
      </tr>`;
    });
    html+='</table>';
    el.innerHTML=html;
  }catch(err){
    el.innerHTML=`<span style="color:var(--red)">‚ùå Could not load changelog: ${esc(err.message)}</span>`;
  }
}

function checkPin(){
  var pin=document.getElementById('pinInput').value;
  if(pin==='54546-44-56456-7567-2345'){
    localStorage.setItem('diceforge_npcdb_auth',pin);
    DICEFORGE_AUTH=true;
    unlockApp();
  } else {
    document.getElementById('pinError').textContent='Invalid PIN';
    document.getElementById('pinInput').value='';
    document.getElementById('pinInput').focus();
  }
}

async function loadCanonStatus(){
  try{
    const res=await fetch(CANON_API,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'get_changelog',secret:'diceforge2026'})
    });
    const data=await res.json();
    const log=data.changelog||[];
    canonCommitted=new Set(log.map(e=>e.target));
    filterNPCs();updateHeaderStats();
    if(currentNPC)renderDetail();
  }catch(e){/* silent fail ‚Äî just means no canon icons */}
}

function unlockApp(){
  document.getElementById('mainContent').innerHTML='<span style="color:var(--text-dim)">Select an NPC or create a new one</span>';
  document.getElementById('mainContent').classList.add('empty-state');
  document.getElementById('sidebarInner').style.display='';
  loadData();filterNPCs();updateHeaderStats();loadCanonStatus();
}

document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('sidebarInner').style.display=DICEFORGE_AUTH?'':'none';
  if(DICEFORGE_AUTH){
    const check=setInterval(()=>{if(window.CharacterForge){clearInterval(check);unlockApp();}},50);
  } else {
    document.getElementById('pinInput').focus();
  }
});
</script>
</body>
</html>



