<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Walker Workshop — DiceForge Studios</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root{--bg-deep:#0E0C0A;--bg-dark:#141210;--bg-card:#1A1816;--bg-panel:#201E1A;--border:#3A3530;--border-light:#4A4540;--accent:#C4A44A;--accent-dim:#C4A44A40;--accent-glow:#C4A44A20;--text:#D4C8B0;--text-bright:#EDE4D4;--text-dim:#8A7A60;--green:#5A9A5A;--red:#8C3030;--red-bright:#B04040;--blue:#4A7A9A;--orange:#B07830}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;background:var(--bg-deep);color:var(--text);font-family:'Crimson Pro',Georgia,serif;font-size:15px;line-height:1.6}
.tool-nav{display:flex;gap:0;background:#141210;border-bottom:1px solid #3A3530;padding:0 12px;font-family:'Cinzel',serif}
.tool-nav-item{background:transparent;border:none;color:#8A7A60;padding:8px 16px;font-size:11px;letter-spacing:1.5px;cursor:pointer;font-family:'Cinzel',serif;text-transform:uppercase;transition:all .15s}
.tool-nav-item:hover{color:#D4C8B0}
.tool-nav-item.active{color:#C4A44A;border-bottom:2px solid #C4A44A}
.app{display:flex;height:calc(100vh - 38px);overflow:hidden}
.sidebar{width:340px;min-width:340px;background:var(--bg-dark);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.header{background:var(--bg-dark);border-bottom:1px solid var(--border);padding:14px 20px;display:flex;align-items:center;gap:16px}
.header-brand{font-family:'Cinzel',serif;font-size:11px;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase}
.header-title{font-family:'Cinzel',serif;font-size:18px;color:var(--accent);letter-spacing:2px}
.header-spacer{flex:1}
.header-btn{background:transparent;border:1px solid var(--border);color:var(--text-dim);padding:6px 14px;font-family:'Crimson Pro',serif;font-size:13px;cursor:pointer;transition:all .15s}
.header-btn:hover{border-color:var(--accent);color:var(--accent)}
.header-btn.primary{background:var(--accent);color:var(--bg-deep);border-color:var(--accent);font-weight:700}
.header-btn.primary:hover{background:#D4B45A}
.sidebar-header{padding:16px;border-bottom:1px solid var(--border)}
.sidebar-header h2{font-family:'Cinzel',serif;font-size:13px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;margin-bottom:8px}
.sidebar-section{padding:12px 16px;border-bottom:1px solid var(--border)}
.sidebar-section h3{font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px}
.field-row input[type="text"]{background:var(--bg-deep);border:1px solid var(--border);color:var(--text-bright);padding:5px 10px;font-family:'Crimson Pro',serif;font-size:14px;width:100%}
.field-row input[type="text"]:focus{outline:none;border-color:var(--accent)}
.size-picker{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.size-picker input[type="range"]{flex:1;accent-color:var(--accent);cursor:pointer}
.size-picker .size-val{font-family:'Cinzel',serif;font-size:24px;color:var(--accent);font-weight:700;min-width:36px;text-align:center}
.size-picker .size-class{font-size:12px;color:var(--text-dim);font-style:italic}
.frame-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px;margin-top:6px}
.frame-stat{background:var(--bg-deep);border:1px solid var(--border);padding:6px 8px;text-align:center}
.frame-stat .fs-label{font-size:9px;letter-spacing:1.5px;color:var(--text-dim);text-transform:uppercase;font-family:'Cinzel',serif}
.frame-stat .fs-value{font-size:14px;font-weight:700;color:var(--text-bright);margin-top:1px}
.frame-stat .fs-value.danger{color:var(--red-bright)}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.stat-box{background:var(--bg-deep);border:1px solid var(--border);padding:8px 10px;text-align:center}
.stat-box .stat-label{font-size:10px;letter-spacing:1.5px;color:var(--text-dim);text-transform:uppercase;font-family:'Cinzel',serif}
.stat-box .stat-value{font-size:16px;font-weight:700;color:var(--text-bright);margin-top:2px}
.stat-box .stat-value.danger{color:var(--red-bright)}
.mods-remaining{background:var(--bg-deep);border:1px solid var(--border);padding:10px;text-align:center;margin-top:8px}
.mods-remaining .big-num{font-size:28px;font-weight:700;font-family:'Cinzel',serif}
.mods-remaining .big-num.ok{color:var(--green)}.mods-remaining .big-num.low{color:var(--orange)}.mods-remaining .big-num.over{color:var(--red-bright)}
.mods-remaining .sub{font-size:11px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase}
.cost-display{background:var(--bg-deep);border:1px solid var(--accent-dim);padding:10px;text-align:center;margin-top:6px}
.cost-display .cost-val{font-size:18px;font-weight:700;color:var(--accent);font-family:'Cinzel',serif}
.cost-display .cost-label{font-size:10px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase}
.content{flex:1;overflow-y:auto;padding:20px}
.content::-webkit-scrollbar{width:6px}.content::-webkit-scrollbar-track{background:var(--bg-dark)}.content::-webkit-scrollbar-thumb{background:var(--border)}
.tab-bar{display:flex;gap:0;border-bottom:1px solid var(--border)}
.tab{padding:10px 20px;font-family:'Cinzel',serif;font-size:12px;letter-spacing:1.5px;color:var(--text-dim);cursor:pointer;border-bottom:2px solid transparent;text-transform:uppercase;transition:all .15s}
.tab:hover{color:var(--text)}.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.panel{display:none}.panel.active{display:block}
.dnd-layout{display:grid;grid-template-columns:1fr 1fr;gap:20px;min-height:400px}
.dnd-column h3{font-family:'Cinzel',serif;font-size:12px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;padding-bottom:8px;border-bottom:1px solid var(--border);margin-bottom:10px}
.drag-item{display:flex;align-items:center;gap:10px;padding:10px 12px;margin-bottom:5px;background:var(--bg-card);border:1px solid var(--border);cursor:grab;transition:transform .15s,box-shadow .15s,border-color .15s;user-select:none;touch-action:none;-webkit-user-select:none}
.drag-item:hover{border-color:var(--border-light)}.drag-item:active{cursor:grabbing}
.drag-item .drag-handle{color:var(--text-dim);font-size:14px;opacity:.4}
.drag-item .di-info{flex:1;min-width:0}.drag-item .di-name{font-weight:600;color:var(--text-bright);font-size:13px}
.drag-item .di-desc{font-size:11px;color:var(--text-dim);font-style:italic;line-height:1.3;margin-top:1px}
.drag-item .di-meta{text-align:right;min-width:55px}.drag-item .di-mods{font-weight:700;color:var(--accent);font-size:12px}
.drag-item .di-price{font-size:10px;color:var(--text-dim)}.drag-item.dragging{opacity:.5;transform:scale(.97)}
.drag-ghost{position:fixed;pointer-events:none;z-index:1000;padding:8px 14px;background:var(--bg-panel);border:1px solid var(--accent);box-shadow:0 8px 32px rgba(196,164,74,.3),0 0 12px rgba(196,164,74,.15);font-family:'Cinzel',serif;font-size:13px;color:var(--accent);letter-spacing:1px;white-space:nowrap}
.drag-ghost.near-target{box-shadow:0 12px 48px rgba(196,164,74,.5),0 0 20px rgba(196,164,74,.25);transform:scale(1.05)}
.drop-bay{min-height:120px;padding:8px;background:var(--bg-deep);border:2px dashed var(--border);transition:border-color .2s,background .2s,box-shadow .2s}
.drop-bay.drag-over{border-color:var(--accent);border-style:solid;background:var(--accent-glow);box-shadow:inset 0 0 30px rgba(196,164,74,.08)}
.drop-bay .empty-bay{text-align:center;padding:30px 16px;color:var(--text-dim);font-style:italic;font-size:13px}
.bay-item{display:flex;align-items:center;gap:8px;padding:8px 12px;margin-bottom:4px;background:var(--bg-card);border:1px solid var(--accent-dim)}
.bay-item .bi-info{flex:1}.bay-item .bi-name{font-weight:600;color:var(--accent);font-size:13px}
.bay-item .bi-detail{font-size:11px;color:var(--text-dim)}
.bay-item .bi-count{font-family:'Cinzel',serif;font-size:14px;color:var(--text-bright);font-weight:700;min-width:24px;text-align:center}
.bay-item .bi-controls{display:flex;gap:3px}
.bay-item .bi-controls button{width:24px;height:24px;background:var(--bg-deep);border:1px solid var(--border);color:var(--text-dim);font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:'Crimson Pro',serif;transition:all .1s}
.bay-item .bi-controls button:hover{border-color:var(--accent);color:var(--accent)}
.bay-item .bi-remove{background:transparent;border:none;color:var(--text-dim);cursor:pointer;font-size:13px;padding:2px 6px;margin-left:4px}
.bay-item .bi-remove:hover{color:var(--red-bright)}
@keyframes snapIn{0%{transform:translateY(-8px) scale(1.03);opacity:.6}40%{transform:translateY(2px) scale(.98);opacity:1}70%{transform:translateY(-1px) scale(1.005)}100%{transform:translateY(0) scale(1)}}
.bay-item.snap-in,.weapon-bay-item.snap-in{animation:snapIn .3s ease-out}
@keyframes impactFlash{0%{box-shadow:inset 0 0 20px rgba(196,164,74,.4)}100%{box-shadow:inset 0 0 0 rgba(196,164,74,0)}}
.drop-bay.impact{animation:impactFlash .35s ease-out}
.cat-header{font-family:'Cinzel',serif;font-size:11px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;padding:8px 0 4px;margin-top:8px}.cat-header:first-child{margin-top:0}
.weapon-drag-item{display:flex;align-items:center;gap:10px;padding:10px 12px;margin-bottom:5px;background:var(--bg-card);border:1px solid var(--border);cursor:grab;transition:transform .15s,box-shadow .15s,border-color .15s;user-select:none;touch-action:none;-webkit-user-select:none}
.weapon-drag-item:hover{border-color:var(--border-light)}.weapon-drag-item:active{cursor:grabbing}.weapon-drag-item.dragging{opacity:.5;transform:scale(.97)}
.weapon-drag-item .wdi-info{flex:1}.weapon-drag-item .wdi-name{font-weight:600;color:var(--text-bright);font-size:13px}
.weapon-drag-item .wdi-stats{font-size:11px;color:var(--text-dim)}
.weapon-drag-item .wdi-meta{text-align:right;min-width:55px}.weapon-drag-item .wdi-mods{font-weight:700;color:var(--accent);font-size:12px}
.weapon-drag-item .wdi-price{font-size:10px;color:var(--text-dim)}
.weapon-bay-item{display:flex;align-items:center;gap:8px;padding:10px 12px;margin-bottom:4px;background:var(--bg-card);border:1px solid var(--accent-dim)}
.weapon-bay-item .wbi-info{flex:1}.weapon-bay-item .wbi-name{font-weight:600;color:var(--accent);font-size:13px}
.weapon-bay-item .wbi-stats{font-size:11px;color:var(--text-dim)}
.weapon-bay-item .wbi-mount{font-size:10px;color:var(--text-dim);font-style:italic}
.weapon-bay-item .wbi-remove{background:transparent;border:none;color:var(--text-dim);cursor:pointer;font-size:13px;padding:2px 6px}
.weapon-bay-item .wbi-remove:hover{color:var(--red-bright)}
.mount-tabs{display:flex;gap:0;margin-bottom:10px}
.mount-tab{padding:6px 14px;font-family:'Cinzel',serif;font-size:11px;letter-spacing:1px;color:var(--text-dim);cursor:pointer;border:1px solid var(--border);background:transparent;text-transform:uppercase;transition:all .15s}
.mount-tab:first-child{border-radius:3px 0 0 3px}.mount-tab:last-child{border-radius:0 3px 3px 0}
.mount-tab:not(:first-child){border-left:none}
.mount-tab:hover{color:var(--text)}.mount-tab.active{background:var(--accent-glow);color:var(--accent);border-color:var(--accent)}
.stat-block{background:var(--bg-deep);border:1px solid var(--accent-dim);padding:24px;font-size:14px;line-height:1.8;max-width:700px}
.stat-block .sb-name{font-family:'Cinzel',serif;font-size:22px;color:var(--accent);letter-spacing:3px;text-align:center;margin-bottom:2px}
.stat-block .sb-type{text-align:center;color:var(--text-dim);font-style:italic;font-size:13px;margin-bottom:14px}
.stat-block .sb-divider{border:none;border-top:1px solid var(--accent-dim);margin:10px 0}
.stat-block .sb-line{margin-bottom:2px}.stat-block .sb-label{color:var(--accent);font-weight:700}
.stat-block .sb-notes{color:var(--text-dim);font-style:italic;margin-top:8px;font-size:13px;line-height:1.5}
.rules-ref{max-width:700px}.rules-ref h3{font-family:'Cinzel',serif;font-size:14px;color:var(--accent);letter-spacing:1.5px;margin:16px 0 8px}
.rules-ref h3:first-child{margin-top:0}.rules-ref p{margin-bottom:8px;font-size:14px;color:var(--text)}
.rules-ref .rule-key{color:var(--accent);font-weight:700}.rules-ref .rule-note{color:var(--text-dim);font-style:italic;font-size:13px}
.saved-list{display:flex;flex-direction:column;gap:4px}
.saved-item{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-card);border:1px solid var(--border);cursor:pointer;transition:all .15s}
.saved-item:hover{border-color:var(--accent)}
.saved-item .si-name{flex:1;font-weight:600;color:var(--text-bright);font-size:14px}
.saved-item .si-chassis{font-size:12px;color:var(--text-dim)}
.saved-item .si-delete{background:transparent;border:none;color:var(--text-dim);cursor:pointer;font-size:14px;padding:2px 6px}
.saved-item .si-delete:hover{color:var(--red-bright)}
.empty-state{text-align:center;padding:40px 20px;color:var(--text-dim)}.empty-state p{font-size:13px;font-style:italic}
.sidebar-footer{margin-top:auto;padding:10px 16px;border-top:1px solid var(--border);font-size:11px;color:var(--text-dim);text-align:center;font-style:italic}
</style>
</head>
<body>
<div id="toolNavContainer"></div>
<div class="app">
  <div class="sidebar">
    <div class="sidebar-header"><h2>Walker Workshop</h2><div class="field-row"><input type="text" id="walkerName" placeholder="Name your walker..." value="Untitled Walker"></div></div>
    <div class="sidebar-section"><h3>Size</h3>
      <div class="size-picker"><input type="range" id="sizeSlider" min="4" max="20" value="7" oninput="setSize(+this.value)"><div><div class="size-val" id="sizeVal">7</div><div class="size-class" id="sizeClass">Large</div></div></div>
      <div class="frame-stats" id="frameStats"></div>
    </div>
    <div class="sidebar-section"><h3>Current Stats</h3><div class="stats-grid" id="statsGrid"></div><div class="mods-remaining" id="modsRemaining"></div><div class="cost-display" id="costDisplay"></div></div>
    <div class="sidebar-section" style="flex:1;overflow-y:auto"><h3>Saved Walkers</h3><div class="saved-list" id="savedList"></div></div>
    <div class="sidebar-footer">Savage Worlds &copy; Pinnacle Entertainment Group. &copy; DiceForge Studios Ltd.</div>
  </div>
  <div class="main">
    <div class="header"><div><div class="header-brand">DiceForge Studios</div><div class="header-title">Walker Workshop</div></div><div class="header-spacer"></div><button class="header-btn" onclick="newWalker()">New</button><button class="header-btn" onclick="saveWalker()">Save</button><button class="header-btn primary" onclick="switchTab('output')">Export</button></div>
    <div class="tab-bar">
      <div class="tab active" data-tab="mods" onclick="switchTab('mods')">Modifications</div>
      <div class="tab" data-tab="weapons" onclick="switchTab('weapons')">Weapon Systems</div>
      <div class="tab" data-tab="output" onclick="switchTab('output')">Stat Block</div>
      <div class="tab" data-tab="rules" onclick="switchTab('rules')">Rules Reference</div>
    </div>
    <div class="content">
      <div class="panel active" id="panel-mods"><div class="dnd-layout"><div class="dnd-column"><h3>Available Modifications</h3><div id="modCatalogue"></div></div><div class="dnd-column"><h3>Installed Systems</h3><div class="drop-bay" id="modBay"><div class="empty-bay">Drag modifications here to install them</div></div></div></div></div>
      <div class="panel" id="panel-weapons"><div class="dnd-layout"><div class="dnd-column"><h3>Vehicular Weapons</h3><div id="weaponCatalogue"></div></div><div class="dnd-column"><h3>Weapon Hardpoints</h3><div class="mount-tabs"><div class="mount-tab active" data-mount="pintle" onclick="switchMount('pintle')">Pintle</div><div class="mount-tab" data-mount="fixed" onclick="switchMount('fixed')">Fixed (&frac12; Mods)</div><div class="mount-tab" data-mount="turret" onclick="switchMount('turret')">Turret (&times;2)</div></div><div class="drop-bay" id="weaponBay"><div class="empty-bay">Drag weapons here to mount them</div></div></div></div></div>
      <div class="panel" id="panel-output"></div>
      <div class="panel" id="panel-rules"><div class="rules-ref">
        <h3>Walker Overview</h3>
        <p>Walkers are giant humanoid combat vehicles piloted using the Piloting skill. Size 4+ mechs are walkers; Size 3 and below are power armour (see PA Forge). All walkers have Heavy Armor.</p>
        <p><span class="rule-key">Fighting:</span> Use the lower of the operator&rsquo;s Piloting or Fighting. Parry = 2 + half Piloting, modified by Handling. Walkers are always considered armed (Strength damage, HW).</p>
        <p><span class="rule-key">Running:</span> Requires a Piloting roll. Failure = Out of Control. Success = +1 Top Speed Rating this turn. Raise = +2.</p>
        <p><span class="rule-key">Strength:</span> d12+Size. Can lift its own weight max; each quarter carried costs &frac14; Top Speed and &minus;1 Handling.</p>
        <h3>Special Manoeuvres</h3>
        <p><span class="rule-key">Stomp:</span> Gargantuan walkers use a blast template (GM&rsquo;s call for size). Ignores Scale. Opposed Athletics vs Agility. Damage = walker&rsquo;s Strength. Smaller walkers stomp one target at least one Scale smaller.</p>
        <p><span class="rule-key">Death From Above:</span> Opposed Piloting. Success = Ram + d6 per Scale category exceeding target. Failure = miss + Out of Control (+ Wound on Crit Fail).</p>
        <p><span class="rule-key">Prone:</span> Fall prone as free action (Piloting roll; fail = Out of Control). Stand up requires Piloting; success halves remaining movement, raise retains full.</p>
        <h3>Damage</h3>
        <p><span class="rule-key">Critical Hits:</span> Called Shot to leg = Locomotion Crit (Speed Rating &minus;1). Called Shot to arm = System Crit. If a Crit strikes nothing left to destroy, reactor breach: Xd10 in 10" radius (X = max Wounds).</p>
        <p><span class="rule-key">Wrecked:</span> Evasion to eject, then 2d6+Size damage to occupants. Walker falls: 3d6+Size to anything beneath.</p>
        <h3>Weapon Mounts</h3>
        <p><span class="rule-key">Pintle:</span> Standard mount, full Mod cost, 180&deg; arc.</p>
        <p><span class="rule-key">Fixed:</span> 45&deg; arc only. Half Mod cost (round up).</p>
        <p><span class="rule-key">Turret:</span> 360&deg; arc. Double Mod cost.</p>
        <p><span class="rule-key">Carried Weapon:</span> Requires both arms. Pintle arc, Fixed Mod cost. Can be stored/readied as an action. +1 Mod for mount. If weapon Mods exceed walker Wounds: Snapfire.</p>
        <p><span class="rule-key">Linked:</span> Dual: +1 hit, +2 dmg. Quad: +2 hit, +4 dmg. Each additional linked weapon +1 Mod.</p>
        <p class="rule-note">References the Savage Worlds Sci-Fi Companion. Always defer to your physical rulebook.</p>
      </div></div>
    </div>
  </div>
</div>
<script>
// ═══ AUDIO ═══
var AudioEngine={ctx:null,
init:function(){if(!this.ctx)this.ctx=new(window.AudioContext||window.webkitAudioContext)();if(this.ctx.state==='suspended')this.ctx.resume()},
clunk:function(){this.init();var c=this.ctx;if(c.state==='suspended')c.resume();var n=c.currentTime;var buf=c.createBuffer(1,c.sampleRate*.02,c.sampleRate);var d=buf.getChannelData(0);for(var i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/d.length,12);var ns=c.createBufferSource();ns.buffer=buf;var bp=c.createBiquadFilter();bp.type='bandpass';bp.frequency.value=4200;bp.Q.value=2;var o1=c.createOscillator();o1.type='sine';o1.frequency.value=820;var g1=c.createGain();g1.gain.setValueAtTime(.06,n);g1.gain.exponentialRampToValueAtTime(.001,n+.06);var o2=c.createOscillator();o2.type='sine';o2.frequency.value=2200;var g2=c.createGain();g2.gain.setValueAtTime(.02,n);g2.gain.exponentialRampToValueAtTime(.001,n+.03);var m=c.createGain();m.gain.value=.3;ns.connect(bp).connect(m);o1.connect(g1).connect(m);o2.connect(g2).connect(m);m.connect(c.destination);ns.start(n);ns.stop(n+.02);o1.start(n);o1.stop(n+.08);o2.start(n);o2.stop(n+.05)},
click:function(){this.init();var c=this.ctx;if(c.state==='suspended')c.resume();var n=c.currentTime;var o=c.createOscillator();o.type='sine';o.frequency.value=600;var g=c.createGain();g.gain.setValueAtTime(.08,n);g.gain.exponentialRampToValueAtTime(.001,n+.04);o.connect(g).connect(c.destination);o.start(n);o.stop(n+.05)},
remove:function(){this.init();var c=this.ctx;if(c.state==='suspended')c.resume();var n=c.currentTime;var o=c.createOscillator();o.type='triangle';o.frequency.setValueAtTime(500,n);o.frequency.exponentialRampToValueAtTime(200,n+.1);var g=c.createGain();g.gain.setValueAtTime(.1,n);g.gain.exponentialRampToValueAtTime(.001,n+.12);o.connect(g).connect(c.destination);o.start(n);o.stop(n+.15)}};

// ═══ CANONICAL SFC DATA ═══
// Walker Frames (SFC p182)
// Large (4-7): Hand 0, Top Speed 8, Tough 15 (max Armor 20), Wounds 4, Str d12+Size, Energy 5, Mods Size×3, Cost $250K×Size
// Huge (8-11): Hand -1, Top Speed 6, Tough 20 (max Armor 30), Wounds 5, Str d12+Size, Energy 5, Mods Size×3, Cost $500K×Size
// Gargantuan (12-20): Hand -2, Top Speed 4, Tough 25 (max Armor 40), Wounds 6, Str d12+Size, Energy 5, Mods Size×4, Cost $1M×Size
function getCategory(sz){if(sz<=7)return{cat:'Large',hand:0,topSpeed:8,baseTough:15,maxArmor:20,wounds:4,energy:5,modMult:3,costMult:250000};if(sz<=11)return{cat:'Huge',hand:-1,topSpeed:6,baseTough:20,maxArmor:30,wounds:5,energy:5,modMult:3,costMult:500000};return{cat:'Gargantuan',hand:-2,topSpeed:4,baseTough:25,maxArmor:40,wounds:6,energy:5,modMult:4,costMult:1000000}}
function getBaseFrame(sz){var c=getCategory(sz);return{size:sz,cat:c.cat,hand:c.hand,topSpeed:c.topSpeed,baseTough:c.baseTough,baseArmor:c.baseTough,maxArmor:c.maxArmor,wounds:c.wounds,str:'d12+'+sz,energy:c.energy,baseMods:sz*c.modMult,cost:c.costMult*sz}}

// Speed Rating table (SFC p180)
var SPEED_TABLE={1:4,2:8,3:16,4:25,5:40,6:60,7:80,8:100,9:120,10:160,11:200,12:250,13:400,14:600,15:800};
function speedToMPH(r){return SPEED_TABLE[r]||(r>15?r*50+'?':'?')}

// Height/Weight lookup (SFC p182)
var HW_TABLE={4:{h:"12'",w:'2 tons'},5:{h:"15'",w:'5 tons'},6:{h:"18'",w:'10 tons'},7:{h:"24'",w:'15 tons'},8:{h:"30'",w:'40 tons'},9:{h:"36'",w:'65 tons'},10:{h:"50'",w:'120 tons'},11:{h:"63'",w:'250 tons'},12:{h:"75'",w:'500 tons'},13:{h:"100'",w:'1K tons'},14:{h:"125'",w:'2K tons'},15:{h:"150'",w:'4K tons'},16:{h:"200'",w:'8K tons'},17:{h:"250'",w:'16K tons'},18:{h:"300'",w:'32K tons'},19:{h:"400'",w:'64K tons'},20:{h:"500'",w:'125K tons'}};

// Walker Modifications (SFC pp183-186) — canonical data
var MODS=[
  // NEGATIVE QUALITIES
  {id:'battered',name:'Battered',cat:'Negative Qualities',max:2,modsCost:-2,costFn:function(s){return -10000*s},desc:'Reduce base Toughness by 2.'},
  {id:'drone',name:'Drone',cat:'Negative Qualities',max:1,modsCost:-2,costFn:function(s){return -5000*s},desc:'No pilot/crew/life support. Requires Remote Control or AI.'},
  {id:'exposed',name:'Exposed Crew',cat:'Negative Qualities',max:1,modsCost:-2,costFn:function(s){return -10000*s},desc:'Pilot targetable, no Armor bonus on Crew Crit Hit.'},
  {id:'feedback',name:'Feedback',cat:'Negative Qualities',max:1,modsCost:-2,costFn:function(s){return -10000*s},desc:'Pilot Shaken when walker takes a Wound.'},
  {id:'finicky',name:'Finicky',cat:'Negative Qualities',max:2,modsCost:-2,costFn:function(s){return -10000*s},desc:'Repair at -2 (-4 if taken twice).'},
  {id:'fragile',name:'Fragile',cat:'Negative Qualities',max:2,modsCost:-2,costFn:function(s){return -10000*s},desc:'Reduce Wounds by 1.'},
  {id:'inefficient',name:'Inefficient',cat:'Negative Qualities',max:1,modsCost:-2,costFn:function(s){return -10000*s},desc:'Double fuel use per day.'},
  {id:'manual',name:'Manual',cat:'Negative Qualities',max:1,modsCost:-2,costFn:function(s){return -10000*s},desc:'No electronics/automated systems. No electronic Mods.'},
  {id:'no_hands',name:'No Hands',cat:'Negative Qualities',max:1,modsCost:-2,costFn:function(s){return -5000*s},desc:'Cannot grapple, pick up, or use carried weapons.'},
  {id:'reduced_hand',name:'Reduced Handling',cat:'Negative Qualities',max:6,modsCost:-2,costFn:function(s){return -10000*s},desc:'-1 Handling (max -6 total).'},
  {id:'reduced_speed',name:'Reduced Speed',cat:'Negative Qualities',max:3,modsCost:-2,costFn:function(s){return -10000*s},desc:'-1 Speed Rating. Cannot combine with Increased Speed.'},
  {id:'reduced_str',name:'Reduced Strength',cat:'Negative Qualities',max:4,modsCost:-2,costFn:function(s){return -5000*s},desc:'-1 die type Strength.'},
  {id:'rough_ride',name:'Rough Ride',cat:'Negative Qualities',max:1,modsCost:-2,costFn:function(s){return -10000*s},desc:'Unstable Platform penalty is -4 instead of -2.'},
  {id:'tandem',name:'Tandem Pilots',cat:'Negative Qualities',max:1,modsCost:-2,costFn:function(s){return -10000*s},desc:'Two pilots required, use lower Piloting.'},
  {id:'unsafe',name:'Unsafe',cat:'Negative Qualities',max:1,modsCost:-2,costFn:function(s){return -10000*s},desc:'No safety measures. Full collision damage. Eject at -2.'},
  // CORE SYSTEMS
  {id:'ai',name:'Artificial Intelligence',cat:'Core Systems',max:3,modsCost:1,costFn:function(s){return 5000*s},desc:'AI acts as ally: d6 skill + Wild Die. 2nd: d10. 3rd: ignore 2 MAP.'},
  {id:'command',name:'Command Suite',cat:'Core Systems',max:1,modsCost:1,costFn:function(){return 10000},desc:'See/hear through linked allies. Extend Command Range.'},
  {id:'crew_seat',name:'Crew Seating',cat:'Core Systems',max:2,modsCost:2,costFn:function(){return 10000},desc:'1st: +1 seat. 2nd: +3 more seats (5 total crew).'},
  {id:'enhanced_sensor',name:'Enhanced Sensors',cat:'Core Systems',max:1,modsCost:1,costFn:function(){return 50000},desc:'+2 Surprise and Notice. 100× optics.'},
  {id:'entangled',name:'Entangled Comms',cat:'Core Systems',max:'U',modsCost:1,costFn:function(){return 50000},desc:'Quantum comms. Unlimited range, unjammable.'},
  {id:'inc_str',name:'Increased Strength',cat:'Core Systems',max:5,modsCost:2,costFn:function(s){return 5000*s},desc:'+1 die type Strength.'},
  {id:'scanner',name:'Scanner',cat:'Core Systems',max:2,modsCost:1,costFn:function(s,ct){return ct>=2?5000:500},desc:'Detect 50yds (+2 Notice). 2nd: 500yds, +1 Mod, $5K.'},
  {id:'sensor_array',name:'Sensor Array',cat:'Core Systems',max:1,modsCost:4,costFn:function(){return 25000},desc:'Scan 1 light-year / LOS. Full round, Vulnerable.'},
  {id:'var_form',name:'Variable Form',cat:'Core Systems',max:1,modsCost:'half',costFn:function(){return 100000},desc:'Transform into vehicle (up to ±2 Size). Action to transform.'},
  // DEFENSIVE SYSTEMS
  {id:'amecm',name:'AM/ECM',cat:'Defensive Systems',max:1,modsCost:1,costFn:function(s){return 5000*s},desc:'+2 Evasion vs Guided Weapons.'},
  {id:'anti_tp',name:'Anti-Teleportation Tech',cat:'Defensive Systems',max:1,modsCost:4,costFn:function(s){return 10000*s},desc:'Prevent teleportation into/onto walker.'},
  {id:'arm_shield',name:'Arm Shield',cat:'Defensive Systems',max:1,modsCost:'half',costFn:function(s){return 10000*s},desc:'+2 Parry, -2 Cover. Hardness 20, +10 Heavy Armor. Uses one arm.'},
  {id:'armor',name:'Armor',cat:'Defensive Systems',max:'frame',modsCost:1,costFn:function(s){return 5000*s},desc:'+2 Armor per application (up to frame max). Heavy Armor.'},
  {id:'emp_shield',name:'EMP Shielding',cat:'Defensive Systems',max:1,modsCost:2,costFn:function(s){return 5000*s},desc:'Ignore 2 of -4 EMP penalty.'},
  {id:'repair_drone',name:'Repair Drones',cat:'Defensive Systems',max:1,modsCost:'half',costFn:function(s){return 25000*s},desc:'Drones attempt Repair. Crit Fail = can\'t retry that repair.'},
  {id:'repair_nano',name:'Repair Nanomachines',cat:'Defensive Systems',max:1,modsCost:3,costFn:function(s){return 50000*s},desc:'Repair as limited action. 3 Wounds max per 24hrs.'},
  {id:'shields',name:'Shields',cat:'Defensive Systems',max:1,modsCost:'half',costFn:function(s){return 50000*s},desc:'Charges = half base Wounds. Soak with Electronics.'},
  {id:'sloped',name:'Sloped Armor',cat:'Defensive Systems',max:1,modsCost:'half',costFn:function(s){return 5000*s},desc:'-2 enemy Shooting (direct-fire energy/kinetic only).'},
  {id:'stealth',name:'Stealth System',cat:'Defensive Systems',max:1,modsCost:'size',costFn:function(s){return 50000*s},desc:'-4 to lock on with Electronics. Dev II: -2/-4 to attack.'},
  {id:'toughness',name:'Toughness',cat:'Defensive Systems',max:5,modsCost:1,costFn:function(s){return 5000*s},desc:'+1 Toughness.'},
  // LOCOMOTION
  {id:'amphibious',name:'Amphibious',cat:'Locomotion',max:2,modsCost:1,costFn:function(s){return 1000*s},desc:'Enter water. Hand -1, Speed 2. 2nd: Speed 3.'},
  {id:'energy_pod',name:'Energy Pod',cat:'Locomotion',max:'U',modsCost:'half',costFn:function(s){return 5000*s},desc:'Double Energy capacity.'},
  {id:'handling',name:'Handling',cat:'Locomotion',max:2,modsCost:'half',costFn:function(s){return 10000*s},desc:'+1 Handling (max +4).'},
  {id:'inc_speed',name:'Increased Speed',cat:'Locomotion',max:'U',modsCost:'half',costFn:function(s){return 10000*s},desc:'+1 Speed Rating. Cannot combine with Reduced Speed.'},
  {id:'jump_jets',name:'Jump Jets',cat:'Locomotion',max:1,modsCost:'half',costFn:function(s){return 10000*s},desc:'Leap movement horiz / half vert. Death From Above. Clash reroll.'},
  {id:'quadruped',name:'Quadruped',cat:'Locomotion',max:1,modsCost:2,costFn:function(){return 10000},desc:'Four-legged. Reroll failed Piloting vs Out of Control.'},
  {id:'thrusters',name:'Thrusters',cat:'Locomotion',max:1,modsCost:'half',costFn:function(s){return 25000*s},desc:'Fly at Speed Rating 8 (100 MPH). Speed improvements apply.'},
  // OFFENSIVE SYSTEMS
  {id:'arm_blade',name:'Arm Blade',cat:'Offensive Systems',max:1,modsCost:2,costFn:function(){return 50000},desc:'Str+d12, AP 6, HW. Uses one arm.'},
  {id:'carried_wp',name:'Carried Weapon',cat:'Offensive Systems',max:1,modsCost:0,costFn:function(){return 10000},desc:'Oversized rifle. Both arms. Pintle arc, Fixed Mod cost. +1 Mod for mount.'},
  {id:'energy_blade',name:'Energy Blade',cat:'Offensive Systems',max:1,modsCost:2,costFn:function(){return 100000},desc:'Str+d12, AP 12, HW. Uses one arm.'},
  {id:'extra_limbs',name:'Extra Appendages',cat:'Offensive Systems',max:3,modsCost:1,costFn:function(){return 10000},desc:'+1 set limbs. +1 Gang Up vs single foe.'},
  {id:'remote',name:'Remote Control',cat:'Offensive Systems',max:1,modsCost:1,costFn:function(){return 10000},desc:'Operate from afar with Electronics -2.'},
  {id:'stabilizer',name:'Stabilizer',cat:'Offensive Systems',max:1,modsCost:1,costFn:function(){return 5000},desc:'Negate Unstable Platform and running penalties.'},
  {id:'targeting',name:'Targeting System',cat:'Offensive Systems',max:1,modsCost:1,costFn:function(){return 25000},desc:'-2 Shooting penalties (Called Shot, Cover, Range, Scale, Speed).'}
];
// Vehicular Weapons (SFC pp58-64) — Min Size determines mounting eligibility
var WEAPONS=[
  {id:'slug_light',name:'Light Slugthrower',cat:'Slugthrowers',range:'30/60/120',damage:'2d8',ap:2,rof:3,shots:200,minSize:1,mods:1,cost:700,notes:'Pt Def, Rxn Fire, not HW'},
  {id:'slug_med',name:'Medium Slugthrower',cat:'Slugthrowers',range:'30/60/120',damage:'2d8+1',ap:2,rof:3,shots:100,minSize:2,mods:1,cost:1000,notes:'Pt Def, Rxn Fire, not HW'},
  {id:'slug_heavy',name:'Heavy Slugthrower',cat:'Slugthrowers',range:'50/100/200',damage:'2d10 (I)',ap:4,rof:3,shots:50,minSize:3,mods:1,cost:2000,notes:'Pt Def, Rxn Fire'},
  {id:'minigun',name:'Minigun',cat:'Slugthrowers',range:'50/100/200',damage:'2d8+1 (I)',ap:2,rof:5,shots:2000,minSize:3,mods:1,cost:10000,notes:'Min RoF 3, Pt Def, Rxn Fire'},
  {id:'ac_light',name:'Light Autocannon',cat:'Autocannons',range:'50/100/200',damage:'3d8 (I)',ap:4,rof:4,shots:100,minSize:2,mods:1,cost:10000,notes:'Min RoF 2, Pt Def, Rxn Fire'},
  {id:'ac_med',name:'Medium Autocannon',cat:'Autocannons',range:'50/100/200',damage:'4d8 (II)',ap:6,rof:4,shots:80,minSize:8,mods:2,cost:20000,notes:'Min RoF 2'},
  {id:'ac_heavy',name:'Heavy Autocannon',cat:'Autocannons',range:'75/150/300',damage:'5d8 (III)',ap:8,rof:4,shots:60,minSize:12,mods:3,cost:50000,notes:'Min RoF 2'},
  {id:'cannon_light',name:'Light Cannon',cat:'Cannons',range:'50/100/200',damage:'3d10 (II)',ap:5,rof:1,shots:80,minSize:1,mods:1,cost:15000,notes:'Rxn Fire, SBT'},
  {id:'cannon_med',name:'Medium Cannon',cat:'Cannons',range:'75/150/300',damage:'4d10 (III)',ap:10,rof:1,shots:60,minSize:2,mods:3,cost:30000,notes:'SBT'},
  {id:'cannon_heavy',name:'Heavy Cannon',cat:'Cannons',range:'100/200/400',damage:'5d10 (IV)',ap:20,rof:1,shots:40,minSize:4,mods:5,cost:60000,notes:'SBT'},
  {id:'cannon_super',name:'Super Cannon',cat:'Cannons',range:'150/300/600',damage:'6d10 (VI)',ap:30,rof:1,shots:20,minSize:10,mods:6,cost:100000,notes:'MBT'},
  {id:'cannon_sheavy',name:'Super Heavy Cannon',cat:'Cannons',range:'150/300/600',damage:'8d10 (VII)',ap:40,rof:1,shots:10,minSize:16,mods:8,cost:500000,notes:'MBT'},
  {id:'laser_gat',name:'Gatling Laser',cat:'Lasers',range:'50/100/200',damage:'3d6+4 (I)',ap:4,rof:4,shots:80,minSize:1,mods:1,cost:3000,notes:'Cauterize, Overcharge, Pt Def, Rxn Fire'},
  {id:'laser_light',name:'Light Laser',cat:'Lasers',range:'150/300/600',damage:'2d10 (II)',ap:10,rof:3,shots:80,minSize:2,mods:1,cost:20000,notes:'Cauterize, Overcharge, Rxn Fire'},
  {id:'laser_med',name:'Medium Laser',cat:'Lasers',range:'150/300/600',damage:'3d10 (III)',ap:20,rof:2,shots:60,minSize:4,mods:3,cost:50000,notes:'Cauterize, Overcharge'},
  {id:'laser_heavy',name:'Heavy Laser',cat:'Lasers',range:'150/300/600',damage:'4d10 (V)',ap:30,rof:1,shots:40,minSize:8,mods:5,cost:200000,notes:'Cauterize, Overcharge'},
  {id:'laser_super',name:'Super Laser',cat:'Lasers',range:'150/300/600',damage:'5d10 (V)',ap:30,rof:1,shots:20,minSize:12,mods:8,cost:300000,notes:'Cauterize, Overcharge'},
  {id:'grenade',name:'Grenade Launcher',cat:'Launchers',range:'24/48/96',damage:'3d6 (I)',ap:0,rof:3,shots:12,minSize:0,mods:1,cost:2600,notes:'MBT'},
  {id:'missile_rack',name:'Missile Launcher',cat:'Launchers',range:'—',damage:'—',ap:0,rof:0,shots:0,minSize:2,mods:1,cost:1000,notes:'Rack only. Load missiles separately.'},
  {id:'missile_light',name:'Light Missiles (×8)',cat:'Launchers',range:'100/200/400',damage:'6d6 (III)',ap:16,rof:4,shots:8,minSize:2,mods:0,cost:4000,notes:'Guided, SBT (requires launcher)'},
  {id:'missile_med',name:'Medium Missiles (×4)',cat:'Launchers',range:'150/300/600',damage:'7d6 (IV)',ap:24,rof:2,shots:4,minSize:2,mods:0,cost:10000,notes:'Guided, MBT (requires launcher)'},
  {id:'missile_heavy',name:'Heavy Missiles (×2)',cat:'Launchers',range:'200/400/800',damage:'8d6 (V)',ap:32,rof:1,shots:2,minSize:2,mods:0,cost:20000,notes:'Guided, LBT (requires launcher)'},
  {id:'flamer',name:'Heavy Flamethrower',cat:'Flamethrowers',range:'Cone',damage:'3d12 (I)',ap:0,rof:1,shots:30,minSize:1,mods:1,cost:5000,notes:'Cauterize, Incendiary, Cone/MBT 18"'},
  {id:'md_light',name:'Light Mass Driver',cat:'Mass Drivers',range:'100/200/400',damage:'2d12+2 (I)',ap:5,rof:3,shots:100,minSize:2,mods:2,cost:10000,notes:'Pt Def, Rxn Fire, SBT'},
  {id:'md_med',name:'Medium Mass Driver',cat:'Mass Drivers',range:'100/200/400',damage:'3d12+3 (II)',ap:5,rof:2,shots:80,minSize:4,mods:3,cost:20000,notes:'MBT'},
  {id:'pc_light',name:'Light Particle Cannon',cat:'Particle Cannons',range:'100/200/400',damage:'4d6+4 (II)',ap:5,rof:3,shots:90,minSize:2,mods:2,cost:25000,notes:'Pt Def, Rxn Fire'},
  {id:'pc_med',name:'Medium Particle Cannon',cat:'Particle Cannons',range:'100/200/400',damage:'6d6+6 (III)',ap:10,rof:3,shots:60,minSize:8,mods:4,cost:50000,notes:''},
];

// ═══ STATE ═══
var state={name:'Untitled Walker',size:7,mods:{},weapons:[],currentMount:'pintle',savedWalkers:[]};
var dragState={active:false,type:null,id:null,ghost:null};

// ═══ DRAG-DROP (same as PA Forge) ═══
function getXY(e){if(e.touches&&e.touches.length)return{x:e.touches[0].clientX,y:e.touches[0].clientY};if(e.changedTouches&&e.changedTouches.length)return{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY};return{x:e.clientX,y:e.clientY}}
function startDrag(e,type,id,label){e.preventDefault();AudioEngine.init();var pt=getXY(e);dragState={active:true,type:type,id:id,ghost:null};var ghost=document.createElement('div');ghost.className='drag-ghost';ghost.textContent=label;ghost.style.left=pt.x+'px';ghost.style.top=pt.y+'px';document.body.appendChild(ghost);dragState.ghost=ghost;var src=e.target.closest('.drag-item')||e.target.closest('.weapon-drag-item');if(src)src.classList.add('dragging');document.addEventListener('mousemove',onDragMove);document.addEventListener('mouseup',onDragEnd);document.addEventListener('touchmove',onDragMove,{passive:false});document.addEventListener('touchend',onDragEnd);document.addEventListener('touchcancel',onDragEnd)}
function onDragMove(e){if(!dragState.active||!dragState.ghost)return;if(e.cancelable)e.preventDefault();var pt=getXY(e);var bayId=dragState.type==='mod'?'modBay':'weaponBay';var bay=document.getElementById(bayId);var gx=pt.x,gy=pt.y;if(bay){var r=bay.getBoundingClientRect();var inside=gx>=r.left&&gx<=r.right&&gy>=r.top&&gy<=r.bottom;var near=gx>=r.left-80&&gx<=r.right+80&&gy>=r.top-80&&gy<=r.bottom+80;bay.classList.toggle('drag-over',inside);dragState.ghost.classList.toggle('near-target',near&&!inside);if(near&&!inside){gx+=(r.left+r.width/2-gx)*.08;gy+=(r.top+r.height/2-gy)*.08}}dragState.ghost.style.left=gx+'px';dragState.ghost.style.top=gy+'px'}
function onDragEnd(e){document.removeEventListener('mousemove',onDragMove);document.removeEventListener('mouseup',onDragEnd);document.removeEventListener('touchmove',onDragMove);document.removeEventListener('touchend',onDragEnd);document.removeEventListener('touchcancel',onDragEnd);if(dragState.ghost)dragState.ghost.remove();document.querySelectorAll('.dragging').forEach(function(el){el.classList.remove('dragging')});var pt=getXY(e);var bayId=dragState.type==='mod'?'modBay':'weaponBay';var bay=document.getElementById(bayId);if(bay){var r=bay.getBoundingClientRect();if(pt.x>=r.left&&pt.x<=r.right&&pt.y>=r.top&&pt.y<=r.bottom){if(dragState.type==='mod')dropMod(dragState.id);else if(dragState.type==='weapon')dropWeapon(dragState.id);bay.classList.remove('impact');void bay.offsetWidth;bay.classList.add('impact')}bay.classList.remove('drag-over')}dragState={active:false,type:null,id:null,ghost:null}}

function dropMod(id){var m=MODS.find(function(x){return x.id===id});var max=m.max==='U'?99:m.max==='frame'?getMaxArmorTakes():m.max;var cur=state.mods[id]||0;
  if(id==='inc_speed'&&(state.mods['reduced_speed']||0)>0)return;
  if(id==='reduced_speed'&&(state.mods['inc_speed']||0)>0)return;
  if(id==='inc_str'&&(state.mods['reduced_str']||0)>0)return;
  if(id==='reduced_str'&&(state.mods['inc_str']||0)>0)return;
  if(id==='reduced_hand'&&(state.mods['handling']||0)>0)return;
  if(id==='handling'&&(state.mods['reduced_hand']||0)>0)return;
  if(cur<max){state.mods[id]=cur+1;AudioEngine.clunk();renderModBay(id);renderStats();renderOutput()}}
function dropWeapon(id){var w=WEAPONS.find(function(x){return x.id===id});if(w.minSize>state.size)return;
  state.weapons.push({weaponId:id,mount:state.currentMount});AudioEngine.clunk();renderWeaponBay(id);renderStats();renderOutput()}
function getMaxArmorTakes(){var f=getBaseFrame(state.size);return Math.floor((f.maxArmor-f.baseTough)/2)}
// ═══ CALCULATIONS ═══
function getModCost(m,sz){if(m.modsCost==='half')return Math.ceil(sz/2);if(m.modsCost==='size')return sz;return m.modsCost}
function getWeaponModCost(w,mount){var mc=w.mods;if(mount==='fixed')mc=Math.ceil(mc/2);else if(mount==='turret')mc=mc*2;return mc}
function calcModsUsed(){var t=0;for(var id in state.mods){var m=MODS.find(function(x){return x.id===id});var mc=getModCost(m,state.size);if(mc>0)t+=mc*state.mods[id]}
  state.weapons.forEach(function(w){var wp=WEAPONS.find(function(x){return x.id===w.weaponId});if(wp)t+=getWeaponModCost(wp,w.mount)});return t}
function calcModsGained(){var t=0;for(var id in state.mods){var m=MODS.find(function(x){return x.id===id});var mc=getModCost(m,state.size);if(mc<0)t+=Math.abs(mc)*state.mods[id]}return t}
function calcTough(){var f=getBaseFrame(state.size),t=f.baseTough;if(state.mods['battered'])t-=2*state.mods['battered'];if(state.mods['toughness'])t+=state.mods['toughness'];return Math.max(0,t)}
function calcArmor(){var f=getBaseFrame(state.size),a=f.baseArmor;if(state.mods['armor'])a+=2*state.mods['armor'];return Math.min(a,f.maxArmor)}
function calcWounds(){var f=getBaseFrame(state.size),w=f.wounds;if(state.mods['fragile'])w-=state.mods['fragile'];return Math.max(1,w)}
function calcHand(){var f=getBaseFrame(state.size),h=f.hand;if(state.mods['handling'])h+=state.mods['handling'];if(state.mods['reduced_hand'])h-=state.mods['reduced_hand'];return h}
function calcTopSpeed(){var f=getBaseFrame(state.size),s=f.topSpeed;if(state.mods['inc_speed'])s+=state.mods['inc_speed'];if(state.mods['reduced_speed'])s-=state.mods['reduced_speed'];return Math.max(1,s)}
function calcStr(){var f=getBaseFrame(state.size);var steps=['d4','d6','d8','d10','d12','d12+1','d12+2','d12+3','d12+4','d12+5','d12+6','d12+7','d12+8','d12+9','d12+10','d12+11','d12+12','d12+13','d12+14','d12+15','d12+16','d12+17','d12+18','d12+19','d12+20'];
  var baseIdx=steps.indexOf(f.str);var boost=state.mods['inc_str']||0;var penalty=state.mods['reduced_str']||0;return steps[Math.max(0,Math.min(baseIdx+boost-penalty,steps.length-1))];}
function calcCost(){var f=getBaseFrame(state.size),cost=f.cost;
  for(var id in state.mods){var m=MODS.find(function(x){return x.id===id});var ct=state.mods[id];cost+=m.costFn(state.size,ct)*ct}
  state.weapons.forEach(function(w){var wp=WEAPONS.find(function(x){return x.id===w.weaponId});if(wp)cost+=wp.cost});return cost}

// ═══ INIT & RENDER ═══
function init(){loadSaved();renderFrameStats();renderModCatalogue();renderModBay();renderWeaponCatalogue();renderWeaponBay();renderStats();renderSaved();renderOutput();
  document.getElementById('walkerName').addEventListener('input',function(e){state.name=e.target.value||'Untitled Walker'})}

function setSize(sz){state.size=sz;state.mods={};state.weapons=[];
  document.getElementById('sizeVal').textContent=sz;document.getElementById('sizeClass').textContent=getCategory(sz).cat;
  renderFrameStats();renderModCatalogue();renderModBay();renderWeaponCatalogue();renderWeaponBay();renderStats();renderOutput()}

function renderFrameStats(){var f=getBaseFrame(state.size),hw=HW_TABLE[state.size]||{h:'?',w:'?'};
  document.getElementById('sizeVal').textContent=state.size;document.getElementById('sizeClass').textContent=f.cat;
  document.getElementById('frameStats').innerHTML=
    '<div class="frame-stat"><div class="fs-label">Height</div><div class="fs-value">'+hw.h+'</div></div>'
    +'<div class="frame-stat"><div class="fs-label">Weight</div><div class="fs-value">'+hw.w+'</div></div>'
    +'<div class="frame-stat"><div class="fs-label">Base Cost</div><div class="fs-value">$'+fmtC(f.cost)+'</div></div>'
    +'<div class="frame-stat"><div class="fs-label">Base Tough</div><div class="fs-value">'+f.baseTough+' ('+f.maxArmor+')</div></div>'
    +'<div class="frame-stat"><div class="fs-label">Base Str</div><div class="fs-value">'+f.str+'</div></div>'
    +'<div class="frame-stat"><div class="fs-label">Base Mods</div><div class="fs-value">'+f.baseMods+'</div></div>'}

function renderModCatalogue(){var el=document.getElementById('modCatalogue'),cats={};
  MODS.forEach(function(m){if(!cats[m.cat])cats[m.cat]=[];cats[m.cat].push(m)});
  var h='';for(var cat in cats){h+='<div class="cat-header">'+cat+'</div>';
    cats[cat].forEach(function(m){var mc=getModCost(m,state.size);var price=m.costFn(state.size,1);
      h+='<div class="drag-item" onmousedown="startDrag(event,\'mod\',\''+m.id+'\',\''+m.name+'\')" ontouchstart="startDrag(event,\'mod\',\''+m.id+'\',\''+m.name+'\')">'
        +'<span class="drag-handle">&#x2807;</span>'
        +'<div class="di-info"><div class="di-name">'+m.name+'</div><div class="di-desc">'+m.desc+'</div></div>'
        +'<div class="di-meta"><div class="di-mods">'+(mc>0?mc+' mod'+(mc>1?'s':''):mc<0?'+'+Math.abs(mc)+' mod'+(Math.abs(mc)>1?'s':''):'&mdash;')+'</div>'
        +'<div class="di-price">'+(price>=0?'$'+fmtN(price):'-$'+fmtN(Math.abs(price)))+'</div></div></div>'})}
  el.innerHTML=h}

function renderModBay(animId){var bay=document.getElementById('modBay');
  var inst=[];for(var k in state.mods){if(state.mods[k]>0)inst.push([k,state.mods[k]])}
  if(!inst.length){bay.innerHTML='<div class="empty-bay">Drag modifications here to install them</div>';return}
  bay.innerHTML=inst.map(function(pair){var id=pair[0],ct=pair[1];
    var m=MODS.find(function(x){return x.id===id});var mc=getModCost(m,state.size)*ct;var tp=m.costFn(state.size,ct)*ct;
    return '<div class="bay-item '+(id===animId?'snap-in':'')+'">'
      +'<div class="bi-info"><div class="bi-name">'+m.name+'</div>'
      +'<div class="bi-detail">'+(mc>0?mc+' mods':mc<0?'Grants '+Math.abs(mc)+' mods':'0 mods')+' &middot; '+(tp>=0?'$'+fmtN(tp):'-$'+fmtN(Math.abs(tp)))+'</div></div>'
      +'<div class="bi-controls"><button onclick="modDec(\''+id+'\')">&minus;</button><span class="bi-count">'+ct+'</span><button onclick="modInc(\''+id+'\')">+</button></div>'
      +'<span class="bi-remove" onclick="modRemoveAll(\''+id+'\')">&times;</span></div>'}).join('')}
function modInc(id){dropMod(id);AudioEngine.click()}
function modDec(id){var cur=state.mods[id]||0;if(cur>0){state.mods[id]=cur-1;if(!state.mods[id])delete state.mods[id];AudioEngine.click();renderModBay();renderStats();renderOutput()}}
function modRemoveAll(id){delete state.mods[id];AudioEngine.remove();renderModBay();renderStats();renderOutput()}

function renderWeaponCatalogue(){var cats={};
  WEAPONS.forEach(function(w){if(!cats[w.cat])cats[w.cat]=[];cats[w.cat].push(w)});
  var h='';for(var cat in cats){h+='<div class="cat-header">'+cat+'</div>';
    cats[cat].forEach(function(w){var avail=w.minSize<=state.size;
      h+='<div class="weapon-drag-item" style="'+(avail?'':'opacity:.4;pointer-events:none')+'" onmousedown="startDrag(event,\'weapon\',\''+w.id+'\',\''+w.name+'\')" ontouchstart="startDrag(event,\'weapon\',\''+w.id+'\',\''+w.name+'\')">'
        +'<span class="drag-handle" style="color:var(--text-dim);font-size:14px;opacity:.4">&#x2807;</span>'
        +'<div class="wdi-info"><div class="wdi-name">'+w.name+(avail?'':' (Min Size '+w.minSize+')')+'</div>'
        +'<div class="wdi-stats">'+w.range+' &middot; '+w.damage+' &middot; AP '+w.ap+' &middot; RoF '+w.rof+'</div>'
        +'<div class="wdi-stats">'+w.notes+'</div></div>'
        +'<div class="wdi-meta"><div class="wdi-mods">'+w.mods+' mod'+(w.mods>1?'s':'')+'</div>'
        +'<div class="wdi-price">$'+fmtN(w.cost)+'</div></div></div>'})}
  document.getElementById('weaponCatalogue').innerHTML=h}

function renderWeaponBay(animId){var bay=document.getElementById('weaponBay');
  if(!state.weapons.length){bay.innerHTML='<div class="empty-bay">Drag weapons here to mount them</div>';return}
  bay.innerHTML=state.weapons.map(function(w,i){
    var wp=WEAPONS.find(function(x){return x.id===w.weaponId});if(!wp)return '';
    var isNew=w.weaponId===animId&&i===state.weapons.length-1;var mc=getWeaponModCost(wp,w.mount);
    var mountLabel=w.mount==='fixed'?'Fixed Front':w.mount==='turret'?'Turret':'Pintle Mount';
    return '<div class="weapon-bay-item '+(isNew?'snap-in':'')+'">'
      +'<div class="wbi-info"><div class="wbi-name">'+wp.name+'</div>'
      +'<div class="wbi-stats">'+wp.range+' &middot; '+wp.damage+' &middot; AP '+wp.ap+' &middot; '+wp.notes+'</div>'
      +'<div class="wbi-mount">'+mountLabel+' &middot; '+mc+' mod'+(mc>1?'s':'')+' &middot; $'+fmtN(wp.cost)+'</div></div>'
      +'<span class="wbi-remove" onclick="removeWeapon('+i+')">&times;</span></div>'}).join('')}
function switchMount(m){state.currentMount=m;document.querySelectorAll('.mount-tab').forEach(function(t){t.classList.toggle('active',t.dataset.mount===m)})}
function removeWeapon(i){state.weapons.splice(i,1);AudioEngine.remove();renderWeaponBay();renderStats();renderOutput()}
// ═══ STATS ═══
function renderStats(){var f=getBaseFrame(state.size),used=calcModsUsed(),gained=calcModsGained(),total=f.baseMods+gained,left=total-used;
  var ts=calcTopSpeed();
  document.getElementById('statsGrid').innerHTML=
    '<div class="stat-box"><div class="stat-label">Toughness</div><div class="stat-value">'+calcTough()+' ('+calcArmor()+')</div></div>'
    +'<div class="stat-box"><div class="stat-label">Wounds</div><div class="stat-value">'+calcWounds()+'</div></div>'
    +'<div class="stat-box"><div class="stat-label">Handling</div><div class="stat-value">'+(calcHand()>=0?'+':'')+calcHand()+'</div></div>'
    +'<div class="stat-box"><div class="stat-label">Top Speed</div><div class="stat-value">'+ts+' ('+speedToMPH(ts)+' MPH)</div></div>'
    +'<div class="stat-box"><div class="stat-label">Strength</div><div class="stat-value">'+calcStr()+' (I)</div></div>'
    +'<div class="stat-box"><div class="stat-label">Mods Used</div><div class="stat-value '+(used>total?'danger':'')+'>'+used+'/'+total+'</div></div>';
  var cls='ok';if(left<=2&&left>0)cls='low';if(left<0)cls='over';
  document.getElementById('modsRemaining').innerHTML='<div class="big-num '+cls+'">'+left+'</div><div class="sub">Mods Remaining</div>';
  document.getElementById('costDisplay').innerHTML='<div class="cost-val">$'+fmtC(calcCost())+'</div><div class="cost-label">Total Cost</div>'}

// ═══ OUTPUT ═══
function renderOutput(){var p=document.getElementById('panel-output'),f=getBaseFrame(state.size),hw=HW_TABLE[state.size]||{h:'?',w:'?'};
  var used=calcModsUsed(),gained=calcModsGained(),left=(f.baseMods+gained)-used;var ts=calcTopSpeed();
  var notes=[];MODS.forEach(function(m){if(state.mods[m.id]>0)notes.push(state.mods[m.id]>1?state.mods[m.id]+'× '+m.name:m.name)});
  var wl=[];state.weapons.forEach(function(w){var wp=WEAPONS.find(function(x){return x.id===w.weaponId});
    if(wp){var ml=w.mount==='fixed'?'Fixed Front':w.mount==='turret'?'Turret':'Pintle Mount';
      wl.push(wp.name+' ('+ml+'): Range '+wp.range+', Damage '+wp.damage+', AP '+wp.ap+', RoF '+wp.rof+(wp.notes?', '+wp.notes:''))}});

  p.innerHTML='<div class="stat-block">'
    +'<div class="sb-name">'+(state.name||'Untitled Walker')+'</div>'
    +'<div class="sb-type">Size '+state.size+' ('+f.cat+'), Handling '+(calcHand()>=0?'+':'')+calcHand()+', Top Speed '+ts+' ('+speedToMPH(ts)+' MPH)</div>'
    +'<hr class="sb-divider">'
    +'<div class="sb-line"><span class="sb-label">Toughness:</span> '+calcTough()+' ('+calcArmor()+')</div>'
    +'<div class="sb-line"><span class="sb-label">Wounds:</span> '+calcWounds()+'</div>'
    +'<div class="sb-line"><span class="sb-label">Height/Weight:</span> '+hw.h+'/'+hw.w+', Strength '+calcStr()+' (I)</div>'
    +'<div class="sb-line"><span class="sb-label">Energy:</span> '+f.energy+' days</div>'
    +'<div class="sb-line"><span class="sb-label">Cost:</span> $'+fmtC(calcCost())+', Mods '+left+' remaining</div>'
    +'<hr class="sb-divider">'
    +(notes.length?'<div class="sb-line"><span class="sb-label">Mods:</span> '+notes.join(', ')+'.</div>':'')
    +(wl.length?'<div class="sb-line"><span class="sb-label">Weapons:</span></div>'+wl.map(function(w){return '<div class="sb-line">&nbsp;&nbsp;&bull; '+w+'</div>'}).join(''):'')
    +'<hr class="sb-divider">'
    +'<div class="sb-notes"><span class="sb-label">Special:</span> Heavy Armor. Piloting skill. Parry 2 + &frac12; Piloting + Handling. Fighting = lower of Piloting/Fighting. Always armed (Str damage, HW). Running: Piloting roll, +1/+2 Speed Rating on success/raise.'
    +(state.mods['shields']?' <strong>Shields:</strong> '+Math.floor(calcWounds()/2)+' charges, Soak with Electronics.':'')
    +(state.mods['thrusters']?' <strong>Thrusters:</strong> Fly at Speed 8 (100 MPH).':'')
    +(state.mods['jump_jets']?' <strong>Jump Jets:</strong> Leap movement horiz / half vert. Death From Above.':'')
    +'</div></div>'
    +'<div style="margin-top:16px"><button class="header-btn" onclick="copyStatBlock()">Copy to Clipboard</button></div>'}

function copyStatBlock(){var f=getBaseFrame(state.size),hw=HW_TABLE[state.size]||{h:'?',w:'?'};var notes=[],wl=[];
  MODS.forEach(function(m){if(state.mods[m.id]>0)notes.push(state.mods[m.id]>1?state.mods[m.id]+'x '+m.name:m.name)});
  state.weapons.forEach(function(w){var wp=WEAPONS.find(function(x){return x.id===w.weaponId});if(wp){var ml=w.mount==='fixed'?'Fixed':w.mount==='turret'?'Turret':'Pintle';wl.push('  * '+wp.name+' ('+ml+'): '+wp.range+', '+wp.damage+', AP '+wp.ap+', RoF '+wp.rof)}});
  var left=(f.baseMods+calcModsGained())-calcModsUsed();var ts=calcTopSpeed();
  var t=state.name+'\nSize '+state.size+' ('+f.cat+'), Hand '+(calcHand()>=0?'+':'')+calcHand()+', Top Speed '+ts+' ('+speedToMPH(ts)+' MPH)\nTough '+calcTough()+' ('+calcArmor()+'), Wounds '+calcWounds()+', Str '+calcStr()+' (I)\nHeight/Weight: '+hw.h+'/'+hw.w+', Energy '+f.energy+' days\nCost $'+fmtC(calcCost())+', Mods '+left+' remaining\n';
  if(notes.length)t+='Mods: '+notes.join(', ')+'.\n';
  if(wl.length)t+='Weapons:\n'+wl.join('\n')+'\n';
  navigator.clipboard.writeText(t).then(function(){var btn=event.target;btn.textContent='Copied!';btn.style.borderColor='var(--green)';btn.style.color='var(--green)';setTimeout(function(){btn.textContent='Copy to Clipboard';btn.style.borderColor='';btn.style.color=''},1500)})}

// ═══ TABS, SAVE/LOAD, UTILS ═══
function switchTab(tab){document.querySelectorAll('.tab').forEach(function(t){t.classList.toggle('active',t.dataset.tab===tab)});document.querySelectorAll('.panel').forEach(function(p){p.classList.toggle('active',p.id==='panel-'+tab)});if(tab==='output')renderOutput()}
function saveWalker(){var d={name:state.name,size:state.size,mods:JSON.parse(JSON.stringify(state.mods)),weapons:JSON.parse(JSON.stringify(state.weapons))};var i=state.savedWalkers.findIndex(function(s){return s.name===state.name});if(i>=0)state.savedWalkers[i]=d;else state.savedWalkers.push(d);localStorage.setItem('diceforge-walker',JSON.stringify(state.savedWalkers));renderSaved()}
function loadWalker(i){var d=state.savedWalkers[i];state.name=d.name;state.size=d.size;state.mods=JSON.parse(JSON.stringify(d.mods));state.weapons=JSON.parse(JSON.stringify(d.weapons));document.getElementById('walkerName').value=state.name;document.getElementById('sizeSlider').value=state.size;renderFrameStats();renderModCatalogue();renderModBay();renderWeaponCatalogue();renderWeaponBay();renderStats();renderOutput();renderSaved()}
function deleteSaved(i){state.savedWalkers.splice(i,1);localStorage.setItem('diceforge-walker',JSON.stringify(state.savedWalkers));renderSaved()}
function newWalker(){state.name='Untitled Walker';state.size=7;state.mods={};state.weapons=[];document.getElementById('walkerName').value=state.name;document.getElementById('sizeSlider').value=7;renderFrameStats();renderModCatalogue();renderModBay();renderWeaponCatalogue();renderWeaponBay();renderStats();renderOutput()}
function loadSaved(){try{var d=localStorage.getItem('diceforge-walker');if(d)state.savedWalkers=JSON.parse(d)}catch(e){}}
function renderSaved(){var list=document.getElementById('savedList');
  if(!state.savedWalkers.length){list.innerHTML='<div class="empty-state"><p>No saved walkers yet.</p></div>';return}
  list.innerHTML=state.savedWalkers.map(function(s,i){
    return '<div class="saved-item" onclick="loadWalker('+i+')"><span class="si-name">'+s.name+'</span><span class="si-chassis">Size '+s.size+' ('+getCategory(s.size).cat+')</span><button class="si-delete" onclick="event.stopPropagation();deleteSaved('+i+')">&times;</button></div>'}).join('')}
function fmtN(n){return n.toLocaleString()}
function fmtC(n){if(n>=1e9)return(n/1e9).toFixed(2)+'B';if(n>=1e6)return(n/1e6).toFixed(n%1e6===0?0:2)+'M';if(n>=1e3)return(n/1e3).toFixed(n%1e3===0?0:1)+'K';return n.toString()}

// ═══ NAV BAR ═══
(function(){var tools=[{id:'foundry',label:'🏭 The Foundry',url:'foundry'},{id:'adventure-vault',label:'🎭 Adventure Vault',url:'adventure-vault'},{id:'character-vault',label:'👤 Character Vault',url:'character-vault'},{id:'walker-workshop',label:'⚙ Walker Workshop',url:'walker-workshop'},{id:'power-armour-forge',label:'🛡 Power Armour Forge',url:'pa-forge'}];
  var nav=document.createElement('div');nav.className='tool-nav';
  tools.forEach(function(t){var btn=document.createElement('button');btn.className='tool-nav-item'+(t.id==='walker-workshop'?' active':'');btn.textContent=t.label;btn.onclick=function(){if(t.id!=='walker-workshop')window.location.href=t.url};nav.appendChild(btn)});
  document.getElementById('toolNavContainer').appendChild(nav)})();

// ═══ BOOT ═══
var audioUnlocked=false;
(function(){function unlockAudio(){if(audioUnlocked)return;AudioEngine.init();var c=AudioEngine.ctx;if(c.state==='suspended')c.resume();var buf=c.createBuffer(1,1,c.sampleRate);var src=c.createBufferSource();src.buffer=buf;src.connect(c.destination);src.start(0);audioUnlocked=true;document.removeEventListener('touchstart',unlockAudio,true);document.removeEventListener('touchend',unlockAudio,true);document.removeEventListener('mousedown',unlockAudio,true);document.removeEventListener('click',unlockAudio,true)}
  document.addEventListener('touchstart',unlockAudio,true);document.addEventListener('touchend',unlockAudio,true);document.addEventListener('mousedown',unlockAudio,true);document.addEventListener('click',unlockAudio,true)})();
init();
</script>
</body>
</html>
